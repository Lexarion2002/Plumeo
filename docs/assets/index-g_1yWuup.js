(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function gi(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(r);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(r,n[s])&&(t[n[s]]=r[n[s]]);return t}function Mf(r,e,t,n){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(u){try{c(n.next(u))}catch(d){o(d)}}function l(u){try{c(n.throw(u))}catch(d){o(d)}}function c(u){u.done?i(u.value):s(u.value).then(a,l)}c((n=n.apply(r,e||[])).next())})}const If=r=>r?(...e)=>r(...e):(...e)=>fetch(...e);class ba extends Error{constructor(e,t="FunctionsError",n){super(e),this.name=t,this.context=n}}class Rf extends ba{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class fl extends ba{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class pl extends ba{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var _o;(function(r){r.Any="any",r.ApNortheast1="ap-northeast-1",r.ApNortheast2="ap-northeast-2",r.ApSouth1="ap-south-1",r.ApSoutheast1="ap-southeast-1",r.ApSoutheast2="ap-southeast-2",r.CaCentral1="ca-central-1",r.EuCentral1="eu-central-1",r.EuWest1="eu-west-1",r.EuWest2="eu-west-2",r.EuWest3="eu-west-3",r.SaEast1="sa-east-1",r.UsEast1="us-east-1",r.UsWest1="us-west-1",r.UsWest2="us-west-2"})(_o||(_o={}));class Nf{constructor(e,{headers:t={},customFetch:n,region:s=_o.Any}={}){this.url=e,this.headers=t,this.region=s,this.fetch=If(n)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return Mf(this,arguments,void 0,function*(t,n={}){var s;let i,o;try{const{headers:a,method:l,body:c,signal:u,timeout:d}=n;let h={},{region:f}=n;f||(f=this.region);const p=new URL(`${this.url}/${t}`);f&&f!=="any"&&(h["x-region"]=f,p.searchParams.set("forceFunctionRegion",f));let m;c&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(h["Content-Type"]="application/octet-stream",m=c):typeof c=="string"?(h["Content-Type"]="text/plain",m=c):typeof FormData<"u"&&c instanceof FormData?m=c:(h["Content-Type"]="application/json",m=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?m=JSON.stringify(c):m=c;let g=u;d&&(o=new AbortController,i=setTimeout(()=>o.abort(),d),u?(g=o.signal,u.addEventListener("abort",()=>o.abort())):g=o.signal);const y=yield this.fetch(p.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},h),this.headers),a),body:m,signal:g}).catch(E=>{throw new Rf(E)}),w=y.headers.get("x-relay-error");if(w&&w==="true")throw new fl(y);if(!y.ok)throw new pl(y);let v=((s=y.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),_;return v==="application/json"?_=yield y.json():v==="application/octet-stream"||v==="application/pdf"?_=yield y.blob():v==="text/event-stream"?_=y:v==="multipart/form-data"?_=yield y.formData():_=yield y.text(),{data:_,error:null,response:y}}catch(a){return{data:null,error:a,response:a instanceof pl||a instanceof fl?a.context:void 0}}finally{i&&clearTimeout(i)}})}}var Pf=class extends Error{constructor(r){super(r.message),this.name="PostgrestError",this.details=r.details,this.hint=r.hint,this.code=r.code}},Df=class{constructor(r){var e,t;this.shouldThrowOnError=!1,this.method=r.method,this.url=r.url,this.headers=new Headers(r.headers),this.schema=r.schema,this.body=r.body,this.shouldThrowOnError=(e=r.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=r.signal,this.isMaybeSingle=(t=r.isMaybeSingle)!==null&&t!==void 0?t:!1,r.fetch?this.fetch=r.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(r,e){return this.headers=new Headers(this.headers),this.headers.set(r,e),this}then(r,e){var t=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const n=this.fetch;let s=n(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{let o=null,a=null,l=null,c=i.status,u=i.statusText;if(i.ok){var d,h;if(t.method!=="HEAD"){var f;const y=await i.text();y===""||(t.headers.get("Accept")==="text/csv"||t.headers.get("Accept")&&(!((f=t.headers.get("Accept"))===null||f===void 0)&&f.includes("application/vnd.pgrst.plan+text"))?a=y:a=JSON.parse(y))}const m=(d=t.headers.get("Prefer"))===null||d===void 0?void 0:d.match(/count=(exact|planned|estimated)/),g=(h=i.headers.get("content-range"))===null||h===void 0?void 0:h.split("/");m&&g&&g.length>1&&(l=parseInt(g[1])),t.isMaybeSingle&&t.method==="GET"&&Array.isArray(a)&&(a.length>1?(o={code:"PGRST116",details:`Results contain ${a.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},a=null,l=null,c=406,u="Not Acceptable"):a.length===1?a=a[0]:a=null)}else{var p;const m=await i.text();try{o=JSON.parse(m),Array.isArray(o)&&i.status===404&&(a=[],o=null,c=200,u="OK")}catch{i.status===404&&m===""?(c=204,u="No Content"):o={message:m}}if(o&&t.isMaybeSingle&&(!(o==null||(p=o.details)===null||p===void 0)&&p.includes("0 rows"))&&(o=null,c=200,u="OK"),o&&t.shouldThrowOnError)throw new Pf(o)}return{error:o,data:a,count:l,status:c,statusText:u}});return this.shouldThrowOnError||(s=s.catch(i=>{var o;let a="";const l=i?.cause;if(l){var c,u,d,h;const p=(c=l?.message)!==null&&c!==void 0?c:"",m=(u=l?.code)!==null&&u!==void 0?u:"";a=`${(d=i?.name)!==null&&d!==void 0?d:"FetchError"}: ${i?.message}`,a+=`

Caused by: ${(h=l?.name)!==null&&h!==void 0?h:"Error"}: ${p}`,m&&(a+=` (${m})`),l?.stack&&(a+=`
${l.stack}`)}else{var f;a=(f=i?.stack)!==null&&f!==void 0?f:""}return{error:{message:`${(o=i?.name)!==null&&o!==void 0?o:"FetchError"}: ${i?.message}`,details:a,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),s.then(r,e)}returns(){return this}overrideTypes(){return this}},$f=class extends Df{select(r){let e=!1;const t=(r??"*").split("").map(n=>/\s/.test(n)&&!e?"":(n==='"'&&(e=!e),n)).join("");return this.url.searchParams.set("select",t),this.headers.append("Prefer","return=representation"),this}order(r,{ascending:e=!0,nullsFirst:t,foreignTable:n,referencedTable:s=n}={}){const i=s?`${s}.order`:"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?`${o},`:""}${r}.${e?"asc":"desc"}${t===void 0?"":t?".nullsfirst":".nullslast"}`),this}limit(r,{foreignTable:e,referencedTable:t=e}={}){const n=typeof t>"u"?"limit":`${t}.limit`;return this.url.searchParams.set(n,`${r}`),this}range(r,e,{foreignTable:t,referencedTable:n=t}={}){const s=typeof n>"u"?"offset":`${n}.offset`,i=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(s,`${r}`),this.url.searchParams.set(i,`${e-r+1}`),this}abortSignal(r){return this.signal=r,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:r=!1,verbose:e=!1,settings:t=!1,buffers:n=!1,wal:s=!1,format:i="text"}={}){var o;const a=[r?"analyze":null,e?"verbose":null,t?"settings":null,n?"buffers":null,s?"wal":null].filter(Boolean).join("|"),l=(o=this.headers.get("Accept"))!==null&&o!==void 0?o:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${i}; for="${l}"; options=${a};`),i==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(r){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${r}`),this}};const ml=new RegExp("[,()]");var Or=class extends $f{eq(r,e){return this.url.searchParams.append(r,`eq.${e}`),this}neq(r,e){return this.url.searchParams.append(r,`neq.${e}`),this}gt(r,e){return this.url.searchParams.append(r,`gt.${e}`),this}gte(r,e){return this.url.searchParams.append(r,`gte.${e}`),this}lt(r,e){return this.url.searchParams.append(r,`lt.${e}`),this}lte(r,e){return this.url.searchParams.append(r,`lte.${e}`),this}like(r,e){return this.url.searchParams.append(r,`like.${e}`),this}likeAllOf(r,e){return this.url.searchParams.append(r,`like(all).{${e.join(",")}}`),this}likeAnyOf(r,e){return this.url.searchParams.append(r,`like(any).{${e.join(",")}}`),this}ilike(r,e){return this.url.searchParams.append(r,`ilike.${e}`),this}ilikeAllOf(r,e){return this.url.searchParams.append(r,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(r,e){return this.url.searchParams.append(r,`ilike(any).{${e.join(",")}}`),this}regexMatch(r,e){return this.url.searchParams.append(r,`match.${e}`),this}regexIMatch(r,e){return this.url.searchParams.append(r,`imatch.${e}`),this}is(r,e){return this.url.searchParams.append(r,`is.${e}`),this}isDistinct(r,e){return this.url.searchParams.append(r,`isdistinct.${e}`),this}in(r,e){const t=Array.from(new Set(e)).map(n=>typeof n=="string"&&ml.test(n)?`"${n}"`:`${n}`).join(",");return this.url.searchParams.append(r,`in.(${t})`),this}notIn(r,e){const t=Array.from(new Set(e)).map(n=>typeof n=="string"&&ml.test(n)?`"${n}"`:`${n}`).join(",");return this.url.searchParams.append(r,`not.in.(${t})`),this}contains(r,e){return typeof e=="string"?this.url.searchParams.append(r,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(r,`cs.{${e.join(",")}}`):this.url.searchParams.append(r,`cs.${JSON.stringify(e)}`),this}containedBy(r,e){return typeof e=="string"?this.url.searchParams.append(r,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(r,`cd.{${e.join(",")}}`):this.url.searchParams.append(r,`cd.${JSON.stringify(e)}`),this}rangeGt(r,e){return this.url.searchParams.append(r,`sr.${e}`),this}rangeGte(r,e){return this.url.searchParams.append(r,`nxl.${e}`),this}rangeLt(r,e){return this.url.searchParams.append(r,`sl.${e}`),this}rangeLte(r,e){return this.url.searchParams.append(r,`nxr.${e}`),this}rangeAdjacent(r,e){return this.url.searchParams.append(r,`adj.${e}`),this}overlaps(r,e){return typeof e=="string"?this.url.searchParams.append(r,`ov.${e}`):this.url.searchParams.append(r,`ov.{${e.join(",")}}`),this}textSearch(r,e,{config:t,type:n}={}){let s="";n==="plain"?s="pl":n==="phrase"?s="ph":n==="websearch"&&(s="w");const i=t===void 0?"":`(${t})`;return this.url.searchParams.append(r,`${s}fts${i}.${e}`),this}match(r){return Object.entries(r).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(r,e,t){return this.url.searchParams.append(r,`not.${e}.${t}`),this}or(r,{foreignTable:e,referencedTable:t=e}={}){const n=t?`${t}.or`:"or";return this.url.searchParams.append(n,`(${r})`),this}filter(r,e,t){return this.url.searchParams.append(r,`${e}.${t}`),this}},Lf=class{constructor(r,{headers:e={},schema:t,fetch:n}){this.url=r,this.headers=new Headers(e),this.schema=t,this.fetch=n}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(r,e){const{head:t=!1,count:n}=e??{},s=t?"HEAD":"GET";let i=!1;const o=(r??"*").split("").map(c=>/\s/.test(c)&&!i?"":(c==='"'&&(i=!i),c)).join(""),{url:a,headers:l}=this.cloneRequestState();return a.searchParams.set("select",o),n&&l.append("Prefer",`count=${n}`),new Or({method:s,url:a,headers:l,schema:this.schema,fetch:this.fetch})}insert(r,{count:e,defaultToNull:t=!0}={}){var n;const s="POST",{url:i,headers:o}=this.cloneRequestState();if(e&&o.append("Prefer",`count=${e}`),t||o.append("Prefer","missing=default"),Array.isArray(r)){const a=r.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(a.length>0){const l=[...new Set(a)].map(c=>`"${c}"`);i.searchParams.set("columns",l.join(","))}}return new Or({method:s,url:i,headers:o,schema:this.schema,body:r,fetch:(n=this.fetch)!==null&&n!==void 0?n:fetch})}upsert(r,{onConflict:e,ignoreDuplicates:t=!1,count:n,defaultToNull:s=!0}={}){var i;const o="POST",{url:a,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${t?"ignore":"merge"}-duplicates`),e!==void 0&&a.searchParams.set("on_conflict",e),n&&l.append("Prefer",`count=${n}`),s||l.append("Prefer","missing=default"),Array.isArray(r)){const c=r.reduce((u,d)=>u.concat(Object.keys(d)),[]);if(c.length>0){const u=[...new Set(c)].map(d=>`"${d}"`);a.searchParams.set("columns",u.join(","))}}return new Or({method:o,url:a,headers:l,schema:this.schema,body:r,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch})}update(r,{count:e}={}){var t;const n="PATCH",{url:s,headers:i}=this.cloneRequestState();return e&&i.append("Prefer",`count=${e}`),new Or({method:n,url:s,headers:i,schema:this.schema,body:r,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch})}delete({count:r}={}){var e;const t="DELETE",{url:n,headers:s}=this.cloneRequestState();return r&&s.append("Prefer",`count=${r}`),new Or({method:t,url:n,headers:s,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch})}},jf=class uu{constructor(e,{headers:t={},schema:n,fetch:s}={}){this.url=e,this.headers=new Headers(t),this.schemaName=n,this.fetch=s}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new Lf(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new uu(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:n=!1,get:s=!1,count:i}={}){var o;let a;const l=new URL(`${this.url}/rpc/${e}`);let c;const u=f=>f!==null&&typeof f=="object"&&(!Array.isArray(f)||f.some(u)),d=n&&Object.values(t).some(u);d?(a="POST",c=t):n||s?(a=n?"HEAD":"GET",Object.entries(t).filter(([f,p])=>p!==void 0).map(([f,p])=>[f,Array.isArray(p)?`{${p.join(",")}}`:`${p}`]).forEach(([f,p])=>{l.searchParams.append(f,p)})):(a="POST",c=t);const h=new Headers(this.headers);return d?h.set("Prefer",i?`count=${i},return=minimal`:"return=minimal"):i&&h.set("Prefer",`count=${i}`),new Or({method:a,url:l,headers:h,schema:this.schemaName,body:c,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}};class Bf{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const t=globalThis.process;if(t){const n=t.versions;if(n&&n.node){const s=n.node,i=parseInt(s.replace(/^v/,"").split(".")[0]);return i>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const n=this.getWebSocketConstructor();return new n(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const zf="2.90.1",Uf=`realtime-js/${zf}`,du="1.0.0",Ff="2.0.0",gl=du,Eo=1e4,Hf=1e3,Vf=100;var _t;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(_t||(_t={}));var ae;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(ae||(ae={}));var Ge;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(Ge||(Ge={}));var Co;(function(r){r.websocket="websocket"})(Co||(Co={}));var Xt;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(Xt||(Xt={}));class qf{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,n;const s=(n=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&n!==void 0?n:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,s)}_encodeJsonUserBroadcastPush(e){var t,n;const s=(n=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&n!==void 0?n:{},o=new TextEncoder().encode(JSON.stringify(s)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,o)}_encodeUserBroadcastPush(e,t,n){var s,i;const o=e.topic,a=(s=e.ref)!==null&&s!==void 0?s:"",l=(i=e.join_ref)!==null&&i!==void 0?i:"",c=e.payload.event,u=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},d=Object.keys(u).length===0?"":JSON.stringify(u);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`ref length ${a.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`topic length ${o.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(d.length>255)throw new Error(`metadata length ${d.length} exceeds maximum of 255`);const h=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+a.length+o.length+c.length+d.length,f=new ArrayBuffer(this.HEADER_LENGTH+h);let p=new DataView(f),m=0;p.setUint8(m++,this.KINDS.userBroadcastPush),p.setUint8(m++,l.length),p.setUint8(m++,a.length),p.setUint8(m++,o.length),p.setUint8(m++,c.length),p.setUint8(m++,d.length),p.setUint8(m++,t),Array.from(l,y=>p.setUint8(m++,y.charCodeAt(0))),Array.from(a,y=>p.setUint8(m++,y.charCodeAt(0))),Array.from(o,y=>p.setUint8(m++,y.charCodeAt(0))),Array.from(c,y=>p.setUint8(m++,y.charCodeAt(0))),Array.from(d,y=>p.setUint8(m++,y.charCodeAt(0)));var g=new Uint8Array(f.byteLength+n.byteLength);return g.set(new Uint8Array(f),0),g.set(new Uint8Array(n),f.byteLength),g.buffer}decode(e,t){if(this._isArrayBuffer(e)){let n=this._binaryDecode(e);return t(n)}if(typeof e=="string"){const n=JSON.parse(e),[s,i,o,a,l]=n;return t({join_ref:s,ref:i,topic:o,event:a,payload:l})}return t({})}_binaryDecode(e){const t=new DataView(e),n=t.getUint8(0),s=new TextDecoder;if(n===this.KINDS.userBroadcast)return this._decodeUserBroadcast(e,t,s)}_decodeUserBroadcast(e,t,n){const s=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),a=t.getUint8(4);let l=this.HEADER_LENGTH+4;const c=n.decode(e.slice(l,l+s));l=l+s;const u=n.decode(e.slice(l,l+i));l=l+i;const d=n.decode(e.slice(l,l+o));l=l+o;const h=e.slice(l,e.byteLength),f=a===this.JSON_ENCODING?JSON.parse(n.decode(h)):h,p={type:this.BROADCAST_EVENT,event:u,payload:f};return o>0&&(p.meta=JSON.parse(d)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:p}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e?.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([n])=>t.includes(n)))}}class hu{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var q;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(q||(q={}));const yl=(r,e,t={})=>{var n;const s=(n=t.skipTypes)!==null&&n!==void 0?n:[];return e?Object.keys(e).reduce((i,o)=>(i[o]=Wf(o,r,e,s),i),{}):{}},Wf=(r,e,t,n)=>{const s=e.find(a=>a.name===r),i=s?.type,o=t[r];return i&&!n.includes(i)?fu(i,o):Ao(o)},fu=(r,e)=>{if(r.charAt(0)==="_"){const t=r.slice(1,r.length);return Yf(e,t)}switch(r){case q.bool:return Kf(e);case q.float4:case q.float8:case q.int2:case q.int4:case q.int8:case q.numeric:case q.oid:return Jf(e);case q.json:case q.jsonb:return Gf(e);case q.timestamp:return Qf(e);case q.abstime:case q.date:case q.daterange:case q.int4range:case q.int8range:case q.money:case q.reltime:case q.text:case q.time:case q.timestamptz:case q.timetz:case q.tsrange:case q.tstzrange:return Ao(e);default:return Ao(e)}},Ao=r=>r,Kf=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},Jf=r=>{if(typeof r=="string"){const e=parseFloat(r);if(!Number.isNaN(e))return e}return r},Gf=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch{return r}return r},Yf=(r,e)=>{if(typeof r!="string")return r;const t=r.length-1,n=r[t];if(r[0]==="{"&&n==="}"){let i;const o=r.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(a=>fu(e,a))}return r},Qf=r=>typeof r=="string"?r.replace(" ","T"):r,pu=r=>{const e=new URL(r);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class Bi{constructor(e,t,n={},s=Eo){this.channel=e,this.event=t,this.payload=n,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var n;return this._hasReceived(e)&&t((n=this.receivedResp)===null||n===void 0?void 0:n.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var bl;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(bl||(bl={}));class un{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const n=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(n.state,{},s=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=un.syncState(this.state,s,i,o),this.pendingDiffs.forEach(l=>{this.state=un.syncDiff(this.state,l,i,o)}),this.pendingDiffs=[],a()}),this.channel._on(n.diff,{},s=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=un.syncDiff(this.state,s,i,o),a())}),this.onJoin((s,i,o)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:o})}),this.onLeave((s,i,o)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,n,s){const i=this.cloneDeep(e),o=this.transformState(t),a={},l={};return this.map(i,(c,u)=>{o[c]||(l[c]=u)}),this.map(o,(c,u)=>{const d=i[c];if(d){const h=u.map(g=>g.presence_ref),f=d.map(g=>g.presence_ref),p=u.filter(g=>f.indexOf(g.presence_ref)<0),m=d.filter(g=>h.indexOf(g.presence_ref)<0);p.length>0&&(a[c]=p),m.length>0&&(l[c]=m)}else a[c]=u}),this.syncDiff(i,{joins:a,leaves:l},n,s)}static syncDiff(e,t,n,s){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return n||(n=()=>{}),s||(s=()=>{}),this.map(i,(a,l)=>{var c;const u=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),u.length>0){const d=e[a].map(f=>f.presence_ref),h=u.filter(f=>d.indexOf(f.presence_ref)<0);e[a].unshift(...h)}n(a,u,l)}),this.map(o,(a,l)=>{let c=e[a];if(!c)return;const u=l.map(d=>d.presence_ref);c=c.filter(d=>u.indexOf(d.presence_ref)<0),e[a]=c,s(a,c,l),c.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(n=>t(n,e[n]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,n)=>{const s=e[n];return"metas"in s?t[n]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[n]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var wl;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(wl||(wl={}));var dn;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes",r.SYSTEM="system"})(dn||(dn={}));var ft;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(ft||(ft={}));class $r{constructor(e,t={config:{}},n){var s,i;if(this.topic=e,this.params=t,this.socket=n,this.bindings={},this.state=ae.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Bi(this,Ge.join,this.params,this.timeout),this.rejoinTimer=new hu(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=ae.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(o=>o.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=ae.closed,this.socket._remove(this)}),this._onError(o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=ae.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=ae.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=ae.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Ge.reply,{},(o,a)=>{this._trigger(this._replyEventName(a),o)}),this.presence=new un(this),this.broadcastEndpointURL=pu(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((i=(s=this.params.config)===null||s===void 0?void 0:s.broadcast)===null||i===void 0)&&i.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var n,s,i;if(this.socket.isConnected()||this.socket.connect(),this.state==ae.closed){const{config:{broadcast:o,presence:a,private:l}}=this.params,c=(s=(n=this.bindings.postgres_changes)===null||n===void 0?void 0:n.map(f=>f.filter))!==null&&s!==void 0?s:[],u=!!this.bindings[dn.PRESENCE]&&this.bindings[dn.PRESENCE].length>0||((i=this.params.config.presence)===null||i===void 0?void 0:i.enabled)===!0,d={},h={broadcast:o,presence:Object.assign(Object.assign({},a),{enabled:u}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(d.access_token=this.socket.accessTokenValue),this._onError(f=>e?.(ft.CHANNEL_ERROR,f)),this._onClose(()=>e?.(ft.CLOSED)),this.updateJoinPayload(Object.assign({config:h},d)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:f})=>{var p;if(this.socket._isManualToken()||this.socket.setAuth(),f===void 0){e?.(ft.SUBSCRIBED);return}else{const m=this.bindings.postgres_changes,g=(p=m?.length)!==null&&p!==void 0?p:0,y=[];for(let w=0;w<g;w++){const v=m[w],{filter:{event:_,schema:E,table:S,filter:x}}=v,I=f&&f[w];if(I&&I.event===_&&$r.isFilterValueEqual(I.schema,E)&&$r.isFilterValueEqual(I.table,S)&&$r.isFilterValueEqual(I.filter,x))y.push(Object.assign(Object.assign({},v),{id:I.id}));else{this.unsubscribe(),this.state=ae.errored,e?.(ft.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=y,e&&e(ft.SUBSCRIBED);return}}).receive("error",f=>{this.state=ae.errored,e?.(ft.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(f).join(", ")||"error")))}).receive("timeout",()=>{e?.(ft.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,n){return this.state===ae.joined&&e===dn.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,t,n)}async httpSend(e,t,n={}){var s;if(t==null)return Promise.reject("Payload is required for httpSend()");const i={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(i.Authorization=`Bearer ${this.socket.accessTokenValue}`);const o={method:"POST",headers:i,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},a=await this._fetchWithTimeout(this.broadcastEndpointURL,o,(s=n.timeout)!==null&&s!==void 0?s:this.timeout);if(a.status===202)return{success:!0};let l=a.statusText;try{const c=await a.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(e,t={}){var n,s;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:i,payload:o}=e,a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(n=t.timeout)!==null&&n!==void 0?n:this.timeout);return await((s=c.body)===null||s===void 0?void 0:s.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,a,l;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&i("ok"),c.receive("ok",()=>i("ok")),c.receive("error",()=>i("error")),c.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=ae.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Ge.close,"leave",this._joinRef())};this.joinPush.destroy();let n=null;return new Promise(s=>{n=new Bi(this,Ge.leave,{},e),n.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),n.send(),this._canPush()||n.trigger("ok",{})}).finally(()=>{n?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=ae.closed,this.bindings={}}async _fetchWithTimeout(e,t,n){const s=new AbortController,i=setTimeout(()=>s.abort(),n),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(i),o}_push(e,t,n=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new Bi(this,e,t,n);return this._canPush()?s.send():this._addToPushBuffer(s),s}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Vf){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,n){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,n){var s,i;const o=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:u}=Ge;if(n&&[a,l,c,u].indexOf(o)>=0&&n!==this._joinRef())return;let h=this._onMessage(o,t,n);if(t&&!h)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(f=>{var p,m,g;return((p=f.filter)===null||p===void 0?void 0:p.event)==="*"||((g=(m=f.filter)===null||m===void 0?void 0:m.event)===null||g===void 0?void 0:g.toLocaleLowerCase())===o}).map(f=>f.callback(h,n)):(i=this.bindings[o])===null||i===void 0||i.filter(f=>{var p,m,g,y,w,v,_,E;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in f){const S=f.id,x=(p=f.filter)===null||p===void 0?void 0:p.event;return S&&((m=t.ids)===null||m===void 0?void 0:m.includes(S))&&(x==="*"||x?.toLocaleLowerCase()===((g=t.data)===null||g===void 0?void 0:g.type.toLocaleLowerCase()))&&(!(!((y=f.filter)===null||y===void 0)&&y.table)||f.filter.table===((w=t.data)===null||w===void 0?void 0:w.table))}else{const S=(_=(v=f?.filter)===null||v===void 0?void 0:v.event)===null||_===void 0?void 0:_.toLocaleLowerCase();return S==="*"||S===((E=t?.event)===null||E===void 0?void 0:E.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===o}).map(f=>{if(typeof h=="object"&&"ids"in h){const p=h.data,{schema:m,table:g,commit_timestamp:y,type:w,errors:v}=p;h=Object.assign(Object.assign({},{schema:m,table:g,commit_timestamp:y,eventType:w,new:{},old:{},errors:v}),this._getPayloadRecords(p))}f.callback(h,n)})}_isClosed(){return this.state===ae.closed}_isJoined(){return this.state===ae.joined}_isJoining(){return this.state===ae.joining}_isLeaving(){return this.state===ae.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,n){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:n};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const n=e.toLocaleLowerCase();return this.bindings[n]&&(this.bindings[n]=this.bindings[n].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===n&&$r.isEqual(s.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}static isFilterValueEqual(e,t){return(e??void 0)===(t??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Ge.close,{},e)}_onError(e){this._on(Ge.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=ae.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=yl(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=yl(e.columns,e.old_record)),t}}const zi=()=>{},Yn={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Xf=[1e3,2e3,5e3,1e4],Zf=1e4,ep=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class tp{constructor(e,t){var n;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Eo,this.transport=null,this.heartbeatIntervalMs=Yn.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=zi,this.ref=0,this.reconnectTimer=null,this.vsn=gl,this.logger=zi,this.conn=null,this.sendBuffer=[],this.serializer=new qf,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=s=>s?(...i)=>s(...i):(...i)=>fetch(...i),!(!((n=t?.params)===null||n===void 0)&&n.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${Co.websocket}`,this.httpEndpoint=pu(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Bf.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const n=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(n),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,n){this.logger(e,t,n)}connectionState(){switch(this.conn&&this.conn.readyState){case _t.connecting:return Xt.Connecting;case _t.open:return Xt.Open;case _t.closing:return Xt.Closing;default:return Xt.Closed}}isConnected(){return this.connectionState()===Xt.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const n=`realtime:${e}`,s=this.getChannels().find(i=>i.topic===n);if(s)return s;{const i=new $r(`realtime:${e}`,t,this);return this.channels.push(i),i}}push(e){const{topic:t,event:n,payload:s,ref:i}=e,o=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${n} (${i})`,s),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Hf,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},Yn.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(n=>n.topic===e&&(n._isJoined()||n._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply"&&t.ref&&t.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error",c)}catch(u){this.log("error","error in heartbeat callback",u)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:n,event:s,payload:i,ref:o}=t,a=o?`(${o})`:"",l=i.status||"";this.log("receive",`${l} ${n} ${s} ${a}`.trim(),i),this.channels.filter(c=>c._isMember(n)).forEach(c=>c._trigger(s,i,o)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===_t.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===_t.open||this.conn.readyState===_t.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this._terminateWorker()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(Ge.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const n=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${n}${s}`}_workerObjectUrl(e){let t;if(e)t=e;else{const n=new Blob([ep],{type:"application/javascript"});t=URL.createObjectURL(n)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t,n=!1;if(e)t=e,n=!0;else if(this.accessToken)try{t=await this.accessToken()}catch(s){this.log("error","Error fetching access token from callback",s),t=this.accessTokenValue}else t=this.accessTokenValue;n?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(s=>{const i={access_token:t,version:Uf};t&&s.updateJoinPayload(i),s.joinedOnce&&s._isJoined()&&s._push(Ge.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(t=>{this.log("error",`Error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(n=>{try{n(t)}catch(s){this.log("error",`error in ${e} callback`,s)}})}catch(n){this.log("error",`error triggering ${e} callbacks`,n)}}_setupReconnectionTimer(){this.reconnectTimer=new hu(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Yn.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,n,s,i,o,a,l,c,u,d,h,f;switch(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(n=e?.timeout)!==null&&n!==void 0?n:Eo,this.heartbeatIntervalMs=(s=e?.heartbeatIntervalMs)!==null&&s!==void 0?s:Yn.HEARTBEAT_INTERVAL,this.worker=(i=e?.worker)!==null&&i!==void 0?i:!1,this.accessToken=(o=e?.accessToken)!==null&&o!==void 0?o:null,this.heartbeatCallback=(a=e?.heartbeatCallback)!==null&&a!==void 0?a:zi,this.vsn=(l=e?.vsn)!==null&&l!==void 0?l:gl,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e?.reconnectAfterMs)!==null&&c!==void 0?c:(p=>Xf[p-1]||Zf),this.vsn){case du:this.encode=(u=e?.encode)!==null&&u!==void 0?u:((p,m)=>m(JSON.stringify(p))),this.decode=(d=e?.decode)!==null&&d!==void 0?d:((p,m)=>m(JSON.parse(p)));break;case Ff:this.encode=(h=e?.encode)!==null&&h!==void 0?h:this.serializer.encode.bind(this.serializer),this.decode=(f=e?.decode)!==null&&f!==void 0?f:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}}var Tn=class extends Error{constructor(r,e){super(r),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&e.icebergType?.includes("CommitState")===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function rp(r,e,t){const n=new URL(e,r);if(t)for(const[s,i]of Object.entries(t))i!==void 0&&n.searchParams.set(s,i);return n.toString()}async function np(r){return!r||r.type==="none"?{}:r.type==="bearer"?{Authorization:`Bearer ${r.token}`}:r.type==="header"?{[r.name]:r.value}:r.type==="custom"?await r.getHeaders():{}}function sp(r){const e=r.fetchImpl??globalThis.fetch;return{async request({method:t,path:n,query:s,body:i,headers:o}){const a=rp(r.baseUrl,n,s),l=await np(r.auth),c=await e(a,{method:t,headers:{...i?{"Content-Type":"application/json"}:{},...l,...o},body:i?JSON.stringify(i):void 0}),u=await c.text(),d=(c.headers.get("content-type")||"").includes("application/json"),h=d&&u?JSON.parse(u):u;if(!c.ok){const f=d?h:void 0,p=f?.error;throw new Tn(p?.message??`Request failed with status ${c.status}`,{status:c.status,icebergType:p?.type,icebergCode:p?.code,details:f})}return{status:c.status,headers:c.headers,data:h}}}}function Qn(r){return r.join("")}var ip=class{constructor(r,e=""){this.client=r,this.prefix=e}async listNamespaces(r){const e=r?{parent:Qn(r.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(n=>({namespace:n}))}async createNamespace(r,e){const t={namespace:r.namespace,properties:e?.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(r){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Qn(r.namespace)}`})}async loadNamespaceMetadata(r){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Qn(r.namespace)}`})).data.properties}}async namespaceExists(r){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Qn(r.namespace)}`}),!0}catch(e){if(e instanceof Tn&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(r,e){try{return await this.createNamespace(r,e)}catch(t){if(t instanceof Tn&&t.status===409)return;throw t}}};function kr(r){return r.join("")}var op=class{constructor(r,e="",t){this.client=r,this.prefix=e,this.accessDelegation=t}async listTables(r){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${kr(r.namespace)}/tables`})).data.identifiers}async createTable(r,e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${kr(r.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(r,e){const t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${kr(r.namespace)}/tables/${r.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(r,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${kr(r.namespace)}/tables/${r.name}`,query:{purgeRequested:String(e?.purge??!1)}})}async loadTable(r){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${kr(r.namespace)}/tables/${r.name}`,headers:e})).data.metadata}async tableExists(r){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${kr(r.namespace)}/tables/${r.name}`,headers:e}),!0}catch(t){if(t instanceof Tn&&t.status===404)return!1;throw t}}async createTableIfNotExists(r,e){try{return await this.createTable(r,e)}catch(t){if(t instanceof Tn&&t.status===409)return await this.loadTable({namespace:r.namespace,name:e.name});throw t}}},ap=class{constructor(r){let e="v1";r.catalogName&&(e+=`/${r.catalogName}`);const t=r.baseUrl.endsWith("/")?r.baseUrl:`${r.baseUrl}/`;this.client=sp({baseUrl:t,auth:r.auth,fetchImpl:r.fetch}),this.accessDelegation=r.accessDelegation?.join(","),this.namespaceOps=new ip(this.client,e),this.tableOps=new op(this.client,e,this.accessDelegation)}async listNamespaces(r){return this.namespaceOps.listNamespaces(r)}async createNamespace(r,e){return this.namespaceOps.createNamespace(r,e)}async dropNamespace(r){await this.namespaceOps.dropNamespace(r)}async loadNamespaceMetadata(r){return this.namespaceOps.loadNamespaceMetadata(r)}async listTables(r){return this.tableOps.listTables(r)}async createTable(r,e){return this.tableOps.createTable(r,e)}async updateTable(r,e){return this.tableOps.updateTable(r,e)}async dropTable(r,e){await this.tableOps.dropTable(r,e)}async loadTable(r){return this.tableOps.loadTable(r)}async namespaceExists(r){return this.namespaceOps.namespaceExists(r)}async tableExists(r){return this.tableOps.tableExists(r)}async createNamespaceIfNotExists(r,e){return this.namespaceOps.createNamespaceIfNotExists(r,e)}async createTableIfNotExists(r,e){return this.tableOps.createTableIfNotExists(r,e)}},yi=class extends Error{constructor(r){super(r),this.__isStorageError=!0,this.name="StorageError"}};function Q(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}var lp=class extends yi{constructor(r,e,t){super(r),this.name="StorageApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},Oo=class extends yi{constructor(r,e){super(r),this.name="StorageUnknownError",this.originalError=e}};const wa=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),cp=()=>Response,Mo=r=>{if(Array.isArray(r))return r.map(t=>Mo(t));if(typeof r=="function"||r!==Object(r))return r;const e={};return Object.entries(r).forEach(([t,n])=>{const s=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[s]=Mo(n)}),e},up=r=>{if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},dp=r=>!r||typeof r!="string"||r.length===0||r.length>100||r.trim()!==r||r.includes("/")||r.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(r);function _n(r){"@babel/helpers - typeof";return _n=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_n(r)}function hp(r,e){if(_n(r)!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(_n(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function fp(r){var e=hp(r,"string");return _n(e)=="symbol"?e:e+""}function pp(r,e,t){return(e=fp(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function vl(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable})),t.push.apply(t,n)}return t}function N(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?vl(Object(t),!0).forEach(function(n){pp(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):vl(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}const Ui=r=>{var e;return r.msg||r.message||r.error_description||(typeof r.error=="string"?r.error:(e=r.error)===null||e===void 0?void 0:e.message)||JSON.stringify(r)},mp=async(r,e,t)=>{r instanceof await cp()&&!t?.noResolveJson?r.json().then(n=>{const s=r.status||500,i=n?.statusCode||s+"";e(new lp(Ui(n),s,i))}).catch(n=>{e(new Oo(Ui(n),n))}):e(new Oo(Ui(r),r))},gp=(r,e,t,n)=>{const s={method:r,headers:e?.headers||{}};return r==="GET"||!n?s:(up(n)?(s.headers=N({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(n)):s.body=n,e?.duplex&&(s.duplex=e.duplex),N(N({},s),t))};async function Un(r,e,t,n,s,i){return new Promise((o,a)=>{r(t,gp(e,n,s,i)).then(l=>{if(!l.ok)throw l;return n?.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>mp(l,a,n))})}async function En(r,e,t,n){return Un(r,"GET",e,t,n)}async function Je(r,e,t,n,s){return Un(r,"POST",e,n,s,t)}async function Io(r,e,t,n,s){return Un(r,"PUT",e,n,s,t)}async function yp(r,e,t,n){return Un(r,"HEAD",e,N(N({},t),{},{noResolveJson:!0}),n)}async function va(r,e,t,n,s){return Un(r,"DELETE",e,n,s,t)}var bp=class{constructor(r,e){this.downloadFn=r,this.shouldThrowOnError=e}then(r,e){return this.execute().then(r,e)}async execute(){var r=this;try{return{data:(await r.downloadFn()).body,error:null}}catch(e){if(r.shouldThrowOnError)throw e;if(Q(e))return{data:null,error:e};throw e}}};let mu;mu=Symbol.toStringTag;var wp=class{constructor(r,e){this.downloadFn=r,this.shouldThrowOnError=e,this[mu]="BlobDownloadBuilder",this.promise=null}asStream(){return new bp(this.downloadFn,this.shouldThrowOnError)}then(r,e){return this.getPromise().then(r,e)}catch(r){return this.getPromise().catch(r)}finally(r){return this.getPromise().finally(r)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var r=this;try{return{data:await(await r.downloadFn()).blob(),error:null}}catch(e){if(r.shouldThrowOnError)throw e;if(Q(e))return{data:null,error:e};throw e}}};const vp={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},kl={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var kp=class{constructor(r,e={},t,n){this.shouldThrowOnError=!1,this.url=r,this.headers=e,this.bucketId=t,this.fetch=wa(n)}throwOnError(){return this.shouldThrowOnError=!0,this}async uploadOrUpdate(r,e,t,n){var s=this;try{let i;const o=N(N({},kl),n);let a=N(N({},s.headers),r==="POST"&&{"x-upsert":String(o.upsert)});const l=o.metadata;typeof Blob<"u"&&t instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),l&&i.append("metadata",s.encodeMetadata(l)),i.append("",t)):typeof FormData<"u"&&t instanceof FormData?(i=t,i.has("cacheControl")||i.append("cacheControl",o.cacheControl),l&&!i.has("metadata")&&i.append("metadata",s.encodeMetadata(l))):(i=t,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,l&&(a["x-metadata"]=s.toBase64(s.encodeMetadata(l))),(typeof ReadableStream<"u"&&i instanceof ReadableStream||i&&typeof i=="object"&&"pipe"in i&&typeof i.pipe=="function")&&!o.duplex&&(o.duplex="half")),n?.headers&&(a=N(N({},a),n.headers));const c=s._removeEmptyFolders(e),u=s._getFinalPath(c),d=await(r=="PUT"?Io:Je)(s.fetch,`${s.url}/object/${u}`,i,N({headers:a},o?.duplex?{duplex:o.duplex}:{}));return{data:{path:c,id:d.Id,fullPath:d.Key},error:null}}catch(i){if(s.shouldThrowOnError)throw i;if(Q(i))return{data:null,error:i};throw i}}async upload(r,e,t){return this.uploadOrUpdate("POST",r,e,t)}async uploadToSignedUrl(r,e,t,n){var s=this;const i=s._removeEmptyFolders(r),o=s._getFinalPath(i),a=new URL(s.url+`/object/upload/sign/${o}`);a.searchParams.set("token",e);try{let l;const c=N({upsert:kl.upsert},n),u=N(N({},s.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&t instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",t)):typeof FormData<"u"&&t instanceof FormData?(l=t,l.append("cacheControl",c.cacheControl)):(l=t,u["cache-control"]=`max-age=${c.cacheControl}`,u["content-type"]=c.contentType),{data:{path:i,fullPath:(await Io(s.fetch,a.toString(),l,{headers:u})).Key},error:null}}catch(l){if(s.shouldThrowOnError)throw l;if(Q(l))return{data:null,error:l};throw l}}async createSignedUploadUrl(r,e){var t=this;try{let n=t._getFinalPath(r);const s=N({},t.headers);e?.upsert&&(s["x-upsert"]="true");const i=await Je(t.fetch,`${t.url}/object/upload/sign/${n}`,{},{headers:s}),o=new URL(t.url+i.url),a=o.searchParams.get("token");if(!a)throw new yi("No token returned by API");return{data:{signedUrl:o.toString(),path:r,token:a},error:null}}catch(n){if(t.shouldThrowOnError)throw n;if(Q(n))return{data:null,error:n};throw n}}async update(r,e,t){return this.uploadOrUpdate("PUT",r,e,t)}async move(r,e,t){var n=this;try{return{data:await Je(n.fetch,`${n.url}/object/move`,{bucketId:n.bucketId,sourceKey:r,destinationKey:e,destinationBucket:t?.destinationBucket},{headers:n.headers}),error:null}}catch(s){if(n.shouldThrowOnError)throw s;if(Q(s))return{data:null,error:s};throw s}}async copy(r,e,t){var n=this;try{return{data:{path:(await Je(n.fetch,`${n.url}/object/copy`,{bucketId:n.bucketId,sourceKey:r,destinationKey:e,destinationBucket:t?.destinationBucket},{headers:n.headers})).Key},error:null}}catch(s){if(n.shouldThrowOnError)throw s;if(Q(s))return{data:null,error:s};throw s}}async createSignedUrl(r,e,t){var n=this;try{let s=n._getFinalPath(r),i=await Je(n.fetch,`${n.url}/object/sign/${s}`,N({expiresIn:e},t?.transform?{transform:t.transform}:{}),{headers:n.headers});const o=t?.download?`&download=${t.download===!0?"":t.download}`:"";return i={signedUrl:encodeURI(`${n.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(s){if(n.shouldThrowOnError)throw s;if(Q(s))return{data:null,error:s};throw s}}async createSignedUrls(r,e,t){var n=this;try{const s=await Je(n.fetch,`${n.url}/object/sign/${n.bucketId}`,{expiresIn:e,paths:r},{headers:n.headers}),i=t?.download?`&download=${t.download===!0?"":t.download}`:"";return{data:s.map(o=>N(N({},o),{},{signedUrl:o.signedURL?encodeURI(`${n.url}${o.signedURL}${i}`):null})),error:null}}catch(s){if(n.shouldThrowOnError)throw s;if(Q(s))return{data:null,error:s};throw s}}download(r,e){const t=typeof e?.transform<"u"?"render/image/authenticated":"object",n=this.transformOptsToQueryString(e?.transform||{}),s=n?`?${n}`:"",i=this._getFinalPath(r),o=()=>En(this.fetch,`${this.url}/${t}/${i}${s}`,{headers:this.headers,noResolveJson:!0});return new wp(o,this.shouldThrowOnError)}async info(r){var e=this;const t=e._getFinalPath(r);try{return{data:Mo(await En(e.fetch,`${e.url}/object/info/${t}`,{headers:e.headers})),error:null}}catch(n){if(e.shouldThrowOnError)throw n;if(Q(n))return{data:null,error:n};throw n}}async exists(r){var e=this;const t=e._getFinalPath(r);try{return await yp(e.fetch,`${e.url}/object/${t}`,{headers:e.headers}),{data:!0,error:null}}catch(n){if(e.shouldThrowOnError)throw n;if(Q(n)&&n instanceof Oo){const s=n.originalError;if([400,404].includes(s?.status))return{data:!1,error:n}}throw n}}getPublicUrl(r,e){const t=this._getFinalPath(r),n=[],s=e?.download?`download=${e.download===!0?"":e.download}`:"";s!==""&&n.push(s);const i=typeof e?.transform<"u"?"render/image":"object",o=this.transformOptsToQueryString(e?.transform||{});o!==""&&n.push(o);let a=n.join("&");return a!==""&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${i}/public/${t}${a}`)}}}async remove(r){var e=this;try{return{data:await va(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:r},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}async list(r,e,t){var n=this;try{const s=N(N(N({},vp),e),{},{prefix:r||""});return{data:await Je(n.fetch,`${n.url}/object/list/${n.bucketId}`,s,{headers:n.headers},t),error:null}}catch(s){if(n.shouldThrowOnError)throw s;if(Q(s))return{data:null,error:s};throw s}}async listV2(r,e){var t=this;try{const n=N({},r);return{data:await Je(t.fetch,`${t.url}/object/list-v2/${t.bucketId}`,n,{headers:t.headers},e),error:null}}catch(n){if(t.shouldThrowOnError)throw n;if(Q(n))return{data:null,error:n};throw n}}encodeMetadata(r){return JSON.stringify(r)}toBase64(r){return typeof Buffer<"u"?Buffer.from(r).toString("base64"):btoa(r)}_getFinalPath(r){return`${this.bucketId}/${r.replace(/^\/+/,"")}`}_removeEmptyFolders(r){return r.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(r){const e=[];return r.width&&e.push(`width=${r.width}`),r.height&&e.push(`height=${r.height}`),r.resize&&e.push(`resize=${r.resize}`),r.format&&e.push(`format=${r.format}`),r.quality&&e.push(`quality=${r.quality}`),e.join("&")}};const gu="2.90.1",yu={"X-Client-Info":`storage-js/${gu}`};var Sp=class{constructor(r,e={},t,n){this.shouldThrowOnError=!1;const s=new URL(r);n?.useNewHostname&&/supabase\.(co|in|red)$/.test(s.hostname)&&!s.hostname.includes("storage.supabase.")&&(s.hostname=s.hostname.replace("supabase.","storage.supabase.")),this.url=s.href.replace(/\/$/,""),this.headers=N(N({},yu),e),this.fetch=wa(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async listBuckets(r){var e=this;try{const t=e.listBucketOptionsToQueryString(r);return{data:await En(e.fetch,`${e.url}/bucket${t}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}async getBucket(r){var e=this;try{return{data:await En(e.fetch,`${e.url}/bucket/${r}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}async createBucket(r,e={public:!1}){var t=this;try{return{data:await Je(t.fetch,`${t.url}/bucket`,{id:r,name:r,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(n){if(t.shouldThrowOnError)throw n;if(Q(n))return{data:null,error:n};throw n}}async updateBucket(r,e){var t=this;try{return{data:await Io(t.fetch,`${t.url}/bucket/${r}`,{id:r,name:r,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(n){if(t.shouldThrowOnError)throw n;if(Q(n))return{data:null,error:n};throw n}}async emptyBucket(r){var e=this;try{return{data:await Je(e.fetch,`${e.url}/bucket/${r}/empty`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}async deleteBucket(r){var e=this;try{return{data:await va(e.fetch,`${e.url}/bucket/${r}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}listBucketOptionsToQueryString(r){const e={};return r&&("limit"in r&&(e.limit=String(r.limit)),"offset"in r&&(e.offset=String(r.offset)),r.search&&(e.search=r.search),r.sortColumn&&(e.sortColumn=r.sortColumn),r.sortOrder&&(e.sortOrder=r.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},xp=class{constructor(r,e={},t){this.shouldThrowOnError=!1,this.url=r.replace(/\/$/,""),this.headers=N(N({},yu),e),this.fetch=wa(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(r){var e=this;try{return{data:await Je(e.fetch,`${e.url}/bucket`,{name:r},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}async listBuckets(r){var e=this;try{const t=new URLSearchParams;r?.limit!==void 0&&t.set("limit",r.limit.toString()),r?.offset!==void 0&&t.set("offset",r.offset.toString()),r?.sortColumn&&t.set("sortColumn",r.sortColumn),r?.sortOrder&&t.set("sortOrder",r.sortOrder),r?.search&&t.set("search",r.search);const n=t.toString(),s=n?`${e.url}/bucket?${n}`:`${e.url}/bucket`;return{data:await En(e.fetch,s,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}async deleteBucket(r){var e=this;try{return{data:await va(e.fetch,`${e.url}/bucket/${r}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Q(t))return{data:null,error:t};throw t}}from(r){var e=this;if(!dp(r))throw new yi("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const t=new ap({baseUrl:this.url,catalogName:r,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),n=this.shouldThrowOnError;return new Proxy(t,{get(s,i){const o=s[i];return typeof o!="function"?o:async(...a)=>{try{return{data:await o.apply(s,a),error:null}}catch(l){if(n)throw l;return{data:null,error:l}}}}})}};const ka={"X-Client-Info":`storage-js/${gu}`,"Content-Type":"application/json"};var bu=class extends Error{constructor(r){super(r),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}};function Pe(r){return typeof r=="object"&&r!==null&&"__isStorageVectorsError"in r}var Fi=class extends bu{constructor(r,e,t){super(r),this.name="StorageVectorsApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},Tp=class extends bu{constructor(r,e){super(r),this.name="StorageVectorsUnknownError",this.originalError=e}};const Sa=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),_p=r=>{if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},Sl=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),Ep=async(r,e,t)=>{if(r&&typeof r=="object"&&"status"in r&&"ok"in r&&typeof r.status=="number"&&!t?.noResolveJson){const n=r.status||500,s=r;if(typeof s.json=="function")s.json().then(i=>{const o=i?.statusCode||i?.code||n+"";e(new Fi(Sl(i),n,o))}).catch(()=>{const i=n+"";e(new Fi(s.statusText||`HTTP ${n} error`,n,i))});else{const i=n+"";e(new Fi(s.statusText||`HTTP ${n} error`,n,i))}}else e(new Tp(Sl(r),r))},Cp=(r,e,t,n)=>{const s={method:r,headers:e?.headers||{}};return n?(_p(n)?(s.headers=N({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(n)):s.body=n,N(N({},s),t)):s};async function Ap(r,e,t,n,s,i){return new Promise((o,a)=>{r(t,Cp(e,n,s,i)).then(l=>{if(!l.ok)throw l;if(n?.noResolveJson)return l;const c=l.headers.get("content-type");return!c||!c.includes("application/json")?{}:l.json()}).then(l=>o(l)).catch(l=>Ep(l,a,n))})}async function De(r,e,t,n,s){return Ap(r,"POST",e,n,s,t)}var Op=class{constructor(r,e={},t){this.shouldThrowOnError=!1,this.url=r.replace(/\/$/,""),this.headers=N(N({},ka),e),this.fetch=Sa(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createIndex(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/CreateIndex`,r,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async getIndex(r,e){var t=this;try{return{data:await De(t.fetch,`${t.url}/GetIndex`,{vectorBucketName:r,indexName:e},{headers:t.headers}),error:null}}catch(n){if(t.shouldThrowOnError)throw n;if(Pe(n))return{data:null,error:n};throw n}}async listIndexes(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/ListIndexes`,r,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async deleteIndex(r,e){var t=this;try{return{data:await De(t.fetch,`${t.url}/DeleteIndex`,{vectorBucketName:r,indexName:e},{headers:t.headers})||{},error:null}}catch(n){if(t.shouldThrowOnError)throw n;if(Pe(n))return{data:null,error:n};throw n}}},Mp=class{constructor(r,e={},t){this.shouldThrowOnError=!1,this.url=r.replace(/\/$/,""),this.headers=N(N({},ka),e),this.fetch=Sa(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async putVectors(r){var e=this;try{if(r.vectors.length<1||r.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:await De(e.fetch,`${e.url}/PutVectors`,r,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async getVectors(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/GetVectors`,r,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async listVectors(r){var e=this;try{if(r.segmentCount!==void 0){if(r.segmentCount<1||r.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(r.segmentIndex!==void 0&&(r.segmentIndex<0||r.segmentIndex>=r.segmentCount))throw new Error(`segmentIndex must be between 0 and ${r.segmentCount-1}`)}return{data:await De(e.fetch,`${e.url}/ListVectors`,r,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async queryVectors(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/QueryVectors`,r,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async deleteVectors(r){var e=this;try{if(r.keys.length<1||r.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:await De(e.fetch,`${e.url}/DeleteVectors`,r,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}},Ip=class{constructor(r,e={},t){this.shouldThrowOnError=!1,this.url=r.replace(/\/$/,""),this.headers=N(N({},ka),e),this.fetch=Sa(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:r},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async getBucket(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:r},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async listBuckets(r={}){var e=this;try{return{data:await De(e.fetch,`${e.url}/ListVectorBuckets`,r,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}async deleteBucket(r){var e=this;try{return{data:await De(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:r},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Pe(t))return{data:null,error:t};throw t}}},Rp=class extends Ip{constructor(r,e={}){super(r,e.headers||{},e.fetch)}from(r){return new Np(this.url,this.headers,r,this.fetch)}async createBucket(r){var e=()=>super.createBucket,t=this;return e().call(t,r)}async getBucket(r){var e=()=>super.getBucket,t=this;return e().call(t,r)}async listBuckets(r={}){var e=()=>super.listBuckets,t=this;return e().call(t,r)}async deleteBucket(r){var e=()=>super.deleteBucket,t=this;return e().call(t,r)}},Np=class extends Op{constructor(r,e,t,n){super(r,e,n),this.vectorBucketName=t}async createIndex(r){var e=()=>super.createIndex,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName}))}async listIndexes(r={}){var e=()=>super.listIndexes,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName}))}async getIndex(r){var e=()=>super.getIndex,t=this;return e().call(t,t.vectorBucketName,r)}async deleteIndex(r){var e=()=>super.deleteIndex,t=this;return e().call(t,t.vectorBucketName,r)}index(r){return new Pp(this.url,this.headers,this.vectorBucketName,r,this.fetch)}},Pp=class extends Mp{constructor(r,e,t,n,s){super(r,e,s),this.vectorBucketName=t,this.indexName=n}async putVectors(r){var e=()=>super.putVectors,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async getVectors(r){var e=()=>super.getVectors,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async listVectors(r={}){var e=()=>super.listVectors,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async queryVectors(r){var e=()=>super.queryVectors,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async deleteVectors(r){var e=()=>super.deleteVectors,t=this;return e().call(t,N(N({},r),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}},Dp=class extends Sp{constructor(r,e={},t,n){super(r,e,t,n)}from(r){return new kp(this.url,this.headers,r,this.fetch)}get vectors(){return new Rp(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new xp(this.url+"/iceberg",this.headers,this.fetch)}};const wu="2.90.1",Mr=30*1e3,Ro=3,Hi=Ro*Mr,$p="http://localhost:9999",Lp="supabase.auth.token",jp={"X-Client-Info":`gotrue-js/${wu}`},No="X-Supabase-Api-Version",vu={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Bp=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,zp=600*1e3;class Cn extends Error{constructor(e,t,n){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=n}}function A(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class Up extends Cn{constructor(e,t,n){super(e,t,n),this.name="AuthApiError",this.status=t,this.code=n}}function Fp(r){return A(r)&&r.name==="AuthApiError"}class Zt extends Cn{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class wt extends Cn{constructor(e,t,n,s){super(e,n,s),this.name=t,this.status=n}}class Ne extends wt{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function Hp(r){return A(r)&&r.name==="AuthSessionMissingError"}class Sr extends wt{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class Xn extends wt{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Zn extends wt{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Vp(r){return A(r)&&r.name==="AuthImplicitGrantRedirectError"}class xl extends wt{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class qp extends wt{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class Po extends wt{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Vi(r){return A(r)&&r.name==="AuthRetryableFetchError"}class Tl extends wt{constructor(e,t,n){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=n}}class Do extends wt{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const ks="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),_l=` 	
\r=`.split(""),Wp=(()=>{const r=new Array(128);for(let e=0;e<r.length;e+=1)r[e]=-1;for(let e=0;e<_l.length;e+=1)r[_l[e].charCodeAt(0)]=-2;for(let e=0;e<ks.length;e+=1)r[ks[e].charCodeAt(0)]=e;return r})();function El(r,e,t){if(r!==null)for(e.queue=e.queue<<8|r,e.queuedBits+=8;e.queuedBits>=6;){const n=e.queue>>e.queuedBits-6&63;t(ks[n]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const n=e.queue>>e.queuedBits-6&63;t(ks[n]),e.queuedBits-=6}}function ku(r,e,t){const n=Wp[r];if(n>-1)for(e.queue=e.queue<<6|n,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(n===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(r)}"`)}}function Cl(r){const e=[],t=o=>{e.push(String.fromCodePoint(o))},n={utf8seq:0,codepoint:0},s={queue:0,queuedBits:0},i=o=>{Gp(o,n,t)};for(let o=0;o<r.length;o+=1)ku(r.charCodeAt(o),s,i);return e.join("")}function Kp(r,e){if(r<=127){e(r);return}else if(r<=2047){e(192|r>>6),e(128|r&63);return}else if(r<=65535){e(224|r>>12),e(128|r>>6&63),e(128|r&63);return}else if(r<=1114111){e(240|r>>18),e(128|r>>12&63),e(128|r>>6&63),e(128|r&63);return}throw new Error(`Unrecognized Unicode codepoint: ${r.toString(16)}`)}function Jp(r,e){for(let t=0;t<r.length;t+=1){let n=r.charCodeAt(t);if(n>55295&&n<=56319){const s=(n-55296)*1024&65535;n=(r.charCodeAt(t+1)-56320&65535|s)+65536,t+=1}Kp(n,e)}}function Gp(r,e,t){if(e.utf8seq===0){if(r<=127){t(r);return}for(let n=1;n<6;n+=1)if((r>>7-n&1)===0){e.utf8seq=n;break}if(e.utf8seq===2)e.codepoint=r&31;else if(e.utf8seq===3)e.codepoint=r&15;else if(e.utf8seq===4)e.codepoint=r&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(r<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|r&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function jr(r){const e=[],t={queue:0,queuedBits:0},n=s=>{e.push(s)};for(let s=0;s<r.length;s+=1)ku(r.charCodeAt(s),t,n);return new Uint8Array(e)}function Yp(r){const e=[];return Jp(r,t=>e.push(t)),new Uint8Array(e)}function tr(r){const e=[],t={queue:0,queuedBits:0},n=s=>{e.push(s)};return r.forEach(s=>El(s,t,n)),El(null,t,n),e.join("")}function Qp(r){return Math.round(Date.now()/1e3)+r}function Xp(){return Symbol("auth-callback")}const pe=()=>typeof window<"u"&&typeof document<"u",Jt={tested:!1,writable:!1},Su=()=>{if(!pe())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Jt.tested)return Jt.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),Jt.tested=!0,Jt.writable=!0}catch{Jt.tested=!0,Jt.writable=!1}return Jt.writable};function Zp(r){const e={},t=new URL(r);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,i)=>{e[i]=s})}catch{}return t.searchParams.forEach((n,s)=>{e[s]=n}),e}const xu=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),em=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",Ir=async(r,e,t)=>{await r.setItem(e,JSON.stringify(t))},Gt=async(r,e)=>{const t=await r.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},fe=async(r,e)=>{await r.removeItem(e)};class bi{constructor(){this.promise=new bi.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}bi.promiseConstructor=Promise;function qi(r){const e=r.split(".");if(e.length!==3)throw new Do("Invalid JWT structure");for(let n=0;n<e.length;n++)if(!Bp.test(e[n]))throw new Do("JWT not in base64url format");return{header:JSON.parse(Cl(e[0])),payload:JSON.parse(Cl(e[1])),signature:jr(e[2]),raw:{header:e[0],payload:e[1]}}}async function tm(r){return await new Promise(e=>{setTimeout(()=>e(null),r)})}function rm(r,e){return new Promise((n,s)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await r(i);if(!e(i,null,o)){n(o);return}}catch(o){if(!e(i,o)){s(o);return}}})()})}function nm(r){return("0"+r.toString(16)).substr(-2)}function sm(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",n=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*n));return s}return crypto.getRandomValues(e),Array.from(e,nm).join("")}async function im(r){const t=new TextEncoder().encode(r),n=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(n);return Array.from(s).map(i=>String.fromCharCode(i)).join("")}async function om(r){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const t=await im(r);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function xr(r,e,t=!1){const n=sm();let s=n;t&&(s+="/PASSWORD_RECOVERY"),await Ir(r,`${e}-code-verifier`,s);const i=await om(n);return[i,n===i?"plain":"s256"]}const am=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function lm(r){const e=r.headers.get(No);if(!e||!e.match(am))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function cm(r){if(!r)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(r<=e)throw new Error("JWT has expired")}function um(r){switch(r){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const dm=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Tr(r){if(!dm.test(r))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Wi(){const r={};return new Proxy(r,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const n=t.toString();if(n==="Symbol(Symbol.toPrimitive)"||n==="Symbol(Symbol.toStringTag)"||n==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function hm(r,e){return new Proxy(r,{get:(t,n,s)=>{if(n==="__isInsecureUserWarningProxy")return!0;if(typeof n=="symbol"){const i=n.toString();if(i==="Symbol(Symbol.toPrimitive)"||i==="Symbol(Symbol.toStringTag)"||i==="Symbol(util.inspect.custom)"||i==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,n,s)}return!e.value&&typeof n=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,n,s)}})}function Al(r){return JSON.parse(JSON.stringify(r))}const Qt=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),fm=[502,503,504];async function Ol(r){var e;if(!em(r))throw new Po(Qt(r),0);if(fm.includes(r.status))throw new Po(Qt(r),r.status);let t;try{t=await r.json()}catch(i){throw new Zt(Qt(i),i)}let n;const s=lm(r);if(s&&s.getTime()>=vu["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?n=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(n=t.error_code),n){if(n==="weak_password")throw new Tl(Qt(t),r.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(n==="session_not_found")throw new Ne}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new Tl(Qt(t),r.status,t.weak_password.reasons);throw new Up(Qt(t),r.status||500,n)}const pm=(r,e,t,n)=>{const s={method:r,headers:e?.headers||{}};return r==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),s.body=JSON.stringify(n),Object.assign(Object.assign({},s),t))};async function R(r,e,t,n){var s;const i=Object.assign({},n?.headers);i[No]||(i[No]=vu["2024-01-01"].name),n?.jwt&&(i.Authorization=`Bearer ${n.jwt}`);const o=(s=n?.query)!==null&&s!==void 0?s:{};n?.redirectTo&&(o.redirect_to=n.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await mm(r,e,t+a,{headers:i,noResolveJson:n?.noResolveJson},{},n?.body);return n?.xform?n?.xform(l):{data:Object.assign({},l),error:null}}async function mm(r,e,t,n,s,i){const o=pm(e,n,s,i);let a;try{a=await r(t,Object.assign({},o))}catch(l){throw console.error(l),new Po(Qt(l),0)}if(a.ok||await Ol(a),n?.noResolveJson)return a;try{return await a.json()}catch(l){await Ol(l)}}function Ke(r){var e;let t=null;bm(r)&&(t=Object.assign({},r),r.expires_at||(t.expires_at=Qp(r.expires_in)));const n=(e=r.user)!==null&&e!==void 0?e:r;return{data:{session:t,user:n},error:null}}function Ml(r){const e=Ke(r);return!e.error&&r.weak_password&&typeof r.weak_password=="object"&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.message&&typeof r.weak_password.message=="string"&&r.weak_password.reasons.reduce((t,n)=>t&&typeof n=="string",!0)&&(e.data.weak_password=r.weak_password),e}function Ot(r){var e;return{data:{user:(e=r.user)!==null&&e!==void 0?e:r},error:null}}function gm(r){return{data:r,error:null}}function ym(r){const{action_link:e,email_otp:t,hashed_token:n,redirect_to:s,verification_type:i}=r,o=gi(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:n,redirect_to:s,verification_type:i},l=Object.assign({},o);return{data:{properties:a,user:l},error:null}}function Il(r){return r}function bm(r){return r.access_token&&r.refresh_token&&r.expires_in}const Ki=["global","local","others"];class wm{constructor({url:e="",headers:t={},fetch:n}){this.url=e,this.headers=t,this.fetch=xu(n),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=Ki[0]){if(Ki.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Ki.join(", ")}`);try{return await R(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(n){if(A(n))return{data:null,error:n};throw n}}async inviteUserByEmail(e,t={}){try{return await R(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:Ot})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async generateLink(e){try{const{options:t}=e,n=gi(e,["options"]),s=Object.assign(Object.assign({},n),t);return"newEmail"in n&&(s.new_email=n?.newEmail,delete s.newEmail),await R(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:ym,redirectTo:t?.redirectTo})}catch(t){if(A(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await R(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:Ot})}catch(t){if(A(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,n,s,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},u=await R(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(n=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:Il});if(u.error)throw u.error;const d=await u.json(),h=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(l=(a=u.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(p=>{const m=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),g=JSON.parse(p.split(";")[1].split("=")[1]);c[`${g}Page`]=m}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},d),c),error:null}}catch(c){if(A(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){Tr(e);try{return await R(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:Ot})}catch(t){if(A(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){Tr(e);try{return await R(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:Ot})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async deleteUser(e,t=!1){Tr(e);try{return await R(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:Ot})}catch(n){if(A(n))return{data:{user:null},error:n};throw n}}async _listFactors(e){Tr(e.userId);try{const{data:t,error:n}=await R(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:n}}catch(t){if(A(t))return{data:null,error:t};throw t}}async _deleteFactor(e){Tr(e.userId),Tr(e.id);try{return{data:await R(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(A(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,n,s,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},u=await R(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(n=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:Il});if(u.error)throw u.error;const d=await u.json(),h=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(l=(a=u.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(p=>{const m=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),g=JSON.parse(p.split(";")[1].split("=")[1]);c[`${g}Page`]=m}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},d),c),error:null}}catch(c){if(A(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(e){try{return await R(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(A(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await R(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(A(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await R(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:n=>({data:n,error:null})})}catch(n){if(A(n))return{data:null,error:n};throw n}}async _deleteOAuthClient(e){try{return await R(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(A(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await R(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(A(t))return{data:null,error:t};throw t}}}function Rl(r={}){return{getItem:e=>r[e]||null,setItem:(e,t)=>{r[e]=t},removeItem:e=>{delete r[e]}}}const _r={debug:!!(globalThis&&Su()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Tu extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class vm extends Tu{}async function km(r,e,t){_r.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",r,e);const n=new globalThis.AbortController;return e>0&&setTimeout(()=>{n.abort(),_r.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",r)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(r,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:n.signal},async s=>{if(s){_r.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",r,s.name);try{return await t()}finally{_r.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",r,s.name)}}else{if(e===0)throw _r.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",r),new vm(`Acquiring an exclusive Navigator LockManager lock "${r}" immediately failed`);if(_r.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function Sm(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function _u(r){if(!/^0x[a-fA-F0-9]{40}$/.test(r))throw new Error(`@supabase/auth-js: Address "${r}" is invalid.`);return r.toLowerCase()}function xm(r){return parseInt(r,16)}function Tm(r){const e=new TextEncoder().encode(r);return"0x"+Array.from(e,n=>n.toString(16).padStart(2,"0")).join("")}function _m(r){var e;const{chainId:t,domain:n,expirationTime:s,issuedAt:i=new Date,nonce:o,notBefore:a,requestId:l,resources:c,scheme:u,uri:d,version:h}=r;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!n)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(o&&o.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${o}`);if(!d)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(h!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${h}`);if(!((e=r.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${r.statement}`)}const f=_u(r.address),p=u?`${u}://${n}`:n,m=r.statement?`${r.statement}
`:"",g=`${p} wants you to sign in with your Ethereum account:
${f}

${m}`;let y=`URI: ${d}
Version: ${h}
Chain ID: ${t}${o?`
Nonce: ${o}`:""}
Issued At: ${i.toISOString()}`;if(s&&(y+=`
Expiration Time: ${s.toISOString()}`),a&&(y+=`
Not Before: ${a.toISOString()}`),l&&(y+=`
Request ID: ${l}`),c){let w=`
Resources:`;for(const v of c){if(!v||typeof v!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${v}`);w+=`
- ${v}`}y+=w}return`${g}
${y}`}class se extends Error{constructor({message:e,code:t,cause:n,name:s}){var i;super(e,{cause:n}),this.__isWebAuthnError=!0,this.name=(i=s??(n instanceof Error?n.name:void 0))!==null&&i!==void 0?i:"Unknown Error",this.code=t}}class Ss extends se{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function Em({error:r,options:e}){var t,n,s;const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(e.signal instanceof AbortSignal)return new se({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else if(r.name==="ConstraintError"){if(((t=i.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new se({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:r});if(e.mediation==="conditional"&&((n=i.authenticatorSelection)===null||n===void 0?void 0:n.userVerification)==="required")return new se({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:r});if(((s=i.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new se({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:r})}else{if(r.name==="InvalidStateError")return new se({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:r});if(r.name==="NotAllowedError")return new se({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="NotSupportedError")return i.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new se({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:r}):new se({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:r});if(r.name==="SecurityError"){const o=window.location.hostname;if(Eu(o)){if(i.rp.id!==o)return new se({message:`The RP ID "${i.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new se({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="TypeError"){if(i.user.id.byteLength<1||i.user.id.byteLength>64)return new se({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:r})}else if(r.name==="UnknownError")return new se({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new se({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}function Cm({error:r,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(e.signal instanceof AbortSignal)return new se({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else{if(r.name==="NotAllowedError")return new se({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="SecurityError"){const n=window.location.hostname;if(Eu(n)){if(t.rpId!==n)return new se({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new se({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="UnknownError")return new se({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new se({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}class Am{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const Om=new Am;function Mm(r){if(!r)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(r);const{challenge:e,user:t,excludeCredentials:n}=r,s=gi(r,["challenge","user","excludeCredentials"]),i=jr(e).buffer,o=Object.assign(Object.assign({},t),{id:jr(t.id).buffer}),a=Object.assign(Object.assign({},s),{challenge:i,user:o});if(n&&n.length>0){a.excludeCredentials=new Array(n.length);for(let l=0;l<n.length;l++){const c=n[l];a.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:jr(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return a}function Im(r){if(!r)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(r);const{challenge:e,allowCredentials:t}=r,n=gi(r,["challenge","allowCredentials"]),s=jr(e).buffer,i=Object.assign(Object.assign({},n),{challenge:s});if(t&&t.length>0){i.allowCredentials=new Array(t.length);for(let o=0;o<t.length;o++){const a=t[o];i.allowCredentials[o]=Object.assign(Object.assign({},a),{id:jr(a.id).buffer,type:a.type||"public-key",transports:a.transports})}}return i}function Rm(r){var e;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const t=r;return{id:r.id,rawId:r.id,response:{attestationObject:tr(new Uint8Array(r.response.attestationObject)),clientDataJSON:tr(new Uint8Array(r.response.clientDataJSON))},type:"public-key",clientExtensionResults:r.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Nm(r){var e;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const t=r,n=r.getClientExtensionResults(),s=r.response;return{id:r.id,rawId:r.id,response:{authenticatorData:tr(new Uint8Array(s.authenticatorData)),clientDataJSON:tr(new Uint8Array(s.clientDataJSON)),signature:tr(new Uint8Array(s.signature)),userHandle:s.userHandle?tr(new Uint8Array(s.userHandle)):void 0},type:"public-key",clientExtensionResults:n,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Eu(r){return r==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(r)}function Nl(){var r,e;return!!(pe()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((r=navigator?.credentials)===null||r===void 0?void 0:r.create)=="function"&&typeof((e=navigator?.credentials)===null||e===void 0?void 0:e.get)=="function")}async function Pm(r){try{const e=await navigator.credentials.create(r);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ss("Browser returned unexpected credential type",e)}:{data:null,error:new Ss("Empty credential response",e)}}catch(e){return{data:null,error:Em({error:e,options:r})}}}async function Dm(r){try{const e=await navigator.credentials.get(r);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ss("Browser returned unexpected credential type",e)}:{data:null,error:new Ss("Empty credential response",e)}}catch(e){return{data:null,error:Cm({error:e,options:r})}}}const $m={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},Lm={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function xs(...r){const e=s=>s!==null&&typeof s=="object"&&!Array.isArray(s),t=s=>s instanceof ArrayBuffer||ArrayBuffer.isView(s),n={};for(const s of r)if(s)for(const i in s){const o=s[i];if(o!==void 0)if(Array.isArray(o))n[i]=o;else if(t(o))n[i]=o;else if(e(o)){const a=n[i];e(a)?n[i]=xs(a,o):n[i]=xs(o)}else n[i]=o}return n}function jm(r,e){return xs($m,r,e||{})}function Bm(r,e){return xs(Lm,r,e||{})}class zm{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:n,signal:s},i){try{const{data:o,error:a}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!o)return{data:null,error:a};const l=s??Om.createNewAbortSignal();if(o.webauthn.type==="create"){const{user:c}=o.webauthn.credential_options.publicKey;c.name||(c.name=`${c.id}:${n}`),c.displayName||(c.displayName=c.name)}switch(o.webauthn.type){case"create":{const c=jm(o.webauthn.credential_options.publicKey,i?.create),{data:u,error:d}=await Pm({publicKey:c,signal:l});return u?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:d}}case"request":{const c=Bm(o.webauthn.credential_options.publicKey,i?.request),{data:u,error:d}=await Dm(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:c,signal:l}));return u?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:d}}}}catch(o){return A(o)?{data:null,error:o}:{data:null,error:new Zt("Unexpected error in challenge",o)}}}async _verify({challengeId:e,factorId:t,webauthn:n}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:n})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:n=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},i){if(!t)return{data:null,error:new Cn("rpId is required for WebAuthn authentication")};try{if(!Nl())return{data:null,error:new Zt("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:n},signal:s},{request:i});if(!o)return{data:null,error:a};const{webauthn:l}=o;return this._verify({factorId:e,challengeId:o.challengeId,webauthn:{type:l.type,rpId:t,rpOrigins:n,credential_response:l.credential_response}})}catch(o){return A(o)?{data:null,error:o}:{data:null,error:new Zt("Unexpected error in authenticate",o)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:n=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},i){if(!t)return{data:null,error:new Cn("rpId is required for WebAuthn registration")};try{if(!Nl())return{data:null,error:new Zt("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this._enroll({friendlyName:e});if(!o)return await this.client.mfa.listFactors().then(u=>{var d;return(d=u.data)===null||d===void 0?void 0:d.all.find(h=>h.factor_type==="webauthn"&&h.friendly_name===e&&h.status!=="unverified")}).then(u=>u?this.client.mfa.unenroll({factorId:u?.id}):void 0),{data:null,error:a};const{data:l,error:c}=await this._challenge({factorId:o.id,friendlyName:o.friendly_name,webauthn:{rpId:t,rpOrigins:n},signal:s},{create:i});return l?this._verify({factorId:o.id,challengeId:l.challengeId,webauthn:{rpId:t,rpOrigins:n,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(o){return A(o)?{data:null,error:o}:{data:null,error:new Zt("Unexpected error in register",o)}}}}Sm();const Um={url:$p,storageKey:Lp,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:jp,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function Pl(r,e,t){return await t()}const Er={};class An{get jwks(){var e,t;return(t=(e=Er[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){Er[this.storageKey]=Object.assign(Object.assign({},Er[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=Er[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){Er[this.storageKey]=Object.assign(Object.assign({},Er[this.storageKey]),{cachedAt:e})}constructor(e){var t,n,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const i=Object.assign(Object.assign({},Um),e);if(this.storageKey=i.storageKey,this.instanceID=(t=An.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,An.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.instanceID>0&&pe()){const o=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(o),this.logDebugMessages&&console.trace(o)}if(this.persistSession=i.persistSession,this.autoRefreshToken=i.autoRefreshToken,this.admin=new wm({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=xu(i.fetch),this.lock=i.lock||Pl,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,this.throwOnError=i.throwOnError,this.lockAcquireTimeout=i.lockAcquireTimeout,i.lock?this.lock=i.lock:this.persistSession&&pe()&&(!((n=globalThis?.navigator)===null||n===void 0)&&n.locks)?this.lock=km:this.lock=Pl,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new zm(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(i.storage?this.storage=i.storage:Su()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Rl(this.memoryStorage)),i.userStorage&&(this.userStorage=i.userStorage)):(this.memoryStorage={},this.storage=Rl(this.memoryStorage)),pe()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o),await this._notifyAllSubscribers(o.data.event,o.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${wu}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},n="none";if(pe()&&(t=Zp(window.location.href),this._isImplicitGrantCallback(t)?n="implicit":await this._isPKCECallback(t)&&(n="pkce")),pe()&&this.detectSessionInUrl&&n!=="none"){const{data:s,error:i}=await this._getSessionFromURL(t,n);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),Vp(i)){const l=(e=i.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:i}}return{error:i}}const{session:o,redirectType:a}=s;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return A(t)?this._returnResult({error:t}):this._returnResult({error:new Zt("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,n,s;try{const i=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(n=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&n!==void 0?n:{},gotrue_meta_security:{captcha_token:(s=e?.options)===null||s===void 0?void 0:s.captchaToken}},xform:Ke}),{data:o,error:a}=i;if(a||!o)return this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signUp(e){var t,n,s;try{let i;if("email"in e){const{email:u,password:d,options:h}=e;let f=null,p=null;this.flowType==="pkce"&&([f,p]=await xr(this.storage,this.storageKey)),i=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:h?.emailRedirectTo,body:{email:u,password:d,data:(t=h?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:h?.captchaToken},code_challenge:f,code_challenge_method:p},xform:Ke})}else if("phone"in e){const{phone:u,password:d,options:h}=e;i=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:u,password:d,data:(n=h?.data)!==null&&n!==void 0?n:{},channel:(s=h?.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:h?.captchaToken}},xform:Ke})}else throw new Xn("You must provide either an email or phone number and a password");const{data:o,error:a}=i;if(a||!o)return await fe(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:o,options:a}=e;t=await R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:Ml})}else if("phone"in e){const{phone:i,password:o,options:a}=e;t=await R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:Ml})}else throw new Xn("You must provide either an email or phone number and a password");const{data:n,error:s}=t;if(s)return this._returnResult({data:{user:null,session:null},error:s});if(!n||!n.session||!n.user){const i=new Sr;return this._returnResult({data:{user:null,session:null},error:i})}return n.session&&(await this._saveSession(n.session),await this._notifyAllSubscribers("SIGNED_IN",n.session)),this._returnResult({data:Object.assign({user:n.user,session:n.session},n.weak_password?{weakPassword:n.weak_password}:null),error:s})}catch(t){if(A(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,n,s,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(n=e.options)===null||n===void 0?void 0:n.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,n,s,i,o,a,l,c,u,d,h;let f,p;if("message"in e)f=e.message,p=e.signature;else{const{chain:m,wallet:g,statement:y,options:w}=e;let v;if(pe())if(typeof g=="object")v=g;else{const $=window;if("ethereum"in $&&typeof $.ethereum=="object"&&"request"in $.ethereum&&typeof $.ethereum.request=="function")v=$.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof g!="object"||!w?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");v=g}const _=new URL((t=w?.url)!==null&&t!==void 0?t:window.location.href),E=await v.request({method:"eth_requestAccounts"}).then($=>$).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!E||E.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const S=_u(E[0]);let x=(n=w?.signInWithEthereum)===null||n===void 0?void 0:n.chainId;if(!x){const $=await v.request({method:"eth_chainId"});x=xm($)}const I={domain:_.host,address:S,statement:y,uri:_.href,version:"1",chainId:x,nonce:(s=w?.signInWithEthereum)===null||s===void 0?void 0:s.nonce,issuedAt:(o=(i=w?.signInWithEthereum)===null||i===void 0?void 0:i.issuedAt)!==null&&o!==void 0?o:new Date,expirationTime:(a=w?.signInWithEthereum)===null||a===void 0?void 0:a.expirationTime,notBefore:(l=w?.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=w?.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(u=w?.signInWithEthereum)===null||u===void 0?void 0:u.resources};f=_m(I),p=await v.request({method:"personal_sign",params:[Tm(f),S]})}try{const{data:m,error:g}=await R(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:f,signature:p},!((d=e.options)===null||d===void 0)&&d.captchaToken?{gotrue_meta_security:{captcha_token:(h=e.options)===null||h===void 0?void 0:h.captchaToken}}:null),xform:Ke});if(g)throw g;if(!m||!m.session||!m.user){const y=new Sr;return this._returnResult({data:{user:null,session:null},error:y})}return m.session&&(await this._saveSession(m.session),await this._notifyAllSubscribers("SIGNED_IN",m.session)),this._returnResult({data:Object.assign({},m),error:g})}catch(m){if(A(m))return this._returnResult({data:{user:null,session:null},error:m});throw m}}async signInWithSolana(e){var t,n,s,i,o,a,l,c,u,d,h,f;let p,m;if("message"in e)p=e.message,m=e.signature;else{const{chain:g,wallet:y,statement:w,options:v}=e;let _;if(pe())if(typeof y=="object")_=y;else{const S=window;if("solana"in S&&typeof S.solana=="object"&&("signIn"in S.solana&&typeof S.solana.signIn=="function"||"signMessage"in S.solana&&typeof S.solana.signMessage=="function"))_=S.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof y!="object"||!v?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");_=y}const E=new URL((t=v?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in _&&_.signIn){const S=await _.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},v?.signInWithSolana),{version:"1",domain:E.host,uri:E.href}),w?{statement:w}:null));let x;if(Array.isArray(S)&&S[0]&&typeof S[0]=="object")x=S[0];else if(S&&typeof S=="object"&&"signedMessage"in S&&"signature"in S)x=S;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in x&&"signature"in x&&(typeof x.signedMessage=="string"||x.signedMessage instanceof Uint8Array)&&x.signature instanceof Uint8Array)p=typeof x.signedMessage=="string"?x.signedMessage:new TextDecoder().decode(x.signedMessage),m=x.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in _)||typeof _.signMessage!="function"||!("publicKey"in _)||typeof _!="object"||!_.publicKey||!("toBase58"in _.publicKey)||typeof _.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");p=[`${E.host} wants you to sign in with your Solana account:`,_.publicKey.toBase58(),...w?["",w,""]:[""],"Version: 1",`URI: ${E.href}`,`Issued At: ${(s=(n=v?.signInWithSolana)===null||n===void 0?void 0:n.issuedAt)!==null&&s!==void 0?s:new Date().toISOString()}`,...!((i=v?.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${v.signInWithSolana.notBefore}`]:[],...!((o=v?.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${v.signInWithSolana.expirationTime}`]:[],...!((a=v?.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${v.signInWithSolana.chainId}`]:[],...!((l=v?.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${v.signInWithSolana.nonce}`]:[],...!((c=v?.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${v.signInWithSolana.requestId}`]:[],...!((d=(u=v?.signInWithSolana)===null||u===void 0?void 0:u.resources)===null||d===void 0)&&d.length?["Resources",...v.signInWithSolana.resources.map(x=>`- ${x}`)]:[]].join(`
`);const S=await _.signMessage(new TextEncoder().encode(p),"utf8");if(!S||!(S instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");m=S}}try{const{data:g,error:y}=await R(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:p,signature:tr(m)},!((h=e.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(f=e.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:Ke});if(y)throw y;if(!g||!g.session||!g.user){const w=new Sr;return this._returnResult({data:{user:null,session:null},error:w})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:y})}catch(g){if(A(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async _exchangeCodeForSession(e){const t=await Gt(this.storage,`${this.storageKey}-code-verifier`),[n,s]=(t??"").split("/");try{if(!n&&this.flowType==="pkce")throw new qp;const{data:i,error:o}=await R(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:n},xform:Ke});if(await fe(this.storage,`${this.storageKey}-code-verifier`),o)throw o;if(!i||!i.session||!i.user){const a=new Sr;return this._returnResult({data:{user:null,session:null,redirectType:null},error:a})}return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),this._returnResult({data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:o})}catch(i){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:{user:null,session:null,redirectType:null},error:i});throw i}}async signInWithIdToken(e){try{const{options:t,provider:n,token:s,access_token:i,nonce:o}=e,a=await R(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:n,id_token:s,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:Ke}),{data:l,error:c}=a;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const u=new Sr;return this._returnResult({data:{user:null,session:null},error:u})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(t){if(A(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,n,s,i,o;try{if("email"in e){const{email:a,options:l}=e;let c=null,u=null;this.flowType==="pkce"&&([c,u]=await xr(this.storage,this.storageKey));const{error:d}=await R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l?.data)!==null&&t!==void 0?t:{},create_user:(n=l?.shouldCreateUser)!==null&&n!==void 0?n:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},code_challenge:c,code_challenge_method:u},redirectTo:l?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:d})}if("phone"in e){const{phone:a,options:l}=e,{data:c,error:u}=await R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(s=l?.data)!==null&&s!==void 0?s:{},create_user:(i=l?.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},channel:(o=l?.channel)!==null&&o!==void 0?o:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c?.message_id},error:u})}throw new Xn("You must provide either an email or phone number.")}catch(a){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async verifyOtp(e){var t,n;try{let s,i;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(n=e.options)===null||n===void 0?void 0:n.captchaToken);const{data:o,error:a}=await R(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:Ke});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");const l=o.session,c=o.user;return l?.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(s){if(A(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithSSO(e){var t,n,s,i,o;try{let a=null,l=null;this.flowType==="pkce"&&([a,l]=await xr(this.storage,this.storageKey));const c=await R(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&n!==void 0?n:void 0}),!((s=e?.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:l}),headers:this.headers,xform:gm});return!((i=c.data)===null||i===void 0)&&i.url&&pe()&&!(!((o=e.options)===null||o===void 0)&&o.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(a){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:n}=e;if(n)throw n;if(!t)throw new Ne;const{error:s}=await R(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:s})})}catch(e){if(A(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:n,type:s,options:i}=e,{error:o}=await R(this.fetch,"POST",t,{headers:this.headers,body:{email:n,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}},redirectTo:i?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:o})}else if("phone"in e){const{phone:n,type:s,options:i}=e,{data:o,error:a}=await R(this.fetch,"POST",t,{headers:this.headers,body:{phone:n,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:o?.message_id},error:a})}throw new Xn("You must provide either an email or phone number and a type")}catch(t){if(A(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const n=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await n,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const n=t();for(this.pendingInLock.push((async()=>{try{await n}catch{}})()),await n;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await n}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await Gt(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const n=e.expires_at?e.expires_at*1e3-Date.now()<Hi:!1;if(this._debug("#__loadSession()",`session has${n?"":" not"} expired`,"expires_at",e.expires_at),!n){if(this.userStorage){const o=await Gt(this.userStorage,this.storageKey+"-user");o?.user?e.user=o.user:e.user=Wi()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const o={value:this.suppressGetSessionWarning};e.user=hm(e.user,o),o.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{session:null},error:i}):this._returnResult({data:{session:s},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const t=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return t.data.user&&(this.suppressGetSessionWarning=!0),t}async _getUser(e){try{return e?await R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:Ot}):await this._useSession(async t=>{var n,s,i;const{data:o,error:a}=t;if(a)throw a;return!(!((n=o.session)===null||n===void 0)&&n.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Ne}:await R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(s=o.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0,xform:Ot})})}catch(t){if(A(t))return Hp(t)&&(await this._removeSession(),await fe(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async n=>{const{data:s,error:i}=n;if(i)throw i;if(!s.session)throw new Ne;const o=s.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await xr(this.storage,this.storageKey));const{data:c,error:u}=await R(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:o.access_token,xform:Ot});if(u)throw u;return o.user=c.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),this._returnResult({data:{user:o.user},error:null})})}catch(n){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(n))return this._returnResult({data:{user:null},error:n});throw n}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Ne;const t=Date.now()/1e3;let n=t,s=!0,i=null;const{payload:o}=qi(e.access_token);if(o.exp&&(n=o.exp,s=n<=t),s){const{data:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:n-t,expires_at:n},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return this._returnResult({data:{user:i.user,session:i},error:null})}catch(t){if(A(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var n;if(!e){const{data:o,error:a}=t;if(a)throw a;e=(n=o.session)!==null&&n!==void 0?n:void 0}if(!e?.refresh_token)throw new Ne;const{data:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{user:null,session:null},error:i}):s?this._returnResult({data:{user:s.user,session:s},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(A(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!pe())throw new Zn("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Zn(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new xl("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Zn("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new xl("No code detected.");const{data:w,error:v}=await this._exchangeCodeForSession(e.code);if(v)throw v;const _=new URL(window.location.href);return _.searchParams.delete("code"),window.history.replaceState(window.history.state,"",_.toString()),{data:{session:w.session,redirectType:null},error:null}}const{provider_token:n,provider_refresh_token:s,access_token:i,refresh_token:o,expires_in:a,expires_at:l,token_type:c}=e;if(!i||!a||!o||!c)throw new Zn("No session defined in URL");const u=Math.round(Date.now()/1e3),d=parseInt(a);let h=u+d;l&&(h=parseInt(l));const f=h-u;f*1e3<=Mr&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${d}s`);const p=h-d;u-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,h,u):u-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",p,h,u);const{data:m,error:g}=await this._getUser(i);if(g)throw g;const y={provider_token:n,provider_refresh_token:s,access_token:i,expires_in:d,expires_at:h,refresh_token:o,token_type:c,user:m.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:y,redirectType:e.type},error:null})}catch(n){if(A(n))return this._returnResult({data:{session:null,redirectType:null},error:n});throw n}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await Gt(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var n;const{data:s,error:i}=t;if(i)return this._returnResult({error:i});const o=(n=s.session)===null||n===void 0?void 0:n.access_token;if(o){const{error:a}=await this.admin.signOut(o,e);if(a&&!(Fp(a)&&(a.status===404||a.status===401||a.status===403)))return this._returnResult({error:a})}return e!=="others"&&(await this._removeSession(),await fe(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=Xp(),n={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,n),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:n}}}async _emitInitialSession(e){return await this._useSession(async t=>{var n,s;try{const{data:{session:i},error:o}=t;if(o)throw o;await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let n=null,s=null;this.flowType==="pkce"&&([n,s]=await xr(this.storage,this.storageKey,!0));try{return await R(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:n,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(i))return this._returnResult({data:null,error:i});throw i}}async getUserIdentities(){var e;try{const{data:t,error:n}=await this.getUser();if(n)throw n;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:n,error:s}=await this._useSession(async i=>{var o,a,l,c,u;const{data:d,error:h}=i;if(h)throw h;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await R(this.fetch,"GET",f,{headers:this.headers,jwt:(u=(c=d.session)===null||c===void 0?void 0:c.access_token)!==null&&u!==void 0?u:void 0})});if(s)throw s;return pe()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(n?.url),this._returnResult({data:{provider:e.provider,url:n?.url},error:null})}catch(n){if(A(n))return this._returnResult({data:{provider:e.provider,url:null},error:n});throw n}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var n;try{const{error:s,data:{session:i}}=t;if(s)throw s;const{options:o,provider:a,token:l,access_token:c,nonce:u}=e,d=await R(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(n=i?.access_token)!==null&&n!==void 0?n:void 0,body:{provider:a,id_token:l,access_token:c,nonce:u,link_identity:!0,gotrue_meta_security:{captcha_token:o?.captchaToken}},xform:Ke}),{data:h,error:f}=d;return f?this._returnResult({data:{user:null,session:null},error:f}):!h||!h.session||!h.user?this._returnResult({data:{user:null,session:null},error:new Sr}):(h.session&&(await this._saveSession(h.session),await this._notifyAllSubscribers("USER_UPDATED",h.session)),this._returnResult({data:h,error:f}))}catch(s){if(await fe(this.storage,`${this.storageKey}-code-verifier`),A(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var n,s;const{data:i,error:o}=t;if(o)throw o;return await R(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(n=i.session)===null||n===void 0?void 0:n.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const n=Date.now();return await rm(async s=>(s>0&&await tm(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await R(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Ke})),(s,i)=>{const o=200*Math.pow(2,s);return i&&Vi(i)&&Date.now()+o-n<Mr})}catch(n){if(this._debug(t,"error",n),A(n))return this._returnResult({data:{session:null,user:null},error:n});throw n}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const n=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",n),pe()&&!t.skipBrowserRedirect&&window.location.assign(n),{data:{provider:e,url:n},error:null}}async _recoverAndRefresh(){var e,t;const n="#_recoverAndRefresh()";this._debug(n,"begin");try{const s=await Gt(this.storage,this.storageKey);if(s&&this.userStorage){let o=await Gt(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!o&&(o={user:s.user},await Ir(this.userStorage,this.storageKey+"-user",o)),s.user=(e=o?.user)!==null&&e!==void 0?e:Wi()}else if(s&&!s.user&&!s.user){const o=await Gt(this.storage,this.storageKey+"-user");o&&o?.user?(s.user=o.user,await fe(this.storage,this.storageKey+"-user"),await Ir(this.storage,this.storageKey,s)):s.user=Wi()}if(this._debug(n,"session from storage",s),!this._isValidSession(s)){this._debug(n,"session is not valid"),s!==null&&await this._removeSession();return}const i=((t=s.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Hi;if(this._debug(n,`session has${i?"":" not"} expired with margin of ${Hi}s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:o}=await this._callRefreshToken(s.refresh_token);o&&(console.error(o),Vi(o)||(this._debug(n,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else if(s.user&&s.user.__isUserNotAvailableProxy===!0)try{const{data:o,error:a}=await this._getUser(s.access_token);!a&&o?.user?(s.user=o.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(n,"could not get user data, skipping SIGNED_IN notification")}catch(o){console.error("Error getting user data:",o),this._debug(n,"error getting user data, skipping SIGNED_IN notification",o)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(n,"error",s),console.error(s);return}finally{this._debug(n,"end")}}async _callRefreshToken(e){var t,n;if(!e)throw new Ne;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new bi;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new Ne;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={data:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(s,"error",i),A(i)){const o={data:null,error:i};return Vi(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(n=this.refreshingDeferred)===null||n===void 0||n.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,n=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${n}`);try{this.broadcastChannel&&n&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){i.push(l)}});if(await Promise.all(o),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await fe(this.storage,`${this.storageKey}-code-verifier`);const t=Object.assign({},e),n=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!n&&t.user&&await Ir(this.userStorage,this.storageKey+"-user",{user:t.user});const s=Object.assign({},t);delete s.user;const i=Al(s);await Ir(this.storage,this.storageKey,i)}else{const s=Al(t);await Ir(this.storage,this.storageKey,s)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await fe(this.storage,this.storageKey),await fe(this.storage,this.storageKey+"-code-verifier"),await fe(this.storage,this.storageKey+"-user"),this.userStorage&&await fe(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&pe()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Mr);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const t=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const t=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,t&&clearTimeout(t)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:n}}=t;if(!n||!n.refresh_token||!n.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((n.expires_at*1e3-e)/Mr);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${Mr}ms, refresh threshold is ${Ro} ticks`),s<=Ro&&await this._callRefreshToken(n.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof Tu)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!pe()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,n){const s=[`provider=${encodeURIComponent(t)}`];if(n?.redirectTo&&s.push(`redirect_to=${encodeURIComponent(n.redirectTo)}`),n?.scopes&&s.push(`scopes=${encodeURIComponent(n.scopes)}`),this.flowType==="pkce"){const[i,o]=await xr(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});s.push(a.toString())}if(n?.queryParams){const i=new URLSearchParams(n.queryParams);s.push(i.toString())}return n?.skipBrowserRedirect&&s.push(`skip_http_redirect=${n.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var n;const{data:s,error:i}=t;return i?this._returnResult({data:null,error:i}):await R(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(n=s?.session)===null||n===void 0?void 0:n.access_token})})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var n,s;const{data:i,error:o}=t;if(o)return this._returnResult({data:null,error:o});const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:l,error:c}=await R(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(n=i?.session)===null||n===void 0?void 0:n.access_token});return c?this._returnResult({data:null,error:c}):(e.factorType==="totp"&&l.type==="totp"&&(!((s=l?.totp)===null||s===void 0)&&s.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var n;const{data:s,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?Rm(e.webauthn.credential_response):Nm(e.webauthn.credential_response)})}:{code:e.code}),{data:a,error:l}=await R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:o,headers:this.headers,jwt:(n=s?.session)===null||n===void 0?void 0:n.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),this._returnResult({data:a,error:l}))})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var n;const{data:s,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=await R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(n=s?.session)===null||n===void 0?void 0:n.access_token});if(o.error)return o;const{data:a}=o;if(a.type!=="webauthn")return{data:a,error:null};switch(a.webauthn.type){case"create":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:Mm(a.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:Im(a.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:n}=await this._challenge({factorId:e.factorId});return n?this._returnResult({data:null,error:n}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:n}=await this.getUser();if(n)return{data:null,error:n};const s={all:[],phone:[],totp:[],webauthn:[]};for(const i of(e=t?.factors)!==null&&e!==void 0?e:[])s.all.push(i),i.status==="verified"&&s[i.factor_type].push(i);return{data:s,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:n},error:s}=await this.getSession();if(s)return this._returnResult({data:null,error:s});if(!n)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:i}=qi(n.access_token);let o=null;i.aal&&(o=i.aal);let a=o;((t=(e=n.user.factors)===null||e===void 0?void 0:e.filter(u=>u.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(a="aal2");const c=i.amr||[];return{data:{currentLevel:o,nextLevel:a,currentAuthenticationMethods:c},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:n},error:s}=t;return s?this._returnResult({data:null,error:s}):n?await R(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:n.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new Ne})})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async n=>{const{data:{session:s},error:i}=n;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new Ne});const o=await R(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"approve"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&pe()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _denyAuthorization(e,t){try{return await this._useSession(async n=>{const{data:{session:s},error:i}=n;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new Ne});const o=await R(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"deny"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&pe()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:t},error:n}=e;return n?this._returnResult({data:null,error:n}):t?await R(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:s=>({data:s,error:null})}):this._returnResult({data:null,error:new Ne})})}catch(e){if(A(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{const{data:{session:n},error:s}=t;return s?this._returnResult({data:null,error:s}):n?(await R(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:n.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new Ne})})}catch(t){if(A(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let n=t.keys.find(a=>a.kid===e);if(n)return n;const s=Date.now();if(n=this.jwks.keys.find(a=>a.kid===e),n&&this.jwks_cached_at+zp>s)return n;const{data:i,error:o}=await R(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return!i.keys||i.keys.length===0||(this.jwks=i,this.jwks_cached_at=s,n=i.keys.find(a=>a.kid===e),!n)?null:n}async getClaims(e,t={}){try{let n=e;if(!n){const{data:f,error:p}=await this.getSession();if(p||!f.session)return this._returnResult({data:null,error:p});n=f.session.access_token}const{header:s,payload:i,signature:o,raw:{header:a,payload:l}}=qi(n);t?.allowExpired||cm(i.exp);const c=!s.alg||s.alg.startsWith("HS")||!s.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(s.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!c){const{error:f}=await this.getUser(n);if(f)throw f;return{data:{claims:i,header:s,signature:o},error:null}}const u=um(s.alg),d=await crypto.subtle.importKey("jwk",c,u,!0,["verify"]);if(!await crypto.subtle.verify(u,d,o,Yp(`${a}.${l}`)))throw new Do("Invalid JWT signature");return{data:{claims:i,header:s,signature:o},error:null}}catch(n){if(A(n))return this._returnResult({data:null,error:n});throw n}}}An.nextInstanceID={};const Fm=An,Hm="2.90.1";let sn="";typeof Deno<"u"?sn="deno":typeof document<"u"?sn="web":typeof navigator<"u"&&navigator.product==="ReactNative"?sn="react-native":sn="node";const Vm={"X-Client-Info":`supabase-js-${sn}/${Hm}`},qm={headers:Vm},Wm={schema:"public"},Km={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Jm={};function On(r){"@babel/helpers - typeof";return On=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},On(r)}function Gm(r,e){if(On(r)!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var n=t.call(r,e);if(On(n)!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function Ym(r){var e=Gm(r,"string");return On(e)=="symbol"?e:e+""}function Qm(r,e,t){return(e=Ym(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Dl(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(r,s).enumerable})),t.push.apply(t,n)}return t}function Z(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Dl(Object(t),!0).forEach(function(n){Qm(r,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):Dl(Object(t)).forEach(function(n){Object.defineProperty(r,n,Object.getOwnPropertyDescriptor(t,n))})}return r}const Xm=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),Zm=()=>Headers,eg=(r,e,t)=>{const n=Xm(t),s=Zm();return async(i,o)=>{var a;const l=(a=await e())!==null&&a!==void 0?a:r;let c=new s(o?.headers);return c.has("apikey")||c.set("apikey",r),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),n(i,Z(Z({},o),{},{headers:c}))}};function tg(r){return r.endsWith("/")?r:r+"/"}function rg(r,e){var t,n;const{db:s,auth:i,realtime:o,global:a}=r,{db:l,auth:c,realtime:u,global:d}=e,h={db:Z(Z({},l),s),auth:Z(Z({},c),i),realtime:Z(Z({},u),o),storage:{},global:Z(Z(Z({},d),a),{},{headers:Z(Z({},(t=d?.headers)!==null&&t!==void 0?t:{}),(n=a?.headers)!==null&&n!==void 0?n:{})}),accessToken:async()=>""};return r.accessToken?h.accessToken=r.accessToken:delete h.accessToken,h}function ng(r){const e=r?.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(tg(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var sg=class extends Fm{constructor(r){super(r)}},ig=class{constructor(r,e,t){var n,s;this.supabaseUrl=r,this.supabaseKey=e;const i=ng(r);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",i),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",i),this.storageUrl=new URL("storage/v1",i),this.functionsUrl=new URL("functions/v1",i);const o=`sb-${i.hostname.split(".")[0]}-auth-token`,a={db:Wm,realtime:Jm,auth:Z(Z({},Km),{},{storageKey:o}),global:qm},l=rg(t??{},a);if(this.storageKey=(n=l.auth.storageKey)!==null&&n!==void 0?n:"",this.headers=(s=l.global.headers)!==null&&s!==void 0?s:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(u,d)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(d)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=eg(e,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(Z({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&this.accessToken().then(u=>this.realtime.setAuth(u)).catch(u=>console.warn("Failed to set initial Realtime auth token:",u)),this.rest=new jf(new URL("rest/v1",i).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch}),this.storage=new Dp(this.storageUrl.href,this.headers,this.fetch,t?.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new Nf(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(r){return this.rest.from(r)}schema(r){return this.rest.schema(r)}rpc(r,e={},t={head:!1,get:!1,count:void 0}){return this.rest.rpc(r,e,t)}channel(r,e={config:{}}){return this.realtime.channel(r,e)}getChannels(){return this.realtime.getChannels()}removeChannel(r){return this.realtime.removeChannel(r)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var r=this,e,t;if(r.accessToken)return await r.accessToken();const{data:n}=await r.auth.getSession();return(e=(t=n.session)===null||t===void 0?void 0:t.access_token)!==null&&e!==void 0?e:r.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:r,persistSession:e,detectSessionInUrl:t,storage:n,userStorage:s,storageKey:i,flowType:o,lock:a,debug:l,throwOnError:c},u,d){const h={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new sg({url:this.authUrl.href,headers:Z(Z({},h),u),storageKey:i,autoRefreshToken:r,persistSession:e,detectSessionInUrl:t,storage:n,userStorage:s,flowType:o,lock:a,debug:l,throwOnError:c,fetch:d,hasCustomAuthorizationHeader:Object.keys(this.headers).some(f=>f.toLowerCase()==="authorization")})}_initRealtimeClient(r){return new tp(this.realtimeUrl.href,Z(Z({},r),{},{params:Z(Z({},{apikey:this.supabaseKey}),r?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((r,e)=>{this._handleTokenChanged(r,"CLIENT",e?.access_token)})}_handleTokenChanged(r,e,t){(r==="TOKEN_REFRESHED"||r==="SIGNED_IN")&&this.changedAccessToken!==t?(this.changedAccessToken=t,this.realtime.setAuth(t)):r==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const og=(r,e,t)=>new ig(r,e,t);function ag(){if(typeof window<"u")return!1;const r=globalThis.process;if(!r)return!1;const e=r.version;if(e==null)return!1;const t=e.match(/^v(\d+)\./);return t?parseInt(t[1],10)<=18:!1}ag()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const $l={SUPABASE_URL:"https://bwmbsjbbyleqjxcxujxo.supabase.co",SUPABASE_ANON_KEY:"sb_publishable_iHVkoe07I55N3QWUeN3ZTQ_TbvT1eyc"},le=og($l.SUPABASE_URL,$l.SUPABASE_ANON_KEY,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}});async function lg(r,e){try{const{error:t}=await le.auth.signUp({email:r,password:e});return t?{ok:!1,errorMessage:t.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function cg(r,e){try{const{error:t}=await le.auth.signInWithPassword({email:r,password:e});return t?{ok:!1,errorMessage:t.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Ll(){try{const{error:r}=await le.auth.signOut();return r?{ok:!1,errorMessage:r.message}:{ok:!0}}catch(r){return{ok:!1,errorMessage:r.message}}}async function ug(){try{const{data:r,error:e}=await le.auth.getUser();return e?{ok:!1,errorMessage:e.message}:{ok:!0,user:r.user??null}}catch(r){return{ok:!1,errorMessage:r.message}}}async function dg(){const r=window.location.hash||"#/home",e=await ug();if(!e.ok)return{page:"login",props:{message:e.errorMessage}};if(e.user===null)return r!=="#login"&&r!=="#/login"&&(window.location.hash="#login"),{page:"login",props:{message:"Veuillez vous connecter."}};if(r==="#login"||r==="#/login"||r==="#app")return window.location.hash="#/home",{page:"home",props:{userEmail:e.user?.email??""}};if(r==="#/home")return{page:"home",props:{userEmail:e.user?.email??""}};if(r.startsWith("#/editor/")){const t=r.replace("#/editor/","").trim();return{page:"editor",props:{userEmail:e.user?.email??"",projectId:t}}}return window.location.hash="#/home",{page:"home",props:{userEmail:e.user?.email??""}}}function hg({userEmail:r="",lastCloudSaveLabel:e="",cloudStatus:t="",cloudBusy:n=!1,backupStatus:s=""}={}){const i=!!r,o=i?"Connecte":"Deconnecte",a=!i||n?"disabled":"",l=n?"true":"false",c=i?`
        <button
          class="danger compact"
          type="button"
          data-action="home-sign-out"
        >
          <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M10 4h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 12H4m0 0l3-3m-3 3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Deconnexion
        </button>
      `:"",u=t?`<p class="home-cloud-status">${t}</p>`:"",d=s?`<p class="home-backup-status">${s}</p>`:"";return`
    <aside class="home-sidebar" aria-label="Sidebar accueil">
      <section class="panel panel-card">
        <div class="panel-header">
          <h2>CONNEXION</h2>
        </div>
        <div class="home-auth-status">
          <span class="home-auth-dot${i?" is-online":""}"></span>
          <span>${o}</span>
        </div>
        <p class="home-auth-email" title="${r||"Non connecte"}">
          ${r||"Non connecte"}
        </p>
        <div class="home-auth-divider" role="presentation"></div>
        <div class="home-cloud-actions" aria-live="polite">
          <button
            class="compact"
            type="button"
            data-action="home-cloud-save"
            ${a}
            aria-disabled="${!i||n}"
            aria-busy="${l}"
          >
            <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 18a4 4 0 0 1 .7-7.95A5.5 5.5 0 0 1 19 10a3.5 3.5 0 0 1 0 7H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 15V9m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Sauver cloud
          </button>
          <button
            class="secondary compact"
            type="button"
            data-action="home-cloud-load"
            ${a}
            aria-disabled="${!i||n}"
            aria-busy="${l}"
          >
            <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 18a4 4 0 0 1 .7-7.95A5.5 5.5 0 0 1 19 10a3.5 3.5 0 0 1 0 7H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 9v6m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Charger cloud
          </button>
          <p class="home-cloud-meta">Sauvegarde : ${e}</p>
          ${u}
        </div>
        ${c}
      </section>
      <section class="panel panel-card">
        <div class="panel-header">
          <h2>BACKUP</h2>
        </div>
        <div class="home-backup-actions">
          <button
            class="secondary compact"
            type="button"
            data-action="home-backup-export"
          >
            Exporter
          </button>
          <button
            class="secondary compact"
            type="button"
            data-action="home-backup-import"
          >
            Importer
          </button>
          <input id="home-backup-file" type="file" accept=".json" hidden />
          ${d}
        </div>
      </section>
    </aside>
  `}function fg({onSignIn:r,onSignUp:e,message:t=""}={}){return`
    <section class="page">
      <h1>Login</h1>
      <p>Connecte-toi pour acceder a l'app.</p>
      <form id="auth-form" class="form" autocomplete="on">
        <label class="field">
          <span>Email</span>
          <input id="email" type="email" required placeholder="email@exemple.com" />
        </label>
        <label class="field">
          <span>Mot de passe</span>
          <input id="password" type="password" required minlength="6" />
        </label>
        <div class="actions">
          <button id="sign-in" type="button">Se connecter</button>
          <button id="sign-up" class="secondary" type="button">Creer un compte</button>
        </div>
      </form>
      <p id="message" class="message">${t}</p>
    </section>
  `}function $o(r){if(!r)return"";const e=new Date(r);return Number.isNaN(e.getTime())?r:e.toLocaleString()}function Cu({userEmail:r="",activeRoute:e="home",editorProjectId:t=null,lastProjectId:n=null}={}){const s=t||n,i=s?"":"disabled",o=s?`data-id="${s}"`:"";return`
    <header class="topbar">
      <div class="topbar-inner">
        <div class="topbar-left">
          <h1>Plumeo</h1>
          <div class="topbar-nav">
            <button data-action="nav-home" type="button" class="topbar-tab${e==="home"?" is-active":""}">Accueil</button>
            <button data-action="nav-editor" type="button" class="topbar-tab${e==="editor"?" is-active":""}" ${o} ${i}>Editeur</button>
          </div>
        </div>
      </div>
    </header>
  `}function pg({userEmail:r="",projects:e=[],lastProjectId:t=null,lastChapterTitle:n=null,lastCloudSaveAt:s=null,cloudStatus:i="",cloudBusy:o=!1,backupStatus:a="",homeStats:l=null,homeMessage:c="",inboxItems:u=[],inboxFilter:d="to_sort"}={}){const h=e.length>0,f=e.find(j=>j.id===t);f?.title;const p=f?"":"disabled",m=f?`data-id="${f.id}"`:"",g=s?$o(new Date(s).toISOString()):"-",y=l??{totalWords:0,wordsPerDay:0,pagesTotal:0,pagesPerDay:0,timeSpent:null,timePerDay:null},w=y.timeSpent?y.timeSpent:"",v=y.timePerDay?y.timePerDay:"",_=`${y.totalWords} mots`,E=`${y.wordsPerDay} mots par jour`,S=`${y.pagesTotal}`,x=`${y.pagesPerDay.toFixed(1)} pages par jour`,I=[{id:"to_sort",label:"A classer"},{id:"sorted",label:"Classe"},{id:"recycled",label:"Recycle"}],$={to_sort:"A classer",sorted:"Classe",recycled:"Recycle"},G=u.filter(j=>j.status===d),Re=G.length?`<ul class="inbox-list">
        ${G.map(j=>{const Y=$[j.status]??"A classer",Be=d==="to_sort"?"":`<span class="inbox-status">${Y}</span>`;let _e="";return j.status==="to_sort"?_e=`
                <button class="secondary compact inbox-action" data-action="inbox-update" data-id="${j.id}" data-status="sorted" type="button">Classer</button>
                <button class="secondary compact inbox-action" data-action="inbox-update" data-id="${j.id}" data-status="recycled" type="button">Recycler</button>
              `:j.status==="sorted"?_e=`
                <button class="secondary compact inbox-action" data-action="inbox-update" data-id="${j.id}" data-status="to_sort" type="button">A classer</button>
                <button class="secondary compact inbox-action" data-action="inbox-update" data-id="${j.id}" data-status="recycled" type="button">Recycler</button>
              `:_e=`
                <button class="danger compact inbox-action" data-action="inbox-delete" data-id="${j.id}" type="button">Supprimer</button>
              `,`
              <li class="inbox-item">
                <div class="inbox-item-main">
                  <p>${j.text}</p>
                  ${Be}
                </div>
                <div class="inbox-item-actions">
                  ${_e}
                </div>
              </li>
            `}).join("")}
      </ul>`:'<p class="muted">Aucune idee pour le moment.</p>',je=e.map(j=>{const Y=j.id===t,Be=Y?"Actif":"En pause",_e=Y?" is-active":"",P=Y?"En cours":"Brouillon",Jn=j.created_at?`Modifie le ${$o(j.created_at)}`:"A reprendre";return`
        <div class="project-card${Y?" is-active":""}">
          <button class="project-card-main" data-action="home-project-open" data-id="${j.id}" type="button">
            <h3>${j.title}</h3>
            <div class="project-card-meta">
              <span class="project-card-status${_e}">${Be}</span>
              <span class="project-card-progress">${P}</span>
              <span class="project-card-info">${Jn}</span>
            </div>
          </button>
          <button class="project-card-delete" data-action="home-project-delete" data-id="${j.id}" type="button" aria-label="Supprimer le projet" title="Supprimer">
            Supprimer
          </button>
        </div>
      `}).join(""),tt=`
        <section class="home-quote">
          <p>Ecrire, c'est tenter de savoir ce que l'on ecrirait si l'on ecrivait.</p>
        </section>
        <section class="home-hero">
          <p class="home-hero-title">Pret a ecrire ?</p>
          <button
            class="home-hero-cta"
            data-action="home-project-continue"
            ${m}
            ${p}
            type="button"
          >
            Continuer a ecrire
          </button>
          <p class="home-hero-note">Ton texte est sauvegarde automatiquement.</p>
        </section>
      `;return`
    <section class="page-shell home-shell">
      ${Cu({userEmail:r,activeRoute:"home",lastProjectId:t})}
      <div class="page dashboard">
        <div class="home-layout">
          ${hg({userEmail:r,lastCloudSaveLabel:g,cloudStatus:i,cloudBusy:o,backupStatus:a})}
          <main class="home-content">
            ${tt}
            <section class="panel panel-card home-projects">
              <div class="panel-header">
                <h2>Projets en cours</h2>
                <button data-action="home-project-create" type="button" class="secondary compact">+ Nouveau projet</button>
              </div>
              ${h?`<div class="project-grid">${je}</div>`:'<p class="muted">Aucun projet pour le moment.</p>'}
            </section>
            <section class="panel panel-card home-stats">
              <div class="panel-header">
                <h2>Vos statistiques d'ecriture</h2>
                <span class="home-stats-note">Mises a jour tous les matins a 10h</span>
              </div>
              <div class="home-stats-card">
                <div class="home-stats-col">
                  <p class="home-stats-value">${w}</p>
                  <p class="home-stats-label">Temps passe a ecrire</p>
                  <p class="home-stats-sub">${v} par jour</p>
                </div>
                <div class="home-stats-divider"></div>
                <div class="home-stats-col">
                  <p class="home-stats-value">${_}</p>
                  <p class="home-stats-label">Nombre total de mots</p>
                  <p class="home-stats-sub">${E}</p>
                </div>
                <div class="home-stats-divider"></div>
                <div class="home-stats-col">
                  <p class="home-stats-value">${S}</p>
                  <p class="home-stats-label">Nombre total de pages</p>
                  <p class="home-stats-hint">250 mots/page</p>
                  <p class="home-stats-sub">${x}</p>
                </div>
              </div>
            </section>
            <p id="home-message" class="message">${c}</p>
          </main>
          <aside class="home-inbox" aria-label="Inbox">
            <section class="panel panel-card inbox-card">
              <div class="panel-header">
                <h2>INBOX</h2>
              </div>
              <div class="inbox-capture">
                <input
                  id="inbox-capture"
                  type="text"
                  placeholder="Capturer une idee..."
                  aria-label="Capturer une idee"
                />
                <button
                  class="compact"
                  type="button"
                  data-action="inbox-create"
                  aria-label="Ajouter une idee"
                  title="Ajouter"
                >
                  +
                </button>
              </div>
              <div class="inbox-filters" role="tablist" aria-label="Filtres inbox">
                ${I.map(j=>`
                    <button
                      class="inbox-filter${j.id===d?" is-active":""}"
                      type="button"
                      data-action="inbox-filter"
                      data-status="${j.id}"
                      role="tab"
                      aria-selected="${j.id===d}"
                    >
                      ${j.label}
                    </button>
                  `).join("")}
              </div>
              <div class="inbox-items">
                ${Re}
              </div>
            </section>
          </aside>
        </div>
      </div>
    </section>
  `}function mg({onSignOut:r,userEmail:e="",projects:t=[],selectedProjectId:n=null,editingProjectId:s=null,chapters:i=[],selectedChapterId:o=null,chapterDetail:a=null,versions:l=[],statusText:c="",editorTab:u="session",writingNav:d="chapter",characters:h=[],selectedCharacterId:f=null,characterFilter:p="",characterSections:m={}}={}){const g=!!n,y=i.length>0,w=!!a,_=(g?t.find(L=>L.id===n):null)?.title??"Sans titre",E=g?_:"-",S=w?i.findIndex(L=>L.id===o)+1:0,x=w&&S>0&&i.length?`${S}/${i.length}`:"-",I=i.map(L=>{const We=L.id===o;return`
        <li class="chapter-item" draggable="true" data-id="${L.id}">
          <button
            class="list-button${We?" is-selected":""}"
            data-action="chapter-select"
            data-id="${L.id}"
          >
            ${L.title}
          </button>
        </li>
      `}).join(""),$=l.map(L=>`
        <li class="version-item">
          <div>
            <strong>${L.label??"Version"}</strong>
            <div class="muted">${$o(L.created_at)}</div>
          </div>
          <button
            data-action="version-restore"
            data-id="${L.id}"
            type="button"
          >
            Restaurer
          </button>
        </li>
      `).join(""),G=a?.conflict?`
      <div class="conflict">
        <p>Conflit detecte (serveur different).</p>
        <div class="actions">
          <button data-action="conflict-reload-server" type="button">
            Recharger serveur
          </button>
          <button data-action="conflict-duplicate-local" class="secondary" type="button">
            Dupliquer local
          </button>
        </div>
      </div>
    `:"",Re=w?`
      ${G}
      <label class="field">
        <span>Titre du chapitre</span>
        <input
          id="chapter-title"
          type="text"
          value="${a.title??""}"
          readonly
        />
      </label>
      <div class="field editor-field">
        <span>Contenu</span>
        <div id="editor-toolbar" class="editor-toolbar" role="toolbar" aria-label="Outils de mise en forme">
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-bold" data-command="bold" aria-label="Gras" title="Gras">
              <span aria-hidden="true">G</span>
            </button>
            <button type="button" class="toolbar-button icon-italic" data-command="italic" aria-label="Italique" title="Italique">
              <span aria-hidden="true">I</span>
            </button>
            <button type="button" class="toolbar-button icon-heading" data-command="heading-1" aria-label="Titre 1" title="Titre 1">
              <span aria-hidden="true">H1</span>
            </button>
            <button type="button" class="toolbar-button icon-heading" data-command="heading-2" aria-label="Titre 2" title="Titre 2">
              <span aria-hidden="true">H2</span>
            </button>
          </div>
          <div class="toolbar-group toolbar-segment" role="group" aria-label="Alignement">
            <button type="button" class="toolbar-button icon-align icon-align-left" data-command="align-left" aria-label="Aligner a gauche" title="Aligner a gauche">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-center" data-command="align-center" aria-label="Centrer" title="Centrer">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-right" data-command="align-right" aria-label="Aligner a droite" title="Aligner a droite">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-justify" data-command="align-justify" aria-label="Justifier" title="Justifier">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-list icon-list-bullet" data-command="bullet-list" aria-label="Liste a puces" title="Liste a puces">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-list icon-list-ordered" data-command="ordered-list" aria-label="Liste numerotee" title="Liste numerotee">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-highlight" data-command="highlight" aria-label="Surligner" title="Surligner">
              <span aria-hidden="true">A</span>
            </button>
          </div>
          <div class="toolbar-group">
            <label class="toolbar-label" for="toolbar-font-size">Taille</label>
            <select id="toolbar-font-size" class="toolbar-select" data-command="font-size" aria-label="Taille de police" title="Taille de police">
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="24">24</option>
            </select>
          </div>
          <div class="toolbar-group toolbar-group-right">
            <button type="button" class="toolbar-button icon-history" data-command="undo" aria-label="Annuler" title="Annuler">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-history" data-command="redo" aria-label="Retablir" title="Retablir">
              <span aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="paper-shell">
          <div id="chapter-editor" class="editor-canvas" aria-label="Contenu du chapitre"></div>
        </div>
      </div>
    `:`
      <div class="empty">
        <p>${g?"Cree un chapitre pour ecrire.":"Commence par creer un projet."}</p>
      </div>
    `,je=w?`
      <details class="history" data-section="history">
        <summary class="history-summary">Afficher / Masquer l'historique</summary>
        <div class="history-body">
          <div class="panel-header">
            <h2>Historique</h2>
            <button data-action="version-create" type="button">Snapshot maintenant</button>
          </div>
          ${l.length?`<ul class="version-list">${$}</ul>`:'<p class="muted">Aucune version.</p>'}
        </div>
      </details>
    `:"",tt=`
    <button
      id="project-export"
      data-action="project-export-md"
      type="button"
      class="secondary compact"
      ${g?"":"disabled"}
      aria-disabled="${g?"false":"true"}"
      aria-label="Exporter le projet en Markdown"
      title="Exporter le projet en Markdown"
    >
      Exporter
    </button>
  `,j=w?a?.title??"":"-",Y=[{id:"session",label:"Session"},{id:"characters",label:"Personnages"},{id:"notes",label:"Notes"},{id:"versions",label:"Versions"}],Be={session:'<p class="muted">Aucun indicateur de session pour le moment.</p>',characters:`
      <div class="character-sidebar">
        <div class="character-filter">
          <label for="character-filter-input">Filtrer</label>
          <div class="character-filter-row">
            <input id="character-filter-input" type="text" placeholder="Rechercher..." />
            <button type="button" class="secondary compact">Ajouter</button>
          </div>
        </div>
        <div class="character-items">
          <button type="button" class="character-item is-active">
            <span class="character-avatar">JD</span>
            <span class="character-name">John Doe</span>
          </button>
          <button type="button" class="character-item">
            <span class="character-avatar">JD</span>
            <span class="character-name">Jane Doe</span>
          </button>
        </div>
      </div>
    `,notes:'<p class="muted">Notes rapides a venir.</p>',versions:'<p class="muted">Acces rapide aux versions a venir.</p>'},_e=h.filter(L=>{if(!p.trim())return!0;const We=p.trim().toLowerCase(),en=`${L.first_name??""} ${L.last_name??""}`.toLowerCase(),Kt=(L.nickname??"").toLowerCase();return en.includes(We)||Kt.includes(We)}),P=h.find(L=>L.id===f)??null,Jn=P?.first_name||P?.last_name?`${P?.first_name??""} ${P?.last_name??""}`.trim():"Nouveau personnage",_f=Jn.split(" ").filter(Boolean).slice(0,2).map(L=>L[0]?.toUpperCase()).join("")||"?",Gn=[];if(P?.age||P?.birth_place){const L=P?.age?`${P.age} ans`:"",We=P?.birth_place?`ne a ${P.birth_place}`:"";Gn.push([L,We].filter(Boolean).join(", "))}P?.residence&&Gn.push(P.residence);const Ef=Math.max(0,Math.min(5,Number(P?.role_rating??0))),St=(L,We,en,Kt)=>`
        <section class="character-accordion${Kt?" is-open":""}">
          <button
            type="button"
            class="character-accordion-header"
            data-action="character-toggle"
            data-section="${L}"
            aria-expanded="${Kt}"
          >
            <span class="character-dot"></span>
            <span>${We}</span>
            <span class="character-accordion-icon" aria-hidden="true">></span>
          </button>
          ${Kt?`<div class="character-accordion-body">${en}</div>`:""}
        </section>
      `,Cf=P?`
      <div class="character-detail-panel">
        <div class="character-hero">
          <div class="character-hero-avatar">${_f}</div>
          <div class="character-hero-info">
            <h3>${Jn}</h3>
            <ul>
              ${Gn.length?Gn.map(L=>`<li>${L}</li>`).join(""):'<li class="muted">Resume a completer.</li>'}
            </ul>
          </div>
          <div class="character-hero-meta">
            <p>Role :</p>
            <div class="character-stars" role="radiogroup" aria-label="Role">
              ${[1,2,3,4,5].map(L=>`
                  <button
                    type="button"
                    class="character-star${L<=Ef?" is-active":""}"
                    data-action="character-rate"
                    data-rating="${L}"
                    aria-label="${L} etoiles"
                  >
                    ?
                  </button>
                `).join("")}
            </div>
            <button
              type="button"
              class="secondary compact"
              data-action="character-write"
              title="Bientot disponible"
              aria-label="Ecrire a cote (bientot disponible)"
            >
              Ecrire a cote
            </button>
          </div>
        </div>
        <div class="character-sections">
          ${St("civil","Etat civil",`
              <div class="character-grid">
                <label>
                  <span>Prenom</span>
                  <input type="text" value="${P.first_name??""}" data-character-field="first_name" />
                </label>
                <label>
                  <span>Nom de famille</span>
                  <input type="text" value="${P.last_name??""}" data-character-field="last_name" />
                </label>
                <label>
                  <span>Surnom</span>
                  <input type="text" value="${P.nickname??""}" data-character-field="nickname" />
                </label>
                <label>
                  <span>Pronoms</span>
                  <input type="text" value="${P.pronouns??""}" data-character-field="pronouns" />
                </label>
                <label class="character-inline">
                  <span>Sexe</span>
                  <div class="character-inline-row">
                    <label><input type="radio" name="sex" value="femme" data-character-field="sex" ${P.sex==="femme"?"checked":""} />Femme</label>
                    <label><input type="radio" name="sex" value="homme" data-character-field="sex" ${P.sex==="homme"?"checked":""} />Homme</label>
                    <label><input type="radio" name="sex" value="autre" data-character-field="sex" ${P.sex==="autre"?"checked":""} />Autre</label>
                  </div>
                </label>
                <label>
                  <span>Race</span>
                  <input type="text" value="${P.race??""}" data-character-field="race" />
                </label>
                <label>
                  <span>Age</span>
                  <input type="number" value="${P.age??""}" data-character-field="age" />
                </label>
                <label>
                  <span>Date de naissance</span>
                  <input type="date" value="${P.birth_date??""}" data-character-field="birth_date" />
                </label>
                <label>
                  <span>Lieu de naissance</span>
                  <input type="text" value="${P.birth_place??""}" data-character-field="birth_place" />
                </label>
                <label>
                  <span>Lieu de residence</span>
                  <input type="text" value="${P.residence??""}" data-character-field="residence" />
                </label>
                <label>
                  <span>Occupation</span>
                  <input type="text" value="${P.occupation??""}" data-character-field="occupation" />
                </label>
              </div>
            `,m.civil)}
          ${St("physique","Physique",`
              <div class="character-grid">
                <label>
                  <span>Taille</span>
                  <input type="text" value="${P.meta?.physique?.taille??""}" data-character-meta="physique" data-character-field="taille" />
                </label>
                <label>
                  <span>Corpulence</span>
                  <input type="text" value="${P.meta?.physique?.corpulence??""}" data-character-meta="physique" data-character-field="corpulence" />
                </label>
                <label class="character-inline">
                  <span>Signes distinctifs</span>
                  <textarea data-character-meta="physique" data-character-field="signes">${P.meta?.physique?.signes??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Style vestimentaire</span>
                  <textarea data-character-meta="physique" data-character-field="style">${P.meta?.physique?.style??""}</textarea>
                </label>
              </div>
            `,m.physique)}
          ${St("caractere","Caractere",`
              <div class="character-grid">
                <label>
                  <span>Traits dominants</span>
                  <textarea data-character-meta="caractere" data-character-field="traits">${P.meta?.caractere?.traits??""}</textarea>
                </label>
                <label>
                  <span>Qualites</span>
                  <textarea data-character-meta="caractere" data-character-field="qualites">${P.meta?.caractere?.qualites??""}</textarea>
                </label>
                <label>
                  <span>Defauts</span>
                  <textarea data-character-meta="caractere" data-character-field="defauts">${P.meta?.caractere?.defauts??""}</textarea>
                </label>
                <label>
                  <span>Peur(s)</span>
                  <textarea data-character-meta="caractere" data-character-field="peurs">${P.meta?.caractere?.peurs??""}</textarea>
                </label>
              </div>
            `,m.caractere)}
          ${St("profil","Profil",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Histoire courte</span>
                  <textarea data-character-meta="profil" data-character-field="histoire">${P.meta?.profil?.histoire??""}</textarea>
                </label>
                <label>
                  <span>Objectifs</span>
                  <textarea data-character-meta="profil" data-character-field="objectifs">${P.meta?.profil?.objectifs??""}</textarea>
                </label>
                <label>
                  <span>Relations</span>
                  <textarea data-character-meta="profil" data-character-field="relations">${P.meta?.profil?.relations??""}</textarea>
                </label>
              </div>
            `,m.profil)}
          ${St("evolution","Evolution",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Arc</span>
                  <textarea data-character-meta="evolution" data-character-field="arc">${P.meta?.evolution?.arc??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Changements</span>
                  <textarea data-character-meta="evolution" data-character-field="changements">${P.meta?.evolution?.changements??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Etapes cles</span>
                  <textarea data-character-meta="evolution" data-character-field="etapes">${P.meta?.evolution?.etapes??""}</textarea>
                </label>
              </div>
            `,m.evolution)}
          ${St("inventaire","Inventaire",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Objets</span>
                  <textarea data-character-meta="inventaire" data-character-field="items">${P.meta?.inventaire?.items??""}</textarea>
                </label>
              </div>
            `,m.inventaire)}
          ${St("possession","Possession",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Biens & lieux</span>
                  <textarea data-character-meta="possession" data-character-field="biens">${P.meta?.possession?.biens??""}</textarea>
                </label>
              </div>
            `,m.possession)}
          ${St("autres","Autres",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Notes libres</span>
                  <textarea data-character-meta="autres" data-character-field="notes">${P.meta?.autres?.notes??""}</textarea>
                </label>
              </div>
            `,m.autres)}
        </div>
      </div>
    `:`
      <div class="character-detail-panel empty">
        <p>Selectionnez un personnage.</p>
      </div>
    `,Af=`
        <section class="panel panel-card character-panel">
          <div class="character-shell">
            <aside class="character-list">
              <div class="character-list-header">
                <h2>Personnages</h2>
                <button type="button" class="character-primary" data-action="character-create">
                  + Nouveau personnage
                </button>
              </div>
              <div class="character-filter">
                <div class="character-filter-row">
                  <input id="character-filter" type="text" placeholder="Rechercher un personnage..." value="${p}" />
                </div>
              </div>
              <div class="character-items">
                ${_e.length?_e.map(L=>{const We=`${L.first_name??""} ${L.last_name??""}`.trim()||"Nouveau personnage",en=We.split(" ").filter(Boolean).slice(0,2).map(Kt=>Kt[0]?.toUpperCase()).join("")||"?";return`
                            <div class="character-item${L.id===f?" is-active":""}">
                              <button
                                type="button"
                                class="character-item-main"
                                data-action="character-select"
                                data-id="${L.id}"
                              >
                                <span class="character-avatar">${en}</span>
                                <span class="character-name">${We}</span>
                              </button>
                              <button
                                type="button"
                                class="character-item-delete"
                                data-action="character-delete"
                                data-id="${L.id}"
                                aria-label="Supprimer"
                                title="Supprimer"
                              >
                                ?
                              </button>
                            </div>
                          `}).join(""):'<p class="muted">Aucun personnage.</p>'}
              </div>
            </aside>
            ${Cf}
          </div>
        </section>
      `,Of=`
        <aside class="writing-secondary">
          <section class="panel panel-card chapter-panel">
            <div class="chapter-panel-header">
              <div>
                <h3>Votre recit</h3>
                <p class="muted">${E}</p>
              </div>
              <button type="button" class="secondary compact chapter-pin" aria-label="Epingler">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8 3l8 8-3 3-8-8z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                  <path d="M6 14l-2 7 7-2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <div class="chapter-search">
              <label for="chapter-search-input">Rechercher dans le texte</label>
              <div class="chapter-search-row">
                <input id="chapter-search-input" type="text" placeholder="Rechercher..." />
                <button type="button" class="secondary compact" aria-label="Rechercher">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="11" cy="11" r="6.5" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M16.5 16.5L21 21" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="chapter-list-header">
              <h4>Les chapitres</h4>
              <div class="chapter-list-actions">
                <button type="button" class="secondary compact" aria-label="Filtrer">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 6h10M4 12h16M4 18h7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </button>
                <button type="button" class="secondary compact" aria-label="Rechercher">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="11" cy="11" r="6.5" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M16.5 16.5L21 21" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </button>
                <button type="button" class="secondary compact" data-action="chapter-create" aria-label="Ajouter un chapitre" ${g?"":"disabled"}>
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
            </div>
            ${g?y?`<ul class="list chapter-list">${I}</ul>`:'<p class="muted">Cree un chapitre pour ecrire.</p>':'<p class="muted">Selectionne un projet.</p>'}
            <div class="chapter-panel-footer">
              <button type="button" class="secondary compact" data-action="chapter-create" ${g?"":"disabled"}>Chapitre</button>
              <button type="button" class="secondary compact">Importer</button>
            </div>
            <div class="chapter-export">
              ${tt}
            </div>
          </section>
        </aside>
      `;return`
    <section class="page-shell writing-page">
      ${Cu({userEmail:e,activeRoute:"editor",editorProjectId:n})}
      <div class="page app-shell">
        <div class="writing-layout">
        <aside class="writing-sidebar">
          <section class="panel panel-card writing-nav">
            <div class="writing-nav-header">Plumeo</div>
            <nav class="writing-nav-list" aria-label="Navigation ecriture">
              <button type="button" class="writing-nav-item${d==="chapter"?" is-active":""}" data-action="writing-nav" data-nav="chapter">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M4 20l4-1 11-11-3-3-11 11-1 4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M14 6l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Chapitre</span>
              </button>
              <button type="button" class="writing-nav-item${d==="characters"?" is-active":""}" data-action="writing-nav" data-nav="characters">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4.5" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M5 20c1.6-3.2 5-5 7-5s5.4 1.8 7 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Personnages</span>
              </button>
              <button type="button" class="writing-nav-item${d==="structure"?" is-active":""}" data-action="writing-nav" data-nav="structure">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 4h12v4H6zM6 10h12v10H6z" fill="none" stroke="currentColor" stroke-width="1.6"/>
                  </svg>
                </span>
                <span>Structurer son recit</span>
              </button>
              <button type="button" class="writing-nav-item${d==="documents"?" is-active":""}" data-action="writing-nav" data-nav="documents">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 4h9l3 3v13H6z" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M9 11h6M9 15h6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Documents</span>
              </button>
              <button type="button" class="writing-nav-item${d==="encyclopedia"?" is-active":""}" data-action="writing-nav" data-nav="encyclopedia">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 4h12v16H6z" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M9 7h6M9 11h6M9 15h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Encyclopedie</span>
              </button>
              <button type="button" class="writing-nav-item${d==="images"?" is-active":""}" data-action="writing-nav" data-nav="images">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <rect x="4" y="6" width="16" height="12" rx="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M8 10l3 3 5-5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <span>Generateur d'images</span>
              </button>
              <button type="button" class="writing-nav-item${d==="mindmap"?" is-active":""}" data-action="writing-nav" data-nav="mindmap">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <circle cx="8" cy="8" r="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <circle cx="16" cy="16" r="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M9.5 9.5l5 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Carte mentale</span>
              </button>
              <button type="button" class="writing-nav-item${d==="appendix"?" is-active":""}" data-action="writing-nav" data-nav="appendix">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 5h9a3 3 0 0 1 3 3v11H6z" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M6 8h12" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Luminaires &amp; Annexes</span>
              </button>
              <button type="button" class="writing-nav-item${d==="goals"?" is-active":""}" data-action="writing-nav" data-nav="goals">
                <span class="writing-nav-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M5 19V9m7 10V5m7 14v-7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span>Objectifs &amp; stats</span>
              </button>
            </nav>
          </section>
        </aside>

        ${d==="chapter"?Of:""}

        <main class="writing-editor">
        ${d==="characters"?Af:`
            <section class="panel panel-card editor ${w?"":"is-disabled"}">
              <div class="panel-header">
                <div>
                  <h2>3. Ecriture</h2>
                  <p class="context">Projet: ${E} / Chapitre: ${j} / Position: ${x}</p>
                </div>
                <span id="status-text" class="status">${c}</span>
              </div>
              <div class="editor-body">
                ${Re}
              </div>
            </section>
          `}
        </main>
        <aside class="writing-rightbar">
          <section class="panel panel-card">
            <div class="editor-tabs" role="tablist" aria-label="Navigation editor">
              ${Y.map(L=>`
                    <div class="editor-tab-block">
                      <button
                        class="editor-tab${L.id===u?" is-active":""}"
                        type="button"
                        data-action="editor-tab"
                        data-tab="${L.id}"
                        role="tab"
                        aria-selected="${L.id===u}"
                      >
                        ${L.label}
                      </button>
                      ${L.id===u?`<div class="editor-tab-content" role="tabpanel">
                              ${Be[L.id]??""}
                            </div>`:""}
                    </div>
                  `).join("")}
            </div>
          </section>
        </aside>
        </div>
        ${je}
      </div>
    </section>
  `}async function Vt(){try{const{data:r,error:e}=await le.auth.getUser();return e?{ok:!1,errorMessage:e.message}:r.user?{ok:!0,userId:r.user.id}:{ok:!1,errorMessage:"User not authenticated"}}catch(r){return{ok:!1,errorMessage:r.message}}}async function gg(){const r=await Vt();if(!r.ok)return r;try{const{data:e,error:t}=await le.from("projects").select("id,title,created_at").eq("user_id",r.userId).order("created_at",{ascending:!0});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Au(r){const e=await Vt();if(!e.ok)return e;try{const{data:t,error:n}=await le.from("projects").insert({title:r,user_id:e.userId}).select("id,title,created_at").single();return n?{ok:!1,errorMessage:n.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function yg(r,e){try{const{data:t,error:n}=await le.from("projects").update({title:e}).eq("id",r).select("id,title").single();return n?{ok:!1,errorMessage:n.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function bg(r){const e=await Vt();if(!e.ok)return e;try{const{error:t}=await le.from("chapters").delete().eq("project_id",r).eq("user_id",e.userId);if(t)return{ok:!1,errorMessage:t.message};const{error:n}=await le.from("projects").delete().eq("id",r).eq("user_id",e.userId);return n?{ok:!1,errorMessage:n.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function wg(r){try{const{data:e,error:t}=await le.from("chapters").select("id,project_id,title,order_index,revision").eq("project_id",r).order("order_index",{ascending:!0});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Ou(r,e,t){const n=await Vt();if(!n.ok)return n;try{const{data:s,error:i}=await le.from("chapters").insert({project_id:r,title:e,order_index:t,user_id:n.userId}).select("id,project_id,title,order_index,revision,content_md").single();return i?{ok:!1,errorMessage:i.message}:{ok:!0,data:s}}catch(s){return{ok:!1,errorMessage:s.message}}}async function vg(r){try{const{data:e,error:t}=await le.from("chapters").select("id,project_id,title,content_md,order_index,revision").eq("id",r).single();return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Mu(r){return vg(r)}async function kg(r,e){try{const{data:t,error:n}=await le.from("chapters").update(e).eq("id",r).select("id").single();return n?{ok:!1,errorMessage:n.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Sg({id:r,title:e,content_md:t,baseRevision:n}){const s=await Vt();if(!s.ok)return s;const i=o=>{if(Array.isArray(o)){const a=o[0];return a&&typeof a.new_revision<"u"?Number(a.new_revision):Number(o[0])}return o&&typeof o.new_revision<"u"?Number(o.new_revision):Number(o)};try{const{data:o,error:a}=await le.rpc("update_chapter_if_revision",{p_id:r,p_user_id:s.userId,p_title:e,p_content_md:t,p_base_revision:n});if(a)return{ok:!1,errorMessage:a.message};const l=i(o);return{ok:!0,newRevision:Number.isFinite(l)?l:-1}}catch(o){return{ok:!1,errorMessage:o.message}}}async function xg(r){try{const{data:e,error:t}=await le.from("versions").select("id,chapter_id,label,content_md,created_at").eq("chapter_id",r).order("created_at",{ascending:!1});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Iu(r,e,t=null){const n=await Vt();if(!n.ok)return n;try{const{data:s,error:i}=await le.from("versions").insert({chapter_id:r,user_id:n.userId,content_md:e,label:t}).select("id,chapter_id,label,content_md,created_at").single();return i?{ok:!1,errorMessage:i.message}:{ok:!0,data:s}}catch(s){return{ok:!1,errorMessage:s.message}}}const Tg="writer_db",_g=3;let es=null;function wi(){return es||(es=new Promise((r,e)=>{const t=indexedDB.open(Tg,_g);t.onupgradeneeded=()=>{const n=t.result;n.objectStoreNames.contains("projects")||n.createObjectStore("projects",{keyPath:"id"}),n.objectStoreNames.contains("chapters")||n.createObjectStore("chapters",{keyPath:"id"}),n.objectStoreNames.contains("outbox")||n.createObjectStore("outbox",{keyPath:"opId"}),n.objectStoreNames.contains("inbox")||n.createObjectStore("inbox",{keyPath:"id"}),n.objectStoreNames.contains("characters")||n.createObjectStore("characters",{keyPath:"id"})},t.onsuccess=()=>r(t.result),t.onerror=()=>e(t.error)}),es)}async function ke(r,e){const t=await wi();return new Promise((n,s)=>{const i=t.transaction(r,"readwrite");i.oncomplete=()=>n(),i.onerror=()=>s(i.error),i.objectStore(r).put(e)})}async function Fn(r,e){const t=await wi();return new Promise((n,s)=>{const o=t.transaction(r,"readonly").objectStore(r).get(e);o.onsuccess=()=>n(o.result),o.onerror=()=>s(o.error)})}async function be(r){const e=await wi();return new Promise((t,n)=>{const i=e.transaction(r,"readonly").objectStore(r).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async function $t(r,e){const t=await wi();return new Promise((n,s)=>{const i=t.transaction(r,"readwrite");i.oncomplete=()=>n(),i.onerror=()=>s(i.error),i.objectStore(r).delete(e)})}function Eg(r,e){const t=e??{},n=r.revision??r.remote_revision??t.remote_revision??0,s=t.dirty===!0||t.conflict===!0,i=s?t.content_md??r.content_md??"":r.content_md??t.content_md??"",o=s?t.title??r.title??"":r.title??t.title??"";return{id:r.id??t.id,project_id:r.project_id??t.project_id,title:o,content_md:i,order_index:r.order_index??t.order_index??0,remote_revision:s?t.remote_revision??n:n,dirty:t.dirty??!1,conflict:t.conflict??!1,server_copy:t.server_copy??null,updated_local_at:t.updated_local_at??null,last_snapshot_at:t.last_snapshot_at??null}}async function Yr(r){for(const e of r)await ke("projects",e)}async function Qr(r){for(const e of r){const t=await Fn("chapters",e.id),n=Eg(e,t);await ke("chapters",n)}}async function Cg(){return be("projects")}async function Ru(r){return(await be("chapters")).filter(t=>t.project_id===r).sort((t,n)=>(t.order_index??0)-(n.order_index??0))}async function vi(r){return Fn("chapters",r)}async function Ag(r){r&&await $t("projects",r)}async function Og(r){if(!r)return;const t=(await be("chapters")).filter(n=>n.project_id===r);for(const n of t)await $t("chapters",n.id)}async function xa(r,e){const t=await Fn("chapters",r),n={...t??{id:r},...e,remote_revision:e.remote_revision??t?.remote_revision??0,dirty:!0,conflict:t?.conflict??!1,server_copy:t?.server_copy??null,updated_local_at:Date.now(),last_snapshot_at:e.last_snapshot_at??t?.last_snapshot_at??null};return await ke("chapters",n),n}async function Mg(){return(await be("inbox")).sort((e,t)=>(t.created_at??0)-(e.created_at??0))}async function Ig(r){const e=r.trim();if(!e)return null;const t={id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,text:e,created_at:Date.now(),status:"to_sort"};return await ke("inbox",t),t}async function Rg(r,e){const t=await Fn("inbox",r);if(!t)return null;const n={...t,...e};return await ke("inbox",n),n}async function Ng(r){r&&await $t("inbox",r)}async function Pg(r){return(await be("characters")).filter(t=>t.project_id===r).sort((t,n)=>(t.created_at??0)-(n.created_at??0))}async function Dg(r){const e=Date.now(),t={id:`${e}-${Math.random().toString(16).slice(2)}`,project_id:r,first_name:"",last_name:"",nickname:"",pronouns:"",sex:"",race:"",age:"",birth_date:"",birth_place:"",residence:"",occupation:"",role_rating:0,avatar_url:"",meta:{physique:{taille:"",corpulence:"",signes:"",style:""},caractere:{traits:"",qualites:"",defauts:"",peurs:""},profil:{histoire:"",objectifs:"",relations:""},evolution:{arc:"",changements:"",etapes:""},inventaire:{items:""},possession:{biens:""},autres:{notes:""}},created_at:e,updated_at:e};return await ke("characters",t),t}async function Nu(r,e){const t=await Fn("characters",r);if(!t)return null;const n={...t,...e,meta:{...t.meta??{},...e.meta??{}},updated_at:Date.now()};return await ke("characters",n),n}async function $g(r){r&&await $t("characters",r)}const Lo="writer:lastProjectId",jo="writer:lastChapterId",Bo="plumeo:lastCloudSaveAt";function Hn(){try{return localStorage.getItem(Lo)}catch{return null}}function Xr(r){try{if(!r){localStorage.removeItem(Lo);return}localStorage.setItem(Lo,r)}catch{}}function Lg(){try{return localStorage.getItem(jo)}catch{return null}}function Ts(r){try{if(!r){localStorage.removeItem(jo);return}localStorage.setItem(jo,r)}catch{}}function jg(){try{const r=localStorage.getItem(Bo);if(!r)return null;const e=Number(r);return Number.isFinite(e)?e:null}catch{return null}}function Pu(r){try{if(!r){localStorage.removeItem(Bo);return}localStorage.setItem(Bo,String(r))}catch{}}function Bg(r){if(typeof r=="number")return r;if(typeof r=="string")try{const e=JSON.parse(r);return Array.isArray(e)&&e[0]?.new_revision!=null?Number(e[0].new_revision)||0:e&&e.new_revision!=null?Number(e.new_revision)||0:Number(e)||0}catch{return Number(r)||0}return r&&typeof r.new_revision<"u"?Number(r.new_revision)||0:Array.isArray(r)&&r[0]?.new_revision!=null?Number(r[0].new_revision)||0:Number(r)||0}async function Ta(r){const e={opId:`${Date.now()}-${Math.random().toString(16).slice(2)}`,type:"UPSERT_CHAPTER",chapterId:r,createdAt:Date.now()};return await ke("outbox",e),e}async function ki(){if(!navigator.onLine)return[];const r=await be("outbox"),e=[];for(const t of r){if(t.type!=="UPSERT_CHAPTER")continue;const n=await vi(t.chapterId);if(!n){await $t("outbox",t.opId);continue}const s=await Sg({id:n.id,title:n.title??"",content_md:n.content_md??"",baseRevision:Bg(n.remote_revision)});if(!s.ok){console.error("syncOnce rpc error",s.errorMessage);continue}if(s.newRevision===-1){const o=await Mu(n.id);if(o.ok){const a={...n,conflict:!0,server_copy:o.data,dirty:!0};await ke("chapters",a)}await $t("outbox",t.opId),e.push({chapterId:n.id,status:"conflict"});continue}const i={...n,remote_revision:s.newRevision,dirty:!1,conflict:!1,server_copy:null};await ke("chapters",i),await $t("outbox",t.opId),e.push({chapterId:n.id,status:"synced"})}return e}function zg(r){const e=async()=>{try{const n=await ki();r&&await r(n)}catch(n){console.error("syncLoop error",n)}},t=window.setInterval(e,5e3);return window.addEventListener("online",e),t}function me(r){this.content=r}me.prototype={constructor:me,find:function(r){for(var e=0;e<this.content.length;e+=2)if(this.content[e]===r)return e;return-1},get:function(r){var e=this.find(r);return e==-1?void 0:this.content[e+1]},update:function(r,e,t){var n=t&&t!=r?this.remove(t):this,s=n.find(r),i=n.content.slice();return s==-1?i.push(t||r,e):(i[s+1]=e,t&&(i[s]=t)),new me(i)},remove:function(r){var e=this.find(r);if(e==-1)return this;var t=this.content.slice();return t.splice(e,2),new me(t)},addToStart:function(r,e){return new me([r,e].concat(this.remove(r).content))},addToEnd:function(r,e){var t=this.remove(r).content.slice();return t.push(r,e),new me(t)},addBefore:function(r,e,t){var n=this.remove(e),s=n.content.slice(),i=n.find(r);return s.splice(i==-1?s.length:i,0,e,t),new me(s)},forEach:function(r){for(var e=0;e<this.content.length;e+=2)r(this.content[e],this.content[e+1])},prepend:function(r){return r=me.from(r),r.size?new me(r.content.concat(this.subtract(r).content)):this},append:function(r){return r=me.from(r),r.size?new me(this.subtract(r).content.concat(r.content)):this},subtract:function(r){var e=this;r=me.from(r);for(var t=0;t<r.content.length;t+=2)e=e.remove(r.content[t]);return e},toObject:function(){var r={};return this.forEach(function(e,t){r[e]=t}),r},get size(){return this.content.length>>1}};me.from=function(r){if(r instanceof me)return r;var e=[];if(r)for(var t in r)e.push(t,r[t]);return new me(e)};function Du(r,e,t){for(let n=0;;n++){if(n==r.childCount||n==e.childCount)return r.childCount==e.childCount?null:t;let s=r.child(n),i=e.child(n);if(s==i){t+=s.nodeSize;continue}if(!s.sameMarkup(i))return t;if(s.isText&&s.text!=i.text){for(let o=0;s.text[o]==i.text[o];o++)t++;return t}if(s.content.size||i.content.size){let o=Du(s.content,i.content,t+1);if(o!=null)return o}t+=s.nodeSize}}function $u(r,e,t,n){for(let s=r.childCount,i=e.childCount;;){if(s==0||i==0)return s==i?null:{a:t,b:n};let o=r.child(--s),a=e.child(--i),l=o.nodeSize;if(o==a){t-=l,n-=l;continue}if(!o.sameMarkup(a))return{a:t,b:n};if(o.isText&&o.text!=a.text){let c=0,u=Math.min(o.text.length,a.text.length);for(;c<u&&o.text[o.text.length-c-1]==a.text[a.text.length-c-1];)c++,t--,n--;return{a:t,b:n}}if(o.content.size||a.content.size){let c=$u(o.content,a.content,t-1,n-1);if(c)return c}t-=l,n-=l}}class k{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let n=0;n<e.length;n++)this.size+=e[n].nodeSize}nodesBetween(e,t,n,s=0,i){for(let o=0,a=0;a<t;o++){let l=this.content[o],c=a+l.nodeSize;if(c>e&&n(l,s+a,i||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),n,s+u)}a=c}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,n,s){let i="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let c=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?s?typeof s=="function"?s(a):s:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&c||a.isTextblock)&&n&&(o?o=!1:i+=n),i+=c},0),i}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,n=e.firstChild,s=this.content.slice(),i=0;for(t.isText&&t.sameMarkup(n)&&(s[s.length-1]=t.withText(t.text+n.text),i=1);i<e.content.length;i++)s.push(e.content[i]);return new k(s,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let n=[],s=0;if(t>e)for(let i=0,o=0;o<t;i++){let a=this.content[i],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),n.push(a),s+=a.nodeSize),o=l}return new k(n,s)}cutByIndex(e,t){return e==t?k.empty:e==0&&t==this.content.length?this:new k(this.content.slice(e,t))}replaceChild(e,t){let n=this.content[e];if(n==t)return this;let s=this.content.slice(),i=this.size+t.nodeSize-n.nodeSize;return s[e]=t,new k(s,i)}addToStart(e){return new k([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new k(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,n=0;t<this.content.length;t++){let s=this.content[t];e(s,n,t),n+=s.nodeSize}}findDiffStart(e,t=0){return Du(this,e,t)}findDiffEnd(e,t=this.size,n=e.size){return $u(this,e,t,n)}findIndex(e){if(e==0)return ts(0,e);if(e==this.size)return ts(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let t=0,n=0;;t++){let s=this.child(t),i=n+s.nodeSize;if(i>=e)return i==e?ts(t+1,i):ts(t,n);n=i}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return k.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new k(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return k.empty;let t,n=0;for(let s=0;s<e.length;s++){let i=e[s];n+=i.nodeSize,s&&i.isText&&e[s-1].sameMarkup(i)?(t||(t=e.slice(0,s)),t[t.length-1]=i.withText(t[t.length-1].text+i.text)):t&&t.push(i)}return new k(t||e,n)}static from(e){if(!e)return k.empty;if(e instanceof k)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new k([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}k.empty=new k([],0);const Ji={index:0,offset:0};function ts(r,e){return Ji.index=r,Ji.offset=e,Ji}function _s(r,e){if(r===e)return!0;if(!(r&&typeof r=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(r);if(Array.isArray(e)!=t)return!1;if(t){if(r.length!=e.length)return!1;for(let n=0;n<r.length;n++)if(!_s(r[n],e[n]))return!1}else{for(let n in r)if(!(n in e)||!_s(r[n],e[n]))return!1;for(let n in e)if(!(n in r))return!1}return!0}let V=class zo{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,n=!1;for(let s=0;s<e.length;s++){let i=e[s];if(this.eq(i))return e;if(this.type.excludes(i.type))t||(t=e.slice(0,s));else{if(i.type.excludes(this.type))return e;!n&&i.type.rank>this.type.rank&&(t||(t=e.slice(0,s)),t.push(this),n=!0),t&&t.push(i)}}return t||(t=e.slice()),n||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&_s(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let n=e.marks[t.type];if(!n)throw new RangeError(`There is no mark type ${t.type} in this schema`);let s=n.create(t.attrs);return n.checkAttrs(s.attrs),s}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++)if(!e[n].eq(t[n]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return zo.none;if(e instanceof zo)return[e];let t=e.slice();return t.sort((n,s)=>n.type.rank-s.type.rank),t}};V.none=[];class Es extends Error{}class C{constructor(e,t,n){this.content=e,this.openStart=t,this.openEnd=n}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let n=ju(this.content,e+this.openStart,t);return n&&new C(n,this.openStart,this.openEnd)}removeBetween(e,t){return new C(Lu(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return C.empty;let n=t.openStart||0,s=t.openEnd||0;if(typeof n!="number"||typeof s!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new C(k.fromJSON(e,t.content),n,s)}static maxOpen(e,t=!0){let n=0,s=0;for(let i=e.firstChild;i&&!i.isLeaf&&(t||!i.type.spec.isolating);i=i.firstChild)n++;for(let i=e.lastChild;i&&!i.isLeaf&&(t||!i.type.spec.isolating);i=i.lastChild)s++;return new C(e,n,s)}}C.empty=new C(k.empty,0,0);function Lu(r,e,t){let{index:n,offset:s}=r.findIndex(e),i=r.maybeChild(n),{index:o,offset:a}=r.findIndex(t);if(s==e||i.isText){if(a!=t&&!r.child(o).isText)throw new RangeError("Removing non-flat range");return r.cut(0,e).append(r.cut(t))}if(n!=o)throw new RangeError("Removing non-flat range");return r.replaceChild(n,i.copy(Lu(i.content,e-s-1,t-s-1)))}function ju(r,e,t,n){let{index:s,offset:i}=r.findIndex(e),o=r.maybeChild(s);if(i==e||o.isText)return n&&!n.canReplace(s,s,t)?null:r.cut(0,e).append(t).append(r.cut(e));let a=ju(o.content,e-i-1,t,o);return a&&r.replaceChild(s,o.copy(a))}function Ug(r,e,t){if(t.openStart>r.depth)throw new Es("Inserted content deeper than insertion position");if(r.depth-t.openStart!=e.depth-t.openEnd)throw new Es("Inconsistent open depths");return Bu(r,e,t,0)}function Bu(r,e,t,n){let s=r.index(n),i=r.node(n);if(s==e.index(n)&&n<r.depth-t.openStart){let o=Bu(r,e,t,n+1);return i.copy(i.content.replaceChild(s,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&r.depth==n&&e.depth==n){let o=r.parent,a=o.content;return cr(o,a.cut(0,r.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=Fg(t,r);return cr(i,Uu(r,o,a,e,n))}else return cr(i,Cs(r,e,n))}function zu(r,e){if(!e.type.compatibleContent(r.type))throw new Es("Cannot join "+e.type.name+" onto "+r.type.name)}function Uo(r,e,t){let n=r.node(t);return zu(n,e.node(t)),n}function lr(r,e){let t=e.length-1;t>=0&&r.isText&&r.sameMarkup(e[t])?e[t]=r.withText(e[t].text+r.text):e.push(r)}function hn(r,e,t,n){let s=(e||r).node(t),i=0,o=e?e.index(t):s.childCount;r&&(i=r.index(t),r.depth>t?i++:r.textOffset&&(lr(r.nodeAfter,n),i++));for(let a=i;a<o;a++)lr(s.child(a),n);e&&e.depth==t&&e.textOffset&&lr(e.nodeBefore,n)}function cr(r,e){return r.type.checkContent(e),r.copy(e)}function Uu(r,e,t,n,s){let i=r.depth>s&&Uo(r,e,s+1),o=n.depth>s&&Uo(t,n,s+1),a=[];return hn(null,r,s,a),i&&o&&e.index(s)==t.index(s)?(zu(i,o),lr(cr(i,Uu(r,e,t,n,s+1)),a)):(i&&lr(cr(i,Cs(r,e,s+1)),a),hn(e,t,s,a),o&&lr(cr(o,Cs(t,n,s+1)),a)),hn(n,null,s,a),new k(a)}function Cs(r,e,t){let n=[];if(hn(null,r,t,n),r.depth>t){let s=Uo(r,e,t+1);lr(cr(s,Cs(r,e,t+1)),n)}return hn(e,null,t,n),new k(n)}function Fg(r,e){let t=e.depth-r.openStart,s=e.node(t).copy(r.content);for(let i=t-1;i>=0;i--)s=e.node(i).copy(k.from(s));return{start:s.resolveNoCache(r.openStart+t),end:s.resolveNoCache(s.content.size-r.openEnd-t)}}class Mn{constructor(e,t,n){this.pos=e,this.path=t,this.parentOffset=n,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let n=this.pos-this.path[this.path.length-1],s=e.child(t);return n?e.child(t).cut(n):s}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let n=this.path[t*3],s=t==0?0:this.path[t*3-1]+1;for(let i=0;i<e;i++)s+=n.child(i).nodeSize;return s}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return V.none;if(this.textOffset)return e.child(t).marks;let n=e.maybeChild(t-1),s=e.maybeChild(t);if(!n){let a=n;n=s,s=a}let i=n.marks;for(var o=0;o<i.length;o++)i[o].type.spec.inclusive===!1&&(!s||!i[o].isInSet(s.marks))&&(i=i[o--].removeFromSet(i));return i}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let n=t.marks,s=e.parent.maybeChild(e.index());for(var i=0;i<n.length;i++)n[i].type.spec.inclusive===!1&&(!s||!n[i].isInSet(s.marks))&&(n=n[i--].removeFromSet(n));return n}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let n=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);n>=0;n--)if(e.pos<=this.end(n)&&(!t||t(this.node(n))))return new As(this,e,n);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let n=[],s=0,i=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(i),c=i-l;if(n.push(o,a,s+l),!c||(o=o.child(a),o.isText))break;i=c-1,s+=l+1}return new Mn(t,n,i)}static resolveCached(e,t){let n=jl.get(e);if(n)for(let i=0;i<n.elts.length;i++){let o=n.elts[i];if(o.pos==t)return o}else jl.set(e,n=new Hg);let s=n.elts[n.i]=Mn.resolve(e,t);return n.i=(n.i+1)%Vg,s}}class Hg{constructor(){this.elts=[],this.i=0}}const Vg=12,jl=new WeakMap;class As{constructor(e,t,n){this.$from=e,this.$to=t,this.depth=n}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const qg=Object.create(null);class Ze{constructor(e,t,n,s=V.none){this.type=e,this.attrs=t,this.marks=s,this.content=n||k.empty}get children(){return this.content.content}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,n,s=0){this.content.nodesBetween(e,t,n,s,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,n,s){return this.content.textBetween(e,t,n,s)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,n){return this.type==e&&_s(this.attrs,t||e.defaultAttrs||qg)&&V.sameSet(this.marks,n||V.none)}copy(e=null){return e==this.content?this:new Ze(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new Ze(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,n=!1){if(e==t)return C.empty;let s=this.resolve(e),i=this.resolve(t),o=n?0:s.sharedDepth(t),a=s.start(o),c=s.node(o).content.cut(s.pos-a,i.pos-a);return new C(c,s.depth-o,i.depth-o)}replace(e,t,n){return Ug(this.resolve(e),this.resolve(t),n)}nodeAt(e){for(let t=this;;){let{index:n,offset:s}=t.content.findIndex(e);if(t=t.maybeChild(n),!t)return null;if(s==e||t.isText)return t;e-=s+1}}childAfter(e){let{index:t,offset:n}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:n}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:n}=this.content.findIndex(e);if(n<e)return{node:this.content.child(t),index:t,offset:n};let s=this.content.child(t-1);return{node:s,index:t-1,offset:n-s.nodeSize}}resolve(e){return Mn.resolveCached(this,e)}resolveNoCache(e){return Mn.resolve(this,e)}rangeHasMark(e,t,n){let s=!1;return t>e&&this.nodesBetween(e,t,i=>(n.isInSet(i.marks)&&(s=!0),!s)),s}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),Fu(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,n=k.empty,s=0,i=n.childCount){let o=this.contentMatchAt(e).matchFragment(n,s,i),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=s;l<i;l++)if(!this.type.allowsMarks(n.child(l).marks))return!1;return!0}canReplaceWith(e,t,n,s){if(s&&!this.type.allowsMarks(s))return!1;let i=this.contentMatchAt(e).matchType(n),o=i&&i.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=V.none;for(let t=0;t<this.marks.length;t++){let n=this.marks[t];n.type.checkAttrs(n.attrs),e=n.addToSet(e)}if(!V.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let n;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");n=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,n)}let s=k.fromJSON(e,t.content),i=e.nodeType(t.type).create(t.attrs,s,n);return i.type.checkAttrs(i.attrs),i}}Ze.prototype.text=void 0;class Os extends Ze{constructor(e,t,n,s){if(super(e,t,null,s),!n)throw new RangeError("Empty text nodes are not allowed");this.text=n}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):Fu(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Os(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Os(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function Fu(r,e){for(let t=r.length-1;t>=0;t--)e=r[t].type.name+"("+e+")";return e}class fr{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let n=new Wg(e,t);if(n.next==null)return fr.empty;let s=Hu(n);n.next&&n.err("Unexpected trailing text");let i=Zg(Xg(s));return ey(i,n),i}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,n=e.childCount){let s=this;for(let i=t;s&&i<n;i++)s=s.matchType(e.child(i).type);return s}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let n=0;n<e.next.length;n++)if(this.next[t].type==e.next[n].type)return!0;return!1}fillBefore(e,t=!1,n=0){let s=[this];function i(o,a){let l=o.matchFragment(e,n);if(l&&(!t||l.validEnd))return k.from(a.map(c=>c.createAndFill()));for(let c=0;c<o.next.length;c++){let{type:u,next:d}=o.next[c];if(!(u.isText||u.hasRequiredAttrs())&&s.indexOf(d)==-1){s.push(d);let h=i(d,a.concat(u));if(h)return h}}return null}return i(this,[])}findWrapping(e){for(let n=0;n<this.wrapCache.length;n+=2)if(this.wrapCache[n]==e)return this.wrapCache[n+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),n=[{match:this,type:null,via:null}];for(;n.length;){let s=n.shift(),i=s.match;if(i.matchType(e)){let o=[];for(let a=s;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<i.next.length;o++){let{type:a,next:l}=i.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!s.type||l.validEnd)&&(n.push({match:a.contentMatch,type:a,via:s}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(n){e.push(n);for(let s=0;s<n.next.length;s++)e.indexOf(n.next[s].next)==-1&&t(n.next[s].next)}return t(this),e.map((n,s)=>{let i=s+(n.validEnd?"*":" ")+" ";for(let o=0;o<n.next.length;o++)i+=(o?", ":"")+n.next[o].type.name+"->"+e.indexOf(n.next[o].next);return i}).join(`
`)}}fr.empty=new fr(!0);class Wg{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function Hu(r){let e=[];do e.push(Kg(r));while(r.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function Kg(r){let e=[];do e.push(Jg(r));while(r.next&&r.next!=")"&&r.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function Jg(r){let e=Qg(r);for(;;)if(r.eat("+"))e={type:"plus",expr:e};else if(r.eat("*"))e={type:"star",expr:e};else if(r.eat("?"))e={type:"opt",expr:e};else if(r.eat("{"))e=Gg(r,e);else break;return e}function Bl(r){/\D/.test(r.next)&&r.err("Expected number, got '"+r.next+"'");let e=Number(r.next);return r.pos++,e}function Gg(r,e){let t=Bl(r),n=t;return r.eat(",")&&(r.next!="}"?n=Bl(r):n=-1),r.eat("}")||r.err("Unclosed braced range"),{type:"range",min:t,max:n,expr:e}}function Yg(r,e){let t=r.nodeTypes,n=t[e];if(n)return[n];let s=[];for(let i in t){let o=t[i];o.isInGroup(e)&&s.push(o)}return s.length==0&&r.err("No node type or group '"+e+"' found"),s}function Qg(r){if(r.eat("(")){let e=Hu(r);return r.eat(")")||r.err("Missing closing paren"),e}else if(/\W/.test(r.next))r.err("Unexpected token '"+r.next+"'");else{let e=Yg(r,r.next).map(t=>(r.inline==null?r.inline=t.isInline:r.inline!=t.isInline&&r.err("Mixing inline and block content"),{type:"name",value:t}));return r.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function Xg(r){let e=[[]];return s(i(r,0),t()),e;function t(){return e.push([])-1}function n(o,a,l){let c={term:l,to:a};return e[o].push(c),c}function s(o,a){o.forEach(l=>l.to=a)}function i(o,a){if(o.type=="choice")return o.exprs.reduce((l,c)=>l.concat(i(c,a)),[]);if(o.type=="seq")for(let l=0;;l++){let c=i(o.exprs[l],a);if(l==o.exprs.length-1)return c;s(c,a=t())}else if(o.type=="star"){let l=t();return n(a,l),s(i(o.expr,l),l),[n(l)]}else if(o.type=="plus"){let l=t();return s(i(o.expr,a),l),s(i(o.expr,l),l),[n(l)]}else{if(o.type=="opt")return[n(a)].concat(i(o.expr,a));if(o.type=="range"){let l=a;for(let c=0;c<o.min;c++){let u=t();s(i(o.expr,l),u),l=u}if(o.max==-1)s(i(o.expr,l),l);else for(let c=o.min;c<o.max;c++){let u=t();n(l,u),s(i(o.expr,l),u),l=u}return[n(l)]}else{if(o.type=="name")return[n(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function Vu(r,e){return e-r}function zl(r,e){let t=[];return n(e),t.sort(Vu);function n(s){let i=r[s];if(i.length==1&&!i[0].term)return n(i[0].to);t.push(s);for(let o=0;o<i.length;o++){let{term:a,to:l}=i[o];!a&&t.indexOf(l)==-1&&n(l)}}}function Zg(r){let e=Object.create(null);return t(zl(r,0));function t(n){let s=[];n.forEach(o=>{r[o].forEach(({term:a,to:l})=>{if(!a)return;let c;for(let u=0;u<s.length;u++)s[u][0]==a&&(c=s[u][1]);zl(r,l).forEach(u=>{c||s.push([a,c=[]]),c.indexOf(u)==-1&&c.push(u)})})});let i=e[n.join(",")]=new fr(n.indexOf(r.length-1)>-1);for(let o=0;o<s.length;o++){let a=s[o][1].sort(Vu);i.next.push({type:s[o][0],next:e[a.join(",")]||t(a)})}return i}}function ey(r,e){for(let t=0,n=[r];t<n.length;t++){let s=n[t],i=!s.validEnd,o=[];for(let a=0;a<s.next.length;a++){let{type:l,next:c}=s.next[a];o.push(l.name),i&&!(l.isText||l.hasRequiredAttrs())&&(i=!1),n.indexOf(c)==-1&&n.push(c)}i&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function qu(r){let e=Object.create(null);for(let t in r){let n=r[t];if(!n.hasDefault)return null;e[t]=n.default}return e}function Wu(r,e){let t=Object.create(null);for(let n in r){let s=e&&e[n];if(s===void 0){let i=r[n];if(i.hasDefault)s=i.default;else throw new RangeError("No value supplied for attribute "+n)}t[n]=s}return t}function Ku(r,e,t,n){for(let s in e)if(!(s in r))throw new RangeError(`Unsupported attribute ${s} for ${t} of type ${s}`);for(let s in r){let i=r[s];i.validate&&i.validate(e[s])}}function Ju(r,e){let t=Object.create(null);if(e)for(let n in e)t[n]=new ry(r,n,e[n]);return t}let Ul=class Gu{constructor(e,t,n){this.name=e,this.schema=t,this.spec=n,this.markSet=null,this.groups=n.group?n.group.split(" "):[],this.attrs=Ju(e,n.attrs),this.defaultAttrs=qu(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(n.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==fr.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}isInGroup(e){return this.groups.indexOf(e)>-1}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:Wu(this.attrs,e)}create(e=null,t,n){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new Ze(this,this.computeAttrs(e),k.from(t),V.setFrom(n))}createChecked(e=null,t,n){return t=k.from(t),this.checkContent(t),new Ze(this,this.computeAttrs(e),t,V.setFrom(n))}createAndFill(e=null,t,n){if(e=this.computeAttrs(e),t=k.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let s=this.contentMatch.matchFragment(t),i=s&&s.fillBefore(k.empty,!0);return i?new Ze(this,e,t.append(i),V.setFrom(n)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let n=0;n<e.childCount;n++)if(!this.allowsMarks(e.child(n).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){Ku(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let n=0;n<e.length;n++)this.allowsMarkType(e[n].type)?t&&t.push(e[n]):t||(t=e.slice(0,n));return t?t.length?t:V.none:e}static compile(e,t){let n=Object.create(null);e.forEach((i,o)=>n[i]=new Gu(i,t,o));let s=t.spec.topNode||"doc";if(!n[s])throw new RangeError("Schema is missing its top node type ('"+s+"')");if(!n.text)throw new RangeError("Every schema needs a 'text' type");for(let i in n.text.attrs)throw new RangeError("The text node type should not have attributes");return n}};function ty(r,e,t){let n=t.split("|");return s=>{let i=s===null?"null":typeof s;if(n.indexOf(i)<0)throw new RangeError(`Expected value of type ${n} for attribute ${e} on type ${r}, got ${i}`)}}class ry{constructor(e,t,n){this.hasDefault=Object.prototype.hasOwnProperty.call(n,"default"),this.default=n.default,this.validate=typeof n.validate=="string"?ty(e,t,n.validate):n.validate}get isRequired(){return!this.hasDefault}}class Si{constructor(e,t,n,s){this.name=e,this.rank=t,this.schema=n,this.spec=s,this.attrs=Ju(e,s.attrs),this.excluded=null;let i=qu(this.attrs);this.instance=i?new V(this,i):null}create(e=null){return!e&&this.instance?this.instance:new V(this,Wu(this.attrs,e))}static compile(e,t){let n=Object.create(null),s=0;return e.forEach((i,o)=>n[i]=new Si(i,s++,t,o)),n}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){Ku(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Yu{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let s in e)t[s]=e[s];t.nodes=me.from(e.nodes),t.marks=me.from(e.marks||{}),this.nodes=Ul.compile(this.spec.nodes,this),this.marks=Si.compile(this.spec.marks,this);let n=Object.create(null);for(let s in this.nodes){if(s in this.marks)throw new RangeError(s+" can not be both a node and a mark");let i=this.nodes[s],o=i.spec.content||"",a=i.spec.marks;if(i.contentMatch=n[o]||(n[o]=fr.parse(o,this.nodes)),i.inlineContent=i.contentMatch.inlineContent,i.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!i.isInline||!i.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=i}i.markSet=a=="_"?null:a?Fl(this,a.split(" ")):a==""||!i.inlineContent?[]:null}for(let s in this.marks){let i=this.marks[s],o=i.spec.excludes;i.excluded=o==null?[i]:o==""?[]:Fl(this,o.split(" "))}this.nodeFromJSON=s=>Ze.fromJSON(this,s),this.markFromJSON=s=>V.fromJSON(this,s),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,n,s){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof Ul){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,n,s)}text(e,t){let n=this.nodes.text;return new Os(n,n.defaultAttrs,e,V.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Fl(r,e){let t=[];for(let n=0;n<e.length;n++){let s=e[n],i=r.marks[s],o=i;if(i)t.push(i);else for(let a in r.marks){let l=r.marks[a];(s=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(s)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[n]+"'")}return t}function ny(r){return r.tag!=null}function sy(r){return r.style!=null}class Lt{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let n=this.matchedStyles=[];t.forEach(s=>{if(ny(s))this.tags.push(s);else if(sy(s)){let i=/[^=]*/.exec(s.style)[0];n.indexOf(i)<0&&n.push(i),this.styles.push(s)}}),this.normalizeLists=!this.tags.some(s=>{if(!/^(ul|ol)\b/.test(s.tag)||!s.node)return!1;let i=e.nodes[s.node];return i.contentMatch.matchType(i)})}parse(e,t={}){let n=new Vl(this,t,!1);return n.addAll(e,V.none,t.from,t.to),n.finish()}parseSlice(e,t={}){let n=new Vl(this,t,!0);return n.addAll(e,V.none,t.from,t.to),C.maxOpen(n.finish())}matchTag(e,t,n){for(let s=n?this.tags.indexOf(n)+1:0;s<this.tags.length;s++){let i=this.tags[s];if(ay(e,i.tag)&&(i.namespace===void 0||e.namespaceURI==i.namespace)&&(!i.context||t.matchesContext(i.context))){if(i.getAttrs){let o=i.getAttrs(e);if(o===!1)continue;i.attrs=o||void 0}return i}}}matchStyle(e,t,n,s){for(let i=s?this.styles.indexOf(s)+1:0;i<this.styles.length;i++){let o=this.styles[i],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!n.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function n(s){let i=s.priority==null?50:s.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<i)break}t.splice(o,0,s)}for(let s in e.marks){let i=e.marks[s].spec.parseDOM;i&&i.forEach(o=>{n(o=ql(o)),o.mark||o.ignore||o.clearMark||(o.mark=s)})}for(let s in e.nodes){let i=e.nodes[s].spec.parseDOM;i&&i.forEach(o=>{n(o=ql(o)),o.node||o.ignore||o.mark||(o.node=s)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new Lt(e,Lt.schemaRules(e)))}}const Qu={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},iy={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Xu={ol:!0,ul:!0},In=1,Fo=2,fn=4;function Hl(r,e,t){return e!=null?(e?In:0)|(e==="full"?Fo:0):r&&r.whitespace=="pre"?In|Fo:t&~fn}class rs{constructor(e,t,n,s,i,o){this.type=e,this.attrs=t,this.marks=n,this.solid=s,this.options=o,this.content=[],this.activeMarks=V.none,this.match=i||(o&fn?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(k.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let n=this.type.contentMatch,s;return(s=n.findWrapping(e.type))?(this.match=n,s):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&In)){let n=this.content[this.content.length-1],s;if(n&&n.isText&&(s=/[ \t\r\n\u000c]+$/.exec(n.text))){let i=n;n.text.length==s[0].length?this.content.pop():this.content[this.content.length-1]=i.withText(i.text.slice(0,i.text.length-s[0].length))}}let t=k.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(k.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!Qu.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class Vl{constructor(e,t,n){this.parser=e,this.options=t,this.isOpen=n,this.open=0,this.localPreserveWS=!1;let s=t.topNode,i,o=Hl(null,t.preserveWhitespace,0)|(n?fn:0);s?i=new rs(s.type,s.attrs,V.none,!0,t.topMatch||s.type.contentMatch,o):n?i=new rs(null,null,V.none,!0,null,o):i=new rs(e.schema.topNodeType,null,V.none,!0,null,o),this.nodes=[i],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e,t){e.nodeType==3?this.addTextNode(e,t):e.nodeType==1&&this.addElement(e,t)}addTextNode(e,t){let n=e.nodeValue,s=this.top,i=s.options&Fo?"full":this.localPreserveWS||(s.options&In)>0,{schema:o}=this.parser;if(i==="full"||s.inlineContext(e)||/[^ \t\r\n\u000c]/.test(n)){if(i)if(i==="full")n=n.replace(/\r\n?/g,`
`);else if(o.linebreakReplacement&&/[\r\n]/.test(n)&&this.top.findWrapping(o.linebreakReplacement.create())){let a=n.split(/\r?\n|\r/);for(let l=0;l<a.length;l++)l&&this.insertNode(o.linebreakReplacement.create(),t,!0),a[l]&&this.insertNode(o.text(a[l]),t,!/\S/.test(a[l]));n=""}else n=n.replace(/\r?\n|\r/g," ");else if(n=n.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(n)&&this.open==this.nodes.length-1){let a=s.content[s.content.length-1],l=e.previousSibling;(!a||l&&l.nodeName=="BR"||a.isText&&/[ \t\r\n\u000c]$/.test(a.text))&&(n=n.slice(1))}n&&this.insertNode(o.text(n),t,!/\S/.test(n)),this.findInText(e)}else this.findInside(e)}addElement(e,t,n){let s=this.localPreserveWS,i=this.top;(e.tagName=="PRE"||/pre/.test(e.style&&e.style.whiteSpace))&&(this.localPreserveWS=!0);let o=e.nodeName.toLowerCase(),a;Xu.hasOwnProperty(o)&&this.parser.normalizeLists&&oy(e);let l=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(a=this.parser.matchTag(e,this,n));e:if(l?l.ignore:iy.hasOwnProperty(o))this.findInside(e),this.ignoreFallback(e,t);else if(!l||l.skip||l.closeParent){l&&l.closeParent?this.open=Math.max(0,this.open-1):l&&l.skip.nodeType&&(e=l.skip);let c,u=this.needsBlock;if(Qu.hasOwnProperty(o))i.content.length&&i.content[0].isInline&&this.open&&(this.open--,i=this.top),c=!0,i.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e,t);break e}let d=l&&l.skip?t:this.readStyles(e,t);d&&this.addAll(e,d),c&&this.sync(i),this.needsBlock=u}else{let c=this.readStyles(e,t);c&&this.addElementByRule(e,l,c,l.consuming===!1?a:void 0)}this.localPreserveWS=s}leafFallback(e,t){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`),t)}ignoreFallback(e,t){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"),t,!0)}readStyles(e,t){let n=e.style;if(n&&n.length)for(let s=0;s<this.parser.matchedStyles.length;s++){let i=this.parser.matchedStyles[s],o=n.getPropertyValue(i);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(i,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?t=t.filter(c=>!l.clearMark(c)):t=t.concat(this.parser.schema.marks[l.mark].create(l.attrs)),l.consuming===!1)a=l;else break}}return t}addElementByRule(e,t,n,s){let i,o;if(t.node)if(o=this.parser.schema.nodes[t.node],o.isLeaf)this.insertNode(o.create(t.attrs),n,e.nodeName=="BR")||this.leafFallback(e,n);else{let l=this.enter(o,t.attrs||null,n,t.preserveWhitespace);l&&(i=!0,n=l)}else{let l=this.parser.schema.marks[t.mark];n=n.concat(l.create(t.attrs))}let a=this.top;if(o&&o.isLeaf)this.findInside(e);else if(s)this.addElement(e,n,s);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l,n,!1));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l,n),this.findAround(e,l,!1)}i&&this.sync(a)&&this.open--}addAll(e,t,n,s){let i=n||0;for(let o=n?e.childNodes[n]:e.firstChild,a=s==null?null:e.childNodes[s];o!=a;o=o.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(o,t);this.findAtPoint(e,i)}findPlace(e,t,n){let s,i;for(let o=this.open,a=0;o>=0;o--){let l=this.nodes[o],c=l.findWrapping(e);if(c&&(!s||s.length>c.length+a)&&(s=c,i=l,!c.length))break;if(l.solid){if(n)break;a+=2}}if(!s)return null;this.sync(i);for(let o=0;o<s.length;o++)t=this.enterInner(s[o],null,t,!1);return t}insertNode(e,t,n){if(e.isInline&&this.needsBlock&&!this.top.type){let i=this.textblockFromContext();i&&(t=this.enterInner(i,null,t))}let s=this.findPlace(e,t,n);if(s){this.closeExtra();let i=this.top;i.match&&(i.match=i.match.matchType(e.type));let o=V.none;for(let a of s.concat(e.marks))(i.type?i.type.allowsMarkType(a.type):Wl(a.type,e.type))&&(o=a.addToSet(o));return i.content.push(e.mark(o)),!0}return!1}enter(e,t,n,s){let i=this.findPlace(e.create(t),n,!1);return i&&(i=this.enterInner(e,t,n,!0,s)),i}enterInner(e,t,n,s=!1,i){this.closeExtra();let o=this.top;o.match=o.match&&o.match.matchType(e);let a=Hl(e,i,o.options);o.options&fn&&o.content.length==0&&(a|=fn);let l=V.none;return n=n.filter(c=>(o.type?o.type.allowsMarkType(c.type):Wl(c.type,e))?(l=c.addToSet(l),!1):!0),this.nodes.push(new rs(e,t,l,s,null,a)),this.open++,n}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(!!(this.isOpen||this.options.topOpen))}sync(e){for(let t=this.open;t>=0;t--){if(this.nodes[t]==e)return this.open=t,!0;this.localPreserveWS&&(this.nodes[t].options|=In)}return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let n=this.nodes[t].content;for(let s=n.length-1;s>=0;s--)e+=n[s].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let n=0;n<this.find.length;n++)this.find[n].node==e&&this.find[n].offset==t&&(this.find[n].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,n){if(e!=t&&this.find)for(let s=0;s<this.find.length;s++)this.find[s].pos==null&&e.nodeType==1&&e.contains(this.find[s].node)&&t.compareDocumentPosition(this.find[s].node)&(n?2:4)&&(this.find[s].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),n=this.options.context,s=!this.isOpen&&(!n||n.parent.type==this.nodes[0].type),i=-(n?n.depth+1:0)+(s?0:1),o=(a,l)=>{for(;a>=0;a--){let c=t[a];if(c==""){if(a==t.length-1||a==0)continue;for(;l>=i;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&s?this.nodes[l].type:n&&l>=i?n.node(l-i).type:null;if(!u||u.name!=c&&!u.isInGroup(c))return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let n=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(n&&n.isTextblock&&n.defaultAttrs)return n}for(let t in this.parser.schema.nodes){let n=this.parser.schema.nodes[t];if(n.isTextblock&&n.defaultAttrs)return n}}}function oy(r){for(let e=r.firstChild,t=null;e;e=e.nextSibling){let n=e.nodeType==1?e.nodeName.toLowerCase():null;n&&Xu.hasOwnProperty(n)&&t?(t.appendChild(e),e=t):n=="li"?t=e:n&&(t=null)}}function ay(r,e){return(r.matches||r.msMatchesSelector||r.webkitMatchesSelector||r.mozMatchesSelector).call(r,e)}function ql(r){let e={};for(let t in r)e[t]=r[t];return e}function Wl(r,e){let t=e.schema.nodes;for(let n in t){let s=t[n];if(!s.allowsMarkType(r))continue;let i=[],o=a=>{i.push(a);for(let l=0;l<a.edgeCount;l++){let{type:c,next:u}=a.edge(l);if(c==e||i.indexOf(u)<0&&o(u))return!0}};if(o(s.contentMatch))return!0}}class vr{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},n){n||(n=Gi(t).createDocumentFragment());let s=n,i=[];return e.forEach(o=>{if(i.length||o.marks.length){let a=0,l=0;for(;a<i.length&&l<o.marks.length;){let c=o.marks[l];if(!this.marks[c.type.name]){l++;continue}if(!c.eq(i[a][0])||c.type.spec.spanning===!1)break;a++,l++}for(;a<i.length;)s=i.pop()[1];for(;l<o.marks.length;){let c=o.marks[l++],u=this.serializeMark(c,o.isInline,t);u&&(i.push([c,s]),s.appendChild(u.dom),s=u.contentDOM||u.dom)}}s.appendChild(this.serializeNodeInner(o,t))}),n}serializeNodeInner(e,t){let{dom:n,contentDOM:s}=ms(Gi(t),this.nodes[e.type.name](e),null,e.attrs);if(s){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,s)}return n}serializeNode(e,t={}){let n=this.serializeNodeInner(e,t);for(let s=e.marks.length-1;s>=0;s--){let i=this.serializeMark(e.marks[s],e.isInline,t);i&&((i.contentDOM||i.dom).appendChild(n),n=i.dom)}return n}serializeMark(e,t,n={}){let s=this.marks[e.type.name];return s&&ms(Gi(n),s(e,t),null,e.attrs)}static renderSpec(e,t,n=null,s){return ms(e,t,n,s)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new vr(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=Kl(e.nodes);return t.text||(t.text=n=>n.text),t}static marksFromSchema(e){return Kl(e.marks)}}function Kl(r){let e={};for(let t in r){let n=r[t].spec.toDOM;n&&(e[t]=n)}return e}function Gi(r){return r.document||window.document}const Jl=new WeakMap;function ly(r){let e=Jl.get(r);return e===void 0&&Jl.set(r,e=cy(r)),e}function cy(r){let e=null;function t(n){if(n&&typeof n=="object")if(Array.isArray(n))if(typeof n[0]=="string")e||(e=[]),e.push(n);else for(let s=0;s<n.length;s++)t(n[s]);else for(let s in n)t(n[s])}return t(r),e}function ms(r,e,t,n){if(typeof e=="string")return{dom:r.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let s=e[0],i;if(typeof s!="string")throw new RangeError("Invalid array passed to renderSpec");if(n&&(i=ly(n))&&i.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=s.indexOf(" ");o>0&&(t=s.slice(0,o),s=s.slice(o+1));let a,l=t?r.createElementNS(t,s):r.createElement(s),c=e[1],u=1;if(c&&typeof c=="object"&&c.nodeType==null&&!Array.isArray(c)){u=2;for(let d in c)if(c[d]!=null){let h=d.indexOf(" ");h>0?l.setAttributeNS(d.slice(0,h),d.slice(h+1),c[d]):d=="style"&&l.style?l.style.cssText=c[d]:l.setAttribute(d,c[d])}}for(let d=u;d<e.length;d++){let h=e[d];if(h===0){if(d<e.length-1||d>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:f,contentDOM:p}=ms(r,h,t,n);if(l.appendChild(f),p){if(a)throw new RangeError("Multiple content holes");a=p}}}return{dom:l,contentDOM:a}}const Zu=65535,ed=Math.pow(2,16);function uy(r,e){return r+e*ed}function Gl(r){return r&Zu}function dy(r){return(r-(r&Zu))/ed}const td=1,rd=2,gs=4,nd=8;class Ho{constructor(e,t,n){this.pos=e,this.delInfo=t,this.recover=n}get deleted(){return(this.delInfo&nd)>0}get deletedBefore(){return(this.delInfo&(td|gs))>0}get deletedAfter(){return(this.delInfo&(rd|gs))>0}get deletedAcross(){return(this.delInfo&gs)>0}}class $e{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&$e.empty)return $e.empty}recover(e){let t=0,n=Gl(e);if(!this.inverted)for(let s=0;s<n;s++)t+=this.ranges[s*3+2]-this.ranges[s*3+1];return this.ranges[n*3]+t+dy(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,n){let s=0,i=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let c=this.ranges[a+i],u=this.ranges[a+o],d=l+c;if(e<=d){let h=c?e==l?-1:e==d?1:t:t,f=l+s+(h<0?0:u);if(n)return f;let p=e==(t<0?l:d)?null:uy(a/3,e-l),m=e==l?rd:e==d?td:gs;return(t<0?e!=l:e!=d)&&(m|=nd),new Ho(f,m,p)}s+=u-c}return n?e+s:new Ho(e+s,0,null)}touches(e,t){let n=0,s=Gl(t),i=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?n:0);if(l>e)break;let c=this.ranges[a+i],u=l+c;if(e<=u&&a==s*3)return!0;n+=this.ranges[a+o]-c}return!1}forEach(e){let t=this.inverted?2:1,n=this.inverted?1:2;for(let s=0,i=0;s<this.ranges.length;s+=3){let o=this.ranges[s],a=o-(this.inverted?i:0),l=o+(this.inverted?0:i),c=this.ranges[s+t],u=this.ranges[s+n];e(a,a+c,l,l+u),i+=u-c}}invert(){return new $e(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?$e.empty:new $e(e<0?[0,-e,0]:[0,0,e])}}$e.empty=new $e([]);class Rn{constructor(e,t,n=0,s=e?e.length:0){this.mirror=t,this.from=n,this.to=s,this._maps=e||[],this.ownData=!(e||t)}get maps(){return this._maps}slice(e=0,t=this.maps.length){return new Rn(this._maps,this.mirror,e,t)}appendMap(e,t){this.ownData||(this._maps=this._maps.slice(),this.mirror=this.mirror&&this.mirror.slice(),this.ownData=!0),this.to=this._maps.push(e),t!=null&&this.setMirror(this._maps.length-1,t)}appendMapping(e){for(let t=0,n=this._maps.length;t<e._maps.length;t++){let s=e.getMirror(t);this.appendMap(e._maps[t],s!=null&&s<t?n+s:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,n=this._maps.length+e._maps.length;t>=0;t--){let s=e.getMirror(t);this.appendMap(e._maps[t].invert(),s!=null&&s>t?n-s-1:void 0)}}invert(){let e=new Rn;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let n=this.from;n<this.to;n++)e=this._maps[n].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,n){let s=0;for(let i=this.from;i<this.to;i++){let o=this._maps[i],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(i);if(l!=null&&l>i&&l<this.to){i=l,e=this._maps[l].recover(a.recover);continue}}s|=a.delInfo,e=a.pos}return n?e:new Ho(e,s,null)}}const Yi=Object.create(null);class Te{getMap(){return $e.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let n=Yi[t.stepType];if(!n)throw new RangeError(`No step type ${t.stepType} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in Yi)throw new RangeError("Duplicate use of step JSON ID "+e);return Yi[e]=t,t.prototype.jsonID=e,t}}class ie{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new ie(e,null)}static fail(e){return new ie(null,e)}static fromReplace(e,t,n,s){try{return ie.ok(e.replace(t,n,s))}catch(i){if(i instanceof Es)return ie.fail(i.message);throw i}}}function _a(r,e,t){let n=[];for(let s=0;s<r.childCount;s++){let i=r.child(s);i.content.size&&(i=i.copy(_a(i.content,e,i))),i.isInline&&(i=e(i,t,s)),n.push(i)}return k.fromArray(n)}class Rt extends Te{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=e.resolve(this.from),s=n.node(n.sharedDepth(this.to)),i=new C(_a(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),s),t.openStart,t.openEnd);return ie.fromReplace(e,this.from,this.to,i)}invert(){return new Xe(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new Rt(t.pos,n.pos,this.mark)}merge(e){return e instanceof Rt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new Rt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new Rt(t.from,t.to,e.markFromJSON(t.mark))}}Te.jsonID("addMark",Rt);class Xe extends Te{constructor(e,t,n){super(),this.from=e,this.to=t,this.mark=n}apply(e){let t=e.slice(this.from,this.to),n=new C(_a(t.content,s=>s.mark(this.mark.removeFromSet(s.marks)),e),t.openStart,t.openEnd);return ie.fromReplace(e,this.from,this.to,n)}invert(){return new Rt(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deleted&&n.deleted||t.pos>=n.pos?null:new Xe(t.pos,n.pos,this.mark)}merge(e){return e instanceof Xe&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new Xe(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new Xe(t.from,t.to,e.markFromJSON(t.mark))}}Te.jsonID("removeMark",Xe);class Nt extends Te{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return ie.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return ie.fromReplace(e,this.pos,this.pos+1,new C(k.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let n=this.mark.addToSet(t.marks);if(n.length==t.marks.length){for(let s=0;s<t.marks.length;s++)if(!t.marks[s].isInSet(n))return new Nt(this.pos,t.marks[s]);return new Nt(this.pos,this.mark)}}return new pr(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Nt(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new Nt(t.pos,e.markFromJSON(t.mark))}}Te.jsonID("addNodeMark",Nt);class pr extends Te{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return ie.fail("No node at mark step's position");let n=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return ie.fromReplace(e,this.pos,this.pos+1,new C(k.from(n),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new Nt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new pr(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new pr(t.pos,e.markFromJSON(t.mark))}}Te.jsonID("removeNodeMark",pr);class ce extends Te{constructor(e,t,n,s=!1){super(),this.from=e,this.to=t,this.slice=n,this.structure=s}apply(e){return this.structure&&Vo(e,this.from,this.to)?ie.fail("Structure replace would overwrite content"):ie.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new $e([this.from,this.to-this.from,this.slice.size])}invert(e){return new ce(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1);return t.deletedAcross&&n.deletedAcross?null:new ce(t.pos,Math.max(t.pos,n.pos),this.slice,this.structure)}merge(e){if(!(e instanceof ce)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?C.empty:new C(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new ce(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?C.empty:new C(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new ce(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new ce(t.from,t.to,C.fromJSON(e,t.slice),!!t.structure)}}Te.jsonID("replace",ce);class de extends Te{constructor(e,t,n,s,i,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=n,this.gapTo=s,this.slice=i,this.insert=o,this.structure=a}apply(e){if(this.structure&&(Vo(e,this.from,this.gapFrom)||Vo(e,this.gapTo,this.to)))return ie.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return ie.fail("Gap is not a flat range");let n=this.slice.insertAt(this.insert,t.content);return n?ie.fromReplace(e,this.from,this.to,n):ie.fail("Content does not fit in gap")}getMap(){return new $e([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new de(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),n=e.mapResult(this.to,-1),s=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),i=this.to==this.gapTo?n.pos:e.map(this.gapTo,1);return t.deletedAcross&&n.deletedAcross||s<t.pos||i>n.pos?null:new de(t.pos,n.pos,s,i,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new de(t.from,t.to,t.gapFrom,t.gapTo,C.fromJSON(e,t.slice),t.insert,!!t.structure)}}Te.jsonID("replaceAround",de);function Vo(r,e,t){let n=r.resolve(e),s=t-e,i=n.depth;for(;s>0&&i>0&&n.indexAfter(i)==n.node(i).childCount;)i--,s--;if(s>0){let o=n.node(i).maybeChild(n.indexAfter(i));for(;s>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,s--}}return!1}function hy(r,e,t,n){let s=[],i=[],o,a;r.doc.nodesBetween(e,t,(l,c,u)=>{if(!l.isInline)return;let d=l.marks;if(!n.isInSet(d)&&u.type.allowsMarkType(n.type)){let h=Math.max(c,e),f=Math.min(c+l.nodeSize,t),p=n.addToSet(d);for(let m=0;m<d.length;m++)d[m].isInSet(p)||(o&&o.to==h&&o.mark.eq(d[m])?o.to=f:s.push(o=new Xe(h,f,d[m])));a&&a.to==h?a.to=f:i.push(a=new Rt(h,f,n))}}),s.forEach(l=>r.step(l)),i.forEach(l=>r.step(l))}function fy(r,e,t,n){let s=[],i=0;r.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;i++;let l=null;if(n instanceof Si){let c=o.marks,u;for(;u=n.isInSet(c);)(l||(l=[])).push(u),c=u.removeFromSet(c)}else n?n.isInSet(o.marks)&&(l=[n]):l=o.marks;if(l&&l.length){let c=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let d=l[u],h;for(let f=0;f<s.length;f++){let p=s[f];p.step==i-1&&d.eq(s[f].style)&&(h=p)}h?(h.to=c,h.step=i):s.push({style:d,from:Math.max(a,e),to:c,step:i})}}}),s.forEach(o=>r.step(new Xe(o.from,o.to,o.style)))}function Ea(r,e,t,n=t.contentMatch,s=!0){let i=r.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<i.childCount;l++){let c=i.child(l),u=a+c.nodeSize,d=n.matchType(c.type);if(!d)o.push(new ce(a,u,C.empty));else{n=d;for(let h=0;h<c.marks.length;h++)t.allowsMarkType(c.marks[h].type)||r.step(new Xe(a,u,c.marks[h]));if(s&&c.isText&&t.whitespace!="pre"){let h,f=/\r?\n|\r/g,p;for(;h=f.exec(c.text);)p||(p=new C(k.from(t.schema.text(" ",t.allowedMarks(c.marks))),0,0)),o.push(new ce(a+h.index,a+h.index+h[0].length,p))}}a=u}if(!n.validEnd){let l=n.fillBefore(k.empty,!0);r.replace(a,a,new C(l,0,0))}for(let l=o.length-1;l>=0;l--)r.step(o[l])}function py(r,e,t){return(e==0||r.canReplace(e,r.childCount))&&(t==r.childCount||r.canReplace(0,t))}function Zr(r){let t=r.parent.content.cutByIndex(r.startIndex,r.endIndex);for(let n=r.depth,s=0,i=0;;--n){let o=r.$from.node(n),a=r.$from.index(n)+s,l=r.$to.indexAfter(n)-i;if(n<r.depth&&o.canReplace(a,l,t))return n;if(n==0||o.type.spec.isolating||!py(o,a,l))break;a&&(s=1),l<o.childCount&&(i=1)}return null}function my(r,e,t){let{$from:n,$to:s,depth:i}=e,o=n.before(i+1),a=s.after(i+1),l=o,c=a,u=k.empty,d=0;for(let p=i,m=!1;p>t;p--)m||n.index(p)>0?(m=!0,u=k.from(n.node(p).copy(u)),d++):l--;let h=k.empty,f=0;for(let p=i,m=!1;p>t;p--)m||s.after(p+1)<s.end(p)?(m=!0,h=k.from(s.node(p).copy(h)),f++):c++;r.step(new de(l,c,o,a,new C(u.append(h),d,f),u.size-d,!0))}function Ca(r,e,t=null,n=r){let s=gy(r,e),i=s&&yy(n,e);return i?s.map(Yl).concat({type:e,attrs:t}).concat(i.map(Yl)):null}function Yl(r){return{type:r,attrs:null}}function gy(r,e){let{parent:t,startIndex:n,endIndex:s}=r,i=t.contentMatchAt(n).findWrapping(e);if(!i)return null;let o=i.length?i[0]:e;return t.canReplaceWith(n,s,o)?i:null}function yy(r,e){let{parent:t,startIndex:n,endIndex:s}=r,i=t.child(n),o=e.contentMatch.findWrapping(i.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let c=n;l&&c<s;c++)l=l.matchType(t.child(c).type);return!l||!l.validEnd?null:o}function by(r,e,t){let n=k.empty;for(let o=t.length-1;o>=0;o--){if(n.size){let a=t[o].type.contentMatch.matchFragment(n);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}n=k.from(t[o].type.create(t[o].attrs,n))}let s=e.start,i=e.end;r.step(new de(s,i,s,i,new C(n,0,0),t.length,!0))}function wy(r,e,t,n,s){if(!n.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let i=r.steps.length;r.doc.nodesBetween(e,t,(o,a)=>{let l=typeof s=="function"?s(o):s;if(o.isTextblock&&!o.hasMarkup(n,l)&&vy(r.doc,r.mapping.slice(i).map(a),n)){let c=null;if(n.schema.linebreakReplacement){let f=n.whitespace=="pre",p=!!n.contentMatch.matchType(n.schema.linebreakReplacement);f&&!p?c=!1:!f&&p&&(c=!0)}c===!1&&id(r,o,a,i),Ea(r,r.mapping.slice(i).map(a,1),n,void 0,c===null);let u=r.mapping.slice(i),d=u.map(a,1),h=u.map(a+o.nodeSize,1);return r.step(new de(d,h,d+1,h-1,new C(k.from(n.create(l,null,o.marks)),0,0),1,!0)),c===!0&&sd(r,o,a,i),!1}})}function sd(r,e,t,n){e.forEach((s,i)=>{if(s.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(s.text);){let l=r.mapping.slice(n).map(t+1+i+o.index);r.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function id(r,e,t,n){e.forEach((s,i)=>{if(s.type==s.type.schema.linebreakReplacement){let o=r.mapping.slice(n).map(t+1+i);r.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function vy(r,e,t){let n=r.resolve(e),s=n.index();return n.parent.canReplaceWith(s,s+1,t)}function ky(r,e,t,n,s){let i=r.doc.nodeAt(e);if(!i)throw new RangeError("No node at given position");t||(t=i.type);let o=t.create(n,null,s||i.marks);if(i.isLeaf)return r.replaceWith(e,e+i.nodeSize,o);if(!t.validContent(i.content))throw new RangeError("Invalid content for node type "+t.name);r.step(new de(e,e+i.nodeSize,e+1,e+i.nodeSize-1,new C(k.from(o),0,0),1,!0))}function gt(r,e,t=1,n){let s=r.resolve(e),i=s.depth-t,o=n&&n[n.length-1]||s.parent;if(i<0||s.parent.type.spec.isolating||!s.parent.canReplace(s.index(),s.parent.childCount)||!o.type.validContent(s.parent.content.cutByIndex(s.index(),s.parent.childCount)))return!1;for(let c=s.depth-1,u=t-2;c>i;c--,u--){let d=s.node(c),h=s.index(c);if(d.type.spec.isolating)return!1;let f=d.content.cutByIndex(h,d.childCount),p=n&&n[u+1];p&&(f=f.replaceChild(0,p.type.create(p.attrs)));let m=n&&n[u]||d;if(!d.canReplace(h+1,d.childCount)||!m.type.validContent(f))return!1}let a=s.indexAfter(i),l=n&&n[0];return s.node(i).canReplaceWith(a,a,l?l.type:s.node(i+1).type)}function Sy(r,e,t=1,n){let s=r.doc.resolve(e),i=k.empty,o=k.empty;for(let a=s.depth,l=s.depth-t,c=t-1;a>l;a--,c--){i=k.from(s.node(a).copy(i));let u=n&&n[c];o=k.from(u?u.type.create(u.attrs,o):s.node(a).copy(o))}r.step(new ce(e,e,new C(i.append(o),t,t),!0))}function qt(r,e){let t=r.resolve(e),n=t.index();return od(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(n,n+1)}function xy(r,e){e.content.size||r.type.compatibleContent(e.type);let t=r.contentMatchAt(r.childCount),{linebreakReplacement:n}=r.type.schema;for(let s=0;s<e.childCount;s++){let i=e.child(s),o=i.type==n?r.type.schema.nodes.text:i.type;if(t=t.matchType(o),!t||!r.type.allowsMarks(i.marks))return!1}return t.validEnd}function od(r,e){return!!(r&&e&&!r.isLeaf&&xy(r,e))}function xi(r,e,t=-1){let n=r.resolve(e);for(let s=n.depth;;s--){let i,o,a=n.index(s);if(s==n.depth?(i=n.nodeBefore,o=n.nodeAfter):t>0?(i=n.node(s+1),a++,o=n.node(s).maybeChild(a)):(i=n.node(s).maybeChild(a-1),o=n.node(s+1)),i&&!i.isTextblock&&od(i,o)&&n.node(s).canReplace(a,a+1))return e;if(s==0)break;e=t<0?n.before(s):n.after(s)}}function Ty(r,e,t){let n=null,{linebreakReplacement:s}=r.doc.type.schema,i=r.doc.resolve(e-t),o=i.node().type;if(s&&o.inlineContent){let u=o.whitespace=="pre",d=!!o.contentMatch.matchType(s);u&&!d?n=!1:!u&&d&&(n=!0)}let a=r.steps.length;if(n===!1){let u=r.doc.resolve(e+t);id(r,u.node(),u.before(),a)}o.inlineContent&&Ea(r,e+t-1,o,i.node().contentMatchAt(i.index()),n==null);let l=r.mapping.slice(a),c=l.map(e-t);if(r.step(new ce(c,l.map(e+t,-1),C.empty,!0)),n===!0){let u=r.doc.resolve(c);sd(r,u.node(),u.before(),r.steps.length)}return r}function _y(r,e,t){let n=r.resolve(e);if(n.parent.canReplaceWith(n.index(),n.index(),t))return e;if(n.parentOffset==0)for(let s=n.depth-1;s>=0;s--){let i=n.index(s);if(n.node(s).canReplaceWith(i,i,t))return n.before(s+1);if(i>0)return null}if(n.parentOffset==n.parent.content.size)for(let s=n.depth-1;s>=0;s--){let i=n.indexAfter(s);if(n.node(s).canReplaceWith(i,i,t))return n.after(s+1);if(i<n.node(s).childCount)return null}return null}function ad(r,e,t){let n=r.resolve(e);if(!t.content.size)return e;let s=t.content;for(let i=0;i<t.openStart;i++)s=s.firstChild.content;for(let i=1;i<=(t.openStart==0&&t.size?2:1);i++)for(let o=n.depth;o>=0;o--){let a=o==n.depth?0:n.pos<=(n.start(o+1)+n.end(o+1))/2?-1:1,l=n.index(o)+(a>0?1:0),c=n.node(o),u=!1;if(i==1)u=c.canReplace(l,l,s);else{let d=c.contentMatchAt(l).findWrapping(s.firstChild.type);u=d&&c.canReplaceWith(l,l,d[0])}if(u)return a==0?n.pos:a<0?n.before(o+1):n.after(o+1)}return null}function Ti(r,e,t=e,n=C.empty){if(e==t&&!n.size)return null;let s=r.resolve(e),i=r.resolve(t);return ld(s,i,n)?new ce(e,t,n):new Ey(s,i,n).fit()}function ld(r,e,t){return!t.openStart&&!t.openEnd&&r.start()==e.start()&&r.parent.canReplace(r.index(),e.index(),t.content)}class Ey{constructor(e,t,n){this.$from=e,this.$to=t,this.unplaced=n,this.frontier=[],this.placed=k.empty;for(let s=0;s<=e.depth;s++){let i=e.node(s);this.frontier.push({type:i.type,match:i.contentMatchAt(e.indexAfter(s))})}for(let s=e.depth;s>0;s--)this.placed=k.from(e.node(s).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let c=this.findFittable();c?this.placeNodes(c):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,n=this.$from,s=this.close(e<0?this.$to:n.doc.resolve(e));if(!s)return null;let i=this.placed,o=n.depth,a=s.depth;for(;o&&a&&i.childCount==1;)i=i.firstChild.content,o--,a--;let l=new C(i,o,a);return e>-1?new de(n.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||n.pos!=this.$to.pos?new ce(n.pos,s.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,n=0,s=this.unplaced.openEnd;n<e;n++){let i=t.firstChild;if(t.childCount>1&&(s=0),i.type.spec.isolating&&s<=n){e=n;break}t=i.content}for(let t=1;t<=2;t++)for(let n=t==1?e:this.unplaced.openStart;n>=0;n--){let s,i=null;n?(i=Qi(this.unplaced.content,n-1).firstChild,s=i.content):s=this.unplaced.content;let o=s.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:c}=this.frontier[a],u,d=null;if(t==1&&(o?c.matchType(o.type)||(d=c.fillBefore(k.from(o),!1)):i&&l.compatibleContent(i.type)))return{sliceDepth:n,frontierDepth:a,parent:i,inject:d};if(t==2&&o&&(u=c.findWrapping(o.type)))return{sliceDepth:n,frontierDepth:a,parent:i,wrap:u};if(i&&c.matchType(i.type))break}}}openMore(){let{content:e,openStart:t,openEnd:n}=this.unplaced,s=Qi(e,t);return!s.childCount||s.firstChild.isLeaf?!1:(this.unplaced=new C(e,t+1,Math.max(n,s.size+t>=e.size-n?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:n}=this.unplaced,s=Qi(e,t);if(s.childCount<=1&&t>0){let i=e.size-t<=t+s.size;this.unplaced=new C(on(e,t-1,1),t-1,i?t-1:n)}else this.unplaced=new C(on(e,t,1),t,n)}placeNodes({sliceDepth:e,frontierDepth:t,parent:n,inject:s,wrap:i}){for(;this.depth>t;)this.closeFrontierNode();if(i)for(let m=0;m<i.length;m++)this.openFrontierNode(i[m]);let o=this.unplaced,a=n?n.content:o.content,l=o.openStart-e,c=0,u=[],{match:d,type:h}=this.frontier[t];if(s){for(let m=0;m<s.childCount;m++)u.push(s.child(m));d=d.matchFragment(s)}let f=a.size+e-(o.content.size-o.openEnd);for(;c<a.childCount;){let m=a.child(c),g=d.matchType(m.type);if(!g)break;c++,(c>1||l==0||m.content.size)&&(d=g,u.push(cd(m.mark(h.allowedMarks(m.marks)),c==1?l:0,c==a.childCount?f:-1)))}let p=c==a.childCount;p||(f=-1),this.placed=an(this.placed,t,k.from(u)),this.frontier[t].match=d,p&&f<0&&n&&n.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let m=0,g=a;m<f;m++){let y=g.lastChild;this.frontier.push({type:y.type,match:y.contentMatchAt(y.childCount)}),g=y.content}this.unplaced=p?e==0?C.empty:new C(on(o.content,e-1,1),e-1,f<0?o.openEnd:e-1):new C(on(o.content,e,c),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!Xi(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:n}=this.$to,s=this.$to.after(n);for(;n>1&&s==this.$to.end(--n);)++s;return s}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:n,type:s}=this.frontier[t],i=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=Xi(e,t,s,n,i);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:c}=this.frontier[a],u=Xi(e,a,c,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:i?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=an(this.placed,t.depth,t.fit)),e=t.move;for(let n=t.depth+1;n<=e.depth;n++){let s=e.node(n),i=s.type.contentMatch.fillBefore(s.content,!0,e.index(n));this.openFrontierNode(s.type,s.attrs,i)}return e}openFrontierNode(e,t=null,n){let s=this.frontier[this.depth];s.match=s.match.matchType(e),this.placed=an(this.placed,this.depth,k.from(e.create(t,n))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(k.empty,!0);t.childCount&&(this.placed=an(this.placed,this.frontier.length,t))}}function on(r,e,t){return e==0?r.cutByIndex(t,r.childCount):r.replaceChild(0,r.firstChild.copy(on(r.firstChild.content,e-1,t)))}function an(r,e,t){return e==0?r.append(t):r.replaceChild(r.childCount-1,r.lastChild.copy(an(r.lastChild.content,e-1,t)))}function Qi(r,e){for(let t=0;t<e;t++)r=r.firstChild.content;return r}function cd(r,e,t){if(e<=0)return r;let n=r.content;return e>1&&(n=n.replaceChild(0,cd(n.firstChild,e-1,n.childCount==1?t-1:0))),e>0&&(n=r.type.contentMatch.fillBefore(n).append(n),t<=0&&(n=n.append(r.type.contentMatch.matchFragment(n).fillBefore(k.empty,!0)))),r.copy(n)}function Xi(r,e,t,n,s){let i=r.node(e),o=s?r.indexAfter(e):r.index(e);if(o==i.childCount&&!t.compatibleContent(i.type))return null;let a=n.fillBefore(i.content,!0,o);return a&&!Cy(t,i.content,o)?a:null}function Cy(r,e,t){for(let n=t;n<e.childCount;n++)if(!r.allowsMarks(e.child(n).marks))return!0;return!1}function Ay(r){return r.spec.defining||r.spec.definingForContent}function Oy(r,e,t,n){if(!n.size)return r.deleteRange(e,t);let s=r.doc.resolve(e),i=r.doc.resolve(t);if(ld(s,i,n))return r.step(new ce(e,t,n));let o=dd(s,i);o[o.length-1]==0&&o.pop();let a=-(s.depth+1);o.unshift(a);for(let h=s.depth,f=s.pos-1;h>0;h--,f--){let p=s.node(h).type.spec;if(p.defining||p.definingAsContext||p.isolating)break;o.indexOf(h)>-1?a=h:s.before(h)==f&&o.splice(1,0,-h)}let l=o.indexOf(a),c=[],u=n.openStart;for(let h=n.content,f=0;;f++){let p=h.firstChild;if(c.push(p),f==n.openStart)break;h=p.content}for(let h=u-1;h>=0;h--){let f=c[h],p=Ay(f.type);if(p&&!f.sameMarkup(s.node(Math.abs(a)-1)))u=h;else if(p||!f.type.isTextblock)break}for(let h=n.openStart;h>=0;h--){let f=(h+u+1)%(n.openStart+1),p=c[f];if(p)for(let m=0;m<o.length;m++){let g=o[(m+l)%o.length],y=!0;g<0&&(y=!1,g=-g);let w=s.node(g-1),v=s.index(g-1);if(w.canReplaceWith(v,v,p.type,p.marks))return r.replace(s.before(g),y?i.after(g):t,new C(ud(n.content,0,n.openStart,f),f,n.openEnd))}}let d=r.steps.length;for(let h=o.length-1;h>=0&&(r.replace(e,t,n),!(r.steps.length>d));h--){let f=o[h];f<0||(e=s.before(f),t=i.after(f))}}function ud(r,e,t,n,s){if(e<t){let i=r.firstChild;r=r.replaceChild(0,i.copy(ud(i.content,e+1,t,n,i)))}if(e>n){let i=s.contentMatchAt(0),o=i.fillBefore(r).append(r);r=o.append(i.matchFragment(o).fillBefore(k.empty,!0))}return r}function My(r,e,t,n){if(!n.isInline&&e==t&&r.doc.resolve(e).parent.content.size){let s=_y(r.doc,e,n.type);s!=null&&(e=t=s)}r.replaceRange(e,t,new C(k.from(n),0,0))}function Iy(r,e,t){let n=r.doc.resolve(e),s=r.doc.resolve(t),i=dd(n,s);for(let o=0;o<i.length;o++){let a=i[o],l=o==i.length-1;if(l&&a==0||n.node(a).type.contentMatch.validEnd)return r.delete(n.start(a),s.end(a));if(a>0&&(l||n.node(a-1).canReplace(n.index(a-1),s.indexAfter(a-1))))return r.delete(n.before(a),s.after(a))}for(let o=1;o<=n.depth&&o<=s.depth;o++)if(e-n.start(o)==n.depth-o&&t>n.end(o)&&s.end(o)-t!=s.depth-o&&n.start(o-1)==s.start(o-1)&&n.node(o-1).canReplace(n.index(o-1),s.index(o-1)))return r.delete(n.before(o),t);r.delete(e,t)}function dd(r,e){let t=[],n=Math.min(r.depth,e.depth);for(let s=n;s>=0;s--){let i=r.start(s);if(i<r.pos-(r.depth-s)||e.end(s)>e.pos+(e.depth-s)||r.node(s).type.spec.isolating||e.node(s).type.spec.isolating)break;(i==e.start(s)||s==r.depth&&s==e.depth&&r.parent.inlineContent&&e.parent.inlineContent&&s&&e.start(s-1)==i-1)&&t.push(s)}return t}class Br extends Te{constructor(e,t,n){super(),this.pos=e,this.attr=t,this.value=n}apply(e){let t=e.nodeAt(this.pos);if(!t)return ie.fail("No node at attribute step's position");let n=Object.create(null);for(let i in t.attrs)n[i]=t.attrs[i];n[this.attr]=this.value;let s=t.type.create(n,null,t.marks);return ie.fromReplace(e,this.pos,this.pos+1,new C(k.from(s),0,t.isLeaf?0:1))}getMap(){return $e.empty}invert(e){return new Br(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Br(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new Br(t.pos,t.attr,t.value)}}Te.jsonID("attr",Br);class Nn extends Te{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let s in e.attrs)t[s]=e.attrs[s];t[this.attr]=this.value;let n=e.type.create(t,e.content,e.marks);return ie.ok(n)}getMap(){return $e.empty}invert(e){return new Nn(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new Nn(t.attr,t.value)}}Te.jsonID("docAttr",Nn);let Fr=class extends Error{};Fr=function r(e){let t=Error.call(this,e);return t.__proto__=r.prototype,t};Fr.prototype=Object.create(Error.prototype);Fr.prototype.constructor=Fr;Fr.prototype.name="TransformError";class hd{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new Rn}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new Fr(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,n=C.empty){let s=Ti(this.doc,e,t,n);return s&&this.step(s),this}replaceWith(e,t,n){return this.replace(e,t,new C(k.from(n),0,0))}delete(e,t){return this.replace(e,t,C.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,n){return Oy(this,e,t,n),this}replaceRangeWith(e,t,n){return My(this,e,t,n),this}deleteRange(e,t){return Iy(this,e,t),this}lift(e,t){return my(this,e,t),this}join(e,t=1){return Ty(this,e,t),this}wrap(e,t){return by(this,e,t),this}setBlockType(e,t=e,n,s=null){return wy(this,e,t,n,s),this}setNodeMarkup(e,t,n=null,s){return ky(this,e,t,n,s),this}setNodeAttribute(e,t,n){return this.step(new Br(e,t,n)),this}setDocAttribute(e,t){return this.step(new Nn(e,t)),this}addNodeMark(e,t){return this.step(new Nt(e,t)),this}removeNodeMark(e,t){let n=this.doc.nodeAt(e);if(!n)throw new RangeError("No node at position "+e);if(t instanceof V)t.isInSet(n.marks)&&this.step(new pr(e,t));else{let s=n.marks,i,o=[];for(;i=t.isInSet(s);)o.push(new pr(e,i)),s=i.removeFromSet(s);for(let a=o.length-1;a>=0;a--)this.step(o[a])}return this}split(e,t=1,n){return Sy(this,e,t,n),this}addMark(e,t,n){return hy(this,e,t,n),this}removeMark(e,t,n){return fy(this,e,t,n),this}clearIncompatible(e,t,n){return Ea(this,e,t,n),this}}const Zi=Object.create(null);class z{constructor(e,t,n){this.$anchor=e,this.$head=t,this.ranges=n||[new Ry(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=C.empty){let n=t.content.lastChild,s=null;for(let a=0;a<t.openEnd;a++)s=n,n=n.lastChild;let i=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:c}=o[a],u=e.mapping.slice(i);e.replaceRange(u.map(l.pos),u.map(c.pos),a?C.empty:t),a==0&&Zl(e,i,(n?n.isInline:s&&s.isTextblock)?-1:1)}}replaceWith(e,t){let n=e.steps.length,s=this.ranges;for(let i=0;i<s.length;i++){let{$from:o,$to:a}=s[i],l=e.mapping.slice(n),c=l.map(o.pos),u=l.map(a.pos);i?e.deleteRange(c,u):(e.replaceRangeWith(c,u,t),Zl(e,n,t.isInline?-1:1))}}static findFrom(e,t,n=!1){let s=e.parent.inlineContent?new D(e):Rr(e.node(0),e.parent,e.pos,e.index(),t,n);if(s)return s;for(let i=e.depth-1;i>=0;i--){let o=t<0?Rr(e.node(0),e.node(i),e.before(i+1),e.index(i),t,n):Rr(e.node(0),e.node(i),e.after(i+1),e.index(i)+1,t,n);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new Le(e.node(0))}static atStart(e){return Rr(e,e,0,0,1)||new Le(e)}static atEnd(e){return Rr(e,e,e.content.size,e.childCount,-1)||new Le(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let n=Zi[t.type];if(!n)throw new RangeError(`No selection type ${t.type} defined`);return n.fromJSON(e,t)}static jsonID(e,t){if(e in Zi)throw new RangeError("Duplicate use of selection JSON ID "+e);return Zi[e]=t,t.prototype.jsonID=e,t}getBookmark(){return D.between(this.$anchor,this.$head).getBookmark()}}z.prototype.visible=!0;class Ry{constructor(e,t){this.$from=e,this.$to=t}}let Ql=!1;function Xl(r){!Ql&&!r.parent.inlineContent&&(Ql=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+r.parent.type.name+")"))}class D extends z{constructor(e,t=e){Xl(e),Xl(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let n=e.resolve(t.map(this.head));if(!n.parent.inlineContent)return z.near(n);let s=e.resolve(t.map(this.anchor));return new D(s.parent.inlineContent?s:n,n)}replace(e,t=C.empty){if(super.replace(e,t),t==C.empty){let n=this.$from.marksAcross(this.$to);n&&e.ensureMarks(n)}}eq(e){return e instanceof D&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new _i(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new D(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,n=t){let s=e.resolve(t);return new this(s,n==t?s:e.resolve(n))}static between(e,t,n){let s=e.pos-t.pos;if((!n||s)&&(n=s>=0?1:-1),!t.parent.inlineContent){let i=z.findFrom(t,n,!0)||z.findFrom(t,-n,!0);if(i)t=i.$head;else return z.near(t,n)}return e.parent.inlineContent||(s==0?e=t:(e=(z.findFrom(e,-n,!0)||z.findFrom(e,n,!0)).$anchor,e.pos<t.pos!=s<0&&(e=t))),new D(e,t)}}z.jsonID("text",D);class _i{constructor(e,t){this.anchor=e,this.head=t}map(e){return new _i(e.map(this.anchor),e.map(this.head))}resolve(e){return D.between(e.resolve(this.anchor),e.resolve(this.head))}}class M extends z{constructor(e){let t=e.nodeAfter,n=e.node(0).resolve(e.pos+t.nodeSize);super(e,n),this.node=t}map(e,t){let{deleted:n,pos:s}=t.mapResult(this.anchor),i=e.resolve(s);return n?z.near(i):new M(i)}content(){return new C(k.from(this.node),0,0)}eq(e){return e instanceof M&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new Aa(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new M(e.resolve(t.anchor))}static create(e,t){return new M(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}M.prototype.visible=!1;z.jsonID("node",M);class Aa{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:n}=e.mapResult(this.anchor);return t?new _i(n,n):new Aa(n)}resolve(e){let t=e.resolve(this.anchor),n=t.nodeAfter;return n&&M.isSelectable(n)?new M(t):z.near(t)}}class Le extends z{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=C.empty){if(t==C.empty){e.delete(0,e.doc.content.size);let n=z.atStart(e.doc);n.eq(e.selection)||e.setSelection(n)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new Le(e)}map(e){return new Le(e)}eq(e){return e instanceof Le}getBookmark(){return Ny}}z.jsonID("all",Le);const Ny={map(){return this},resolve(r){return new Le(r)}};function Rr(r,e,t,n,s,i=!1){if(e.inlineContent)return D.create(r,t);for(let o=n-(s>0?0:1);s>0?o<e.childCount:o>=0;o+=s){let a=e.child(o);if(a.isAtom){if(!i&&M.isSelectable(a))return M.create(r,t-(s<0?a.nodeSize:0))}else{let l=Rr(r,a,t+s,s<0?a.childCount:0,s,i);if(l)return l}t+=a.nodeSize*s}return null}function Zl(r,e,t){let n=r.steps.length-1;if(n<e)return;let s=r.steps[n];if(!(s instanceof ce||s instanceof de))return;let i=r.mapping.maps[n],o;i.forEach((a,l,c,u)=>{o==null&&(o=u)}),r.setSelection(z.near(r.doc.resolve(o),t))}const ec=1,ns=2,tc=4;class Py extends hd{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|ec)&~ns,this.storedMarks=null,this}get selectionSet(){return(this.updated&ec)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=ns,this}ensureMarks(e){return V.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&ns)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~ns,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let n=this.selection;return t&&(e=e.mark(this.storedMarks||(n.empty?n.$from.marks():n.$from.marksAcross(n.$to)||V.none))),n.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,n){let s=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(s.text(e),!0):this.deleteSelection();{if(n==null&&(n=t),!e)return this.deleteRange(t,n);let i=this.storedMarks;if(!i){let o=this.doc.resolve(t);i=n==t?o.marks():o.marksAcross(this.doc.resolve(n))}return this.replaceRangeWith(t,n,s.text(e,i)),!this.selection.empty&&this.selection.to==t+e.length&&this.setSelection(z.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=tc,this}get scrolledIntoView(){return(this.updated&tc)>0}}function rc(r,e){return!e||!r?r:r.bind(e)}class ln{constructor(e,t,n){this.name=e,this.init=rc(t.init,n),this.apply=rc(t.apply,n)}}const Dy=[new ln("doc",{init(r){return r.doc||r.schema.topNodeType.createAndFill()},apply(r){return r.doc}}),new ln("selection",{init(r,e){return r.selection||z.atStart(e.doc)},apply(r){return r.selection}}),new ln("storedMarks",{init(r){return r.storedMarks||null},apply(r,e,t,n){return n.selection.$cursor?r.storedMarks:null}}),new ln("scrollToSelection",{init(){return 0},apply(r,e){return r.scrolledIntoView?e+1:e}})];class eo{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=Dy.slice(),t&&t.forEach(n=>{if(this.pluginsByKey[n.key])throw new RangeError("Adding different instances of a keyed plugin ("+n.key+")");this.plugins.push(n),this.pluginsByKey[n.key]=n,n.spec.state&&this.fields.push(new ln(n.key,n.spec.state,n))})}}class Lr{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let n=0;n<this.config.plugins.length;n++)if(n!=t){let s=this.config.plugins[n];if(s.spec.filterTransaction&&!s.spec.filterTransaction.call(s,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],n=this.applyInner(e),s=null;for(;;){let i=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=s?s[o].n:0,c=s?s[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,c,n);if(u&&n.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!s){s=[];for(let d=0;d<this.config.plugins.length;d++)s.push(d<o?{state:n,n:t.length}:{state:this,n:0})}t.push(u),n=n.applyInner(u),i=!0}s&&(s[o]={state:n,n:t.length})}}if(!i)return{state:n,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new Lr(this.config),n=this.config.fields;for(let s=0;s<n.length;s++){let i=n[s];t[i.name]=i.apply(e,this[i.name],this,t)}return t}get tr(){return new Py(this)}static create(e){let t=new eo(e.doc?e.doc.type.schema:e.schema,e.plugins),n=new Lr(t);for(let s=0;s<t.fields.length;s++)n[t.fields[s].name]=t.fields[s].init(e,n);return n}reconfigure(e){let t=new eo(this.schema,e.plugins),n=t.fields,s=new Lr(t);for(let i=0;i<n.length;i++){let o=n[i].name;s[o]=this.hasOwnProperty(o)?this[o]:n[i].init(e,s)}return s}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(n=>n.toJSON())),e&&typeof e=="object")for(let n in e){if(n=="doc"||n=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let s=e[n],i=s.spec.state;i&&i.toJSON&&(t[n]=i.toJSON.call(s,this[s.key]))}return t}static fromJSON(e,t,n){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let s=new eo(e.schema,e.plugins),i=new Lr(s);return s.fields.forEach(o=>{if(o.name=="doc")i.doc=Ze.fromJSON(e.schema,t.doc);else if(o.name=="selection")i.selection=z.fromJSON(i.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(i.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(n)for(let a in n){let l=n[a],c=l.spec.state;if(l.key==o.name&&c&&c.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){i[o.name]=c.fromJSON.call(l,e,t[a],i);return}}i[o.name]=o.init(e,i)}}),i}}function fd(r,e,t){for(let n in r){let s=r[n];s instanceof Function?s=s.bind(e):n=="handleDOMEvents"&&(s=fd(s,e,{})),t[n]=s}return t}class K{constructor(e){this.spec=e,this.props={},e.props&&fd(e.props,this,this.props),this.key=e.key?e.key.key:pd("plugin")}getState(e){return e[this.key]}}const to=Object.create(null);function pd(r){return r in to?r+"$"+ ++to[r]:(to[r]=0,r+"$")}class ne{constructor(e="key"){this.key=pd(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const Oa=(r,e)=>r.selection.empty?!1:(e&&e(r.tr.deleteSelection().scrollIntoView()),!0);function md(r,e){let{$cursor:t}=r.selection;return!t||(e?!e.endOfTextblock("backward",r):t.parentOffset>0)?null:t}const gd=(r,e,t)=>{let n=md(r,t);if(!n)return!1;let s=Ma(n);if(!s){let o=n.blockRange(),a=o&&Zr(o);return a==null?!1:(e&&e(r.tr.lift(o,a).scrollIntoView()),!0)}let i=s.nodeBefore;if(_d(r,s,e,-1))return!0;if(n.parent.content.size==0&&(Hr(i,"end")||M.isSelectable(i)))for(let o=n.depth;;o--){let a=Ti(r.doc,n.before(o),n.after(o),C.empty);if(a&&a.slice.size<a.to-a.from){if(e){let l=r.tr.step(a);l.setSelection(Hr(i,"end")?z.findFrom(l.doc.resolve(l.mapping.map(s.pos,-1)),-1):M.create(l.doc,s.pos-i.nodeSize)),e(l.scrollIntoView())}return!0}if(o==1||n.node(o-1).childCount>1)break}return i.isAtom&&s.depth==n.depth-1?(e&&e(r.tr.delete(s.pos-i.nodeSize,s.pos).scrollIntoView()),!0):!1},$y=(r,e,t)=>{let n=md(r,t);if(!n)return!1;let s=Ma(n);return s?yd(r,s,e):!1},Ly=(r,e,t)=>{let n=wd(r,t);if(!n)return!1;let s=Ia(n);return s?yd(r,s,e):!1};function yd(r,e,t){let n=e.nodeBefore,s=n,i=e.pos-1;for(;!s.isTextblock;i--){if(s.type.spec.isolating)return!1;let u=s.lastChild;if(!u)return!1;s=u}let o=e.nodeAfter,a=o,l=e.pos+1;for(;!a.isTextblock;l++){if(a.type.spec.isolating)return!1;let u=a.firstChild;if(!u)return!1;a=u}let c=Ti(r.doc,i,l,C.empty);if(!c||c.from!=i||c instanceof ce&&c.slice.size>=l-i)return!1;if(t){let u=r.tr.step(c);u.setSelection(D.create(u.doc,i)),t(u.scrollIntoView())}return!0}function Hr(r,e,t=!1){for(let n=r;n;n=e=="start"?n.firstChild:n.lastChild){if(n.isTextblock)return!0;if(t&&n.childCount!=1)return!1}return!1}const bd=(r,e,t)=>{let{$head:n,empty:s}=r.selection,i=n;if(!s)return!1;if(n.parent.isTextblock){if(t?!t.endOfTextblock("backward",r):n.parentOffset>0)return!1;i=Ma(n)}let o=i&&i.nodeBefore;return!o||!M.isSelectable(o)?!1:(e&&e(r.tr.setSelection(M.create(r.doc,i.pos-o.nodeSize)).scrollIntoView()),!0)};function Ma(r){if(!r.parent.type.spec.isolating)for(let e=r.depth-1;e>=0;e--){if(r.index(e)>0)return r.doc.resolve(r.before(e+1));if(r.node(e).type.spec.isolating)break}return null}function wd(r,e){let{$cursor:t}=r.selection;return!t||(e?!e.endOfTextblock("forward",r):t.parentOffset<t.parent.content.size)?null:t}const vd=(r,e,t)=>{let n=wd(r,t);if(!n)return!1;let s=Ia(n);if(!s)return!1;let i=s.nodeAfter;if(_d(r,s,e,1))return!0;if(n.parent.content.size==0&&(Hr(i,"start")||M.isSelectable(i))){let o=Ti(r.doc,n.before(),n.after(),C.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=r.tr.step(o);a.setSelection(Hr(i,"start")?z.findFrom(a.doc.resolve(a.mapping.map(s.pos)),1):M.create(a.doc,a.mapping.map(s.pos))),e(a.scrollIntoView())}return!0}}return i.isAtom&&s.depth==n.depth-1?(e&&e(r.tr.delete(s.pos,s.pos+i.nodeSize).scrollIntoView()),!0):!1},kd=(r,e,t)=>{let{$head:n,empty:s}=r.selection,i=n;if(!s)return!1;if(n.parent.isTextblock){if(t?!t.endOfTextblock("forward",r):n.parentOffset<n.parent.content.size)return!1;i=Ia(n)}let o=i&&i.nodeAfter;return!o||!M.isSelectable(o)?!1:(e&&e(r.tr.setSelection(M.create(r.doc,i.pos)).scrollIntoView()),!0)};function Ia(r){if(!r.parent.type.spec.isolating)for(let e=r.depth-1;e>=0;e--){let t=r.node(e);if(r.index(e)+1<t.childCount)return r.doc.resolve(r.after(e+1));if(t.type.spec.isolating)break}return null}const jy=(r,e)=>{let t=r.selection,n=t instanceof M,s;if(n){if(t.node.isTextblock||!qt(r.doc,t.from))return!1;s=t.from}else if(s=xi(r.doc,t.from,-1),s==null)return!1;if(e){let i=r.tr.join(s);n&&i.setSelection(M.create(i.doc,s-r.doc.resolve(s).nodeBefore.nodeSize)),e(i.scrollIntoView())}return!0},By=(r,e)=>{let t=r.selection,n;if(t instanceof M){if(t.node.isTextblock||!qt(r.doc,t.to))return!1;n=t.to}else if(n=xi(r.doc,t.to,1),n==null)return!1;return e&&e(r.tr.join(n).scrollIntoView()),!0},zy=(r,e)=>{let{$from:t,$to:n}=r.selection,s=t.blockRange(n),i=s&&Zr(s);return i==null?!1:(e&&e(r.tr.lift(s,i).scrollIntoView()),!0)},Sd=(r,e)=>{let{$head:t,$anchor:n}=r.selection;return!t.parent.type.spec.code||!t.sameParent(n)?!1:(e&&e(r.tr.insertText(`
`).scrollIntoView()),!0)};function Ra(r){for(let e=0;e<r.edgeCount;e++){let{type:t}=r.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}const Uy=(r,e)=>{let{$head:t,$anchor:n}=r.selection;if(!t.parent.type.spec.code||!t.sameParent(n))return!1;let s=t.node(-1),i=t.indexAfter(-1),o=Ra(s.contentMatchAt(i));if(!o||!s.canReplaceWith(i,i,o))return!1;if(e){let a=t.after(),l=r.tr.replaceWith(a,a,o.createAndFill());l.setSelection(z.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},xd=(r,e)=>{let t=r.selection,{$from:n,$to:s}=t;if(t instanceof Le||n.parent.inlineContent||s.parent.inlineContent)return!1;let i=Ra(s.parent.contentMatchAt(s.indexAfter()));if(!i||!i.isTextblock)return!1;if(e){let o=(!n.parentOffset&&s.index()<s.parent.childCount?n:s).pos,a=r.tr.insert(o,i.createAndFill());a.setSelection(D.create(a.doc,o+1)),e(a.scrollIntoView())}return!0},Td=(r,e)=>{let{$cursor:t}=r.selection;if(!t||t.parent.content.size)return!1;if(t.depth>1&&t.after()!=t.end(-1)){let i=t.before();if(gt(r.doc,i))return e&&e(r.tr.split(i).scrollIntoView()),!0}let n=t.blockRange(),s=n&&Zr(n);return s==null?!1:(e&&e(r.tr.lift(n,s).scrollIntoView()),!0)};function Fy(r){return(e,t)=>{let{$from:n,$to:s}=e.selection;if(e.selection instanceof M&&e.selection.node.isBlock)return!n.parentOffset||!gt(e.doc,n.pos)?!1:(t&&t(e.tr.split(n.pos).scrollIntoView()),!0);if(!n.depth)return!1;let i=[],o,a,l=!1,c=!1;for(let f=n.depth;;f--)if(n.node(f).isBlock){l=n.end(f)==n.pos+(n.depth-f),c=n.start(f)==n.pos-(n.depth-f),a=Ra(n.node(f-1).contentMatchAt(n.indexAfter(f-1))),i.unshift(l&&a?{type:a}:null),o=f;break}else{if(f==1)return!1;i.unshift(null)}let u=e.tr;(e.selection instanceof D||e.selection instanceof Le)&&u.deleteSelection();let d=u.mapping.map(n.pos),h=gt(u.doc,d,i.length,i);if(h||(i[0]=a?{type:a}:null,h=gt(u.doc,d,i.length,i)),!h)return!1;if(u.split(d,i.length,i),!l&&c&&n.node(o).type!=a){let f=u.mapping.map(n.before(o)),p=u.doc.resolve(f);a&&n.node(o-1).canReplaceWith(p.index(),p.index()+1,a)&&u.setNodeMarkup(u.mapping.map(n.before(o)),a)}return t&&t(u.scrollIntoView()),!0}}const Hy=Fy(),Vy=(r,e)=>{let{$from:t,to:n}=r.selection,s,i=t.sharedDepth(n);return i==0?!1:(s=t.before(i),e&&e(r.tr.setSelection(M.create(r.doc,s))),!0)};function qy(r,e,t){let n=e.nodeBefore,s=e.nodeAfter,i=e.index();return!n||!s||!n.type.compatibleContent(s.type)?!1:!n.content.size&&e.parent.canReplace(i-1,i)?(t&&t(r.tr.delete(e.pos-n.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(i,i+1)||!(s.isTextblock||qt(r.doc,e.pos))?!1:(t&&t(r.tr.join(e.pos).scrollIntoView()),!0)}function _d(r,e,t,n){let s=e.nodeBefore,i=e.nodeAfter,o,a,l=s.type.spec.isolating||i.type.spec.isolating;if(!l&&qy(r,e,t))return!0;let c=!l&&e.parent.canReplace(e.index(),e.index()+1);if(c&&(o=(a=s.contentMatchAt(s.childCount)).findWrapping(i.type))&&a.matchType(o[0]||i.type).validEnd){if(t){let f=e.pos+i.nodeSize,p=k.empty;for(let y=o.length-1;y>=0;y--)p=k.from(o[y].create(null,p));p=k.from(s.copy(p));let m=r.tr.step(new de(e.pos-1,f,e.pos,f,new C(p,1,0),o.length,!0)),g=m.doc.resolve(f+2*o.length);g.nodeAfter&&g.nodeAfter.type==s.type&&qt(m.doc,g.pos)&&m.join(g.pos),t(m.scrollIntoView())}return!0}let u=i.type.spec.isolating||n>0&&l?null:z.findFrom(e,1),d=u&&u.$from.blockRange(u.$to),h=d&&Zr(d);if(h!=null&&h>=e.depth)return t&&t(r.tr.lift(d,h).scrollIntoView()),!0;if(c&&Hr(i,"start",!0)&&Hr(s,"end")){let f=s,p=[];for(;p.push(f),!f.isTextblock;)f=f.lastChild;let m=i,g=1;for(;!m.isTextblock;m=m.firstChild)g++;if(f.canReplace(f.childCount,f.childCount,m.content)){if(t){let y=k.empty;for(let v=p.length-1;v>=0;v--)y=k.from(p[v].copy(y));let w=r.tr.step(new de(e.pos-p.length,e.pos+i.nodeSize,e.pos+g,e.pos+i.nodeSize-g,new C(y,p.length,0),0,!0));t(w.scrollIntoView())}return!0}}return!1}function Ed(r){return function(e,t){let n=e.selection,s=r<0?n.$from:n.$to,i=s.depth;for(;s.node(i).isInline;){if(!i)return!1;i--}return s.node(i).isTextblock?(t&&t(e.tr.setSelection(D.create(e.doc,r<0?s.start(i):s.end(i)))),!0):!1}}const Wy=Ed(-1),Ky=Ed(1);function Jy(r,e=null){return function(t,n){let{$from:s,$to:i}=t.selection,o=s.blockRange(i),a=o&&Ca(o,r,e);return a?(n&&n(t.tr.wrap(o,a).scrollIntoView()),!0):!1}}function nc(r,e=null){return function(t,n){let s=!1;for(let i=0;i<t.selection.ranges.length&&!s;i++){let{$from:{pos:o},$to:{pos:a}}=t.selection.ranges[i];t.doc.nodesBetween(o,a,(l,c)=>{if(s)return!1;if(!(!l.isTextblock||l.hasMarkup(r,e)))if(l.type==r)s=!0;else{let u=t.doc.resolve(c),d=u.index();s=u.parent.canReplaceWith(d,d+1,r)}})}if(!s)return!1;if(n){let i=t.tr;for(let o=0;o<t.selection.ranges.length;o++){let{$from:{pos:a},$to:{pos:l}}=t.selection.ranges[o];i.setBlockType(a,l,r,e)}n(i.scrollIntoView())}return!0}}function Na(...r){return function(e,t,n){for(let s=0;s<r.length;s++)if(r[s](e,t,n))return!0;return!1}}Na(Oa,gd,bd);Na(Oa,vd,kd);Na(Sd,xd,Td,Hy);typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform&&os.platform()=="darwin";function Gy(r,e=null){return function(t,n){let{$from:s,$to:i}=t.selection,o=s.blockRange(i);if(!o)return!1;let a=n?t.tr:null;return Yy(a,o,r,e)?(n&&n(a.scrollIntoView()),!0):!1}}function Yy(r,e,t,n=null){let s=!1,i=e,o=e.$from.doc;if(e.depth>=2&&e.$from.node(e.depth-1).type.compatibleContent(t)&&e.startIndex==0){if(e.$from.index(e.depth-1)==0)return!1;let l=o.resolve(e.start-2);i=new As(l,l,e.depth),e.endIndex<e.parent.childCount&&(e=new As(e.$from,o.resolve(e.$to.end(e.depth)),e.depth)),s=!0}let a=Ca(i,t,n,e);return a?(r&&Qy(r,e,a,s,t),!0):!1}function Qy(r,e,t,n,s){let i=k.empty;for(let u=t.length-1;u>=0;u--)i=k.from(t[u].type.create(t[u].attrs,i));r.step(new de(e.start-(n?2:0),e.end,e.start,e.end,new C(i,0,0),t.length,!0));let o=0;for(let u=0;u<t.length;u++)t[u].type==s&&(o=u+1);let a=t.length-o,l=e.start+t.length-(n?2:0),c=e.parent;for(let u=e.startIndex,d=e.endIndex,h=!0;u<d;u++,h=!1)!h&&gt(r.doc,l,a)&&(r.split(l,a),l+=2*a),l+=c.child(u).nodeSize;return r}function Xy(r){return function(e,t){let{$from:n,$to:s}=e.selection,i=n.blockRange(s,o=>o.childCount>0&&o.firstChild.type==r);return i?t?n.node(i.depth-1).type==r?Zy(e,t,r,i):eb(e,t,i):!0:!1}}function Zy(r,e,t,n){let s=r.tr,i=n.end,o=n.$to.end(n.depth);i<o&&(s.step(new de(i-1,o,i,o,new C(k.from(t.create(null,n.parent.copy())),1,0),1,!0)),n=new As(s.doc.resolve(n.$from.pos),s.doc.resolve(o),n.depth));const a=Zr(n);if(a==null)return!1;s.lift(n,a);let l=s.doc.resolve(s.mapping.map(i,-1)-1);return qt(s.doc,l.pos)&&l.nodeBefore.type==l.nodeAfter.type&&s.join(l.pos),e(s.scrollIntoView()),!0}function eb(r,e,t){let n=r.tr,s=t.parent;for(let f=t.end,p=t.endIndex-1,m=t.startIndex;p>m;p--)f-=s.child(p).nodeSize,n.delete(f-1,f+1);let i=n.doc.resolve(t.start),o=i.nodeAfter;if(n.mapping.map(t.end)!=t.start+i.nodeAfter.nodeSize)return!1;let a=t.startIndex==0,l=t.endIndex==s.childCount,c=i.node(-1),u=i.index(-1);if(!c.canReplace(u+(a?0:1),u+1,o.content.append(l?k.empty:k.from(s))))return!1;let d=i.pos,h=d+o.nodeSize;return n.step(new de(d-(a?1:0),h+(l?1:0),d+1,h-1,new C((a?k.empty:k.from(s.copy(k.empty))).append(l?k.empty:k.from(s.copy(k.empty))),a?0:1,l?0:1),a?0:1)),e(n.scrollIntoView()),!0}function tb(r){return function(e,t){let{$from:n,$to:s}=e.selection,i=n.blockRange(s,c=>c.childCount>0&&c.firstChild.type==r);if(!i)return!1;let o=i.startIndex;if(o==0)return!1;let a=i.parent,l=a.child(o-1);if(l.type!=r)return!1;if(t){let c=l.lastChild&&l.lastChild.type==a.type,u=k.from(c?r.create():null),d=new C(k.from(r.create(null,k.from(a.type.create(null,u)))),c?3:1,0),h=i.start,f=i.end;t(e.tr.step(new de(h-(c?3:1),f,h,f,d,1,!0)).scrollIntoView())}return!0}}const ge=function(r){for(var e=0;;e++)if(r=r.previousSibling,!r)return e},Vr=function(r){let e=r.assignedSlot||r.parentNode;return e&&e.nodeType==11?e.host:e};let qo=null;const pt=function(r,e,t){let n=qo||(qo=document.createRange());return n.setEnd(r,t??r.nodeValue.length),n.setStart(r,e||0),n},rb=function(){qo=null},mr=function(r,e,t,n){return t&&(sc(r,e,t,n,-1)||sc(r,e,t,n,1))},nb=/^(img|br|input|textarea|hr)$/i;function sc(r,e,t,n,s){for(var i;;){if(r==t&&e==n)return!0;if(e==(s<0?0:He(r))){let o=r.parentNode;if(!o||o.nodeType!=1||Vn(r)||nb.test(r.nodeName)||r.contentEditable=="false")return!1;e=ge(r)+(s<0?0:1),r=o}else if(r.nodeType==1){let o=r.childNodes[e+(s<0?-1:0)];if(o.nodeType==1&&o.contentEditable=="false")if(!((i=o.pmViewDesc)===null||i===void 0)&&i.ignoreForSelection)e+=s;else return!1;else r=o,e=s<0?He(r):0}else return!1}}function He(r){return r.nodeType==3?r.nodeValue.length:r.childNodes.length}function sb(r,e){for(;;){if(r.nodeType==3&&e)return r;if(r.nodeType==1&&e>0){if(r.contentEditable=="false")return null;r=r.childNodes[e-1],e=He(r)}else if(r.parentNode&&!Vn(r))e=ge(r),r=r.parentNode;else return null}}function ib(r,e){for(;;){if(r.nodeType==3&&e<r.nodeValue.length)return r;if(r.nodeType==1&&e<r.childNodes.length){if(r.contentEditable=="false")return null;r=r.childNodes[e],e=0}else if(r.parentNode&&!Vn(r))e=ge(r)+1,r=r.parentNode;else return null}}function ob(r,e,t){for(let n=e==0,s=e==He(r);n||s;){if(r==t)return!0;let i=ge(r);if(r=r.parentNode,!r)return!1;n=n&&i==0,s=s&&i==He(r)}}function Vn(r){let e;for(let t=r;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==r||e.contentDOM==r)}const Ei=function(r){return r.focusNode&&mr(r.focusNode,r.focusOffset,r.anchorNode,r.anchorOffset)};function er(r,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=r,t.key=t.code=e,t}function ab(r){let e=r.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function lb(r,e,t){if(r.caretPositionFromPoint)try{let n=r.caretPositionFromPoint(e,t);if(n)return{node:n.offsetNode,offset:Math.min(He(n.offsetNode),n.offset)}}catch{}if(r.caretRangeFromPoint){let n=r.caretRangeFromPoint(e,t);if(n)return{node:n.startContainer,offset:Math.min(He(n.startContainer),n.startOffset)}}}const at=typeof navigator<"u"?navigator:null,ic=typeof document<"u"?document:null,Wt=at&&at.userAgent||"",Wo=/Edge\/(\d+)/.exec(Wt),Cd=/MSIE \d/.exec(Wt),Ko=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Wt),Ie=!!(Cd||Ko||Wo),jt=Cd?document.documentMode:Ko?+Ko[1]:Wo?+Wo[1]:0,Ve=!Ie&&/gecko\/(\d+)/i.test(Wt);Ve&&+(/Firefox\/(\d+)/.exec(Wt)||[0,0])[1];const Jo=!Ie&&/Chrome\/(\d+)/.exec(Wt),ue=!!Jo,Ad=Jo?+Jo[1]:0,Se=!Ie&&!!at&&/Apple Computer/.test(at.vendor),qr=Se&&(/Mobile\/\w+/.test(Wt)||!!at&&at.maxTouchPoints>2),Fe=qr||(at?/Mac/.test(at.platform):!1),Od=at?/Win/.test(at.platform):!1,mt=/Android \d/.test(Wt),qn=!!ic&&"webkitFontSmoothing"in ic.documentElement.style,cb=qn?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function ub(r){let e=r.defaultView&&r.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:r.documentElement.clientWidth,top:0,bottom:r.documentElement.clientHeight}}function ct(r,e){return typeof r=="number"?r:r[e]}function db(r){let e=r.getBoundingClientRect(),t=e.width/r.offsetWidth||1,n=e.height/r.offsetHeight||1;return{left:e.left,right:e.left+r.clientWidth*t,top:e.top,bottom:e.top+r.clientHeight*n}}function oc(r,e,t){let n=r.someProp("scrollThreshold")||0,s=r.someProp("scrollMargin")||5,i=r.dom.ownerDocument;for(let o=t||r.dom;o;){if(o.nodeType!=1){o=Vr(o);continue}let a=o,l=a==i.body,c=l?ub(i):db(a),u=0,d=0;if(e.top<c.top+ct(n,"top")?d=-(c.top-e.top+ct(s,"top")):e.bottom>c.bottom-ct(n,"bottom")&&(d=e.bottom-e.top>c.bottom-c.top?e.top+ct(s,"top")-c.top:e.bottom-c.bottom+ct(s,"bottom")),e.left<c.left+ct(n,"left")?u=-(c.left-e.left+ct(s,"left")):e.right>c.right-ct(n,"right")&&(u=e.right-c.right+ct(s,"right")),u||d)if(l)i.defaultView.scrollBy(u,d);else{let f=a.scrollLeft,p=a.scrollTop;d&&(a.scrollTop+=d),u&&(a.scrollLeft+=u);let m=a.scrollLeft-f,g=a.scrollTop-p;e={left:e.left-m,top:e.top-g,right:e.right-m,bottom:e.bottom-g}}let h=l?"fixed":getComputedStyle(o).position;if(/^(fixed|sticky)$/.test(h))break;o=h=="absolute"?o.offsetParent:Vr(o)}}function hb(r){let e=r.dom.getBoundingClientRect(),t=Math.max(0,e.top),n,s;for(let i=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=r.root.elementFromPoint(i,o);if(!a||a==r.dom||!r.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){n=a,s=l.top;break}}return{refDOM:n,refTop:s,stack:Md(r.dom)}}function Md(r){let e=[],t=r.ownerDocument;for(let n=r;n&&(e.push({dom:n,top:n.scrollTop,left:n.scrollLeft}),r!=t);n=Vr(n));return e}function fb({refDOM:r,refTop:e,stack:t}){let n=r?r.getBoundingClientRect().top:0;Id(t,n==0?0:n-e)}function Id(r,e){for(let t=0;t<r.length;t++){let{dom:n,top:s,left:i}=r[t];n.scrollTop!=s+e&&(n.scrollTop=s+e),n.scrollLeft!=i&&(n.scrollLeft=i)}}let Cr=null;function pb(r){if(r.setActive)return r.setActive();if(Cr)return r.focus(Cr);let e=Md(r);r.focus(Cr==null?{get preventScroll(){return Cr={preventScroll:!0},!0}}:void 0),Cr||(Cr=!1,Id(e,0))}function Rd(r,e){let t,n=2e8,s,i=0,o=e.top,a=e.top,l,c;for(let u=r.firstChild,d=0;u;u=u.nextSibling,d++){let h;if(u.nodeType==1)h=u.getClientRects();else if(u.nodeType==3)h=pt(u).getClientRects();else continue;for(let f=0;f<h.length;f++){let p=h[f];if(p.top<=o&&p.bottom>=a){o=Math.max(p.bottom,o),a=Math.min(p.top,a);let m=p.left>e.left?p.left-e.left:p.right<e.left?e.left-p.right:0;if(m<n){t=u,n=m,s=m&&t.nodeType==3?{left:p.right<e.left?p.right:p.left,top:e.top}:e,u.nodeType==1&&m&&(i=d+(e.left>=(p.left+p.right)/2?1:0));continue}}else p.top>e.top&&!l&&p.left<=e.left&&p.right>=e.left&&(l=u,c={left:Math.max(p.left,Math.min(p.right,e.left)),top:p.top});!t&&(e.left>=p.right&&e.top>=p.top||e.left>=p.left&&e.top>=p.bottom)&&(i=d+1)}}return!t&&l&&(t=l,s=c,n=0),t&&t.nodeType==3?mb(t,s):!t||n&&t.nodeType==1?{node:r,offset:i}:Rd(t,s)}function mb(r,e){let t=r.nodeValue.length,n=document.createRange(),s;for(let i=0;i<t;i++){n.setEnd(r,i+1),n.setStart(r,i);let o=Tt(n,1);if(o.top!=o.bottom&&Pa(e,o)){s={node:r,offset:i+(e.left>=(o.left+o.right)/2?1:0)};break}}return n.detach(),s||{node:r,offset:0}}function Pa(r,e){return r.left>=e.left-1&&r.left<=e.right+1&&r.top>=e.top-1&&r.top<=e.bottom+1}function gb(r,e){let t=r.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<r.getBoundingClientRect().left?t:r}function yb(r,e,t){let{node:n,offset:s}=Rd(e,t),i=-1;if(n.nodeType==1&&!n.firstChild){let o=n.getBoundingClientRect();i=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return r.docView.posFromDOM(n,s,i)}function bb(r,e,t,n){let s=-1;for(let i=e,o=!1;i!=r.dom;){let a=r.docView.nearestDesc(i,!0),l;if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)&&((l=a.dom.getBoundingClientRect()).width||l.height)&&(a.node.isBlock&&a.parent&&!/^T(R|BODY|HEAD|FOOT)$/.test(a.dom.nodeName)&&(!o&&l.left>n.left||l.top>n.top?s=a.posBefore:(!o&&l.right<n.left||l.bottom<n.top)&&(s=a.posAfter),o=!0),!a.contentDOM&&s<0&&!a.node.isText))return(a.node.isBlock?n.top<(l.top+l.bottom)/2:n.left<(l.left+l.right)/2)?a.posBefore:a.posAfter;i=a.dom.parentNode}return s>-1?s:r.docView.posFromDOM(e,t,-1)}function Nd(r,e,t){let n=r.childNodes.length;if(n&&t.top<t.bottom)for(let s=Math.max(0,Math.min(n-1,Math.floor(n*(e.top-t.top)/(t.bottom-t.top))-2)),i=s;;){let o=r.childNodes[i];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let c=a[l];if(Pa(e,c))return Nd(o,e,c)}}if((i=(i+1)%n)==s)break}return r}function wb(r,e){let t=r.dom.ownerDocument,n,s=0,i=lb(t,e.left,e.top);i&&({node:n,offset:s}=i);let o=(r.root.elementFromPoint?r.root:t).elementFromPoint(e.left,e.top),a;if(!o||!r.dom.contains(o.nodeType!=1?o.parentNode:o)){let c=r.dom.getBoundingClientRect();if(!Pa(e,c)||(o=Nd(r.dom,e,c),!o))return null}if(Se)for(let c=o;n&&c;c=Vr(c))c.draggable&&(n=void 0);if(o=gb(o,e),n){if(Ve&&n.nodeType==1&&(s=Math.min(s,n.childNodes.length),s<n.childNodes.length)){let u=n.childNodes[s],d;u.nodeName=="IMG"&&(d=u.getBoundingClientRect()).right<=e.left&&d.bottom>e.top&&s++}let c;qn&&s&&n.nodeType==1&&(c=n.childNodes[s-1]).nodeType==1&&c.contentEditable=="false"&&c.getBoundingClientRect().top>=e.top&&s--,n==r.dom&&s==n.childNodes.length-1&&n.lastChild.nodeType==1&&e.top>n.lastChild.getBoundingClientRect().bottom?a=r.state.doc.content.size:(s==0||n.nodeType!=1||n.childNodes[s-1].nodeName!="BR")&&(a=bb(r,n,s,e))}a==null&&(a=yb(r,o,e));let l=r.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function ac(r){return r.top<r.bottom||r.left<r.right}function Tt(r,e){let t=r.getClientRects();if(t.length){let n=t[e<0?0:t.length-1];if(ac(n))return n}return Array.prototype.find.call(t,ac)||r.getBoundingClientRect()}const vb=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Pd(r,e,t){let{node:n,offset:s,atom:i}=r.docView.domFromPos(e,t<0?-1:1),o=qn||Ve;if(n.nodeType==3)if(o&&(vb.test(n.nodeValue)||(t<0?!s:s==n.nodeValue.length))){let l=Tt(pt(n,s,s),t);if(Ve&&s&&/\s/.test(n.nodeValue[s-1])&&s<n.nodeValue.length){let c=Tt(pt(n,s-1,s-1),-1);if(c.top==l.top){let u=Tt(pt(n,s,s+1),-1);if(u.top!=l.top)return tn(u,u.left<c.left)}}return l}else{let l=s,c=s,u=t<0?1:-1;return t<0&&!s?(c++,u=-1):t>=0&&s==n.nodeValue.length?(l--,u=1):t<0?l--:c++,tn(Tt(pt(n,l,c),u),u<0)}if(!r.state.doc.resolve(e-(i||0)).parent.inlineContent){if(i==null&&s&&(t<0||s==He(n))){let l=n.childNodes[s-1];if(l.nodeType==1)return ro(l.getBoundingClientRect(),!1)}if(i==null&&s<He(n)){let l=n.childNodes[s];if(l.nodeType==1)return ro(l.getBoundingClientRect(),!0)}return ro(n.getBoundingClientRect(),t>=0)}if(i==null&&s&&(t<0||s==He(n))){let l=n.childNodes[s-1],c=l.nodeType==3?pt(l,He(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(c)return tn(Tt(c,1),!1)}if(i==null&&s<He(n)){let l=n.childNodes[s];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let c=l?l.nodeType==3?pt(l,0,o?0:1):l.nodeType==1?l:null:null;if(c)return tn(Tt(c,-1),!0)}return tn(Tt(n.nodeType==3?pt(n):n,-t),t>=0)}function tn(r,e){if(r.width==0)return r;let t=e?r.left:r.right;return{top:r.top,bottom:r.bottom,left:t,right:t}}function ro(r,e){if(r.height==0)return r;let t=e?r.top:r.bottom;return{top:t,bottom:t,left:r.left,right:r.right}}function Dd(r,e,t){let n=r.state,s=r.root.activeElement;n!=e&&r.updateState(e),s!=r.dom&&r.focus();try{return t()}finally{n!=e&&r.updateState(n),s!=r.dom&&s&&s.focus()}}function kb(r,e,t){let n=e.selection,s=t=="up"?n.$from:n.$to;return Dd(r,e,()=>{let{node:i}=r.docView.domFromPos(s.pos,t=="up"?-1:1);for(;;){let a=r.docView.nearestDesc(i,!0);if(!a)break;if(a.node.isBlock){i=a.contentDOM||a.dom;break}i=a.dom.parentNode}let o=Pd(r,s.pos,1);for(let a=i.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=pt(a,0,a.nodeValue.length).getClientRects();else continue;for(let c=0;c<l.length;c++){let u=l[c];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const Sb=/[\u0590-\u08ac]/;function xb(r,e,t){let{$head:n}=e.selection;if(!n.parent.isTextblock)return!1;let s=n.parentOffset,i=!s,o=s==n.parent.content.size,a=r.domSelection();return a?!Sb.test(n.parent.textContent)||!a.modify?t=="left"||t=="backward"?i:o:Dd(r,e,()=>{let{focusNode:l,focusOffset:c,anchorNode:u,anchorOffset:d}=r.domSelectionRange(),h=a.caretBidiLevel;a.modify("move",t,"character");let f=n.depth?r.docView.domAfterPos(n.before()):r.dom,{focusNode:p,focusOffset:m}=r.domSelectionRange(),g=p&&!f.contains(p.nodeType==1?p:p.parentNode)||l==p&&c==m;try{a.collapse(u,d),l&&(l!=u||c!=d)&&a.extend&&a.extend(l,c)}catch{}return h!=null&&(a.caretBidiLevel=h),g}):n.pos==n.start()||n.pos==n.end()}let lc=null,cc=null,uc=!1;function Tb(r,e,t){return lc==e&&cc==t?uc:(lc=e,cc=t,uc=t=="up"||t=="down"?kb(r,e,t):xb(r,e,t))}const qe=0,dc=1,rr=2,lt=3;class Wn{constructor(e,t,n,s){this.parent=e,this.children=t,this.dom=n,this.contentDOM=s,this.dirty=qe,n.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,n){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,n=this.posAtStart;;t++){let s=this.children[t];if(s==e)return n;n+=s.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,n){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(n<0){let i,o;if(e==this.contentDOM)i=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;i=e.previousSibling}for(;i&&!((o=i.pmViewDesc)&&o.parent==this);)i=i.previousSibling;return i?this.posBeforeChild(o)+o.size:this.posAtStart}else{let i,o;if(e==this.contentDOM)i=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;i=e.nextSibling}for(;i&&!((o=i.pmViewDesc)&&o.parent==this);)i=i.nextSibling;return i?this.posBeforeChild(o):this.posAtEnd}let s;if(e==this.dom&&this.contentDOM)s=t>ge(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))s=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let i=e;;i=i.parentNode){if(i==this.dom){s=!1;break}if(i.previousSibling)break}if(s==null&&t==e.childNodes.length)for(let i=e;;i=i.parentNode){if(i==this.dom){s=!0;break}if(i.nextSibling)break}}return s??n>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let n=!0,s=e;s;s=s.parentNode){let i=this.getDesc(s),o;if(i&&(!t||i.node))if(n&&(o=i.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))n=!1;else return i}}getDesc(e){let t=e.pmViewDesc;for(let n=t;n;n=n.parent)if(n==this)return t}posFromDOM(e,t,n){for(let s=e;s;s=s.parentNode){let i=this.getDesc(s);if(i)return i.localPosFromDOM(e,t,n)}return-1}descAt(e){for(let t=0,n=0;t<this.children.length;t++){let s=this.children[t],i=n+s.size;if(n==e&&i!=n){for(;!s.border&&s.children.length;)for(let o=0;o<s.children.length;o++){let a=s.children[o];if(a.size){s=a;break}}return s}if(e<i)return s.descAt(e-n-s.border);n=i}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let n=0,s=0;for(let i=0;n<this.children.length;n++){let o=this.children[n],a=i+o.size;if(a>e||o instanceof Ld){s=e-i;break}i=a}if(s)return this.children[n].domFromPos(s-this.children[n].border,t);for(let i;n&&!(i=this.children[n-1]).size&&i instanceof $d&&i.side>=0;n--);if(t<=0){let i,o=!0;for(;i=n?this.children[n-1]:null,!(!i||i.dom.parentNode==this.contentDOM);n--,o=!1);return i&&t&&o&&!i.border&&!i.domAtom?i.domFromPos(i.size,t):{node:this.contentDOM,offset:i?ge(i.dom)+1:0}}else{let i,o=!0;for(;i=n<this.children.length?this.children[n]:null,!(!i||i.dom.parentNode==this.contentDOM);n++,o=!1);return i&&o&&!i.border&&!i.domAtom?i.domFromPos(0,t):{node:this.contentDOM,offset:i?ge(i.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,n=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let s=-1,i=-1;for(let o=n,a=0;;a++){let l=this.children[a],c=o+l.size;if(s==-1&&e<=c){let u=o+l.border;if(e>=u&&t<=c-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let d=a;d>0;d--){let h=this.children[d-1];if(h.size&&h.dom.parentNode==this.contentDOM&&!h.emptyChildAt(1)){s=ge(h.dom)+1;break}e-=h.size}s==-1&&(s=0)}if(s>-1&&(c>t||a==this.children.length-1)){t=c;for(let u=a+1;u<this.children.length;u++){let d=this.children[u];if(d.size&&d.dom.parentNode==this.contentDOM&&!d.emptyChildAt(-1)){i=ge(d.dom);break}t+=d.size}i==-1&&(i=this.contentDOM.childNodes.length);break}o=c}return{node:this.contentDOM,from:e,to:t,fromOffset:s,toOffset:i}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:n}=this.domFromPos(e,0);if(t.nodeType!=1||n==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[n]}setSelection(e,t,n,s=!1){let i=Math.min(e,t),o=Math.max(e,t);for(let f=0,p=0;f<this.children.length;f++){let m=this.children[f],g=p+m.size;if(i>p&&o<g)return m.setSelection(e-p-m.border,t-p-m.border,n,s);p=g}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),c=n.root.getSelection(),u=n.domSelectionRange(),d=!1;if((Ve||Se)&&e==t){let{node:f,offset:p}=a;if(f.nodeType==3){if(d=!!(p&&f.nodeValue[p-1]==`
`),d&&p==f.nodeValue.length)for(let m=f,g;m;m=m.parentNode){if(g=m.nextSibling){g.nodeName=="BR"&&(a=l={node:g.parentNode,offset:ge(g)+1});break}let y=m.pmViewDesc;if(y&&y.node&&y.node.isBlock)break}}else{let m=f.childNodes[p-1];d=m&&(m.nodeName=="BR"||m.contentEditable=="false")}}if(Ve&&u.focusNode&&u.focusNode!=l.node&&u.focusNode.nodeType==1){let f=u.focusNode.childNodes[u.focusOffset];f&&f.contentEditable=="false"&&(s=!0)}if(!(s||d&&Se)&&mr(a.node,a.offset,u.anchorNode,u.anchorOffset)&&mr(l.node,l.offset,u.focusNode,u.focusOffset))return;let h=!1;if((c.extend||e==t)&&!(d&&Ve)){c.collapse(a.node,a.offset);try{e!=t&&c.extend(l.node,l.offset),h=!0}catch{}}if(!h){if(e>t){let p=a;a=l,l=p}let f=document.createRange();f.setEnd(l.node,l.offset),f.setStart(a.node,a.offset),c.removeAllRanges(),c.addRange(f)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let n=0,s=0;s<this.children.length;s++){let i=this.children[s],o=n+i.size;if(n==o?e<=o&&t>=n:e<o&&t>n){let a=n+i.border,l=o-i.border;if(e>=a&&t<=l){this.dirty=e==n||t==o?rr:dc,e==a&&t==l&&(i.contentLost||i.dom.parentNode!=this.contentDOM)?i.dirty=lt:i.markDirty(e-a,t-a);return}else i.dirty=i.dom==i.contentDOM&&i.dom.parentNode==this.contentDOM&&!i.children.length?rr:lt}n=o}this.dirty=rr}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let n=e==1?rr:dc;t.dirty<n&&(t.dirty=n)}}get domAtom(){return!1}get ignoreForCoords(){return!1}get ignoreForSelection(){return!1}isText(e){return!1}}class $d extends Wn{constructor(e,t,n,s){let i,o=t.type.toDOM;if(typeof o=="function"&&(o=o(n,()=>{if(!i)return s;if(i.parent)return i.parent.posBeforeChild(i)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,i=this}matchesWidget(e){return this.dirty==qe&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get ignoreForSelection(){return!!this.widget.type.spec.relaxedSide}get side(){return this.widget.type.side}}class _b extends Wn{constructor(e,t,n,s){super(e,[],t,null),this.textDOM=n,this.text=s}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class gr extends Wn{constructor(e,t,n,s,i){super(e,[],n,s),this.mark=t,this.spec=i}static create(e,t,n,s){let i=s.nodeViews[t.type.name],o=i&&i(t,s,n);return(!o||!o.dom)&&(o=vr.renderSpec(document,t.type.spec.toDOM(t,n),null,t.attrs)),new gr(e,t,o.dom,o.contentDOM||o.dom,o)}parseRule(){return this.dirty&lt||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=lt&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=qe){let n=this.parent;for(;!n.node;)n=n.parent;n.dirty<this.dirty&&(n.dirty=this.dirty),this.dirty=qe}}slice(e,t,n){let s=gr.create(this.parent,this.mark,!0,n),i=this.children,o=this.size;t<o&&(i=Yo(i,t,o,n)),e>0&&(i=Yo(i,0,e,n));for(let a=0;a<i.length;a++)i[a].parent=s;return s.children=i,s}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}}class Bt extends Wn{constructor(e,t,n,s,i,o,a,l,c){super(e,[],i,o),this.node=t,this.outerDeco=n,this.innerDeco=s,this.nodeDOM=a}static create(e,t,n,s,i,o){let a=i.nodeViews[t.type.name],l,c=a&&a(t,i,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},n,s),u=c&&c.dom,d=c&&c.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:d}=vr.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!d&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let h=u;return u=zd(u,n,t),c?l=new Eb(e,t,n,s,u,d||null,h,c,i,o+1):t.isText?new Ci(e,t,n,s,u,h,i):new Bt(e,t,n,s,u,d||null,h,i,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let n=this.children[t];if(this.dom.contains(n.dom.parentNode)){e.contentElement=n.dom.parentNode;break}}e.contentElement||(e.getContent=()=>k.empty)}return e}matchesNode(e,t,n){return this.dirty==qe&&e.eq(this.node)&&Ms(t,this.outerDeco)&&n.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let n=this.node.inlineContent,s=t,i=e.composing?this.localCompositionInfo(e,t):null,o=i&&i.pos>-1?i:null,a=i&&i.pos<0,l=new Ab(this,o&&o.node,e);Ib(this.node,this.innerDeco,(c,u,d)=>{c.spec.marks?l.syncToMarks(c.spec.marks,n,e):c.type.side>=0&&!d&&l.syncToMarks(u==this.node.childCount?V.none:this.node.child(u).marks,n,e),l.placeWidget(c,e,s)},(c,u,d,h)=>{l.syncToMarks(c.marks,n,e);let f;l.findNodeMatch(c,u,d,h)||a&&e.state.selection.from>s&&e.state.selection.to<s+c.nodeSize&&(f=l.findIndexWithChild(i.node))>-1&&l.updateNodeAt(c,u,d,f,e)||l.updateNextNode(c,u,d,e,h,s)||l.addNode(c,u,d,e,s),s+=c.nodeSize}),l.syncToMarks([],n,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==rr)&&(o&&this.protectLocalComposition(e,o),jd(this.contentDOM,this.children,e),qr&&Rb(this.dom))}localCompositionInfo(e,t){let{from:n,to:s}=e.state.selection;if(!(e.state.selection instanceof D)||n<t||s>t+this.node.content.size)return null;let i=e.input.compositionNode;if(!i||!this.dom.contains(i.parentNode))return null;if(this.node.inlineContent){let o=i.nodeValue,a=Nb(this.node.content,o,n-t,s-t);return a<0?null:{node:i,pos:a,text:o}}else return{node:i,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:n,text:s}){if(this.getDesc(t))return;let i=t;for(;i.parentNode!=this.contentDOM;i=i.parentNode){for(;i.previousSibling;)i.parentNode.removeChild(i.previousSibling);for(;i.nextSibling;)i.parentNode.removeChild(i.nextSibling);i.pmViewDesc&&(i.pmViewDesc=void 0)}let o=new _b(this,i,t,s);e.input.compositionNodes.push(o),this.children=Yo(this.children,n,n+s.length,e,o)}update(e,t,n,s){return this.dirty==lt||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,n,s),!0)}updateInner(e,t,n,s){this.updateOuterDeco(t),this.node=e,this.innerDeco=n,this.contentDOM&&this.updateChildren(s,this.posAtStart),this.dirty=qe}updateOuterDeco(e){if(Ms(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,n=this.dom;this.dom=Bd(this.dom,this.nodeDOM,Go(this.outerDeco,this.node,t),Go(e,this.node,t)),this.dom!=n&&(n.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.nodeDOM.draggable=!0))}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.nodeDOM.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function hc(r,e,t,n,s){zd(n,e,r);let i=new Bt(void 0,r,e,t,n,n,n,s,0);return i.contentDOM&&i.updateChildren(s,0),i}class Ci extends Bt{constructor(e,t,n,s,i,o,a){super(e,t,n,s,i,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,n,s){return this.dirty==lt||this.dirty!=qe&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=qe||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,s.trackWrites==this.nodeDOM&&(s.trackWrites=null)),this.node=e,this.dirty=qe,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,n){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,n)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,n){let s=this.node.cut(e,t),i=document.createTextNode(s.text);return new Ci(this.parent,s,this.outerDeco,this.innerDeco,i,i,n)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=lt)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Ld extends Wn{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==qe&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class Eb extends Bt{constructor(e,t,n,s,i,o,a,l,c,u){super(e,t,n,s,i,o,a,c,u),this.spec=l}update(e,t,n,s){if(this.dirty==lt)return!1;if(this.spec.update&&(this.node.type==e.type||this.spec.multiType)){let i=this.spec.update(e,t,n);return i&&this.updateInner(e,t,n,s),i}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,n,s)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,n,s){this.spec.setSelection?this.spec.setSelection(e,t,n.root):super.setSelection(e,t,n,s)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function jd(r,e,t){let n=r.firstChild,s=!1;for(let i=0;i<e.length;i++){let o=e[i],a=o.dom;if(a.parentNode==r){for(;a!=n;)n=fc(n),s=!0;n=n.nextSibling}else s=!0,r.insertBefore(a,n);if(o instanceof gr){let l=n?n.previousSibling:r.lastChild;jd(o.contentDOM,o.children,t),n=l?l.nextSibling:r.firstChild}}for(;n;)n=fc(n),s=!0;s&&t.trackWrites==r&&(t.trackWrites=null)}const pn=function(r){r&&(this.nodeName=r)};pn.prototype=Object.create(null);const nr=[new pn];function Go(r,e,t){if(r.length==0)return nr;let n=t?nr[0]:new pn,s=[n];for(let i=0;i<r.length;i++){let o=r[i].type.attrs;if(o){o.nodeName&&s.push(n=new pn(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&s.length==1&&s.push(n=new pn(e.isInline?"span":"div")),a=="class"?n.class=(n.class?n.class+" ":"")+l:a=="style"?n.style=(n.style?n.style+";":"")+l:a!="nodeName"&&(n[a]=l))}}}return s}function Bd(r,e,t,n){if(t==nr&&n==nr)return e;let s=e;for(let i=0;i<n.length;i++){let o=n[i],a=t[i];if(i){let l;a&&a.nodeName==o.nodeName&&s!=r&&(l=s.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(s),a=nr[0]),s=l}Cb(s,a||nr[0],o)}return s}function Cb(r,e,t){for(let n in e)n!="class"&&n!="style"&&n!="nodeName"&&!(n in t)&&r.removeAttribute(n);for(let n in t)n!="class"&&n!="style"&&n!="nodeName"&&t[n]!=e[n]&&r.setAttribute(n,t[n]);if(e.class!=t.class){let n=e.class?e.class.split(" ").filter(Boolean):[],s=t.class?t.class.split(" ").filter(Boolean):[];for(let i=0;i<n.length;i++)s.indexOf(n[i])==-1&&r.classList.remove(n[i]);for(let i=0;i<s.length;i++)n.indexOf(s[i])==-1&&r.classList.add(s[i]);r.classList.length==0&&r.removeAttribute("class")}if(e.style!=t.style){if(e.style){let n=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,s;for(;s=n.exec(e.style);)r.style.removeProperty(s[1])}t.style&&(r.style.cssText+=t.style)}}function zd(r,e,t){return Bd(r,r,nr,Go(e,t,r.nodeType!=1))}function Ms(r,e){if(r.length!=e.length)return!1;for(let t=0;t<r.length;t++)if(!r[t].type.eq(e[t].type))return!1;return!0}function fc(r){let e=r.nextSibling;return r.parentNode.removeChild(r),e}class Ab{constructor(e,t,n){this.lock=t,this.view=n,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=Ob(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let n=e;n<t;n++)this.top.children[n].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,n){let s=0,i=this.stack.length>>1,o=Math.min(i,e.length);for(;s<o&&(s==i-1?this.top:this.stack[s+1<<1]).matchesMark(e[s])&&e[s].type.spec.spanning!==!1;)s++;for(;s<i;)this.destroyRest(),this.top.dirty=qe,this.index=this.stack.pop(),this.top=this.stack.pop(),i--;for(;i<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let c=this.top.children[l];if(c.matchesMark(e[i])&&!this.isLocked(c.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=gr.create(this.top,e[i],t,n);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,i++}}findNodeMatch(e,t,n,s){let i=-1,o;if(s>=this.preMatch.index&&(o=this.preMatch.matches[s-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,n))i=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let c=this.top.children[a];if(c.matchesNode(e,t,n)&&!this.preMatch.matched.has(c)){i=a;break}}return i<0?!1:(this.destroyBetween(this.index,i),this.index++,!0)}updateNodeAt(e,t,n,s,i){let o=this.top.children[s];return o.dirty==lt&&o.dom==o.contentDOM&&(o.dirty=rr),o.update(e,t,n,i)?(this.destroyBetween(this.index,s),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let n=e.pmViewDesc;if(n){for(let s=this.index;s<this.top.children.length;s++)if(this.top.children[s]==n)return s}return-1}e=t}}updateNextNode(e,t,n,s,i,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof Bt){let c=this.preMatch.matched.get(l);if(c!=null&&c!=i)return!1;let u=l.dom,d,h=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=lt&&Ms(t,l.outerDeco));if(!h&&l.update(e,t,n,s))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!h&&(d=this.recreateWrapper(l,e,t,n,s,o)))return this.destroyBetween(this.index,a),this.top.children[this.index]=d,d.contentDOM&&(d.dirty=rr,d.updateChildren(s,o+1),d.dirty=qe),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,n,s,i,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content)||!Ms(n,e.outerDeco)||!s.eq(e.innerDeco))return null;let a=Bt.create(this.top,t,n,s,i,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,n,s,i){let o=Bt.create(this.top,e,t,n,s,i);o.contentDOM&&o.updateChildren(s,i+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,n){let s=this.index<this.top.children.length?this.top.children[this.index]:null;if(s&&s.matchesWidget(e)&&(e==s.widget||!s.widget.type.toDOM.parentNode))this.index++;else{let i=new $d(this.top,e,t,n);this.top.children.splice(this.index++,0,i),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof gr;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof Ci)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((Se||ue)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let n=document.createElement(e);e=="IMG"&&(n.className="ProseMirror-separator",n.alt=""),e=="BR"&&(n.className="ProseMirror-trailingBreak");let s=new Ld(this.top,[],n,null);t!=this.top?t.children.push(s):t.children.splice(this.index++,0,s),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function Ob(r,e){let t=e,n=t.children.length,s=r.childCount,i=new Map,o=[];e:for(;s>0;){let a;for(;;)if(n){let c=t.children[n-1];if(c instanceof gr)t=c,n=c.children.length;else{a=c,n--;break}}else{if(t==e)break e;n=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=r.child(s-1))break;--s,i.set(a,s),o.push(a)}}return{index:s,matched:i,matches:o.reverse()}}function Mb(r,e){return r.type.side-e.type.side}function Ib(r,e,t,n){let s=e.locals(r),i=0;if(s.length==0){for(let c=0;c<r.childCount;c++){let u=r.child(c);n(u,s,e.forChild(i,u),c),i+=u.nodeSize}return}let o=0,a=[],l=null;for(let c=0;;){let u,d;for(;o<s.length&&s[o].to==i;){let g=s[o++];g.widget&&(u?(d||(d=[u])).push(g):u=g)}if(u)if(d){d.sort(Mb);for(let g=0;g<d.length;g++)t(d[g],c,!!l)}else t(u,c,!!l);let h,f;if(l)f=-1,h=l,l=null;else if(c<r.childCount)f=c,h=r.child(c++);else break;for(let g=0;g<a.length;g++)a[g].to<=i&&a.splice(g--,1);for(;o<s.length&&s[o].from<=i&&s[o].to>i;)a.push(s[o++]);let p=i+h.nodeSize;if(h.isText){let g=p;o<s.length&&s[o].from<g&&(g=s[o].from);for(let y=0;y<a.length;y++)a[y].to<g&&(g=a[y].to);g<p&&(l=h.cut(g-i),h=h.cut(0,g-i),p=g,f=-1)}else for(;o<s.length&&s[o].to<p;)o++;let m=h.isInline&&!h.isLeaf?a.filter(g=>!g.inline):a.slice();n(h,m,e.forChild(i,h),f),i=p}}function Rb(r){if(r.nodeName=="UL"||r.nodeName=="OL"){let e=r.style.cssText;r.style.cssText=e+"; list-style: square !important",window.getComputedStyle(r).listStyle,r.style.cssText=e}}function Nb(r,e,t,n){for(let s=0,i=0;s<r.childCount&&i<=n;){let o=r.child(s++),a=i;if(i+=o.nodeSize,!o.isText)continue;let l=o.text;for(;s<r.childCount;){let c=r.child(s++);if(i+=c.nodeSize,!c.isText)break;l+=c.text}if(i>=t){if(i>=n&&l.slice(n-e.length-a,n-a)==e)return n-e.length;let c=a<n?l.lastIndexOf(e,n-a-1):-1;if(c>=0&&c+e.length+a>=t)return a+c;if(t==n&&l.length>=n+e.length-a&&l.slice(n-a,n-a+e.length)==e)return n}}return-1}function Yo(r,e,t,n,s){let i=[];for(let o=0,a=0;o<r.length;o++){let l=r[o],c=a,u=a+=l.size;c>=t||u<=e?i.push(l):(c<e&&i.push(l.slice(0,e-c,n)),s&&(i.push(s),s=void 0),u>t&&i.push(l.slice(t-c,l.size,n)))}return i}function Da(r,e=null){let t=r.domSelectionRange(),n=r.state.doc;if(!t.focusNode)return null;let s=r.docView.nearestDesc(t.focusNode),i=s&&s.size==0,o=r.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=n.resolve(o),l,c;if(Ei(t)){for(l=o;s&&!s.node;)s=s.parent;let d=s.node;if(s&&d.isAtom&&M.isSelectable(d)&&s.parent&&!(d.isInline&&ob(t.focusNode,t.focusOffset,s.dom))){let h=s.posBefore;c=new M(o==h?a:n.resolve(h))}}else{if(t instanceof r.dom.ownerDocument.defaultView.Selection&&t.rangeCount>1){let d=o,h=o;for(let f=0;f<t.rangeCount;f++){let p=t.getRangeAt(f);d=Math.min(d,r.docView.posFromDOM(p.startContainer,p.startOffset,1)),h=Math.max(h,r.docView.posFromDOM(p.endContainer,p.endOffset,-1))}if(d<0)return null;[l,o]=h==r.state.selection.anchor?[h,d]:[d,h],a=n.resolve(o)}else l=r.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(l<0)return null}let u=n.resolve(l);if(!c){let d=e=="pointer"||r.state.selection.head<a.pos&&!i?1:-1;c=$a(r,u,a,d)}return c}function Ud(r){return r.editable?r.hasFocus():Hd(r)&&document.activeElement&&document.activeElement.contains(r.dom)}function yt(r,e=!1){let t=r.state.selection;if(Fd(r,t),!!Ud(r)){if(!e&&r.input.mouseDown&&r.input.mouseDown.allowDefault&&ue){let n=r.domSelectionRange(),s=r.domObserver.currentSelection;if(n.anchorNode&&s.anchorNode&&mr(n.anchorNode,n.anchorOffset,s.anchorNode,s.anchorOffset)){r.input.mouseDown.delayedSelectionSync=!0,r.domObserver.setCurSelection();return}}if(r.domObserver.disconnectSelection(),r.cursorWrapper)Db(r);else{let{anchor:n,head:s}=t,i,o;pc&&!(t instanceof D)&&(t.$from.parent.inlineContent||(i=mc(r,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=mc(r,t.to))),r.docView.setSelection(n,s,r,e),pc&&(i&&gc(i),o&&gc(o)),t.visible?r.dom.classList.remove("ProseMirror-hideselection"):(r.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&Pb(r))}r.domObserver.setCurSelection(),r.domObserver.connectSelection()}}const pc=Se||ue&&Ad<63;function mc(r,e){let{node:t,offset:n}=r.docView.domFromPos(e,0),s=n<t.childNodes.length?t.childNodes[n]:null,i=n?t.childNodes[n-1]:null;if(Se&&s&&s.contentEditable=="false")return no(s);if((!s||s.contentEditable=="false")&&(!i||i.contentEditable=="false")){if(s)return no(s);if(i)return no(i)}}function no(r){return r.contentEditable="true",Se&&r.draggable&&(r.draggable=!1,r.wasDraggable=!0),r}function gc(r){r.contentEditable="false",r.wasDraggable&&(r.draggable=!0,r.wasDraggable=null)}function Pb(r){let e=r.dom.ownerDocument;e.removeEventListener("selectionchange",r.input.hideSelectionGuard);let t=r.domSelectionRange(),n=t.anchorNode,s=t.anchorOffset;e.addEventListener("selectionchange",r.input.hideSelectionGuard=()=>{(t.anchorNode!=n||t.anchorOffset!=s)&&(e.removeEventListener("selectionchange",r.input.hideSelectionGuard),setTimeout(()=>{(!Ud(r)||r.state.selection.visible)&&r.dom.classList.remove("ProseMirror-hideselection")},20))})}function Db(r){let e=r.domSelection();if(!e)return;let t=r.cursorWrapper.dom,n=t.nodeName=="IMG";n?e.collapse(t.parentNode,ge(t)+1):e.collapse(t,0),!n&&!r.state.selection.visible&&Ie&&jt<=11&&(t.disabled=!0,t.disabled=!1)}function Fd(r,e){if(e instanceof M){let t=r.docView.descAt(e.from);t!=r.lastSelectedViewDesc&&(yc(r),t&&t.selectNode(),r.lastSelectedViewDesc=t)}else yc(r)}function yc(r){r.lastSelectedViewDesc&&(r.lastSelectedViewDesc.parent&&r.lastSelectedViewDesc.deselectNode(),r.lastSelectedViewDesc=void 0)}function $a(r,e,t,n){return r.someProp("createSelectionBetween",s=>s(r,e,t))||D.between(e,t,n)}function bc(r){return r.editable&&!r.hasFocus()?!1:Hd(r)}function Hd(r){let e=r.domSelectionRange();if(!e.anchorNode)return!1;try{return r.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(r.editable||r.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function $b(r){let e=r.docView.domFromPos(r.state.selection.anchor,0),t=r.domSelectionRange();return mr(e.node,e.offset,t.anchorNode,t.anchorOffset)}function Qo(r,e){let{$anchor:t,$head:n}=r.selection,s=e>0?t.max(n):t.min(n),i=s.parent.inlineContent?s.depth?r.doc.resolve(e>0?s.after():s.before()):null:s;return i&&z.findFrom(i,e)}function Et(r,e){return r.dispatch(r.state.tr.setSelection(e).scrollIntoView()),!0}function wc(r,e,t){let n=r.state.selection;if(n instanceof D)if(t.indexOf("s")>-1){let{$head:s}=n,i=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter;if(!i||i.isText||!i.isLeaf)return!1;let o=r.state.doc.resolve(s.pos+i.nodeSize*(e<0?-1:1));return Et(r,new D(n.$anchor,o))}else if(n.empty){if(r.endOfTextblock(e>0?"forward":"backward")){let s=Qo(r.state,e);return s&&s instanceof M?Et(r,s):!1}else if(!(Fe&&t.indexOf("m")>-1)){let s=n.$head,i=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter,o;if(!i||i.isText)return!1;let a=e<0?s.pos-i.nodeSize:s.pos;return i.isAtom||(o=r.docView.descAt(a))&&!o.contentDOM?M.isSelectable(i)?Et(r,new M(e<0?r.state.doc.resolve(s.pos-i.nodeSize):s)):qn?Et(r,new D(r.state.doc.resolve(e<0?a:a+i.nodeSize))):!1:!1}}else return!1;else{if(n instanceof M&&n.node.isInline)return Et(r,new D(e>0?n.$to:n.$from));{let s=Qo(r.state,e);return s?Et(r,s):!1}}}function Is(r){return r.nodeType==3?r.nodeValue.length:r.childNodes.length}function mn(r,e){let t=r.pmViewDesc;return t&&t.size==0&&(e<0||r.nextSibling||r.nodeName!="BR")}function Ar(r,e){return e<0?Lb(r):jb(r)}function Lb(r){let e=r.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let s,i,o=!1;for(Ve&&t.nodeType==1&&n<Is(t)&&mn(t.childNodes[n],-1)&&(o=!0);;)if(n>0){if(t.nodeType!=1)break;{let a=t.childNodes[n-1];if(mn(a,-1))s=t,i=--n;else if(a.nodeType==3)t=a,n=t.nodeValue.length;else break}}else{if(Vd(t))break;{let a=t.previousSibling;for(;a&&mn(a,-1);)s=t.parentNode,i=ge(a),a=a.previousSibling;if(a)t=a,n=Is(t);else{if(t=t.parentNode,t==r.dom)break;n=0}}}o?Xo(r,t,n):s&&Xo(r,s,i)}function jb(r){let e=r.domSelectionRange(),t=e.focusNode,n=e.focusOffset;if(!t)return;let s=Is(t),i,o;for(;;)if(n<s){if(t.nodeType!=1)break;let a=t.childNodes[n];if(mn(a,1))i=t,o=++n;else break}else{if(Vd(t))break;{let a=t.nextSibling;for(;a&&mn(a,1);)i=a.parentNode,o=ge(a)+1,a=a.nextSibling;if(a)t=a,n=0,s=Is(t);else{if(t=t.parentNode,t==r.dom)break;n=s=0}}}i&&Xo(r,i,o)}function Vd(r){let e=r.pmViewDesc;return e&&e.node&&e.node.isBlock}function Bb(r,e){for(;r&&e==r.childNodes.length&&!Vn(r);)e=ge(r)+1,r=r.parentNode;for(;r&&e<r.childNodes.length;){let t=r.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;r=t,e=0}}function zb(r,e){for(;r&&!e&&!Vn(r);)e=ge(r),r=r.parentNode;for(;r&&e;){let t=r.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;r=t,e=r.childNodes.length}}function Xo(r,e,t){if(e.nodeType!=3){let i,o;(o=Bb(e,t))?(e=o,t=0):(i=zb(e,t))&&(e=i,t=i.nodeValue.length)}let n=r.domSelection();if(!n)return;if(Ei(n)){let i=document.createRange();i.setEnd(e,t),i.setStart(e,t),n.removeAllRanges(),n.addRange(i)}else n.extend&&n.extend(e,t);r.domObserver.setCurSelection();let{state:s}=r;setTimeout(()=>{r.state==s&&yt(r)},50)}function vc(r,e){let t=r.state.doc.resolve(e);if(!(ue||Od)&&t.parent.inlineContent){let s=r.coordsAtPos(e);if(e>t.start()){let i=r.coordsAtPos(e-1),o=(i.top+i.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(i.left-s.left)>1)return i.left<s.left?"ltr":"rtl"}if(e<t.end()){let i=r.coordsAtPos(e+1),o=(i.top+i.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(i.left-s.left)>1)return i.left>s.left?"ltr":"rtl"}}return getComputedStyle(r.dom).direction=="rtl"?"rtl":"ltr"}function kc(r,e,t){let n=r.state.selection;if(n instanceof D&&!n.empty||t.indexOf("s")>-1||Fe&&t.indexOf("m")>-1)return!1;let{$from:s,$to:i}=n;if(!s.parent.inlineContent||r.endOfTextblock(e<0?"up":"down")){let o=Qo(r.state,e);if(o&&o instanceof M)return Et(r,o)}if(!s.parent.inlineContent){let o=e<0?s:i,a=n instanceof Le?z.near(o,e):z.findFrom(o,e);return a?Et(r,a):!1}return!1}function Sc(r,e){if(!(r.state.selection instanceof D))return!0;let{$head:t,$anchor:n,empty:s}=r.state.selection;if(!t.sameParent(n))return!0;if(!s)return!1;if(r.endOfTextblock(e>0?"forward":"backward"))return!0;let i=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(i&&!i.isText){let o=r.state.tr;return e<0?o.delete(t.pos-i.nodeSize,t.pos):o.delete(t.pos,t.pos+i.nodeSize),r.dispatch(o),!0}return!1}function xc(r,e,t){r.domObserver.stop(),e.contentEditable=t,r.domObserver.start()}function Ub(r){if(!Se||r.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=r.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let n=e.firstChild;xc(r,n,"true"),setTimeout(()=>xc(r,n,"false"),20)}return!1}function Fb(r){let e="";return r.ctrlKey&&(e+="c"),r.metaKey&&(e+="m"),r.altKey&&(e+="a"),r.shiftKey&&(e+="s"),e}function Hb(r,e){let t=e.keyCode,n=Fb(e);if(t==8||Fe&&t==72&&n=="c")return Sc(r,-1)||Ar(r,-1);if(t==46&&!e.shiftKey||Fe&&t==68&&n=="c")return Sc(r,1)||Ar(r,1);if(t==13||t==27)return!0;if(t==37||Fe&&t==66&&n=="c"){let s=t==37?vc(r,r.state.selection.from)=="ltr"?-1:1:-1;return wc(r,s,n)||Ar(r,s)}else if(t==39||Fe&&t==70&&n=="c"){let s=t==39?vc(r,r.state.selection.from)=="ltr"?1:-1:1;return wc(r,s,n)||Ar(r,s)}else{if(t==38||Fe&&t==80&&n=="c")return kc(r,-1,n)||Ar(r,-1);if(t==40||Fe&&t==78&&n=="c")return Ub(r)||kc(r,1,n)||Ar(r,1);if(n==(Fe?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function La(r,e){r.someProp("transformCopied",f=>{e=f(e,r)});let t=[],{content:n,openStart:s,openEnd:i}=e;for(;s>1&&i>1&&n.childCount==1&&n.firstChild.childCount==1;){s--,i--;let f=n.firstChild;t.push(f.type.name,f.attrs!=f.type.defaultAttrs?f.attrs:null),n=f.content}let o=r.someProp("clipboardSerializer")||vr.fromSchema(r.state.schema),a=Yd(),l=a.createElement("div");l.appendChild(o.serializeFragment(n,{document:a}));let c=l.firstChild,u,d=0;for(;c&&c.nodeType==1&&(u=Gd[c.nodeName.toLowerCase()]);){for(let f=u.length-1;f>=0;f--){let p=a.createElement(u[f]);for(;l.firstChild;)p.appendChild(l.firstChild);l.appendChild(p),d++}c=l.firstChild}c&&c.nodeType==1&&c.setAttribute("data-pm-slice",`${s} ${i}${d?` -${d}`:""} ${JSON.stringify(t)}`);let h=r.someProp("clipboardTextSerializer",f=>f(e,r))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:h,slice:e}}function qd(r,e,t,n,s){let i=s.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=!!e&&(n||i||!t);if(l){if(r.someProp("transformPastedText",h=>{e=h(e,i||n,r)}),i)return a=new C(k.from(r.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0),r.someProp("transformPasted",h=>{a=h(a,r,!0)}),a;let d=r.someProp("clipboardTextParser",h=>h(e,s,n,r));if(d)a=d;else{let h=s.marks(),{schema:f}=r.state,p=vr.fromSchema(f);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(m=>{let g=o.appendChild(document.createElement("p"));m&&g.appendChild(p.serializeNode(f.text(m,h)))})}}else r.someProp("transformPastedHTML",d=>{t=d(t,r)}),o=Kb(t),qn&&Jb(o);let c=o&&o.querySelector("[data-pm-slice]"),u=c&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let d=+u[3];d>0;d--){let h=o.firstChild;for(;h&&h.nodeType!=1;)h=h.nextSibling;if(!h)break;o=h}if(a||(a=(r.someProp("clipboardParser")||r.someProp("domParser")||Lt.fromSchema(r.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:s,ruleFromNode(h){return h.nodeName=="BR"&&!h.nextSibling&&h.parentNode&&!Vb.test(h.parentNode.nodeName)?{ignore:!0}:null}})),u)a=Gb(Tc(a,+u[1],+u[2]),u[4]);else if(a=C.maxOpen(qb(a.content,s),!0),a.openStart||a.openEnd){let d=0,h=0;for(let f=a.content.firstChild;d<a.openStart&&!f.type.spec.isolating;d++,f=f.firstChild);for(let f=a.content.lastChild;h<a.openEnd&&!f.type.spec.isolating;h++,f=f.lastChild);a=Tc(a,d,h)}return r.someProp("transformPasted",d=>{a=d(a,r,l)}),a}const Vb=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function qb(r,e){if(r.childCount<2)return r;for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.index(t)),i,o=[];if(r.forEach(a=>{if(!o)return;let l=s.findWrapping(a.type),c;if(!l)return o=null;if(c=o.length&&i.length&&Kd(l,i,a,o[o.length-1],0))o[o.length-1]=c;else{o.length&&(o[o.length-1]=Jd(o[o.length-1],i.length));let u=Wd(a,l);o.push(u),s=s.matchType(u.type),i=l}}),o)return k.from(o)}return r}function Wd(r,e,t=0){for(let n=e.length-1;n>=t;n--)r=e[n].create(null,k.from(r));return r}function Kd(r,e,t,n,s){if(s<r.length&&s<e.length&&r[s]==e[s]){let i=Kd(r,e,t,n.lastChild,s+1);if(i)return n.copy(n.content.replaceChild(n.childCount-1,i));if(n.contentMatchAt(n.childCount).matchType(s==r.length-1?t.type:r[s+1]))return n.copy(n.content.append(k.from(Wd(t,r,s+1))))}}function Jd(r,e){if(e==0)return r;let t=r.content.replaceChild(r.childCount-1,Jd(r.lastChild,e-1)),n=r.contentMatchAt(r.childCount).fillBefore(k.empty,!0);return r.copy(t.append(n))}function Zo(r,e,t,n,s,i){let o=e<0?r.firstChild:r.lastChild,a=o.content;return r.childCount>1&&(i=0),s<n-1&&(a=Zo(a,e,t,n,s+1,i)),s>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,i<=s).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(k.empty,!0))),r.replaceChild(e<0?0:r.childCount-1,o.copy(a))}function Tc(r,e,t){return e<r.openStart&&(r=new C(Zo(r.content,-1,e,r.openStart,0,r.openEnd),e,r.openEnd)),t<r.openEnd&&(r=new C(Zo(r.content,1,t,r.openEnd,0,0),r.openStart,t)),r}const Gd={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let _c=null;function Yd(){return _c||(_c=document.implementation.createHTMLDocument("title"))}let so=null;function Wb(r){let e=window.trustedTypes;return e?(so||(so=e.defaultPolicy||e.createPolicy("ProseMirrorClipboard",{createHTML:t=>t})),so.createHTML(r)):r}function Kb(r){let e=/^(\s*<meta [^>]*>)*/.exec(r);e&&(r=r.slice(e[0].length));let t=Yd().createElement("div"),n=/<([a-z][^>\s]+)/i.exec(r),s;if((s=n&&Gd[n[1].toLowerCase()])&&(r=s.map(i=>"<"+i+">").join("")+r+s.map(i=>"</"+i+">").reverse().join("")),t.innerHTML=Wb(r),s)for(let i=0;i<s.length;i++)t=t.querySelector(s[i])||t;return t}function Jb(r){let e=r.querySelectorAll(ue?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let n=e[t];n.childNodes.length==1&&n.textContent==""&&n.parentNode&&n.parentNode.replaceChild(r.ownerDocument.createTextNode(" "),n)}}function Gb(r,e){if(!r.size)return r;let t=r.content.firstChild.type.schema,n;try{n=JSON.parse(e)}catch{return r}let{content:s,openStart:i,openEnd:o}=r;for(let a=n.length-2;a>=0;a-=2){let l=t.nodes[n[a]];if(!l||l.hasRequiredAttrs())break;s=k.from(l.create(n[a+1],s)),i++,o++}return new C(s,i,o)}const Ce={},Ae={},Yb={touchstart:!0,touchmove:!0};class Qb{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:"",button:0},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastChromeDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function Xb(r){for(let e in Ce){let t=Ce[e];r.dom.addEventListener(e,r.input.eventHandlers[e]=n=>{ew(r,n)&&!ja(r,n)&&(r.editable||!(n.type in Ae))&&t(r,n)},Yb[e]?{passive:!0}:void 0)}Se&&r.dom.addEventListener("input",()=>null),ea(r)}function Pt(r,e){r.input.lastSelectionOrigin=e,r.input.lastSelectionTime=Date.now()}function Zb(r){r.domObserver.stop();for(let e in r.input.eventHandlers)r.dom.removeEventListener(e,r.input.eventHandlers[e]);clearTimeout(r.input.composingTimeout),clearTimeout(r.input.lastIOSEnterFallbackTimeout)}function ea(r){r.someProp("handleDOMEvents",e=>{for(let t in e)r.input.eventHandlers[t]||r.dom.addEventListener(t,r.input.eventHandlers[t]=n=>ja(r,n))})}function ja(r,e){return r.someProp("handleDOMEvents",t=>{let n=t[e.type];return n?n(r,e)||e.defaultPrevented:!1})}function ew(r,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=r.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function tw(r,e){!ja(r,e)&&Ce[e.type]&&(r.editable||!(e.type in Ae))&&Ce[e.type](r,e)}Ae.keydown=(r,e)=>{let t=e;if(r.input.shiftKey=t.keyCode==16||t.shiftKey,!Xd(r,t)&&(r.input.lastKeyCode=t.keyCode,r.input.lastKeyCodeTime=Date.now(),!(mt&&ue&&t.keyCode==13)))if(t.keyCode!=229&&r.domObserver.forceFlush(),qr&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let n=Date.now();r.input.lastIOSEnter=n,r.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{r.input.lastIOSEnter==n&&(r.someProp("handleKeyDown",s=>s(r,er(13,"Enter"))),r.input.lastIOSEnter=0)},200)}else r.someProp("handleKeyDown",n=>n(r,t))||Hb(r,t)?t.preventDefault():Pt(r,"key")};Ae.keyup=(r,e)=>{e.keyCode==16&&(r.input.shiftKey=!1)};Ae.keypress=(r,e)=>{let t=e;if(Xd(r,t)||!t.charCode||t.ctrlKey&&!t.altKey||Fe&&t.metaKey)return;if(r.someProp("handleKeyPress",s=>s(r,t))){t.preventDefault();return}let n=r.state.selection;if(!(n instanceof D)||!n.$from.sameParent(n.$to)){let s=String.fromCharCode(t.charCode),i=()=>r.state.tr.insertText(s).scrollIntoView();!/[\r\n]/.test(s)&&!r.someProp("handleTextInput",o=>o(r,n.$from.pos,n.$to.pos,s,i))&&r.dispatch(i()),t.preventDefault()}};function Ai(r){return{left:r.clientX,top:r.clientY}}function rw(r,e){let t=e.x-r.clientX,n=e.y-r.clientY;return t*t+n*n<100}function Ba(r,e,t,n,s){if(n==-1)return!1;let i=r.state.doc.resolve(n);for(let o=i.depth+1;o>0;o--)if(r.someProp(e,a=>o>i.depth?a(r,t,i.nodeAfter,i.before(o),s,!0):a(r,t,i.node(o),i.before(o),s,!1)))return!0;return!1}function zr(r,e,t){if(r.focused||r.focus(),r.state.selection.eq(e))return;let n=r.state.tr.setSelection(e);n.setMeta("pointer",!0),r.dispatch(n)}function nw(r,e){if(e==-1)return!1;let t=r.state.doc.resolve(e),n=t.nodeAfter;return n&&n.isAtom&&M.isSelectable(n)?(zr(r,new M(t)),!0):!1}function sw(r,e){if(e==-1)return!1;let t=r.state.selection,n,s;t instanceof M&&(n=t.node);let i=r.state.doc.resolve(e);for(let o=i.depth+1;o>0;o--){let a=o>i.depth?i.nodeAfter:i.node(o);if(M.isSelectable(a)){n&&t.$from.depth>0&&o>=t.$from.depth&&i.before(t.$from.depth+1)==t.$from.pos?s=i.before(t.$from.depth):s=i.before(o);break}}return s!=null?(zr(r,M.create(r.state.doc,s)),!0):!1}function iw(r,e,t,n,s){return Ba(r,"handleClickOn",e,t,n)||r.someProp("handleClick",i=>i(r,e,n))||(s?sw(r,t):nw(r,t))}function ow(r,e,t,n){return Ba(r,"handleDoubleClickOn",e,t,n)||r.someProp("handleDoubleClick",s=>s(r,e,n))}function aw(r,e,t,n){return Ba(r,"handleTripleClickOn",e,t,n)||r.someProp("handleTripleClick",s=>s(r,e,n))||lw(r,t,n)}function lw(r,e,t){if(t.button!=0)return!1;let n=r.state.doc;if(e==-1)return n.inlineContent?(zr(r,D.create(n,0,n.content.size)),!0):!1;let s=n.resolve(e);for(let i=s.depth+1;i>0;i--){let o=i>s.depth?s.nodeAfter:s.node(i),a=s.before(i);if(o.inlineContent)zr(r,D.create(n,a+1,a+1+o.content.size));else if(M.isSelectable(o))zr(r,M.create(n,a));else continue;return!0}}function za(r){return Rs(r)}const Qd=Fe?"metaKey":"ctrlKey";Ce.mousedown=(r,e)=>{let t=e;r.input.shiftKey=t.shiftKey;let n=za(r),s=Date.now(),i="singleClick";s-r.input.lastClick.time<500&&rw(t,r.input.lastClick)&&!t[Qd]&&r.input.lastClick.button==t.button&&(r.input.lastClick.type=="singleClick"?i="doubleClick":r.input.lastClick.type=="doubleClick"&&(i="tripleClick")),r.input.lastClick={time:s,x:t.clientX,y:t.clientY,type:i,button:t.button};let o=r.posAtCoords(Ai(t));o&&(i=="singleClick"?(r.input.mouseDown&&r.input.mouseDown.done(),r.input.mouseDown=new cw(r,o,t,!!n)):(i=="doubleClick"?ow:aw)(r,o.pos,o.inside,t)?t.preventDefault():Pt(r,"pointer"))};class cw{constructor(e,t,n,s){this.view=e,this.pos=t,this.event=n,this.flushed=s,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!n[Qd],this.allowDefault=n.shiftKey;let i,o;if(t.inside>-1)i=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);i=u.parent,o=u.depth?u.before():0}const a=s?null:n.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.nodeDOM.nodeType==1?l.nodeDOM:null;let{selection:c}=e.state;(n.button==0&&i.type.spec.draggable&&i.type.spec.selectable!==!1||c instanceof M&&c.from<=o&&c.to>o)&&(this.mightDrag={node:i,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Ve&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),Pt(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>yt(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(Ai(e))),this.updateAllowDefault(e),this.allowDefault||!t?Pt(this.view,"pointer"):iw(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||Se&&this.mightDrag&&!this.mightDrag.node.isAtom||ue&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(zr(this.view,z.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):Pt(this.view,"pointer")}move(e){this.updateAllowDefault(e),Pt(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Ce.touchstart=r=>{r.input.lastTouch=Date.now(),za(r),Pt(r,"pointer")};Ce.touchmove=r=>{r.input.lastTouch=Date.now(),Pt(r,"pointer")};Ce.contextmenu=r=>za(r);function Xd(r,e){return r.composing?!0:Se&&Math.abs(e.timeStamp-r.input.compositionEndedAt)<500?(r.input.compositionEndedAt=-2e8,!0):!1}const uw=mt?5e3:-1;Ae.compositionstart=Ae.compositionupdate=r=>{if(!r.composing){r.domObserver.flush();let{state:e}=r,t=e.selection.$to;if(e.selection instanceof D&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(n=>n.type.spec.inclusive===!1)||ue&&Od&&dw(r)))r.markCursor=r.state.storedMarks||t.marks(),Rs(r,!0),r.markCursor=null;else if(Rs(r,!e.selection.empty),Ve&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let n=r.domSelectionRange();for(let s=n.focusNode,i=n.focusOffset;s&&s.nodeType==1&&i!=0;){let o=i<0?s.lastChild:s.childNodes[i-1];if(!o)break;if(o.nodeType==3){let a=r.domSelection();a&&a.collapse(o,o.nodeValue.length);break}else s=o,i=-1}}r.input.composing=!0}Zd(r,uw)};function dw(r){let{focusNode:e,focusOffset:t}=r.domSelectionRange();if(!e||e.nodeType!=1||t>=e.childNodes.length)return!1;let n=e.childNodes[t];return n.nodeType==1&&n.contentEditable=="false"}Ae.compositionend=(r,e)=>{r.composing&&(r.input.composing=!1,r.input.compositionEndedAt=e.timeStamp,r.input.compositionPendingChanges=r.domObserver.pendingRecords().length?r.input.compositionID:0,r.input.compositionNode=null,r.input.compositionPendingChanges&&Promise.resolve().then(()=>r.domObserver.flush()),r.input.compositionID++,Zd(r,20))};function Zd(r,e){clearTimeout(r.input.composingTimeout),e>-1&&(r.input.composingTimeout=setTimeout(()=>Rs(r),e))}function eh(r){for(r.composing&&(r.input.composing=!1,r.input.compositionEndedAt=fw());r.input.compositionNodes.length>0;)r.input.compositionNodes.pop().markParentsDirty()}function hw(r){let e=r.domSelectionRange();if(!e.focusNode)return null;let t=sb(e.focusNode,e.focusOffset),n=ib(e.focusNode,e.focusOffset);if(t&&n&&t!=n){let s=n.pmViewDesc,i=r.domObserver.lastChangedTextNode;if(t==i||n==i)return i;if(!s||!s.isText(n.nodeValue))return n;if(r.input.compositionNode==n){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return n}}return t||n}function fw(){let r=document.createEvent("Event");return r.initEvent("event",!0,!0),r.timeStamp}function Rs(r,e=!1){if(!(mt&&r.domObserver.flushingSoon>=0)){if(r.domObserver.forceFlush(),eh(r),e||r.docView&&r.docView.dirty){let t=Da(r),n=r.state.selection;return t&&!t.eq(n)?r.dispatch(r.state.tr.setSelection(t)):(r.markCursor||e)&&!n.$from.node(n.$from.sharedDepth(n.to)).inlineContent?r.dispatch(r.state.tr.deleteSelection()):r.updateState(r.state),!0}return!1}}function pw(r,e){if(!r.dom.parentNode)return;let t=r.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let n=getSelection(),s=document.createRange();s.selectNodeContents(e),r.dom.blur(),n.removeAllRanges(),n.addRange(s),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),r.focus()},50)}const Pn=Ie&&jt<15||qr&&cb<604;Ce.copy=Ae.cut=(r,e)=>{let t=e,n=r.state.selection,s=t.type=="cut";if(n.empty)return;let i=Pn?null:t.clipboardData,o=n.content(),{dom:a,text:l}=La(r,o);i?(t.preventDefault(),i.clearData(),i.setData("text/html",a.innerHTML),i.setData("text/plain",l)):pw(r,a),s&&r.dispatch(r.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function mw(r){return r.openStart==0&&r.openEnd==0&&r.content.childCount==1?r.content.firstChild:null}function gw(r,e){if(!r.dom.parentNode)return;let t=r.input.shiftKey||r.state.selection.$from.parent.type.spec.code,n=r.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(n.contentEditable="true"),n.style.cssText="position: fixed; left: -10000px; top: 10px",n.focus();let s=r.input.shiftKey&&r.input.lastKeyCode!=45;setTimeout(()=>{r.focus(),n.parentNode&&n.parentNode.removeChild(n),t?Dn(r,n.value,null,s,e):Dn(r,n.textContent,n.innerHTML,s,e)},50)}function Dn(r,e,t,n,s){let i=qd(r,e,t,n,r.state.selection.$from);if(r.someProp("handlePaste",l=>l(r,s,i||C.empty)))return!0;if(!i)return!1;let o=mw(i),a=o?r.state.tr.replaceSelectionWith(o,n):r.state.tr.replaceSelection(i);return r.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function th(r){let e=r.getData("text/plain")||r.getData("Text");if(e)return e;let t=r.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Ae.paste=(r,e)=>{let t=e;if(r.composing&&!mt)return;let n=Pn?null:t.clipboardData,s=r.input.shiftKey&&r.input.lastKeyCode!=45;n&&Dn(r,th(n),n.getData("text/html"),s,t)?t.preventDefault():gw(r,t)};class rh{constructor(e,t,n){this.slice=e,this.move=t,this.node=n}}const yw=Fe?"altKey":"ctrlKey";function nh(r,e){let t=r.someProp("dragCopies",n=>!n(e));return t??!e[yw]}Ce.dragstart=(r,e)=>{let t=e,n=r.input.mouseDown;if(n&&n.done(),!t.dataTransfer)return;let s=r.state.selection,i=s.empty?null:r.posAtCoords(Ai(t)),o;if(!(i&&i.pos>=s.from&&i.pos<=(s instanceof M?s.to-1:s.to))){if(n&&n.mightDrag)o=M.create(r.state.doc,n.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let d=r.docView.nearestDesc(t.target,!0);d&&d.node.type.spec.draggable&&d!=r.docView&&(o=M.create(r.state.doc,d.posBefore))}}let a=(o||r.state.selection).content(),{dom:l,text:c,slice:u}=La(r,a);(!t.dataTransfer.files.length||!ue||Ad>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(Pn?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",Pn||t.dataTransfer.setData("text/plain",c),r.dragging=new rh(u,nh(r,t),o)};Ce.dragend=r=>{let e=r.dragging;window.setTimeout(()=>{r.dragging==e&&(r.dragging=null)},50)};Ae.dragover=Ae.dragenter=(r,e)=>e.preventDefault();Ae.drop=(r,e)=>{try{bw(r,e,r.dragging)}finally{r.dragging=null}};function bw(r,e,t){if(!e.dataTransfer)return;let n=r.posAtCoords(Ai(e));if(!n)return;let s=r.state.doc.resolve(n.pos),i=t&&t.slice;i?r.someProp("transformPasted",f=>{i=f(i,r,!1)}):i=qd(r,th(e.dataTransfer),Pn?null:e.dataTransfer.getData("text/html"),!1,s);let o=!!(t&&nh(r,e));if(r.someProp("handleDrop",f=>f(r,e,i||C.empty,o))){e.preventDefault();return}if(!i)return;e.preventDefault();let a=i?ad(r.state.doc,s.pos,i):s.pos;a==null&&(a=s.pos);let l=r.state.tr;if(o){let{node:f}=t;f?f.replace(l):l.deleteSelection()}let c=l.mapping.map(a),u=i.openStart==0&&i.openEnd==0&&i.content.childCount==1,d=l.doc;if(u?l.replaceRangeWith(c,c,i.content.firstChild):l.replaceRange(c,c,i),l.doc.eq(d))return;let h=l.doc.resolve(c);if(u&&M.isSelectable(i.content.firstChild)&&h.nodeAfter&&h.nodeAfter.sameMarkup(i.content.firstChild))l.setSelection(new M(h));else{let f=l.mapping.map(a);l.mapping.maps[l.mapping.maps.length-1].forEach((p,m,g,y)=>f=y),l.setSelection($a(r,h,l.doc.resolve(f)))}r.focus(),r.dispatch(l.setMeta("uiEvent","drop"))}Ce.focus=r=>{r.input.lastFocus=Date.now(),r.focused||(r.domObserver.stop(),r.dom.classList.add("ProseMirror-focused"),r.domObserver.start(),r.focused=!0,setTimeout(()=>{r.docView&&r.hasFocus()&&!r.domObserver.currentSelection.eq(r.domSelectionRange())&&yt(r)},20))};Ce.blur=(r,e)=>{let t=e;r.focused&&(r.domObserver.stop(),r.dom.classList.remove("ProseMirror-focused"),r.domObserver.start(),t.relatedTarget&&r.dom.contains(t.relatedTarget)&&r.domObserver.currentSelection.clear(),r.focused=!1)};Ce.beforeinput=(r,e)=>{if(ue&&mt&&e.inputType=="deleteContentBackward"){r.domObserver.flushSoon();let{domChangeCount:n}=r.input;setTimeout(()=>{if(r.input.domChangeCount!=n||(r.dom.blur(),r.focus(),r.someProp("handleKeyDown",i=>i(r,er(8,"Backspace")))))return;let{$cursor:s}=r.state.selection;s&&s.pos>0&&r.dispatch(r.state.tr.delete(s.pos-1,s.pos).scrollIntoView())},50)}};for(let r in Ae)Ce[r]=Ae[r];function $n(r,e){if(r==e)return!0;for(let t in r)if(r[t]!==e[t])return!1;for(let t in e)if(!(t in r))return!1;return!0}class Ns{constructor(e,t){this.toDOM=e,this.spec=t||ur,this.side=this.spec.side||0}map(e,t,n,s){let{pos:i,deleted:o}=e.mapResult(t.from+s,this.side<0?-1:1);return o?null:new ve(i-n,i-n,this)}valid(){return!0}eq(e){return this==e||e instanceof Ns&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&$n(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class zt{constructor(e,t){this.attrs=e,this.spec=t||ur}map(e,t,n,s){let i=e.map(t.from+s,this.spec.inclusiveStart?-1:1)-n,o=e.map(t.to+s,this.spec.inclusiveEnd?1:-1)-n;return i>=o?null:new ve(i,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof zt&&$n(this.attrs,e.attrs)&&$n(this.spec,e.spec)}static is(e){return e.type instanceof zt}destroy(){}}class Ua{constructor(e,t){this.attrs=e,this.spec=t||ur}map(e,t,n,s){let i=e.mapResult(t.from+s,1);if(i.deleted)return null;let o=e.mapResult(t.to+s,-1);return o.deleted||o.pos<=i.pos?null:new ve(i.pos-n,o.pos-n,this)}valid(e,t){let{index:n,offset:s}=e.content.findIndex(t.from),i;return s==t.from&&!(i=e.child(n)).isText&&s+i.nodeSize==t.to}eq(e){return this==e||e instanceof Ua&&$n(this.attrs,e.attrs)&&$n(this.spec,e.spec)}destroy(){}}class ve{constructor(e,t,n){this.from=e,this.to=t,this.type=n}copy(e,t){return new ve(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,n){return this.type.map(e,this,t,n)}static widget(e,t,n){return new ve(e,e,new Ns(t,n))}static inline(e,t,n,s){return new ve(e,t,new zt(n,s))}static node(e,t,n,s){return new ve(e,t,new Ua(n,s))}get spec(){return this.type.spec}get inline(){return this.type instanceof zt}get widget(){return this.type instanceof Ns}}const Nr=[],ur={};class J{constructor(e,t){this.local=e.length?e:Nr,this.children=t.length?t:Nr}static create(e,t){return t.length?Ps(t,e,0,ur):we}find(e,t,n){let s=[];return this.findInner(e??0,t??1e9,s,0,n),s}findInner(e,t,n,s,i){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!i||i(a.spec))&&n.push(a.copy(a.from+s,a.to+s))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,n,s+a,i)}}map(e,t,n){return this==we||e.maps.length==0?this:this.mapInner(e,t,0,0,n||ur)}mapInner(e,t,n,s,i){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,n,s);l&&l.type.valid(t,l)?(o||(o=[])).push(l):i.onRemove&&i.onRemove(this.local[a].spec)}return this.children.length?ww(this.children,o||[],e,t,n,s,i):o?new J(o.sort(dr),Nr):we}add(e,t){return t.length?this==we?J.create(e,t):this.addInner(e,t,0):this}addInner(e,t,n){let s,i=0;e.forEach((a,l)=>{let c=l+n,u;if(u=ih(t,a,c)){for(s||(s=this.children.slice());i<s.length&&s[i]<l;)i+=3;s[i]==l?s[i+2]=s[i+2].addInner(a,u,c+1):s.splice(i,0,l,l+a.nodeSize,Ps(u,a,c+1,ur)),i+=3}});let o=sh(i?oh(t):t,-n);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new J(o.length?this.local.concat(o).sort(dr):this.local,s||this.children)}remove(e){return e.length==0||this==we?this:this.removeInner(e,0)}removeInner(e,t){let n=this.children,s=this.local;for(let i=0;i<n.length;i+=3){let o,a=n[i]+t,l=n[i+1]+t;for(let u=0,d;u<e.length;u++)(d=e[u])&&d.from>a&&d.to<l&&(e[u]=null,(o||(o=[])).push(d));if(!o)continue;n==this.children&&(n=this.children.slice());let c=n[i+2].removeInner(o,a+1);c!=we?n[i+2]=c:(n.splice(i,3),i-=3)}if(s.length){for(let i=0,o;i<e.length;i++)if(o=e[i])for(let a=0;a<s.length;a++)s[a].eq(o,t)&&(s==this.local&&(s=this.local.slice()),s.splice(a--,1))}return n==this.children&&s==this.local?this:s.length||n.length?new J(s,n):we}forChild(e,t){if(this==we)return this;if(t.isLeaf)return J.empty;let n,s;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(n=this.children[a+2]);break}let i=e+1,o=i+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>i&&l.type instanceof zt){let c=Math.max(i,l.from)-i,u=Math.min(o,l.to)-i;c<u&&(s||(s=[])).push(l.copy(c,u))}}if(s){let a=new J(s.sort(dr),Nr);return n?new Mt([a,n]):a}return n||we}eq(e){if(this==e)return!0;if(!(e instanceof J)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return Fa(this.localsInner(e))}localsInner(e){if(this==we)return Nr;if(e.inlineContent||!this.local.some(zt.is))return this.local;let t=[];for(let n=0;n<this.local.length;n++)this.local[n].type instanceof zt||t.push(this.local[n]);return t}forEachSet(e){e(this)}}J.empty=new J([],[]);J.removeOverlap=Fa;const we=J.empty;class Mt{constructor(e){this.members=e}map(e,t){const n=this.members.map(s=>s.map(e,t,ur));return Mt.from(n)}forChild(e,t){if(t.isLeaf)return J.empty;let n=[];for(let s=0;s<this.members.length;s++){let i=this.members[s].forChild(e,t);i!=we&&(i instanceof Mt?n=n.concat(i.members):n.push(i))}return Mt.from(n)}eq(e){if(!(e instanceof Mt)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,n=!0;for(let s=0;s<this.members.length;s++){let i=this.members[s].localsInner(e);if(i.length)if(!t)t=i;else{n&&(t=t.slice(),n=!1);for(let o=0;o<i.length;o++)t.push(i[o])}}return t?Fa(n?t:t.sort(dr)):Nr}static from(e){switch(e.length){case 0:return we;case 1:return e[0];default:return new Mt(e.every(t=>t instanceof J)?e:e.reduce((t,n)=>t.concat(n instanceof J?n:n.members),[]))}}forEachSet(e){for(let t=0;t<this.members.length;t++)this.members[t].forEachSet(e)}}function ww(r,e,t,n,s,i,o){let a=r.slice();for(let c=0,u=i;c<t.maps.length;c++){let d=0;t.maps[c].forEach((h,f,p,m)=>{let g=m-p-(f-h);for(let y=0;y<a.length;y+=3){let w=a[y+1];if(w<0||h>w+u-d)continue;let v=a[y]+u-d;f>=v?a[y+1]=h<=v?-2:-1:h>=u&&g&&(a[y]+=g,a[y+1]+=g)}d+=g}),u=t.maps[c].map(u,-1)}let l=!1;for(let c=0;c<a.length;c+=3)if(a[c+1]<0){if(a[c+1]==-2){l=!0,a[c+1]=-1;continue}let u=t.map(r[c]+i),d=u-s;if(d<0||d>=n.content.size){l=!0;continue}let h=t.map(r[c+1]+i,-1),f=h-s,{index:p,offset:m}=n.content.findIndex(d),g=n.maybeChild(p);if(g&&m==d&&m+g.nodeSize==f){let y=a[c+2].mapInner(t,g,u+1,r[c]+i+1,o);y!=we?(a[c]=d,a[c+1]=f,a[c+2]=y):(a[c+1]=-2,l=!0)}else l=!0}if(l){let c=vw(a,r,e,t,s,i,o),u=Ps(c,n,0,o);e=u.local;for(let d=0;d<a.length;d+=3)a[d+1]<0&&(a.splice(d,3),d-=3);for(let d=0,h=0;d<u.children.length;d+=3){let f=u.children[d];for(;h<a.length&&a[h]<f;)h+=3;a.splice(h,0,u.children[d],u.children[d+1],u.children[d+2])}}return new J(e.sort(dr),a)}function sh(r,e){if(!e||!r.length)return r;let t=[];for(let n=0;n<r.length;n++){let s=r[n];t.push(new ve(s.from+e,s.to+e,s.type))}return t}function vw(r,e,t,n,s,i,o){function a(l,c){for(let u=0;u<l.local.length;u++){let d=l.local[u].map(n,s,c);d?t.push(d):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+c+1)}for(let l=0;l<r.length;l+=3)r[l+1]==-1&&a(r[l+2],e[l]+i+1);return t}function ih(r,e,t){if(e.isLeaf)return null;let n=t+e.nodeSize,s=null;for(let i=0,o;i<r.length;i++)(o=r[i])&&o.from>t&&o.to<n&&((s||(s=[])).push(o),r[i]=null);return s}function oh(r){let e=[];for(let t=0;t<r.length;t++)r[t]!=null&&e.push(r[t]);return e}function Ps(r,e,t,n){let s=[],i=!1;e.forEach((a,l)=>{let c=ih(r,a,l+t);if(c){i=!0;let u=Ps(c,a,t+l+1,n);u!=we&&s.push(l,l+a.nodeSize,u)}});let o=sh(i?oh(r):r,-t).sort(dr);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(n.onRemove&&n.onRemove(o[a].spec),o.splice(a--,1));return o.length||s.length?new J(o,s):we}function dr(r,e){return r.from-e.from||r.to-e.to}function Fa(r){let e=r;for(let t=0;t<e.length-1;t++){let n=e[t];if(n.from!=n.to)for(let s=t+1;s<e.length;s++){let i=e[s];if(i.from==n.from){i.to!=n.to&&(e==r&&(e=r.slice()),e[s]=i.copy(i.from,n.to),Ec(e,s+1,i.copy(n.to,i.to)));continue}else{i.from<n.to&&(e==r&&(e=r.slice()),e[t]=n.copy(n.from,i.from),Ec(e,s,n.copy(i.from,n.to)));break}}}return e}function Ec(r,e,t){for(;e<r.length&&dr(t,r[e])>0;)e++;r.splice(e,0,t)}function io(r){let e=[];return r.someProp("decorations",t=>{let n=t(r.state);n&&n!=we&&e.push(n)}),r.cursorWrapper&&e.push(J.create(r.state.doc,[r.cursorWrapper.deco])),Mt.from(e)}const kw={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},Sw=Ie&&jt<=11;class xw{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class Tw{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new xw,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(n=>{for(let s=0;s<n.length;s++)this.queue.push(n[s]);Ie&&jt<=11&&n.some(s=>s.type=="childList"&&s.removedNodes.length||s.type=="characterData"&&s.oldValue.length>s.target.nodeValue.length)?this.flushSoon():this.flush()}),Sw&&(this.onCharData=n=>{this.queue.push({target:n.target,type:"characterData",oldValue:n.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,kw)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(bc(this.view)){if(this.suppressingSelectionUpdates)return yt(this.view);if(Ie&&jt<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&mr(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,n;for(let i=e.focusNode;i;i=Vr(i))t.add(i);for(let i=e.anchorNode;i;i=Vr(i))if(t.has(i)){n=i;break}let s=n&&this.view.docView.nearestDesc(n);if(s&&s.ignoreMutation({type:"selection",target:n.nodeType==3?n.parentNode:n}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let n=e.domSelectionRange(),s=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(n)&&bc(e)&&!this.ignoreSelectionChange(n),i=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let d=this.registerMutation(t[u],l);d&&(i=i<0?d.from:Math.min(d.from,i),o=o<0?d.to:Math.max(d.to,o),d.typeOver&&(a=!0))}if(Ve&&l.length){let u=l.filter(d=>d.nodeName=="BR");if(u.length==2){let[d,h]=u;d.parentNode&&d.parentNode.parentNode==h.parentNode?h.remove():d.remove()}else{let{focusNode:d}=this.currentSelection;for(let h of u){let f=h.parentNode;f&&f.nodeName=="LI"&&(!d||Cw(e,d)!=f)&&h.remove()}}}else if((ue||Se)&&l.some(u=>u.nodeName=="BR")&&(e.input.lastKeyCode==8||e.input.lastKeyCode==46)){for(let u of l)if(u.nodeName=="BR"&&u.parentNode){let d=u.nextSibling;d&&d.nodeType==1&&d.contentEditable=="false"&&u.parentNode.removeChild(u)}}let c=null;i<0&&s&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Ei(n)&&(c=Da(e))&&c.eq(z.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,yt(e),this.currentSelection.set(n),e.scrollToSelection()):(i>-1||s)&&(i>-1&&(e.docView.markDirty(i,o),_w(e)),this.handleDOMChange(i,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(n)||yt(e),this.currentSelection.set(n))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let n=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(n==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!n||n.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let d=e.addedNodes[u];t.push(d),d.nodeType==3&&(this.lastChangedTextNode=d)}if(n.contentDOM&&n.contentDOM!=n.dom&&!n.contentDOM.contains(e.target))return{from:n.posBefore,to:n.posAfter};let s=e.previousSibling,i=e.nextSibling;if(Ie&&jt<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:d,nextSibling:h}=e.addedNodes[u];(!d||Array.prototype.indexOf.call(e.addedNodes,d)<0)&&(s=d),(!h||Array.prototype.indexOf.call(e.addedNodes,h)<0)&&(i=h)}let o=s&&s.parentNode==e.target?ge(s)+1:0,a=n.localPosFromDOM(e.target,o,-1),l=i&&i.parentNode==e.target?ge(i):e.target.childNodes.length,c=n.localPosFromDOM(e.target,l,1);return{from:a,to:c}}else return e.type=="attributes"?{from:n.posAtStart-n.border,to:n.posAtEnd+n.border}:(this.lastChangedTextNode=e.target,{from:n.posAtStart,to:n.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let Cc=new WeakMap,Ac=!1;function _w(r){if(!Cc.has(r)&&(Cc.set(r,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(r.dom).whiteSpace)!==-1)){if(r.requiresGeckoHackNode=Ve,Ac)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),Ac=!0}}function Oc(r,e){let t=e.startContainer,n=e.startOffset,s=e.endContainer,i=e.endOffset,o=r.domAtPos(r.state.selection.anchor);return mr(o.node,o.offset,s,i)&&([t,n,s,i]=[s,i,t,n]),{anchorNode:t,anchorOffset:n,focusNode:s,focusOffset:i}}function Ew(r,e){if(e.getComposedRanges){let s=e.getComposedRanges(r.root)[0];if(s)return Oc(r,s)}let t;function n(s){s.preventDefault(),s.stopImmediatePropagation(),t=s.getTargetRanges()[0]}return r.dom.addEventListener("beforeinput",n,!0),document.execCommand("indent"),r.dom.removeEventListener("beforeinput",n,!0),t?Oc(r,t):null}function Cw(r,e){for(let t=e.parentNode;t&&t!=r.dom;t=t.parentNode){let n=r.docView.nearestDesc(t,!0);if(n&&n.node.isBlock)return t}return null}function Aw(r,e,t){let{node:n,fromOffset:s,toOffset:i,from:o,to:a}=r.docView.parseRange(e,t),l=r.domSelectionRange(),c,u=l.anchorNode;if(u&&r.dom.contains(u.nodeType==1?u:u.parentNode)&&(c=[{node:u,offset:l.anchorOffset}],Ei(l)||c.push({node:l.focusNode,offset:l.focusOffset})),ue&&r.input.lastKeyCode===8)for(let g=i;g>s;g--){let y=n.childNodes[g-1],w=y.pmViewDesc;if(y.nodeName=="BR"&&!w){i=g;break}if(!w||w.size)break}let d=r.state.doc,h=r.someProp("domParser")||Lt.fromSchema(r.state.schema),f=d.resolve(o),p=null,m=h.parse(n,{topNode:f.parent,topMatch:f.parent.contentMatchAt(f.index()),topOpen:!0,from:s,to:i,preserveWhitespace:f.parent.type.whitespace=="pre"?"full":!0,findPositions:c,ruleFromNode:Ow,context:f});if(c&&c[0].pos!=null){let g=c[0].pos,y=c[1]&&c[1].pos;y==null&&(y=g),p={anchor:g+o,head:y+o}}return{doc:m,sel:p,from:o,to:a}}function Ow(r){let e=r.pmViewDesc;if(e)return e.parseRule();if(r.nodeName=="BR"&&r.parentNode){if(Se&&/^(ul|ol)$/i.test(r.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(r.parentNode.lastChild==r||Se&&/^(tr|table)$/i.test(r.parentNode.nodeName))return{ignore:!0}}else if(r.nodeName=="IMG"&&r.getAttribute("mark-placeholder"))return{ignore:!0};return null}const Mw=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|img|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function Iw(r,e,t,n,s){let i=r.input.compositionPendingChanges||(r.composing?r.input.compositionID:0);if(r.input.compositionPendingChanges=0,e<0){let x=r.input.lastSelectionTime>Date.now()-50?r.input.lastSelectionOrigin:null,I=Da(r,x);if(I&&!r.state.selection.eq(I)){if(ue&&mt&&r.input.lastKeyCode===13&&Date.now()-100<r.input.lastKeyCodeTime&&r.someProp("handleKeyDown",G=>G(r,er(13,"Enter"))))return;let $=r.state.tr.setSelection(I);x=="pointer"?$.setMeta("pointer",!0):x=="key"&&$.scrollIntoView(),i&&$.setMeta("composition",i),r.dispatch($)}return}let o=r.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=r.state.doc.resolve(t).after(a+1);let l=r.state.selection,c=Aw(r,e,t),u=r.state.doc,d=u.slice(c.from,c.to),h,f;r.input.lastKeyCode===8&&Date.now()-100<r.input.lastKeyCodeTime?(h=r.state.selection.to,f="end"):(h=r.state.selection.from,f="start"),r.input.lastKeyCode=null;let p=Pw(d.content,c.doc.content,c.from,h,f);if(p&&r.input.domChangeCount++,(qr&&r.input.lastIOSEnter>Date.now()-225||mt)&&s.some(x=>x.nodeType==1&&!Mw.test(x.nodeName))&&(!p||p.endA>=p.endB)&&r.someProp("handleKeyDown",x=>x(r,er(13,"Enter")))){r.input.lastIOSEnter=0;return}if(!p)if(n&&l instanceof D&&!l.empty&&l.$head.sameParent(l.$anchor)&&!r.composing&&!(c.sel&&c.sel.anchor!=c.sel.head))p={start:l.from,endA:l.to,endB:l.to};else{if(c.sel){let x=Mc(r,r.state.doc,c.sel);if(x&&!x.eq(r.state.selection)){let I=r.state.tr.setSelection(x);i&&I.setMeta("composition",i),r.dispatch(I)}}return}r.state.selection.from<r.state.selection.to&&p.start==p.endB&&r.state.selection instanceof D&&(p.start>r.state.selection.from&&p.start<=r.state.selection.from+2&&r.state.selection.from>=c.from?p.start=r.state.selection.from:p.endA<r.state.selection.to&&p.endA>=r.state.selection.to-2&&r.state.selection.to<=c.to&&(p.endB+=r.state.selection.to-p.endA,p.endA=r.state.selection.to)),Ie&&jt<=11&&p.endB==p.start+1&&p.endA==p.start&&p.start>c.from&&c.doc.textBetween(p.start-c.from-1,p.start-c.from+1)==" "&&(p.start--,p.endA--,p.endB--);let m=c.doc.resolveNoCache(p.start-c.from),g=c.doc.resolveNoCache(p.endB-c.from),y=u.resolve(p.start),w=m.sameParent(g)&&m.parent.inlineContent&&y.end()>=p.endA;if((qr&&r.input.lastIOSEnter>Date.now()-225&&(!w||s.some(x=>x.nodeName=="DIV"||x.nodeName=="P"))||!w&&m.pos<c.doc.content.size&&(!m.sameParent(g)||!m.parent.inlineContent)&&m.pos<g.pos&&!/\S/.test(c.doc.textBetween(m.pos,g.pos,"","")))&&r.someProp("handleKeyDown",x=>x(r,er(13,"Enter")))){r.input.lastIOSEnter=0;return}if(r.state.selection.anchor>p.start&&Nw(u,p.start,p.endA,m,g)&&r.someProp("handleKeyDown",x=>x(r,er(8,"Backspace")))){mt&&ue&&r.domObserver.suppressSelectionUpdates();return}ue&&p.endB==p.start&&(r.input.lastChromeDelete=Date.now()),mt&&!w&&m.start()!=g.start()&&g.parentOffset==0&&m.depth==g.depth&&c.sel&&c.sel.anchor==c.sel.head&&c.sel.head==p.endA&&(p.endB-=2,g=c.doc.resolveNoCache(p.endB-c.from),setTimeout(()=>{r.someProp("handleKeyDown",function(x){return x(r,er(13,"Enter"))})},20));let v=p.start,_=p.endA,E=x=>{let I=x||r.state.tr.replace(v,_,c.doc.slice(p.start-c.from,p.endB-c.from));if(c.sel){let $=Mc(r,I.doc,c.sel);$&&!(ue&&r.composing&&$.empty&&(p.start!=p.endB||r.input.lastChromeDelete<Date.now()-100)&&($.head==v||$.head==I.mapping.map(_)-1)||Ie&&$.empty&&$.head==v)&&I.setSelection($)}return i&&I.setMeta("composition",i),I.scrollIntoView()},S;if(w)if(m.pos==g.pos){Ie&&jt<=11&&m.parentOffset==0&&(r.domObserver.suppressSelectionUpdates(),setTimeout(()=>yt(r),20));let x=E(r.state.tr.delete(v,_)),I=u.resolve(p.start).marksAcross(u.resolve(p.endA));I&&x.ensureMarks(I),r.dispatch(x)}else if(p.endA==p.endB&&(S=Rw(m.parent.content.cut(m.parentOffset,g.parentOffset),y.parent.content.cut(y.parentOffset,p.endA-y.start())))){let x=E(r.state.tr);S.type=="add"?x.addMark(v,_,S.mark):x.removeMark(v,_,S.mark),r.dispatch(x)}else if(m.parent.child(m.index()).isText&&m.index()==g.index()-(g.textOffset?0:1)){let x=m.parent.textBetween(m.parentOffset,g.parentOffset),I=()=>E(r.state.tr.insertText(x,v,_));r.someProp("handleTextInput",$=>$(r,v,_,x,I))||r.dispatch(I())}else r.dispatch(E());else r.dispatch(E())}function Mc(r,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:$a(r,e.resolve(t.anchor),e.resolve(t.head))}function Rw(r,e){let t=r.firstChild.marks,n=e.firstChild.marks,s=t,i=n,o,a,l;for(let u=0;u<n.length;u++)s=n[u].removeFromSet(s);for(let u=0;u<t.length;u++)i=t[u].removeFromSet(i);if(s.length==1&&i.length==0)a=s[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(s.length==0&&i.length==1)a=i[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let c=[];for(let u=0;u<e.childCount;u++)c.push(l(e.child(u)));if(k.from(c).eq(r))return{mark:a,type:o}}function Nw(r,e,t,n,s){if(t-e<=s.pos-n.pos||oo(n,!0,!1)<s.pos)return!1;let i=r.resolve(e);if(!n.parent.isTextblock){let a=i.nodeAfter;return a!=null&&t==e+a.nodeSize}if(i.parentOffset<i.parent.content.size||!i.parent.isTextblock)return!1;let o=r.resolve(oo(i,!0,!0));return!o.parent.isTextblock||o.pos>t||oo(o,!0,!1)<t?!1:n.parent.content.cut(n.parentOffset).eq(o.parent.content)}function oo(r,e,t){let n=r.depth,s=e?r.end():r.pos;for(;n>0&&(e||r.indexAfter(n)==r.node(n).childCount);)n--,s++,e=!1;if(t){let i=r.node(n).maybeChild(r.indexAfter(n));for(;i&&!i.isLeaf;)i=i.firstChild,s++}return s}function Pw(r,e,t,n,s){let i=r.findDiffStart(e,t);if(i==null)return null;let{a:o,b:a}=r.findDiffEnd(e,t+r.size,t+e.size);if(s=="end"){let l=Math.max(0,i-Math.min(o,a));n-=o+l-i}if(o<i&&r.size<e.size){let l=n<=i&&n>=o?i-n:0;i-=l,i&&i<e.size&&Ic(e.textBetween(i-1,i+1))&&(i+=l?1:-1),a=i+(a-o),o=i}else if(a<i){let l=n<=i&&n>=a?i-n:0;i-=l,i&&i<r.size&&Ic(r.textBetween(i-1,i+1))&&(i+=l?1:-1),o=i+(o-a),a=i}return{start:i,endA:o,endB:a}}function Ic(r){if(r.length!=2)return!1;let e=r.charCodeAt(0),t=r.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class ah{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new Qb,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach($c),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=Pc(this),Nc(this),this.nodeViews=Dc(this),this.docView=hc(this.state.doc,Rc(this),io(this),this.dom,this),this.domObserver=new Tw(this,(n,s,i,o)=>Iw(this,n,s,i,o)),this.domObserver.start(),Xb(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&ea(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach($c),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let n in this._props)t[n]=this._props[n];t.state=this.state;for(let n in e)t[n]=e[n];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var n;let s=this.state,i=!1,o=!1;e.storedMarks&&this.composing&&(eh(this),o=!0),this.state=e;let a=s.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let f=Dc(this);$w(f,this.nodeViews)&&(this.nodeViews=f,i=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&ea(this),this.editable=Pc(this),Nc(this);let l=io(this),c=Rc(this),u=s.plugins!=e.plugins&&!s.doc.eq(e.doc)?"reset":e.scrollToSelection>s.scrollToSelection?"to selection":"preserve",d=i||!this.docView.matchesNode(e.doc,c,l);(d||!e.selection.eq(s.selection))&&(o=!0);let h=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&hb(this);if(o){this.domObserver.stop();let f=d&&(Ie||ue)&&!this.composing&&!s.selection.empty&&!e.selection.empty&&Dw(s.selection,e.selection);if(d){let p=ue?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=hw(this)),(i||!this.docView.update(e.doc,c,l,this))&&(this.docView.updateOuterDeco(c),this.docView.destroy(),this.docView=hc(e.doc,c,l,this.dom,this)),p&&!this.trackWrites&&(f=!0)}f||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&$b(this))?yt(this,f):(Fd(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(s),!((n=this.dragging)===null||n===void 0)&&n.node&&!s.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,s),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():h&&fb(h)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!(!e||!this.dom.contains(e.nodeType==1?e:e.parentNode))){if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof M){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&oc(this,t.getBoundingClientRect(),e)}else oc(this,this.coordsAtPos(this.state.selection.head,1),e)}}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let n=this.directPlugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let n=this.state.plugins[t];n.spec.view&&this.pluginViews.push(n.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let n=this.pluginViews[t];n.update&&n.update(this,e)}}updateDraggedNode(e,t){let n=e.node,s=-1;if(this.state.doc.nodeAt(n.from)==n.node)s=n.from;else{let i=n.from+(this.state.doc.content.size-t.doc.content.size);(i>0&&this.state.doc.nodeAt(i))==n.node&&(s=i)}this.dragging=new rh(e.slice,e.move,s<0?void 0:M.create(this.state.doc,s))}someProp(e,t){let n=this._props&&this._props[e],s;if(n!=null&&(s=t?t(n):n))return s;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(s=t?t(a):a))return s}let i=this.state.plugins;if(i)for(let o=0;o<i.length;o++){let a=i[o].props[e];if(a!=null&&(s=t?t(a):a))return s}}hasFocus(){if(Ie){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&pb(this.dom),yt(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return wb(this,e)}coordsAtPos(e,t=1){return Pd(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,n=-1){let s=this.docView.posFromDOM(e,t,n);if(s==null)throw new RangeError("DOM position not inside the editor");return s}endOfTextblock(e,t){return Tb(this,t||this.state,e)}pasteHTML(e,t){return Dn(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return Dn(this,e,null,!0,t||new ClipboardEvent("paste"))}serializeForClipboard(e){return La(this,e)}destroy(){this.docView&&(Zb(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],io(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,rb())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return tw(this,e)}domSelectionRange(){let e=this.domSelection();return e?Se&&this.root.nodeType===11&&ab(this.dom.ownerDocument)==this.dom&&Ew(this,e)||e:{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0}}domSelection(){return this.root.getSelection()}}ah.prototype.dispatch=function(r){let e=this._props.dispatchTransaction;e?e.call(this,r):this.updateState(this.state.apply(r))};function Rc(r){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(r.editable),r.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(r.state)),t)for(let n in t)n=="class"?e.class+=" "+t[n]:n=="style"?e.style=(e.style?e.style+";":"")+t[n]:!e[n]&&n!="contenteditable"&&n!="nodeName"&&(e[n]=String(t[n]))}),e.translate||(e.translate="no"),[ve.node(0,r.state.doc.content.size,e)]}function Nc(r){if(r.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),r.cursorWrapper={dom:e,deco:ve.widget(r.state.selection.from,e,{raw:!0,marks:r.markCursor})}}else r.cursorWrapper=null}function Pc(r){return!r.someProp("editable",e=>e(r.state)===!1)}function Dw(r,e){let t=Math.min(r.$anchor.sharedDepth(r.head),e.$anchor.sharedDepth(e.head));return r.$anchor.start(t)!=e.$anchor.start(t)}function Dc(r){let e=Object.create(null);function t(n){for(let s in n)Object.prototype.hasOwnProperty.call(e,s)||(e[s]=n[s])}return r.someProp("nodeViews",t),r.someProp("markViews",t),e}function $w(r,e){let t=0,n=0;for(let s in r){if(r[s]!=e[s])return!0;t++}for(let s in e)n++;return t!=n}function $c(r){if(r.spec.state||r.spec.filterTransaction||r.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}var Ut={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Ds={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},Lw=typeof navigator<"u"&&/Mac/.test(navigator.platform),jw=typeof navigator<"u"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);for(var ye=0;ye<10;ye++)Ut[48+ye]=Ut[96+ye]=String(ye);for(var ye=1;ye<=24;ye++)Ut[ye+111]="F"+ye;for(var ye=65;ye<=90;ye++)Ut[ye]=String.fromCharCode(ye+32),Ds[ye]=String.fromCharCode(ye);for(var ao in Ut)Ds.hasOwnProperty(ao)||(Ds[ao]=Ut[ao]);function Bw(r){var e=Lw&&r.metaKey&&r.shiftKey&&!r.ctrlKey&&!r.altKey||jw&&r.shiftKey&&r.key&&r.key.length==1||r.key=="Unidentified",t=!e&&r.key||(r.shiftKey?Ds:Ut)[r.keyCode]||r.key||"Unidentified";return t=="Esc"&&(t="Escape"),t=="Del"&&(t="Delete"),t=="Left"&&(t="ArrowLeft"),t=="Up"&&(t="ArrowUp"),t=="Right"&&(t="ArrowRight"),t=="Down"&&(t="ArrowDown"),t}const zw=typeof navigator<"u"&&/Mac|iP(hone|[oa]d)/.test(navigator.platform),Uw=typeof navigator<"u"&&/Win/.test(navigator.platform);function Fw(r){let e=r.split(/-(?!$)/),t=e[e.length-1];t=="Space"&&(t=" ");let n,s,i,o;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))n=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))i=!0;else if(/^mod$/i.test(l))zw?o=!0:s=!0;else throw new Error("Unrecognized modifier name: "+l)}return n&&(t="Alt-"+t),s&&(t="Ctrl-"+t),o&&(t="Meta-"+t),i&&(t="Shift-"+t),t}function Hw(r){let e=Object.create(null);for(let t in r)e[Fw(t)]=r[t];return e}function lo(r,e,t=!0){return e.altKey&&(r="Alt-"+r),e.ctrlKey&&(r="Ctrl-"+r),e.metaKey&&(r="Meta-"+r),t&&e.shiftKey&&(r="Shift-"+r),r}function Vw(r){return new K({props:{handleKeyDown:lh(r)}})}function lh(r){let e=Hw(r);return function(t,n){let s=Bw(n),i,o=e[lo(s,n)];if(o&&o(t.state,t.dispatch,t))return!0;if(s.length==1&&s!=" "){if(n.shiftKey){let a=e[lo(s,n,!1)];if(a&&a(t.state,t.dispatch,t))return!0}if((n.altKey||n.metaKey||n.ctrlKey)&&!(Uw&&n.ctrlKey&&n.altKey)&&(i=Ut[n.keyCode])&&i!=s){let a=e[lo(i,n)];if(a&&a(t.state,t.dispatch,t))return!0}}return!1}}var qw=Object.defineProperty,Ha=(r,e)=>{for(var t in e)qw(r,t,{get:e[t],enumerable:!0})};function Oi(r){const{state:e,transaction:t}=r;let{selection:n}=t,{doc:s}=t,{storedMarks:i}=t;return{...e,apply:e.apply.bind(e),applyTransaction:e.applyTransaction.bind(e),plugins:e.plugins,schema:e.schema,reconfigure:e.reconfigure.bind(e),toJSON:e.toJSON.bind(e),get storedMarks(){return i},get selection(){return n},get doc(){return s},get tr(){return n=t.selection,s=t.doc,i=t.storedMarks,t}}}var Mi=class{constructor(r){this.editor=r.editor,this.rawCommands=this.editor.extensionManager.commands,this.customState=r.state}get hasCustomState(){return!!this.customState}get state(){return this.customState||this.editor.state}get commands(){const{rawCommands:r,editor:e,state:t}=this,{view:n}=e,{tr:s}=t,i=this.buildProps(s);return Object.fromEntries(Object.entries(r).map(([o,a])=>[o,(...c)=>{const u=a(...c)(i);return!s.getMeta("preventDispatch")&&!this.hasCustomState&&n.dispatch(s),u}]))}get chain(){return()=>this.createChain()}get can(){return()=>this.createCan()}createChain(r,e=!0){const{rawCommands:t,editor:n,state:s}=this,{view:i}=n,o=[],a=!!r,l=r||s.tr,c=()=>(!a&&e&&!l.getMeta("preventDispatch")&&!this.hasCustomState&&i.dispatch(l),o.every(d=>d===!0)),u={...Object.fromEntries(Object.entries(t).map(([d,h])=>[d,(...p)=>{const m=this.buildProps(l,e),g=h(...p)(m);return o.push(g),u}])),run:c};return u}createCan(r){const{rawCommands:e,state:t}=this,n=!1,s=r||t.tr,i=this.buildProps(s,n);return{...Object.fromEntries(Object.entries(e).map(([a,l])=>[a,(...c)=>l(...c)({...i,dispatch:void 0})])),chain:()=>this.createChain(s,n)}}buildProps(r,e=!0){const{rawCommands:t,editor:n,state:s}=this,{view:i}=n,o={tr:r,editor:n,view:i,state:Oi({state:s,transaction:r}),dispatch:e?()=>{}:void 0,chain:()=>this.createChain(r,e),can:()=>this.createCan(r),get commands(){return Object.fromEntries(Object.entries(t).map(([a,l])=>[a,(...c)=>l(...c)(o)]))}};return o}},ch={};Ha(ch,{blur:()=>Ww,clearContent:()=>Kw,clearNodes:()=>Jw,command:()=>Gw,createParagraphNear:()=>Yw,cut:()=>Qw,deleteCurrentNode:()=>Xw,deleteNode:()=>Zw,deleteRange:()=>ev,deleteSelection:()=>tv,enter:()=>rv,exitCode:()=>nv,extendMarkRange:()=>sv,first:()=>iv,focus:()=>av,forEach:()=>lv,insertContent:()=>cv,insertContentAt:()=>hv,joinBackward:()=>mv,joinDown:()=>pv,joinForward:()=>gv,joinItemBackward:()=>yv,joinItemForward:()=>bv,joinTextblockBackward:()=>wv,joinTextblockForward:()=>vv,joinUp:()=>fv,keyboardShortcut:()=>Sv,lift:()=>xv,liftEmptyBlock:()=>Tv,liftListItem:()=>_v,newlineInCode:()=>Ev,resetAttributes:()=>Cv,scrollIntoView:()=>Av,selectAll:()=>Ov,selectNodeBackward:()=>Mv,selectNodeForward:()=>Iv,selectParentNode:()=>Rv,selectTextblockEnd:()=>Nv,selectTextblockStart:()=>Pv,setContent:()=>Dv,setMark:()=>t0,setMeta:()=>r0,setNode:()=>n0,setNodeSelection:()=>s0,setTextDirection:()=>i0,setTextSelection:()=>o0,sinkListItem:()=>a0,splitBlock:()=>l0,splitListItem:()=>c0,toggleList:()=>u0,toggleMark:()=>d0,toggleNode:()=>h0,toggleWrap:()=>f0,undoInputRule:()=>p0,unsetAllMarks:()=>m0,unsetMark:()=>g0,unsetTextDirection:()=>y0,updateAttributes:()=>b0,wrapIn:()=>w0,wrapInList:()=>v0});var Ww=()=>({editor:r,view:e})=>(requestAnimationFrame(()=>{var t;r.isDestroyed||(e.dom.blur(),(t=window?.getSelection())==null||t.removeAllRanges())}),!0),Kw=(r=!0)=>({commands:e})=>e.setContent("",{emitUpdate:r}),Jw=()=>({state:r,tr:e,dispatch:t})=>{const{selection:n}=e,{ranges:s}=n;return t&&s.forEach(({$from:i,$to:o})=>{r.doc.nodesBetween(i.pos,o.pos,(a,l)=>{if(a.type.isText)return;const{doc:c,mapping:u}=e,d=c.resolve(u.map(l)),h=c.resolve(u.map(l+a.nodeSize)),f=d.blockRange(h);if(!f)return;const p=Zr(f);if(a.type.isTextblock){const{defaultType:m}=d.parent.contentMatchAt(d.index());e.setNodeMarkup(f.start,m)}(p||p===0)&&e.lift(f,p)})}),!0},Gw=r=>e=>r(e),Yw=()=>({state:r,dispatch:e})=>xd(r,e),Qw=(r,e)=>({editor:t,tr:n})=>{const{state:s}=t,i=s.doc.slice(r.from,r.to);n.deleteRange(r.from,r.to);const o=n.mapping.map(e);return n.insert(o,i.content),n.setSelection(new D(n.doc.resolve(Math.max(o-1,0)))),!0},Xw=()=>({tr:r,dispatch:e})=>{const{selection:t}=r,n=t.$anchor.node();if(n.content.size>0)return!1;const s=r.selection.$anchor;for(let i=s.depth;i>0;i-=1)if(s.node(i).type===n.type){if(e){const a=s.before(i),l=s.after(i);r.delete(a,l).scrollIntoView()}return!0}return!1};function oe(r,e){if(typeof r=="string"){if(!e.nodes[r])throw Error(`There is no node type named '${r}'. Maybe you forgot to add the extension?`);return e.nodes[r]}return r}var Zw=r=>({tr:e,state:t,dispatch:n})=>{const s=oe(r,t.schema),i=e.selection.$anchor;for(let o=i.depth;o>0;o-=1)if(i.node(o).type===s){if(n){const l=i.before(o),c=i.after(o);e.delete(l,c).scrollIntoView()}return!0}return!1},ev=r=>({tr:e,dispatch:t})=>{const{from:n,to:s}=r;return t&&e.delete(n,s),!0},tv=()=>({state:r,dispatch:e})=>Oa(r,e),rv=()=>({commands:r})=>r.keyboardShortcut("Enter"),nv=()=>({state:r,dispatch:e})=>Uy(r,e);function Va(r){return Object.prototype.toString.call(r)==="[object RegExp]"}function $s(r,e,t={strict:!0}){const n=Object.keys(e);return n.length?n.every(s=>t.strict?e[s]===r[s]:Va(e[s])?e[s].test(r[s]):e[s]===r[s]):!0}function uh(r,e,t={}){return r.find(n=>n.type===e&&$s(Object.fromEntries(Object.keys(t).map(s=>[s,n.attrs[s]])),t))}function Lc(r,e,t={}){return!!uh(r,e,t)}function qa(r,e,t){var n;if(!r||!e)return;let s=r.parent.childAfter(r.parentOffset);if((!s.node||!s.node.marks.some(u=>u.type===e))&&(s=r.parent.childBefore(r.parentOffset)),!s.node||!s.node.marks.some(u=>u.type===e)||(t=t||((n=s.node.marks[0])==null?void 0:n.attrs),!uh([...s.node.marks],e,t)))return;let o=s.index,a=r.start()+s.offset,l=o+1,c=a+s.node.nodeSize;for(;o>0&&Lc([...r.parent.child(o-1).marks],e,t);)o-=1,a-=r.parent.child(o).nodeSize;for(;l<r.parent.childCount&&Lc([...r.parent.child(l).marks],e,t);)c+=r.parent.child(l).nodeSize,l+=1;return{from:a,to:c}}function vt(r,e){if(typeof r=="string"){if(!e.marks[r])throw Error(`There is no mark type named '${r}'. Maybe you forgot to add the extension?`);return e.marks[r]}return r}var sv=(r,e={})=>({tr:t,state:n,dispatch:s})=>{const i=vt(r,n.schema),{doc:o,selection:a}=t,{$from:l,from:c,to:u}=a;if(s){const d=qa(l,i,e);if(d&&d.from<=c&&d.to>=u){const h=D.create(o,d.from,d.to);t.setSelection(h)}}return!0},iv=r=>e=>{const t=typeof r=="function"?r(e):r;for(let n=0;n<t.length;n+=1)if(t[n](e))return!0;return!1};function dh(r){return r instanceof D}function sr(r=0,e=0,t=0){return Math.min(Math.max(r,e),t)}function hh(r,e=null){if(!e)return null;const t=z.atStart(r),n=z.atEnd(r);if(e==="start"||e===!0)return t;if(e==="end")return n;const s=t.from,i=n.to;return e==="all"?D.create(r,sr(0,s,i),sr(r.content.size,s,i)):D.create(r,sr(e,s,i),sr(e,s,i))}function jc(){return navigator.platform==="Android"||/android/i.test(navigator.userAgent)}function Ls(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function ov(){return typeof navigator<"u"?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}var av=(r=null,e={})=>({editor:t,view:n,tr:s,dispatch:i})=>{e={scrollIntoView:!0,...e};const o=()=>{(Ls()||jc())&&n.dom.focus(),ov()&&!Ls()&&!jc()&&n.dom.focus({preventScroll:!0}),requestAnimationFrame(()=>{t.isDestroyed||(n.focus(),e?.scrollIntoView&&t.commands.scrollIntoView())})};if(n.hasFocus()&&r===null||r===!1)return!0;if(i&&r===null&&!dh(t.state.selection))return o(),!0;const a=hh(s.doc,r)||t.state.selection,l=t.state.selection.eq(a);return i&&(l||s.setSelection(a),l&&s.storedMarks&&s.setStoredMarks(s.storedMarks),o()),!0},lv=(r,e)=>t=>r.every((n,s)=>e(n,{...t,index:s})),cv=(r,e)=>({tr:t,commands:n})=>n.insertContentAt({from:t.selection.from,to:t.selection.to},r,e),fh=r=>{const e=r.childNodes;for(let t=e.length-1;t>=0;t-=1){const n=e[t];n.nodeType===3&&n.nodeValue&&/^(\n\s\s|\n)$/.test(n.nodeValue)?r.removeChild(n):n.nodeType===1&&fh(n)}return r};function ss(r){if(typeof window>"u")throw new Error("[tiptap error]: there is no window object available, so this function cannot be used");const e=`<body>${r}</body>`,t=new window.DOMParser().parseFromString(e,"text/html").body;return fh(t)}function Ln(r,e,t){if(r instanceof Ze||r instanceof k)return r;t={slice:!0,parseOptions:{},...t};const n=typeof r=="object"&&r!==null,s=typeof r=="string";if(n)try{if(Array.isArray(r)&&r.length>0)return k.fromArray(r.map(a=>e.nodeFromJSON(a)));const o=e.nodeFromJSON(r);return t.errorOnInvalidContent&&o.check(),o}catch(i){if(t.errorOnInvalidContent)throw new Error("[tiptap error]: Invalid JSON content",{cause:i});return console.warn("[tiptap warn]: Invalid content.","Passed value:",r,"Error:",i),Ln("",e,t)}if(s){if(t.errorOnInvalidContent){let o=!1,a="";const l=new Yu({topNode:e.spec.topNode,marks:e.spec.marks,nodes:e.spec.nodes.append({__tiptap__private__unknown__catch__all__node:{content:"inline*",group:"block",parseDOM:[{tag:"*",getAttrs:c=>(o=!0,a=typeof c=="string"?c:c.outerHTML,null)}]}})});if(t.slice?Lt.fromSchema(l).parseSlice(ss(r),t.parseOptions):Lt.fromSchema(l).parse(ss(r),t.parseOptions),t.errorOnInvalidContent&&o)throw new Error("[tiptap error]: Invalid HTML content",{cause:new Error(`Invalid element found: ${a}`)})}const i=Lt.fromSchema(e);return t.slice?i.parseSlice(ss(r),t.parseOptions).content:i.parse(ss(r),t.parseOptions)}return Ln("",e,t)}function uv(r,e,t){const n=r.steps.length-1;if(n<e)return;const s=r.steps[n];if(!(s instanceof ce||s instanceof de))return;const i=r.mapping.maps[n];let o=0;i.forEach((a,l,c,u)=>{o===0&&(o=u)}),r.setSelection(z.near(r.doc.resolve(o),t))}var dv=r=>!("type"in r),hv=(r,e,t)=>({tr:n,dispatch:s,editor:i})=>{var o;if(s){t={parseOptions:i.options.parseOptions,updateSelection:!0,applyInputRules:!1,applyPasteRules:!1,...t};let a;const l=g=>{i.emit("contentError",{editor:i,error:g,disableCollaboration:()=>{"collaboration"in i.storage&&typeof i.storage.collaboration=="object"&&i.storage.collaboration&&(i.storage.collaboration.isDisabled=!0)}})},c={preserveWhitespace:"full",...t.parseOptions};if(!t.errorOnInvalidContent&&!i.options.enableContentCheck&&i.options.emitContentError)try{Ln(e,i.schema,{parseOptions:c,errorOnInvalidContent:!0})}catch(g){l(g)}try{a=Ln(e,i.schema,{parseOptions:c,errorOnInvalidContent:(o=t.errorOnInvalidContent)!=null?o:i.options.enableContentCheck})}catch(g){return l(g),!1}let{from:u,to:d}=typeof r=="number"?{from:r,to:r}:{from:r.from,to:r.to},h=!0,f=!0;if((dv(a)?a:[a]).forEach(g=>{g.check(),h=h?g.isText&&g.marks.length===0:!1,f=f?g.isBlock:!1}),u===d&&f){const{parent:g}=n.doc.resolve(u);g.isTextblock&&!g.type.spec.code&&!g.childCount&&(u-=1,d+=1)}let m;if(h){if(Array.isArray(e))m=e.map(g=>g.text||"").join("");else if(e instanceof k){let g="";e.forEach(y=>{y.text&&(g+=y.text)}),m=g}else typeof e=="object"&&e&&e.text?m=e.text:m=e;n.insertText(m,u,d)}else{m=a;const g=n.doc.resolve(u),y=g.node(),w=g.parentOffset===0,v=y.isText||y.isTextblock,_=y.content.size>0;w&&v&&_&&(u=Math.max(0,u-1)),n.replaceWith(u,d,m)}t.updateSelection&&uv(n,n.steps.length-1,-1),t.applyInputRules&&n.setMeta("applyInputRules",{from:u,text:m}),t.applyPasteRules&&n.setMeta("applyPasteRules",{from:u,text:m})}return!0},fv=()=>({state:r,dispatch:e})=>jy(r,e),pv=()=>({state:r,dispatch:e})=>By(r,e),mv=()=>({state:r,dispatch:e})=>gd(r,e),gv=()=>({state:r,dispatch:e})=>vd(r,e),yv=()=>({state:r,dispatch:e,tr:t})=>{try{const n=xi(r.doc,r.selection.$from.pos,-1);return n==null?!1:(t.join(n,2),e&&e(t),!0)}catch{return!1}},bv=()=>({state:r,dispatch:e,tr:t})=>{try{const n=xi(r.doc,r.selection.$from.pos,1);return n==null?!1:(t.join(n,2),e&&e(t),!0)}catch{return!1}},wv=()=>({state:r,dispatch:e})=>$y(r,e),vv=()=>({state:r,dispatch:e})=>Ly(r,e);function ph(){return typeof navigator<"u"?/Mac/.test(navigator.platform):!1}function kv(r){const e=r.split(/-(?!$)/);let t=e[e.length-1];t==="Space"&&(t=" ");let n,s,i,o;for(let a=0;a<e.length-1;a+=1){const l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))n=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))i=!0;else if(/^mod$/i.test(l))Ls()||ph()?o=!0:s=!0;else throw new Error(`Unrecognized modifier name: ${l}`)}return n&&(t=`Alt-${t}`),s&&(t=`Ctrl-${t}`),o&&(t=`Meta-${t}`),i&&(t=`Shift-${t}`),t}var Sv=r=>({editor:e,view:t,tr:n,dispatch:s})=>{const i=kv(r).split(/-(?!$)/),o=i.find(c=>!["Alt","Ctrl","Meta","Shift"].includes(c)),a=new KeyboardEvent("keydown",{key:o==="Space"?" ":o,altKey:i.includes("Alt"),ctrlKey:i.includes("Ctrl"),metaKey:i.includes("Meta"),shiftKey:i.includes("Shift"),bubbles:!0,cancelable:!0}),l=e.captureTransaction(()=>{t.someProp("handleKeyDown",c=>c(t,a))});return l?.steps.forEach(c=>{const u=c.map(n.mapping);u&&s&&n.maybeStep(u)}),!0};function Ft(r,e,t={}){const{from:n,to:s,empty:i}=r.selection,o=e?oe(e,r.schema):null,a=[];r.doc.nodesBetween(n,s,(d,h)=>{if(d.isText)return;const f=Math.max(n,h),p=Math.min(s,h+d.nodeSize);a.push({node:d,from:f,to:p})});const l=s-n,c=a.filter(d=>o?o.name===d.node.type.name:!0).filter(d=>$s(d.node.attrs,t,{strict:!1}));return i?!!c.length:c.reduce((d,h)=>d+h.to-h.from,0)>=l}var xv=(r,e={})=>({state:t,dispatch:n})=>{const s=oe(r,t.schema);return Ft(t,s,e)?zy(t,n):!1},Tv=()=>({state:r,dispatch:e})=>Td(r,e),_v=r=>({state:e,dispatch:t})=>{const n=oe(r,e.schema);return Xy(n)(e,t)},Ev=()=>({state:r,dispatch:e})=>Sd(r,e);function Ii(r,e){return e.nodes[r]?"node":e.marks[r]?"mark":null}function Bc(r,e){const t=typeof e=="string"?[e]:e;return Object.keys(r).reduce((n,s)=>(t.includes(s)||(n[s]=r[s]),n),{})}var Cv=(r,e)=>({tr:t,state:n,dispatch:s})=>{let i=null,o=null;const a=Ii(typeof r=="string"?r:r.name,n.schema);if(!a)return!1;a==="node"&&(i=oe(r,n.schema)),a==="mark"&&(o=vt(r,n.schema));let l=!1;return t.selection.ranges.forEach(c=>{n.doc.nodesBetween(c.$from.pos,c.$to.pos,(u,d)=>{i&&i===u.type&&(l=!0,s&&t.setNodeMarkup(d,void 0,Bc(u.attrs,e))),o&&u.marks.length&&u.marks.forEach(h=>{o===h.type&&(l=!0,s&&t.addMark(d,d+u.nodeSize,o.create(Bc(h.attrs,e))))})})}),l},Av=()=>({tr:r,dispatch:e})=>(e&&r.scrollIntoView(),!0),Ov=()=>({tr:r,dispatch:e})=>{if(e){const t=new Le(r.doc);r.setSelection(t)}return!0},Mv=()=>({state:r,dispatch:e})=>bd(r,e),Iv=()=>({state:r,dispatch:e})=>kd(r,e),Rv=()=>({state:r,dispatch:e})=>Vy(r,e),Nv=()=>({state:r,dispatch:e})=>Ky(r,e),Pv=()=>({state:r,dispatch:e})=>Wy(r,e);function ta(r,e,t={},n={}){return Ln(r,e,{slice:!1,parseOptions:t,errorOnInvalidContent:n.errorOnInvalidContent})}var Dv=(r,{errorOnInvalidContent:e,emitUpdate:t=!0,parseOptions:n={}}={})=>({editor:s,tr:i,dispatch:o,commands:a})=>{const{doc:l}=i;if(n.preserveWhitespace!=="full"){const c=ta(r,s.schema,n,{errorOnInvalidContent:e??s.options.enableContentCheck});return o&&i.replaceWith(0,l.content.size,c).setMeta("preventUpdate",!t),!0}return o&&i.setMeta("preventUpdate",!t),a.insertContentAt({from:0,to:l.content.size},r,{parseOptions:n,errorOnInvalidContent:e??s.options.enableContentCheck})};function mh(r,e){const t=vt(e,r.schema),{from:n,to:s,empty:i}=r.selection,o=[];i?(r.storedMarks&&o.push(...r.storedMarks),o.push(...r.selection.$head.marks())):r.doc.nodesBetween(n,s,l=>{o.push(...l.marks)});const a=o.find(l=>l.type.name===t.name);return a?{...a.attrs}:{}}function gh(r,e){const t=new hd(r);return e.forEach(n=>{n.steps.forEach(s=>{t.step(s)})}),t}function $v(r){for(let e=0;e<r.edgeCount;e+=1){const{type:t}=r.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}function Lv(r,e,t){const n=[];return r.nodesBetween(e.from,e.to,(s,i)=>{t(s)&&n.push({node:s,pos:i})}),n}function jv(r,e){for(let t=r.depth;t>0;t-=1){const n=r.node(t);if(e(n))return{pos:t>0?r.before(t):0,start:r.start(t),depth:t,node:n}}}function Ri(r){return e=>jv(e.$from,r)}function O(r,e,t){return r.config[e]===void 0&&r.parent?O(r.parent,e,t):typeof r.config[e]=="function"?r.config[e].bind({...t,parent:r.parent?O(r.parent,e,t):null}):r.config[e]}function Wa(r){return r.map(e=>{const t={name:e.name,options:e.options,storage:e.storage},n=O(e,"addExtensions",t);return n?[e,...Wa(n())]:e}).flat(10)}function Ka(r,e){const t=vr.fromSchema(e).serializeFragment(r),s=document.implementation.createHTMLDocument().createElement("div");return s.appendChild(t),s.innerHTML}function yh(r){return typeof r=="function"}function H(r,e=void 0,...t){return yh(r)?e?r.bind(e)(...t):r(...t):r}function Bv(r={}){return Object.keys(r).length===0&&r.constructor===Object}function Wr(r){const e=r.filter(s=>s.type==="extension"),t=r.filter(s=>s.type==="node"),n=r.filter(s=>s.type==="mark");return{baseExtensions:e,nodeExtensions:t,markExtensions:n}}function bh(r){const e=[],{nodeExtensions:t,markExtensions:n}=Wr(r),s=[...t,...n],i={default:null,validate:void 0,rendered:!0,renderHTML:null,parseHTML:null,keepOnSplit:!0,isRequired:!1};return r.forEach(o=>{const a={name:o.name,options:o.options,storage:o.storage,extensions:s},l=O(o,"addGlobalAttributes",a);if(!l)return;l().forEach(u=>{u.types.forEach(d=>{Object.entries(u.attributes).forEach(([h,f])=>{e.push({type:d,name:h,attribute:{...i,...f}})})})})}),s.forEach(o=>{const a={name:o.name,options:o.options,storage:o.storage},l=O(o,"addAttributes",a);if(!l)return;const c=l();Object.entries(c).forEach(([u,d])=>{const h={...i,...d};typeof h?.default=="function"&&(h.default=h.default()),h?.isRequired&&h?.default===void 0&&delete h.default,e.push({type:o.name,name:u,attribute:h})})}),e}function te(...r){return r.filter(e=>!!e).reduce((e,t)=>{const n={...e};return Object.entries(t).forEach(([s,i])=>{if(!n[s]){n[s]=i;return}if(s==="class"){const a=i?String(i).split(" "):[],l=n[s]?n[s].split(" "):[],c=a.filter(u=>!l.includes(u));n[s]=[...l,...c].join(" ")}else if(s==="style"){const a=i?i.split(";").map(u=>u.trim()).filter(Boolean):[],l=n[s]?n[s].split(";").map(u=>u.trim()).filter(Boolean):[],c=new Map;l.forEach(u=>{const[d,h]=u.split(":").map(f=>f.trim());c.set(d,h)}),a.forEach(u=>{const[d,h]=u.split(":").map(f=>f.trim());c.set(d,h)}),n[s]=Array.from(c.entries()).map(([u,d])=>`${u}: ${d}`).join("; ")}else n[s]=i}),n},{})}function jn(r,e){return e.filter(t=>t.type===r.type.name).filter(t=>t.attribute.rendered).map(t=>t.attribute.renderHTML?t.attribute.renderHTML(r.attrs)||{}:{[t.name]:r.attrs[t.name]}).reduce((t,n)=>te(t,n),{})}function zv(r){return typeof r!="string"?r:r.match(/^[+-]?(?:\d*\.)?\d+$/)?Number(r):r==="true"?!0:r==="false"?!1:r}function zc(r,e){return"style"in r?r:{...r,getAttrs:t=>{const n=r.getAttrs?r.getAttrs(t):r.attrs;if(n===!1)return!1;const s=e.reduce((i,o)=>{const a=o.attribute.parseHTML?o.attribute.parseHTML(t):zv(t.getAttribute(o.name));return a==null?i:{...i,[o.name]:a}},{});return{...n,...s}}}}function Uc(r){return Object.fromEntries(Object.entries(r).filter(([e,t])=>e==="attrs"&&Bv(t)?!1:t!=null))}function Fc(r){var e,t;const n={};return!((e=r?.attribute)!=null&&e.isRequired)&&"default"in(r?.attribute||{})&&(n.default=r.attribute.default),((t=r?.attribute)==null?void 0:t.validate)!==void 0&&(n.validate=r.attribute.validate),[r.name,n]}function Uv(r,e){var t;const n=bh(r),{nodeExtensions:s,markExtensions:i}=Wr(r),o=(t=s.find(c=>O(c,"topNode")))==null?void 0:t.name,a=Object.fromEntries(s.map(c=>{const u=n.filter(y=>y.type===c.name),d={name:c.name,options:c.options,storage:c.storage,editor:e},h=r.reduce((y,w)=>{const v=O(w,"extendNodeSchema",d);return{...y,...v?v(c):{}}},{}),f=Uc({...h,content:H(O(c,"content",d)),marks:H(O(c,"marks",d)),group:H(O(c,"group",d)),inline:H(O(c,"inline",d)),atom:H(O(c,"atom",d)),selectable:H(O(c,"selectable",d)),draggable:H(O(c,"draggable",d)),code:H(O(c,"code",d)),whitespace:H(O(c,"whitespace",d)),linebreakReplacement:H(O(c,"linebreakReplacement",d)),defining:H(O(c,"defining",d)),isolating:H(O(c,"isolating",d)),attrs:Object.fromEntries(u.map(Fc))}),p=H(O(c,"parseHTML",d));p&&(f.parseDOM=p.map(y=>zc(y,u)));const m=O(c,"renderHTML",d);m&&(f.toDOM=y=>m({node:y,HTMLAttributes:jn(y,u)}));const g=O(c,"renderText",d);return g&&(f.toText=g),[c.name,f]})),l=Object.fromEntries(i.map(c=>{const u=n.filter(g=>g.type===c.name),d={name:c.name,options:c.options,storage:c.storage,editor:e},h=r.reduce((g,y)=>{const w=O(y,"extendMarkSchema",d);return{...g,...w?w(c):{}}},{}),f=Uc({...h,inclusive:H(O(c,"inclusive",d)),excludes:H(O(c,"excludes",d)),group:H(O(c,"group",d)),spanning:H(O(c,"spanning",d)),code:H(O(c,"code",d)),attrs:Object.fromEntries(u.map(Fc))}),p=H(O(c,"parseHTML",d));p&&(f.parseDOM=p.map(g=>zc(g,u)));const m=O(c,"renderHTML",d);return m&&(f.toDOM=g=>m({mark:g,HTMLAttributes:jn(g,u)})),[c.name,f]}));return new Yu({topNode:o,nodes:a,marks:l})}function Fv(r){const e=r.filter((t,n)=>r.indexOf(t)!==n);return Array.from(new Set(e))}function js(r){return r.sort((t,n)=>{const s=O(t,"priority")||100,i=O(n,"priority")||100;return s>i?-1:s<i?1:0})}function wh(r){const e=js(Wa(r)),t=Fv(e.map(n=>n.name));return t.length&&console.warn(`[tiptap warn]: Duplicate extension names found: [${t.map(n=>`'${n}'`).join(", ")}]. This can lead to issues.`),e}function vh(r,e,t){const{from:n,to:s}=e,{blockSeparator:i=`

`,textSerializers:o={}}=t||{};let a="";return r.nodesBetween(n,s,(l,c,u,d)=>{var h;l.isBlock&&c>n&&(a+=i);const f=o?.[l.type.name];if(f)return u&&(a+=f({node:l,pos:c,parent:u,index:d,range:e})),!1;l.isText&&(a+=(h=l?.text)==null?void 0:h.slice(Math.max(n,c)-c,s-c))}),a}function Hv(r,e){const t={from:0,to:r.content.size};return vh(r,t,e)}function kh(r){return Object.fromEntries(Object.entries(r.nodes).filter(([,e])=>e.spec.toText).map(([e,t])=>[e,t.spec.toText]))}function Vv(r,e){const t=oe(e,r.schema),{from:n,to:s}=r.selection,i=[];r.doc.nodesBetween(n,s,a=>{i.push(a)});const o=i.reverse().find(a=>a.type.name===t.name);return o?{...o.attrs}:{}}function Sh(r,e){const t=Ii(typeof e=="string"?e:e.name,r.schema);return t==="node"?Vv(r,e):t==="mark"?mh(r,e):{}}function qv(r,e=JSON.stringify){const t={};return r.filter(n=>{const s=e(n);return Object.prototype.hasOwnProperty.call(t,s)?!1:t[s]=!0})}function Wv(r){const e=qv(r);return e.length===1?e:e.filter((t,n)=>!e.filter((i,o)=>o!==n).some(i=>t.oldRange.from>=i.oldRange.from&&t.oldRange.to<=i.oldRange.to&&t.newRange.from>=i.newRange.from&&t.newRange.to<=i.newRange.to))}function xh(r){const{mapping:e,steps:t}=r,n=[];return e.maps.forEach((s,i)=>{const o=[];if(s.ranges.length)s.forEach((a,l)=>{o.push({from:a,to:l})});else{const{from:a,to:l}=t[i];if(a===void 0||l===void 0)return;o.push({from:a,to:l})}o.forEach(({from:a,to:l})=>{const c=e.slice(i).map(a,-1),u=e.slice(i).map(l),d=e.invert().map(c,-1),h=e.invert().map(u);n.push({oldRange:{from:d,to:h},newRange:{from:c,to:u}})})}),Wv(n)}function Ja(r,e,t){const n=[];return r===e?t.resolve(r).marks().forEach(s=>{const i=t.resolve(r),o=qa(i,s.type);o&&n.push({mark:s,...o})}):t.nodesBetween(r,e,(s,i)=>{!s||s?.nodeSize===void 0||n.push(...s.marks.map(o=>({from:i,to:i+s.nodeSize,mark:o})))}),n}var Kv=(r,e,t,n=20)=>{const s=r.doc.resolve(t);let i=n,o=null;for(;i>0&&o===null;){const a=s.node(i);a?.type.name===e?o=a:i-=1}return[o,i]};function is(r,e){return e.nodes[r]||e.marks[r]||null}function ys(r,e,t){return Object.fromEntries(Object.entries(t).filter(([n])=>{const s=r.find(i=>i.type===e&&i.name===n);return s?s.attribute.keepOnSplit:!1}))}var Jv=(r,e=500)=>{let t="";const n=r.parentOffset;return r.parent.nodesBetween(Math.max(0,n-e),n,(s,i,o,a)=>{var l,c;const u=((c=(l=s.type.spec).toText)==null?void 0:c.call(l,{node:s,pos:i,parent:o,index:a}))||s.textContent||"%leaf%";t+=s.isAtom&&!s.isText?u:u.slice(0,Math.max(0,n-i))}),t};function ra(r,e,t={}){const{empty:n,ranges:s}=r.selection,i=e?vt(e,r.schema):null;if(n)return!!(r.storedMarks||r.selection.$from.marks()).filter(d=>i?i.name===d.type.name:!0).find(d=>$s(d.attrs,t,{strict:!1}));let o=0;const a=[];if(s.forEach(({$from:d,$to:h})=>{const f=d.pos,p=h.pos;r.doc.nodesBetween(f,p,(m,g)=>{if(!m.isText&&!m.marks.length)return;const y=Math.max(f,g),w=Math.min(p,g+m.nodeSize),v=w-y;o+=v,a.push(...m.marks.map(_=>({mark:_,from:y,to:w})))})}),o===0)return!1;const l=a.filter(d=>i?i.name===d.mark.type.name:!0).filter(d=>$s(d.mark.attrs,t,{strict:!1})).reduce((d,h)=>d+h.to-h.from,0),c=a.filter(d=>i?d.mark.type!==i&&d.mark.type.excludes(i):!0).reduce((d,h)=>d+h.to-h.from,0);return(l>0?l+c:l)>=o}function Gv(r,e,t={}){if(!e)return Ft(r,null,t)||ra(r,null,t);const n=Ii(e,r.schema);return n==="node"?Ft(r,e,t):n==="mark"?ra(r,e,t):!1}var Yv=(r,e)=>{const{$from:t,$to:n,$anchor:s}=r.selection;if(e){const i=Ri(a=>a.type.name===e)(r.selection);if(!i)return!1;const o=r.doc.resolve(i.pos+1);return s.pos+1===o.end()}return!(n.parentOffset<n.parent.nodeSize-2||t.pos!==n.pos)},Qv=r=>{const{$from:e,$to:t}=r.selection;return!(e.parentOffset>0||e.pos!==t.pos)};function Hc(r,e){return Array.isArray(e)?e.some(t=>(typeof t=="string"?t:t.name)===r.name):e}function Vc(r,e){const{nodeExtensions:t}=Wr(e),n=t.find(o=>o.name===r);if(!n)return!1;const s={name:n.name,options:n.options,storage:n.storage},i=H(O(n,"group",s));return typeof i!="string"?!1:i.split(" ").includes("list")}function Ni(r,{checkChildren:e=!0,ignoreWhitespace:t=!1}={}){var n;if(t){if(r.type.name==="hardBreak")return!0;if(r.isText)return/^\s*$/m.test((n=r.text)!=null?n:"")}if(r.isText)return!r.text;if(r.isAtom||r.isLeaf)return!1;if(r.content.childCount===0)return!0;if(e){let s=!0;return r.content.forEach(i=>{s!==!1&&(Ni(i,{ignoreWhitespace:t,checkChildren:e})||(s=!1))}),s}return!1}function Th(r){return r instanceof M}var _h=class Eh{constructor(e){this.position=e}static fromJSON(e){return new Eh(e.position)}toJSON(){return{position:this.position}}};function Xv(r,e){const t=e.mapping.mapResult(r.position);return{position:new _h(t.pos),mapResult:t}}function Zv(r){return new _h(r)}function e0(r,e,t){var n;const{selection:s}=e;let i=null;if(dh(s)&&(i=s.$cursor),i){const a=(n=r.storedMarks)!=null?n:i.marks();return i.parent.type.allowsMarkType(t)&&(!!t.isInSet(a)||!a.some(c=>c.type.excludes(t)))}const{ranges:o}=s;return o.some(({$from:a,$to:l})=>{let c=a.depth===0?r.doc.inlineContent&&r.doc.type.allowsMarkType(t):!1;return r.doc.nodesBetween(a.pos,l.pos,(u,d,h)=>{if(c)return!1;if(u.isInline){const f=!h||h.type.allowsMarkType(t),p=!!t.isInSet(u.marks)||!u.marks.some(m=>m.type.excludes(t));c=f&&p}return!c}),c})}var t0=(r,e={})=>({tr:t,state:n,dispatch:s})=>{const{selection:i}=t,{empty:o,ranges:a}=i,l=vt(r,n.schema);if(s)if(o){const c=mh(n,l);t.addStoredMark(l.create({...c,...e}))}else a.forEach(c=>{const u=c.$from.pos,d=c.$to.pos;n.doc.nodesBetween(u,d,(h,f)=>{const p=Math.max(f,u),m=Math.min(f+h.nodeSize,d);h.marks.find(y=>y.type===l)?h.marks.forEach(y=>{l===y.type&&t.addMark(p,m,l.create({...y.attrs,...e}))}):t.addMark(p,m,l.create(e))})});return e0(n,t,l)},r0=(r,e)=>({tr:t})=>(t.setMeta(r,e),!0),n0=(r,e={})=>({state:t,dispatch:n,chain:s})=>{const i=oe(r,t.schema);let o;return t.selection.$anchor.sameParent(t.selection.$head)&&(o=t.selection.$anchor.parent.attrs),i.isTextblock?s().command(({commands:a})=>nc(i,{...o,...e})(t)?!0:a.clearNodes()).command(({state:a})=>nc(i,{...o,...e})(a,n)).run():(console.warn('[tiptap warn]: Currently "setNode()" only supports text block nodes.'),!1)},s0=r=>({tr:e,dispatch:t})=>{if(t){const{doc:n}=e,s=sr(r,0,n.content.size),i=M.create(n,s);e.setSelection(i)}return!0},i0=(r,e)=>({tr:t,state:n,dispatch:s})=>{const{selection:i}=n;let o,a;return typeof e=="number"?(o=e,a=e):e&&"from"in e&&"to"in e?(o=e.from,a=e.to):(o=i.from,a=i.to),s&&t.doc.nodesBetween(o,a,(l,c)=>{l.isText||t.setNodeMarkup(c,void 0,{...l.attrs,dir:r})}),!0},o0=r=>({tr:e,dispatch:t})=>{if(t){const{doc:n}=e,{from:s,to:i}=typeof r=="number"?{from:r,to:r}:r,o=D.atStart(n).from,a=D.atEnd(n).to,l=sr(s,o,a),c=sr(i,o,a),u=D.create(n,l,c);e.setSelection(u)}return!0},a0=r=>({state:e,dispatch:t})=>{const n=oe(r,e.schema);return tb(n)(e,t)};function qc(r,e){const t=r.storedMarks||r.selection.$to.parentOffset&&r.selection.$from.marks();if(t){const n=t.filter(s=>e?.includes(s.type.name));r.tr.ensureMarks(n)}}var l0=({keepMarks:r=!0}={})=>({tr:e,state:t,dispatch:n,editor:s})=>{const{selection:i,doc:o}=e,{$from:a,$to:l}=i,c=s.extensionManager.attributes,u=ys(c,a.node().type.name,a.node().attrs);if(i instanceof M&&i.node.isBlock)return!a.parentOffset||!gt(o,a.pos)?!1:(n&&(r&&qc(t,s.extensionManager.splittableMarks),e.split(a.pos).scrollIntoView()),!0);if(!a.parent.isBlock)return!1;const d=l.parentOffset===l.parent.content.size,h=a.depth===0?void 0:$v(a.node(-1).contentMatchAt(a.indexAfter(-1)));let f=d&&h?[{type:h,attrs:u}]:void 0,p=gt(e.doc,e.mapping.map(a.pos),1,f);if(!f&&!p&&gt(e.doc,e.mapping.map(a.pos),1,h?[{type:h}]:void 0)&&(p=!0,f=h?[{type:h,attrs:u}]:void 0),n){if(p&&(i instanceof D&&e.deleteSelection(),e.split(e.mapping.map(a.pos),1,f),h&&!d&&!a.parentOffset&&a.parent.type!==h)){const m=e.mapping.map(a.before()),g=e.doc.resolve(m);a.node(-1).canReplaceWith(g.index(),g.index()+1,h)&&e.setNodeMarkup(e.mapping.map(a.before()),h)}r&&qc(t,s.extensionManager.splittableMarks),e.scrollIntoView()}return p},c0=(r,e={})=>({tr:t,state:n,dispatch:s,editor:i})=>{var o;const a=oe(r,n.schema),{$from:l,$to:c}=n.selection,u=n.selection.node;if(u&&u.isBlock||l.depth<2||!l.sameParent(c))return!1;const d=l.node(-1);if(d.type!==a)return!1;const h=i.extensionManager.attributes;if(l.parent.content.size===0&&l.node(-1).childCount===l.indexAfter(-1)){if(l.depth===2||l.node(-3).type!==a||l.index(-2)!==l.node(-2).childCount-1)return!1;if(s){let y=k.empty;const w=l.index(-1)?1:l.index(-2)?2:3;for(let I=l.depth-w;I>=l.depth-3;I-=1)y=k.from(l.node(I).copy(y));const v=l.indexAfter(-1)<l.node(-2).childCount?1:l.indexAfter(-2)<l.node(-3).childCount?2:3,_={...ys(h,l.node().type.name,l.node().attrs),...e},E=((o=a.contentMatch.defaultType)==null?void 0:o.createAndFill(_))||void 0;y=y.append(k.from(a.createAndFill(null,E)||void 0));const S=l.before(l.depth-(w-1));t.replace(S,l.after(-v),new C(y,4-w,0));let x=-1;t.doc.nodesBetween(S,t.doc.content.size,(I,$)=>{if(x>-1)return!1;I.isTextblock&&I.content.size===0&&(x=$+1)}),x>-1&&t.setSelection(D.near(t.doc.resolve(x))),t.scrollIntoView()}return!0}const f=c.pos===l.end()?d.contentMatchAt(0).defaultType:null,p={...ys(h,d.type.name,d.attrs),...e},m={...ys(h,l.node().type.name,l.node().attrs),...e};t.delete(l.pos,c.pos);const g=f?[{type:a,attrs:p},{type:f,attrs:m}]:[{type:a,attrs:p}];if(!gt(t.doc,l.pos,2))return!1;if(s){const{selection:y,storedMarks:w}=n,{splittableMarks:v}=i.extensionManager,_=w||y.$to.parentOffset&&y.$from.marks();if(t.split(l.pos,2,g).scrollIntoView(),!_||!s)return!0;const E=_.filter(S=>v.includes(S.type.name));t.ensureMarks(E)}return!0},co=(r,e)=>{const t=Ri(o=>o.type===e)(r.selection);if(!t)return!0;const n=r.doc.resolve(Math.max(0,t.pos-1)).before(t.depth);if(n===void 0)return!0;const s=r.doc.nodeAt(n);return t.node.type===s?.type&&qt(r.doc,t.pos)&&r.join(t.pos),!0},uo=(r,e)=>{const t=Ri(o=>o.type===e)(r.selection);if(!t)return!0;const n=r.doc.resolve(t.start).after(t.depth);if(n===void 0)return!0;const s=r.doc.nodeAt(n);return t.node.type===s?.type&&qt(r.doc,n)&&r.join(n),!0},u0=(r,e,t,n={})=>({editor:s,tr:i,state:o,dispatch:a,chain:l,commands:c,can:u})=>{const{extensions:d,splittableMarks:h}=s.extensionManager,f=oe(r,o.schema),p=oe(e,o.schema),{selection:m,storedMarks:g}=o,{$from:y,$to:w}=m,v=y.blockRange(w),_=g||m.$to.parentOffset&&m.$from.marks();if(!v)return!1;const E=Ri(S=>Vc(S.type.name,d))(m);if(v.depth>=1&&E&&v.depth-E.depth<=1){if(E.node.type===f)return c.liftListItem(p);if(Vc(E.node.type.name,d)&&f.validContent(E.node.content)&&a)return l().command(()=>(i.setNodeMarkup(E.pos,f),!0)).command(()=>co(i,f)).command(()=>uo(i,f)).run()}return!t||!_||!a?l().command(()=>u().wrapInList(f,n)?!0:c.clearNodes()).wrapInList(f,n).command(()=>co(i,f)).command(()=>uo(i,f)).run():l().command(()=>{const S=u().wrapInList(f,n),x=_.filter(I=>h.includes(I.type.name));return i.ensureMarks(x),S?!0:c.clearNodes()}).wrapInList(f,n).command(()=>co(i,f)).command(()=>uo(i,f)).run()},d0=(r,e={},t={})=>({state:n,commands:s})=>{const{extendEmptyMarkRange:i=!1}=t,o=vt(r,n.schema);return ra(n,o,e)?s.unsetMark(o,{extendEmptyMarkRange:i}):s.setMark(o,e)},h0=(r,e,t={})=>({state:n,commands:s})=>{const i=oe(r,n.schema),o=oe(e,n.schema),a=Ft(n,i,t);let l;return n.selection.$anchor.sameParent(n.selection.$head)&&(l=n.selection.$anchor.parent.attrs),a?s.setNode(o,l):s.setNode(i,{...l,...t})},f0=(r,e={})=>({state:t,commands:n})=>{const s=oe(r,t.schema);return Ft(t,s,e)?n.lift(s):n.wrapIn(s,e)},p0=()=>({state:r,dispatch:e})=>{const t=r.plugins;for(let n=0;n<t.length;n+=1){const s=t[n];let i;if(s.spec.isInputRules&&(i=s.getState(r))){if(e){const o=r.tr,a=i.transform;for(let l=a.steps.length-1;l>=0;l-=1)o.step(a.steps[l].invert(a.docs[l]));if(i.text){const l=o.doc.resolve(i.from).marks();o.replaceWith(i.from,i.to,r.schema.text(i.text,l))}else o.delete(i.from,i.to)}return!0}}return!1},m0=()=>({tr:r,dispatch:e})=>{const{selection:t}=r,{empty:n,ranges:s}=t;return n||e&&s.forEach(i=>{r.removeMark(i.$from.pos,i.$to.pos)}),!0},g0=(r,e={})=>({tr:t,state:n,dispatch:s})=>{var i;const{extendEmptyMarkRange:o=!1}=e,{selection:a}=t,l=vt(r,n.schema),{$from:c,empty:u,ranges:d}=a;if(!s)return!0;if(u&&o){let{from:h,to:f}=a;const p=(i=c.marks().find(g=>g.type===l))==null?void 0:i.attrs,m=qa(c,l,p);m&&(h=m.from,f=m.to),t.removeMark(h,f,l)}else d.forEach(h=>{t.removeMark(h.$from.pos,h.$to.pos,l)});return t.removeStoredMark(l),!0},y0=r=>({tr:e,state:t,dispatch:n})=>{const{selection:s}=t;let i,o;return typeof r=="number"?(i=r,o=r):r&&"from"in r&&"to"in r?(i=r.from,o=r.to):(i=s.from,o=s.to),n&&e.doc.nodesBetween(i,o,(a,l)=>{if(a.isText)return;const c={...a.attrs};delete c.dir,e.setNodeMarkup(l,void 0,c)}),!0},b0=(r,e={})=>({tr:t,state:n,dispatch:s})=>{let i=null,o=null;const a=Ii(typeof r=="string"?r:r.name,n.schema);if(!a)return!1;a==="node"&&(i=oe(r,n.schema)),a==="mark"&&(o=vt(r,n.schema));let l=!1;return t.selection.ranges.forEach(c=>{const u=c.$from.pos,d=c.$to.pos;let h,f,p,m;t.selection.empty?n.doc.nodesBetween(u,d,(g,y)=>{i&&i===g.type&&(l=!0,p=Math.max(y,u),m=Math.min(y+g.nodeSize,d),h=y,f=g)}):n.doc.nodesBetween(u,d,(g,y)=>{y<u&&i&&i===g.type&&(l=!0,p=Math.max(y,u),m=Math.min(y+g.nodeSize,d),h=y,f=g),y>=u&&y<=d&&(i&&i===g.type&&(l=!0,s&&t.setNodeMarkup(y,void 0,{...g.attrs,...e})),o&&g.marks.length&&g.marks.forEach(w=>{if(o===w.type&&(l=!0,s)){const v=Math.max(y,u),_=Math.min(y+g.nodeSize,d);t.addMark(v,_,o.create({...w.attrs,...e}))}}))}),f&&(h!==void 0&&s&&t.setNodeMarkup(h,void 0,{...f.attrs,...e}),o&&f.marks.length&&f.marks.forEach(g=>{o===g.type&&s&&t.addMark(p,m,o.create({...g.attrs,...e}))}))}),l},w0=(r,e={})=>({state:t,dispatch:n})=>{const s=oe(r,t.schema);return Jy(s,e)(t,n)},v0=(r,e={})=>({state:t,dispatch:n})=>{const s=oe(r,t.schema);return Gy(s,e)(t,n)},k0=class{constructor(){this.callbacks={}}on(r,e){return this.callbacks[r]||(this.callbacks[r]=[]),this.callbacks[r].push(e),this}emit(r,...e){const t=this.callbacks[r];return t&&t.forEach(n=>n.apply(this,e)),this}off(r,e){const t=this.callbacks[r];return t&&(e?this.callbacks[r]=t.filter(n=>n!==e):delete this.callbacks[r]),this}once(r,e){const t=(...n)=>{this.off(r,t),e.apply(this,n)};return this.on(r,t)}removeAllListeners(){this.callbacks={}}},Pi=class{constructor(r){var e;this.find=r.find,this.handler=r.handler,this.undoable=(e=r.undoable)!=null?e:!0}},S0=(r,e)=>{if(Va(e))return e.exec(r);const t=e(r);if(!t)return null;const n=[t.text];return n.index=t.index,n.input=r,n.data=t.data,t.replaceWith&&(t.text.includes(t.replaceWith)||console.warn('[tiptap warn]: "inputRuleMatch.replaceWith" must be part of "inputRuleMatch.text".'),n.push(t.replaceWith)),n};function as(r){var e;const{editor:t,from:n,to:s,text:i,rules:o,plugin:a}=r,{view:l}=t;if(l.composing)return!1;const c=l.state.doc.resolve(n);if(c.parent.type.spec.code||(e=c.nodeBefore||c.nodeAfter)!=null&&e.marks.find(h=>h.type.spec.code))return!1;let u=!1;const d=Jv(c)+i;return o.forEach(h=>{if(u)return;const f=S0(d,h.find);if(!f)return;const p=l.state.tr,m=Oi({state:l.state,transaction:p}),g={from:n-(f[0].length-i.length),to:s},{commands:y,chain:w,can:v}=new Mi({editor:t,state:m});h.handler({state:m,range:g,match:f,commands:y,chain:w,can:v})===null||!p.steps.length||(h.undoable&&p.setMeta(a,{transform:p,from:n,to:s,text:i}),l.dispatch(p),u=!0)}),u}function x0(r){const{editor:e,rules:t}=r,n=new K({state:{init(){return null},apply(s,i,o){const a=s.getMeta(n);if(a)return a;const l=s.getMeta("applyInputRules");return l&&setTimeout(()=>{let{text:u}=l;typeof u=="string"?u=u:u=Ka(k.from(u),o.schema);const{from:d}=l,h=d+u.length;as({editor:e,from:d,to:h,text:u,rules:t,plugin:n})}),s.selectionSet||s.docChanged?null:i}},props:{handleTextInput(s,i,o,a){return as({editor:e,from:i,to:o,text:a,rules:t,plugin:n})},handleDOMEvents:{compositionend:s=>(setTimeout(()=>{const{$cursor:i}=s.state.selection;i&&as({editor:e,from:i.pos,to:i.pos,text:"",rules:t,plugin:n})}),!1)},handleKeyDown(s,i){if(i.key!=="Enter")return!1;const{$cursor:o}=s.state.selection;return o?as({editor:e,from:o.pos,to:o.pos,text:`
`,rules:t,plugin:n}):!1}},isInputRules:!0});return n}function T0(r){return Object.prototype.toString.call(r).slice(8,-1)}function ls(r){return T0(r)!=="Object"?!1:r.constructor===Object&&Object.getPrototypeOf(r)===Object.prototype}function Ch(r,e){const t={...r};return ls(r)&&ls(e)&&Object.keys(e).forEach(n=>{ls(e[n])&&ls(r[n])?t[n]=Ch(r[n],e[n]):t[n]=e[n]}),t}var Ga=class{constructor(r={}){this.type="extendable",this.parent=null,this.child=null,this.name="",this.config={name:this.name},this.config={...this.config,...r},this.name=this.config.name}get options(){return{...H(O(this,"addOptions",{name:this.name}))||{}}}get storage(){return{...H(O(this,"addStorage",{name:this.name,options:this.options}))||{}}}configure(r={}){const e=this.extend({...this.config,addOptions:()=>Ch(this.options,r)});return e.name=this.name,e.parent=this.parent,e}extend(r={}){const e=new this.constructor({...this.config,...r});return e.parent=this,this.child=e,e.name="name"in r?r.name:e.parent.name,e}},kt=class Ah extends Ga{constructor(){super(...arguments),this.type="mark"}static create(e={}){const t=typeof e=="function"?e():e;return new Ah(t)}static handleExit({editor:e,mark:t}){const{tr:n}=e.state,s=e.state.selection.$from;if(s.pos===s.end()){const o=s.marks();if(!!!o.find(c=>c?.type.name===t.name))return!1;const l=o.find(c=>c?.type.name===t.name);return l&&n.removeStoredMark(l),n.insertText(" ",s.pos),e.view.dispatch(n),!0}return!1}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}};function _0(r){return typeof r=="number"}var E0=class{constructor(r){this.find=r.find,this.handler=r.handler}},C0=(r,e,t)=>{if(Va(e))return[...r.matchAll(e)];const n=e(r,t);return n?n.map(s=>{const i=[s.text];return i.index=s.index,i.input=r,i.data=s.data,s.replaceWith&&(s.text.includes(s.replaceWith)||console.warn('[tiptap warn]: "pasteRuleMatch.replaceWith" must be part of "pasteRuleMatch.text".'),i.push(s.replaceWith)),i}):[]};function A0(r){const{editor:e,state:t,from:n,to:s,rule:i,pasteEvent:o,dropEvent:a}=r,{commands:l,chain:c,can:u}=new Mi({editor:e,state:t}),d=[];return t.doc.nodesBetween(n,s,(f,p)=>{var m,g,y,w,v;if((g=(m=f.type)==null?void 0:m.spec)!=null&&g.code||!(f.isText||f.isTextblock||f.isInline))return;const _=(v=(w=(y=f.content)==null?void 0:y.size)!=null?w:f.nodeSize)!=null?v:0,E=Math.max(n,p),S=Math.min(s,p+_);if(E>=S)return;const x=f.isText?f.text||"":f.textBetween(E-p,S-p,void 0,"");C0(x,i.find,o).forEach($=>{if($.index===void 0)return;const G=E+$.index+1,Re=G+$[0].length,je={from:t.tr.mapping.map(G),to:t.tr.mapping.map(Re)},tt=i.handler({state:t,range:je,match:$,commands:l,chain:c,can:u,pasteEvent:o,dropEvent:a});d.push(tt)})}),d.every(f=>f!==null)}var cs=null,O0=r=>{var e;const t=new ClipboardEvent("paste",{clipboardData:new DataTransfer});return(e=t.clipboardData)==null||e.setData("text/html",r),t};function M0(r){const{editor:e,rules:t}=r;let n=null,s=!1,i=!1,o=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,a;try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}const l=({state:u,from:d,to:h,rule:f,pasteEvt:p})=>{const m=u.tr,g=Oi({state:u,transaction:m});if(!(!A0({editor:e,state:g,from:Math.max(d-1,0),to:h.b-1,rule:f,pasteEvent:p,dropEvent:a})||!m.steps.length)){try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}return o=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,m}};return t.map(u=>new K({view(d){const h=p=>{var m;n=(m=d.dom.parentElement)!=null&&m.contains(p.target)?d.dom.parentElement:null,n&&(cs=e)},f=()=>{cs&&(cs=null)};return window.addEventListener("dragstart",h),window.addEventListener("dragend",f),{destroy(){window.removeEventListener("dragstart",h),window.removeEventListener("dragend",f)}}},props:{handleDOMEvents:{drop:(d,h)=>{if(i=n===d.dom.parentElement,a=h,!i){const f=cs;f?.isEditable&&setTimeout(()=>{const p=f.state.selection;p&&f.commands.deleteRange({from:p.from,to:p.to})},10)}return!1},paste:(d,h)=>{var f;const p=(f=h.clipboardData)==null?void 0:f.getData("text/html");return o=h,s=!!p?.includes("data-pm-slice"),!1}}},appendTransaction:(d,h,f)=>{const p=d[0],m=p.getMeta("uiEvent")==="paste"&&!s,g=p.getMeta("uiEvent")==="drop"&&!i,y=p.getMeta("applyPasteRules"),w=!!y;if(!m&&!g&&!w)return;if(w){let{text:E}=y;typeof E=="string"?E=E:E=Ka(k.from(E),f.schema);const{from:S}=y,x=S+E.length,I=O0(E);return l({rule:u,state:f,from:S,to:{b:x},pasteEvt:I})}const v=h.doc.content.findDiffStart(f.doc.content),_=h.doc.content.findDiffEnd(f.doc.content);if(!(!_0(v)||!_||v===_.b))return l({rule:u,state:f,from:v,to:_,pasteEvt:o})}}))}var Di=class{constructor(r,e){this.splittableMarks=[],this.editor=e,this.baseExtensions=r,this.extensions=wh(r),this.schema=Uv(this.extensions,e),this.setupExtensions()}get commands(){return this.extensions.reduce((r,e)=>{const t={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:is(e.name,this.schema)},n=O(e,"addCommands",t);return n?{...r,...n()}:r},{})}get plugins(){const{editor:r}=this;return js([...this.extensions].reverse()).flatMap(n=>{const s={name:n.name,options:n.options,storage:this.editor.extensionStorage[n.name],editor:r,type:is(n.name,this.schema)},i=[],o=O(n,"addKeyboardShortcuts",s);let a={};if(n.type==="mark"&&O(n,"exitable",s)&&(a.ArrowRight=()=>kt.handleExit({editor:r,mark:n})),o){const h=Object.fromEntries(Object.entries(o()).map(([f,p])=>[f,()=>p({editor:r})]));a={...a,...h}}const l=Vw(a);i.push(l);const c=O(n,"addInputRules",s);if(Hc(n,r.options.enableInputRules)&&c){const h=c();if(h&&h.length){const f=x0({editor:r,rules:h}),p=Array.isArray(f)?f:[f];i.push(...p)}}const u=O(n,"addPasteRules",s);if(Hc(n,r.options.enablePasteRules)&&u){const h=u();if(h&&h.length){const f=M0({editor:r,rules:h});i.push(...f)}}const d=O(n,"addProseMirrorPlugins",s);if(d){const h=d();i.push(...h)}return i})}get attributes(){return bh(this.extensions)}get nodeViews(){const{editor:r}=this,{nodeExtensions:e}=Wr(this.extensions);return Object.fromEntries(e.filter(t=>!!O(t,"addNodeView")).map(t=>{const n=this.attributes.filter(l=>l.type===t.name),s={name:t.name,options:t.options,storage:this.editor.extensionStorage[t.name],editor:r,type:oe(t.name,this.schema)},i=O(t,"addNodeView",s);if(!i)return[];const o=i();if(!o)return[];const a=(l,c,u,d,h)=>{const f=jn(l,n);return o({node:l,view:c,getPos:u,decorations:d,innerDecorations:h,editor:r,extension:t,HTMLAttributes:f})};return[t.name,a]}))}dispatchTransaction(r){const{editor:e}=this;return js([...this.extensions].reverse()).reduceRight((n,s)=>{const i={name:s.name,options:s.options,storage:this.editor.extensionStorage[s.name],editor:e,type:is(s.name,this.schema)},o=O(s,"dispatchTransaction",i);return o?a=>{o.call(i,{transaction:a,next:n})}:n},r)}get markViews(){const{editor:r}=this,{markExtensions:e}=Wr(this.extensions);return Object.fromEntries(e.filter(t=>!!O(t,"addMarkView")).map(t=>{const n=this.attributes.filter(a=>a.type===t.name),s={name:t.name,options:t.options,storage:this.editor.extensionStorage[t.name],editor:r,type:vt(t.name,this.schema)},i=O(t,"addMarkView",s);if(!i)return[];const o=(a,l,c)=>{const u=jn(a,n);return i()({mark:a,view:l,inline:c,editor:r,extension:t,HTMLAttributes:u,updateAttributes:d=>{V0(a,r,d)}})};return[t.name,o]}))}setupExtensions(){const r=this.extensions;this.editor.extensionStorage=Object.fromEntries(r.map(e=>[e.name,e.storage])),r.forEach(e=>{var t;const n={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:is(e.name,this.schema)};e.type==="mark"&&((t=H(O(e,"keepOnSplit",n)))==null||t)&&this.splittableMarks.push(e.name);const s=O(e,"onBeforeCreate",n),i=O(e,"onCreate",n),o=O(e,"onUpdate",n),a=O(e,"onSelectionUpdate",n),l=O(e,"onTransaction",n),c=O(e,"onFocus",n),u=O(e,"onBlur",n),d=O(e,"onDestroy",n);s&&this.editor.on("beforeCreate",s),i&&this.editor.on("create",i),o&&this.editor.on("update",o),a&&this.editor.on("selectionUpdate",a),l&&this.editor.on("transaction",l),c&&this.editor.on("focus",c),u&&this.editor.on("blur",u),d&&this.editor.on("destroy",d)})}};Di.resolve=wh;Di.sort=js;Di.flatten=Wa;var I0={};Ha(I0,{ClipboardTextSerializer:()=>Mh,Commands:()=>Ih,Delete:()=>Rh,Drop:()=>Nh,Editable:()=>Ph,FocusEvents:()=>$h,Keymap:()=>Lh,Paste:()=>jh,Tabindex:()=>Bh,TextDirection:()=>zh,focusEventsPluginKey:()=>Dh});var F=class Oh extends Ga{constructor(){super(...arguments),this.type="extension"}static create(e={}){const t=typeof e=="function"?e():e;return new Oh(t)}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}},Mh=F.create({name:"clipboardTextSerializer",addOptions(){return{blockSeparator:void 0}},addProseMirrorPlugins(){return[new K({key:new ne("clipboardTextSerializer"),props:{clipboardTextSerializer:()=>{const{editor:r}=this,{state:e,schema:t}=r,{doc:n,selection:s}=e,{ranges:i}=s,o=Math.min(...i.map(u=>u.$from.pos)),a=Math.max(...i.map(u=>u.$to.pos)),l=kh(t);return vh(n,{from:o,to:a},{...this.options.blockSeparator!==void 0?{blockSeparator:this.options.blockSeparator}:{},textSerializers:l})}}})]}}),Ih=F.create({name:"commands",addCommands(){return{...ch}}}),Rh=F.create({name:"delete",onUpdate({transaction:r,appendedTransactions:e}){var t,n,s;const i=()=>{var o,a,l,c;if((c=(l=(a=(o=this.editor.options.coreExtensionOptions)==null?void 0:o.delete)==null?void 0:a.filterTransaction)==null?void 0:l.call(a,r))!=null?c:r.getMeta("y-sync$"))return;const u=gh(r.before,[r,...e]);xh(u).forEach(f=>{u.mapping.mapResult(f.oldRange.from).deletedAfter&&u.mapping.mapResult(f.oldRange.to).deletedBefore&&u.before.nodesBetween(f.oldRange.from,f.oldRange.to,(p,m)=>{const g=m+p.nodeSize-2,y=f.oldRange.from<=m&&g<=f.oldRange.to;this.editor.emit("delete",{type:"node",node:p,from:m,to:g,newFrom:u.mapping.map(m),newTo:u.mapping.map(g),deletedRange:f.oldRange,newRange:f.newRange,partial:!y,editor:this.editor,transaction:r,combinedTransform:u})})});const h=u.mapping;u.steps.forEach((f,p)=>{var m,g;if(f instanceof Xe){const y=h.slice(p).map(f.from,-1),w=h.slice(p).map(f.to),v=h.invert().map(y,-1),_=h.invert().map(w),E=(m=u.doc.nodeAt(y-1))==null?void 0:m.marks.some(x=>x.eq(f.mark)),S=(g=u.doc.nodeAt(w))==null?void 0:g.marks.some(x=>x.eq(f.mark));this.editor.emit("delete",{type:"mark",mark:f.mark,from:f.from,to:f.to,deletedRange:{from:v,to:_},newRange:{from:y,to:w},partial:!!(S||E),editor:this.editor,transaction:r,combinedTransform:u})}})};(s=(n=(t=this.editor.options.coreExtensionOptions)==null?void 0:t.delete)==null?void 0:n.async)==null||s?setTimeout(i,0):i()}}),Nh=F.create({name:"drop",addProseMirrorPlugins(){return[new K({key:new ne("tiptapDrop"),props:{handleDrop:(r,e,t,n)=>{this.editor.emit("drop",{editor:this.editor,event:e,slice:t,moved:n})}}})]}}),Ph=F.create({name:"editable",addProseMirrorPlugins(){return[new K({key:new ne("editable"),props:{editable:()=>this.editor.options.editable}})]}}),Dh=new ne("focusEvents"),$h=F.create({name:"focusEvents",addProseMirrorPlugins(){const{editor:r}=this;return[new K({key:Dh,props:{handleDOMEvents:{focus:(e,t)=>{r.isFocused=!0;const n=r.state.tr.setMeta("focus",{event:t}).setMeta("addToHistory",!1);return e.dispatch(n),!1},blur:(e,t)=>{r.isFocused=!1;const n=r.state.tr.setMeta("blur",{event:t}).setMeta("addToHistory",!1);return e.dispatch(n),!1}}}})]}}),Lh=F.create({name:"keymap",addKeyboardShortcuts(){const r=()=>this.editor.commands.first(({commands:o})=>[()=>o.undoInputRule(),()=>o.command(({tr:a})=>{const{selection:l,doc:c}=a,{empty:u,$anchor:d}=l,{pos:h,parent:f}=d,p=d.parent.isTextblock&&h>0?a.doc.resolve(h-1):d,m=p.parent.type.spec.isolating,g=d.pos-d.parentOffset,y=m&&p.parent.childCount===1?g===d.pos:z.atStart(c).from===h;return!u||!f.type.isTextblock||f.textContent.length||!y||y&&d.parent.type.name==="paragraph"?!1:o.clearNodes()}),()=>o.deleteSelection(),()=>o.joinBackward(),()=>o.selectNodeBackward()]),e=()=>this.editor.commands.first(({commands:o})=>[()=>o.deleteSelection(),()=>o.deleteCurrentNode(),()=>o.joinForward(),()=>o.selectNodeForward()]),n={Enter:()=>this.editor.commands.first(({commands:o})=>[()=>o.newlineInCode(),()=>o.createParagraphNear(),()=>o.liftEmptyBlock(),()=>o.splitBlock()]),"Mod-Enter":()=>this.editor.commands.exitCode(),Backspace:r,"Mod-Backspace":r,"Shift-Backspace":r,Delete:e,"Mod-Delete":e,"Mod-a":()=>this.editor.commands.selectAll()},s={...n},i={...n,"Ctrl-h":r,"Alt-Backspace":r,"Ctrl-d":e,"Ctrl-Alt-Backspace":e,"Alt-Delete":e,"Alt-d":e,"Ctrl-a":()=>this.editor.commands.selectTextblockStart(),"Ctrl-e":()=>this.editor.commands.selectTextblockEnd()};return Ls()||ph()?i:s},addProseMirrorPlugins(){return[new K({key:new ne("clearDocument"),appendTransaction:(r,e,t)=>{if(r.some(m=>m.getMeta("composition")))return;const n=r.some(m=>m.docChanged)&&!e.doc.eq(t.doc),s=r.some(m=>m.getMeta("preventClearDocument"));if(!n||s)return;const{empty:i,from:o,to:a}=e.selection,l=z.atStart(e.doc).from,c=z.atEnd(e.doc).to;if(i||!(o===l&&a===c)||!Ni(t.doc))return;const h=t.tr,f=Oi({state:t,transaction:h}),{commands:p}=new Mi({editor:this.editor,state:f});if(p.clearNodes(),!!h.steps.length)return h}})]}}),jh=F.create({name:"paste",addProseMirrorPlugins(){return[new K({key:new ne("tiptapPaste"),props:{handlePaste:(r,e,t)=>{this.editor.emit("paste",{editor:this.editor,event:e,slice:t})}}})]}}),Bh=F.create({name:"tabindex",addProseMirrorPlugins(){return[new K({key:new ne("tabindex"),props:{attributes:()=>this.editor.isEditable?{tabindex:"0"}:{}}})]}}),zh=F.create({name:"textDirection",addOptions(){return{direction:void 0}},addGlobalAttributes(){if(!this.options.direction)return[];const{nodeExtensions:r}=Wr(this.extensions);return[{types:r.filter(e=>e.name!=="text").map(e=>e.name),attributes:{dir:{default:this.options.direction,parseHTML:e=>{const t=e.getAttribute("dir");return t&&(t==="ltr"||t==="rtl"||t==="auto")?t:this.options.direction},renderHTML:e=>e.dir?{dir:e.dir}:{}}}}]},addProseMirrorPlugins(){return[new K({key:new ne("textDirection"),props:{attributes:()=>{const r=this.options.direction;return r?{dir:r}:{}}}})]}}),R0=class Pr{constructor(e,t,n=!1,s=null){this.currentNode=null,this.actualDepth=null,this.isBlock=n,this.resolvedPos=e,this.editor=t,this.currentNode=s}get name(){return this.node.type.name}get node(){return this.currentNode||this.resolvedPos.node()}get element(){return this.editor.view.domAtPos(this.pos).node}get depth(){var e;return(e=this.actualDepth)!=null?e:this.resolvedPos.depth}get pos(){return this.resolvedPos.pos}get content(){return this.node.content}set content(e){let t=this.from,n=this.to;if(this.isBlock){if(this.content.size===0){console.error(`You cant set content on a block node. Tried to set content on ${this.name} at ${this.pos}`);return}t=this.from+1,n=this.to-1}this.editor.commands.insertContentAt({from:t,to:n},e)}get attributes(){return this.node.attrs}get textContent(){return this.node.textContent}get size(){return this.node.nodeSize}get from(){return this.isBlock?this.pos:this.resolvedPos.start(this.resolvedPos.depth)}get range(){return{from:this.from,to:this.to}}get to(){return this.isBlock?this.pos+this.size:this.resolvedPos.end(this.resolvedPos.depth)+(this.node.isText?0:1)}get parent(){if(this.depth===0)return null;const e=this.resolvedPos.start(this.resolvedPos.depth-1),t=this.resolvedPos.doc.resolve(e);return new Pr(t,this.editor)}get before(){let e=this.resolvedPos.doc.resolve(this.from-(this.isBlock?1:2));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.from-3)),new Pr(e,this.editor)}get after(){let e=this.resolvedPos.doc.resolve(this.to+(this.isBlock?2:1));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.to+3)),new Pr(e,this.editor)}get children(){const e=[];return this.node.content.forEach((t,n)=>{const s=t.isBlock&&!t.isTextblock,i=t.isAtom&&!t.isText,o=this.pos+n+(i?0:1);if(o<0||o>this.resolvedPos.doc.nodeSize-2)return;const a=this.resolvedPos.doc.resolve(o);if(!s&&a.depth<=this.depth)return;const l=new Pr(a,this.editor,s,s?t:null);s&&(l.actualDepth=this.depth+1),e.push(new Pr(a,this.editor,s,s?t:null))}),e}get firstChild(){return this.children[0]||null}get lastChild(){const e=this.children;return e[e.length-1]||null}closest(e,t={}){let n=null,s=this.parent;for(;s&&!n;){if(s.node.type.name===e)if(Object.keys(t).length>0){const i=s.node.attrs,o=Object.keys(t);for(let a=0;a<o.length;a+=1){const l=o[a];if(i[l]!==t[l])break}}else n=s;s=s.parent}return n}querySelector(e,t={}){return this.querySelectorAll(e,t,!0)[0]||null}querySelectorAll(e,t={},n=!1){let s=[];if(!this.children||this.children.length===0)return s;const i=Object.keys(t);return this.children.forEach(o=>{n&&s.length>0||(o.node.type.name===e&&i.every(l=>t[l]===o.node.attrs[l])&&s.push(o),!(n&&s.length>0)&&(s=s.concat(o.querySelectorAll(e,t,n))))}),s}setAttribute(e){const{tr:t}=this.editor.state;t.setNodeMarkup(this.from,void 0,{...this.node.attrs,...e}),this.editor.view.dispatch(t)}},N0=`.ProseMirror {
  position: relative;
}

.ProseMirror {
  word-wrap: break-word;
  white-space: pre-wrap;
  white-space: break-spaces;
  -webkit-font-variant-ligatures: none;
  font-variant-ligatures: none;
  font-feature-settings: "liga" 0; /* the above doesn't seem to work in Edge */
}

.ProseMirror [contenteditable="false"] {
  white-space: normal;
}

.ProseMirror [contenteditable="false"] [contenteditable="true"] {
  white-space: pre-wrap;
}

.ProseMirror pre {
  white-space: pre-wrap;
}

img.ProseMirror-separator {
  display: inline !important;
  border: none !important;
  margin: 0 !important;
  width: 0 !important;
  height: 0 !important;
}

.ProseMirror-gapcursor {
  display: none;
  pointer-events: none;
  position: absolute;
  margin: 0;
}

.ProseMirror-gapcursor:after {
  content: "";
  display: block;
  position: absolute;
  top: -2px;
  width: 20px;
  border-top: 1px solid black;
  animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

.ProseMirror-hideselection *::selection {
  background: transparent;
}

.ProseMirror-hideselection *::-moz-selection {
  background: transparent;
}

.ProseMirror-hideselection * {
  caret-color: transparent;
}

.ProseMirror-focused .ProseMirror-gapcursor {
  display: block;
}`;function P0(r,e,t){const n=document.querySelector("style[data-tiptap-style]");if(n!==null)return n;const s=document.createElement("style");return e&&s.setAttribute("nonce",e),s.setAttribute("data-tiptap-style",""),s.innerHTML=r,document.getElementsByTagName("head")[0].appendChild(s),s}var D0=class extends k0{constructor(r={}){super(),this.css=null,this.className="tiptap",this.editorView=null,this.isFocused=!1,this.isInitialized=!1,this.extensionStorage={},this.instanceId=Math.random().toString(36).slice(2,9),this.options={element:typeof document<"u"?document.createElement("div"):null,content:"",injectCSS:!0,injectNonce:void 0,extensions:[],autofocus:!1,editable:!0,textDirection:void 0,editorProps:{},parseOptions:{},coreExtensionOptions:{},enableInputRules:!0,enablePasteRules:!0,enableCoreExtensions:!0,enableContentCheck:!1,emitContentError:!1,onBeforeCreate:()=>null,onCreate:()=>null,onMount:()=>null,onUnmount:()=>null,onUpdate:()=>null,onSelectionUpdate:()=>null,onTransaction:()=>null,onFocus:()=>null,onBlur:()=>null,onDestroy:()=>null,onContentError:({error:n})=>{throw n},onPaste:()=>null,onDrop:()=>null,onDelete:()=>null,enableExtensionDispatchTransaction:!0},this.isCapturingTransaction=!1,this.capturedTransaction=null,this.utils={getUpdatedPosition:Xv,createMappablePosition:Zv},this.setOptions(r),this.createExtensionManager(),this.createCommandManager(),this.createSchema(),this.on("beforeCreate",this.options.onBeforeCreate),this.emit("beforeCreate",{editor:this}),this.on("mount",this.options.onMount),this.on("unmount",this.options.onUnmount),this.on("contentError",this.options.onContentError),this.on("create",this.options.onCreate),this.on("update",this.options.onUpdate),this.on("selectionUpdate",this.options.onSelectionUpdate),this.on("transaction",this.options.onTransaction),this.on("focus",this.options.onFocus),this.on("blur",this.options.onBlur),this.on("destroy",this.options.onDestroy),this.on("drop",({event:n,slice:s,moved:i})=>this.options.onDrop(n,s,i)),this.on("paste",({event:n,slice:s})=>this.options.onPaste(n,s)),this.on("delete",this.options.onDelete);const e=this.createDoc(),t=hh(e,this.options.autofocus);this.editorState=Lr.create({doc:e,schema:this.schema,selection:t||void 0}),this.options.element&&this.mount(this.options.element)}mount(r){if(typeof document>"u")throw new Error("[tiptap error]: The editor cannot be mounted because there is no 'document' defined in this environment.");this.createView(r),this.emit("mount",{editor:this}),this.css&&!document.head.contains(this.css)&&document.head.appendChild(this.css),window.setTimeout(()=>{this.isDestroyed||(this.options.autofocus!==!1&&this.options.autofocus!==null&&this.commands.focus(this.options.autofocus),this.emit("create",{editor:this}),this.isInitialized=!0)},0)}unmount(){if(this.editorView){const r=this.editorView.dom;r?.editor&&delete r.editor,this.editorView.destroy()}if(this.editorView=null,this.isInitialized=!1,this.css&&!document.querySelectorAll(`.${this.className}`).length)try{typeof this.css.remove=="function"?this.css.remove():this.css.parentNode&&this.css.parentNode.removeChild(this.css)}catch(r){console.warn("Failed to remove CSS element:",r)}this.css=null,this.emit("unmount",{editor:this})}get storage(){return this.extensionStorage}get commands(){return this.commandManager.commands}chain(){return this.commandManager.chain()}can(){return this.commandManager.can()}injectCSS(){this.options.injectCSS&&typeof document<"u"&&(this.css=P0(N0,this.options.injectNonce))}setOptions(r={}){this.options={...this.options,...r},!(!this.editorView||!this.state||this.isDestroyed)&&(this.options.editorProps&&this.view.setProps(this.options.editorProps),this.view.updateState(this.state))}setEditable(r,e=!0){this.setOptions({editable:r}),e&&this.emit("update",{editor:this,transaction:this.state.tr,appendedTransactions:[]})}get isEditable(){return this.options.editable&&this.view&&this.view.editable}get view(){return this.editorView?this.editorView:new Proxy({state:this.editorState,updateState:r=>{this.editorState=r},dispatch:r=>{this.dispatchTransaction(r)},composing:!1,dragging:null,editable:!0,isDestroyed:!1},{get:(r,e)=>{if(this.editorView)return this.editorView[e];if(e==="state")return this.editorState;if(e in r)return Reflect.get(r,e);throw new Error(`[tiptap error]: The editor view is not available. Cannot access view['${e}']. The editor may not be mounted yet.`)}})}get state(){return this.editorView&&(this.editorState=this.view.state),this.editorState}registerPlugin(r,e){const t=yh(e)?e(r,[...this.state.plugins]):[...this.state.plugins,r],n=this.state.reconfigure({plugins:t});return this.view.updateState(n),n}unregisterPlugin(r){if(this.isDestroyed)return;const e=this.state.plugins;let t=e;if([].concat(r).forEach(s=>{const i=typeof s=="string"?`${s}$`:s.key;t=t.filter(o=>!o.key.startsWith(i))}),e.length===t.length)return;const n=this.state.reconfigure({plugins:t});return this.view.updateState(n),n}createExtensionManager(){var r,e;const n=[...this.options.enableCoreExtensions?[Ph,Mh.configure({blockSeparator:(e=(r=this.options.coreExtensionOptions)==null?void 0:r.clipboardTextSerializer)==null?void 0:e.blockSeparator}),Ih,$h,Lh,Bh,Nh,jh,Rh,zh.configure({direction:this.options.textDirection})].filter(s=>typeof this.options.enableCoreExtensions=="object"?this.options.enableCoreExtensions[s.name]!==!1:!0):[],...this.options.extensions].filter(s=>["extension","node","mark"].includes(s?.type));this.extensionManager=new Di(n,this)}createCommandManager(){this.commandManager=new Mi({editor:this})}createSchema(){this.schema=this.extensionManager.schema}createDoc(){let r;try{r=ta(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:this.options.enableContentCheck})}catch(e){if(!(e instanceof Error)||!["[tiptap error]: Invalid JSON content","[tiptap error]: Invalid HTML content"].includes(e.message))throw e;this.emit("contentError",{editor:this,error:e,disableCollaboration:()=>{"collaboration"in this.storage&&typeof this.storage.collaboration=="object"&&this.storage.collaboration&&(this.storage.collaboration.isDisabled=!0),this.options.extensions=this.options.extensions.filter(t=>t.name!=="collaboration"),this.createExtensionManager()}}),r=ta(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:!1})}return r}createView(r){const{editorProps:e,enableExtensionDispatchTransaction:t}=this.options,n=e.dispatchTransaction||this.dispatchTransaction.bind(this),s=t?this.extensionManager.dispatchTransaction(n):n;this.editorView=new ah(r,{...e,attributes:{role:"textbox",...e?.attributes},dispatchTransaction:s,state:this.editorState,markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews});const i=this.state.reconfigure({plugins:this.extensionManager.plugins});this.view.updateState(i),this.prependClass(),this.injectCSS();const o=this.view.dom;o.editor=this}createNodeViews(){this.view.isDestroyed||this.view.setProps({markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews})}prependClass(){this.view.dom.className=`${this.className} ${this.view.dom.className}`}captureTransaction(r){this.isCapturingTransaction=!0,r(),this.isCapturingTransaction=!1;const e=this.capturedTransaction;return this.capturedTransaction=null,e}dispatchTransaction(r){if(this.view.isDestroyed)return;if(this.isCapturingTransaction){if(!this.capturedTransaction){this.capturedTransaction=r;return}r.steps.forEach(c=>{var u;return(u=this.capturedTransaction)==null?void 0:u.step(c)});return}const{state:e,transactions:t}=this.state.applyTransaction(r),n=!this.state.selection.eq(e.selection),s=t.includes(r),i=this.state;if(this.emit("beforeTransaction",{editor:this,transaction:r,nextState:e}),!s)return;this.view.updateState(e),this.emit("transaction",{editor:this,transaction:r,appendedTransactions:t.slice(1)}),n&&this.emit("selectionUpdate",{editor:this,transaction:r});const o=t.findLast(c=>c.getMeta("focus")||c.getMeta("blur")),a=o?.getMeta("focus"),l=o?.getMeta("blur");a&&this.emit("focus",{editor:this,event:a.event,transaction:o}),l&&this.emit("blur",{editor:this,event:l.event,transaction:o}),!(r.getMeta("preventUpdate")||!t.some(c=>c.docChanged)||i.doc.eq(e.doc))&&this.emit("update",{editor:this,transaction:r,appendedTransactions:t.slice(1)})}getAttributes(r){return Sh(this.state,r)}isActive(r,e){const t=typeof r=="string"?r:null,n=typeof r=="string"?e:r;return Gv(this.state,t,n)}getJSON(){return this.state.doc.toJSON()}getHTML(){return Ka(this.state.doc.content,this.schema)}getText(r){const{blockSeparator:e=`

`,textSerializers:t={}}=r||{};return Hv(this.state.doc,{blockSeparator:e,textSerializers:{...kh(this.schema),...t}})}get isEmpty(){return Ni(this.state.doc)}destroy(){this.emit("destroy"),this.unmount(),this.removeAllListeners()}get isDestroyed(){var r,e;return(e=(r=this.editorView)==null?void 0:r.isDestroyed)!=null?e:!0}$node(r,e){var t;return((t=this.$doc)==null?void 0:t.querySelector(r,e))||null}$nodes(r,e){var t;return((t=this.$doc)==null?void 0:t.querySelectorAll(r,e))||null}$pos(r){const e=this.state.doc.resolve(r);return new R0(e,this)}get $doc(){return this.$pos(0)}};function yr(r){return new Pi({find:r.find,handler:({state:e,range:t,match:n})=>{const s=H(r.getAttributes,void 0,n);if(s===!1||s===null)return null;const{tr:i}=e,o=n[n.length-1],a=n[0];if(o){const l=a.search(/\S/),c=t.from+a.indexOf(o),u=c+o.length;if(Ja(t.from,t.to,e.doc).filter(f=>f.mark.type.excluded.find(m=>m===r.type&&m!==f.mark.type)).filter(f=>f.to>c).length)return null;u<t.to&&i.delete(u,t.to),c>t.from&&i.delete(t.from+l,c);const h=t.from+l+o.length;i.addMark(t.from+l,h,r.type.create(s||{})),i.removeStoredMark(r.type)}},undoable:r.undoable})}function $0(r){return new Pi({find:r.find,handler:({state:e,range:t,match:n})=>{const s=H(r.getAttributes,void 0,n)||{},{tr:i}=e,o=t.from;let a=t.to;const l=r.type.create(s);if(n[1]){const c=n[0].lastIndexOf(n[1]);let u=o+c;u>a?u=a:a=u+n[1].length;const d=n[0][n[0].length-1];i.insertText(d,o+n[0].length-1),i.replaceWith(u,a,l)}else if(n[0]){const c=r.type.isInline?o:o-1;i.insert(c,r.type.create(s)).delete(i.mapping.map(o),i.mapping.map(a))}i.scrollIntoView()},undoable:r.undoable})}function na(r){return new Pi({find:r.find,handler:({state:e,range:t,match:n})=>{const s=e.doc.resolve(t.from),i=H(r.getAttributes,void 0,n)||{};if(!s.node(-1).canReplaceWith(s.index(-1),s.indexAfter(-1),r.type))return null;e.tr.delete(t.from,t.to).setBlockType(t.from,t.from,r.type,i)},undoable:r.undoable})}function Kr(r){return new Pi({find:r.find,handler:({state:e,range:t,match:n,chain:s})=>{const i=H(r.getAttributes,void 0,n)||{},o=e.tr.delete(t.from,t.to),l=o.doc.resolve(t.from).blockRange(),c=l&&Ca(l,r.type,i);if(!c)return null;if(o.wrap(l,c),r.keepMarks&&r.editor){const{selection:d,storedMarks:h}=e,{splittableMarks:f}=r.editor.extensionManager,p=h||d.$to.parentOffset&&d.$from.marks();if(p){const m=p.filter(g=>f.includes(g.type.name));o.ensureMarks(m)}}if(r.keepAttributes){const d=r.type.name==="bulletList"||r.type.name==="orderedList"?"listItem":"taskList";s().updateAttributes(d,i).run()}const u=o.doc.resolve(t.from-1).nodeBefore;u&&u.type===r.type&&qt(o.doc,t.from-1)&&(!r.joinPredicate||r.joinPredicate(n,u))&&o.join(t.from-1)},undoable:r.undoable})}function L0(r,e){const{selection:t}=r,{$from:n}=t;if(t instanceof M){const i=n.index();return n.parent.canReplaceWith(i,i+1,e)}let s=n.depth;for(;s>=0;){const i=n.index(s);if(n.node(s).contentMatchAt(i).matchType(e))return!0;s-=1}return!1}var j0={};Ha(j0,{createAtomBlockMarkdownSpec:()=>B0,createBlockMarkdownSpec:()=>z0,createInlineMarkdownSpec:()=>H0,parseAttributes:()=>Ya,parseIndentedBlocks:()=>sa,renderNestedMarkdownContent:()=>Xa,serializeAttributes:()=>Qa});function Ya(r){if(!r?.trim())return{};const e={},t=[],n=r.replace(/["']([^"']*)["']/g,c=>(t.push(c),`__QUOTED_${t.length-1}__`)),s=n.match(/(?:^|\s)\.([a-zA-Z][\w-]*)/g);if(s){const c=s.map(u=>u.trim().slice(1));e.class=c.join(" ")}const i=n.match(/(?:^|\s)#([a-zA-Z][\w-]*)/);i&&(e.id=i[1]);const o=/([a-zA-Z][\w-]*)\s*=\s*(__QUOTED_\d+__)/g;Array.from(n.matchAll(o)).forEach(([,c,u])=>{var d;const h=parseInt(((d=u.match(/__QUOTED_(\d+)__/))==null?void 0:d[1])||"0",10),f=t[h];f&&(e[c]=f.slice(1,-1))});const l=n.replace(/(?:^|\s)\.([a-zA-Z][\w-]*)/g,"").replace(/(?:^|\s)#([a-zA-Z][\w-]*)/g,"").replace(/([a-zA-Z][\w-]*)\s*=\s*__QUOTED_\d+__/g,"").trim();return l&&l.split(/\s+/).filter(Boolean).forEach(u=>{u.match(/^[a-zA-Z][\w-]*$/)&&(e[u]=!0)}),e}function Qa(r){if(!r||Object.keys(r).length===0)return"";const e=[];return r.class&&String(r.class).split(/\s+/).filter(Boolean).forEach(n=>e.push(`.${n}`)),r.id&&e.push(`#${r.id}`),Object.entries(r).forEach(([t,n])=>{t==="class"||t==="id"||(n===!0?e.push(t):n!==!1&&n!=null&&e.push(`${t}="${String(n)}"`))}),e.join(" ")}function B0(r){const{nodeName:e,name:t,parseAttributes:n=Ya,serializeAttributes:s=Qa,defaultAttributes:i={},requiredAttributes:o=[],allowedAttributes:a}=r,l=t||e,c=u=>{if(!a)return u;const d={};return a.forEach(h=>{h in u&&(d[h]=u[h])}),d};return{parseMarkdown:(u,d)=>{const h={...i,...u.attributes};return d.createNode(e,h,[])},markdownTokenizer:{name:e,level:"block",start(u){var d;const h=new RegExp(`^:::${l}(?:\\s|$)`,"m"),f=(d=u.match(h))==null?void 0:d.index;return f!==void 0?f:-1},tokenize(u,d,h){const f=new RegExp(`^:::${l}(?:\\s+\\{([^}]*)\\})?\\s*:::(?:\\n|$)`),p=u.match(f);if(!p)return;const m=p[1]||"",g=n(m);if(!o.find(w=>!(w in g)))return{type:e,raw:p[0],attributes:g}}},renderMarkdown:u=>{const d=c(u.attrs||{}),h=s(d),f=h?` {${h}}`:"";return`:::${l}${f} :::`}}}function z0(r){const{nodeName:e,name:t,getContent:n,parseAttributes:s=Ya,serializeAttributes:i=Qa,defaultAttributes:o={},content:a="block",allowedAttributes:l}=r,c=t||e,u=d=>{if(!l)return d;const h={};return l.forEach(f=>{f in d&&(h[f]=d[f])}),h};return{parseMarkdown:(d,h)=>{let f;if(n){const m=n(d);f=typeof m=="string"?[{type:"text",text:m}]:m}else a==="block"?f=h.parseChildren(d.tokens||[]):f=h.parseInline(d.tokens||[]);const p={...o,...d.attributes};return h.createNode(e,p,f)},markdownTokenizer:{name:e,level:"block",start(d){var h;const f=new RegExp(`^:::${c}`,"m"),p=(h=d.match(f))==null?void 0:h.index;return p!==void 0?p:-1},tokenize(d,h,f){var p;const m=new RegExp(`^:::${c}(?:\\s+\\{([^}]*)\\})?\\s*\\n`),g=d.match(m);if(!g)return;const[y,w=""]=g,v=s(w);let _=1;const E=y.length;let S="";const x=/^:::([\w-]*)(\s.*)?/gm,I=d.slice(E);for(x.lastIndex=0;;){const $=x.exec(I);if($===null)break;const G=$.index,Re=$[1];if(!((p=$[2])!=null&&p.endsWith(":::"))){if(Re)_+=1;else if(_-=1,_===0){const je=I.slice(0,G);S=je.trim();const tt=d.slice(0,E+G+$[0].length);let j=[];if(S)if(a==="block")for(j=f.blockTokens(je),j.forEach(Y=>{Y.text&&(!Y.tokens||Y.tokens.length===0)&&(Y.tokens=f.inlineTokens(Y.text))});j.length>0;){const Y=j[j.length-1];if(Y.type==="paragraph"&&(!Y.text||Y.text.trim()===""))j.pop();else break}else j=f.inlineTokens(S);return{type:e,raw:tt,attributes:v,content:S,tokens:j}}}}}},renderMarkdown:(d,h)=>{const f=u(d.attrs||{}),p=i(f),m=p?` {${p}}`:"",g=h.renderChildren(d.content||[],`

`);return`:::${c}${m}

${g}

:::`}}}function U0(r){if(!r.trim())return{};const e={},t=/(\w+)=(?:"([^"]*)"|'([^']*)')/g;let n=t.exec(r);for(;n!==null;){const[,s,i,o]=n;e[s]=i||o,n=t.exec(r)}return e}function F0(r){return Object.entries(r).filter(([,e])=>e!=null).map(([e,t])=>`${e}="${t}"`).join(" ")}function H0(r){const{nodeName:e,name:t,getContent:n,parseAttributes:s=U0,serializeAttributes:i=F0,defaultAttributes:o={},selfClosing:a=!1,allowedAttributes:l}=r,c=t||e,u=h=>{if(!l)return h;const f={};return l.forEach(p=>{const m=typeof p=="string"?p:p.name,g=typeof p=="string"?void 0:p.skipIfDefault;if(m in h){const y=h[m];if(g!==void 0&&y===g)return;f[m]=y}}),f},d=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return{parseMarkdown:(h,f)=>{const p={...o,...h.attributes};if(a)return f.createNode(e,p);const m=n?n(h):h.content||"";return m?f.createNode(e,p,[f.createTextNode(m)]):f.createNode(e,p,[])},markdownTokenizer:{name:e,level:"inline",start(h){const f=a?new RegExp(`\\[${d}\\s*[^\\]]*\\]`):new RegExp(`\\[${d}\\s*[^\\]]*\\][\\s\\S]*?\\[\\/${d}\\]`),p=h.match(f),m=p?.index;return m!==void 0?m:-1},tokenize(h,f,p){const m=a?new RegExp(`^\\[${d}\\s*([^\\]]*)\\]`):new RegExp(`^\\[${d}\\s*([^\\]]*)\\]([\\s\\S]*?)\\[\\/${d}\\]`),g=h.match(m);if(!g)return;let y="",w="";if(a){const[,_]=g;w=_}else{const[,_,E]=g;w=_,y=E||""}const v=s(w.trim());return{type:e,raw:g[0],content:y.trim(),attributes:v}}},renderMarkdown:h=>{let f="";n?f=n(h):h.content&&h.content.length>0&&(f=h.content.filter(y=>y.type==="text").map(y=>y.text).join(""));const p=u(h.attrs||{}),m=i(p),g=m?` ${m}`:"";return a?`[${c}${g}]`:`[${c}${g}]${f}[/${c}]`}}}function sa(r,e,t){var n,s,i,o;const a=r.split(`
`),l=[];let c="",u=0;const d=e.baseIndentSize||2;for(;u<a.length;){const h=a[u],f=h.match(e.itemPattern);if(!f){if(l.length>0)break;if(h.trim()===""){u+=1,c=`${c}${h}
`;continue}else return}const p=e.extractItemData(f),{indentLevel:m,mainContent:g}=p;c=`${c}${h}
`;const y=[g];for(u+=1;u<a.length;){const E=a[u];if(E.trim()===""){const x=a.slice(u+1).findIndex(G=>G.trim()!=="");if(x===-1)break;if((((s=(n=a[u+1+x].match(/^(\s*)/))==null?void 0:n[1])==null?void 0:s.length)||0)>m){y.push(E),c=`${c}${E}
`,u+=1;continue}else break}if((((o=(i=E.match(/^(\s*)/))==null?void 0:i[1])==null?void 0:o.length)||0)>m)y.push(E),c=`${c}${E}
`,u+=1;else break}let w;const v=y.slice(1);if(v.length>0){const E=v.map(S=>S.slice(m+d)).join(`
`);E.trim()&&(e.customNestedParser?w=e.customNestedParser(E):w=t.blockTokens(E))}const _=e.createToken(p,w);l.push(_)}if(l.length!==0)return{items:l,raw:c}}function Xa(r,e,t,n){if(!r||!Array.isArray(r.content))return"";const s=typeof t=="function"?t(n):t,[i,...o]=r.content,a=e.renderChildren([i]),l=[`${s}${a}`];return o&&o.length>0&&o.forEach(c=>{const u=e.renderChildren([c]);if(u){const d=u.split(`
`).map(h=>h?e.indent(h):"").join(`
`);l.push(d)}}),l.join(`
`)}function V0(r,e,t={}){const{state:n}=e,{doc:s,tr:i}=n,o=r;s.descendants((a,l)=>{const c=i.mapping.map(l),u=i.mapping.map(l)+a.nodeSize;let d=null;if(a.marks.forEach(f=>{if(f!==o)return!1;d=f}),!d)return;let h=!1;if(Object.keys(t).forEach(f=>{t[f]!==d.attrs[f]&&(h=!0)}),h){const f=r.type.create({...r.attrs,...t});i.removeMark(c,u,r.type),i.addMark(c,u,f)}}),i.docChanged&&e.view.dispatch(i)}var Oe=class Uh extends Ga{constructor(){super(...arguments),this.type="node"}static create(e={}){const t=typeof e=="function"?e():e;return new Uh(t)}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}};function Ht(r){return new E0({find:r.find,handler:({state:e,range:t,match:n,pasteEvent:s})=>{const i=H(r.getAttributes,void 0,n,s);if(i===!1||i===null)return null;const{tr:o}=e,a=n[n.length-1],l=n[0];let c=t.to;if(a){const u=l.search(/\S/),d=t.from+l.indexOf(a),h=d+a.length;if(Ja(t.from,t.to,e.doc).filter(p=>p.mark.type.excluded.find(g=>g===r.type&&g!==p.mark.type)).filter(p=>p.to>d).length)return null;h<t.to&&o.delete(h,t.to),d>t.from&&o.delete(t.from+u,d),c=t.from+u+a.length,o.addMark(t.from+u,c,r.type.create(i||{})),o.removeStoredMark(r.type)}}})}var Bs=(r,e)=>{if(r==="slot")return 0;if(r instanceof Function)return r(e);const{children:t,...n}=e??{};if(r==="svg")throw new Error("SVG elements are not supported in the JSX syntax, use the array syntax instead");return[r,n,t]},q0=/^\s*>\s$/,W0=Oe.create({name:"blockquote",addOptions(){return{HTMLAttributes:{}}},content:"block+",group:"block",defining:!0,parseHTML(){return[{tag:"blockquote"}]},renderHTML({HTMLAttributes:r}){return Bs("blockquote",{...te(this.options.HTMLAttributes,r),children:Bs("slot",{})})},parseMarkdown:(r,e)=>e.createNode("blockquote",void 0,e.parseChildren(r.tokens||[])),renderMarkdown:(r,e)=>{if(!r.content)return"";const t=">",n=[];return r.content.forEach(s=>{const a=e.renderChildren([s]).split(`
`).map(l=>l.trim()===""?t:`${t} ${l}`);n.push(a.join(`
`))}),n.join(`
${t}
`)},addCommands(){return{setBlockquote:()=>({commands:r})=>r.wrapIn(this.name),toggleBlockquote:()=>({commands:r})=>r.toggleWrap(this.name),unsetBlockquote:()=>({commands:r})=>r.lift(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-b":()=>this.editor.commands.toggleBlockquote()}},addInputRules(){return[Kr({find:q0,type:this.type})]}}),K0=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))$/,J0=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))/g,G0=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))$/,Y0=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))/g,Q0=kt.create({name:"bold",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"strong"},{tag:"b",getAttrs:r=>r.style.fontWeight!=="normal"&&null},{style:"font-weight=400",clearMark:r=>r.type.name===this.name},{style:"font-weight",getAttrs:r=>/^(bold(er)?|[5-9]\d{2,})$/.test(r)&&null}]},renderHTML({HTMLAttributes:r}){return Bs("strong",{...te(this.options.HTMLAttributes,r),children:Bs("slot",{})})},markdownTokenName:"strong",parseMarkdown:(r,e)=>e.applyMark("bold",e.parseInline(r.tokens||[])),renderMarkdown:(r,e)=>`**${e.renderChildren(r)}**`,addCommands(){return{setBold:()=>({commands:r})=>r.setMark(this.name),toggleBold:()=>({commands:r})=>r.toggleMark(this.name),unsetBold:()=>({commands:r})=>r.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-b":()=>this.editor.commands.toggleBold(),"Mod-B":()=>this.editor.commands.toggleBold()}},addInputRules(){return[yr({find:K0,type:this.type}),yr({find:G0,type:this.type})]},addPasteRules(){return[Ht({find:J0,type:this.type}),Ht({find:Y0,type:this.type})]}}),X0=/(^|[^`])`([^`]+)`(?!`)$/,Z0=/(^|[^`])`([^`]+)`(?!`)/g,ek=kt.create({name:"code",addOptions(){return{HTMLAttributes:{}}},excludes:"_",code:!0,exitable:!0,parseHTML(){return[{tag:"code"}]},renderHTML({HTMLAttributes:r}){return["code",te(this.options.HTMLAttributes,r),0]},markdownTokenName:"codespan",parseMarkdown:(r,e)=>e.applyMark("code",[{type:"text",text:r.text||""}]),renderMarkdown:(r,e)=>r.content?`\`${e.renderChildren(r.content)}\``:"",addCommands(){return{setCode:()=>({commands:r})=>r.setMark(this.name),toggleCode:()=>({commands:r})=>r.toggleMark(this.name),unsetCode:()=>({commands:r})=>r.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-e":()=>this.editor.commands.toggleCode()}},addInputRules(){return[yr({find:X0,type:this.type})]},addPasteRules(){return[Ht({find:Z0,type:this.type})]}}),ho=4,tk=/^```([a-z]+)?[\s\n]$/,rk=/^~~~([a-z]+)?[\s\n]$/,nk=Oe.create({name:"codeBlock",addOptions(){return{languageClassPrefix:"language-",exitOnTripleEnter:!0,exitOnArrowDown:!0,defaultLanguage:null,enableTabIndentation:!1,tabSize:ho,HTMLAttributes:{}}},content:"text*",marks:"",group:"block",code:!0,defining:!0,addAttributes(){return{language:{default:this.options.defaultLanguage,parseHTML:r=>{var e;const{languageClassPrefix:t}=this.options;if(!t)return null;const i=[...((e=r.firstElementChild)==null?void 0:e.classList)||[]].filter(o=>o.startsWith(t)).map(o=>o.replace(t,""))[0];return i||null},rendered:!1}}},parseHTML(){return[{tag:"pre",preserveWhitespace:"full"}]},renderHTML({node:r,HTMLAttributes:e}){return["pre",te(this.options.HTMLAttributes,e),["code",{class:r.attrs.language?this.options.languageClassPrefix+r.attrs.language:null},0]]},markdownTokenName:"code",parseMarkdown:(r,e)=>{var t;return((t=r.raw)==null?void 0:t.startsWith("```"))===!1&&r.codeBlockStyle!=="indented"?[]:e.createNode("codeBlock",{language:r.lang||null},r.text?[e.createTextNode(r.text)]:[])},renderMarkdown:(r,e)=>{var t;let n="";const s=((t=r.attrs)==null?void 0:t.language)||"";return r.content?n=[`\`\`\`${s}`,e.renderChildren(r.content),"```"].join(`
`):n=`\`\`\`${s}

\`\`\``,n},addCommands(){return{setCodeBlock:r=>({commands:e})=>e.setNode(this.name,r),toggleCodeBlock:r=>({commands:e})=>e.toggleNode(this.name,"paragraph",r)}},addKeyboardShortcuts(){return{"Mod-Alt-c":()=>this.editor.commands.toggleCodeBlock(),Backspace:()=>{const{empty:r,$anchor:e}=this.editor.state.selection,t=e.pos===1;return!r||e.parent.type.name!==this.name?!1:t||!e.parent.textContent.length?this.editor.commands.clearNodes():!1},Tab:({editor:r})=>{var e;if(!this.options.enableTabIndentation)return!1;const t=(e=this.options.tabSize)!=null?e:ho,{state:n}=r,{selection:s}=n,{$from:i,empty:o}=s;if(i.parent.type!==this.type)return!1;const a=" ".repeat(t);return o?r.commands.insertContent(a):r.commands.command(({tr:l})=>{const{from:c,to:u}=s,f=n.doc.textBetween(c,u,`
`,`
`).split(`
`).map(p=>a+p).join(`
`);return l.replaceWith(c,u,n.schema.text(f)),!0})},"Shift-Tab":({editor:r})=>{var e;if(!this.options.enableTabIndentation)return!1;const t=(e=this.options.tabSize)!=null?e:ho,{state:n}=r,{selection:s}=n,{$from:i,empty:o}=s;return i.parent.type!==this.type?!1:o?r.commands.command(({tr:a})=>{var l;const{pos:c}=i,u=i.start(),d=i.end(),f=n.doc.textBetween(u,d,`
`,`
`).split(`
`);let p=0,m=0;const g=c-u;for(let S=0;S<f.length;S+=1){if(m+f[S].length>=g){p=S;break}m+=f[S].length+1}const w=((l=f[p].match(/^ */))==null?void 0:l[0])||"",v=Math.min(w.length,t);if(v===0)return!0;let _=u;for(let S=0;S<p;S+=1)_+=f[S].length+1;return a.delete(_,_+v),c-_<=v&&a.setSelection(D.create(a.doc,_)),!0}):r.commands.command(({tr:a})=>{const{from:l,to:c}=s,h=n.doc.textBetween(l,c,`
`,`
`).split(`
`).map(f=>{var p;const m=((p=f.match(/^ */))==null?void 0:p[0])||"",g=Math.min(m.length,t);return f.slice(g)}).join(`
`);return a.replaceWith(l,c,n.schema.text(h)),!0})},Enter:({editor:r})=>{if(!this.options.exitOnTripleEnter)return!1;const{state:e}=r,{selection:t}=e,{$from:n,empty:s}=t;if(!s||n.parent.type!==this.type)return!1;const i=n.parentOffset===n.parent.nodeSize-2,o=n.parent.textContent.endsWith(`

`);return!i||!o?!1:r.chain().command(({tr:a})=>(a.delete(n.pos-2,n.pos),!0)).exitCode().run()},ArrowDown:({editor:r})=>{if(!this.options.exitOnArrowDown)return!1;const{state:e}=r,{selection:t,doc:n}=e,{$from:s,empty:i}=t;if(!i||s.parent.type!==this.type||!(s.parentOffset===s.parent.nodeSize-2))return!1;const a=s.after();return a===void 0?!1:n.nodeAt(a)?r.commands.command(({tr:c})=>(c.setSelection(z.near(n.resolve(a))),!0)):r.commands.exitCode()}}},addInputRules(){return[na({find:tk,type:this.type,getAttributes:r=>({language:r[1]})}),na({find:rk,type:this.type,getAttributes:r=>({language:r[1]})})]},addProseMirrorPlugins(){return[new K({key:new ne("codeBlockVSCodeHandler"),props:{handlePaste:(r,e)=>{if(!e.clipboardData||this.editor.isActive(this.type.name))return!1;const t=e.clipboardData.getData("text/plain"),n=e.clipboardData.getData("vscode-editor-data"),s=n?JSON.parse(n):void 0,i=s?.mode;if(!t||!i)return!1;const{tr:o,schema:a}=r.state,l=a.text(t.replace(/\r\n?/g,`
`));return o.replaceSelectionWith(this.type.create({language:i},l)),o.selection.$from.parent.type!==this.type&&o.setSelection(D.near(o.doc.resolve(Math.max(0,o.selection.from-2)))),o.setMeta("paste",!0),r.dispatch(o),!0}}})]}}),sk=Oe.create({name:"doc",topNode:!0,content:"block+",renderMarkdown:(r,e)=>r.content?e.renderChildren(r.content,`

`):""}),ik=Oe.create({name:"hardBreak",markdownTokenName:"br",addOptions(){return{keepMarks:!0,HTMLAttributes:{}}},inline:!0,group:"inline",selectable:!1,linebreakReplacement:!0,parseHTML(){return[{tag:"br"}]},renderHTML({HTMLAttributes:r}){return["br",te(this.options.HTMLAttributes,r)]},renderText(){return`
`},renderMarkdown:()=>`  
`,parseMarkdown:()=>({type:"hardBreak"}),addCommands(){return{setHardBreak:()=>({commands:r,chain:e,state:t,editor:n})=>r.first([()=>r.exitCode(),()=>r.command(()=>{const{selection:s,storedMarks:i}=t;if(s.$from.parent.type.spec.isolating)return!1;const{keepMarks:o}=this.options,{splittableMarks:a}=n.extensionManager,l=i||s.$to.parentOffset&&s.$from.marks();return e().insertContent({type:this.name}).command(({tr:c,dispatch:u})=>{if(u&&l&&o){const d=l.filter(h=>a.includes(h.type.name));c.ensureMarks(d)}return!0}).run()})])}},addKeyboardShortcuts(){return{"Mod-Enter":()=>this.editor.commands.setHardBreak(),"Shift-Enter":()=>this.editor.commands.setHardBreak()}}}),ok=Oe.create({name:"heading",addOptions(){return{levels:[1,2,3,4,5,6],HTMLAttributes:{}}},content:"inline*",group:"block",defining:!0,addAttributes(){return{level:{default:1,rendered:!1}}},parseHTML(){return this.options.levels.map(r=>({tag:`h${r}`,attrs:{level:r}}))},renderHTML({node:r,HTMLAttributes:e}){return[`h${this.options.levels.includes(r.attrs.level)?r.attrs.level:this.options.levels[0]}`,te(this.options.HTMLAttributes,e),0]},parseMarkdown:(r,e)=>e.createNode("heading",{level:r.depth||1},e.parseInline(r.tokens||[])),renderMarkdown:(r,e)=>{var t;const n=(t=r.attrs)!=null&&t.level?parseInt(r.attrs.level,10):1,s="#".repeat(n);return r.content?`${s} ${e.renderChildren(r.content)}`:""},addCommands(){return{setHeading:r=>({commands:e})=>this.options.levels.includes(r.level)?e.setNode(this.name,r):!1,toggleHeading:r=>({commands:e})=>this.options.levels.includes(r.level)?e.toggleNode(this.name,"paragraph",r):!1}},addKeyboardShortcuts(){return this.options.levels.reduce((r,e)=>({...r,[`Mod-Alt-${e}`]:()=>this.editor.commands.toggleHeading({level:e})}),{})},addInputRules(){return this.options.levels.map(r=>na({find:new RegExp(`^(#{${Math.min(...this.options.levels)},${r}})\\s$`),type:this.type,getAttributes:{level:r}}))}}),ak=Oe.create({name:"horizontalRule",addOptions(){return{HTMLAttributes:{},nextNodeType:"paragraph"}},group:"block",parseHTML(){return[{tag:"hr"}]},renderHTML({HTMLAttributes:r}){return["hr",te(this.options.HTMLAttributes,r)]},markdownTokenName:"hr",parseMarkdown:(r,e)=>e.createNode("horizontalRule"),renderMarkdown:()=>"---",addCommands(){return{setHorizontalRule:()=>({chain:r,state:e})=>{if(!L0(e,e.schema.nodes[this.name]))return!1;const{selection:t}=e,{$to:n}=t,s=r();return Th(t)?s.insertContentAt(n.pos,{type:this.name}):s.insertContent({type:this.name}),s.command(({state:i,tr:o,dispatch:a})=>{if(a){const{$to:l}=o.selection,c=l.end();if(l.nodeAfter)l.nodeAfter.isTextblock?o.setSelection(D.create(o.doc,l.pos+1)):l.nodeAfter.isBlock?o.setSelection(M.create(o.doc,l.pos)):o.setSelection(D.create(o.doc,l.pos));else{const u=i.schema.nodes[this.options.nextNodeType]||l.parent.type.contentMatch.defaultType,d=u?.create();d&&(o.insert(c,d),o.setSelection(D.create(o.doc,c+1)))}o.scrollIntoView()}return!0}).run()}}},addInputRules(){return[$0({find:/^(?:---|-|___\s|\*\*\*\s)$/,type:this.type})]}}),lk=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))$/,ck=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))/g,uk=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))$/,dk=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))/g,hk=kt.create({name:"italic",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"em"},{tag:"i",getAttrs:r=>r.style.fontStyle!=="normal"&&null},{style:"font-style=normal",clearMark:r=>r.type.name===this.name},{style:"font-style=italic"}]},renderHTML({HTMLAttributes:r}){return["em",te(this.options.HTMLAttributes,r),0]},addCommands(){return{setItalic:()=>({commands:r})=>r.setMark(this.name),toggleItalic:()=>({commands:r})=>r.toggleMark(this.name),unsetItalic:()=>({commands:r})=>r.unsetMark(this.name)}},markdownTokenName:"em",parseMarkdown:(r,e)=>e.applyMark("italic",e.parseInline(r.tokens||[])),renderMarkdown:(r,e)=>`*${e.renderChildren(r)}*`,addKeyboardShortcuts(){return{"Mod-i":()=>this.editor.commands.toggleItalic(),"Mod-I":()=>this.editor.commands.toggleItalic()}},addInputRules(){return[yr({find:lk,type:this.type}),yr({find:uk,type:this.type})]},addPasteRules(){return[Ht({find:ck,type:this.type}),Ht({find:dk,type:this.type})]}});const fk="aaa1rp3bb0ott3vie4c1le2ogado5udhabi7c0ademy5centure6ountant0s9o1tor4d0s1ult4e0g1ro2tna4f0l1rica5g0akhan5ency5i0g1rbus3force5tel5kdn3l0ibaba4pay4lfinanz6state5y2sace3tom5m0azon4ericanexpress7family11x2fam3ica3sterdam8nalytics7droid5quan4z2o0l2partments8p0le4q0uarelle8r0ab1mco4chi3my2pa2t0e3s0da2ia2sociates9t0hleta5torney7u0ction5di0ble3o3spost5thor3o0s4w0s2x0a2z0ure5ba0by2idu3namex4d1k2r0celona5laycard4s5efoot5gains6seball5ketball8uhaus5yern5b0c1t1va3cg1n2d1e0ats2uty4er2rlin4st0buy5t2f1g1h0arti5i0ble3d1ke2ng0o3o1z2j1lack0friday9ockbuster8g1omberg7ue3m0s1w2n0pparibas9o0ats3ehringer8fa2m1nd2o0k0ing5sch2tik2on4t1utique6x2r0adesco6idgestone9oadway5ker3ther5ussels7s1t1uild0ers6siness6y1zz3v1w1y1z0h3ca0b1fe2l0l1vinklein9m0era3p2non3petown5ital0one8r0avan4ds2e0er0s4s2sa1e1h1ino4t0ering5holic7ba1n1re3c1d1enter4o1rn3f0a1d2g1h0anel2nel4rity4se2t2eap3intai5ristmas6ome4urch5i0priani6rcle4sco3tadel4i0c2y3k1l0aims4eaning6ick2nic1que6othing5ud3ub0med6m1n1o0ach3des3ffee4llege4ogne5m0mbank4unity6pany2re3uter5sec4ndos3struction8ulting7tact3ractors9oking4l1p2rsica5untry4pon0s4rses6pa2r0edit0card4union9icket5own3s1uise0s6u0isinella9v1w1x1y0mru3ou3z2dad1nce3ta1e1ing3sun4y2clk3ds2e0al0er2s3gree4livery5l1oitte5ta3mocrat6ntal2ist5si0gn4v2hl2iamonds6et2gital5rect0ory7scount3ver5h2y2j1k1m1np2o0cs1tor4g1mains5t1wnload7rive4tv2ubai3nlop4pont4rban5vag2r2z2earth3t2c0o2deka3u0cation8e1g1mail3erck5nergy4gineer0ing9terprises10pson4quipment8r0icsson6ni3s0q1tate5t1u0rovision8s2vents5xchange6pert3osed4ress5traspace10fage2il1rwinds6th3mily4n0s2rm0ers5shion4t3edex3edback6rrari3ero6i0delity5o2lm2nal1nce1ial7re0stone6mdale6sh0ing5t0ness6j1k1lickr3ghts4r2orist4wers5y2m1o0o0d1tball6rd1ex2sale4um3undation8x2r0ee1senius7l1ogans4ntier7tr2ujitsu5n0d2rniture7tbol5yi3ga0l0lery3o1up4me0s3p1rden4y2b0iz3d0n2e0a1nt0ing5orge5f1g0ee3h1i0ft0s3ves2ing5l0ass3e1obal2o4m0ail3bh2o1x2n1odaddy5ld0point6f2o0dyear5g0le4p1t1v2p1q1r0ainger5phics5tis4een3ipe3ocery4up4s1t1u0cci3ge2ide2tars5ru3w1y2hair2mburg5ngout5us3bo2dfc0bank7ealth0care8lp1sinki6re1mes5iphop4samitsu7tachi5v2k0t2m1n1ockey4ldings5iday5medepot5goods5s0ense7nda3rse3spital5t0ing5t0els3mail5use3w2r1sbc3t1u0ghes5yatt3undai7ibm2cbc2e1u2d1e0ee3fm2kano4l1m0amat4db2mo0bilien9n0c1dustries8finiti5o2g1k1stitute6urance4e4t0ernational10uit4vestments10o1piranga7q1r0ish4s0maili5t0anbul7t0au2v3jaguar4va3cb2e0ep2tzt3welry6io2ll2m0p2nj2o0bs1urg4t1y2p0morgan6rs3uegos4niper7kaufen5ddi3e0rryhotels6properties14fh2g1h1i0a1ds2m1ndle4tchen5wi3m1n1oeln3matsu5sher5p0mg2n2r0d1ed3uokgroup8w1y0oto4z2la0caixa5mborghini8er3nd0rover6xess5salle5t0ino3robe5w0yer5b1c1ds2ease3clerc5frak4gal2o2xus4gbt3i0dl2fe0insurance9style7ghting6ke2lly3mited4o2ncoln4k2ve1ing5k1lc1p2oan0s3cker3us3l1ndon4tte1o3ve3pl0financial11r1s1t0d0a3u0ndbeck6xe1ury5v1y2ma0drid4if1son4keup4n0agement7go3p1rket0ing3s4riott5shalls7ttel5ba2c0kinsey7d1e0d0ia3et2lbourne7me1orial6n0u2rckmsd7g1h1iami3crosoft7l1ni1t2t0subishi9k1l0b1s2m0a2n1o0bi0le4da2e1i1m1nash3ey2ster5rmon3tgage6scow4to0rcycles9v0ie4p1q1r1s0d2t0n1r2u0seum3ic4v1w1x1y1z2na0b1goya4me2vy3ba2c1e0c1t0bank4flix4work5ustar5w0s2xt0direct7us4f0l2g0o2hk2i0co2ke1on3nja3ssan1y5l1o0kia3rton4w0ruz3tv4p1r0a1w2tt2u1yc2z2obi1server7ffice5kinawa6layan0group9lo3m0ega4ne1g1l0ine5oo2pen3racle3nge4g0anic5igins6saka4tsuka4t2vh3pa0ge2nasonic7ris2s1tners4s1y3y2ccw3e0t2f0izer5g1h0armacy6d1ilips5one2to0graphy6s4ysio5ics1tet2ures6d1n0g1k2oneer5zza4k1l0ace2y0station9umbing5s3m1n0c2ohl2ker3litie5rn2st3r0axi3ess3ime3o0d0uctions8f1gressive8mo2perties3y5tection8u0dential9s1t1ub2w0c2y2qa1pon3uebec3st5racing4dio4e0ad1lestate6tor2y4cipes5d0stone5umbrella9hab3ise0n3t2liance6n0t0als5pair3ort3ublican8st0aurant8view0s5xroth6ich0ardli6oh3l1o1p2o0cks3deo3gers4om3s0vp3u0gby3hr2n2w0e2yukyu6sa0arland6fe0ty4kura4le1on3msclub4ung5ndvik0coromant12ofi4p1rl2s1ve2xo3b0i1s2c0b1haeffler7midt4olarships8ol3ule3warz5ience5ot3d1e0arch3t2cure1ity6ek2lect4ner3rvices6ven3w1x0y3fr2g1h0angrila6rp3ell3ia1ksha5oes2p0ping5uji3w3i0lk2na1gles5te3j1k0i0n2y0pe4l0ing4m0art3ile4n0cf3o0ccer3ial4ftbank4ware6hu2lar2utions7ng1y2y2pa0ce3ort2t3r0l2s1t0ada2ples4r1tebank4farm7c0group6ockholm6rage3e3ream4udio2y3yle4u0cks3pplies3y2ort5rf1gery5zuki5v1watch4iss4x1y0dney4stems6z2tab1ipei4lk2obao4rget4tamotors6r2too4x0i3c0i2d0k2eam2ch0nology8l1masek5nnis4va3f1g1h0d1eater2re6iaa2ckets5enda4ps2res2ol4j0maxx4x2k0maxx5l1m0all4n1o0day3kyo3ols3p1ray3shiba5tal3urs3wn2yota3s3r0ade1ing4ining5vel0ers0insurance16ust3v2t1ube2i1nes3shu4v0s2w1z2ua1bank3s2g1k1nicom3versity8o2ol2ps2s1y1z2va0cations7na1guard7c1e0gas3ntures6risign5mgensberater2ung14sicherung10t2g1i0ajes4deo3g1king4llas4n1p1rgin4sa1ion4va1o3laanderen9n1odka3lvo3te1ing3o2yage5u2wales2mart4ter4ng0gou5tch0es6eather0channel12bcam3er2site5d0ding5ibo2r3f1hoswho6ien2ki2lliamhill9n0dows4e1ners6me2olterskluwer11odside6rk0s2ld3w2s1tc1f3xbox3erox4ihuan4n2xx2yz3yachts4hoo3maxun5ndex5e1odobashi7ga2kohama6u0tube6t1un3za0ppos4ra3ero3ip2m1one3uerich6w2",pk="121342632165322333335355455655552435435422463632574574330355524444661154543332344423364211133222221212112052232222232212222223222241112222224322321222",ia="numeric",oa="ascii",aa="alpha",gn="asciinumeric",cn="alphanumeric",la="domain",Fh="emoji",mk="scheme",gk="slashscheme",fo="whitespace";function yk(r,e){return r in e||(e[r]=[]),e[r]}function ir(r,e,t){e[ia]&&(e[gn]=!0,e[cn]=!0),e[oa]&&(e[gn]=!0,e[aa]=!0),e[gn]&&(e[cn]=!0),e[aa]&&(e[cn]=!0),e[cn]&&(e[la]=!0),e[Fh]&&(e[la]=!0);for(const n in e){const s=yk(n,t);s.indexOf(r)<0&&s.push(r)}}function bk(r,e){const t={};for(const n in e)e[n].indexOf(r)>=0&&(t[n]=!0);return t}function Me(r=null){this.j={},this.jr=[],this.jd=null,this.t=r}Me.groups={};Me.prototype={accepts(){return!!this.t},go(r){const e=this,t=e.j[r];if(t)return t;for(let n=0;n<e.jr.length;n++){const s=e.jr[n][0],i=e.jr[n][1];if(i&&s.test(r))return i}return e.jd},has(r,e=!1){return e?r in this.j:!!this.go(r)},ta(r,e,t,n){for(let s=0;s<r.length;s++)this.tt(r[s],e,t,n)},tr(r,e,t,n){n=n||Me.groups;let s;return e&&e.j?s=e:(s=new Me(e),t&&n&&ir(e,t,n)),this.jr.push([r,s]),s},ts(r,e,t,n){let s=this;const i=r.length;if(!i)return s;for(let o=0;o<i-1;o++)s=s.tt(r[o]);return s.tt(r[i-1],e,t,n)},tt(r,e,t,n){n=n||Me.groups;const s=this;if(e&&e.j)return s.j[r]=e,e;const i=e;let o,a=s.go(r);if(a?(o=new Me,Object.assign(o.j,a.j),o.jr.push.apply(o.jr,a.jr),o.jd=a.jd,o.t=a.t):o=new Me,i){if(n)if(o.t&&typeof o.t=="string"){const l=Object.assign(bk(o.t,n),t);ir(i,l,n)}else t&&ir(i,t,n);o.t=i}return s.j[r]=o,o}};const B=(r,e,t,n,s)=>r.ta(e,t,n,s),X=(r,e,t,n,s)=>r.tr(e,t,n,s),Wc=(r,e,t,n,s)=>r.ts(e,t,n,s),T=(r,e,t,n,s)=>r.tt(e,t,n,s),ht="WORD",ca="UWORD",Hh="ASCIINUMERICAL",Vh="ALPHANUMERICAL",Bn="LOCALHOST",ua="TLD",da="UTLD",bs="SCHEME",Dr="SLASH_SCHEME",Za="NUM",ha="WS",el="NL",yn="OPENBRACE",bn="CLOSEBRACE",zs="OPENBRACKET",Us="CLOSEBRACKET",Fs="OPENPAREN",Hs="CLOSEPAREN",Vs="OPENANGLEBRACKET",qs="CLOSEANGLEBRACKET",Ws="FULLWIDTHLEFTPAREN",Ks="FULLWIDTHRIGHTPAREN",Js="LEFTCORNERBRACKET",Gs="RIGHTCORNERBRACKET",Ys="LEFTWHITECORNERBRACKET",Qs="RIGHTWHITECORNERBRACKET",Xs="FULLWIDTHLESSTHAN",Zs="FULLWIDTHGREATERTHAN",ei="AMPERSAND",ti="APOSTROPHE",ri="ASTERISK",Ct="AT",ni="BACKSLASH",si="BACKTICK",ii="CARET",It="COLON",tl="COMMA",oi="DOLLAR",rt="DOT",ai="EQUALS",rl="EXCLAMATION",Ue="HYPHEN",wn="PERCENT",li="PIPE",ci="PLUS",ui="POUND",vn="QUERY",nl="QUOTE",qh="FULLWIDTHMIDDLEDOT",sl="SEMI",nt="SLASH",kn="TILDE",di="UNDERSCORE",Wh="EMOJI",hi="SYM";var Kh=Object.freeze({__proto__:null,ALPHANUMERICAL:Vh,AMPERSAND:ei,APOSTROPHE:ti,ASCIINUMERICAL:Hh,ASTERISK:ri,AT:Ct,BACKSLASH:ni,BACKTICK:si,CARET:ii,CLOSEANGLEBRACKET:qs,CLOSEBRACE:bn,CLOSEBRACKET:Us,CLOSEPAREN:Hs,COLON:It,COMMA:tl,DOLLAR:oi,DOT:rt,EMOJI:Wh,EQUALS:ai,EXCLAMATION:rl,FULLWIDTHGREATERTHAN:Zs,FULLWIDTHLEFTPAREN:Ws,FULLWIDTHLESSTHAN:Xs,FULLWIDTHMIDDLEDOT:qh,FULLWIDTHRIGHTPAREN:Ks,HYPHEN:Ue,LEFTCORNERBRACKET:Js,LEFTWHITECORNERBRACKET:Ys,LOCALHOST:Bn,NL:el,NUM:Za,OPENANGLEBRACKET:Vs,OPENBRACE:yn,OPENBRACKET:zs,OPENPAREN:Fs,PERCENT:wn,PIPE:li,PLUS:ci,POUND:ui,QUERY:vn,QUOTE:nl,RIGHTCORNERBRACKET:Gs,RIGHTWHITECORNERBRACKET:Qs,SCHEME:bs,SEMI:sl,SLASH:nt,SLASH_SCHEME:Dr,SYM:hi,TILDE:kn,TLD:ua,UNDERSCORE:di,UTLD:da,UWORD:ca,WORD:ht,WS:ha});const ut=/[a-z]/,rn=new RegExp("\\p{L}","u"),po=new RegExp("\\p{Emoji}","u"),dt=/\d/,mo=/\s/,Kc="\r",go=`
`,wk="",vk="",yo="";let us=null,ds=null;function kk(r=[]){const e={};Me.groups=e;const t=new Me;us==null&&(us=Jc(fk)),ds==null&&(ds=Jc(pk)),T(t,"'",ti),T(t,"{",yn),T(t,"}",bn),T(t,"[",zs),T(t,"]",Us),T(t,"(",Fs),T(t,")",Hs),T(t,"<",Vs),T(t,">",qs),T(t,"",Ws),T(t,"",Ks),T(t,"",Js),T(t,"",Gs),T(t,"",Ys),T(t,"",Qs),T(t,"",Xs),T(t,"",Zs),T(t,"&",ei),T(t,"*",ri),T(t,"@",Ct),T(t,"`",si),T(t,"^",ii),T(t,":",It),T(t,",",tl),T(t,"$",oi),T(t,".",rt),T(t,"=",ai),T(t,"!",rl),T(t,"-",Ue),T(t,"%",wn),T(t,"|",li),T(t,"+",ci),T(t,"#",ui),T(t,"?",vn),T(t,'"',nl),T(t,"/",nt),T(t,";",sl),T(t,"~",kn),T(t,"_",di),T(t,"\\",ni),T(t,"",qh);const n=X(t,dt,Za,{[ia]:!0});X(n,dt,n);const s=X(n,ut,Hh,{[gn]:!0}),i=X(n,rn,Vh,{[cn]:!0}),o=X(t,ut,ht,{[oa]:!0});X(o,dt,s),X(o,ut,o),X(s,dt,s),X(s,ut,s);const a=X(t,rn,ca,{[aa]:!0});X(a,ut),X(a,dt,i),X(a,rn,a),X(i,dt,i),X(i,ut),X(i,rn,i);const l=T(t,go,el,{[fo]:!0}),c=T(t,Kc,ha,{[fo]:!0}),u=X(t,mo,ha,{[fo]:!0});T(t,yo,u),T(c,go,l),T(c,yo,u),X(c,mo,u),T(u,Kc),T(u,go),X(u,mo,u),T(u,yo,u);const d=X(t,po,Wh,{[Fh]:!0});T(d,"#"),X(d,po,d),T(d,wk,d);const h=T(d,vk);T(h,"#"),X(h,po,d);const f=[[ut,o],[dt,s]],p=[[ut,null],[rn,a],[dt,i]];for(let m=0;m<us.length;m++)xt(t,us[m],ua,ht,f);for(let m=0;m<ds.length;m++)xt(t,ds[m],da,ca,p);ir(ua,{tld:!0,ascii:!0},e),ir(da,{utld:!0,alpha:!0},e),xt(t,"file",bs,ht,f),xt(t,"mailto",bs,ht,f),xt(t,"http",Dr,ht,f),xt(t,"https",Dr,ht,f),xt(t,"ftp",Dr,ht,f),xt(t,"ftps",Dr,ht,f),ir(bs,{scheme:!0,ascii:!0},e),ir(Dr,{slashscheme:!0,ascii:!0},e),r=r.sort((m,g)=>m[0]>g[0]?1:-1);for(let m=0;m<r.length;m++){const g=r[m][0],w=r[m][1]?{[mk]:!0}:{[gk]:!0};g.indexOf("-")>=0?w[la]=!0:ut.test(g)?dt.test(g)?w[gn]=!0:w[oa]=!0:w[ia]=!0,Wc(t,g,g,w)}return Wc(t,"localhost",Bn,{ascii:!0}),t.jd=new Me(hi),{start:t,tokens:Object.assign({groups:e},Kh)}}function Jh(r,e){const t=Sk(e.replace(/[A-Z]/g,a=>a.toLowerCase())),n=t.length,s=[];let i=0,o=0;for(;o<n;){let a=r,l=null,c=0,u=null,d=-1,h=-1;for(;o<n&&(l=a.go(t[o]));)a=l,a.accepts()?(d=0,h=0,u=a):d>=0&&(d+=t[o].length,h++),c+=t[o].length,i+=t[o].length,o++;i-=d,o-=h,c-=d,s.push({t:u.t,v:e.slice(i-c,i),s:i-c,e:i})}return s}function Sk(r){const e=[],t=r.length;let n=0;for(;n<t;){let s=r.charCodeAt(n),i,o=s<55296||s>56319||n+1===t||(i=r.charCodeAt(n+1))<56320||i>57343?r[n]:r.slice(n,n+2);e.push(o),n+=o.length}return e}function xt(r,e,t,n,s){let i;const o=e.length;for(let a=0;a<o-1;a++){const l=e[a];r.j[l]?i=r.j[l]:(i=new Me(n),i.jr=s.slice(),r.j[l]=i),r=i}return i=new Me(t),i.jr=s.slice(),r.j[e[o-1]]=i,i}function Jc(r){const e=[],t=[];let n=0,s="0123456789";for(;n<r.length;){let i=0;for(;s.indexOf(r[n+i])>=0;)i++;if(i>0){e.push(t.join(""));for(let o=parseInt(r.substring(n,n+i),10);o>0;o--)t.pop();n+=i}else t.push(r[n]),n++}return e}const zn={defaultProtocol:"http",events:null,format:Gc,formatHref:Gc,nl2br:!1,tagName:"a",target:null,rel:null,validate:!0,truncate:1/0,className:null,attributes:null,ignoreTags:[],render:null};function il(r,e=null){let t=Object.assign({},zn);r&&(t=Object.assign(t,r instanceof il?r.o:r));const n=t.ignoreTags,s=[];for(let i=0;i<n.length;i++)s.push(n[i].toUpperCase());this.o=t,e&&(this.defaultRender=e),this.ignoreTags=s}il.prototype={o:zn,ignoreTags:[],defaultRender(r){return r},check(r){return this.get("validate",r.toString(),r)},get(r,e,t){const n=e!=null;let s=this.o[r];return s&&(typeof s=="object"?(s=t.t in s?s[t.t]:zn[r],typeof s=="function"&&n&&(s=s(e,t))):typeof s=="function"&&n&&(s=s(e,t.t,t)),s)},getObj(r,e,t){let n=this.o[r];return typeof n=="function"&&e!=null&&(n=n(e,t.t,t)),n},render(r){const e=r.render(this);return(this.get("render",null,r)||this.defaultRender)(e,r.t,r)}};function Gc(r){return r}function Gh(r,e){this.t="token",this.v=r,this.tk=e}Gh.prototype={isLink:!1,toString(){return this.v},toHref(r){return this.toString()},toFormattedString(r){const e=this.toString(),t=r.get("truncate",e,this),n=r.get("format",e,this);return t&&n.length>t?n.substring(0,t)+"":n},toFormattedHref(r){return r.get("formatHref",this.toHref(r.get("defaultProtocol")),this)},startIndex(){return this.tk[0].s},endIndex(){return this.tk[this.tk.length-1].e},toObject(r=zn.defaultProtocol){return{type:this.t,value:this.toString(),isLink:this.isLink,href:this.toHref(r),start:this.startIndex(),end:this.endIndex()}},toFormattedObject(r){return{type:this.t,value:this.toFormattedString(r),isLink:this.isLink,href:this.toFormattedHref(r),start:this.startIndex(),end:this.endIndex()}},validate(r){return r.get("validate",this.toString(),this)},render(r){const e=this,t=this.toHref(r.get("defaultProtocol")),n=r.get("formatHref",t,this),s=r.get("tagName",t,e),i=this.toFormattedString(r),o={},a=r.get("className",t,e),l=r.get("target",t,e),c=r.get("rel",t,e),u=r.getObj("attributes",t,e),d=r.getObj("events",t,e);return o.href=n,a&&(o.class=a),l&&(o.target=l),c&&(o.rel=c),u&&Object.assign(o,u),{tagName:s,attributes:o,content:i,eventListeners:d}}};function $i(r,e){class t extends Gh{constructor(s,i){super(s,i),this.t=r}}for(const n in e)t.prototype[n]=e[n];return t.t=r,t}const Yc=$i("email",{isLink:!0,toHref(){return"mailto:"+this.toString()}}),Qc=$i("text"),xk=$i("nl"),hs=$i("url",{isLink:!0,toHref(r=zn.defaultProtocol){return this.hasProtocol()?this.v:`${r}://${this.v}`},hasProtocol(){const r=this.tk;return r.length>=2&&r[0].t!==Bn&&r[1].t===It}}),ze=r=>new Me(r);function Tk({groups:r}){const e=r.domain.concat([ei,ri,Ct,ni,si,ii,oi,ai,Ue,Za,wn,li,ci,ui,nt,hi,kn,di]),t=[ti,It,tl,rt,rl,wn,vn,nl,sl,Vs,qs,yn,bn,Us,zs,Fs,Hs,Ws,Ks,Js,Gs,Ys,Qs,Xs,Zs],n=[ei,ti,ri,ni,si,ii,oi,ai,Ue,yn,bn,wn,li,ci,ui,vn,nt,hi,kn,di],s=ze(),i=T(s,kn);B(i,n,i),B(i,r.domain,i);const o=ze(),a=ze(),l=ze();B(s,r.domain,o),B(s,r.scheme,a),B(s,r.slashscheme,l),B(o,n,i),B(o,r.domain,o);const c=T(o,Ct);T(i,Ct,c),T(a,Ct,c),T(l,Ct,c);const u=T(i,rt);B(u,n,i),B(u,r.domain,i);const d=ze();B(c,r.domain,d),B(d,r.domain,d);const h=T(d,rt);B(h,r.domain,d);const f=ze(Yc);B(h,r.tld,f),B(h,r.utld,f),T(c,Bn,f);const p=T(d,Ue);T(p,Ue,p),B(p,r.domain,d),B(f,r.domain,d),T(f,rt,h),T(f,Ue,p);const m=T(f,It);B(m,r.numeric,Yc);const g=T(o,Ue),y=T(o,rt);T(g,Ue,g),B(g,r.domain,o),B(y,n,i),B(y,r.domain,o);const w=ze(hs);B(y,r.tld,w),B(y,r.utld,w),B(w,r.domain,o),B(w,n,i),T(w,rt,y),T(w,Ue,g),T(w,Ct,c);const v=T(w,It),_=ze(hs);B(v,r.numeric,_);const E=ze(hs),S=ze();B(E,e,E),B(E,t,S),B(S,e,E),B(S,t,S),T(w,nt,E),T(_,nt,E);const x=T(a,It),I=T(l,It),$=T(I,nt),G=T($,nt);B(a,r.domain,o),T(a,rt,y),T(a,Ue,g),B(l,r.domain,o),T(l,rt,y),T(l,Ue,g),B(x,r.domain,E),T(x,nt,E),T(x,vn,E),B(G,r.domain,E),B(G,e,E),T(G,nt,E);const Re=[[yn,bn],[zs,Us],[Fs,Hs],[Vs,qs],[Ws,Ks],[Js,Gs],[Ys,Qs],[Xs,Zs]];for(let je=0;je<Re.length;je++){const[tt,j]=Re[je],Y=T(E,tt);T(S,tt,Y),T(Y,j,E);const Be=ze(hs);B(Y,e,Be);const _e=ze();B(Y,t),B(Be,e,Be),B(Be,t,_e),B(_e,e,Be),B(_e,t,_e),T(Be,j,E),T(_e,j,E)}return T(s,Bn,w),T(s,el,xk),{start:s,tokens:Kh}}function _k(r,e,t){let n=t.length,s=0,i=[],o=[];for(;s<n;){let a=r,l=null,c=null,u=0,d=null,h=-1;for(;s<n&&!(l=a.go(t[s].t));)o.push(t[s++]);for(;s<n&&(c=l||a.go(t[s].t));)l=null,a=c,a.accepts()?(h=0,d=a):h>=0&&h++,s++,u++;if(h<0)s-=u,s<n&&(o.push(t[s]),s++);else{o.length>0&&(i.push(bo(Qc,e,o)),o=[]),s-=h,u-=h;const f=d.t,p=t.slice(s-u,s);i.push(bo(f,e,p))}}return o.length>0&&i.push(bo(Qc,e,o)),i}function bo(r,e,t){const n=t[0].s,s=t[t.length-1].e,i=e.slice(n,s);return new r(i,t)}const Ek=typeof console<"u"&&console&&console.warn||(()=>{}),Ck="until manual call of linkify.init(). Register all schemes and plugins before invoking linkify the first time.",W={scanner:null,parser:null,tokenQueue:[],pluginQueue:[],customSchemes:[],initialized:!1};function Ak(){return Me.groups={},W.scanner=null,W.parser=null,W.tokenQueue=[],W.pluginQueue=[],W.customSchemes=[],W.initialized=!1,W}function Xc(r,e=!1){if(W.initialized&&Ek(`linkifyjs: already initialized - will not register custom scheme "${r}" ${Ck}`),!/^[0-9a-z]+(-[0-9a-z]+)*$/.test(r))throw new Error(`linkifyjs: incorrect scheme format.
1. Must only contain digits, lowercase ASCII letters or "-"
2. Cannot start or end with "-"
3. "-" cannot repeat`);W.customSchemes.push([r,e])}function Ok(){W.scanner=kk(W.customSchemes);for(let r=0;r<W.tokenQueue.length;r++)W.tokenQueue[r][1]({scanner:W.scanner});W.parser=Tk(W.scanner.tokens);for(let r=0;r<W.pluginQueue.length;r++)W.pluginQueue[r][1]({scanner:W.scanner,parser:W.parser});return W.initialized=!0,W}function ol(r){return W.initialized||Ok(),_k(W.parser.start,r,Jh(W.scanner.start,r))}ol.scan=Jh;function Yh(r,e=null,t=null){if(e&&typeof e=="object"){if(t)throw Error(`linkifyjs: Invalid link type ${e}; must be a string`);t=e,e=null}const n=new il(t),s=ol(r),i=[];for(let o=0;o<s.length;o++){const a=s[o];a.isLink&&(!e||a.t===e)&&n.check(a)&&i.push(a.toFormattedObject(n))}return i}var al="[\0- -\u2029]",Mk=new RegExp(al),Ik=new RegExp(`${al}$`),Rk=new RegExp(al,"g");function Nk(r){return r.length===1?r[0].isLink:r.length===3&&r[1].isLink?["()","[]"].includes(r[0].value+r[2].value):!1}function Pk(r){return new K({key:new ne("autolink"),appendTransaction:(e,t,n)=>{const s=e.some(c=>c.docChanged)&&!t.doc.eq(n.doc),i=e.some(c=>c.getMeta("preventAutolink"));if(!s||i)return;const{tr:o}=n,a=gh(t.doc,[...e]);if(xh(a).forEach(({newRange:c})=>{const u=Lv(n.doc,c,f=>f.isTextblock);let d,h;if(u.length>1)d=u[0],h=n.doc.textBetween(d.pos,d.pos+d.node.nodeSize,void 0," ");else if(u.length){const f=n.doc.textBetween(c.from,c.to," "," ");if(!Ik.test(f))return;d=u[0],h=n.doc.textBetween(d.pos,c.to,void 0," ")}if(d&&h){const f=h.split(Mk).filter(Boolean);if(f.length<=0)return!1;const p=f[f.length-1],m=d.pos+h.lastIndexOf(p);if(!p)return!1;const g=ol(p).map(y=>y.toObject(r.defaultProtocol));if(!Nk(g))return!1;g.filter(y=>y.isLink).map(y=>({...y,from:m+y.start+1,to:m+y.end+1})).filter(y=>n.schema.marks.code?!n.doc.rangeHasMark(y.from,y.to,n.schema.marks.code):!0).filter(y=>r.validate(y.value)).filter(y=>r.shouldAutoLink(y.value)).forEach(y=>{Ja(y.from,y.to,n.doc).some(w=>w.mark.type===r.type)||o.addMark(y.from,y.to,r.type.create({href:y.href}))})}}),!!o.steps.length)return o}})}function Dk(r){return new K({key:new ne("handleClickLink"),props:{handleClick:(e,t,n)=>{var s,i;if(n.button!==0||!e.editable)return!1;let o=!1;if(r.enableClickSelection&&(o=r.editor.commands.extendMarkRange(r.type.name)),r.openOnClick){let a=null;if(n.target instanceof HTMLAnchorElement)a=n.target;else{let d=n.target;const h=[];for(;d.nodeName!=="DIV";)h.push(d),d=d.parentNode;a=h.find(f=>f.nodeName==="A")}if(!a)return o;const l=Sh(e.state,r.type.name),c=(s=a?.href)!=null?s:l.href,u=(i=a?.target)!=null?i:l.target;a&&c&&(window.open(c,u),o=!0)}return o}}})}function $k(r){return new K({key:new ne("handlePasteLink"),props:{handlePaste:(e,t,n)=>{const{shouldAutoLink:s}=r,{state:i}=e,{selection:o}=i,{empty:a}=o;if(a)return!1;let l="";n.content.forEach(u=>{l+=u.textContent});const c=Yh(l,{defaultProtocol:r.defaultProtocol}).find(u=>u.isLink&&u.value===l);return!l||!c||s!==void 0&&!s(c.value)?!1:r.editor.commands.setMark(r.type,{href:c.href})}}})}function Yt(r,e){const t=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(n=>{const s=typeof n=="string"?n:n.scheme;s&&t.push(s)}),!r||r.replace(Rk,"").match(new RegExp(`^(?:(?:${t.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var Lk=kt.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate,console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")),this.options.protocols.forEach(r=>{if(typeof r=="string"){Xc(r);return}Xc(r.scheme,r.optionalSlashes)})},onDestroy(){Ak()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,enableClickSelection:!1,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(r,e)=>!!Yt(r,e.protocols),validate:r=>!!r,shouldAutoLink:r=>{const e=/^[a-z][a-z0-9+.-]*:\/\//i.test(r),t=/^[a-z][a-z0-9+.-]*:/i.test(r);if(e||t&&!r.includes("@"))return!0;const s=(r.includes("@")?r.split("@").pop():r).split(/[/?#:]/)[0];return!(/^\d{1,3}(\.\d{1,3}){3}$/.test(s)||!/\./.test(s))}}},addAttributes(){return{href:{default:null,parseHTML(r){return r.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:r=>{const e=r.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:t=>!!Yt(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:r}){return this.options.isAllowedUri(r.href,{defaultValidate:e=>!!Yt(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",te(this.options.HTMLAttributes,r),0]:["a",te(this.options.HTMLAttributes,{...r,href:""}),0]},markdownTokenName:"link",parseMarkdown:(r,e)=>e.applyMark("link",e.parseInline(r.tokens||[]),{href:r.href,title:r.title||null}),renderMarkdown:(r,e)=>{var t;const n=((t=r.attrs)==null?void 0:t.href)||"";return`[${e.renderChildren(r)}](${n})`},addCommands(){return{setLink:r=>({chain:e})=>{const{href:t}=r;return this.options.isAllowedUri(t,{defaultValidate:n=>!!Yt(n,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,r).setMeta("preventAutolink",!0).run():!1},toggleLink:r=>({chain:e})=>{const{href:t}=r||{};return t&&!this.options.isAllowedUri(t,{defaultValidate:n=>!!Yt(n,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:e().toggleMark(this.name,r,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()},unsetLink:()=>({chain:r})=>r().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[Ht({find:r=>{const e=[];if(r){const{protocols:t,defaultProtocol:n}=this.options,s=Yh(r).filter(i=>i.isLink&&this.options.isAllowedUri(i.value,{defaultValidate:o=>!!Yt(o,t),protocols:t,defaultProtocol:n}));s.length&&s.forEach(i=>{this.options.shouldAutoLink(i.value)&&e.push({text:i.value,data:{href:i.href},index:i.start})})}return e},type:this.type,getAttributes:r=>{var e;return{href:(e=r.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const r=[],{protocols:e,defaultProtocol:t}=this.options;return this.options.autolink&&r.push(Pk({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:n=>this.options.isAllowedUri(n,{defaultValidate:s=>!!Yt(s,e),protocols:e,defaultProtocol:t}),shouldAutoLink:this.options.shouldAutoLink})),r.push(Dk({type:this.type,editor:this.editor,openOnClick:this.options.openOnClick==="whenNotEditable"?!0:this.options.openOnClick,enableClickSelection:this.options.enableClickSelection})),this.options.linkOnPaste&&r.push($k({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type,shouldAutoLink:this.options.shouldAutoLink})),r}}),jk=Object.defineProperty,Bk=(r,e)=>{for(var t in e)jk(r,t,{get:e[t],enumerable:!0})},zk="listItem",Zc="textStyle",eu=/^\s*([-+*])\s$/,Qh=Oe.create({name:"bulletList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:"ul"}]},renderHTML({HTMLAttributes:r}){return["ul",te(this.options.HTMLAttributes,r),0]},markdownTokenName:"list",parseMarkdown:(r,e)=>r.type!=="list"||r.ordered?[]:{type:"bulletList",content:r.items?e.parseChildren(r.items):[]},renderMarkdown:(r,e)=>r.content?e.renderChildren(r.content,`
`):"",markdownOptions:{indentsContent:!0},addCommands(){return{toggleBulletList:()=>({commands:r,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(zk,this.editor.getAttributes(Zc)).run():r.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-8":()=>this.editor.commands.toggleBulletList()}},addInputRules(){let r=Kr({find:eu,type:this.type});return(this.options.keepMarks||this.options.keepAttributes)&&(r=Kr({find:eu,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:()=>this.editor.getAttributes(Zc),editor:this.editor})),[r]}}),Xh=Oe.create({name:"listItem",addOptions(){return{HTMLAttributes:{},bulletListTypeName:"bulletList",orderedListTypeName:"orderedList"}},content:"paragraph block*",defining:!0,parseHTML(){return[{tag:"li"}]},renderHTML({HTMLAttributes:r}){return["li",te(this.options.HTMLAttributes,r),0]},markdownTokenName:"list_item",parseMarkdown:(r,e)=>{if(r.type!=="list_item")return[];let t=[];if(r.tokens&&r.tokens.length>0)if(r.tokens.some(s=>s.type==="paragraph"))t=e.parseChildren(r.tokens);else{const s=r.tokens[0];if(s&&s.type==="text"&&s.tokens&&s.tokens.length>0){if(t=[{type:"paragraph",content:e.parseInline(s.tokens)}],r.tokens.length>1){const o=r.tokens.slice(1),a=e.parseChildren(o);t.push(...a)}}else t=e.parseChildren(r.tokens)}return t.length===0&&(t=[{type:"paragraph",content:[]}]),{type:"listItem",content:t}},renderMarkdown:(r,e,t)=>Xa(r,e,n=>n.parentType==="bulletList"?"- ":n.parentType==="orderedList"?`${n.index+1}. `:"- ",t),addKeyboardShortcuts(){return{Enter:()=>this.editor.commands.splitListItem(this.name),Tab:()=>this.editor.commands.sinkListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)}}}),Uk={};Bk(Uk,{findListItemPos:()=>Kn,getNextListDepth:()=>ll,handleBackspace:()=>fa,handleDelete:()=>pa,hasListBefore:()=>Zh,hasListItemAfter:()=>Fk,hasListItemBefore:()=>ef,listItemHasSubList:()=>tf,nextListIsDeeper:()=>rf,nextListIsHigher:()=>nf});var Kn=(r,e)=>{const{$from:t}=e.selection,n=oe(r,e.schema);let s=null,i=t.depth,o=t.pos,a=null;for(;i>0&&a===null;)s=t.node(i),s.type===n?a=i:(i-=1,o-=1);return a===null?null:{$pos:e.doc.resolve(o),depth:a}},ll=(r,e)=>{const t=Kn(r,e);if(!t)return!1;const[,n]=Kv(e,r,t.$pos.pos+4);return n},Zh=(r,e,t)=>{const{$anchor:n}=r.selection,s=Math.max(0,n.pos-2),i=r.doc.resolve(s).node();return!(!i||!t.includes(i.type.name))},ef=(r,e)=>{var t;const{$anchor:n}=e.selection,s=e.doc.resolve(n.pos-2);return!(s.index()===0||((t=s.nodeBefore)==null?void 0:t.type.name)!==r)},tf=(r,e,t)=>{if(!t)return!1;const n=oe(r,e.schema);let s=!1;return t.descendants(i=>{i.type===n&&(s=!0)}),s},fa=(r,e,t)=>{if(r.commands.undoInputRule())return!0;if(r.state.selection.from!==r.state.selection.to)return!1;if(!Ft(r.state,e)&&Zh(r.state,e,t)){const{$anchor:a}=r.state.selection,l=r.state.doc.resolve(a.before()-1),c=[];l.node().descendants((h,f)=>{h.type.name===e&&c.push({node:h,pos:f})});const u=c.at(-1);if(!u)return!1;const d=r.state.doc.resolve(l.start()+u.pos+1);return r.chain().cut({from:a.start()-1,to:a.end()+1},d.end()).joinForward().run()}if(!Ft(r.state,e)||!Qv(r.state))return!1;const n=Kn(e,r.state);if(!n)return!1;const i=r.state.doc.resolve(n.$pos.pos-2).node(n.depth),o=tf(e,r.state,i);return ef(e,r.state)&&!o?r.commands.joinItemBackward():r.chain().liftListItem(e).run()},rf=(r,e)=>{const t=ll(r,e),n=Kn(r,e);return!n||!t?!1:t>n.depth},nf=(r,e)=>{const t=ll(r,e),n=Kn(r,e);return!n||!t?!1:t<n.depth},pa=(r,e)=>{if(!Ft(r.state,e)||!Yv(r.state,e))return!1;const{selection:t}=r.state,{$from:n,$to:s}=t;return!t.empty&&n.sameParent(s)?!1:rf(e,r.state)?r.chain().focus(r.state.selection.from+4).lift(e).joinBackward().run():nf(e,r.state)?r.chain().joinForward().joinBackward().run():r.commands.joinItemForward()},Fk=(r,e)=>{var t;const{$anchor:n}=e.selection,s=e.doc.resolve(n.pos-n.parentOffset-2);return!(s.index()===s.parent.childCount-1||((t=s.nodeAfter)==null?void 0:t.type.name)!==r)},sf=F.create({name:"listKeymap",addOptions(){return{listTypes:[{itemName:"listItem",wrapperNames:["bulletList","orderedList"]},{itemName:"taskItem",wrapperNames:["taskList"]}]}},addKeyboardShortcuts(){return{Delete:({editor:r})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t})=>{r.state.schema.nodes[t]!==void 0&&pa(r,t)&&(e=!0)}),e},"Mod-Delete":({editor:r})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t})=>{r.state.schema.nodes[t]!==void 0&&pa(r,t)&&(e=!0)}),e},Backspace:({editor:r})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t,wrapperNames:n})=>{r.state.schema.nodes[t]!==void 0&&fa(r,t,n)&&(e=!0)}),e},"Mod-Backspace":({editor:r})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t,wrapperNames:n})=>{r.state.schema.nodes[t]!==void 0&&fa(r,t,n)&&(e=!0)}),e}}}}),tu=/^(\s*)(\d+)\.\s+(.*)$/,Hk=/^\s/;function Vk(r){const e=[];let t=0,n=0;for(;t<r.length;){const s=r[t],i=s.match(tu);if(!i)break;const[,o,a,l]=i,c=o.length;let u=l,d=t+1;const h=[s];for(;d<r.length;){const f=r[d];if(f.match(tu))break;if(f.trim()==="")h.push(f),u+=`
`,d+=1;else if(f.match(Hk))h.push(f),u+=`
${f.slice(c+2)}`,d+=1;else break}e.push({indent:c,number:parseInt(a,10),content:u.trim(),raw:h.join(`
`)}),n=d,t=d}return[e,n]}function of(r,e,t){var n;const s=[];let i=0;for(;i<r.length;){const o=r[i];if(o.indent===e){const a=o.content.split(`
`),l=((n=a[0])==null?void 0:n.trim())||"",c=[];l&&c.push({type:"paragraph",raw:l,tokens:t.inlineTokens(l)});const u=a.slice(1).join(`
`).trim();if(u){const f=t.blockTokens(u);c.push(...f)}let d=i+1;const h=[];for(;d<r.length&&r[d].indent>e;)h.push(r[d]),d+=1;if(h.length>0){const f=Math.min(...h.map(m=>m.indent)),p=of(h,f,t);c.push({type:"list",ordered:!0,start:h[0].number,items:p,raw:h.map(m=>m.raw).join(`
`)})}s.push({type:"list_item",raw:o.raw,tokens:c}),i=d}else i+=1}return s}function qk(r,e){return r.map(t=>{if(t.type!=="list_item")return e.parseChildren([t])[0];const n=[];return t.tokens&&t.tokens.length>0&&t.tokens.forEach(s=>{if(s.type==="paragraph"||s.type==="list"||s.type==="blockquote"||s.type==="code")n.push(...e.parseChildren([s]));else if(s.type==="text"&&s.tokens){const i=e.parseChildren([s]);n.push({type:"paragraph",content:i})}else{const i=e.parseChildren([s]);i.length>0&&n.push(...i)}}),{type:"listItem",content:n}})}var Wk="listItem",ru="textStyle",nu=/^(\d+)\.\s$/,af=Oe.create({name:"orderedList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},addAttributes(){return{start:{default:1,parseHTML:r=>r.hasAttribute("start")?parseInt(r.getAttribute("start")||"",10):1},type:{default:null,parseHTML:r=>r.getAttribute("type")}}},parseHTML(){return[{tag:"ol"}]},renderHTML({HTMLAttributes:r}){const{start:e,...t}=r;return e===1?["ol",te(this.options.HTMLAttributes,t),0]:["ol",te(this.options.HTMLAttributes,r),0]},markdownTokenName:"list",parseMarkdown:(r,e)=>{if(r.type!=="list"||!r.ordered)return[];const t=r.start||1,n=r.items?qk(r.items,e):[];return t!==1?{type:"orderedList",attrs:{start:t},content:n}:{type:"orderedList",content:n}},renderMarkdown:(r,e)=>r.content?e.renderChildren(r.content,`
`):"",markdownTokenizer:{name:"orderedList",level:"block",start:r=>{const e=r.match(/^(\s*)(\d+)\.\s+/),t=e?.index;return t!==void 0?t:-1},tokenize:(r,e,t)=>{var n;const s=r.split(`
`),[i,o]=Vk(s);if(i.length===0)return;const a=of(i,0,t);return a.length===0?void 0:{type:"list",ordered:!0,start:((n=i[0])==null?void 0:n.number)||1,items:a,raw:s.slice(0,o).join(`
`)}}},markdownOptions:{indentsContent:!0},addCommands(){return{toggleOrderedList:()=>({commands:r,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(Wk,this.editor.getAttributes(ru)).run():r.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-7":()=>this.editor.commands.toggleOrderedList()}},addInputRules(){let r=Kr({find:nu,type:this.type,getAttributes:e=>({start:+e[1]}),joinPredicate:(e,t)=>t.childCount+t.attrs.start===+e[1]});return(this.options.keepMarks||this.options.keepAttributes)&&(r=Kr({find:nu,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:e=>({start:+e[1],...this.editor.getAttributes(ru)}),joinPredicate:(e,t)=>t.childCount+t.attrs.start===+e[1],editor:this.editor})),[r]}}),Kk=/^\s*(\[([( |x])?\])\s$/,Jk=Oe.create({name:"taskItem",addOptions(){return{nested:!1,HTMLAttributes:{},taskListTypeName:"taskList",a11y:void 0}},content(){return this.options.nested?"paragraph block*":"paragraph+"},defining:!0,addAttributes(){return{checked:{default:!1,keepOnSplit:!1,parseHTML:r=>{const e=r.getAttribute("data-checked");return e===""||e==="true"},renderHTML:r=>({"data-checked":r.checked})}}},parseHTML(){return[{tag:`li[data-type="${this.name}"]`,priority:51}]},renderHTML({node:r,HTMLAttributes:e}){return["li",te(this.options.HTMLAttributes,e,{"data-type":this.name}),["label",["input",{type:"checkbox",checked:r.attrs.checked?"checked":null}],["span"]],["div",0]]},parseMarkdown:(r,e)=>{const t=[];if(r.tokens&&r.tokens.length>0?t.push(e.createNode("paragraph",{},e.parseInline(r.tokens))):r.text?t.push(e.createNode("paragraph",{},[e.createNode("text",{text:r.text})])):t.push(e.createNode("paragraph",{},[])),r.nestedTokens&&r.nestedTokens.length>0){const n=e.parseChildren(r.nestedTokens);t.push(...n)}return e.createNode("taskItem",{checked:r.checked||!1},t)},renderMarkdown:(r,e)=>{var t;const s=`- [${(t=r.attrs)!=null&&t.checked?"x":" "}] `;return Xa(r,e,s)},addKeyboardShortcuts(){const r={Enter:()=>this.editor.commands.splitListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)};return this.options.nested?{...r,Tab:()=>this.editor.commands.sinkListItem(this.name)}:r},addNodeView(){return({node:r,HTMLAttributes:e,getPos:t,editor:n})=>{const s=document.createElement("li"),i=document.createElement("label"),o=document.createElement("span"),a=document.createElement("input"),l=document.createElement("div"),c=d=>{var h,f;a.ariaLabel=((f=(h=this.options.a11y)==null?void 0:h.checkboxLabel)==null?void 0:f.call(h,d,a.checked))||`Task item checkbox for ${d.textContent||"empty task item"}`};c(r),i.contentEditable="false",a.type="checkbox",a.addEventListener("mousedown",d=>d.preventDefault()),a.addEventListener("change",d=>{if(!n.isEditable&&!this.options.onReadOnlyChecked){a.checked=!a.checked;return}const{checked:h}=d.target;n.isEditable&&typeof t=="function"&&n.chain().focus(void 0,{scrollIntoView:!1}).command(({tr:f})=>{const p=t();if(typeof p!="number")return!1;const m=f.doc.nodeAt(p);return f.setNodeMarkup(p,void 0,{...m?.attrs,checked:h}),!0}).run(),!n.isEditable&&this.options.onReadOnlyChecked&&(this.options.onReadOnlyChecked(r,h)||(a.checked=!a.checked))}),Object.entries(this.options.HTMLAttributes).forEach(([d,h])=>{s.setAttribute(d,h)}),s.dataset.checked=r.attrs.checked,a.checked=r.attrs.checked,i.append(a,o),s.append(i,l),Object.entries(e).forEach(([d,h])=>{s.setAttribute(d,h)});let u=new Set(Object.keys(e));return{dom:s,contentDOM:l,update:d=>{if(d.type!==this.type)return!1;s.dataset.checked=d.attrs.checked,a.checked=d.attrs.checked,c(d);const h=n.extensionManager.attributes,f=jn(d,h),p=new Set(Object.keys(f)),m=this.options.HTMLAttributes;return u.forEach(g=>{p.has(g)||(g in m?s.setAttribute(g,m[g]):s.removeAttribute(g))}),Object.entries(f).forEach(([g,y])=>{y==null?g in m?s.setAttribute(g,m[g]):s.removeAttribute(g):s.setAttribute(g,y)}),u=p,!0}}}},addInputRules(){return[Kr({find:Kk,type:this.type,getAttributes:r=>({checked:r[r.length-1]==="x"})})]}}),Gk=Oe.create({name:"taskList",addOptions(){return{itemTypeName:"taskItem",HTMLAttributes:{}}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:`ul[data-type="${this.name}"]`,priority:51}]},renderHTML({HTMLAttributes:r}){return["ul",te(this.options.HTMLAttributes,r,{"data-type":this.name}),0]},parseMarkdown:(r,e)=>e.createNode("taskList",{},e.parseChildren(r.items||[])),renderMarkdown:(r,e)=>r.content?e.renderChildren(r.content,`
`):"",markdownTokenizer:{name:"taskList",level:"block",start(r){var e;const t=(e=r.match(/^\s*[-+*]\s+\[([ xX])\]\s+/))==null?void 0:e.index;return t!==void 0?t:-1},tokenize(r,e,t){const n=i=>{const o=sa(i,{itemPattern:/^(\s*)([-+*])\s+\[([ xX])\]\s+(.*)$/,extractItemData:a=>({indentLevel:a[1].length,mainContent:a[4],checked:a[3].toLowerCase()==="x"}),createToken:(a,l)=>({type:"taskItem",raw:"",mainContent:a.mainContent,indentLevel:a.indentLevel,checked:a.checked,text:a.mainContent,tokens:t.inlineTokens(a.mainContent),nestedTokens:l}),customNestedParser:n},t);return o?[{type:"taskList",raw:o.raw,items:o.items}]:t.blockTokens(i)},s=sa(r,{itemPattern:/^(\s*)([-+*])\s+\[([ xX])\]\s+(.*)$/,extractItemData:i=>({indentLevel:i[1].length,mainContent:i[4],checked:i[3].toLowerCase()==="x"}),createToken:(i,o)=>({type:"taskItem",raw:"",mainContent:i.mainContent,indentLevel:i.indentLevel,checked:i.checked,text:i.mainContent,tokens:t.inlineTokens(i.mainContent),nestedTokens:o}),customNestedParser:n},t);if(s)return{type:"taskList",raw:s.raw,items:s.items}}},markdownOptions:{indentsContent:!0},addCommands(){return{toggleTaskList:()=>({commands:r})=>r.toggleList(this.name,this.options.itemTypeName)}},addKeyboardShortcuts(){return{"Mod-Shift-9":()=>this.editor.commands.toggleTaskList()}}});F.create({name:"listKit",addExtensions(){const r=[];return this.options.bulletList!==!1&&r.push(Qh.configure(this.options.bulletList)),this.options.listItem!==!1&&r.push(Xh.configure(this.options.listItem)),this.options.listKeymap!==!1&&r.push(sf.configure(this.options.listKeymap)),this.options.orderedList!==!1&&r.push(af.configure(this.options.orderedList)),this.options.taskItem!==!1&&r.push(Jk.configure(this.options.taskItem)),this.options.taskList!==!1&&r.push(Gk.configure(this.options.taskList)),r}});var Yk=Oe.create({name:"paragraph",priority:1e3,addOptions(){return{HTMLAttributes:{}}},group:"block",content:"inline*",parseHTML(){return[{tag:"p"}]},renderHTML({HTMLAttributes:r}){return["p",te(this.options.HTMLAttributes,r),0]},parseMarkdown:(r,e)=>{const t=r.tokens||[];return t.length===1&&t[0].type==="image"?e.parseChildren([t[0]]):e.createNode("paragraph",void 0,e.parseInline(t))},renderMarkdown:(r,e)=>!r||!Array.isArray(r.content)?"":e.renderChildren(r.content),addCommands(){return{setParagraph:()=>({commands:r})=>r.setNode(this.name)}},addKeyboardShortcuts(){return{"Mod-Alt-0":()=>this.editor.commands.setParagraph()}}}),Qk=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))$/,Xk=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))/g,Zk=kt.create({name:"strike",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"s"},{tag:"del"},{tag:"strike"},{style:"text-decoration",consuming:!1,getAttrs:r=>r.includes("line-through")?{}:!1}]},renderHTML({HTMLAttributes:r}){return["s",te(this.options.HTMLAttributes,r),0]},markdownTokenName:"del",parseMarkdown:(r,e)=>e.applyMark("strike",e.parseInline(r.tokens||[])),renderMarkdown:(r,e)=>`~~${e.renderChildren(r)}~~`,addCommands(){return{setStrike:()=>({commands:r})=>r.setMark(this.name),toggleStrike:()=>({commands:r})=>r.toggleMark(this.name),unsetStrike:()=>({commands:r})=>r.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-s":()=>this.editor.commands.toggleStrike()}},addInputRules(){return[yr({find:Qk,type:this.type})]},addPasteRules(){return[Ht({find:Xk,type:this.type})]}}),eS=Oe.create({name:"text",group:"inline",parseMarkdown:r=>({type:"text",text:r.text||""}),renderMarkdown:r=>r.text||""}),tS=kt.create({name:"underline",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"u"},{style:"text-decoration",consuming:!1,getAttrs:r=>r.includes("underline")?{}:!1}]},renderHTML({HTMLAttributes:r}){return["u",te(this.options.HTMLAttributes,r),0]},parseMarkdown(r,e){return e.applyMark(this.name||"underline",e.parseInline(r.tokens||[]))},renderMarkdown(r,e){return`++${e.renderChildren(r)}++`},markdownTokenizer:{name:"underline",level:"inline",start(r){return r.indexOf("++")},tokenize(r,e,t){const s=/^(\+\+)([\s\S]+?)(\+\+)/.exec(r);if(!s)return;const i=s[2].trim();return{type:"underline",raw:s[0],text:i,tokens:t.inlineTokens(i)}}},addCommands(){return{setUnderline:()=>({commands:r})=>r.setMark(this.name),toggleUnderline:()=>({commands:r})=>r.toggleMark(this.name),unsetUnderline:()=>({commands:r})=>r.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-u":()=>this.editor.commands.toggleUnderline(),"Mod-U":()=>this.editor.commands.toggleUnderline()}}});function rS(r={}){return new K({view(e){return new nS(e,r)}})}class nS{constructor(e,t){var n;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(n=t.width)!==null&&n!==void 0?n:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(s=>{let i=o=>{this[s](o)};return e.dom.addEventListener(s,i),{name:s,handler:i}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,n,s=this.editorView.dom,i=s.getBoundingClientRect(),o=i.width/s.offsetWidth,a=i.height/s.offsetHeight;if(t){let d=e.nodeBefore,h=e.nodeAfter;if(d||h){let f=this.editorView.nodeDOM(this.cursorPos-(d?d.nodeSize:0));if(f){let p=f.getBoundingClientRect(),m=d?p.bottom:p.top;d&&h&&(m=(m+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2);let g=this.width/2*a;n={left:p.left,right:p.right,top:m-g,bottom:m+g}}}}if(!n){let d=this.editorView.coordsAtPos(this.cursorPos),h=this.width/2*o;n={left:d.left-h,right:d.left+h,top:d.top,bottom:d.bottom}}let l=this.editorView.dom.offsetParent;this.element||(this.element=l.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let c,u;if(!l||l==document.body&&getComputedStyle(l).position=="static")c=-pageXOffset,u=-pageYOffset;else{let d=l.getBoundingClientRect(),h=d.width/l.offsetWidth,f=d.height/l.offsetHeight;c=d.left-l.scrollLeft*h,u=d.top-l.scrollTop*f}this.element.style.left=(n.left-c)/o+"px",this.element.style.top=(n.top-u)/a+"px",this.element.style.width=(n.right-n.left)/o+"px",this.element.style.height=(n.bottom-n.top)/a+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),n=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),s=n&&n.type.spec.disableDropCursor,i=typeof s=="function"?s(this.editorView,t,e):s;if(t&&!i){let o=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=ad(this.editorView.state.doc,o,this.editorView.dragging.slice);a!=null&&(o=a)}this.setCursor(o),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){this.editorView.dom.contains(e.relatedTarget)||this.setCursor(null)}}class ee extends z{constructor(e){super(e,e)}map(e,t){let n=e.resolve(t.map(this.head));return ee.valid(n)?new ee(n):z.near(n)}content(){return C.empty}eq(e){return e instanceof ee&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new ee(e.resolve(t.pos))}getBookmark(){return new cl(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!sS(e)||!iS(e))return!1;let n=t.type.spec.allowGapCursor;if(n!=null)return n;let s=t.contentMatchAt(e.index()).defaultType;return s&&s.isTextblock}static findGapCursorFrom(e,t,n=!1){e:for(;;){if(!n&&ee.valid(e))return e;let s=e.pos,i=null;for(let o=e.depth;;o--){let a=e.node(o);if(t>0?e.indexAfter(o)<a.childCount:e.index(o)>0){i=a.child(t>0?e.indexAfter(o):e.index(o)-1);break}else if(o==0)return null;s+=t;let l=e.doc.resolve(s);if(ee.valid(l))return l}for(;;){let o=t>0?i.firstChild:i.lastChild;if(!o){if(i.isAtom&&!i.isText&&!M.isSelectable(i)){e=e.doc.resolve(s+i.nodeSize*t),n=!1;continue e}break}i=o,s+=t;let a=e.doc.resolve(s);if(ee.valid(a))return a}return null}}}ee.prototype.visible=!1;ee.findFrom=ee.findGapCursorFrom;z.jsonID("gapcursor",ee);class cl{constructor(e){this.pos=e}map(e){return new cl(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return ee.valid(t)?new ee(t):z.near(t)}}function lf(r){return r.isAtom||r.spec.isolating||r.spec.createGapCursor}function sS(r){for(let e=r.depth;e>=0;e--){let t=r.index(e),n=r.node(e);if(t==0){if(n.type.spec.isolating)return!0;continue}for(let s=n.child(t-1);;s=s.lastChild){if(s.childCount==0&&!s.inlineContent||lf(s.type))return!0;if(s.inlineContent)return!1}}return!0}function iS(r){for(let e=r.depth;e>=0;e--){let t=r.indexAfter(e),n=r.node(e);if(t==n.childCount){if(n.type.spec.isolating)return!0;continue}for(let s=n.child(t);;s=s.firstChild){if(s.childCount==0&&!s.inlineContent||lf(s.type))return!0;if(s.inlineContent)return!1}}return!0}function oS(){return new K({props:{decorations:uS,createSelectionBetween(r,e,t){return e.pos==t.pos&&ee.valid(t)?new ee(t):null},handleClick:lS,handleKeyDown:aS,handleDOMEvents:{beforeinput:cS}}})}const aS=lh({ArrowLeft:fs("horiz",-1),ArrowRight:fs("horiz",1),ArrowUp:fs("vert",-1),ArrowDown:fs("vert",1)});function fs(r,e){const t=r=="vert"?e>0?"down":"up":e>0?"right":"left";return function(n,s,i){let o=n.selection,a=e>0?o.$to:o.$from,l=o.empty;if(o instanceof D){if(!i.endOfTextblock(t)||a.depth==0)return!1;l=!1,a=n.doc.resolve(e>0?a.after():a.before())}let c=ee.findGapCursorFrom(a,e,l);return c?(s&&s(n.tr.setSelection(new ee(c))),!0):!1}}function lS(r,e,t){if(!r||!r.editable)return!1;let n=r.state.doc.resolve(e);if(!ee.valid(n))return!1;let s=r.posAtCoords({left:t.clientX,top:t.clientY});return s&&s.inside>-1&&M.isSelectable(r.state.doc.nodeAt(s.inside))?!1:(r.dispatch(r.state.tr.setSelection(new ee(n))),!0)}function cS(r,e){if(e.inputType!="insertCompositionText"||!(r.state.selection instanceof ee))return!1;let{$from:t}=r.state.selection,n=t.parent.contentMatchAt(t.index()).findWrapping(r.state.schema.nodes.text);if(!n)return!1;let s=k.empty;for(let o=n.length-1;o>=0;o--)s=k.from(n[o].createAndFill(null,s));let i=r.state.tr.replace(t.pos,t.pos,new C(s,0,0));return i.setSelection(D.near(i.doc.resolve(t.pos+1))),r.dispatch(i),!1}function uS(r){if(!(r.selection instanceof ee))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",J.create(r.doc,[ve.widget(r.selection.head,e,{key:"gapcursor"})])}var fi=200,he=function(){};he.prototype.append=function(e){return e.length?(e=he.from(e),!this.length&&e||e.length<fi&&this.leafAppend(e)||this.length<fi&&e.leafPrepend(this)||this.appendInner(e)):this};he.prototype.prepend=function(e){return e.length?he.from(e).append(this):this};he.prototype.appendInner=function(e){return new dS(this,e)};he.prototype.slice=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=this.length),e>=t?he.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,t))};he.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)};he.prototype.forEach=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length),t<=n?this.forEachInner(e,t,n,0):this.forEachInvertedInner(e,t,n,0)};he.prototype.map=function(e,t,n){t===void 0&&(t=0),n===void 0&&(n=this.length);var s=[];return this.forEach(function(i,o){return s.push(e(i,o))},t,n),s};he.from=function(e){return e instanceof he?e:e&&e.length?new cf(e):he.empty};var cf=(function(r){function e(n){r.call(this),this.values=n}r&&(e.__proto__=r),e.prototype=Object.create(r&&r.prototype),e.prototype.constructor=e;var t={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(s,i){return s==0&&i==this.length?this:new e(this.values.slice(s,i))},e.prototype.getInner=function(s){return this.values[s]},e.prototype.forEachInner=function(s,i,o,a){for(var l=i;l<o;l++)if(s(this.values[l],a+l)===!1)return!1},e.prototype.forEachInvertedInner=function(s,i,o,a){for(var l=i-1;l>=o;l--)if(s(this.values[l],a+l)===!1)return!1},e.prototype.leafAppend=function(s){if(this.length+s.length<=fi)return new e(this.values.concat(s.flatten()))},e.prototype.leafPrepend=function(s){if(this.length+s.length<=fi)return new e(s.flatten().concat(this.values))},t.length.get=function(){return this.values.length},t.depth.get=function(){return 0},Object.defineProperties(e.prototype,t),e})(he);he.empty=new cf([]);var dS=(function(r){function e(t,n){r.call(this),this.left=t,this.right=n,this.length=t.length+n.length,this.depth=Math.max(t.depth,n.depth)+1}return r&&(e.__proto__=r),e.prototype=Object.create(r&&r.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(n){return n<this.left.length?this.left.get(n):this.right.get(n-this.left.length)},e.prototype.forEachInner=function(n,s,i,o){var a=this.left.length;if(s<a&&this.left.forEachInner(n,s,Math.min(i,a),o)===!1||i>a&&this.right.forEachInner(n,Math.max(s-a,0),Math.min(this.length,i)-a,o+a)===!1)return!1},e.prototype.forEachInvertedInner=function(n,s,i,o){var a=this.left.length;if(s>a&&this.right.forEachInvertedInner(n,s-a,Math.max(i,a)-a,o+a)===!1||i<a&&this.left.forEachInvertedInner(n,Math.min(s,a),i,o)===!1)return!1},e.prototype.sliceInner=function(n,s){if(n==0&&s==this.length)return this;var i=this.left.length;return s<=i?this.left.slice(n,s):n>=i?this.right.slice(n-i,s-i):this.left.slice(n,i).append(this.right.slice(0,s-i))},e.prototype.leafAppend=function(n){var s=this.right.leafAppend(n);if(s)return new e(this.left,s)},e.prototype.leafPrepend=function(n){var s=this.left.leafPrepend(n);if(s)return new e(s,this.right)},e.prototype.appendInner=function(n){return this.left.depth>=Math.max(this.right.depth,n.depth)+1?new e(this.left,new e(this.right,n)):new e(this,n)},e})(he);const hS=500;class Qe{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let n=this.items.length;for(;;n--)if(this.items.get(n-1).selection){--n;break}let s,i;t&&(s=this.remapping(n,this.items.length),i=s.maps.length);let o=e.tr,a,l,c=[],u=[];return this.items.forEach((d,h)=>{if(!d.step){s||(s=this.remapping(n,h+1),i=s.maps.length),i--,u.push(d);return}if(s){u.push(new st(d.map));let f=d.step.map(s.slice(i)),p;f&&o.maybeStep(f).doc&&(p=o.mapping.maps[o.mapping.maps.length-1],c.push(new st(p,void 0,void 0,c.length+u.length))),i--,p&&s.appendMap(p,i)}else o.maybeStep(d.step);if(d.selection)return a=s?d.selection.map(s.slice(i)):d.selection,l=new Qe(this.items.slice(0,n).append(u.reverse().concat(c)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,n,s){let i=[],o=this.eventCount,a=this.items,l=!s&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let d=e.steps[u].invert(e.docs[u]),h=new st(e.mapping.maps[u],d,t),f;(f=l&&l.merge(h))&&(h=f,u?i.pop():a=a.slice(0,a.length-1)),i.push(h),t&&(o++,t=void 0),s||(l=h)}let c=o-n.depth;return c>pS&&(a=fS(a,c),o-=c),new Qe(a.append(i),o)}remapping(e,t){let n=new Rn;return this.items.forEach((s,i)=>{let o=s.mirrorOffset!=null&&i-s.mirrorOffset>=e?n.maps.length-s.mirrorOffset:void 0;n.appendMap(s.map,o)},e,t),n}addMaps(e){return this.eventCount==0?this:new Qe(this.items.append(e.map(t=>new st(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let n=[],s=Math.max(0,this.items.length-t),i=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(h=>{h.selection&&a--},s);let l=t;this.items.forEach(h=>{let f=i.getMirror(--l);if(f==null)return;o=Math.min(o,f);let p=i.maps[f];if(h.step){let m=e.steps[f].invert(e.docs[f]),g=h.selection&&h.selection.map(i.slice(l+1,f));g&&a++,n.push(new st(p,m,g))}else n.push(new st(p))},s);let c=[];for(let h=t;h<o;h++)c.push(new st(i.maps[h]));let u=this.items.slice(0,s).append(c).append(n),d=new Qe(u,a);return d.emptyItemCount()>hS&&(d=d.compress(this.items.length-n.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),n=t.maps.length,s=[],i=0;return this.items.forEach((o,a)=>{if(a>=e)s.push(o),o.selection&&i++;else if(o.step){let l=o.step.map(t.slice(n)),c=l&&l.getMap();if(n--,c&&t.appendMap(c,n),l){let u=o.selection&&o.selection.map(t.slice(n));u&&i++;let d=new st(c.invert(),l,u),h,f=s.length-1;(h=s.length&&s[f].merge(d))?s[f]=h:s.push(d)}}else o.map&&n--},this.items.length,0),new Qe(he.from(s.reverse()),i)}}Qe.empty=new Qe(he.empty,0);function fS(r,e){let t;return r.forEach((n,s)=>{if(n.selection&&e--==0)return t=s,!1}),r.slice(t)}class st{constructor(e,t,n,s){this.map=e,this.step=t,this.selection=n,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new st(t.getMap().invert(),t,this.selection)}}}class At{constructor(e,t,n,s,i){this.done=e,this.undone=t,this.prevRanges=n,this.prevTime=s,this.prevComposition=i}}const pS=20;function mS(r,e,t,n){let s=t.getMeta(hr),i;if(s)return s.historyState;t.getMeta(bS)&&(r=new At(r.done,r.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return r;if(o&&o.getMeta(hr))return o.getMeta(hr).redo?new At(r.done.addTransform(t,void 0,n,ws(e)),r.undone,su(t.mapping.maps),r.prevTime,r.prevComposition):new At(r.done,r.undone.addTransform(t,void 0,n,ws(e)),null,r.prevTime,r.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=r.prevTime==0||!o&&r.prevComposition!=a&&(r.prevTime<(t.time||0)-n.newGroupDelay||!gS(t,r.prevRanges)),c=o?wo(r.prevRanges,t.mapping):su(t.mapping.maps);return new At(r.done.addTransform(t,l?e.selection.getBookmark():void 0,n,ws(e)),Qe.empty,c,t.time,a??r.prevComposition)}else return(i=t.getMeta("rebased"))?new At(r.done.rebased(t,i),r.undone.rebased(t,i),wo(r.prevRanges,t.mapping),r.prevTime,r.prevComposition):new At(r.done.addMaps(t.mapping.maps),r.undone.addMaps(t.mapping.maps),wo(r.prevRanges,t.mapping),r.prevTime,r.prevComposition)}function gS(r,e){if(!e)return!1;if(!r.docChanged)return!0;let t=!1;return r.mapping.maps[0].forEach((n,s)=>{for(let i=0;i<e.length;i+=2)n<=e[i+1]&&s>=e[i]&&(t=!0)}),t}function su(r){let e=[];for(let t=r.length-1;t>=0&&e.length==0;t--)r[t].forEach((n,s,i,o)=>e.push(i,o));return e}function wo(r,e){if(!r)return null;let t=[];for(let n=0;n<r.length;n+=2){let s=e.map(r[n],1),i=e.map(r[n+1],-1);s<=i&&t.push(s,i)}return t}function yS(r,e,t){let n=ws(e),s=hr.get(e).spec.config,i=(t?r.undone:r.done).popEvent(e,n);if(!i)return null;let o=i.selection.resolve(i.transform.doc),a=(t?r.done:r.undone).addTransform(i.transform,e.selection.getBookmark(),s,n),l=new At(t?a:i.remaining,t?i.remaining:a,null,0,-1);return i.transform.setSelection(o).setMeta(hr,{redo:t,historyState:l})}let vo=!1,iu=null;function ws(r){let e=r.plugins;if(iu!=e){vo=!1,iu=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){vo=!0;break}}return vo}const hr=new ne("history"),bS=new ne("closeHistory");function wS(r={}){return r={depth:r.depth||100,newGroupDelay:r.newGroupDelay||500},new K({key:hr,state:{init(){return new At(Qe.empty,Qe.empty,null,0,-1)},apply(e,t,n){return mS(t,n,e,r)}},config:r,props:{handleDOMEvents:{beforeinput(e,t){let n=t.inputType,s=n=="historyUndo"?df:n=="historyRedo"?hf:null;return!s||!e.editable?!1:(t.preventDefault(),s(e.state,e.dispatch))}}}})}function uf(r,e){return(t,n)=>{let s=hr.getState(t);if(!s||(r?s.undone:s.done).eventCount==0)return!1;if(n){let i=yS(s,t,r);i&&n(e?i.scrollIntoView():i)}return!0}}const df=uf(!1,!0),hf=uf(!0,!0);F.create({name:"characterCount",addOptions(){return{limit:null,mode:"textSize",textCounter:r=>r.length,wordCounter:r=>r.split(" ").filter(e=>e!=="").length}},addStorage(){return{characters:()=>0,words:()=>0}},onBeforeCreate(){this.storage.characters=r=>{const e=r?.node||this.editor.state.doc;if((r?.mode||this.options.mode)==="textSize"){const n=e.textBetween(0,e.content.size,void 0," ");return this.options.textCounter(n)}return e.nodeSize},this.storage.words=r=>{const e=r?.node||this.editor.state.doc,t=e.textBetween(0,e.content.size," "," ");return this.options.wordCounter(t)}},addProseMirrorPlugins(){let r=!1;return[new K({key:new ne("characterCount"),appendTransaction:(e,t,n)=>{if(r)return;const s=this.options.limit;if(s==null||s===0){r=!0;return}const i=this.storage.characters({node:n.doc});if(i>s){const o=i-s,a=0,l=o;console.warn(`[CharacterCount] Initial content exceeded limit of ${s} characters. Content was automatically trimmed.`);const c=n.tr.deleteRange(a,l);return r=!0,c}r=!0},filterTransaction:(e,t)=>{const n=this.options.limit;if(!e.docChanged||n===0||n===null||n===void 0)return!0;const s=this.storage.characters({node:t.doc}),i=this.storage.characters({node:e.doc});if(i<=n||s>n&&i>n&&i<=s)return!0;if(s>n&&i>n&&i>s||!e.getMeta("paste"))return!1;const a=e.selection.$head.pos,l=i-n,c=a-l,u=a;return e.deleteRange(c,u),!(this.storage.characters({node:e.doc})>n)}})]}});var vS=F.create({name:"dropCursor",addOptions(){return{color:"currentColor",width:1,class:void 0}},addProseMirrorPlugins(){return[rS(this.options)]}});F.create({name:"focus",addOptions(){return{className:"has-focus",mode:"all"}},addProseMirrorPlugins(){return[new K({key:new ne("focus"),props:{decorations:({doc:r,selection:e})=>{const{isEditable:t,isFocused:n}=this.editor,{anchor:s}=e,i=[];if(!t||!n)return J.create(r,[]);let o=0;this.options.mode==="deepest"&&r.descendants((l,c)=>{if(l.isText)return;if(!(s>=c&&s<=c+l.nodeSize-1))return!1;o+=1});let a=0;return r.descendants((l,c)=>{if(l.isText||!(s>=c&&s<=c+l.nodeSize-1))return!1;if(a+=1,this.options.mode==="deepest"&&o-a>0||this.options.mode==="shallowest"&&a>1)return this.options.mode==="deepest";i.push(ve.node(c,c+l.nodeSize,{class:this.options.className}))}),J.create(r,i)}}})]}});var kS=F.create({name:"gapCursor",addProseMirrorPlugins(){return[oS()]},extendNodeSchema(r){var e;const t={name:r.name,options:r.options,storage:r.storage};return{allowGapCursor:(e=H(O(r,"allowGapCursor",t)))!=null?e:null}}});F.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something ",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new K({key:new ne("placeholder"),props:{decorations:({doc:r,selection:e})=>{const t=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:n}=e,s=[];if(!t)return null;const i=this.editor.isEmpty;return r.descendants((o,a)=>{const l=n>=a&&n<=a+o.nodeSize,c=!o.isLeaf&&Ni(o);if((l||!this.options.showOnlyCurrent)&&c){const u=[this.options.emptyNodeClass];i&&u.push(this.options.emptyEditorClass);const d=ve.node(a,a+o.nodeSize,{class:u.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:o,pos:a,hasAnchor:l}):this.options.placeholder});s.push(d)}return this.options.includeChildren}),J.create(r,s)}}})]}});F.create({name:"selection",addOptions(){return{className:"selection"}},addProseMirrorPlugins(){const{editor:r,options:e}=this;return[new K({key:new ne("selection"),props:{decorations(t){return t.selection.empty||r.isFocused||!r.isEditable||Th(t.selection)||r.view.dragging?null:J.create(t.doc,[ve.inline(t.selection.from,t.selection.to,{class:e.className})])}}})]}});function ou({types:r,node:e}){return e&&Array.isArray(r)&&r.includes(e.type)||e?.type===r}var SS=F.create({name:"trailingNode",addOptions(){return{node:void 0,notAfter:[]}},addProseMirrorPlugins(){var r;const e=new ne(this.name),t=this.options.node||((r=this.editor.schema.topNodeType.contentMatch.defaultType)==null?void 0:r.name)||"paragraph",n=Object.entries(this.editor.schema.nodes).map(([,s])=>s).filter(s=>(this.options.notAfter||[]).concat(t).includes(s.name));return[new K({key:e,appendTransaction:(s,i,o)=>{const{doc:a,tr:l,schema:c}=o,u=e.getState(o),d=a.content.size,h=c.nodes[t];if(u)return l.insert(d,h.create())},state:{init:(s,i)=>{const o=i.tr.doc.lastChild;return!ou({node:o,types:n})},apply:(s,i)=>{if(!s.docChanged||s.getMeta("__uniqueIDTransaction"))return i;const o=s.doc.lastChild;return!ou({node:o,types:n})}}})]}}),xS=F.create({name:"undoRedo",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:r,dispatch:e})=>df(r,e),redo:()=>({state:r,dispatch:e})=>hf(r,e)}},addProseMirrorPlugins(){return[wS(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-":()=>this.editor.commands.undo(),"Shift-Mod-":()=>this.editor.commands.redo()}}}),TS=F.create({name:"starterKit",addExtensions(){var r,e,t,n;const s=[];return this.options.bold!==!1&&s.push(Q0.configure(this.options.bold)),this.options.blockquote!==!1&&s.push(W0.configure(this.options.blockquote)),this.options.bulletList!==!1&&s.push(Qh.configure(this.options.bulletList)),this.options.code!==!1&&s.push(ek.configure(this.options.code)),this.options.codeBlock!==!1&&s.push(nk.configure(this.options.codeBlock)),this.options.document!==!1&&s.push(sk.configure(this.options.document)),this.options.dropcursor!==!1&&s.push(vS.configure(this.options.dropcursor)),this.options.gapcursor!==!1&&s.push(kS.configure(this.options.gapcursor)),this.options.hardBreak!==!1&&s.push(ik.configure(this.options.hardBreak)),this.options.heading!==!1&&s.push(ok.configure(this.options.heading)),this.options.undoRedo!==!1&&s.push(xS.configure(this.options.undoRedo)),this.options.horizontalRule!==!1&&s.push(ak.configure(this.options.horizontalRule)),this.options.italic!==!1&&s.push(hk.configure(this.options.italic)),this.options.listItem!==!1&&s.push(Xh.configure(this.options.listItem)),this.options.listKeymap!==!1&&s.push(sf.configure((r=this.options)==null?void 0:r.listKeymap)),this.options.link!==!1&&s.push(Lk.configure((e=this.options)==null?void 0:e.link)),this.options.orderedList!==!1&&s.push(af.configure(this.options.orderedList)),this.options.paragraph!==!1&&s.push(Yk.configure(this.options.paragraph)),this.options.strike!==!1&&s.push(Zk.configure(this.options.strike)),this.options.text!==!1&&s.push(eS.configure(this.options.text)),this.options.underline!==!1&&s.push(tS.configure((t=this.options)==null?void 0:t.underline)),this.options.trailingNode!==!1&&s.push(SS.configure((n=this.options)==null?void 0:n.trailingNode)),s}}),_S=TS,ES=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,CS=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,AS=kt.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:r=>r.getAttribute("data-color")||r.style.backgroundColor,renderHTML:r=>r.color?{"data-color":r.color,style:`background-color: ${r.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:r}){return["mark",te(this.options.HTMLAttributes,r),0]},renderMarkdown:(r,e)=>`==${e.renderChildren(r)}==`,parseMarkdown:(r,e)=>e.applyMark("highlight",e.parseInline(r.tokens||[])),markdownTokenizer:{name:"highlight",level:"inline",start:r=>r.indexOf("=="),tokenize(r,e,t){const s=/^(==)([^=]+)(==)/.exec(r);if(s){const i=s[2].trim(),o=t.inlineTokens(i);return{type:"highlight",raw:s[0],text:i,tokens:o}}}},addCommands(){return{setHighlight:r=>({commands:e})=>e.setMark(this.name,r),toggleHighlight:r=>({commands:e})=>e.toggleMark(this.name,r),unsetHighlight:()=>({commands:r})=>r.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[yr({find:ES,type:this.type})]},addPasteRules(){return[Ht({find:CS,type:this.type})]}}),OS=F.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:r=>{const e=r.style.textAlign;return this.options.alignments.includes(e)?e:this.options.defaultAlignment},renderHTML:r=>r.textAlign?{style:`text-align: ${r.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:r=>({commands:e})=>this.options.alignments.includes(r)?this.options.types.map(t=>e.updateAttributes(t,{textAlign:r})).some(t=>t):!1,unsetTextAlign:()=>({commands:r})=>this.options.types.map(e=>r.resetAttributes(e,"textAlign")).some(e=>e),toggleTextAlign:r=>({editor:e,commands:t})=>this.options.alignments.includes(r)?e.isActive({textAlign:r})?t.unsetTextAlign():t.setTextAlign(r):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),MS=20,ff=(r,e=0)=>{const t=[];return!r.children.length||e>MS||Array.from(r.children).forEach(n=>{n.tagName==="SPAN"?t.push(n):n.children.length&&t.push(...ff(n,e+1))}),t},IS=r=>{if(!r.children.length)return;const e=ff(r);e&&e.forEach(t=>{var n,s;const i=t.getAttribute("style"),o=(s=(n=t.parentElement)==null?void 0:n.closest("span"))==null?void 0:s.getAttribute("style");t.setAttribute("style",`${o};${i}`)})},pf=kt.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:r=>r.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&IS(r),{}):!1}]},renderHTML({HTMLAttributes:r}){return["span",te(this.options.HTMLAttributes,r),0]},addCommands(){return{toggleTextStyle:r=>({commands:e})=>e.toggleMark(this.name,r),removeEmptyTextStyle:()=>({tr:r})=>{const{selection:e}=r;return r.doc.nodesBetween(e.from,e.to,(t,n)=>{if(t.isTextblock)return!0;t.marks.filter(s=>s.type===this.type).some(s=>Object.values(s.attrs).some(i=>!!i))||r.removeMark(n,n+t.nodeSize,this.type)}),!0}}}}),RS=F.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:r=>{var e;const t=r.getAttribute("style");if(t){const n=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s=n.length-1;s>=0;s-=1){const i=n[s].split(":");if(i.length>=2){const o=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(o==="background-color")return a.replace(/['"]+/g,"")}}}return(e=r.style.backgroundColor)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:r=>r.backgroundColor?{style:`background-color: ${r.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:r=>({chain:e})=>e().setMark("textStyle",{backgroundColor:r}).run(),unsetBackgroundColor:()=>({chain:r})=>r().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),NS=F.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:r=>{var e;const t=r.getAttribute("style");if(t){const n=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s=n.length-1;s>=0;s-=1){const i=n[s].split(":");if(i.length>=2){const o=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(o==="color")return a.replace(/['"]+/g,"")}}}return(e=r.style.color)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:r=>r.color?{style:`color: ${r.color}`}:{}}}}]},addCommands(){return{setColor:r=>({chain:e})=>e().setMark("textStyle",{color:r}).run(),unsetColor:()=>({chain:r})=>r().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),PS=F.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:r=>r.style.fontFamily,renderHTML:r=>r.fontFamily?{style:`font-family: ${r.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:r=>({chain:e})=>e().setMark("textStyle",{fontFamily:r}).run(),unsetFontFamily:()=>({chain:r})=>r().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),DS=F.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:r=>r.style.fontSize,renderHTML:r=>r.fontSize?{style:`font-size: ${r.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:r=>({chain:e})=>e().setMark("textStyle",{fontSize:r}).run(),unsetFontSize:()=>({chain:r})=>r().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),$S=F.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:r=>r.style.lineHeight,renderHTML:r=>r.lineHeight?{style:`line-height: ${r.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:r=>({chain:e})=>e().setMark("textStyle",{lineHeight:r}).run(),unsetLineHeight:()=>({chain:r})=>r().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});F.create({name:"textStyleKit",addExtensions(){const r=[];return this.options.backgroundColor!==!1&&r.push(RS.configure(this.options.backgroundColor)),this.options.color!==!1&&r.push(NS.configure(this.options.color)),this.options.fontFamily!==!1&&r.push(PS.configure(this.options.fontFamily)),this.options.fontSize!==!1&&r.push(DS.configure(this.options.fontSize)),this.options.lineHeight!==!1&&r.push($S.configure(this.options.lineHeight)),this.options.textStyle!==!1&&r.push(pf.configure(this.options.textStyle)),r}});let U=null,it=null,Sn=null,Ye=null,xn=null,Ur=null;const ma=new ne("pagination"),LS=new ne("wordCount"),jS=Oe.create({name:"doc",topNode:!0,content:"page+"}),BS=Oe.create({name:"page",group:"block",content:"block+",defining:!0,isolating:!0,parseHTML(){return[{tag:'div[data-type="page"]'}]},renderHTML({HTMLAttributes:r}){return["div",{...r,"data-type":"page",class:"page-node"},0]}}),zS=F.create({name:"fontSize",addGlobalAttributes(){return[{types:["textStyle"],attributes:{fontSize:{default:null,parseHTML:r=>r.style.fontSize||null,renderHTML:r=>r.fontSize?{style:`font-size: ${r.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:r=>({chain:e})=>e().setMark("textStyle",{fontSize:r}).run(),unsetFontSize:()=>({chain:r})=>r().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}});function US(r){const e=r.trim();if(!e)return 0;const t=e.match(/\S+/g);return t?t.length:0}const FS=F.create({name:"wordCount",addProseMirrorPlugins(){return[new K({key:LS,props:{decorations(r){const e=r.selection?.from??0,t=r.schema.nodes.page;if(!t)return null;let n=null;if(r.doc.descendants((c,u)=>{if(c.type===t){const d=u,h=u+c.nodeSize;if(e>=d&&e<h)return n={node:c,pos:u},!1}return!0}),!n)return null;const s=US(n.node.textContent),i=`${s} mot${s===1?"":"s"}`,o=document.createElement("div");o.className="page-word-count",o.textContent=i;const a=n.pos+n.node.nodeSize-1,l=ve.widget(a,o,{key:"page-word-count",side:1});return J.create(r.doc,[l])}}})]}});function HS(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function VS(r){return r?r.split(`
`).map(e=>`<p>${HS(e)}</p>`).join(""):"<p></p>"}function qS(r){return/<\/?[a-z][\s\S]*>/i.test(r)}function WS(r){if(!r)return"<p></p>";const e=qS(r)?r:VS(r);return e.includes('data-type="page"')?e:`<div data-type="page">${e}</div>`}function or(){if(!U||!it)return;const r=it.querySelectorAll("[data-command]"),e=it.querySelector('[data-command="font-size"]');for(const t of r){const n=t.dataset.command;let s=!1;if(n==="bold")s=U.isActive("bold");else if(n==="italic")s=U.isActive("italic");else if(n==="heading-1")s=U.isActive("heading",{level:1});else if(n==="heading-2")s=U.isActive("heading",{level:2});else if(n==="align-left")s=U.isActive({textAlign:"left"});else if(n==="align-center")s=U.isActive({textAlign:"center"});else if(n==="align-right")s=U.isActive({textAlign:"right"});else if(n==="align-justify")s=U.isActive({textAlign:"justify"});else if(n==="bullet-list")s=U.isActive("bulletList");else if(n==="ordered-list")s=U.isActive("orderedList");else if(n==="highlight")s=U.isActive("highlight");else if(n&&n.startsWith("font-")){const i=`${n.replace("font-","")}px`;s=U.isActive("textStyle",{fontSize:i})}if(n==="align-left"&&!s){const i=U.getAttributes("paragraph").textAlign,o=U.getAttributes("heading").textAlign;!i&&!o&&(s=!0)}t.classList.toggle("is-active",s),n==="undo"&&(t.disabled=!U.can().undo()),n==="redo"&&(t.disabled=!U.can().redo())}if(e){if(document.activeElement===e)return;const t=U.getAttributes("textStyle").fontSize||"";e.value=t?t.replace("px",""):"16"}}function KS(r){if(r.target instanceof HTMLSelectElement||r.target instanceof HTMLOptionElement)return;const e=r.target.closest("[data-command]");if(!e||!U||e instanceof HTMLSelectElement)return;const t=e.dataset.command,n=U.chain().focus();if(t==="bold")n.toggleBold().run();else if(t==="italic")n.toggleItalic().run();else if(t==="heading-1")n.toggleHeading({level:1}).run();else if(t==="heading-2")n.toggleHeading({level:2}).run();else if(t==="align-left")n.setTextAlign("left").run();else if(t==="align-center")n.setTextAlign("center").run();else if(t==="align-right")n.setTextAlign("right").run();else if(t==="align-justify")n.setTextAlign("justify").run();else if(t==="bullet-list")n.toggleBulletList().run();else if(t==="ordered-list")n.toggleOrderedList().run();else if(t==="highlight")U.isActive("highlight")?n.unsetHighlight().run():n.toggleHighlight({color:"#fde68a"}).run();else if(t&&t.startsWith("font-")){const s=`${t.replace("font-","")}px`;n.setFontSize(s).run()}else t==="undo"?n.undo().run():t==="redo"&&n.redo().run();or()}function mf(r){const e=r.target;if(!U||!(e instanceof HTMLSelectElement)||e.dataset.command!=="font-size")return;const t=e.value,n=U.chain().focus();if(!t){n.unsetFontSize().run(),or();return}const s=`${t}px`;n.setFontSize(s).run(),or()}function ko(r){const e=Number.parseFloat(r);return Number.isNaN(e)?0:e}const JS=F.create({name:"pagination",addProseMirrorPlugins(){return[new K({key:ma,view(r){let e=null,t=r.dom.clientWidth,n=!1;const s=()=>{const c=Ye?window.getComputedStyle(Ye):null,u=ko(c?.getPropertyValue("--page-height"))||1160,d=ko(c?.getPropertyValue("--page-padding"))||48,h=ko(c?.getPropertyValue("--page-footer-space"))||0;return{pageHeight:u,padding:d,footerSpace:h}},i=(c,u)=>{const d=c.doc.resolve(u);let h=null;for(let p=d.depth;p>0;p-=1)if(d.node(p).type===c.schema.nodes.page){h=p;break}if(!h)return null;const f=d.depth-h+1;return c.tr.split(u,f)},o=c=>!c||c.type.name!=="page"?!1:c.textContent.trim()===""&&c.childCount<=1,a=()=>{if(n)return;n=!0;const{state:c}=r,u=c.schema.nodes.page;if(!u||!Ye){n=!1;return}const d=Array.from(r.dom.querySelectorAll(".page-node")),h=[];if(c.doc.descendants((S,x)=>{S.type===u&&h.push({node:S,pos:x})}),h.length===0||d.length===0){n=!1;return}const f=c.selection?.from??0;let p=h.length-1;for(let S=0;S<h.length;S+=1){const x=h[S].pos,I=x+h[S].node.nodeSize;if(f>=x&&f<I){p=S;break}}const m=d[p],g=h[p];if(!m||!g){n=!1;return}const{pageHeight:y,padding:w,footerSpace:v}=s(),_=y-w-v;if(m.scrollHeight>y+1){const S=m.getBoundingClientRect(),x=g.pos+1,I=g.pos+g.node.content.size,G=r.posAtCoords({left:S.left+w+8,top:S.top+_-4})?.pos??null;if(G&&G>x+1&&G<I-1){const Re=i(c,G);if(Re)return r.dispatch(Re),n=!1,a()}}const E=h[h.length-1]?.node;if(h.length>1&&o(E)){const S=h[h.length-1].pos,x=c.tr.delete(S,S+E.nodeSize);r.dispatch(x)}n=!1},l=(c=!1)=>{if(e)return;const u=c?0:200;e=window.setTimeout(()=>{e=null,a()},u)};return a(),{update(c,u){const d=c.dom.clientWidth,h=!c.state.doc.eq(u.doc),f=d!==t,p=c.state.tr.getMeta(ma);(h||f||p)&&(t=d,l(f||p))},destroy(){e&&(clearTimeout(e),e=null)}}}})]}});function GS(){if(!Ye)return;const r=Ye.clientWidth;if(!r)return;const e=Math.min(980,Math.max(640,r)),t=Math.round(e*1.414),n=Math.round(Math.min(56,Math.max(32,e*.06))),s=Math.round(Math.max(20,n*.6));Ye.style.setProperty("--page-width",`${e}px`),Ye.style.setProperty("--page-height",`${t}px`),Ye.style.setProperty("--page-padding",`${n}px`),Ye.style.setProperty("--page-footer-space",`${s}px`)}function au(){Ur||(Ur=window.requestAnimationFrame(()=>{Ur=null,GS(),U&&U.view.dispatch(U.view.state.tr.setMeta(ma,!0))}))}function YS({content:r="",onUpdate:e}={}){const t=document.querySelector("#chapter-editor"),n=document.querySelector("#editor-toolbar"),s=document.querySelector(".paper-shell");if(!t||!n||!s){ul();return}U&&(U.destroy(),U=null),it=n,Sn=KS,it.addEventListener("click",Sn),it.addEventListener("change",mf),Ye=s,xn=au,window.addEventListener("resize",xn),au(),U=new D0({element:t,extensions:[jS,BS,JS,FS,_S.configure({document:!1,gapcursor:!1}),OS.configure({types:["paragraph","heading"]}),AS,pf,zS],content:WS(r),onUpdate({editor:i}){e&&e(i.getHTML()),or()},onSelectionUpdate:or,onTransaction:or}),or()}function ul(){it&&Sn&&(it.removeEventListener("click",Sn),it.removeEventListener("change",mf)),it=null,Sn=null,Ye=null,xn&&(window.removeEventListener("resize",xn),xn=null),Ur&&(window.cancelAnimationFrame(Ur),Ur=null),U&&(U.destroy(),U=null)}const gf="Bucketplumeo",QS="latest.json";function yf(r){return`${r}/${QS}`}async function bf(){const r=await Vt();if(!r.ok)return r;try{const e=await be("projects"),t=await be("chapters"),n={schema:1,saved_at:new Date().toISOString(),projects:e,chapters:t},s=new Blob([JSON.stringify(n)],{type:"application/json"}),i=yf(r.userId),{error:o}=await le.storage.from(gf).upload(i,s,{upsert:!0,contentType:"application/json"});return o?{ok:!1,errorMessage:o.message}:{ok:!0}}catch(e){return{ok:!1,errorMessage:e.message}}}async function XS(){const r=await Vt();if(!r.ok)return r;try{const e=yf(r.userId),{data:t,error:n}=await le.storage.from(gf).download(e);if(n)return{ok:!1,errorMessage:n.message};const s=await t.text(),i=JSON.parse(s),o=Array.isArray(i?.projects)?i.projects:[],a=Array.isArray(i?.chapters)?i.chapters:[];return await Yr(o),await Qr(a),{ok:!0}}catch(e){return{ok:!1,errorMessage:e.message}}}const et=document.querySelector("#app"),b={projects:[],selectedProjectId:null,chapters:[],selectedChapterId:null,chapterDetail:null,versions:[],statusText:"",homeMessage:"",editingProjectId:null,lastChapterTitle:null,lastCloudSaveAt:null,cloudStatus:"",cloudBusy:!1,backupStatus:"",homeStats:null,inboxItems:[],inboxFilter:"to_sort",editorTab:"session",writingNav:"chapter",characters:[],selectedCharacterId:null,characterFilter:"",characterSections:{civil:!0,physique:!1,caractere:!1,profil:!1,evolution:!1,inventaire:!1,possession:!1,autres:!1}},ZS=300*1e3,ex=300*1e3;let vs=null,ps=null,lu=!1,Dt="",ot=null,ar=null;const So=new Map;function dl(){vs&&(clearTimeout(vs),vs=null)}function xo(r){ps&&(clearInterval(ps),ps=null),r&&(ps=window.setInterval(async()=>{if(b.cloudBusy||!Dt)return;const e=await bf();if(e.ok){const t=Date.now();Pu(t),b.lastCloudSaveAt=t}else console.error("cloud autosave error",e.errorMessage)},ex))}function To(r){const e=document.querySelector("#message");e&&(e.textContent=r)}function xe(r){b.statusText=r;const e=document.querySelector("#status-text");e&&(e.textContent=r)}function Jr(r){b.homeMessage=r;const e=document.querySelector("#home-message");e&&(e.textContent=r)}function re(){ul(),et.innerHTML=mg({userEmail:Dt,projects:b.projects,selectedProjectId:b.selectedProjectId,editingProjectId:b.editingProjectId,chapters:b.chapters,selectedChapterId:b.selectedChapterId,chapterDetail:b.chapterDetail,versions:b.versions,statusText:b.statusText,editorTab:b.editorTab,writingNav:b.writingNav,characters:b.characters,selectedCharacterId:b.selectedCharacterId,characterFilter:b.characterFilter,characterSections:b.characterSections}),tx(),b.chapterDetail&&YS({content:b.chapterDetail.content_md??"",onUpdate:xf})}function Ee(){et.innerHTML=pg({userEmail:Dt,projects:b.projects,lastProjectId:Hn(),lastChapterTitle:b.lastChapterTitle,lastCloudSaveAt:b.lastCloudSaveAt,cloudStatus:b.cloudStatus,cloudBusy:b.cloudBusy,backupStatus:b.backupStatus,homeStats:b.homeStats,homeMessage:b.homeMessage,inboxItems:b.inboxItems,inboxFilter:b.inboxFilter})}function tx(){const r=document.querySelector("#project-export");if(!r)return;const t=!!b.projects.find(n=>n.id===b.selectedProjectId);r.disabled=!t,r.setAttribute("aria-disabled",t?"false":"true")}function cu(){const r=document.querySelector("#email"),e=document.querySelector("#password");return{email:r?r.value.trim():"",password:e?e.value:""}}async function bt({allowFallback:r=!0}={}){const e=await Cg();if(b.projects=e,b.projects.length===0){b.selectedProjectId=null;return}!b.projects.some(n=>n.id===b.selectedProjectId)&&r&&(b.selectedProjectId=b.projects[0].id)}async function Li(){if(!b.selectedProjectId){b.chapters=[],b.selectedChapterId=null,b.chapterDetail=null,b.versions=[];return}const r=await Ru(b.selectedProjectId);if(b.chapters=r,b.chapters.length===0){b.selectedChapterId=null,b.chapterDetail=null,b.versions=[];return}b.chapters.some(t=>t.id===b.selectedChapterId)||(b.selectedChapterId=b.chapters[0].id)}async function Gr(){if(!b.selectedProjectId){b.characters=[],b.selectedCharacterId=null;return}b.characters=await Pg(b.selectedProjectId),b.characters.some(e=>e.id===b.selectedCharacterId)||(b.selectedCharacterId=b.characters[0]?.id??null)}async function br(){if(!b.selectedChapterId){b.chapterDetail=null;return}b.chapterDetail=await vi(b.selectedChapterId)}async function wr(r){if(!r){b.versions=[];return}const e=await xg(r);if(!e.ok){b.versions=[];return}b.versions=e.data}async function wf(){const r=await gg();if(!r.ok){xe(`Erreur: ${r.errorMessage}`);return}await Yr(r.data),await bt()}async function rx(r){const e=await wg(r);if(!e.ok){xe(`Erreur: ${e.errorMessage}`);return}await Qr(e.data),await Li()}async function ga(){b.inboxItems=await Mg()}async function nx(){b.editingProjectId=null,b.lastCloudSaveAt=jg(),await bt(),await ga(),await pi(),await mi(),Ee(),await wf(),await bt(),await ga(),await pi(),await mi(),Ee()}function sx(r){const e=r.trim();if(!e)return 0;const t=e.match(/\S+/g);return t?t.length:0}function ix(r){if(!r)return"";if(!/<[a-z][\s\S]*>/i.test(r))return r;const e=document.createElement("div");return e.innerHTML=r,e.textContent??""}async function pi(){const r=await be("chapters"),e=Date.now();let t=0,n=null;for(const l of r){const c=ix(l.content_md??"");t+=sx(c);const u=l.updated_local_at??null;u&&(n=n===null?u:Math.min(n,u))}const s=n===null?1:Math.max(1,Math.ceil((e-n)/864e5)),i=t?Math.round(t/s):0,o=t?Math.ceil(t/250):0,a=o?o/s:0;b.homeStats={totalWords:t,wordsPerDay:i,pagesTotal:o,pagesPerDay:a,timeSpent:null,timePerDay:null}}function ox(){return b.chapters.map((e,t)=>({chapter:e,index:t})).sort((e,t)=>{const n=(e.chapter.order_index??0)-(t.chapter.order_index??0);return n!==0?n:e.index-t.index}).map(e=>e.chapter)}async function ax(r){const e=[];if(r.forEach((t,n)=>{const s=(n+1)*10;(t.order_index??0)!==s&&e.push({chapter:t,order_index:s})}),!!e.length){for(const t of e){const n={...t.chapter,order_index:t.order_index};await ke("chapters",n)}b.chapters=r.map(t=>{const n=e.find(s=>s.chapter.id===t.id);return n?{...t,order_index:n.order_index}:t}),navigator.onLine&&await Promise.all(e.map(t=>kg(t.chapter.id,{order_index:t.order_index})))}}async function lx(r,e){if(!r||!e||r===e)return;const t=ox(),n=t.findIndex(a=>a.id===r),s=t.findIndex(a=>a.id===e);if(n===-1||s===-1)return;const i=[...t],[o]=i.splice(n,1);i.splice(s,0,o),await ax(i),re()}async function hl(){await ga(),Ee()}async function vf(r){await Ig(r)&&await hl()}async function cx(r,e){!r||!e||(await Rg(r,{status:e}),await hl())}async function ux(r){r&&(await Ng(r),await hl())}function dx(r){r&&(b.inboxFilter=r,Ee())}function kf(){return b.characters.find(r=>r.id===b.selectedCharacterId)}async function hx(){if(!b.selectedProjectId){xe("Cree un projet avant d'ajouter un personnage.");return}const r=await Dg(b.selectedProjectId);await Gr(),b.selectedCharacterId=r?.id??b.selectedCharacterId,re()}async function fx(r){!r||r===b.selectedCharacterId||(b.selectedCharacterId=r,re())}async function px(r){if(!r)return;const e=b.characters.find(s=>s.id===r),t=e?.first_name||e?.last_name?`${e?.first_name??""} ${e?.last_name??""}`.trim():"ce personnage";window.confirm(`Supprimer ${t} ?`)&&(await $g(r),await Gr(),re())}function mx(r){b.characterFilter=r,re()}function gx(r){!r||!(r in b.characterSections)||(b.characterSections={...b.characterSections,[r]:!b.characterSections[r]},re())}async function yx(r){const e=kf();if(!e)return;const t=Math.max(0,Math.min(5,r));await Nu(e.id,{role_rating:t}),await Gr(),re()}function bx(r,e){const t=r;So.has(t)&&clearTimeout(So.get(t));const n=window.setTimeout(async()=>{await Nu(r,e),await Gr(),re()},400);So.set(t,n)}function Sf(r,e,t=null){const n=kf();if(!n)return;const s=t?{meta:{[t]:{...n.meta?.[t]??{},[r]:e}}}:{[r]:e};bx(n.id,s)}function wx(){xe("Bientot disponible.")}async function vx(){if(b.cloudBusy)return;b.cloudBusy=!0,b.cloudStatus="Sauvegarde...",Ee();const r=await bf();if(r.ok){const e=Date.now();Pu(e),b.lastCloudSaveAt=e,b.cloudStatus="Sauvegarde terminee."}else b.cloudStatus=`Erreur: ${r.errorMessage}`;b.cloudBusy=!1,Ee()}async function kx(){if(b.cloudBusy)return;b.cloudBusy=!0,b.cloudStatus="Chargement...",Ee();const r=await XS();r.ok?(await bt({allowFallback:!1}),await pi(),await mi(),b.cloudStatus="Chargement termine."):b.cloudStatus=`Erreur: ${r.errorMessage}`,b.cloudBusy=!1,Ee()}async function Sx(){const r=await be("projects"),e=await be("chapters"),t=await be("outbox"),n=await be("inbox"),s=await be("characters"),i={version:1,exportedAt:new Date().toISOString(),data:{projects:r,chapters:e,outbox:t,inbox:n,characters:s}},o=new Blob([JSON.stringify(i)],{type:"application/json"}),a=URL.createObjectURL(o),c=`plumeo-backup-${new Date().toISOString().slice(0,10)}.json`,u=document.createElement("a");u.href=a,u.download=c,document.body.appendChild(u),u.click(),u.remove(),URL.revokeObjectURL(a),b.backupStatus="Export termine.",Ee()}async function nn(r,e){const t=await be(r);for(const n of t)n&&n[e]!=null&&await $t(r,n[e])}async function xx(r){if(!r)return;let e;try{const d=await r.text();e=JSON.parse(d)}catch{b.backupStatus="Import echoue.",Ee();return}if(!e||e.version!==1||!e.data){b.backupStatus="Import refuse (format).",Ee();return}const t=e.data,n=Array.isArray(t.projects)?t.projects:null,s=Array.isArray(t.chapters)?t.chapters:null,i=Array.isArray(t.outbox)?t.outbox:[],o=Array.isArray(t.inbox)?t.inbox:[],a=Array.isArray(t.characters)?t.characters:[];if(!n||!s){b.backupStatus="Import refuse (donnees).",Ee();return}const l=await be("projects"),c=await be("chapters");if(!((l.length>0||c.length>0)&&!window.confirm("Importer ce backup va remplacer les donnees locales. Continuer ?"))){await nn("projects","id"),await nn("chapters","id"),await nn("outbox","opId"),await nn("inbox","id"),await nn("characters","id"),await Yr(n),await Qr(s);for(const d of i)await ke("outbox",d);for(const d of o)await ke("inbox",d);for(const d of a)await ke("characters",d);b.backupStatus="Import termine.",await bt({allowFallback:!1}),await pi(),await mi(),Ee()}}async function mi(){const r=Hn(),e=Lg();if(!r||!e){b.lastChapterTitle=null;return}const t=await vi(e);if(!t||t.project_id!==r){b.lastChapterTitle=null;return}b.lastChapterTitle=t.title||"Sans titre"}async function Tx(r){return r?(b.selectedProjectId=r,await bt({allowFallback:!1}),b.projects.some(t=>t.id===r)?!0:(await wf(),await bt({allowFallback:!1}),b.projects.some(t=>t.id===r))):!1}async function _x(r){if(!await Tx(r)){window.location.hash="#/home";return}Xr(r),b.statusText="",b.editingProjectId=b.editingProjectId===r?r:null,await Li(),await Gr(),await br(),b.selectedChapterId&&Ts(b.selectedChapterId),await wr(b.selectedChapterId),re(),await rx(r),await br(),await Gr(),b.selectedChapterId&&Ts(b.selectedChapterId),await wr(b.selectedChapterId),re()}async function Ex(){const r=await Au("Sans titre");if(!r.ok){xe(`Erreur: ${r.errorMessage}`);return}await Yr([r.data]),Xr(r.data.id),b.editingProjectId=r.data.id,window.location.hash=`#/editor/${r.data.id}`}async function Cx(r){r!==b.selectedProjectId&&(Xr(r),b.editingProjectId=null,window.location.hash=`#/editor/${r}`)}async function Ax(r){r&&(Xr(r),window.location.hash=`#/editor/${r}`)}async function Ox(){const r=Hn();r&&(window.location.hash=`#/editor/${r}`)}async function Mx(){const r=await Au("Sans titre");if(!r.ok){Jr(`Erreur: ${r.errorMessage}`);return}Jr(""),await Yr([r.data]),Xr(r.data.id),b.editingProjectId=r.data.id,window.location.hash=`#/editor/${r.data.id}`}async function Ix(r){if(!r)return;const e=b.projects.find(i=>i.id===r),t=e?.title?`"${e.title}"`:"ce projet";if(!window.confirm(`Supprimer ${t} ? Cette action est definitive.`))return;const s=await bg(r);if(!s.ok){Jr(`Erreur: ${s.errorMessage}`);return}await Ag(r),await Og(r),await bt({allowFallback:!1}),b.selectedProjectId===r&&(b.selectedProjectId=null,b.selectedChapterId=null,b.chapterDetail=null,b.chapters=[],b.versions=[]),b.editingProjectId===r&&(b.editingProjectId=null),Hn()===r&&Xr(null),Jr("Projet supprime."),Ee()}async function Rx(r,e){const t=e.trim()||"Sans titre",n=await yg(r,t);if(!n.ok){xe(`Erreur: ${n.errorMessage}`);return}await Yr([n.data]),await bt({allowFallback:!1}),b.editingProjectId=null,re()}async function xf(r){if(!b.selectedChapterId)return;const e=await xa(b.selectedChapterId,{content_md:r});b.chapterDetail=e;const t=navigator.onLine?"Synchronisation...":"En attente (offline)";xe(t),dl();const n=b.selectedChapterId;vs=window.setTimeout(async()=>{if(await Ta(n),navigator.onLine){const s=await ki();await ji(s)}},1200)}async function Nx(){if(!b.selectedProjectId){xe("Cree un projet avant d'ajouter un chapitre.");return}const r=window.prompt("Titre du chapitre");if(!r)return;const e=b.chapters.length,t=await Ou(b.selectedProjectId,r.trim(),e);if(!t.ok){xe(`Erreur: ${t.errorMessage}`);return}await Qr([t.data]),b.selectedChapterId=t.data.id,Ts(t.data.id),await Li(),await br(),await wr(b.selectedChapterId),re()}async function Px(r){if(r!==b.selectedChapterId){if(dl(),b.selectedChapterId=r,Ts(r),b.statusText="",await br(),!b.chapterDetail){const e=await Mu(r);e.ok&&(await Qr([e.data]),await br())}await wr(r),re()}}async function Dx(){if(!b.chapterDetail?.server_copy)return;const r=b.chapterDetail.server_copy,e={...b.chapterDetail,title:r.title??b.chapterDetail.title,content_md:r.content_md??"",remote_revision:r.revision??b.chapterDetail.remote_revision??0,conflict:!1,dirty:!1,server_copy:null};await ke("chapters",e),b.chapterDetail=e,xe("Charge depuis serveur"),re()}async function $x(){if(!b.selectedProjectId||!b.chapterDetail)return;const e=`${b.chapterDetail.title||"Chapitre"} (copie)`,t=b.chapters.length,n=await Ou(b.selectedProjectId,e,t);if(!n.ok){xe(`Erreur: ${n.errorMessage}`);return}await Qr([n.data]);const s=await xa(n.data.id,{content_md:b.chapterDetail.content_md??""});b.selectedChapterId=n.data.id,b.chapterDetail=s;const i=navigator.onLine?"Synchronisation...":"En attente (offline)";if(xe(i),await Ta(n.data.id),navigator.onLine){const o=await ki();await ji(o)}await Li(),await wr(b.selectedChapterId),re()}async function Lx(){if(!b.selectedChapterId||!b.chapterDetail)return;const r=window.prompt("Label du snapshot (optionnel)"),e=await Iu(b.selectedChapterId,b.chapterDetail.content_md??"",r||null);if(!e.ok){xe(`Erreur: ${e.errorMessage}`);return}await wr(b.selectedChapterId),re()}async function jx(r){if(!b.selectedChapterId)return;const e=b.versions.find(s=>s.id===r);if(!e)return;const t=await xa(b.selectedChapterId,{content_md:e.content_md??""});b.chapterDetail=t;const n=navigator.onLine?"Synchronisation...":"En attente (offline)";if(xe(n),await Ta(b.selectedChapterId),navigator.onLine){const s=await ki();await ji(s)}re()}async function Bx(){if(!b.selectedProjectId)return;const r=await Ru(b.selectedProjectId),t=b.projects.find(c=>c.id===b.selectedProjectId)?.title??"Projet",n=[`# ${t}`,""],s=c=>{if(!c)return"";if(!/<[a-z][\s\S]*>/i.test(c))return c;const u=document.createElement("div");return u.innerHTML=c,u.textContent??""};for(const c of r)n.push(`## ${c.title??"Sans titre"}`),n.push(s(c.content_md??"")),n.push("");const i=new Blob([n.join(`
`)],{type:"text/markdown"}),o=URL.createObjectURL(i),a=`${t}`.replace(/[\\/:*?"<>|]/g,"-").trim()||"projet",l=document.createElement("a");l.href=o,l.download=`${a}.md`,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(o)}async function zx(r){const e=await vi(r);if(!e)return;const t=e.last_snapshot_at??0;if(Date.now()-t<ZS||!(await Iu(r,e.content_md??"","Auto")).ok)return;const s={...e,last_snapshot_at:Date.now()};await ke("chapters",s),r===b.selectedChapterId&&await wr(r)}async function ji(r){if(!r||r.length===0)return;for(const t of r)t.status==="synced"&&await zx(t.chapterId);const e=r.find(t=>t.chapterId===b.selectedChapterId);if(e){if(e.status==="synced"){await br(),xe("Enregistre"),re();return}e.status==="conflict"&&(await br(),xe("Conflit detecte"),re())}}et.addEventListener("click",async r=>{const e=r.target.closest("[data-action]");if(!e)return;const t=e.dataset.action;if(t==="sign-out"){(await Ll()).ok&&(window.location.hash="#login");return}if(t==="nav-home"){window.location.hash="#/home";return}if(t==="nav-editor"){const n=e.dataset.id||Hn();if(!n)return;window.location.hash=`#/editor/${n}`;return}if(t==="project-create"){await Ex();return}if(t==="home-project-create"){await Mx();return}if(t==="home-project-open"){await Ax(e.dataset.id);return}if(t==="home-backup-export"){await Sx();return}if(t==="home-backup-import"){const n=document.querySelector("#home-backup-file");n&&(n.value="",n.click());return}if(t==="home-cloud-save"){await vx();return}if(t==="home-cloud-load"){await kx();return}if(t==="home-sign-out"){const n=await Ll();if(!n.ok){console.error(n.errorMessage),Jr(`Erreur: ${n.errorMessage}`);return}Dt="",Jr(""),Ee();return}if(t==="home-project-delete"){await Ix(e.dataset.id);return}if(t==="home-project-continue"){await Ox();return}if(t==="inbox-create"){const n=document.querySelector("#inbox-capture");if(n instanceof HTMLInputElement){const s=n.value;n.value="",await vf(s)}return}if(t==="inbox-filter"){dx(e.dataset.status);return}if(t==="inbox-update"){await cx(e.dataset.id,e.dataset.status);return}if(t==="inbox-delete"){await ux(e.dataset.id);return}if(t==="project-select"){await Cx(e.dataset.id);return}if(t==="project-export-md"){await Bx();return}if(t==="chapter-create"){await Nx();return}if(t==="chapter-select"){await Px(e.dataset.id);return}if(t==="conflict-reload-server"){await Dx();return}if(t==="conflict-duplicate-local"){await $x();return}if(t==="version-create"){await Lx();return}if(t==="version-restore"&&await jx(e.dataset.id),t==="editor-tab"){const n=e.dataset.tab;n&&n!==b.editorTab&&(b.editorTab=n,re());return}if(t==="writing-nav"){const n=e.dataset.nav;n&&n!==b.writingNav&&(b.writingNav=n,re());return}if(t==="character-create"){await hx();return}if(t==="character-select"){await fx(e.dataset.id);return}if(t==="character-delete"){await px(e.dataset.id);return}if(t==="character-toggle"){gx(e.dataset.section);return}if(t==="character-rate"){const n=Number(e.dataset.rating);Number.isFinite(n)&&await yx(n);return}if(t==="character-write"){wx();return}});function ya(){document.querySelectorAll(".chapter-item.is-dragging, .chapter-item.is-drop-target").forEach(r=>r.classList.remove("is-dragging","is-drop-target"))}et.addEventListener("dragstart",r=>{const e=r.target.closest(".chapter-item");!e||!(r.dataTransfer instanceof DataTransfer)||(ot=e.dataset.id||null,ot&&(e.classList.add("is-dragging"),r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",ot)))});et.addEventListener("dragover",r=>{const e=r.target.closest(".chapter-item");if(!e||!ot)return;const t=e.dataset.id;if(!(!t||t===ot)){if(r.preventDefault(),ar&&ar!==t){const n=document.querySelector(`.chapter-item[data-id="${ar}"]`);n&&n.classList.remove("is-drop-target")}ar=t,e.classList.add("is-drop-target"),r.dataTransfer&&(r.dataTransfer.dropEffect="move")}});et.addEventListener("drop",async r=>{const e=r.target.closest(".chapter-item");if(!e||!ot){ya(),ot=null,ar=null;return}r.preventDefault();const t=e.dataset.id;ya();const n=ot;ot=null,ar=null,t&&await lx(n,t)});et.addEventListener("dragend",()=>{ya(),ot=null,ar=null});et.addEventListener("input",async r=>{const e=r.target;if(e){if(e.id==="character-filter"){mx(e.value);return}if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){const t=e.dataset.characterField,n=e.dataset.characterMeta||null;if(t){Sf(t,e.value,n);return}}e.id==="chapter-content"&&await xf(e.value)}});et.addEventListener("change",async r=>{const e=r.target;if(!(e instanceof HTMLInputElement))return;if(e.dataset.characterField){const n=e.dataset.characterField,s=e.dataset.characterMeta||null;Sf(n,e.value,s);return}if(e.id!=="home-backup-file")return;const t=e.files?.[0]??null;await xx(t),e.value=""});et.addEventListener("keydown",async r=>{const e=r.target;if(e instanceof HTMLInputElement){if(e.id==="inbox-capture"){if(r.key==="Enter"){r.preventDefault();const t=e.value;e.value="",await vf(t)}return}if(e.classList.contains("project-edit-input")){if(r.key==="Enter"){r.preventDefault();const t=e.dataset.id;t&&await Rx(t,e.value);return}r.key==="Escape"&&(r.preventDefault(),b.editingProjectId=null,re())}}});async function Tf(){const{page:r,props:e}=await dg();if(dl(),r==="editor"){Dt=e.userEmail,xo(!!Dt),lu||(zg(ji),lu=!0),await _x(e.projectId);return}if(ul(),r==="home"){Dt=e.userEmail,xo(!!Dt),await nx();return}et.innerHTML=fg({message:e.message}),xo(!1);const t=document.querySelector("#sign-in"),n=document.querySelector("#sign-up");t&&t.addEventListener("click",async()=>{const{email:s,password:i}=cu(),o=await cg(s,i);if(!o.ok){To(o.errorMessage);return}window.location.hash="#/home"}),n&&n.addEventListener("click",async()=>{const{email:s,password:i}=cu(),o=await lg(s,i);if(!o.ok){To(o.errorMessage);return}To("Compte cree. Verifie tes emails si besoin.")})}window.addEventListener("hashchange",Tf);Tf();
