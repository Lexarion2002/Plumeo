(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function zi(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t}function nm(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(u){try{c(r.next(u))}catch(d){o(d)}}function l(u){try{c(r.throw(u))}catch(d){o(d)}}function c(u){u.done?i(u.value):s(u.value).then(a,l)}c((r=r.apply(n,e||[])).next())})}const rm=n=>n?(...e)=>n(...e):(...e)=>fetch(...e);class Ga extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class sm extends Ga{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Zl extends Ga{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class ec extends Ga{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var ta;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(ta||(ta={}));class im{constructor(e,{headers:t={},customFetch:r,region:s=ta.Any}={}){this.url=e,this.headers=t,this.region=s,this.fetch=rm(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return nm(this,arguments,void 0,function*(t,r={}){var s;let i,o;try{const{headers:a,method:l,body:c,signal:u,timeout:d}=r;let h={},{region:f}=r;f||(f=this.region);const m=new URL(`${this.url}/${t}`);f&&f!=="any"&&(h["x-region"]=f,m.searchParams.set("forceFunctionRegion",f));let g;c&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(h["Content-Type"]="application/octet-stream",g=c):typeof c=="string"?(h["Content-Type"]="text/plain",g=c):typeof FormData<"u"&&c instanceof FormData?g=c:(h["Content-Type"]="application/json",g=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?g=JSON.stringify(c):g=c;let y=u;d&&(o=new AbortController,i=setTimeout(()=>o.abort(),d),u?(y=o.signal,u.addEventListener("abort",()=>o.abort())):y=o.signal);const b=yield this.fetch(m.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},h),this.headers),a),body:g,signal:y}).catch(T=>{throw new sm(T)}),v=b.headers.get("x-relay-error");if(v&&v==="true")throw new Zl(b);if(!b.ok)throw new ec(b);let w=((s=b.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),k;return w==="application/json"?k=yield b.json():w==="application/octet-stream"||w==="application/pdf"?k=yield b.blob():w==="text/event-stream"?k=b:w==="multipart/form-data"?k=yield b.formData():k=yield b.text(),{data:k,error:null,response:b}}catch(a){return{data:null,error:a,response:a instanceof ec||a instanceof Zl?a.context:void 0}}finally{i&&clearTimeout(i)}})}}var om=class extends Error{constructor(n){super(n.message),this.name="PostgrestError",this.details=n.details,this.hint=n.hint,this.code=n.code}},am=class{constructor(n){var e,t;this.shouldThrowOnError=!1,this.method=n.method,this.url=n.url,this.headers=new Headers(n.headers),this.schema=n.schema,this.body=n.body,this.shouldThrowOnError=(e=n.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=n.signal,this.isMaybeSingle=(t=n.isMaybeSingle)!==null&&t!==void 0?t:!1,n.fetch?this.fetch=n.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(n,e){return this.headers=new Headers(this.headers),this.headers.set(n,e),this}then(n,e){var t=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const r=this.fetch;let s=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{let o=null,a=null,l=null,c=i.status,u=i.statusText;if(i.ok){var d,h;if(t.method!=="HEAD"){var f;const b=await i.text();b===""||(t.headers.get("Accept")==="text/csv"||t.headers.get("Accept")&&(!((f=t.headers.get("Accept"))===null||f===void 0)&&f.includes("application/vnd.pgrst.plan+text"))?a=b:a=JSON.parse(b))}const g=(d=t.headers.get("Prefer"))===null||d===void 0?void 0:d.match(/count=(exact|planned|estimated)/),y=(h=i.headers.get("content-range"))===null||h===void 0?void 0:h.split("/");g&&y&&y.length>1&&(l=parseInt(y[1])),t.isMaybeSingle&&t.method==="GET"&&Array.isArray(a)&&(a.length>1?(o={code:"PGRST116",details:`Results contain ${a.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},a=null,l=null,c=406,u="Not Acceptable"):a.length===1?a=a[0]:a=null)}else{var m;const g=await i.text();try{o=JSON.parse(g),Array.isArray(o)&&i.status===404&&(a=[],o=null,c=200,u="OK")}catch{i.status===404&&g===""?(c=204,u="No Content"):o={message:g}}if(o&&t.isMaybeSingle&&(!(o==null||(m=o.details)===null||m===void 0)&&m.includes("0 rows"))&&(o=null,c=200,u="OK"),o&&t.shouldThrowOnError)throw new om(o)}return{error:o,data:a,count:l,status:c,statusText:u}});return this.shouldThrowOnError||(s=s.catch(i=>{var o;let a="";const l=i?.cause;if(l){var c,u,d,h;const m=(c=l?.message)!==null&&c!==void 0?c:"",g=(u=l?.code)!==null&&u!==void 0?u:"";a=`${(d=i?.name)!==null&&d!==void 0?d:"FetchError"}: ${i?.message}`,a+=`

Caused by: ${(h=l?.name)!==null&&h!==void 0?h:"Error"}: ${m}`,g&&(a+=` (${g})`),l?.stack&&(a+=`
${l.stack}`)}else{var f;a=(f=i?.stack)!==null&&f!==void 0?f:""}return{error:{message:`${(o=i?.name)!==null&&o!==void 0?o:"FetchError"}: ${i?.message}`,details:a,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),s.then(n,e)}returns(){return this}overrideTypes(){return this}},lm=class extends am{select(n){let e=!1;const t=(n??"*").split("").map(r=>/\s/.test(r)&&!e?"":(r==='"'&&(e=!e),r)).join("");return this.url.searchParams.set("select",t),this.headers.append("Prefer","return=representation"),this}order(n,{ascending:e=!0,nullsFirst:t,foreignTable:r,referencedTable:s=r}={}){const i=s?`${s}.order`:"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?`${o},`:""}${n}.${e?"asc":"desc"}${t===void 0?"":t?".nullsfirst":".nullslast"}`),this}limit(n,{foreignTable:e,referencedTable:t=e}={}){const r=typeof t>"u"?"limit":`${t}.limit`;return this.url.searchParams.set(r,`${n}`),this}range(n,e,{foreignTable:t,referencedTable:r=t}={}){const s=typeof r>"u"?"offset":`${r}.offset`,i=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(s,`${n}`),this.url.searchParams.set(i,`${e-n+1}`),this}abortSignal(n){return this.signal=n,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:n=!1,verbose:e=!1,settings:t=!1,buffers:r=!1,wal:s=!1,format:i="text"}={}){var o;const a=[n?"analyze":null,e?"verbose":null,t?"settings":null,r?"buffers":null,s?"wal":null].filter(Boolean).join("|"),l=(o=this.headers.get("Accept"))!==null&&o!==void 0?o:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${i}; for="${l}"; options=${a};`),i==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(n){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${n}`),this}};const tc=new RegExp("[,()]");var Hn=class extends lm{eq(n,e){return this.url.searchParams.append(n,`eq.${e}`),this}neq(n,e){return this.url.searchParams.append(n,`neq.${e}`),this}gt(n,e){return this.url.searchParams.append(n,`gt.${e}`),this}gte(n,e){return this.url.searchParams.append(n,`gte.${e}`),this}lt(n,e){return this.url.searchParams.append(n,`lt.${e}`),this}lte(n,e){return this.url.searchParams.append(n,`lte.${e}`),this}like(n,e){return this.url.searchParams.append(n,`like.${e}`),this}likeAllOf(n,e){return this.url.searchParams.append(n,`like(all).{${e.join(",")}}`),this}likeAnyOf(n,e){return this.url.searchParams.append(n,`like(any).{${e.join(",")}}`),this}ilike(n,e){return this.url.searchParams.append(n,`ilike.${e}`),this}ilikeAllOf(n,e){return this.url.searchParams.append(n,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(n,e){return this.url.searchParams.append(n,`ilike(any).{${e.join(",")}}`),this}regexMatch(n,e){return this.url.searchParams.append(n,`match.${e}`),this}regexIMatch(n,e){return this.url.searchParams.append(n,`imatch.${e}`),this}is(n,e){return this.url.searchParams.append(n,`is.${e}`),this}isDistinct(n,e){return this.url.searchParams.append(n,`isdistinct.${e}`),this}in(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&tc.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`in.(${t})`),this}notIn(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&tc.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`not.in.(${t})`),this}contains(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cs.{${e.join(",")}}`):this.url.searchParams.append(n,`cs.${JSON.stringify(e)}`),this}containedBy(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cd.{${e.join(",")}}`):this.url.searchParams.append(n,`cd.${JSON.stringify(e)}`),this}rangeGt(n,e){return this.url.searchParams.append(n,`sr.${e}`),this}rangeGte(n,e){return this.url.searchParams.append(n,`nxl.${e}`),this}rangeLt(n,e){return this.url.searchParams.append(n,`sl.${e}`),this}rangeLte(n,e){return this.url.searchParams.append(n,`nxr.${e}`),this}rangeAdjacent(n,e){return this.url.searchParams.append(n,`adj.${e}`),this}overlaps(n,e){return typeof e=="string"?this.url.searchParams.append(n,`ov.${e}`):this.url.searchParams.append(n,`ov.{${e.join(",")}}`),this}textSearch(n,e,{config:t,type:r}={}){let s="";r==="plain"?s="pl":r==="phrase"?s="ph":r==="websearch"&&(s="w");const i=t===void 0?"":`(${t})`;return this.url.searchParams.append(n,`${s}fts${i}.${e}`),this}match(n){return Object.entries(n).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(n,e,t){return this.url.searchParams.append(n,`not.${e}.${t}`),this}or(n,{foreignTable:e,referencedTable:t=e}={}){const r=t?`${t}.or`:"or";return this.url.searchParams.append(r,`(${n})`),this}filter(n,e,t){return this.url.searchParams.append(n,`${e}.${t}`),this}},cm=class{constructor(n,{headers:e={},schema:t,fetch:r}){this.url=n,this.headers=new Headers(e),this.schema=t,this.fetch=r}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(n,e){const{head:t=!1,count:r}=e??{},s=t?"HEAD":"GET";let i=!1;const o=(n??"*").split("").map(c=>/\s/.test(c)&&!i?"":(c==='"'&&(i=!i),c)).join(""),{url:a,headers:l}=this.cloneRequestState();return a.searchParams.set("select",o),r&&l.append("Prefer",`count=${r}`),new Hn({method:s,url:a,headers:l,schema:this.schema,fetch:this.fetch})}insert(n,{count:e,defaultToNull:t=!0}={}){var r;const s="POST",{url:i,headers:o}=this.cloneRequestState();if(e&&o.append("Prefer",`count=${e}`),t||o.append("Prefer","missing=default"),Array.isArray(n)){const a=n.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(a.length>0){const l=[...new Set(a)].map(c=>`"${c}"`);i.searchParams.set("columns",l.join(","))}}return new Hn({method:s,url:i,headers:o,schema:this.schema,body:n,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch})}upsert(n,{onConflict:e,ignoreDuplicates:t=!1,count:r,defaultToNull:s=!0}={}){var i;const o="POST",{url:a,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${t?"ignore":"merge"}-duplicates`),e!==void 0&&a.searchParams.set("on_conflict",e),r&&l.append("Prefer",`count=${r}`),s||l.append("Prefer","missing=default"),Array.isArray(n)){const c=n.reduce((u,d)=>u.concat(Object.keys(d)),[]);if(c.length>0){const u=[...new Set(c)].map(d=>`"${d}"`);a.searchParams.set("columns",u.join(","))}}return new Hn({method:o,url:a,headers:l,schema:this.schema,body:n,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch})}update(n,{count:e}={}){var t;const r="PATCH",{url:s,headers:i}=this.cloneRequestState();return e&&i.append("Prefer",`count=${e}`),new Hn({method:r,url:s,headers:i,schema:this.schema,body:n,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch})}delete({count:n}={}){var e;const t="DELETE",{url:r,headers:s}=this.cloneRequestState();return n&&s.append("Prefer",`count=${n}`),new Hn({method:t,url:r,headers:s,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch})}},um=class td{constructor(e,{headers:t={},schema:r,fetch:s}={}){this.url=e,this.headers=new Headers(t),this.schemaName=r,this.fetch=s}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new cm(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new td(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:s=!1,count:i}={}){var o;let a;const l=new URL(`${this.url}/rpc/${e}`);let c;const u=f=>f!==null&&typeof f=="object"&&(!Array.isArray(f)||f.some(u)),d=r&&Object.values(t).some(u);d?(a="POST",c=t):r||s?(a=r?"HEAD":"GET",Object.entries(t).filter(([f,m])=>m!==void 0).map(([f,m])=>[f,Array.isArray(m)?`{${m.join(",")}}`:`${m}`]).forEach(([f,m])=>{l.searchParams.append(f,m)})):(a="POST",c=t);const h=new Headers(this.headers);return d?h.set("Prefer",i?`count=${i},return=minimal`:"return=minimal"):i&&h.set("Prefer",`count=${i}`),new Hn({method:a,url:l,headers:h,schema:this.schemaName,body:c,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}};class dm{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const t=globalThis.process;if(t){const r=t.versions;if(r&&r.node){const s=r.node,i=parseInt(s.replace(/^v/,"").split(".")[0]);return i>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const hm="2.90.1",fm=`realtime-js/${hm}`,nd="1.0.0",pm="2.0.0",nc=nd,na=1e4,mm=1e3,gm=100;var Dt;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(Dt||(Dt={}));var me;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(me||(me={}));var Qe;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(Qe||(Qe={}));var ra;(function(n){n.websocket="websocket"})(ra||(ra={}));var hn;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(hn||(hn={}));class ym{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,r;const s=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,s)}_encodeJsonUserBroadcastPush(e){var t,r;const s=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:{},o=new TextEncoder().encode(JSON.stringify(s)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,o)}_encodeUserBroadcastPush(e,t,r){var s,i;const o=e.topic,a=(s=e.ref)!==null&&s!==void 0?s:"",l=(i=e.join_ref)!==null&&i!==void 0?i:"",c=e.payload.event,u=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},d=Object.keys(u).length===0?"":JSON.stringify(u);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`ref length ${a.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`topic length ${o.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(d.length>255)throw new Error(`metadata length ${d.length} exceeds maximum of 255`);const h=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+a.length+o.length+c.length+d.length,f=new ArrayBuffer(this.HEADER_LENGTH+h);let m=new DataView(f),g=0;m.setUint8(g++,this.KINDS.userBroadcastPush),m.setUint8(g++,l.length),m.setUint8(g++,a.length),m.setUint8(g++,o.length),m.setUint8(g++,c.length),m.setUint8(g++,d.length),m.setUint8(g++,t),Array.from(l,b=>m.setUint8(g++,b.charCodeAt(0))),Array.from(a,b=>m.setUint8(g++,b.charCodeAt(0))),Array.from(o,b=>m.setUint8(g++,b.charCodeAt(0))),Array.from(c,b=>m.setUint8(g++,b.charCodeAt(0))),Array.from(d,b=>m.setUint8(g++,b.charCodeAt(0)));var y=new Uint8Array(f.byteLength+r.byteLength);return y.set(new Uint8Array(f),0),y.set(new Uint8Array(r),f.byteLength),y.buffer}decode(e,t){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return t(r)}if(typeof e=="string"){const r=JSON.parse(e),[s,i,o,a,l]=r;return t({join_ref:s,ref:i,topic:o,event:a,payload:l})}return t({})}_binaryDecode(e){const t=new DataView(e),r=t.getUint8(0),s=new TextDecoder;if(r===this.KINDS.userBroadcast)return this._decodeUserBroadcast(e,t,s)}_decodeUserBroadcast(e,t,r){const s=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),a=t.getUint8(4);let l=this.HEADER_LENGTH+4;const c=r.decode(e.slice(l,l+s));l=l+s;const u=r.decode(e.slice(l,l+i));l=l+i;const d=r.decode(e.slice(l,l+o));l=l+o;const h=e.slice(l,e.byteLength),f=a===this.JSON_ENCODING?JSON.parse(r.decode(h)):h,m={type:this.BROADCAST_EVENT,event:u,payload:f};return o>0&&(m.meta=JSON.parse(d)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:m}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e?.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>t.includes(r)))}}class rd{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var Q;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(Q||(Q={}));const rc=(n,e,t={})=>{var r;const s=(r=t.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((i,o)=>(i[o]=bm(o,n,e,s),i),{}):{}},bm=(n,e,t,r)=>{const s=e.find(a=>a.name===n),i=s?.type,o=t[n];return i&&!r.includes(i)?sd(i,o):sa(o)},sd=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return Sm(e,t)}switch(n){case Q.bool:return wm(e);case Q.float4:case Q.float8:case Q.int2:case Q.int4:case Q.int8:case Q.numeric:case Q.oid:return vm(e);case Q.json:case Q.jsonb:return km(e);case Q.timestamp:return _m(e);case Q.abstime:case Q.date:case Q.daterange:case Q.int4range:case Q.int8range:case Q.money:case Q.reltime:case Q.text:case Q.time:case Q.timestamptz:case Q.timetz:case Q.tsrange:case Q.tstzrange:return sa(e);default:return sa(e)}},sa=n=>n,wm=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},vm=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},km=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch{return n}return n},Sm=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let i;const o=n.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(a=>sd(e,a))}return n},_m=n=>typeof n=="string"?n.replace(" ","T"):n,id=n=>{const e=new URL(n);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class po{constructor(e,t,r={},s=na){this.channel=e,this.event=t,this.payload=r,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var sc;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(sc||(sc={}));class Tr{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},s=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Tr.syncState(this.state,s,i,o),this.pendingDiffs.forEach(l=>{this.state=Tr.syncDiff(this.state,l,i,o)}),this.pendingDiffs=[],a()}),this.channel._on(r.diff,{},s=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=Tr.syncDiff(this.state,s,i,o),a())}),this.onJoin((s,i,o)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:o})}),this.onLeave((s,i,o)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,s){const i=this.cloneDeep(e),o=this.transformState(t),a={},l={};return this.map(i,(c,u)=>{o[c]||(l[c]=u)}),this.map(o,(c,u)=>{const d=i[c];if(d){const h=u.map(y=>y.presence_ref),f=d.map(y=>y.presence_ref),m=u.filter(y=>f.indexOf(y.presence_ref)<0),g=d.filter(y=>h.indexOf(y.presence_ref)<0);m.length>0&&(a[c]=m),g.length>0&&(l[c]=g)}else a[c]=u}),this.syncDiff(i,{joins:a,leaves:l},r,s)}static syncDiff(e,t,r,s){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),s||(s=()=>{}),this.map(i,(a,l)=>{var c;const u=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),u.length>0){const d=e[a].map(f=>f.presence_ref),h=u.filter(f=>d.indexOf(f.presence_ref)<0);e[a].unshift(...h)}r(a,u,l)}),this.map(o,(a,l)=>{let c=e[a];if(!c)return;const u=l.map(d=>d.presence_ref);c=c.filter(d=>u.indexOf(d.presence_ref)<0),e[a]=c,s(a,c,l),c.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const s=e[r];return"metas"in s?t[r]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[r]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var ic;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(ic||(ic={}));var Er;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(Er||(Er={}));var vt;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(vt||(vt={}));class Yn{constructor(e,t={config:{}},r){var s,i;if(this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=me.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new po(this,Qe.join,this.params,this.timeout),this.rejoinTimer=new rd(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=me.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(o=>o.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=me.closed,this.socket._remove(this)}),this._onError(o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=me.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=me.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=me.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Qe.reply,{},(o,a)=>{this._trigger(this._replyEventName(a),o)}),this.presence=new Tr(this),this.broadcastEndpointURL=id(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((i=(s=this.params.config)===null||s===void 0?void 0:s.broadcast)===null||i===void 0)&&i.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var r,s,i;if(this.socket.isConnected()||this.socket.connect(),this.state==me.closed){const{config:{broadcast:o,presence:a,private:l}}=this.params,c=(s=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(f=>f.filter))!==null&&s!==void 0?s:[],u=!!this.bindings[Er.PRESENCE]&&this.bindings[Er.PRESENCE].length>0||((i=this.params.config.presence)===null||i===void 0?void 0:i.enabled)===!0,d={},h={broadcast:o,presence:Object.assign(Object.assign({},a),{enabled:u}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(d.access_token=this.socket.accessTokenValue),this._onError(f=>e?.(vt.CHANNEL_ERROR,f)),this._onClose(()=>e?.(vt.CLOSED)),this.updateJoinPayload(Object.assign({config:h},d)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:f})=>{var m;if(this.socket._isManualToken()||this.socket.setAuth(),f===void 0){e?.(vt.SUBSCRIBED);return}else{const g=this.bindings.postgres_changes,y=(m=g?.length)!==null&&m!==void 0?m:0,b=[];for(let v=0;v<y;v++){const w=g[v],{filter:{event:k,schema:T,table:S,filter:x}}=w,C=f&&f[v];if(C&&C.event===k&&Yn.isFilterValueEqual(C.schema,T)&&Yn.isFilterValueEqual(C.table,S)&&Yn.isFilterValueEqual(C.filter,x))b.push(Object.assign(Object.assign({},w),{id:C.id}));else{this.unsubscribe(),this.state=me.errored,e?.(vt.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=b,e&&e(vt.SUBSCRIBED);return}}).receive("error",f=>{this.state=me.errored,e?.(vt.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(f).join(", ")||"error")))}).receive("timeout",()=>{e?.(vt.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===me.joined&&e===Er.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,t,r)}async httpSend(e,t,r={}){var s;if(t==null)return Promise.reject("Payload is required for httpSend()");const i={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(i.Authorization=`Bearer ${this.socket.accessTokenValue}`);const o={method:"POST",headers:i,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},a=await this._fetchWithTimeout(this.broadcastEndpointURL,o,(s=r.timeout)!==null&&s!==void 0?s:this.timeout);if(a.status===202)return{success:!0};let l=a.statusText;try{const c=await a.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(e,t={}){var r,s;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:i,payload:o}=e,a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((s=c.body)===null||s===void 0?void 0:s.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,a,l;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&i("ok"),c.receive("ok",()=>i("ok")),c.receive("error",()=>i("error")),c.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=me.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Qe.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(s=>{r=new po(this,Qe.leave,{},e),r.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=me.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){const s=new AbortController,i=setTimeout(()=>s.abort(),r),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(i),o}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new po(this,e,t,r);return this._canPush()?s.send():this._addToPushBuffer(s),s}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>gm){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var s,i;const o=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:u}=Qe;if(r&&[a,l,c,u].indexOf(o)>=0&&r!==this._joinRef())return;let h=this._onMessage(o,t,r);if(t&&!h)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(f=>{var m,g,y;return((m=f.filter)===null||m===void 0?void 0:m.event)==="*"||((y=(g=f.filter)===null||g===void 0?void 0:g.event)===null||y===void 0?void 0:y.toLocaleLowerCase())===o}).map(f=>f.callback(h,r)):(i=this.bindings[o])===null||i===void 0||i.filter(f=>{var m,g,y,b,v,w,k,T;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in f){const S=f.id,x=(m=f.filter)===null||m===void 0?void 0:m.event;return S&&((g=t.ids)===null||g===void 0?void 0:g.includes(S))&&(x==="*"||x?.toLocaleLowerCase()===((y=t.data)===null||y===void 0?void 0:y.type.toLocaleLowerCase()))&&(!(!((b=f.filter)===null||b===void 0)&&b.table)||f.filter.table===((v=t.data)===null||v===void 0?void 0:v.table))}else{const S=(k=(w=f?.filter)===null||w===void 0?void 0:w.event)===null||k===void 0?void 0:k.toLocaleLowerCase();return S==="*"||S===((T=t?.event)===null||T===void 0?void 0:T.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===o}).map(f=>{if(typeof h=="object"&&"ids"in h){const m=h.data,{schema:g,table:y,commit_timestamp:b,type:v,errors:w}=m;h=Object.assign(Object.assign({},{schema:g,table:y,commit_timestamp:b,eventType:v,new:{},old:{},errors:w}),this._getPayloadRecords(m))}f.callback(h,r)})}_isClosed(){return this.state===me.closed}_isJoined(){return this.state===me.joined}_isJoining(){return this.state===me.joining}_isLeaving(){return this.state===me.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:r};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===r&&Yn.isEqual(s.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}static isFilterValueEqual(e,t){return(e??void 0)===(t??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Qe.close,{},e)}_onError(e){this._on(Qe.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=me.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=rc(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=rc(e.columns,e.old_record)),t}}const mo=()=>{},ps={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},xm=[1e3,2e3,5e3,1e4],Tm=1e4,Em=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Cm{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=na,this.transport=null,this.heartbeatIntervalMs=ps.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=mo,this.ref=0,this.reconnectTimer=null,this.vsn=nc,this.logger=mo,this.conn=null,this.sendBuffer=[],this.serializer=new ym,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=s=>s?(...i)=>s(...i):(...i)=>fetch(...i),!(!((r=t?.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${ra.websocket}`,this.httpEndpoint=id(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=dm.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case Dt.connecting:return hn.Connecting;case Dt.open:return hn.Open;case Dt.closing:return hn.Closing;default:return hn.Closed}}isConnected(){return this.connectionState()===hn.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const r=`realtime:${e}`,s=this.getChannels().find(i=>i.topic===r);if(s)return s;{const i=new Yn(`realtime:${e}`,t,this);return this.channels.push(i),i}}push(e){const{topic:t,event:r,payload:s,ref:i}=e,o=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${r} (${i})`,s),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(mm,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},ps.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply"&&t.ref&&t.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error",c)}catch(u){this.log("error","error in heartbeat callback",u)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:r,event:s,payload:i,ref:o}=t,a=o?`(${o})`:"",l=i.status||"";this.log("receive",`${l} ${r} ${s} ${a}`.trim(),i),this.channels.filter(c=>c._isMember(r)).forEach(c=>c._trigger(s,i,o)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===Dt.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===Dt.open||this.conn.readyState===Dt.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this._terminateWorker()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(Qe.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${r}${s}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([Em],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t,r=!1;if(e)t=e,r=!0;else if(this.accessToken)try{t=await this.accessToken()}catch(s){this.log("error","Error fetching access token from callback",s),t=this.accessTokenValue}else t=this.accessTokenValue;r?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(s=>{const i={access_token:t,version:fm};t&&s.updateJoinPayload(i),s.joinedOnce&&s._isJoined()&&s._push(Qe.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(t=>{this.log("error",`Error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(s){this.log("error",`error in ${e} callback`,s)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new rd(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},ps.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,s,i,o,a,l,c,u,d,h,f;switch(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e?.timeout)!==null&&r!==void 0?r:na,this.heartbeatIntervalMs=(s=e?.heartbeatIntervalMs)!==null&&s!==void 0?s:ps.HEARTBEAT_INTERVAL,this.worker=(i=e?.worker)!==null&&i!==void 0?i:!1,this.accessToken=(o=e?.accessToken)!==null&&o!==void 0?o:null,this.heartbeatCallback=(a=e?.heartbeatCallback)!==null&&a!==void 0?a:mo,this.vsn=(l=e?.vsn)!==null&&l!==void 0?l:nc,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e?.reconnectAfterMs)!==null&&c!==void 0?c:(m=>xm[m-1]||Tm),this.vsn){case nd:this.encode=(u=e?.encode)!==null&&u!==void 0?u:((m,g)=>g(JSON.stringify(m))),this.decode=(d=e?.decode)!==null&&d!==void 0?d:((m,g)=>g(JSON.parse(m)));break;case pm:this.encode=(h=e?.encode)!==null&&h!==void 0?h:this.serializer.encode.bind(this.serializer),this.decode=(f=e?.decode)!==null&&f!==void 0?f:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}}var Br=class extends Error{constructor(n,e){super(n),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&e.icebergType?.includes("CommitState")===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function Am(n,e,t){const r=new URL(e,n);if(t)for(const[s,i]of Object.entries(t))i!==void 0&&r.searchParams.set(s,i);return r.toString()}async function Om(n){return!n||n.type==="none"?{}:n.type==="bearer"?{Authorization:`Bearer ${n.token}`}:n.type==="header"?{[n.name]:n.value}:n.type==="custom"?await n.getHeaders():{}}function Mm(n){const e=n.fetchImpl??globalThis.fetch;return{async request({method:t,path:r,query:s,body:i,headers:o}){const a=Am(n.baseUrl,r,s),l=await Om(n.auth),c=await e(a,{method:t,headers:{...i?{"Content-Type":"application/json"}:{},...l,...o},body:i?JSON.stringify(i):void 0}),u=await c.text(),d=(c.headers.get("content-type")||"").includes("application/json"),h=d&&u?JSON.parse(u):u;if(!c.ok){const f=d?h:void 0,m=f?.error;throw new Br(m?.message??`Request failed with status ${c.status}`,{status:c.status,icebergType:m?.type,icebergCode:m?.code,details:f})}return{status:c.status,headers:c.headers,data:h}}}}function ms(n){return n.join("")}var Im=class{constructor(n,e=""){this.client=n,this.prefix=e}async listNamespaces(n){const e=n?{parent:ms(n.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(n,e){const t={namespace:n.namespace,properties:e?.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(n){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${ms(n.namespace)}`})}async loadNamespaceMetadata(n){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${ms(n.namespace)}`})).data.properties}}async namespaceExists(n){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${ms(n.namespace)}`}),!0}catch(e){if(e instanceof Br&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(n,e){try{return await this.createNamespace(n,e)}catch(t){if(t instanceof Br&&t.status===409)return;throw t}}};function $n(n){return n.join("")}var Nm=class{constructor(n,e="",t){this.client=n,this.prefix=e,this.accessDelegation=t}async listTables(n){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${$n(n.namespace)}/tables`})).data.identifiers}async createTable(n,e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${$n(n.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(n,e){const t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${$n(n.namespace)}/tables/${n.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(n,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${$n(n.namespace)}/tables/${n.name}`,query:{purgeRequested:String(e?.purge??!1)}})}async loadTable(n){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${$n(n.namespace)}/tables/${n.name}`,headers:e})).data.metadata}async tableExists(n){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${$n(n.namespace)}/tables/${n.name}`,headers:e}),!0}catch(t){if(t instanceof Br&&t.status===404)return!1;throw t}}async createTableIfNotExists(n,e){try{return await this.createTable(n,e)}catch(t){if(t instanceof Br&&t.status===409)return await this.loadTable({namespace:n.namespace,name:e.name});throw t}}},Rm=class{constructor(n){let e="v1";n.catalogName&&(e+=`/${n.catalogName}`);const t=n.baseUrl.endsWith("/")?n.baseUrl:`${n.baseUrl}/`;this.client=Mm({baseUrl:t,auth:n.auth,fetchImpl:n.fetch}),this.accessDelegation=n.accessDelegation?.join(","),this.namespaceOps=new Im(this.client,e),this.tableOps=new Nm(this.client,e,this.accessDelegation)}async listNamespaces(n){return this.namespaceOps.listNamespaces(n)}async createNamespace(n,e){return this.namespaceOps.createNamespace(n,e)}async dropNamespace(n){await this.namespaceOps.dropNamespace(n)}async loadNamespaceMetadata(n){return this.namespaceOps.loadNamespaceMetadata(n)}async listTables(n){return this.tableOps.listTables(n)}async createTable(n,e){return this.tableOps.createTable(n,e)}async updateTable(n,e){return this.tableOps.updateTable(n,e)}async dropTable(n,e){await this.tableOps.dropTable(n,e)}async loadTable(n){return this.tableOps.loadTable(n)}async namespaceExists(n){return this.namespaceOps.namespaceExists(n)}async tableExists(n){return this.tableOps.tableExists(n)}async createNamespaceIfNotExists(n,e){return this.namespaceOps.createNamespaceIfNotExists(n,e)}async createTableIfNotExists(n,e){return this.tableOps.createTableIfNotExists(n,e)}},Fi=class extends Error{constructor(n){super(n),this.__isStorageError=!0,this.name="StorageError"}};function ne(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}var Pm=class extends Fi{constructor(n,e,t){super(n),this.name="StorageApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},ia=class extends Fi{constructor(n,e){super(n),this.name="StorageUnknownError",this.originalError=e}};const Ya=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),$m=()=>Response,oa=n=>{if(Array.isArray(n))return n.map(t=>oa(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,r])=>{const s=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[s]=oa(r)}),e},Dm=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},jm=n=>!n||typeof n!="string"||n.length===0||n.length>100||n.trim()!==n||n.includes("/")||n.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(n);function zr(n){"@babel/helpers - typeof";return zr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},zr(n)}function Lm(n,e){if(zr(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(zr(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Bm(n){var e=Lm(n,"string");return zr(e)=="symbol"?e:e+""}function zm(n,e,t){return(e=Bm(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function oc(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,r)}return t}function D(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?oc(Object(t),!0).forEach(function(r){zm(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):oc(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const go=n=>{var e;return n.msg||n.message||n.error_description||(typeof n.error=="string"?n.error:(e=n.error)===null||e===void 0?void 0:e.message)||JSON.stringify(n)},Fm=async(n,e,t)=>{n instanceof await $m()&&!t?.noResolveJson?n.json().then(r=>{const s=n.status||500,i=r?.statusCode||s+"";e(new Pm(go(r),s,i))}).catch(r=>{e(new ia(go(r),r))}):e(new ia(go(n),n))},Um=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return n==="GET"||!r?s:(Dm(r)?(s.headers=D({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,e?.duplex&&(s.duplex=e.duplex),D(D({},s),t))};async function rs(n,e,t,r,s,i){return new Promise((o,a)=>{n(t,Um(e,r,s,i)).then(l=>{if(!l.ok)throw l;return r?.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>Fm(l,a,r))})}async function Fr(n,e,t,r){return rs(n,"GET",e,t,r)}async function Xe(n,e,t,r,s){return rs(n,"POST",e,r,s,t)}async function aa(n,e,t,r,s){return rs(n,"PUT",e,r,s,t)}async function Hm(n,e,t,r){return rs(n,"HEAD",e,D(D({},t),{},{noResolveJson:!0}),r)}async function Xa(n,e,t,r,s){return rs(n,"DELETE",e,r,s,t)}var Vm=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e}then(n,e){return this.execute().then(n,e)}async execute(){var n=this;try{return{data:(await n.downloadFn()).body,error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(ne(e))return{data:null,error:e};throw e}}};let od;od=Symbol.toStringTag;var qm=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e,this[od]="BlobDownloadBuilder",this.promise=null}asStream(){return new Vm(this.downloadFn,this.shouldThrowOnError)}then(n,e){return this.getPromise().then(n,e)}catch(n){return this.getPromise().catch(n)}finally(n){return this.getPromise().finally(n)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var n=this;try{return{data:await(await n.downloadFn()).blob(),error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(ne(e))return{data:null,error:e};throw e}}};const Wm={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},ac={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var Km=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1,this.url=n,this.headers=e,this.bucketId=t,this.fetch=Ya(r)}throwOnError(){return this.shouldThrowOnError=!0,this}async uploadOrUpdate(n,e,t,r){var s=this;try{let i;const o=D(D({},ac),r);let a=D(D({},s.headers),n==="POST"&&{"x-upsert":String(o.upsert)});const l=o.metadata;typeof Blob<"u"&&t instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),l&&i.append("metadata",s.encodeMetadata(l)),i.append("",t)):typeof FormData<"u"&&t instanceof FormData?(i=t,i.has("cacheControl")||i.append("cacheControl",o.cacheControl),l&&!i.has("metadata")&&i.append("metadata",s.encodeMetadata(l))):(i=t,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,l&&(a["x-metadata"]=s.toBase64(s.encodeMetadata(l))),(typeof ReadableStream<"u"&&i instanceof ReadableStream||i&&typeof i=="object"&&"pipe"in i&&typeof i.pipe=="function")&&!o.duplex&&(o.duplex="half")),r?.headers&&(a=D(D({},a),r.headers));const c=s._removeEmptyFolders(e),u=s._getFinalPath(c),d=await(n=="PUT"?aa:Xe)(s.fetch,`${s.url}/object/${u}`,i,D({headers:a},o?.duplex?{duplex:o.duplex}:{}));return{data:{path:c,id:d.Id,fullPath:d.Key},error:null}}catch(i){if(s.shouldThrowOnError)throw i;if(ne(i))return{data:null,error:i};throw i}}async upload(n,e,t){return this.uploadOrUpdate("POST",n,e,t)}async uploadToSignedUrl(n,e,t,r){var s=this;const i=s._removeEmptyFolders(n),o=s._getFinalPath(i),a=new URL(s.url+`/object/upload/sign/${o}`);a.searchParams.set("token",e);try{let l;const c=D({upsert:ac.upsert},r),u=D(D({},s.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&t instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",t)):typeof FormData<"u"&&t instanceof FormData?(l=t,l.append("cacheControl",c.cacheControl)):(l=t,u["cache-control"]=`max-age=${c.cacheControl}`,u["content-type"]=c.contentType),{data:{path:i,fullPath:(await aa(s.fetch,a.toString(),l,{headers:u})).Key},error:null}}catch(l){if(s.shouldThrowOnError)throw l;if(ne(l))return{data:null,error:l};throw l}}async createSignedUploadUrl(n,e){var t=this;try{let r=t._getFinalPath(n);const s=D({},t.headers);e?.upsert&&(s["x-upsert"]="true");const i=await Xe(t.fetch,`${t.url}/object/upload/sign/${r}`,{},{headers:s}),o=new URL(t.url+i.url),a=o.searchParams.get("token");if(!a)throw new Fi("No token returned by API");return{data:{signedUrl:o.toString(),path:n,token:a},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ne(r))return{data:null,error:r};throw r}}async update(n,e,t){return this.uploadOrUpdate("PUT",n,e,t)}async move(n,e,t){var r=this;try{return{data:await Xe(r.fetch,`${r.url}/object/move`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t?.destinationBucket},{headers:r.headers}),error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ne(s))return{data:null,error:s};throw s}}async copy(n,e,t){var r=this;try{return{data:{path:(await Xe(r.fetch,`${r.url}/object/copy`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t?.destinationBucket},{headers:r.headers})).Key},error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ne(s))return{data:null,error:s};throw s}}async createSignedUrl(n,e,t){var r=this;try{let s=r._getFinalPath(n),i=await Xe(r.fetch,`${r.url}/object/sign/${s}`,D({expiresIn:e},t?.transform?{transform:t.transform}:{}),{headers:r.headers});const o=t?.download?`&download=${t.download===!0?"":t.download}`:"";return i={signedUrl:encodeURI(`${r.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ne(s))return{data:null,error:s};throw s}}async createSignedUrls(n,e,t){var r=this;try{const s=await Xe(r.fetch,`${r.url}/object/sign/${r.bucketId}`,{expiresIn:e,paths:n},{headers:r.headers}),i=t?.download?`&download=${t.download===!0?"":t.download}`:"";return{data:s.map(o=>D(D({},o),{},{signedUrl:o.signedURL?encodeURI(`${r.url}${o.signedURL}${i}`):null})),error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ne(s))return{data:null,error:s};throw s}}download(n,e){const t=typeof e?.transform<"u"?"render/image/authenticated":"object",r=this.transformOptsToQueryString(e?.transform||{}),s=r?`?${r}`:"",i=this._getFinalPath(n),o=()=>Fr(this.fetch,`${this.url}/${t}/${i}${s}`,{headers:this.headers,noResolveJson:!0});return new qm(o,this.shouldThrowOnError)}async info(n){var e=this;const t=e._getFinalPath(n);try{return{data:oa(await Fr(e.fetch,`${e.url}/object/info/${t}`,{headers:e.headers})),error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(ne(r))return{data:null,error:r};throw r}}async exists(n){var e=this;const t=e._getFinalPath(n);try{return await Hm(e.fetch,`${e.url}/object/${t}`,{headers:e.headers}),{data:!0,error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(ne(r)&&r instanceof ia){const s=r.originalError;if([400,404].includes(s?.status))return{data:!1,error:r}}throw r}}getPublicUrl(n,e){const t=this._getFinalPath(n),r=[],s=e?.download?`download=${e.download===!0?"":e.download}`:"";s!==""&&r.push(s);const i=typeof e?.transform<"u"?"render/image":"object",o=this.transformOptsToQueryString(e?.transform||{});o!==""&&r.push(o);let a=r.join("&");return a!==""&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${i}/public/${t}${a}`)}}}async remove(n){var e=this;try{return{data:await Xa(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}async list(n,e,t){var r=this;try{const s=D(D(D({},Wm),e),{},{prefix:n||""});return{data:await Xe(r.fetch,`${r.url}/object/list/${r.bucketId}`,s,{headers:r.headers},t),error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ne(s))return{data:null,error:s};throw s}}async listV2(n,e){var t=this;try{const r=D({},n);return{data:await Xe(t.fetch,`${t.url}/object/list-v2/${t.bucketId}`,r,{headers:t.headers},e),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ne(r))return{data:null,error:r};throw r}}encodeMetadata(n){return JSON.stringify(n)}toBase64(n){return typeof Buffer<"u"?Buffer.from(n).toString("base64"):btoa(n)}_getFinalPath(n){return`${this.bucketId}/${n.replace(/^\/+/,"")}`}_removeEmptyFolders(n){return n.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(n){const e=[];return n.width&&e.push(`width=${n.width}`),n.height&&e.push(`height=${n.height}`),n.resize&&e.push(`resize=${n.resize}`),n.format&&e.push(`format=${n.format}`),n.quality&&e.push(`quality=${n.quality}`),e.join("&")}};const ad="2.90.1",ld={"X-Client-Info":`storage-js/${ad}`};var Jm=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1;const s=new URL(n);r?.useNewHostname&&/supabase\.(co|in|red)$/.test(s.hostname)&&!s.hostname.includes("storage.supabase.")&&(s.hostname=s.hostname.replace("supabase.","storage.supabase.")),this.url=s.href.replace(/\/$/,""),this.headers=D(D({},ld),e),this.fetch=Ya(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async listBuckets(n){var e=this;try{const t=e.listBucketOptionsToQueryString(n);return{data:await Fr(e.fetch,`${e.url}/bucket${t}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await Fr(e.fetch,`${e.url}/bucket/${n}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}async createBucket(n,e={public:!1}){var t=this;try{return{data:await Xe(t.fetch,`${t.url}/bucket`,{id:n,name:n,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ne(r))return{data:null,error:r};throw r}}async updateBucket(n,e){var t=this;try{return{data:await aa(t.fetch,`${t.url}/bucket/${n}`,{id:n,name:n,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ne(r))return{data:null,error:r};throw r}}async emptyBucket(n){var e=this;try{return{data:await Xe(e.fetch,`${e.url}/bucket/${n}/empty`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await Xa(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}listBucketOptionsToQueryString(n){const e={};return n&&("limit"in n&&(e.limit=String(n.limit)),"offset"in n&&(e.offset=String(n.offset)),n.search&&(e.search=n.search),n.sortColumn&&(e.sortColumn=n.sortColumn),n.sortOrder&&(e.sortOrder=n.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},Gm=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=D(D({},ld),e),this.fetch=Ya(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await Xe(e.fetch,`${e.url}/bucket`,{name:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}async listBuckets(n){var e=this;try{const t=new URLSearchParams;n?.limit!==void 0&&t.set("limit",n.limit.toString()),n?.offset!==void 0&&t.set("offset",n.offset.toString()),n?.sortColumn&&t.set("sortColumn",n.sortColumn),n?.sortOrder&&t.set("sortOrder",n.sortOrder),n?.search&&t.set("search",n.search);const r=t.toString(),s=r?`${e.url}/bucket?${r}`:`${e.url}/bucket`;return{data:await Fr(e.fetch,s,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await Xa(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ne(t))return{data:null,error:t};throw t}}from(n){var e=this;if(!jm(n))throw new Fi("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const t=new Rm({baseUrl:this.url,catalogName:n,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),r=this.shouldThrowOnError;return new Proxy(t,{get(s,i){const o=s[i];return typeof o!="function"?o:async(...a)=>{try{return{data:await o.apply(s,a),error:null}}catch(l){if(r)throw l;return{data:null,error:l}}}}})}};const Qa={"X-Client-Info":`storage-js/${ad}`,"Content-Type":"application/json"};var cd=class extends Error{constructor(n){super(n),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}};function je(n){return typeof n=="object"&&n!==null&&"__isStorageVectorsError"in n}var yo=class extends cd{constructor(n,e,t){super(n),this.name="StorageVectorsApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},Ym=class extends cd{constructor(n,e){super(n),this.name="StorageVectorsUnknownError",this.originalError=e}};const Za=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Xm=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},lc=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),Qm=async(n,e,t)=>{if(n&&typeof n=="object"&&"status"in n&&"ok"in n&&typeof n.status=="number"&&!t?.noResolveJson){const r=n.status||500,s=n;if(typeof s.json=="function")s.json().then(i=>{const o=i?.statusCode||i?.code||r+"";e(new yo(lc(i),r,o))}).catch(()=>{const i=r+"";e(new yo(s.statusText||`HTTP ${r} error`,r,i))});else{const i=r+"";e(new yo(s.statusText||`HTTP ${r} error`,r,i))}}else e(new Ym(lc(n),n))},Zm=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return r?(Xm(r)?(s.headers=D({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,D(D({},s),t)):s};async function eg(n,e,t,r,s,i){return new Promise((o,a)=>{n(t,Zm(e,r,s,i)).then(l=>{if(!l.ok)throw l;if(r?.noResolveJson)return l;const c=l.headers.get("content-type");return!c||!c.includes("application/json")?{}:l.json()}).then(l=>o(l)).catch(l=>Qm(l,a,r))})}async function Le(n,e,t,r,s){return eg(n,"POST",e,r,s,t)}var tg=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=D(D({},Qa),e),this.fetch=Za(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createIndex(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/CreateIndex`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async getIndex(n,e){var t=this;try{return{data:await Le(t.fetch,`${t.url}/GetIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(je(r))return{data:null,error:r};throw r}}async listIndexes(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/ListIndexes`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async deleteIndex(n,e){var t=this;try{return{data:await Le(t.fetch,`${t.url}/DeleteIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers})||{},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(je(r))return{data:null,error:r};throw r}}},ng=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=D(D({},Qa),e),this.fetch=Za(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async putVectors(n){var e=this;try{if(n.vectors.length<1||n.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:await Le(e.fetch,`${e.url}/PutVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async getVectors(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/GetVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async listVectors(n){var e=this;try{if(n.segmentCount!==void 0){if(n.segmentCount<1||n.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(n.segmentIndex!==void 0&&(n.segmentIndex<0||n.segmentIndex>=n.segmentCount))throw new Error(`segmentIndex must be between 0 and ${n.segmentCount-1}`)}return{data:await Le(e.fetch,`${e.url}/ListVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async queryVectors(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/QueryVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async deleteVectors(n){var e=this;try{if(n.keys.length<1||n.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:await Le(e.fetch,`${e.url}/DeleteVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}},rg=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=D(D({},Qa),e),this.fetch=Za(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async listBuckets(n={}){var e=this;try{return{data:await Le(e.fetch,`${e.url}/ListVectorBuckets`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await Le(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(je(t))return{data:null,error:t};throw t}}},sg=class extends rg{constructor(n,e={}){super(n,e.headers||{},e.fetch)}from(n){return new ig(this.url,this.headers,n,this.fetch)}async createBucket(n){var e=()=>super.createBucket,t=this;return e().call(t,n)}async getBucket(n){var e=()=>super.getBucket,t=this;return e().call(t,n)}async listBuckets(n={}){var e=()=>super.listBuckets,t=this;return e().call(t,n)}async deleteBucket(n){var e=()=>super.deleteBucket,t=this;return e().call(t,n)}},ig=class extends tg{constructor(n,e,t,r){super(n,e,r),this.vectorBucketName=t}async createIndex(n){var e=()=>super.createIndex,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName}))}async listIndexes(n={}){var e=()=>super.listIndexes,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName}))}async getIndex(n){var e=()=>super.getIndex,t=this;return e().call(t,t.vectorBucketName,n)}async deleteIndex(n){var e=()=>super.deleteIndex,t=this;return e().call(t,t.vectorBucketName,n)}index(n){return new og(this.url,this.headers,this.vectorBucketName,n,this.fetch)}},og=class extends ng{constructor(n,e,t,r,s){super(n,e,s),this.vectorBucketName=t,this.indexName=r}async putVectors(n){var e=()=>super.putVectors,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async getVectors(n){var e=()=>super.getVectors,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async listVectors(n={}){var e=()=>super.listVectors,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async queryVectors(n){var e=()=>super.queryVectors,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async deleteVectors(n){var e=()=>super.deleteVectors,t=this;return e().call(t,D(D({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}},ag=class extends Jm{constructor(n,e={},t,r){super(n,e,t,r)}from(n){return new Km(this.url,this.headers,n,this.fetch)}get vectors(){return new sg(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new Gm(this.url+"/iceberg",this.headers,this.fetch)}};const ud="2.90.1",Vn=30*1e3,la=3,bo=la*Vn,lg="http://localhost:9999",cg="supabase.auth.token",ug={"X-Client-Info":`gotrue-js/${ud}`},ca="X-Supabase-Api-Version",dd={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},dg=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,hg=600*1e3;class Ur extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}}function O(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class fg extends Ur{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}}function pg(n){return O(n)&&n.name==="AuthApiError"}class fn extends Ur{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class Ct extends Ur{constructor(e,t,r,s){super(e,r,s),this.name=t,this.status=r}}class De extends Ct{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function mg(n){return O(n)&&n.name==="AuthSessionMissingError"}class Dn extends Ct{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class gs extends Ct{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class ys extends Ct{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function gg(n){return O(n)&&n.name==="AuthImplicitGrantRedirectError"}class cc extends Ct{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class yg extends Ct{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class ua extends Ct{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function wo(n){return O(n)&&n.name==="AuthRetryableFetchError"}class uc extends Ct{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}}class da extends Ct{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Bs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),dc=` 	
\r=`.split(""),bg=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<dc.length;e+=1)n[dc[e].charCodeAt(0)]=-2;for(let e=0;e<Bs.length;e+=1)n[Bs[e].charCodeAt(0)]=e;return n})();function hc(n,e,t){if(n!==null)for(e.queue=e.queue<<8|n,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(Bs[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(Bs[r]),e.queuedBits-=6}}function hd(n,e,t){const r=bg[n];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function fc(n){const e=[],t=o=>{e.push(String.fromCodePoint(o))},r={utf8seq:0,codepoint:0},s={queue:0,queuedBits:0},i=o=>{kg(o,r,t)};for(let o=0;o<n.length;o+=1)hd(n.charCodeAt(o),s,i);return e.join("")}function wg(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function vg(n,e){for(let t=0;t<n.length;t+=1){let r=n.charCodeAt(t);if(r>55295&&r<=56319){const s=(r-55296)*1024&65535;r=(n.charCodeAt(t+1)-56320&65535|s)+65536,t+=1}wg(r,e)}}function kg(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let r=1;r<6;r+=1)if((n>>7-r&1)===0){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function er(n){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};for(let s=0;s<n.length;s+=1)hd(n.charCodeAt(s),t,r);return new Uint8Array(e)}function Sg(n){const e=[];return vg(n,t=>e.push(t)),new Uint8Array(e)}function mn(n){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};return n.forEach(s=>hc(s,t,r)),hc(null,t,r),e.join("")}function _g(n){return Math.round(Date.now()/1e3)+n}function xg(){return Symbol("auth-callback")}const Se=()=>typeof window<"u"&&typeof document<"u",on={tested:!1,writable:!1},fd=()=>{if(!Se())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(on.tested)return on.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),on.tested=!0,on.writable=!0}catch{on.tested=!0,on.writable=!1}return on.writable};function Tg(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,i)=>{e[i]=s})}catch{}return t.searchParams.forEach((r,s)=>{e[s]=r}),e}const pd=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Eg=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",qn=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},an=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},ke=async(n,e)=>{await n.removeItem(e)};class Ui{constructor(){this.promise=new Ui.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Ui.promiseConstructor=Promise;function vo(n){const e=n.split(".");if(e.length!==3)throw new da("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!dg.test(e[r]))throw new da("JWT not in base64url format");return{header:JSON.parse(fc(e[0])),payload:JSON.parse(fc(e[1])),signature:er(e[2]),raw:{header:e[0],payload:e[1]}}}async function Cg(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function Ag(n,e){return new Promise((r,s)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await n(i);if(!e(i,null,o)){r(o);return}}catch(o){if(!e(i,o)){s(o);return}}})()})}function Og(n){return("0"+n.toString(16)).substr(-2)}function Mg(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*r));return s}return crypto.getRandomValues(e),Array.from(e,Og).join("")}async function Ig(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(r);return Array.from(s).map(i=>String.fromCharCode(i)).join("")}async function Ng(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await Ig(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function jn(n,e,t=!1){const r=Mg();let s=r;t&&(s+="/PASSWORD_RECOVERY"),await qn(n,`${e}-code-verifier`,s);const i=await Ng(r);return[i,r===i?"plain":"s256"]}const Rg=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Pg(n){const e=n.headers.get(ca);if(!e||!e.match(Rg))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function $g(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function Dg(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const jg=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function Ln(n){if(!jg.test(n))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function ko(){const n={};return new Proxy(n,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Lg(n,e){return new Proxy(n,{get:(t,r,s)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){const i=r.toString();if(i==="Symbol(Symbol.toPrimitive)"||i==="Symbol(Symbol.toStringTag)"||i==="Symbol(util.inspect.custom)"||i==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,r,s)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,r,s)}})}function pc(n){return JSON.parse(JSON.stringify(n))}const un=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),Bg=[502,503,504];async function mc(n){var e;if(!Eg(n))throw new ua(un(n),0);if(Bg.includes(n.status))throw new ua(un(n),n.status);let t;try{t=await n.json()}catch(i){throw new fn(un(i),i)}let r;const s=Pg(n);if(s&&s.getTime()>=dd["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new uc(un(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new De}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new uc(un(t),n.status,t.weak_password.reasons);throw new fg(un(t),n.status||500,r)}const zg=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};async function $(n,e,t,r){var s;const i=Object.assign({},r?.headers);i[ca]||(i[ca]=dd["2024-01-01"].name),r?.jwt&&(i.Authorization=`Bearer ${r.jwt}`);const o=(s=r?.query)!==null&&s!==void 0?s:{};r?.redirectTo&&(o.redirect_to=r.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await Fg(n,e,t+a,{headers:i,noResolveJson:r?.noResolveJson},{},r?.body);return r?.xform?r?.xform(l):{data:Object.assign({},l),error:null}}async function Fg(n,e,t,r,s,i){const o=zg(e,r,s,i);let a;try{a=await n(t,Object.assign({},o))}catch(l){throw console.error(l),new ua(un(l),0)}if(a.ok||await mc(a),r?.noResolveJson)return a;try{return await a.json()}catch(l){await mc(l)}}function Ye(n){var e;let t=null;Vg(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=_g(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function gc(n){const e=Ye(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function zt(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function Ug(n){return{data:n,error:null}}function Hg(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i}=n,o=zi(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i},l=Object.assign({},o);return{data:{properties:a,user:l},error:null}}function yc(n){return n}function Vg(n){return n.access_token&&n.refresh_token&&n.expires_in}const So=["global","local","others"];class qg{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=pd(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=So[0]){if(So.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${So.join(", ")}`);try{return await $(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(O(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await $(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:zt})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=zi(e,["options"]),s=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(s.new_email=r?.newEmail,delete s.newEmail),await $(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:Hg,redirectTo:t?.redirectTo})}catch(t){if(O(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await $(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:zt})}catch(t){if(O(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,s,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},u=await $(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:yc});if(u.error)throw u.error;const d=await u.json(),h=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(l=(a=u.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(m=>{const g=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),y=JSON.parse(m.split(";")[1].split("=")[1]);c[`${y}Page`]=g}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},d),c),error:null}}catch(c){if(O(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){Ln(e);try{return await $(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:zt})}catch(t){if(O(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){Ln(e);try{return await $(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:zt})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){Ln(e);try{return await $(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:zt})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){Ln(e.userId);try{const{data:t,error:r}=await $(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:r}}catch(t){if(O(t))return{data:null,error:t};throw t}}async _deleteFactor(e){Ln(e.userId),Ln(e.id);try{return{data:await $(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,r,s,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},u=await $(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:yc});if(u.error)throw u.error;const d=await u.json(),h=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,f=(l=(a=u.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(m=>{const g=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),y=JSON.parse(m.split(";")[1].split("=")[1]);c[`${y}Page`]=g}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},d),c),error:null}}catch(c){if(O(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(e){try{return await $(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(O(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await $(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(O(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await $(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(O(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await $(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await $(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(O(t))return{data:null,error:t};throw t}}}function bc(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}const Bn={debug:!!(globalThis&&fd()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class md extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Wg extends md{}async function Kg(n,e,t){Bn.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),Bn.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async s=>{if(s){Bn.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,s.name);try{return await t()}finally{Bn.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,s.name)}}else{if(e===0)throw Bn.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new Wg(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(Bn.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function Jg(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function gd(n){if(!/^0x[a-fA-F0-9]{40}$/.test(n))throw new Error(`@supabase/auth-js: Address "${n}" is invalid.`);return n.toLowerCase()}function Gg(n){return parseInt(n,16)}function Yg(n){const e=new TextEncoder().encode(n);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function Xg(n){var e;const{chainId:t,domain:r,expirationTime:s,issuedAt:i=new Date,nonce:o,notBefore:a,requestId:l,resources:c,scheme:u,uri:d,version:h}=n;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(o&&o.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${o}`);if(!d)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(h!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${h}`);if(!((e=n.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${n.statement}`)}const f=gd(n.address),m=u?`${u}://${r}`:r,g=n.statement?`${n.statement}
`:"",y=`${m} wants you to sign in with your Ethereum account:
${f}

${g}`;let b=`URI: ${d}
Version: ${h}
Chain ID: ${t}${o?`
Nonce: ${o}`:""}
Issued At: ${i.toISOString()}`;if(s&&(b+=`
Expiration Time: ${s.toISOString()}`),a&&(b+=`
Not Before: ${a.toISOString()}`),l&&(b+=`
Request ID: ${l}`),c){let v=`
Resources:`;for(const w of c){if(!w||typeof w!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${w}`);v+=`
- ${w}`}b+=v}return`${y}
${b}`}class ue extends Error{constructor({message:e,code:t,cause:r,name:s}){var i;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(i=s??(r instanceof Error?r.name:void 0))!==null&&i!==void 0?i:"Unknown Error",this.code=t}}class zs extends ue{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function Qg({error:n,options:e}){var t,r,s;const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ue({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else if(n.name==="ConstraintError"){if(((t=i.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new ue({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:n});if(e.mediation==="conditional"&&((r=i.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new ue({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:n});if(((s=i.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new ue({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:n})}else{if(n.name==="InvalidStateError")return new ue({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:n});if(n.name==="NotAllowedError")return new ue({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="NotSupportedError")return i.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new ue({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:n}):new ue({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:n});if(n.name==="SecurityError"){const o=window.location.hostname;if(yd(o)){if(i.rp.id!==o)return new ue({message:`The RP ID "${i.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new ue({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="TypeError"){if(i.user.id.byteLength<1||i.user.id.byteLength>64)return new ue({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:n})}else if(n.name==="UnknownError")return new ue({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new ue({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}function Zg({error:n,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new ue({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else{if(n.name==="NotAllowedError")return new ue({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="SecurityError"){const r=window.location.hostname;if(yd(r)){if(t.rpId!==r)return new ue({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new ue({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="UnknownError")return new ue({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new ue({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}class ey{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const ty=new ey;function ny(n){if(!n)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(n);const{challenge:e,user:t,excludeCredentials:r}=n,s=zi(n,["challenge","user","excludeCredentials"]),i=er(e).buffer,o=Object.assign(Object.assign({},t),{id:er(t.id).buffer}),a=Object.assign(Object.assign({},s),{challenge:i,user:o});if(r&&r.length>0){a.excludeCredentials=new Array(r.length);for(let l=0;l<r.length;l++){const c=r[l];a.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:er(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return a}function ry(n){if(!n)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(n);const{challenge:e,allowCredentials:t}=n,r=zi(n,["challenge","allowCredentials"]),s=er(e).buffer,i=Object.assign(Object.assign({},r),{challenge:s});if(t&&t.length>0){i.allowCredentials=new Array(t.length);for(let o=0;o<t.length;o++){const a=t[o];i.allowCredentials[o]=Object.assign(Object.assign({},a),{id:er(a.id).buffer,type:a.type||"public-key",transports:a.transports})}}return i}function sy(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n;return{id:n.id,rawId:n.id,response:{attestationObject:mn(new Uint8Array(n.response.attestationObject)),clientDataJSON:mn(new Uint8Array(n.response.clientDataJSON))},type:"public-key",clientExtensionResults:n.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function iy(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n,r=n.getClientExtensionResults(),s=n.response;return{id:n.id,rawId:n.id,response:{authenticatorData:mn(new Uint8Array(s.authenticatorData)),clientDataJSON:mn(new Uint8Array(s.clientDataJSON)),signature:mn(new Uint8Array(s.signature)),userHandle:s.userHandle?mn(new Uint8Array(s.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function yd(n){return n==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(n)}function wc(){var n,e;return!!(Se()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((n=navigator?.credentials)===null||n===void 0?void 0:n.create)=="function"&&typeof((e=navigator?.credentials)===null||e===void 0?void 0:e.get)=="function")}async function oy(n){try{const e=await navigator.credentials.create(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new zs("Browser returned unexpected credential type",e)}:{data:null,error:new zs("Empty credential response",e)}}catch(e){return{data:null,error:Qg({error:e,options:n})}}}async function ay(n){try{const e=await navigator.credentials.get(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new zs("Browser returned unexpected credential type",e)}:{data:null,error:new zs("Empty credential response",e)}}catch(e){return{data:null,error:Zg({error:e,options:n})}}}const ly={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},cy={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Fs(...n){const e=s=>s!==null&&typeof s=="object"&&!Array.isArray(s),t=s=>s instanceof ArrayBuffer||ArrayBuffer.isView(s),r={};for(const s of n)if(s)for(const i in s){const o=s[i];if(o!==void 0)if(Array.isArray(o))r[i]=o;else if(t(o))r[i]=o;else if(e(o)){const a=r[i];e(a)?r[i]=Fs(a,o):r[i]=Fs(o)}else r[i]=o}return r}function uy(n,e){return Fs(ly,n,e||{})}function dy(n,e){return Fs(cy,n,e||{})}class hy{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:r,signal:s},i){try{const{data:o,error:a}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!o)return{data:null,error:a};const l=s??ty.createNewAbortSignal();if(o.webauthn.type==="create"){const{user:c}=o.webauthn.credential_options.publicKey;c.name||(c.name=`${c.id}:${r}`),c.displayName||(c.displayName=c.name)}switch(o.webauthn.type){case"create":{const c=uy(o.webauthn.credential_options.publicKey,i?.create),{data:u,error:d}=await oy({publicKey:c,signal:l});return u?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:d}}case"request":{const c=dy(o.webauthn.credential_options.publicKey,i?.request),{data:u,error:d}=await ay(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:c,signal:l}));return u?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:d}}}}catch(o){return O(o)?{data:null,error:o}:{data:null,error:new fn("Unexpected error in challenge",o)}}}async _verify({challengeId:e,factorId:t,webauthn:r}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},i){if(!t)return{data:null,error:new Ur("rpId is required for WebAuthn authentication")};try{if(!wc())return{data:null,error:new fn("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:r},signal:s},{request:i});if(!o)return{data:null,error:a};const{webauthn:l}=o;return this._verify({factorId:e,challengeId:o.challengeId,webauthn:{type:l.type,rpId:t,rpOrigins:r,credential_response:l.credential_response}})}catch(o){return O(o)?{data:null,error:o}:{data:null,error:new fn("Unexpected error in authenticate",o)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},i){if(!t)return{data:null,error:new Ur("rpId is required for WebAuthn registration")};try{if(!wc())return{data:null,error:new fn("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this._enroll({friendlyName:e});if(!o)return await this.client.mfa.listFactors().then(u=>{var d;return(d=u.data)===null||d===void 0?void 0:d.all.find(h=>h.factor_type==="webauthn"&&h.friendly_name===e&&h.status!=="unverified")}).then(u=>u?this.client.mfa.unenroll({factorId:u?.id}):void 0),{data:null,error:a};const{data:l,error:c}=await this._challenge({factorId:o.id,friendlyName:o.friendly_name,webauthn:{rpId:t,rpOrigins:r},signal:s},{create:i});return l?this._verify({factorId:o.id,challengeId:l.challengeId,webauthn:{rpId:t,rpOrigins:r,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(o){return O(o)?{data:null,error:o}:{data:null,error:new fn("Unexpected error in register",o)}}}}Jg();const fy={url:lg,storageKey:cg,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:ug,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function vc(n,e,t){return await t()}const zn={};class Hr{get jwks(){var e,t;return(t=(e=zn[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){zn[this.storageKey]=Object.assign(Object.assign({},zn[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=zn[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){zn[this.storageKey]=Object.assign(Object.assign({},zn[this.storageKey]),{cachedAt:e})}constructor(e){var t,r,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const i=Object.assign(Object.assign({},fy),e);if(this.storageKey=i.storageKey,this.instanceID=(t=Hr.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,Hr.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.instanceID>0&&Se()){const o=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(o),this.logDebugMessages&&console.trace(o)}if(this.persistSession=i.persistSession,this.autoRefreshToken=i.autoRefreshToken,this.admin=new qg({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=pd(i.fetch),this.lock=i.lock||vc,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,this.throwOnError=i.throwOnError,this.lockAcquireTimeout=i.lockAcquireTimeout,i.lock?this.lock=i.lock:this.persistSession&&Se()&&(!((r=globalThis?.navigator)===null||r===void 0)&&r.locks)?this.lock=Kg:this.lock=vc,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new hy(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(i.storage?this.storage=i.storage:fd()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=bc(this.memoryStorage)),i.userStorage&&(this.userStorage=i.userStorage)):(this.memoryStorage={},this.storage=bc(this.memoryStorage)),Se()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o),await this._notifyAllSubscribers(o.data.event,o.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${ud}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},r="none";if(Se()&&(t=Tg(window.location.href),this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce")),Se()&&this.detectSessionInUrl&&r!=="none"){const{data:s,error:i}=await this._getSessionFromURL(t,r);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),gg(i)){const l=(e=i.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:i}}return{error:i}}const{session:o,redirectType:a}=s;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return O(t)?this._returnResult({error:t}):this._returnResult({error:new fn("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,s;try{const i=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(s=e?.options)===null||s===void 0?void 0:s.captchaToken}},xform:Ye}),{data:o,error:a}=i;if(a||!o)return this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(O(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signUp(e){var t,r,s;try{let i;if("email"in e){const{email:u,password:d,options:h}=e;let f=null,m=null;this.flowType==="pkce"&&([f,m]=await jn(this.storage,this.storageKey)),i=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:h?.emailRedirectTo,body:{email:u,password:d,data:(t=h?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:h?.captchaToken},code_challenge:f,code_challenge_method:m},xform:Ye})}else if("phone"in e){const{phone:u,password:d,options:h}=e;i=await $(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:u,password:d,data:(r=h?.data)!==null&&r!==void 0?r:{},channel:(s=h?.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:h?.captchaToken}},xform:Ye})}else throw new gs("You must provide either an email or phone number and a password");const{data:o,error:a}=i;if(a||!o)return await ke(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:o,options:a}=e;t=await $(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:gc})}else if("phone"in e){const{phone:i,password:o,options:a}=e;t=await $(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:gc})}else throw new gs("You must provide either an email or phone number and a password");const{data:r,error:s}=t;if(s)return this._returnResult({data:{user:null,session:null},error:s});if(!r||!r.session||!r.user){const i=new Dn;return this._returnResult({data:{user:null,session:null},error:i})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:s})}catch(t){if(O(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,r,s,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,r,s,i,o,a,l,c,u,d,h;let f,m;if("message"in e)f=e.message,m=e.signature;else{const{chain:g,wallet:y,statement:b,options:v}=e;let w;if(Se())if(typeof y=="object")w=y;else{const R=window;if("ethereum"in R&&typeof R.ethereum=="object"&&"request"in R.ethereum&&typeof R.ethereum.request=="function")w=R.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof y!="object"||!v?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");w=y}const k=new URL((t=v?.url)!==null&&t!==void 0?t:window.location.href),T=await w.request({method:"eth_requestAccounts"}).then(R=>R).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!T||T.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const S=gd(T[0]);let x=(r=v?.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!x){const R=await w.request({method:"eth_chainId"});x=Gg(R)}const C={domain:k.host,address:S,statement:b,uri:k.href,version:"1",chainId:x,nonce:(s=v?.signInWithEthereum)===null||s===void 0?void 0:s.nonce,issuedAt:(o=(i=v?.signInWithEthereum)===null||i===void 0?void 0:i.issuedAt)!==null&&o!==void 0?o:new Date,expirationTime:(a=v?.signInWithEthereum)===null||a===void 0?void 0:a.expirationTime,notBefore:(l=v?.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=v?.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(u=v?.signInWithEthereum)===null||u===void 0?void 0:u.resources};f=Xg(C),m=await w.request({method:"personal_sign",params:[Yg(f),S]})}try{const{data:g,error:y}=await $(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:f,signature:m},!((d=e.options)===null||d===void 0)&&d.captchaToken?{gotrue_meta_security:{captcha_token:(h=e.options)===null||h===void 0?void 0:h.captchaToken}}:null),xform:Ye});if(y)throw y;if(!g||!g.session||!g.user){const b=new Dn;return this._returnResult({data:{user:null,session:null},error:b})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:y})}catch(g){if(O(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async signInWithSolana(e){var t,r,s,i,o,a,l,c,u,d,h,f;let m,g;if("message"in e)m=e.message,g=e.signature;else{const{chain:y,wallet:b,statement:v,options:w}=e;let k;if(Se())if(typeof b=="object")k=b;else{const S=window;if("solana"in S&&typeof S.solana=="object"&&("signIn"in S.solana&&typeof S.solana.signIn=="function"||"signMessage"in S.solana&&typeof S.solana.signMessage=="function"))k=S.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof b!="object"||!w?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");k=b}const T=new URL((t=w?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in k&&k.signIn){const S=await k.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},w?.signInWithSolana),{version:"1",domain:T.host,uri:T.href}),v?{statement:v}:null));let x;if(Array.isArray(S)&&S[0]&&typeof S[0]=="object")x=S[0];else if(S&&typeof S=="object"&&"signedMessage"in S&&"signature"in S)x=S;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in x&&"signature"in x&&(typeof x.signedMessage=="string"||x.signedMessage instanceof Uint8Array)&&x.signature instanceof Uint8Array)m=typeof x.signedMessage=="string"?x.signedMessage:new TextDecoder().decode(x.signedMessage),g=x.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in k)||typeof k.signMessage!="function"||!("publicKey"in k)||typeof k!="object"||!k.publicKey||!("toBase58"in k.publicKey)||typeof k.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");m=[`${T.host} wants you to sign in with your Solana account:`,k.publicKey.toBase58(),...v?["",v,""]:[""],"Version: 1",`URI: ${T.href}`,`Issued At: ${(s=(r=w?.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&s!==void 0?s:new Date().toISOString()}`,...!((i=w?.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${w.signInWithSolana.notBefore}`]:[],...!((o=w?.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${w.signInWithSolana.expirationTime}`]:[],...!((a=w?.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${w.signInWithSolana.chainId}`]:[],...!((l=w?.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${w.signInWithSolana.nonce}`]:[],...!((c=w?.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${w.signInWithSolana.requestId}`]:[],...!((d=(u=w?.signInWithSolana)===null||u===void 0?void 0:u.resources)===null||d===void 0)&&d.length?["Resources",...w.signInWithSolana.resources.map(x=>`- ${x}`)]:[]].join(`
`);const S=await k.signMessage(new TextEncoder().encode(m),"utf8");if(!S||!(S instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=S}}try{const{data:y,error:b}=await $(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:m,signature:mn(g)},!((h=e.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(f=e.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:Ye});if(b)throw b;if(!y||!y.session||!y.user){const v=new Dn;return this._returnResult({data:{user:null,session:null},error:v})}return y.session&&(await this._saveSession(y.session),await this._notifyAllSubscribers("SIGNED_IN",y.session)),this._returnResult({data:Object.assign({},y),error:b})}catch(y){if(O(y))return this._returnResult({data:{user:null,session:null},error:y});throw y}}async _exchangeCodeForSession(e){const t=await an(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(t??"").split("/");try{if(!r&&this.flowType==="pkce")throw new yg;const{data:i,error:o}=await $(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:Ye});if(await ke(this.storage,`${this.storageKey}-code-verifier`),o)throw o;if(!i||!i.session||!i.user){const a=new Dn;return this._returnResult({data:{user:null,session:null,redirectType:null},error:a})}return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),this._returnResult({data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:o})}catch(i){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(i))return this._returnResult({data:{user:null,session:null,redirectType:null},error:i});throw i}}async signInWithIdToken(e){try{const{options:t,provider:r,token:s,access_token:i,nonce:o}=e,a=await $(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:Ye}),{data:l,error:c}=a;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const u=new Dn;return this._returnResult({data:{user:null,session:null},error:u})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(t){if(O(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,r,s,i,o;try{if("email"in e){const{email:a,options:l}=e;let c=null,u=null;this.flowType==="pkce"&&([c,u]=await jn(this.storage,this.storageKey));const{error:d}=await $(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l?.data)!==null&&t!==void 0?t:{},create_user:(r=l?.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},code_challenge:c,code_challenge_method:u},redirectTo:l?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:d})}if("phone"in e){const{phone:a,options:l}=e,{data:c,error:u}=await $(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(s=l?.data)!==null&&s!==void 0?s:{},create_user:(i=l?.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},channel:(o=l?.channel)!==null&&o!==void 0?o:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c?.message_id},error:u})}throw new gs("You must provide either an email or phone number.")}catch(a){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async verifyOtp(e){var t,r;try{let s,i;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:o,error:a}=await $(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:Ye});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");const l=o.session,c=o.user;return l?.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(s){if(O(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithSSO(e){var t,r,s,i,o;try{let a=null,l=null;this.flowType==="pkce"&&([a,l]=await jn(this.storage,this.storageKey));const c=await $(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=e?.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:l}),headers:this.headers,xform:Ug});return!((i=c.data)===null||i===void 0)&&i.url&&Se()&&!(!((o=e.options)===null||o===void 0)&&o.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(a){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new De;const{error:s}=await $(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:s})})}catch(e){if(O(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:s,options:i}=e,{error:o}=await $(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}},redirectTo:i?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:o})}else if("phone"in e){const{phone:r,type:s,options:i}=e,{data:o,error:a}=await $(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:o?.message_id},error:a})}throw new gs("You must provide either an email or phone number and a type")}catch(t){if(O(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await an(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<bo:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const o=await an(this.userStorage,this.storageKey+"-user");o?.user?e.user=o.user:e.user=ko()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const o={value:this.suppressGetSessionWarning};e.user=Lg(e.user,o),o.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{session:null},error:i}):this._returnResult({data:{session:s},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const t=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return t.data.user&&(this.suppressGetSessionWarning=!0),t}async _getUser(e){try{return e?await $(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:zt}):await this._useSession(async t=>{var r,s,i;const{data:o,error:a}=t;if(a)throw a;return!(!((r=o.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new De}:await $(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(s=o.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0,xform:zt})})}catch(t){if(O(t))return mg(t)&&(await this._removeSession(),await ke(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:s,error:i}=r;if(i)throw i;if(!s.session)throw new De;const o=s.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await jn(this.storage,this.storageKey));const{data:c,error:u}=await $(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:o.access_token,xform:zt});if(u)throw u;return o.user=c.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),this._returnResult({data:{user:o.user},error:null})})}catch(r){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new De;const t=Date.now()/1e3;let r=t,s=!0,i=null;const{payload:o}=vo(e.access_token);if(o.exp&&(r=o.exp,s=r<=t),s){const{data:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return this._returnResult({data:{user:i.user,session:i},error:null})}catch(t){if(O(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:o,error:a}=t;if(a)throw a;e=(r=o.session)!==null&&r!==void 0?r:void 0}if(!e?.refresh_token)throw new De;const{data:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{user:null,session:null},error:i}):s?this._returnResult({data:{user:s.user,session:s},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(O(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!Se())throw new ys("No browser detected.");if(e.error||e.error_description||e.error_code)throw new ys(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new cc("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new ys("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new cc("No code detected.");const{data:v,error:w}=await this._exchangeCodeForSession(e.code);if(w)throw w;const k=new URL(window.location.href);return k.searchParams.delete("code"),window.history.replaceState(window.history.state,"",k.toString()),{data:{session:v.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:s,access_token:i,refresh_token:o,expires_in:a,expires_at:l,token_type:c}=e;if(!i||!a||!o||!c)throw new ys("No session defined in URL");const u=Math.round(Date.now()/1e3),d=parseInt(a);let h=u+d;l&&(h=parseInt(l));const f=h-u;f*1e3<=Vn&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${d}s`);const m=h-d;u-m>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",m,h,u):u-m<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",m,h,u);const{data:g,error:y}=await this._getUser(i);if(y)throw y;const b={provider_token:r,provider_refresh_token:s,access_token:i,expires_in:d,expires_at:h,refresh_token:o,token_type:c,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:b,redirectType:e.type},error:null})}catch(r){if(O(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await an(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return this._returnResult({error:i});const o=(r=s.session)===null||r===void 0?void 0:r.access_token;if(o){const{error:a}=await this.admin.signOut(o,e);if(a&&!(pg(a)&&(a.status===404||a.status===401||a.status===403)))return this._returnResult({error:a})}return e!=="others"&&(await this._removeSession(),await ke(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=xg(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,s;try{const{data:{session:i},error:o}=t;if(o)throw o;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let r=null,s=null;this.flowType==="pkce"&&([r,s]=await jn(this.storage,this.storageKey,!0));try{return await $(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(i))return this._returnResult({data:null,error:i});throw i}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:r,error:s}=await this._useSession(async i=>{var o,a,l,c,u;const{data:d,error:h}=i;if(h)throw h;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await $(this.fetch,"GET",f,{headers:this.headers,jwt:(u=(c=d.session)===null||c===void 0?void 0:c.access_token)!==null&&u!==void 0?u:void 0})});if(s)throw s;return Se()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r?.url),this._returnResult({data:{provider:e.provider,url:r?.url},error:null})}catch(r){if(O(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var r;try{const{error:s,data:{session:i}}=t;if(s)throw s;const{options:o,provider:a,token:l,access_token:c,nonce:u}=e,d=await $(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=i?.access_token)!==null&&r!==void 0?r:void 0,body:{provider:a,id_token:l,access_token:c,nonce:u,link_identity:!0,gotrue_meta_security:{captcha_token:o?.captchaToken}},xform:Ye}),{data:h,error:f}=d;return f?this._returnResult({data:{user:null,session:null},error:f}):!h||!h.session||!h.user?this._returnResult({data:{user:null,session:null},error:new Dn}):(h.session&&(await this._saveSession(h.session),await this._notifyAllSubscribers("USER_UPDATED",h.session)),this._returnResult({data:h,error:f}))}catch(s){if(await ke(this.storage,`${this.storageKey}-code-verifier`),O(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:o}=t;if(o)throw o;return await $(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await Ag(async s=>(s>0&&await Cg(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await $(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Ye})),(s,i)=>{const o=200*Math.pow(2,s);return i&&wo(i)&&Date.now()+o-r<Vn})}catch(r){if(this._debug(t,"error",r),O(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),Se()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const s=await an(this.storage,this.storageKey);if(s&&this.userStorage){let o=await an(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!o&&(o={user:s.user},await qn(this.userStorage,this.storageKey+"-user",o)),s.user=(e=o?.user)!==null&&e!==void 0?e:ko()}else if(s&&!s.user&&!s.user){const o=await an(this.storage,this.storageKey+"-user");o&&o?.user?(s.user=o.user,await ke(this.storage,this.storageKey+"-user"),await qn(this.storage,this.storageKey,s)):s.user=ko()}if(this._debug(r,"session from storage",s),!this._isValidSession(s)){this._debug(r,"session is not valid"),s!==null&&await this._removeSession();return}const i=((t=s.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<bo;if(this._debug(r,`session has${i?"":" not"} expired with margin of ${bo}s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:o}=await this._callRefreshToken(s.refresh_token);o&&(console.error(o),wo(o)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else if(s.user&&s.user.__isUserNotAvailableProxy===!0)try{const{data:o,error:a}=await this._getUser(s.access_token);!a&&o?.user?(s.user=o.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(o){console.error("Error getting user data:",o),this._debug(r,"error getting user data, skipping SIGNED_IN notification",o)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(r,"error",s),console.error(s);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new De;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new Ui;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new De;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={data:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(s,"error",i),O(i)){const o={data:null,error:i};return wo(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,r=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){i.push(l)}});if(await Promise.all(o),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await ke(this.storage,`${this.storageKey}-code-verifier`);const t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await qn(this.userStorage,this.storageKey+"-user",{user:t.user});const s=Object.assign({},t);delete s.user;const i=pc(s);await qn(this.storage,this.storageKey,i)}else{const s=pc(t);await qn(this.storage,this.storageKey,s)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await ke(this.storage,this.storageKey),await ke(this.storage,this.storageKey+"-code-verifier"),await ke(this.storage,this.storageKey+"-user"),this.userStorage&&await ke(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Se()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Vn);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const t=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const t=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,t&&clearTimeout(t)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-e)/Vn);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${Vn}ms, refresh threshold is ${la} ticks`),s<=la&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof md)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Se()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const s=[`provider=${encodeURIComponent(t)}`];if(r?.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r?.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[i,o]=await jn(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});s.push(a.toString())}if(r?.queryParams){const i=new URLSearchParams(r.queryParams);s.push(i.toString())}return r?.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?this._returnResult({data:null,error:i}):await $(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:o}=t;if(o)return this._returnResult({data:null,error:o});const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:l,error:c}=await $(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(r=i?.session)===null||r===void 0?void 0:r.access_token});return c?this._returnResult({data:null,error:c}):(e.factorType==="totp"&&l.type==="totp"&&(!((s=l?.totp)===null||s===void 0)&&s.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?sy(e.webauthn.credential_response):iy(e.webauthn.credential_response)})}:{code:e.code}),{data:a,error:l}=await $(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:o,headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),this._returnResult({data:a,error:l}))})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=await $(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});if(o.error)return o;const{data:a}=o;if(a.type!=="webauthn")return{data:a,error:null};switch(a.webauthn.type){case"create":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:ny(a.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:ry(a.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:r}=await this.getUser();if(r)return{data:null,error:r};const s={all:[],phone:[],totp:[],webauthn:[]};for(const i of(e=t?.factors)!==null&&e!==void 0?e:[])s.all.push(i),i.status==="verified"&&s[i.factor_type].push(i);return{data:s,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:r},error:s}=await this.getSession();if(s)return this._returnResult({data:null,error:s});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:i}=vo(r.access_token);let o=null;i.aal&&(o=i.aal);let a=o;((t=(e=r.user.factors)===null||e===void 0?void 0:e.filter(u=>u.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(a="aal2");const c=i.amr||[];return{data:{currentLevel:o,nextLevel:a,currentAuthenticationMethods:c},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?await $(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new De})})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:s},error:i}=r;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new De});const o=await $(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"approve"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&Se()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(r){if(O(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:s},error:i}=r;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new De});const o=await $(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"deny"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&Se()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(r){if(O(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;return r?this._returnResult({data:null,error:r}):t?await $(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:s=>({data:s,error:null})}):this._returnResult({data:null,error:new De})})}catch(e){if(O(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?(await $(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new De})})}catch(t){if(O(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(a=>a.kid===e);if(r)return r;const s=Date.now();if(r=this.jwks.keys.find(a=>a.kid===e),r&&this.jwks_cached_at+hg>s)return r;const{data:i,error:o}=await $(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return!i.keys||i.keys.length===0||(this.jwks=i,this.jwks_cached_at=s,r=i.keys.find(a=>a.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){const{data:f,error:m}=await this.getSession();if(m||!f.session)return this._returnResult({data:null,error:m});r=f.session.access_token}const{header:s,payload:i,signature:o,raw:{header:a,payload:l}}=vo(r);t?.allowExpired||$g(i.exp);const c=!s.alg||s.alg.startsWith("HS")||!s.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(s.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!c){const{error:f}=await this.getUser(r);if(f)throw f;return{data:{claims:i,header:s,signature:o},error:null}}const u=Dg(s.alg),d=await crypto.subtle.importKey("jwk",c,u,!0,["verify"]);if(!await crypto.subtle.verify(u,d,o,Sg(`${a}.${l}`)))throw new da("Invalid JWT signature");return{data:{claims:i,header:s,signature:o},error:null}}catch(r){if(O(r))return this._returnResult({data:null,error:r});throw r}}}Hr.nextInstanceID={};const py=Hr,my="2.90.1";let vr="";typeof Deno<"u"?vr="deno":typeof document<"u"?vr="web":typeof navigator<"u"&&navigator.product==="ReactNative"?vr="react-native":vr="node";const gy={"X-Client-Info":`supabase-js-${vr}/${my}`},yy={headers:gy},by={schema:"public"},wy={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},vy={};function Vr(n){"@babel/helpers - typeof";return Vr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Vr(n)}function ky(n,e){if(Vr(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(Vr(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Sy(n){var e=ky(n,"string");return Vr(e)=="symbol"?e:e+""}function _y(n,e,t){return(e=Sy(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function kc(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,r)}return t}function oe(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kc(Object(t),!0).forEach(function(r){_y(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):kc(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const xy=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Ty=()=>Headers,Ey=(n,e,t)=>{const r=xy(t),s=Ty();return async(i,o)=>{var a;const l=(a=await e())!==null&&a!==void 0?a:n;let c=new s(o?.headers);return c.has("apikey")||c.set("apikey",n),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),r(i,oe(oe({},o),{},{headers:c}))}};function Cy(n){return n.endsWith("/")?n:n+"/"}function Ay(n,e){var t,r;const{db:s,auth:i,realtime:o,global:a}=n,{db:l,auth:c,realtime:u,global:d}=e,h={db:oe(oe({},l),s),auth:oe(oe({},c),i),realtime:oe(oe({},u),o),storage:{},global:oe(oe(oe({},d),a),{},{headers:oe(oe({},(t=d?.headers)!==null&&t!==void 0?t:{}),(r=a?.headers)!==null&&r!==void 0?r:{})}),accessToken:async()=>""};return n.accessToken?h.accessToken=n.accessToken:delete h.accessToken,h}function Oy(n){const e=n?.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Cy(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var My=class extends py{constructor(n){super(n)}},Iy=class{constructor(n,e,t){var r,s;this.supabaseUrl=n,this.supabaseKey=e;const i=Oy(n);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",i),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",i),this.storageUrl=new URL("storage/v1",i),this.functionsUrl=new URL("functions/v1",i);const o=`sb-${i.hostname.split(".")[0]}-auth-token`,a={db:by,realtime:vy,auth:oe(oe({},wy),{},{storageKey:o}),global:yy},l=Ay(t??{},a);if(this.storageKey=(r=l.auth.storageKey)!==null&&r!==void 0?r:"",this.headers=(s=l.global.headers)!==null&&s!==void 0?s:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(u,d)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(d)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=Ey(e,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(oe({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&this.accessToken().then(u=>this.realtime.setAuth(u)).catch(u=>console.warn("Failed to set initial Realtime auth token:",u)),this.rest=new um(new URL("rest/v1",i).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch}),this.storage=new ag(this.storageUrl.href,this.headers,this.fetch,t?.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new im(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(n){return this.rest.from(n)}schema(n){return this.rest.schema(n)}rpc(n,e={},t={head:!1,get:!1,count:void 0}){return this.rest.rpc(n,e,t)}channel(n,e={config:{}}){return this.realtime.channel(n,e)}getChannels(){return this.realtime.getChannels()}removeChannel(n){return this.realtime.removeChannel(n)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var n=this,e,t;if(n.accessToken)return await n.accessToken();const{data:r}=await n.auth.getSession();return(e=(t=r.session)===null||t===void 0?void 0:t.access_token)!==null&&e!==void 0?e:n.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:s,storageKey:i,flowType:o,lock:a,debug:l,throwOnError:c},u,d){const h={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new My({url:this.authUrl.href,headers:oe(oe({},h),u),storageKey:i,autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:s,flowType:o,lock:a,debug:l,throwOnError:c,fetch:d,hasCustomAuthorizationHeader:Object.keys(this.headers).some(f=>f.toLowerCase()==="authorization")})}_initRealtimeClient(n){return new Cm(this.realtimeUrl.href,oe(oe({},n),{},{params:oe(oe({},{apikey:this.supabaseKey}),n?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((n,e)=>{this._handleTokenChanged(n,"CLIENT",e?.access_token)})}_handleTokenChanged(n,e,t){(n==="TOKEN_REFRESHED"||n==="SIGNED_IN")&&this.changedAccessToken!==t?(this.changedAccessToken=t,this.realtime.setAuth(t)):n==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const Ny=(n,e,t)=>new Iy(n,e,t);function Ry(){if(typeof window<"u")return!1;const n=globalThis.process;if(!n)return!1;const e=n.version;if(e==null)return!1;const t=e.match(/^v(\d+)\./);return t?parseInt(t[1],10)<=18:!1}Ry()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Sc={SUPABASE_URL:"https://bwmbsjbbyleqjxcxujxo.supabase.co",SUPABASE_ANON_KEY:"sb_publishable_iHVkoe07I55N3QWUeN3ZTQ_TbvT1eyc"},ce=Ny(Sc.SUPABASE_URL,Sc.SUPABASE_ANON_KEY,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}});async function Py(n,e){try{const{error:t}=await ce.auth.signUp({email:n,password:e});return t?{ok:!1,errorMessage:t.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function $y(n,e){try{const{error:t}=await ce.auth.signInWithPassword({email:n,password:e});return t?{ok:!1,errorMessage:t.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function _c(){try{const{error:n}=await ce.auth.signOut();return n?{ok:!1,errorMessage:n.message}:{ok:!0}}catch(n){return{ok:!1,errorMessage:n.message}}}async function Dy(){try{const{data:n,error:e}=await ce.auth.getUser();return e?{ok:!1,errorMessage:e.message}:{ok:!0,user:n.user??null}}catch(n){return{ok:!1,errorMessage:n.message}}}async function jy(){const n=window.location.hash||"#/home",e=await Dy();if(!e.ok)return{page:"login",props:{message:e.errorMessage}};if(e.user===null)return n!=="#login"&&n!=="#/login"&&(window.location.hash="#login"),{page:"login",props:{message:"Veuillez vous connecter."}};if(n==="#login"||n==="#/login"||n==="#app")return window.location.hash="#/home",{page:"home",props:{userEmail:e.user?.email??""}};if(n==="#/home")return{page:"home",props:{userEmail:e.user?.email??""}};if(n==="#/ideas")return window.location.hash="#/projects",{page:"projects",props:{userEmail:e.user?.email??""}};if(n==="#/projects")return{page:"projects",props:{userEmail:e.user?.email??""}};if(n.startsWith("#/project/")){const t=n.replace("#/project/","").split("/").filter(Boolean),r=t[0];if(!r)return window.location.hash="#/projects",{page:"projects",props:{userEmail:e.user?.email??""}};const s=t[1]??"write",i={write:"chapter",characters:"characters",ideas:"ideas",inspiration:"inspiration",mindmap:"mindmap",settings:"chapter"};return s in i||(window.location.hash=`#/project/${r}/write`),{page:"editor",props:{userEmail:e.user?.email??"",projectId:r,writingNav:i[s]??"chapter"}}}if(n.startsWith("#/editor/")){const t=n.replace("#/editor/","").trim();return t?(window.location.hash=`#/project/${t}/write`,{page:"editor",props:{userEmail:e.user?.email??"",projectId:t,writingNav:"chapter"}}):(window.location.hash="#/projects",{page:"projects",props:{userEmail:e.user?.email??""}})}return window.location.hash="#/home",{page:"home",props:{userEmail:e.user?.email??""}}}const Ly="/Plumeo/";function By({onSignIn:n,onSignUp:e,message:t=""}={}){return`
    <section class="page">
      <h1>Login</h1>
      <p>Connecte-toi pour acceder a l'app.</p>
      <form id="auth-form" class="form" autocomplete="on">
        <label class="field">
          <span>Email</span>
          <input class="input" id="email" type="email" required placeholder="email@exemple.com" />
        </label>
        <label class="field">
          <span>Mot de passe</span>
          <input class="input" id="password" type="password" required minlength="6" />
        </label>
        <div class="actions">
          <button class="btn btn-primary" id="sign-in" type="button">Se connecter</button>
          <button id="sign-up" class="btn btn-secondary" type="button">Creer un compte</button>
        </div>
      </form>
      <p id="message" class="message">${t}</p>
    </section>
  `}function Us(n){if(!n)return"";const e=new Date(n);return Number.isNaN(e.getTime())?n:e.toLocaleString()}function ha(n){if(!n)return"";const e=new Date(n);if(Number.isNaN(e.getTime()))return"";const t=e.toLocaleDateString("fr-FR",{day:"2-digit",month:"short"}),r=e.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});return`${t} ${r}`}function el({userEmail:n="",activeRoute:e="home",lastProjectId:t=null,lastCloudSaveAt:r=null,cloudStatus:s="",cloudBusy:i=!1,accountMenuOpen:o=!1,backupStatus:a="",backupMenuOpen:l=!1}={}){const c=e==="home"?" is-active":"",u=e==="projects"?" is-active":"",d=l?" is-active":"",h=o?" is-active":"",f=!!n,m=n?n.split("@")[0].slice(0,14):"Non connecte",g=n?n.trim().charAt(0).toUpperCase():"?",y=r?Us(new Date(r).toISOString()):"-",b=!f||i?"disabled":"",v=!f||i?"disabled":"",w=f?'<button class="btn btn-ghost topbar-popover-item" data-action="home-sign-out" type="button"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 4h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12H4m0 0l3-3m-3 3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Deconnexion</span></button>':"",k=a?`<p class="topbar-popover-meta"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 7v5l3 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">${a}</span></p>`:"",T=l?`
        <div class="topbar-popover" role="menu" aria-label="Backup">
          <button class="btn btn-ghost topbar-popover-item" data-action="home-backup-export" type="button"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v10m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 19h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></span><span class="topbar-popover-label">Exporter</span></button>
          <button class="btn btn-ghost topbar-popover-item" data-action="home-backup-import" type="button"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 19V9m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 5h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></span><span class="topbar-popover-label">Importer</span></button>
          <input id="home-backup-file" type="file" accept=".json" hidden />
          ${k}
        </div>
      `:"",S=o?`
        <div class="topbar-popover" role="menu" aria-label="Compte">
          <button class="btn btn-ghost topbar-popover-item" data-action="home-cloud-save" type="button" ${b}><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 18a4 4 0 0 1 .7-7.95A5.5 5.5 0 0 1 19 10a3.5 3.5 0 0 1 0 7H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 15V9m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Sauver cloud</span></button>
          <button class="btn btn-ghost topbar-popover-item" data-action="home-cloud-load" type="button" ${v}><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 18a4 4 0 0 1 .7-7.95A5.5 5.5 0 0 1 19 10a3.5 3.5 0 0 1 0 7H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9v6m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Charger cloud</span></button>
          <div class="topbar-popover-sep" role="presentation"></div>
          ${w}
          <p class="topbar-popover-meta"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 7v5l3 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Sauvegarde : ${y}</span></p>
        </div>
      `:"",x=s?`<span class="status topbar-cloud-status">${s}</span>`:"";return`
    <header class="topbar">
      <div class="topbar-inner layout-container">
        <div class="topbar-left">
          <h1>Plumeo</h1>
        </div>
        <div class="topbar-right">
          <div class="topbar-nav">
            <button data-action="nav-home" type="button" class="topbar-pill${c}">Accueil</button>
            <button data-action="nav-projects" type="button" class="topbar-pill${u}">Projets</button>
          </div>
          ${x}
          <div class="topbar-backup">
            <button
              class="topbar-pill${d}"
              type="button"
              data-action="backup-toggle"
              aria-haspopup="menu"
              aria-expanded="${l?"true":"false"}"
              title="Backup"
            >
              <span class="topbar-account-avatar">B</span>
              <span class="topbar-account-label">Backup</span>
            </button>
            ${T}
          </div>
          <div class="topbar-account">
            <button
              type="button"
              data-action="account-toggle"
              aria-haspopup="menu"
              aria-expanded="${o?"true":"false"}"
              class="topbar-pill${h}"
            >
              <span class="topbar-account-avatar">${g}</span>
              <span class="topbar-account-label">${m}</span>
            </button>
            ${S}
          </div>
        </div>
      </div>
    </header>
  `}function zy({userEmail:n="",projects:e=[],lastProjectId:t=null,lastChapterTitle:r=null,lastCloudSaveAt:s=null,cloudStatus:i="",cloudBusy:o=!1,backupStatus:a="",homeStats:l=null,homeMessage:c="",accountMenuOpen:u=!1,backupMenuOpen:d=!1}={}){e.length>0;const h=e.find(w=>w.id===t);h?.title,h&&`${h.id}`,s&&Us(new Date(s).toISOString());const f=l??{totalWords:null,wordsPerDay:null,pagesTotal:null,pagesPerDay:null,timeSpent:null,timePerDay:null,favoriteTime:null},m=(w,k)=>w==null?"--":k(w),g=m(f.totalWords,w=>`${w} mots`),y=m(f.wordsPerDay,w=>`${w} mots`),b=m(f.pagesTotal,w=>`${w}`),v=m(f.pagesPerDay,w=>`${w.toFixed(1)} pages`);return e.map(w=>{const k=w.id===t,T=k?"Actif":"En pause",S=k?" is-active":"",x=k?"En cours":"Brouillon",C=w.created_at?`Modifie le ${Us(w.created_at)}`:"A reprendre";return`
        <div class="project-card${k?" is-active":""}">
          <button class="project-card-main" data-action="home-project-open" data-id="${w.id}" type="button">
            <h3>${w.title}</h3>
            <div class="project-card-meta">
              <span class="project-card-status${S}">${T}</span>
              <span class="project-card-progress">${x}</span>
              <span class="project-card-info">${C}</span>
            </div>
          </button>
          <button class="project-card-delete danger-hover" data-action="home-project-delete" data-id="${w.id}" type="button" aria-label="Supprimer le projet" title="Supprimer">
            Supprimer
          </button>
        </div>
      `}).join(""),`
    <section class="page-shell home-shell">
      ${el({userEmail:n,activeRoute:"home",lastProjectId:t,lastCloudSaveAt:s,cloudStatus:i,cloudBusy:o,accountMenuOpen:u,backupStatus:a,backupMenuOpen:d})}
      <div class="page dashboard">
        <main class="home-landing layout-container">
          <section class="home-hero-split">
            <div class="home-hero-copy">
              <h1 class="home-hero-title-large">Bonjour, Louis</h1>
              <blockquote class="home-hero-quote">&Eacute;crire, c'est tenter de savoir ce qu'on &eacute;crirait si on &eacute;crivait</blockquote>
              <button
                class="home-hero-cta"
                data-action="home-project-continue"
                type="button"
              >
                Continuer a ecrire
              </button>
            </div>
            <div class="home-hero-art" aria-hidden="true"></div>
          </section>
          <section id="home-next" class="home-next" aria-hidden="true"></section>
          <section id="home-analysis" class="home-analysis">
            <div class="analysis-frame">
              <div class="analysis-frame-header">
                <h2 class="analysis-title">Analyse</h2>
              </div>
              <div class="analysis-frame-body">
                <div class="home-analysis-left">
                  <img
                    class="home-analysis-illustration"
                    src="${Ly}assets/illustrations/analysis.png"
                    alt="Illustration des statistiques d'ecriture"
                    loading="lazy"
                  />
                </div>
                <div class="home-analysis-right">
                  <section class="home-analysis-card">
                    <h3>Vos statistiques d'&eacute;criture</h3>
                    <div class="home-analysis-kpis">
                      <div class="home-analysis-kpi">
                        <span class="home-analysis-kpi-label">Temps pass&eacute; &agrave; &eacute;crire</span>
                        <span class="home-analysis-kpi-value">${f.timeSpent??"--"}</span>
                        <span class="home-analysis-kpi-meta">${f.timePerDay??"--"} / jour</span>
                      </div>
                      <div class="home-analysis-kpi">
                        <span class="home-analysis-kpi-label">Nombre total de mots</span>
                        <span class="home-analysis-kpi-value">${g??"--"}</span>
                        <span class="home-analysis-kpi-meta">${y??"--"} / jour</span>
                      </div>
                      <div class="home-analysis-kpi">
                        <span class="home-analysis-kpi-label">Nombre total de pages</span>
                        <span class="home-analysis-kpi-value">${b??"--"}</span>
                        <span class="home-analysis-kpi-meta">${v??"--"} / jour</span>
                      </div>
                    </div>
                  </section>
                  <section class="home-analysis-card home-analysis-insight">
                    <h3>Moment pr&eacute;f&eacute;r&eacute; pour &eacute;crire</h3>
                    <div class="home-analysis-insight-visual"></div>
                    <p class="home-analysis-insight-text">Moment pr&eacute;f&eacute;r&eacute; pour &eacute;crire : ${f.favoriteTime??"--"}</p>
                  </section>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </section>
  `}function Fy({ideas:n=[],selectedIdeaId:e=null,ideasQuery:t="",ideasTagFilter:r="",ideasStatusFilter:s="all",ideasSort:i="desc",ideasFiltersOpen:o=!1,ideasNoteExpanded:a=!1}={}){const l=n.find(y=>y.id===e)??null,c={raw:"Brute",used:"Exploitee",abandoned:"Abandonnee"},u=n.map(y=>{const b=y.content?.trim()||"Sans contenu",v=b.length>80?`${b.slice(0,77)}...`:b,w=ha(y.created_at),k=c[y.status]??"Brute",T=`<span class="ideas-item__status status-${y.status}">${k}</span>`,S=Array.isArray(y.tags)?y.tags.length:0,x=S===1?`tags: ${y.tags[0]}`:S>1?`tags: +${S}`:"",C=[w,T,x].filter(Boolean);return`
        <button type="button" class="ideas-item${y.id===e?" is-selected":""}" data-action="ideas-select" data-id="${y.id}">
          <span class="ideas-item__line1">${v}</span>
          <span class="ideas-item__meta">${C.join("  ")}</span>
        </button>
      `}).join(""),d=l?.note??"",h=!!d.trim(),f=a?"Masquer la note":h?"Afficher la note":"Ajouter une note",m=l?`
        <div class="ideas-detail-body">
          <textarea
            class="ideas-detail-input"
            rows="8"
            data-idea-field="content"
            data-id="${l.id}"
            placeholder="Ecris ton idee..."
          >${l.content??""}</textarea>
          <div class="ideas-detail-meta">
            <label class="ideas-meta-field">
              <span>Statut</span>
              <select class="input" data-idea-field="status" data-id="${l.id}">
                <option value="raw"${l.status==="raw"?" selected":""}>Brute</option>
                <option value="used"${l.status==="used"?" selected":""}>Exploitee</option>
                <option value="abandoned"${l.status==="abandoned"?" selected":""}>Abandonnee</option>
              </select>
            </label>
            <label class="ideas-meta-field">
              <span>Tags</span>
              <input class="input" type="text" value="${(l.tags??[]).join(", ")}" data-idea-field="tags" data-id="${l.id}" placeholder="tag1, tag2" />
            </label>
          </div>
          <div class="ideas-detail-note">
            <button type="button" class="btn btn-ghost ideas-note-toggle" data-action="ideas-note-toggle">
              ${f}
            </button>
            ${a?`<textarea class="input ideas-note-input" rows="3" data-idea-field="note" data-id="${l.id}" placeholder="Note">${d}</textarea>`:""}
          </div>
          <div class="ideas-detail-footer">
            <div class="ideas-detail-actions">
              <button type="button" class="btn btn-secondary" disabled>Associer a un projet</button>
              <button type="button" class="btn btn-secondary" disabled>Transformer en chapitre</button>
            </div>
            <button type="button" class="btn btn-danger ideas-delete danger-hover" data-action="ideas-delete" data-id="${l.id}">Supprimer</button>
          </div>
        </div>
      `:`
        <div class="ideas-detail-empty">
          <h3>Selectionne une idee</h3>
          <p>La idee apparaitra ici pour etre enrichie.</p>
        </div>
      `,g=o?`
        <div class="ideas-filters-panel" id="ideas-filters-panel">
          <label class="field">
            <span>Tag</span>
            <input id="ideas-tag-filter" class="input" type="text" placeholder="Tag" value="${r}" />
          </label>
          <label class="field">
            <span>Statut</span>
            <select id="ideas-status-filter" class="input">
              <option value="all"${s==="all"?" selected":""}>Tous</option>
              <option value="raw"${s==="raw"?" selected":""}>Brute</option>
              <option value="used"${s==="used"?" selected":""}>Exploitee</option>
              <option value="abandoned"${s==="abandoned"?" selected":""}>Abandonnee</option>
            </select>
          </label>
          <label class="field">
            <span>Tri</span>
            <select id="ideas-sort" class="input">
              <option value="desc"${i==="desc"?" selected":""}>Plus recentes</option>
              <option value="asc"${i==="asc"?" selected":""}>Plus anciennes</option>
            </select>
          </label>
        </div>
      `:"";return`
    <section class="ideas-create panel card">
      <h3>Ajouter une idee</h3>
      <textarea
        id="ideas-create-input"
        class="input ideas-create-input"
        rows="3"
        placeholder="Une phrase, une scene, un concept, une question..."
        aria-label="Ajouter une idee"
      ></textarea>
      <div class="ideas-create-hint"> Entree pour ajouter</div>
    </section>

    <section class="ideas-controls">
      <div class="ideas-controls-main">
        <input id="ideas-search" class="input" type="text" placeholder="Rechercher..." value="${t}" />
        <button
          type="button"
          class="btn btn-ghost ideas-filters-toggle"
          data-action="ideas-filters-toggle"
          aria-expanded="${o?"true":"false"}"
          aria-controls="ideas-filters-panel"
        >
          Filtres v
        </button>
      </div>
      ${g}
    </section>

    <div class="ideas-layout ideas-layout--master-detail">
      <div class="ideas-list">
        ${u||'<p class="ideas-empty">Ajoute une idee ci-dessus.</p>'}
      </div>
      <div class="ideas-detail">
        ${m}
      </div>
    </div>
  `}function Uy({userEmail:n="",projects:e=[],projectStats:t={},projectsMenuOpenId:r=null,editingProjectId:s=null,lastProjectId:i=null,lastCloudSaveAt:o=null,cloudStatus:a="",cloudBusy:l=!1,accountMenuOpen:c=!1,backupStatus:u="",backupMenuOpen:d=!1}={}){const h=e.length>0,f={active:"Actif",paused:"En pause",done:"Termine",archived:"Archive"},m=e.map(y=>{const b=t[y.id]??{},v=b.updatedAt?ha(b.updatedAt):y.created_at?ha(y.created_at):"",w=typeof b.chapterCount=="number"?b.chapterCount:"",k=typeof b.wordCount=="number"?b.wordCount:"",T=w===""?"":`${w} chapitre${w===1?"":"s"}`,S=k===""?"":`${k} mot${k===1?"":"s"}`,x=y.status??"active",C=f[x]??"Actif",R=y.id===i,X=R?'<span class="project-badge">Actif</span>':"",I=x!=="active"?`<span class="project-status status-${x}">${C}</span>`:"",pe=s===y.id?`
            <div class="project-title-edit">
              <input
                class="project-edit-input"
                data-action="projects-rename-input"
                data-id="${y.id}"
                type="text"
                value="${y.title??""}"
                placeholder="Sans titre"
                spellcheck="false"
              />
              <div class="project-title-actions">
                <button type="button" class="btn btn-secondary btn-compact" data-action="projects-rename-confirm" data-id="${y.id}">OK</button>
                <button type="button" class="btn btn-ghost btn-compact" data-action="projects-rename-cancel" data-id="${y.id}">Annuler</button>
              </div>
            </div>
            ${X}
            ${I}
          `:`
            <h3>${y.title??"Sans titre"}</h3>
            ${X}
            ${I}
          `,te=r===y.id,Z=te?`
            <div class="project-menu" role="menu" aria-label="Actions projet">
              <button type="button" class="project-menu-item" data-action="projects-rename" data-id="${y.id}">Renommer</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="active">Actif</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="paused">En pause</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="done">Termine</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="archived">Archive</button>
              <button type="button" class="project-menu-item danger-hover" data-action="projects-delete" data-id="${y.id}">Supprimer</button>
            </div>
          `:"";return`
        <article
          class="project-card project-card--projects${R?" is-active":""}"
          data-action="projects-open"
          data-id="${y.id}"
          role="button"
          tabindex="0"
        >
          <div class="project-card-main">
            <div class="project-card-title">
              ${pe}
            </div>
            <div class="project-card-meta">
              <span class="project-card-info">Derniere modification : ${v}  ${T}  ${S}</span>
            </div>
          </div>
          <div class="project-card-actions">
            <button class="project-menu-toggle" type="button" data-action="projects-menu-toggle" data-id="${y.id}" aria-haspopup="menu" aria-expanded="${te?"true":"false"}" aria-label="Menu projet"></button>
            ${Z}
          </div>
        </article>
      `}).join("");return`
    <section class="page projects-page">
      ${el({userEmail:n,activeRoute:"projects",lastProjectId:i,lastCloudSaveAt:o,cloudStatus:a,cloudBusy:l,accountMenuOpen:c,backupStatus:u,backupMenuOpen:d})}
      <main class="projects-content layout-container">
        <header class="projects-header">
          <h2>Projets</h2>
          <button class="btn btn-secondary" data-action="projects-create" type="button">+ Nouveau projet</button>
        </header>
        <section class="projects-grid">
          ${h?m:`
      <div class="projects-empty">
        <p>Aucun projet pour le moment.</p>
        <button class="btn btn-secondary" data-action="projects-create" type="button">+ Nouveau projet</button>
      </div>
    `}
        </section>
      </main>
    </section>
  `}function Hs(n){return String(n||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function bs(n){try{return new URL(n).hostname.replace(/^www\./,"")}catch{return n}}function xc(n=[]){if(!n.length)return"";const e=n.slice(0,2),t=n.length-e.length,r=e.map(i=>`<span class="inspiration-tag">${i}</span>`).join(""),s=t>0?`<span class="inspiration-tag">+${t}</span>`:"";return`<div class="inspiration-tags">${r}${s}</div>`}function Hy({projectTitle:n="-",inspirationItems:e=[],inspirationSearch:t="",inspirationTag:r="",inspirationModal:s=null,inspirationDetailId:i=null,chapters:o=[],characters:a=[]}={}){const l=Hs(t),c=e.filter(C=>{const R=[C.title,C.note,C.url,...C.tags??[]].map(H=>Hs(H)).join(" "),X=l?R.includes(l):!0,I=r?(C.tags??[]).includes(r):!0;return X&&I}),u=Array.from(new Set(e.flatMap(C=>C.tags??[]))),d=c.length?c.map(C=>{const R=C.type==="image",X=C.type==="video",I=R?`<img src="${C.image_data}" alt="" loading="lazy" />`:`<div class="inspiration-preview-icon">
                <span>${X?"Video":"Lien"}</span>
                <span class="inspiration-preview-domain">${bs(C.url)}</span>
              </div>`,H=C.title?.trim()||bs(C.url)||"Sans titre";return`
            <article class="inspiration-card" data-action="inspiration-open" data-id="${C.id}">
              <div class="inspiration-preview${R?" is-image":""}">
                ${I}
              </div>
              <div class="inspiration-card-body">
                <h4 class="inspiration-card-title">${H}</h4>
                ${xc(C.tags??[])}
                <div class="inspiration-card-actions">
                  <button type="button" class="btn btn-ghost" data-action="inspiration-edit" data-id="${C.id}">Modifier</button>
                  <button type="button" class="btn btn-ghost danger-hover" data-action="inspiration-delete" data-id="${C.id}">Supprimer</button>
                </div>
              </div>
            </article>
          `}).join(""):'<p class="muted">Aucune inspiration pour ce projet.</p>',h=e.length,f=`${h} inspiration${h>1?"s":""}`,m=s?.open,g=s?.step??"type",y=s?.type??"",b=s?.draft??{},v=s?.mode==="edit"?"Modifier":"Ajouter",w=b.image_data?`<div class="inspiration-preview is-image"><img src="${b.image_data}" alt="" /></div>`:"",k=g==="type"?`
          <div class="inspiration-modal-options">
            <button type="button" class="btn btn-secondary" data-action="inspiration-choose-type" data-type="image">Image</button>
            <button type="button" class="btn btn-secondary" data-action="inspiration-choose-type" data-type="link">Lien</button>
            <button type="button" class="btn btn-secondary" data-action="inspiration-choose-type" data-type="video">Video</button>
          </div>
        `:`
          <form class="inspiration-form">
            ${y==="image"?`<label class="field"><span>Image</span><input id="inspiration-image-input" type="file" accept="image/*" /></label>${w}`:""}
            ${y!=="image"?`<label class="field"><span>URL</span><input id="inspiration-url" class="input" type="url" value="${b.url??""}" placeholder="https://..." /></label>`:""}
            <label class="field"><span>Titre</span><input id="inspiration-title" class="input" type="text" value="${b.title??""}" placeholder="Titre (optionnel)" /></label>
            <label class="field"><span>Tags</span><input id="inspiration-tags" class="input" type="text" value="${(b.tags??[]).join(", ")}" placeholder="tag1, tag2" /></label>
            <label class="field"><span>Note</span><textarea id="inspiration-note" class="input" rows="3" placeholder="Note">${b.note??""}</textarea></label>
            <label class="field"><span>Lie a un chapitre</span>
              <select id="inspiration-link-chapter" class="input">
                <option value="">Aucun</option>
                ${o.map(C=>`<option value="${C.id}" ${b.linkedChapterId===C.id?"selected":""}>${C.title||"Sans titre"}</option>`).join("")}
              </select>
            </label>
            <label class="field"><span>Lie a un personnage</span>
              <select id="inspiration-link-character" class="input">
                <option value="">Aucun</option>
                ${a.map(C=>{const X=`${C.first_name??""} ${C.last_name??""}`.trim()||"Sans nom";return`<option value="${C.id}" ${b.linkedCharacterId===C.id?"selected":""}>${X}</option>`}).join("")}
              </select>
            </label>
          </form>
        `,T=m?`
        <div class="inspiration-modal-backdrop" role="dialog" aria-modal="true">
          <div class="inspiration-modal">
            <header class="inspiration-modal-header">
              <h3>${v}</h3>
            </header>
            <div class="inspiration-modal-body">
              ${k}
            </div>
            <footer class="inspiration-modal-actions">
              <button type="button" class="btn btn-ghost" data-action="inspiration-cancel">Annuler</button>
              ${g==="form"?'<button type="button" class="btn btn-primary" data-action="inspiration-save">Enregistrer</button>':""}
            </footer>
          </div>
        </div>
      `:"",S=e.find(C=>C.id===i),x=S?`
        <div class="inspiration-modal-backdrop" role="dialog" aria-modal="true">
          <div class="inspiration-modal">
            <header class="inspiration-modal-header">
              <h3>${S.title||bs(S.url)||"Sans titre"}</h3>
            </header>
            <div class="inspiration-modal-body">
              ${S.type==="image"?`<div class="inspiration-preview is-image"><img src="${S.image_data}" alt="" /></div>`:`<div class="inspiration-preview">${bs(S.url)}</div>`}
              ${S.note?`<p>${S.note}</p>`:""}
              ${xc(S.tags??[])}
            </div>
            <footer class="inspiration-modal-actions">
              <button type="button" class="btn btn-ghost" data-action="inspiration-close">Fermer</button>
              <button type="button" class="btn btn-secondary" data-action="inspiration-edit" data-id="${S.id}">Modifier</button>
              <button type="button" class="btn btn-danger danger-hover" data-action="inspiration-delete" data-id="${S.id}">Supprimer</button>
            </footer>
          </div>
        </div>
      `:"";return`
    <section class="panel inspiration-panel">
      <header class="inspiration-header">
        <div class="inspiration-header-main">
          <h2 class="inspiration-title">Inspiration  Projet : ${n}</h2>
          <span class="inspiration-count">${f}</span>
        </div>
        <div class="inspiration-actions">
          <button type="button" class="btn btn-primary inspiration-create" data-action="inspiration-add">+ Ajouter</button>
          <label class="inspiration-field" for="inspiration-search">
            <span>Rechercher</span>
            <input id="inspiration-search" class="input" type="text" placeholder="Rechercher..." value="${t}" />
          </label>
          <label class="inspiration-field" for="inspiration-tag-filter">
            <span>Tags</span>
            <select id="inspiration-tag-filter" class="input">
              <option value="">Tous les tags</option>
              ${u.map(C=>`<option value="${C}" ${C===r?"selected":""}>${C}</option>`).join("")}
            </select>
          </label>
        </div>
      </header>
      <div class="inspiration-grid">
        ${d}
      </div>
      ${T}
      ${x}
    </section>
  `}function Vy({projectTitle:n="-",nodes:e=[],edges:t=[],selectedNodeId:r=null,mode:s="select",linkSourceId:i=null,search:o="",createType:a="note",linkTypeMenu:l=null,flashNodeId:c=null,view:u={offsetX:0,offsetY:0,scale:1},chapters:d=[],characters:h=[]}={}){const g=e.find(I=>I.id===r)||null,y=Hs(o),b=y?e.filter(I=>{const H=[I.title,I.summary,...I.tags??[]].filter(Boolean).join(" ");return Hs(H).includes(y)}):e,v=new Set(b.map(I=>I.id)),w={linked:"lie a",conflict:"conflit",appears:"apparait dans",cause:"cause-consequence"},k=t.filter(I=>v.has(I.fromNodeId)&&v.has(I.toNodeId)).map(I=>{const H=e.find(gr=>gr.id===I.fromNodeId),pe=e.find(gr=>gr.id===I.toNodeId);if(!H||!pe)return"";const te=H.x+180/2,Z=H.y+64/2,Ge=pe.x+180/2,st=pe.y+64/2,hs=w[I.type]??I.type??"",ho=(te+Ge)/2,fo=(Z+st)/2;return`
        <line x1="${te}" y1="${Z}" x2="${Ge}" y2="${st}" />
        ${hs?`<text x="${ho}" y="${fo}" class="mindmap-edge-label">${hs}</text>`:""}
      `}).join(""),T={chapter:"Chapitre",character:"Personnage",place:"Lieu",theme:"Theme",event:"Evenement",note:"Idee"},S=b.map(I=>{const H=I.id===r,pe=I.id===i,te=I.id===c,Z=T[I.type]??"Idee";return`
        <button
          type="button"
          class="mindmap-node node--${I.type}${H?" is-active":""}${pe?" is-source":""}${te?" is-flash":""}"
          data-action="mindmap-node"
          data-id="${I.id}"
          style="transform: translate(${I.x}px, ${I.y}px);"
          aria-label="${I.title}"
        >
          <span class="mindmap-node-title">${I.title}</span>
          <span class="mindmap-node-type">${Z}</span>
        </button>
      `}).join(""),x=I=>d.map(H=>{const pe=H.id===I?"selected":"";return`<option value="${H.id}" ${pe}>${H.title||"Sans titre"}</option>`}).join(""),C=I=>h.map(H=>{const te=`${H.first_name??""} ${H.last_name??""}`.trim()||"Sans nom",Z=H.id===I?"selected":"";return`<option value="${H.id}" ${Z}>${te}</option>`}).join(""),R=g?`
      <aside class="mindmap-sidebar">
        <header class="mindmap-sidebar-header">
          <h3>${g.title}</h3>
          <button type="button" class="btn btn-ghost danger-hover" data-action="mindmap-delete-node" data-id="${g.id}">Supprimer</button>
        </header>
        <div class="mindmap-sidebar-body">
          <label class="field"><span>Titre</span>
            <input class="input" type="text" value="${g.title}" data-mindmap-field="title" data-id="${g.id}" />
          </label>
          <label class="field"><span>Type</span>
            <select class="input" data-mindmap-field="type" data-id="${g.id}">
              ${["chapter","character","place","theme","event","note"].map(I=>`<option value="${I}" ${I===g.type?"selected":""}>${I}</option>`).join("")}
            </select>
          </label>
          <label class="field"><span>Resume</span>
            <textarea class="input" rows="3" data-mindmap-field="summary" data-id="${g.id}">${g.summary??""}</textarea>
          </label>
          <label class="field"><span>Tags</span>
          <input class="input" type="text" value="${(g.tags??[]).join(", ")}" data-mindmap-field="tags" data-id="${g.id}" placeholder="tag1, tag2" />
          </label>
          <label class="field"><span>Lier un chapitre</span>
            <select class="input" data-mindmap-field="linkedChapterId" data-id="${g.id}">
              <option value="">Aucun</option>
              ${x(g.linkedChapterId)}
            </select>
          </label>
          <label class="field"><span>Lier un personnage</span>
            <select class="input" data-mindmap-field="linkedCharacterId" data-id="${g.id}">
              <option value="">Aucun</option>
              ${C(g.linkedCharacterId)}
            </select>
          </label>
          ${g.linkedChapterId||g.linkedCharacterId?`<button type="button" class="btn btn-secondary" data-action="mindmap-open-source" data-id="${g.id}">Ouvrir la source</button>`:""}
        </div>
      </aside>
    `:`
      <aside class="mindmap-sidebar">
        <div class="mindmap-empty">
          <h3>Carte mentale</h3>
          <ul>
            <li>Double-clique pour creer un noeud</li>
            <li>Glisse un noeud pour le deplacer</li>
            <li>Relie deux noeuds pour creer un lien</li>
          </ul>
          <p>Utilise la carte pour voir la structure, pas pour ecrire tout le texte.</p>
        </div>
      </aside>
    `,X=l?.open?`
        <div class="mindmap-link-menu" style="transform: translate(${l.x}px, ${l.y}px);">
          <button type="button" data-action="mindmap-link-type" data-type="linked">lie a</button>
          <button type="button" data-action="mindmap-link-type" data-type="conflict">conflit</button>
          <button type="button" data-action="mindmap-link-type" data-type="appears">apparait dans</button>
          <button type="button" data-action="mindmap-link-type" data-type="cause">cause-consequence</button>
          <button type="button" data-action="mindmap-link-cancel">valider</button>
        </div>
      `:"";return`
    <section class="panel card mindmap-panel">
      <header class="mindmap-toolbar">
        <div class="mindmap-toolbar-left">
          <h2>Carte mentale  Projet : ${n}</h2>
          <p class="mindmap-subtitle">Visualise la structure de ton recit</p>
        </div>
        <div class="mindmap-toolbar-actions">
          <button type="button" class="btn btn-primary" data-action="mindmap-add-node">+ Noeud</button>
          <select id="mindmap-create-type" class="input" data-action="mindmap-create-type">
            ${["chapter","character","place","theme","event","note"].map(I=>`<option value="${I}" ${I===a?"selected":""}>${T[I]}</option>`).join("")}
          </select>
          <button type="button" class="btn btn-secondary${s==="link"?" is-active":""}" data-action="mindmap-link-mode">+ Lien</button>
          <input class="input" type="text" id="mindmap-search" placeholder="Rechercher..." value="${o}" />
          <button type="button" class="btn btn-ghost" data-action="mindmap-reset" title="Centrer la carte sur l'ensemble des noeuds">Recentrer</button>
        </div>
      </header>
      <div class="mindmap-body">
        <div class="mindmap-canvas" data-action="mindmap-canvas">
          <div class="mindmap-viewport" style="transform: translate(${u.offsetX}px, ${u.offsetY}px) scale(${u.scale});">
            <svg class="mindmap-edges" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              ${k}
            </svg>
            ${S}
            ${X}
          </div>
        </div>
        ${R}
      </div>
    </section>
  `}function qy({onSignOut:n,userEmail:e="",projects:t=[],selectedProjectId:r=null,editingProjectId:s=null,chapters:i=[],selectedChapterId:o=null,chapterDetail:a=null,versions:l=[],statusText:c="",editorTab:u="session",writingNav:d="chapter",characters:h=[],selectedCharacterId:f=null,characterFilter:m="",inspirationItems:g=[],inspirationSearch:y="",inspirationTag:b="",inspirationModal:v=null,inspirationDetailId:w=null,ideas:k=[],selectedIdeaId:T=null,ideasQuery:S="",ideasTagFilter:x="",ideasStatusFilter:C="all",ideasSort:R="desc",ideasFiltersOpen:X=!1,ideasNoteExpanded:I=!1,mindmapNodes:H=[],mindmapEdges:pe=[],mindmapSelectedNodeId:te=null,mindmapMode:Z="select",mindmapLinkSourceId:Ge=null,mindmapSearch:st="",mindmapCreateType:hs="note",mindmapLinkTypeMenu:ho=null,mindmapFlashNodeId:fo=null,mindmapView:gr={offsetX:0,offsetY:0,scale:1},characterSections:pt={},lastCloudSaveAt:Cp=null,cloudStatus:Ap="",cloudBusy:Op=!1,accountMenuOpen:Mp=!1,backupStatus:Ip="",backupMenuOpen:Np=!1}={}){const sn=!!r,Rp=i.length>0,yr=!!a,Pp=(sn?t.find(U=>U.id===r):null)?.title??"Sans titre",Jl=sn?Pp:"-",Gl=yr?i.findIndex(U=>U.id===o)+1:0;yr&&Gl>0&&i.length&&`${Gl}${i.length}`;const $p=i.map(U=>{const it=U.id===o;return`
        <li class="chapter-item" draggable="true" data-id="${U.id}">
          <button
            class="list-button${it?" is-selected":""}"
            data-action="chapter-select"
            data-id="${U.id}"
          >
            ${U.title}
          </button>
          <button
            type="button"
            class="chapter-delete danger-hover"
            data-action="chapter-delete"
            data-id="${U.id}"
            aria-label="Supprimer le chapitre"
            title="Supprimer"
          >
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </li>
      `}).join("");l.map(U=>`
        <li class="version-item">
          <div>
            <strong>${U.label??"Version"}</strong>
            <div class="muted">${Us(U.created_at)}</div>
          </div>
          <button class="btn btn-primary"
            data-action="version-restore"
            data-id="${U.id}"
            type="button"
          >
            Restaurer
          </button>
        </li>
      `).join("");const Dp=a?.conflict?`
      <div class="conflict">
        <p>Conflit detecte (serveur different).</p>
        <div class="actions">
          <button class="btn btn-primary" data-action="conflict-reload-server" type="button">
            Recharger serveur
          </button>
          <button data-action="conflict-duplicate-local" class="btn btn-secondary" type="button">
            Dupliquer local
          </button>
        </div>
      </div>
    `:"",jp=yr?`
      ${Dp}
      <div class="field editor-field">
        <div id="editor-toolbar" class="editor-toolbar" role="toolbar" aria-label="Outils de mise en forme">
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-bold" data-command="bold" aria-label="Gras" title="Gras">
              <span aria-hidden="true">G</span>
            </button>
            <button type="button" class="toolbar-button icon-italic" data-command="italic" aria-label="Italique" title="Italique">
              <span aria-hidden="true">I</span>
            </button>
            <button type="button" class="toolbar-button icon-heading" data-command="heading-1" aria-label="Titre 1" title="Titre 1">
              <span aria-hidden="true">H1</span>
            </button>
            <button type="button" class="toolbar-button icon-heading" data-command="heading-2" aria-label="Titre 2" title="Titre 2">
              <span aria-hidden="true">H2</span>
            </button>
          </div>
          <div class="toolbar-group toolbar-segment" role="group" aria-label="Alignement">
            <button type="button" class="toolbar-button icon-align icon-align-left" data-command="align-left" aria-label="Aligner a gauche" title="Aligner a gauche">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-center" data-command="align-center" aria-label="Centrer" title="Centrer">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-right" data-command="align-right" aria-label="Aligner a droite" title="Aligner a droite">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-justify" data-command="align-justify" aria-label="Justifier" title="Justifier">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-list icon-list-bullet" data-command="bullet-list" aria-label="Liste a puces" title="Liste a puces">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-list icon-list-ordered" data-command="ordered-list" aria-label="Liste numerotee" title="Liste numerotee">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-highlight" data-command="highlight" aria-label="Surligner" title="Surligner">
              <span aria-hidden="true">A</span>
            </button>
          </div>
          <div class="toolbar-group">
            <label class="toolbar-label" for="toolbar-font-size">Taille</label>
            <select id="toolbar-font-size" class="toolbar-select input input-sm" data-command="font-size" aria-label="Taille de police" title="Taille de police">
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="24">24</option>
            </select>
          </div>
          <div class="toolbar-group toolbar-group-right">
            <button type="button" class="toolbar-button icon-history" data-command="undo" aria-label="Annuler" title="Annuler">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-history" data-command="redo" aria-label="Retablir" title="Retablir">
              <span aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="paper-shell">
          <div id="chapter-editor" class="editor-canvas" aria-label="Contenu du chapitre"></div>
        </div>
      </div>
    `:`
      <div class="empty">
        <p>${sn?"Cree un chapitre pour ecrire.":"Commence par creer un projet."}</p>
      </div>
    `,Lp="",Bp=`
    <button
      id="project-export"
      data-action="project-export-md"
      type="button"
      class="btn btn-secondary btn-compact"
      ${sn?"":"disabled"}
      aria-disabled="${sn?"false":"true"}"
      aria-label="Exporter le projet en Markdown"
      title="Exporter le projet en Markdown"
    >
      Exporter
    </button>
  `;yr&&a?.title;const fs=h.filter(U=>{if(!m.trim())return!0;const it=m.trim().toLowerCase(),Nt=`${U.first_name??""} ${U.last_name??""}`.toLowerCase(),Rt=(U.nickname??"").toLowerCase();return Nt.includes(it)||Rt.includes(it)}),Yl=f??fs[0]?.id??null,B=h.find(U=>U.id===Yl)??null,Xl=B?.first_name||B?.last_name?`${B?.first_name??""} ${B?.last_name??""}`.trim():"Personnage sans nom",zp=Xl.split(" ").filter(Boolean).slice(0,2).map(U=>U[0]?.toUpperCase()).join("")||"?",Fp=B?.avatar_url?.trim()?B.avatar_url.trim():"/character-placeholder.svg",Up=B?.age?`${B.age} ans`:"",Hp=(B?.residence??"").trim()||(B?.birth_place??"").trim(),Ql=[Up,Hp].filter(Boolean).join("  "),Vp=Math.max(0,Math.min(5,Number(B?.role_rating??0))),mt=(U,it,Nt,Rt)=>`
        <section class="character-accordion${Rt?" is-open":""}">
          <button
            type="button"
            class="character-accordion-header"
            data-action="character-toggle"
            data-section="${U}"
            aria-expanded="${Rt}"
          >
            <span class="character-dot"></span>
            <span>${it}</span>
            <span class="character-accordion-icon" aria-hidden="true">></span>
          </button>
          ${Rt?`<div class="character-accordion-body">${Nt}</div>`:""}
        </section>
      `,qp=B?`
      <div class="character-detail-panel">
        <div class="character-hero">
          <button type="button" class="character-hero-avatar" data-action="character-avatar" aria-label="Changer l'avatar">
            <img src="${Fp}" alt="${zp}" />
          </button>
          <input id="character-avatar-input" type="file" accept="image/*" hidden />
          <div class="character-hero-info">
            <h3>${Xl}</h3>
            ${Ql?`<div class="character-meta">${Ql}</div>`:""}
          </div>
            <div class="character-hero-meta">
              <p>Role :</p>
              <div class="character-stars" role="radiogroup" aria-label="Role">
                ${[1,2,3,4,5].map(U=>`
                  <button
                    type="button"
                    class="character-star${U<=Vp?" is-active":""}"
                    data-action="character-rate"
                    data-rating="${U}"
                    aria-label="${U} etoiles"
                  >
                    
                  </button>
                `).join("")}
              </div>
            </div>
        </div>
        <div class="character-sections">
          ${mt("civil","Etat civil",`
              <div class="character-grid">
                <label>
                  <span>Prenom</span>
                  <input class="input" type="text" value="${B.first_name??""}" data-character-field="first_name" />
                </label>
                <label>
                  <span>Nom de famille</span>
                  <input class="input" type="text" value="${B.last_name??""}" data-character-field="last_name" />
                </label>
                <label>
                  <span>Surnom</span>
                  <input class="input" type="text" value="${B.nickname??""}" data-character-field="nickname" />
                </label>
                <label>
                  <span>Pronoms</span>
                  <input class="input" type="text" value="${B.pronouns??""}" data-character-field="pronouns" />
                </label>
                <label class="character-inline">
                  <span>Sexe</span>
                  <div class="character-inline-row">
                    <label><input type="radio" name="sex" value="femme" data-character-field="sex" ${B.sex==="femme"?"checked":""} />Femme</label>
                    <label><input type="radio" name="sex" value="homme" data-character-field="sex" ${B.sex==="homme"?"checked":""} />Homme</label>
                    <label><input type="radio" name="sex" value="autre" data-character-field="sex" ${B.sex==="autre"?"checked":""} />Autre</label>
                  </div>
                </label>
                <label>
                  <span>Race</span>
                  <input class="input" type="text" value="${B.race??""}" data-character-field="race" />
                </label>
                <label>
                  <span>Age</span>
                  <input class="input" type="number" value="${B.age??""}" data-character-field="age" />
                </label>
                <label>
                  <span>Date de naissance</span>
                  <input class="input" type="date" value="${B.birth_date??""}" data-character-field="birth_date" />
                </label>
                <label>
                  <span>Lieu de naissance</span>
                  <input class="input" type="text" value="${B.birth_place??""}" data-character-field="birth_place" />
                </label>
                <label>
                  <span>Lieu de residence</span>
                  <input class="input" type="text" value="${B.residence??""}" data-character-field="residence" />
                </label>
                <label>
                  <span>Occupation</span>
                  <input class="input" type="text" value="${B.occupation??""}" data-character-field="occupation" />
                </label>
              </div>
            `,pt.civil)}
          ${mt("physique","Physique",`
              <div class="character-physique">
                <div class="character-physique-preview">
                  <img
                    src="${B.meta?.physique?.image_url?.trim()?B.meta.physique.image_url.trim():"/character-placeholder.svg"}"
                    alt="Physique du personnage"
                  />
                </div>
                <button type="button" class="btn btn-secondary btn-compact" data-action="character-physique">
                  Charger une image
                </button>
                <input id="character-physique-input" type="file" accept="image/*" hidden />
              </div>
            `,pt.physique)}
          ${mt("caractere","Caractere",`
              <div class="character-grid">
                <label>
                  <span>Traits dominants</span>
                  <textarea data-character-meta="caractere" data-character-field="traits">${B.meta?.caractere?.traits??""}</textarea>
                </label>
                <label>
                  <span>Qualites</span>
                  <textarea data-character-meta="caractere" data-character-field="qualites">${B.meta?.caractere?.qualites??""}</textarea>
                </label>
                <label>
                  <span>Defauts</span>
                  <textarea data-character-meta="caractere" data-character-field="defauts">${B.meta?.caractere?.defauts??""}</textarea>
                </label>
                <label>
                  <span>Peur(s)</span>
                  <textarea data-character-meta="caractere" data-character-field="peurs">${B.meta?.caractere?.peurs??""}</textarea>
                </label>
              </div>
            `,pt.caractere)}
          ${mt("profil","Profil",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Histoire courte</span>
                  <textarea data-character-meta="profil" data-character-field="histoire">${B.meta?.profil?.histoire??""}</textarea>
                </label>
                <label>
                  <span>Objectifs</span>
                  <textarea data-character-meta="profil" data-character-field="objectifs">${B.meta?.profil?.objectifs??""}</textarea>
                </label>
                <label>
                  <span>Relations</span>
                  <textarea data-character-meta="profil" data-character-field="relations">${B.meta?.profil?.relations??""}</textarea>
                </label>
              </div>
            `,pt.profil)}
          ${mt("storyRole","Role dans l'histoire",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Role dans l'histoire</span>
                  <textarea data-character-field="storyRole" placeholder="Decris la fonction narrative du personnage...">${B.storyRole??""}</textarea>
                </label>
              </div>
            `,pt.storyRole)}
          ${mt("evolution","Evolution",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Arc</span>
                  <textarea data-character-meta="evolution" data-character-field="arc">${B.meta?.evolution?.arc??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Changements</span>
                  <textarea data-character-meta="evolution" data-character-field="changements">${B.meta?.evolution?.changements??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Etapes cles</span>
                  <textarea data-character-meta="evolution" data-character-field="etapes">${B.meta?.evolution?.etapes??""}</textarea>
                </label>
              </div>
            `,pt.evolution)}
          ${mt("inventaire","Inventaire",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Objets</span>
                  <textarea data-character-meta="inventaire" data-character-field="items">${B.meta?.inventaire?.items??""}</textarea>
                </label>
              </div>
            `,pt.inventaire)}
          ${mt("possession","Possession",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Biens & lieux</span>
                  <textarea data-character-meta="possession" data-character-field="biens">${B.meta?.possession?.biens??""}</textarea>
                </label>
              </div>
            `,pt.possession)}
          ${mt("autres","Autres",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Notes libres</span>
                  <textarea data-character-meta="autres" data-character-field="notes">${B.meta?.autres?.notes??""}</textarea>
                </label>
              </div>
            `,pt.autres)}
        </div>
      </div>
    `:`
      <div class="character-detail-panel empty">
        <p>Selectionnez un personnage.</p>
      </div>
    `,Wp=`
        <section class="panel card character-panel characters-skin">
          <div class="character-shell">
            <aside class="character-list characters-panel">
              <div class="characters-panel__header">
                <div class="characters-panel__title">
                  Personnages <span class="characters-panel__count"> ${fs.length}</span>
                </div>
                <button type="button" class="characters-panel__create btn btn-secondary btn-compact" data-action="character-create" aria-label="Nouveau personnage" title="Nouveau personnage">
                  <span aria-hidden="true">+</span> Nouveau personnage
                </button>
              </div>
              <div class="characters-panel__search">
                <input class="input" id="character-filter" type="text" placeholder="Rechercher..." value="${m}" />
              </div>
              <div class="characters-list">
                ${fs.length?fs.map(U=>{const it=`${U.first_name??""} ${U.last_name??""}`.trim(),Nt=!!it,Rt=Nt?it:"Sans nom",Xp=Nt?it.split(" ").filter(Boolean).slice(0,2).map(tm=>tm[0]?.toUpperCase()).join(""):"NP",Qp=U.avatar_url?.trim()?U.avatar_url.trim():"/character-placeholder.svg",Zp=Nt?"":'<span class="characters-item__meta">Brouillon</span>',em=Nt?`Supprimer ${Rt}`:"Supprimer ce personnage";return`
                            <div class="characters-item${U.id===Yl?" is-active":""}" data-action="character-select" data-id="${U.id}">
                              <button
                                type="button"
                                class="characters-item__main"
                                data-action="character-select"
                                data-id="${U.id}"
                              >
                                <span class="characters-item__avatar">
                                  <img src="${Qp}" alt="${Xp}" />
                                </span>
                                <span class="characters-item__content">
                                  <span class="characters-item__name">${Rt}</span>
                                  ${Zp}
                                </span>
                              </button>
                              <button
                                type="button"
                                class="characters-item__delete danger-hover"
                                data-action="character-delete"
                                data-id="${U.id}"
                                aria-label="${em}"
                                title="Supprimer"
                              >
                                <span aria-hidden="true"></span>
                              </button>
                            </div>
                          `}).join(""):`<p class="muted">Aucun personnage pour le moment.
                  Cree ton premier personnage pour commencer.</p>`}
              </div>
            </aside>
            ${qp}
          </div>
        </section>
      `,Kp=Hy({projectTitle:Jl,inspirationItems:g,inspirationSearch:y,inspirationTag:b,inspirationModal:v,inspirationDetailId:w,chapters:i,characters:h}),Jp=Vy({projectTitle:Jl,nodes:H,edges:pe,selectedNodeId:te,mode:Z,linkSourceId:Ge,search:st,createType:hs,linkTypeMenu:ho,flashNodeId:fo,view:gr,chapters:i,characters:h}),Gp=`
        <section class="ideas-panel">
          <div class="ideas-content ideas-content--embedded">
            ${Fy({ideas:k,selectedIdeaId:T,ideasQuery:S,ideasTagFilter:x,ideasStatusFilter:C,ideasSort:R,ideasFiltersOpen:X,ideasNoteExpanded:I})}
          </div>
        </section>
      `,Yp=`
        <aside class="writing-secondary">
          <section class="panel card story-panel">
            <header class="story-panel__header">
              <h3>Chapitres</h3>
              <button type="button" class="btn btn-secondary btn-compact" data-action="chapter-create" aria-label="Nouveau chapitre" title="Nouveau chapitre" ${sn?"":"disabled"}>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
                              </button>
            </header>
            <div class="story-panel__divider"></div>

            <div class="story-panel__section story-panel__search">
              <div class="story-panel__search-row">
                <input class="input" id="chapter-search-input" type="text" placeholder="Rechercher..." />
              </div>
            </div>

            <div class="story-panel__section story-panel__chapters">
              <div class="story-panel__list">
                ${sn?Rp?`<ul class="list chapter-list">${$p}</ul>`:'<p class="muted">Cree un chapitre pour ecrire.</p>':'<p class="muted">Selectionne un projet.</p>'}
              </div>
            </div>

            <div class="story-panel__section story-panel__footer">
              <div class="story-panel__file-actions">
                <button type="button" class="btn btn-secondary btn-compact">Importer</button>
                ${Bp}
              </div>
            </div>
          </section>
        </aside>
      `;return`
    <section class="page-shell writing-page">
      ${el({userEmail:e,activeRoute:"projects",lastProjectId:r,lastCloudSaveAt:Cp,cloudStatus:Ap,cloudBusy:Op,accountMenuOpen:Mp,backupStatus:Ip,backupMenuOpen:Np})}
      <div class="page app-shell">
        <div class="writing-layout${d==="chapter"?" with-chapter":""}">
        <aside class="writing-sidebar editor-sidebar">
          <section class="panel card writing-nav">
            <div class="writing-nav-header">Plumeo</div>
            <nav class="writing-nav-list" aria-label="Navigation ecriture">
              <button type="button" class="writing-nav-item editor-sidebar__item${d==="chapter"?" is-active":""}" data-action="writing-nav" data-nav="chapter" aria-label="Chapitre" title="Chapitre">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M4 20l4-1 11-11-3-3-11 11-1 4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M14 6l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Chapitre</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${d==="characters"?" is-active":""}" data-action="writing-nav" data-nav="characters" aria-label="Personnages" title="Personnages">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4.5" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M5 20c1.6-3.2 5-5 7-5s5.4 1.8 7 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Personnages</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${d==="inspiration"?" is-active":""}" data-action="writing-nav" data-nav="inspiration" aria-label="Inspiration" title="Inspiration">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M12 3a6 6 0 0 0-3 11.2V17h6v-2.8A6 6 0 0 0 12 3z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M9 21h6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Inspiration</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${d==="ideas"?" is-active":""}" data-action="writing-nav" data-nav="ideas" aria-label="Idees" title="Idees">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 4h9l3 3v13H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M15 4v3h3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Idees</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${d==="mindmap"?" is-active":""}" data-action="writing-nav" data-nav="mindmap" aria-label="Carte mentale" title="Carte mentale">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <circle cx="8" cy="8" r="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <circle cx="16" cy="16" r="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M9.5 9.5l5 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Carte mentale</span>
              </button>
            </nav>
          </section>
        </aside>

        ${d==="chapter"?Yp:""}

        <main class="writing-editor${d==="inspiration"?" writing-editor--wide":""}${d==="ideas"?" writing-editor--ideas":""}${d==="mindmap"?" writing-editor--mindmap":""}">
        ${d==="characters"?Wp:d==="inspiration"?Kp:d==="ideas"?Gp:d==="mindmap"?Jp:`
            <section class="panel card editor ${yr?"":"is-disabled"}">
              <div class="panel-header">
                <span id="status-text" class="status">${c}</span>
                <span id="editor-word-count" class="status"></span>
              </div>
              <div class="editor-body">
                ${jp}
              </div>
            </section>
          `}
        </main>
        </div>
        ${Lp}
        
      </div>
    </section>
  `}async function ft(){try{const{data:n,error:e}=await ce.auth.getUser();return e?{ok:!1,errorMessage:e.message}:n.user?{ok:!0,userId:n.user.id}:{ok:!1,errorMessage:"User not authenticated"}}catch(n){return{ok:!1,errorMessage:n.message}}}async function Wy(){const n=await ft();if(!n.ok)return n;try{const{data:e,error:t}=await ce.from("projects").select("id,title,created_at").eq("user_id",n.userId).order("created_at",{ascending:!0});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function bd(n){const e=await ft();if(!e.ok)return e;if(!n)return{ok:!1,errorMessage:"Missing project id"};try{const{data:t,error:r}=await ce.from("projects").select("id").eq("id",n).eq("user_id",e.userId).maybeSingle();return r?{ok:!1,errorMessage:r.message}:{ok:!0,exists:!!t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function tl(n){const e=await ft();if(!e.ok)return e;try{const{data:t,error:r}=await ce.from("projects").insert({title:n,user_id:e.userId}).select("id,title,created_at").single();return r?{ok:!1,errorMessage:r.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Ky(n,e){try{const{data:t,error:r}=await ce.from("projects").update({title:e}).eq("id",n).select("id,title").single();return r?{ok:!1,errorMessage:r.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function wd(n){const e=await ft();if(!e.ok)return e;try{const{error:t}=await ce.from("chapters").delete().eq("project_id",n).eq("user_id",e.userId);if(t)return{ok:!1,errorMessage:t.message};const{error:r}=await ce.from("projects").delete().eq("id",n).eq("user_id",e.userId);return r?{ok:!1,errorMessage:r.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Jy(n){try{const{data:e,error:t}=await ce.from("chapters").select("id,project_id,title,order_index,revision").eq("project_id",n).order("order_index",{ascending:!0});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function vd(n,e,t){const r=await ft();if(!r.ok)return r;try{const{data:s,error:i}=await ce.from("chapters").insert({project_id:n,title:e,order_index:t,user_id:r.userId}).select("id,project_id,title,order_index,revision,content_md").single();return i?{ok:!1,errorMessage:i.message}:{ok:!0,data:s}}catch(s){return{ok:!1,errorMessage:s.message}}}async function Gy({id:n,projectId:e,title:t,orderIndex:r,contentMd:s=""}){const i=await ft();if(!i.ok)return i;if(!n||!e)return{ok:!1,errorMessage:"Missing chapter id or project id"};try{const{data:o,error:a}=await ce.from("chapters").insert({id:n,project_id:e,title:t,order_index:r,content_md:s,user_id:i.userId}).select("id,project_id,title,order_index,revision,content_md").single();return a?{ok:!1,errorMessage:a.message}:{ok:!0,data:o}}catch(o){return{ok:!1,errorMessage:o.message}}}async function Yy(n){try{const{data:e,error:t}=await ce.from("chapters").select("id,project_id,title,content_md,order_index,revision").eq("id",n).single();return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e}}catch(e){return{ok:!1,errorMessage:e.message}}}async function kd(n){return Yy(n)}async function Xy(n,e){try{const{data:t,error:r}=await ce.from("chapters").update(e).eq("id",n).select("id").single();return r?{ok:!1,errorMessage:r.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Qy({id:n,title:e,content_md:t,baseRevision:r}){const s=await ft();if(!s.ok)return s;const i=o=>{if(Array.isArray(o)){const a=o[0];return a&&typeof a.new_revision<"u"?Number(a.new_revision):Number(o[0])}return o&&typeof o.new_revision<"u"?Number(o.new_revision):Number(o)};try{const{data:o,error:a}=await ce.rpc("update_chapter_if_revision",{p_id:n,p_user_id:s.userId,p_title:e,p_content_md:t,p_base_revision:r});if(a)return{ok:!1,errorMessage:a.message};const l=i(o);return{ok:!0,newRevision:Number.isFinite(l)?l:-1}}catch(o){return{ok:!1,errorMessage:o.message}}}async function Zy(n){try{const{data:e,error:t}=await ce.from("versions").select("id,chapter_id,label,content_md,created_at").eq("chapter_id",n).order("created_at",{ascending:!1});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Sd(n,e,t=null){const r=await ft();if(!r.ok)return r;try{const{data:s,error:i}=await ce.from("versions").insert({chapter_id:n,user_id:r.userId,content_md:e,label:t}).select("id,chapter_id,label,content_md,created_at").single();return i?{ok:!1,errorMessage:i.message}:{ok:!0,data:s}}catch(s){return{ok:!1,errorMessage:s.message}}}const eb="writer_db",tb=6;let dn=null,Ft=null;function nb(){return dn||(dn=new Promise((n,e)=>{const t=indexedDB.open(eb,tb);t.onupgradeneeded=()=>{const r=t.result;r.objectStoreNames.contains("projects")||r.createObjectStore("projects",{keyPath:"id"}),r.objectStoreNames.contains("chapters")||r.createObjectStore("chapters",{keyPath:"id"}),r.objectStoreNames.contains("outbox")||r.createObjectStore("outbox",{keyPath:"opId"}),r.objectStoreNames.contains("characters")||r.createObjectStore("characters",{keyPath:"id"}),r.objectStoreNames.contains("inspiration")||r.createObjectStore("inspiration",{keyPath:"id"}),r.objectStoreNames.contains("mindmap_nodes")||r.createObjectStore("mindmap_nodes",{keyPath:"id"}),r.objectStoreNames.contains("mindmap_edges")||r.createObjectStore("mindmap_edges",{keyPath:"id"}),r.objectStoreNames.contains("ideas")||r.createObjectStore("ideas",{keyPath:"id"})},t.onsuccess=()=>{Ft=t.result,Ft.onversionchange=()=>{try{Ft.close()}catch{}Ft=null,dn=null},n(Ft)},t.onerror=()=>{dn=null,e(t.error)},t.onblocked=()=>{}}),dn)}const rb=n=>n&&["InvalidStateError","TransactionInactiveError","AbortError"].includes(n.name);async function ss(n,e=1){try{const t=await nb();return await n(t)}catch(t){if(e>0&&rb(t)){if(Ft)try{Ft.close()}catch{}return Ft=null,dn=null,ss(n,e-1)}throw t}}async function W(n,e){return ss(t=>new Promise((r,s)=>{const i=t.transaction(n,"readwrite");i.oncomplete=()=>r(),i.onerror=()=>s(i.error),i.objectStore(n).put(e)}))}async function At(n,e){return ss(t=>new Promise((r,s)=>{const o=t.transaction(n,"readonly").objectStore(n).get(e);o.onsuccess=()=>r(o.result),o.onerror=()=>s(o.error)}))}async function q(n){return ss(e=>new Promise((t,r)=>{const i=e.transaction(n,"readonly").objectStore(n).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>r(i.error)}))}async function Ce(n,e){return ss(t=>new Promise((r,s)=>{const i=t.transaction(n,"readwrite");i.oncomplete=()=>r(),i.onerror=()=>s(i.error),i.objectStore(n).delete(e)}))}function sb(n,e,t=!1){const r=e??{},s=n.revision??n.remote_revision??r.remote_revision??0,i=!t&&(r.dirty===!0||r.conflict===!0),o=i?r.content_md??n.content_md??"":n.content_md??r.content_md??"",a=i?r.title??n.title??"":n.title??r.title??"";return{id:n.id??r.id,project_id:n.project_id??r.project_id,title:a,content_md:o,order_index:n.order_index??r.order_index??0,remote_revision:i?r.remote_revision??s:s,dirty:t?!1:r.dirty??!1,conflict:t?!1:r.conflict??!1,server_copy:t?null:r.server_copy??null,updated_local_at:r.updated_local_at??null,last_snapshot_at:r.last_snapshot_at??null,pending_create:t?!1:r.pending_create??!1}}function ib(n,e){const t=e??{};return{...t,...n,status:n.status??t.status??"active"}}async function fr(n){for(const e of n){const t=await At("projects",e.id),r=ib(e,t);await W("projects",r)}}async function is(n,{force:e=!1}={}){for(const t of n){const r=await At("chapters",t.id),s=sb(t,r,e);await W("chapters",s)}}async function ob(){return q("projects")}async function nl(n){return(await q("chapters")).filter(t=>t.project_id===n).sort((t,r)=>(t.order_index??0)-(r.order_index??0))}async function Hi(n){return At("chapters",n)}async function ab(n){n&&await Ce("chapters",n)}async function _d(n){n&&await Ce("projects",n)}async function xd(n,e){if(!n)return null;const t=await At("projects",n);if(!t)return null;const r={...t,...e};return await W("projects",r),r}async function Td(n){if(!n)return;const t=(await q("chapters")).filter(r=>r.project_id===n);for(const r of t)await Ce("chapters",r.id)}async function Ed(n){if(!n)return;const t=(await q("inspiration")).filter(r=>r.project_id===n);for(const r of t)await Ce("inspiration",r.id)}async function Cd(n){if(!n)return;const e=await q("mindmap_nodes"),t=await q("mindmap_edges"),r=e.filter(i=>i.project_id===n),s=t.filter(i=>i.project_id===n);for(const i of r)await Ce("mindmap_nodes",i.id);for(const i of s)await Ce("mindmap_edges",i.id)}async function rl(n,e){const t=await At("chapters",n),r={...t??{id:n},...e,remote_revision:e.remote_revision??t?.remote_revision??0,dirty:!0,conflict:t?.conflict??!1,server_copy:t?.server_copy??null,updated_local_at:Date.now(),last_snapshot_at:e.last_snapshot_at??t?.last_snapshot_at??null,pending_create:t?.pending_create??!1};return await W("chapters",r),r}function lb(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}async function cb(n,e,t){if(!n)return null;const r=Date.now(),s={id:lb(),project_id:n,title:e,content_md:"",order_index:t??0,remote_revision:0,dirty:!0,conflict:!1,server_copy:null,updated_local_at:r,last_snapshot_at:null,pending_create:!0,created_at:r};return await W("chapters",s),s}async function ub(n){return(await q("characters")).filter(t=>t.project_id===n).sort((t,r)=>(t.created_at??0)-(r.created_at??0))}async function db(n){const e=Date.now(),t={id:`${e}-${Math.random().toString(16).slice(2)}`,project_id:n,first_name:"",last_name:"",nickname:"",pronouns:"",sex:"",race:"",age:"",birth_date:"",birth_place:"",residence:"",occupation:"",role_rating:0,storyRole:"",avatar_url:"",meta:{physique:{taille:"",corpulence:"",signes:"",style:"",image_url:""},caractere:{traits:"",qualites:"",defauts:"",peurs:""},profil:{histoire:"",objectifs:"",relations:""},evolution:{arc:"",changements:"",etapes:""},inventaire:{items:""},possession:{biens:""},autres:{notes:""}},created_at:e,updated_at:e};return await W("characters",t),t}async function Vs(n,e){const t=await At("characters",n);if(!t)return null;const r={...t,...e,meta:{...t.meta??{},...e.meta??{}},updated_at:Date.now()};return await W("characters",r),r}async function hb(n){n&&await Ce("characters",n)}async function fb(n){return(await q("inspiration")).filter(t=>t.project_id===n).sort((t,r)=>(r.created_at??0)-(t.created_at??0))}async function pb(n,e){const t=Date.now(),r={id:`${t}-${Math.random().toString(16).slice(2)}`,project_id:n,type:e.type,title:e.title??"",note:e.note??"",tags:Array.isArray(e.tags)?e.tags:[],url:e.url??"",image_data:e.image_data??"",linkedChapterId:e.linkedChapterId??"",linkedCharacterId:e.linkedCharacterId??"",created_at:t,updated_at:t};return await W("inspiration",r),r}async function mb(n,e){const t=await At("inspiration",n);if(!t)return null;const r={...t,...e,tags:Array.isArray(e.tags)?e.tags:t.tags??[],updated_at:Date.now()};return await W("inspiration",r),r}async function gb(n){n&&await Ce("inspiration",n)}async function yb(n){const[e,t]=await Promise.all([q("mindmap_nodes"),q("mindmap_edges")]);return{nodes:e.filter(r=>r.project_id===n),edges:t.filter(r=>r.project_id===n)}}async function bb(n,e){const t=Date.now(),r={id:`${t}-${Math.random().toString(16).slice(2)}`,project_id:n,title:e.title??"Nouveau noeud",type:e.type??"note",summary:e.summary??"",tags:Array.isArray(e.tags)?e.tags:[],x:Number.isFinite(e.x)?e.x:120,y:Number.isFinite(e.y)?e.y:120,linkedChapterId:e.linkedChapterId??"",linkedCharacterId:e.linkedCharacterId??"",created_at:t,updated_at:t};return await W("mindmap_nodes",r),r}async function Ad(n,e){const t=await At("mindmap_nodes",n);if(!t)return null;const r={...t,...e,tags:Array.isArray(e.tags)?e.tags:t.tags??[],x:Number.isFinite(e.x)?e.x:t.x??0,y:Number.isFinite(e.y)?e.y:t.y??0,updated_at:Date.now()};return await W("mindmap_nodes",r),r}async function wb(n){if(!n)return;await Ce("mindmap_nodes",n);const t=(await q("mindmap_edges")).filter(r=>r.fromNodeId===n||r.toNodeId===n);for(const r of t)await Ce("mindmap_edges",r.id)}async function vb(n,e){const t=Date.now(),r={id:`${t}-${Math.random().toString(16).slice(2)}`,project_id:n,fromNodeId:e.fromNodeId,toNodeId:e.toNodeId,type:e.type??"link",created_at:t,updated_at:t};return await W("mindmap_edges",r),r}async function Vi({projectId:n=null}={}){const e=await q("ideas");return(n?e.filter(r=>r.project_id===n):e).sort((r,s)=>(s.created_at??0)-(r.created_at??0))}async function kb(n){const e=Date.now(),t={id:`${e}-${Math.random().toString(16).slice(2)}`,project_id:n.project_id??null,content:n.content??"",note:n.note??"",tags:Array.isArray(n.tags)?n.tags:[],status:n.status??"raw",created_at:e,updated_at:e};return await W("ideas",t),t}async function Sb(n,e){const t=await At("ideas",n);if(!t)return null;const r={...t,...e,tags:Array.isArray(e.tags)?e.tags:t.tags??[],updated_at:Date.now()};return await W("ideas",r),r}async function _b(n){n&&await Ce("ideas",n)}const fa="writer:lastProjectId",pa="writer:lastChapterId",ma="plumeo:lastCloudSaveAt";function Ot(){try{return localStorage.getItem(fa)}catch{return null}}function rt(n){try{if(!n){localStorage.removeItem(fa);return}localStorage.setItem(fa,n)}catch{}}function xb(){try{return localStorage.getItem(pa)}catch{return null}}function Cn(n){try{if(!n){localStorage.removeItem(pa);return}localStorage.setItem(pa,n)}catch{}}function qi(){try{const n=localStorage.getItem(ma);if(!n)return null;const e=Number(n);return Number.isFinite(e)?e:null}catch{return null}}function sl(n){try{if(!n){localStorage.removeItem(ma);return}localStorage.setItem(ma,String(n))}catch{}}function Tb(n){if(typeof n=="number")return n;if(typeof n=="string")try{const e=JSON.parse(n);return Array.isArray(e)&&e[0]?.new_revision!=null?Number(e[0].new_revision)||0:e&&e.new_revision!=null?Number(e.new_revision)||0:Number(e)||0}catch{return Number(n)||0}return n&&typeof n.new_revision<"u"?Number(n.new_revision)||0:Array.isArray(n)&&n[0]?.new_revision!=null?Number(n[0].new_revision)||0:Number(n)||0}async function Wi(n){const e={opId:`${Date.now()}-${Math.random().toString(16).slice(2)}`,type:"UPSERT_CHAPTER",chapterId:n,createdAt:Date.now()};return await W("outbox",e),e}async function Ki(){if(!navigator.onLine)return[];const n=await q("outbox"),e=[];for(const t of n){if(t.type!=="UPSERT_CHAPTER")continue;const r=await Hi(t.chapterId);if(!r){await Ce("outbox",t.opId);continue}if(r.pending_create){const o=await bd(r.project_id);if(!o.ok||!o.exists)continue;const a=await Gy({id:r.id,projectId:r.project_id,title:r.title??"",orderIndex:r.order_index??0,contentMd:r.content_md??""});if(!a.ok)continue;const l={...r,...a.data,content_md:a.data.content_md??r.content_md??"",remote_revision:a.data.revision??r.remote_revision??0,dirty:!1,conflict:!1,server_copy:null,pending_create:!1};await W("chapters",l),await Ce("outbox",t.opId),e.push({chapterId:r.id,status:"synced"});continue}const s=await Qy({id:r.id,title:r.title??"",content_md:r.content_md??"",baseRevision:Tb(r.remote_revision)});if(!s.ok){console.error("syncOnce rpc error",s.errorMessage);continue}if(s.newRevision===-1){const o=await kd(r.id);if(o.ok){const a={...r,conflict:!0,server_copy:o.data,dirty:!0};await W("chapters",a)}await Ce("outbox",t.opId),e.push({chapterId:r.id,status:"conflict"});continue}const i={...r,remote_revision:s.newRevision,dirty:!1,conflict:!1,server_copy:null};await W("chapters",i),await Ce("outbox",t.opId),e.push({chapterId:r.id,status:"synced"})}return e}function Eb(n){const e=async()=>{try{const r=await Ki();n&&await n(r)}catch(r){console.error("syncLoop error",r)}},t=window.setInterval(e,5e3);return window.addEventListener("online",e),t}function _e(n){this.content=n}_e.prototype={constructor:_e,find:function(n){for(var e=0;e<this.content.length;e+=2)if(this.content[e]===n)return e;return-1},get:function(n){var e=this.find(n);return e==-1?void 0:this.content[e+1]},update:function(n,e,t){var r=t&&t!=n?this.remove(t):this,s=r.find(n),i=r.content.slice();return s==-1?i.push(t||n,e):(i[s+1]=e,t&&(i[s]=t)),new _e(i)},remove:function(n){var e=this.find(n);if(e==-1)return this;var t=this.content.slice();return t.splice(e,2),new _e(t)},addToStart:function(n,e){return new _e([n,e].concat(this.remove(n).content))},addToEnd:function(n,e){var t=this.remove(n).content.slice();return t.push(n,e),new _e(t)},addBefore:function(n,e,t){var r=this.remove(e),s=r.content.slice(),i=r.find(n);return s.splice(i==-1?s.length:i,0,e,t),new _e(s)},forEach:function(n){for(var e=0;e<this.content.length;e+=2)n(this.content[e],this.content[e+1])},prepend:function(n){return n=_e.from(n),n.size?new _e(n.content.concat(this.subtract(n).content)):this},append:function(n){return n=_e.from(n),n.size?new _e(this.subtract(n).content.concat(n.content)):this},subtract:function(n){var e=this;n=_e.from(n);for(var t=0;t<n.content.length;t+=2)e=e.remove(n.content[t]);return e},toObject:function(){var n={};return this.forEach(function(e,t){n[e]=t}),n},get size(){return this.content.length>>1}};_e.from=function(n){if(n instanceof _e)return n;var e=[];if(n)for(var t in n)e.push(t,n[t]);return new _e(e)};function Od(n,e,t){for(let r=0;;r++){if(r==n.childCount||r==e.childCount)return n.childCount==e.childCount?null:t;let s=n.child(r),i=e.child(r);if(s==i){t+=s.nodeSize;continue}if(!s.sameMarkup(i))return t;if(s.isText&&s.text!=i.text){for(let o=0;s.text[o]==i.text[o];o++)t++;return t}if(s.content.size||i.content.size){let o=Od(s.content,i.content,t+1);if(o!=null)return o}t+=s.nodeSize}}function Md(n,e,t,r){for(let s=n.childCount,i=e.childCount;;){if(s==0||i==0)return s==i?null:{a:t,b:r};let o=n.child(--s),a=e.child(--i),l=o.nodeSize;if(o==a){t-=l,r-=l;continue}if(!o.sameMarkup(a))return{a:t,b:r};if(o.isText&&o.text!=a.text){let c=0,u=Math.min(o.text.length,a.text.length);for(;c<u&&o.text[o.text.length-c-1]==a.text[a.text.length-c-1];)c++,t--,r--;return{a:t,b:r}}if(o.content.size||a.content.size){let c=Md(o.content,a.content,t-1,r-1);if(c)return c}t-=l,r-=l}}class _{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let r=0;r<e.length;r++)this.size+=e[r].nodeSize}nodesBetween(e,t,r,s=0,i){for(let o=0,a=0;a<t;o++){let l=this.content[o],c=a+l.nodeSize;if(c>e&&r(l,s+a,i||null,o)!==!1&&l.content.size){let u=a+1;l.nodesBetween(Math.max(0,e-u),Math.min(l.content.size,t-u),r,s+u)}a=c}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,r,s){let i="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let c=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?s?typeof s=="function"?s(a):s:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&c||a.isTextblock)&&r&&(o?o=!1:i+=r),i+=c},0),i}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,r=e.firstChild,s=this.content.slice(),i=0;for(t.isText&&t.sameMarkup(r)&&(s[s.length-1]=t.withText(t.text+r.text),i=1);i<e.content.length;i++)s.push(e.content[i]);return new _(s,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let r=[],s=0;if(t>e)for(let i=0,o=0;o<t;i++){let a=this.content[i],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),r.push(a),s+=a.nodeSize),o=l}return new _(r,s)}cutByIndex(e,t){return e==t?_.empty:e==0&&t==this.content.length?this:new _(this.content.slice(e,t))}replaceChild(e,t){let r=this.content[e];if(r==t)return this;let s=this.content.slice(),i=this.size+t.nodeSize-r.nodeSize;return s[e]=t,new _(s,i)}addToStart(e){return new _([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new _(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,r=0;t<this.content.length;t++){let s=this.content[t];e(s,r,t),r+=s.nodeSize}}findDiffStart(e,t=0){return Od(this,e,t)}findDiffEnd(e,t=this.size,r=e.size){return Md(this,e,t,r)}findIndex(e){if(e==0)return ws(0,e);if(e==this.size)return ws(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let t=0,r=0;;t++){let s=this.child(t),i=r+s.nodeSize;if(i>=e)return i==e?ws(t+1,i):ws(t,r);r=i}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return _.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new _(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return _.empty;let t,r=0;for(let s=0;s<e.length;s++){let i=e[s];r+=i.nodeSize,s&&i.isText&&e[s-1].sameMarkup(i)?(t||(t=e.slice(0,s)),t[t.length-1]=i.withText(t[t.length-1].text+i.text)):t&&t.push(i)}return new _(t||e,r)}static from(e){if(!e)return _.empty;if(e instanceof _)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new _([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}_.empty=new _([],0);const _o={index:0,offset:0};function ws(n,e){return _o.index=n,_o.offset=e,_o}function qs(n,e){if(n===e)return!0;if(!(n&&typeof n=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(n);if(Array.isArray(e)!=t)return!1;if(t){if(n.length!=e.length)return!1;for(let r=0;r<n.length;r++)if(!qs(n[r],e[r]))return!1}else{for(let r in n)if(!(r in e)||!qs(n[r],e[r]))return!1;for(let r in e)if(!(r in n))return!1}return!0}let Y=class ga{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,r=!1;for(let s=0;s<e.length;s++){let i=e[s];if(this.eq(i))return e;if(this.type.excludes(i.type))t||(t=e.slice(0,s));else{if(i.type.excludes(this.type))return e;!r&&i.type.rank>this.type.rank&&(t||(t=e.slice(0,s)),t.push(this),r=!0),t&&t.push(i)}}return t||(t=e.slice()),r||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&qs(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let r=e.marks[t.type];if(!r)throw new RangeError(`There is no mark type ${t.type} in this schema`);let s=r.create(t.attrs);return r.checkAttrs(s.attrs),s}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++)if(!e[r].eq(t[r]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return ga.none;if(e instanceof ga)return[e];let t=e.slice();return t.sort((r,s)=>r.type.rank-s.type.rank),t}};Y.none=[];class Ws extends Error{}class A{constructor(e,t,r){this.content=e,this.openStart=t,this.openEnd=r}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let r=Nd(this.content,e+this.openStart,t);return r&&new A(r,this.openStart,this.openEnd)}removeBetween(e,t){return new A(Id(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return A.empty;let r=t.openStart||0,s=t.openEnd||0;if(typeof r!="number"||typeof s!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new A(_.fromJSON(e,t.content),r,s)}static maxOpen(e,t=!0){let r=0,s=0;for(let i=e.firstChild;i&&!i.isLeaf&&(t||!i.type.spec.isolating);i=i.firstChild)r++;for(let i=e.lastChild;i&&!i.isLeaf&&(t||!i.type.spec.isolating);i=i.lastChild)s++;return new A(e,r,s)}}A.empty=new A(_.empty,0,0);function Id(n,e,t){let{index:r,offset:s}=n.findIndex(e),i=n.maybeChild(r),{index:o,offset:a}=n.findIndex(t);if(s==e||i.isText){if(a!=t&&!n.child(o).isText)throw new RangeError("Removing non-flat range");return n.cut(0,e).append(n.cut(t))}if(r!=o)throw new RangeError("Removing non-flat range");return n.replaceChild(r,i.copy(Id(i.content,e-s-1,t-s-1)))}function Nd(n,e,t,r){let{index:s,offset:i}=n.findIndex(e),o=n.maybeChild(s);if(i==e||o.isText)return r&&!r.canReplace(s,s,t)?null:n.cut(0,e).append(t).append(n.cut(e));let a=Nd(o.content,e-i-1,t,o);return a&&n.replaceChild(s,o.copy(a))}function Cb(n,e,t){if(t.openStart>n.depth)throw new Ws("Inserted content deeper than insertion position");if(n.depth-t.openStart!=e.depth-t.openEnd)throw new Ws("Inconsistent open depths");return Rd(n,e,t,0)}function Rd(n,e,t,r){let s=n.index(r),i=n.node(r);if(s==e.index(r)&&r<n.depth-t.openStart){let o=Rd(n,e,t,r+1);return i.copy(i.content.replaceChild(s,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&n.depth==r&&e.depth==r){let o=n.parent,a=o.content;return _n(o,a.cut(0,n.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=Ab(t,n);return _n(i,$d(n,o,a,e,r))}else return _n(i,Ks(n,e,r))}function Pd(n,e){if(!e.type.compatibleContent(n.type))throw new Ws("Cannot join "+e.type.name+" onto "+n.type.name)}function ya(n,e,t){let r=n.node(t);return Pd(r,e.node(t)),r}function Sn(n,e){let t=e.length-1;t>=0&&n.isText&&n.sameMarkup(e[t])?e[t]=n.withText(e[t].text+n.text):e.push(n)}function Cr(n,e,t,r){let s=(e||n).node(t),i=0,o=e?e.index(t):s.childCount;n&&(i=n.index(t),n.depth>t?i++:n.textOffset&&(Sn(n.nodeAfter,r),i++));for(let a=i;a<o;a++)Sn(s.child(a),r);e&&e.depth==t&&e.textOffset&&Sn(e.nodeBefore,r)}function _n(n,e){return n.type.checkContent(e),n.copy(e)}function $d(n,e,t,r,s){let i=n.depth>s&&ya(n,e,s+1),o=r.depth>s&&ya(t,r,s+1),a=[];return Cr(null,n,s,a),i&&o&&e.index(s)==t.index(s)?(Pd(i,o),Sn(_n(i,$d(n,e,t,r,s+1)),a)):(i&&Sn(_n(i,Ks(n,e,s+1)),a),Cr(e,t,s,a),o&&Sn(_n(o,Ks(t,r,s+1)),a)),Cr(r,null,s,a),new _(a)}function Ks(n,e,t){let r=[];if(Cr(null,n,t,r),n.depth>t){let s=ya(n,e,t+1);Sn(_n(s,Ks(n,e,t+1)),r)}return Cr(e,null,t,r),new _(r)}function Ab(n,e){let t=e.depth-n.openStart,s=e.node(t).copy(n.content);for(let i=t-1;i>=0;i--)s=e.node(i).copy(_.from(s));return{start:s.resolveNoCache(n.openStart+t),end:s.resolveNoCache(s.content.size-n.openEnd-t)}}class qr{constructor(e,t,r){this.pos=e,this.path=t,this.parentOffset=r,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let r=this.pos-this.path[this.path.length-1],s=e.child(t);return r?e.child(t).cut(r):s}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let r=this.path[t*3],s=t==0?0:this.path[t*3-1]+1;for(let i=0;i<e;i++)s+=r.child(i).nodeSize;return s}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return Y.none;if(this.textOffset)return e.child(t).marks;let r=e.maybeChild(t-1),s=e.maybeChild(t);if(!r){let a=r;r=s,s=a}let i=r.marks;for(var o=0;o<i.length;o++)i[o].type.spec.inclusive===!1&&(!s||!i[o].isInSet(s.marks))&&(i=i[o--].removeFromSet(i));return i}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let r=t.marks,s=e.parent.maybeChild(e.index());for(var i=0;i<r.length;i++)r[i].type.spec.inclusive===!1&&(!s||!r[i].isInSet(s.marks))&&(r=r[i--].removeFromSet(r));return r}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let r=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);r>=0;r--)if(e.pos<=this.end(r)&&(!t||t(this.node(r))))return new Js(this,e,r);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let r=[],s=0,i=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(i),c=i-l;if(r.push(o,a,s+l),!c||(o=o.child(a),o.isText))break;i=c-1,s+=l+1}return new qr(t,r,i)}static resolveCached(e,t){let r=Tc.get(e);if(r)for(let i=0;i<r.elts.length;i++){let o=r.elts[i];if(o.pos==t)return o}else Tc.set(e,r=new Ob);let s=r.elts[r.i]=qr.resolve(e,t);return r.i=(r.i+1)%Mb,s}}class Ob{constructor(){this.elts=[],this.i=0}}const Mb=12,Tc=new WeakMap;class Js{constructor(e,t,r){this.$from=e,this.$to=t,this.depth=r}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const Ib=Object.create(null);class nt{constructor(e,t,r,s=Y.none){this.type=e,this.attrs=t,this.marks=s,this.content=r||_.empty}get children(){return this.content.content}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,r,s=0){this.content.nodesBetween(e,t,r,s,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,r,s){return this.content.textBetween(e,t,r,s)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,r){return this.type==e&&qs(this.attrs,t||e.defaultAttrs||Ib)&&Y.sameSet(this.marks,r||Y.none)}copy(e=null){return e==this.content?this:new nt(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new nt(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,r=!1){if(e==t)return A.empty;let s=this.resolve(e),i=this.resolve(t),o=r?0:s.sharedDepth(t),a=s.start(o),c=s.node(o).content.cut(s.pos-a,i.pos-a);return new A(c,s.depth-o,i.depth-o)}replace(e,t,r){return Cb(this.resolve(e),this.resolve(t),r)}nodeAt(e){for(let t=this;;){let{index:r,offset:s}=t.content.findIndex(e);if(t=t.maybeChild(r),!t)return null;if(s==e||t.isText)return t;e-=s+1}}childAfter(e){let{index:t,offset:r}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:r}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:r}=this.content.findIndex(e);if(r<e)return{node:this.content.child(t),index:t,offset:r};let s=this.content.child(t-1);return{node:s,index:t-1,offset:r-s.nodeSize}}resolve(e){return qr.resolveCached(this,e)}resolveNoCache(e){return qr.resolve(this,e)}rangeHasMark(e,t,r){let s=!1;return t>e&&this.nodesBetween(e,t,i=>(r.isInSet(i.marks)&&(s=!0),!s)),s}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),Dd(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,r=_.empty,s=0,i=r.childCount){let o=this.contentMatchAt(e).matchFragment(r,s,i),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=s;l<i;l++)if(!this.type.allowsMarks(r.child(l).marks))return!1;return!0}canReplaceWith(e,t,r,s){if(s&&!this.type.allowsMarks(s))return!1;let i=this.contentMatchAt(e).matchType(r),o=i&&i.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=Y.none;for(let t=0;t<this.marks.length;t++){let r=this.marks[t];r.type.checkAttrs(r.attrs),e=r.addToSet(e)}if(!Y.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let r;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");r=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,r)}let s=_.fromJSON(e,t.content),i=e.nodeType(t.type).create(t.attrs,s,r);return i.type.checkAttrs(i.attrs),i}}nt.prototype.text=void 0;class Gs extends nt{constructor(e,t,r,s){if(super(e,t,null,s),!r)throw new RangeError("Empty text nodes are not allowed");this.text=r}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):Dd(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Gs(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Gs(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function Dd(n,e){for(let t=n.length-1;t>=0;t--)e=n[t].type.name+"("+e+")";return e}class An{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let r=new Nb(e,t);if(r.next==null)return An.empty;let s=jd(r);r.next&&r.err("Unexpected trailing text");let i=Bb(Lb(s));return zb(i,r),i}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,r=e.childCount){let s=this;for(let i=t;s&&i<r;i++)s=s.matchType(e.child(i).type);return s}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let r=0;r<e.next.length;r++)if(this.next[t].type==e.next[r].type)return!0;return!1}fillBefore(e,t=!1,r=0){let s=[this];function i(o,a){let l=o.matchFragment(e,r);if(l&&(!t||l.validEnd))return _.from(a.map(c=>c.createAndFill()));for(let c=0;c<o.next.length;c++){let{type:u,next:d}=o.next[c];if(!(u.isText||u.hasRequiredAttrs())&&s.indexOf(d)==-1){s.push(d);let h=i(d,a.concat(u));if(h)return h}}return null}return i(this,[])}findWrapping(e){for(let r=0;r<this.wrapCache.length;r+=2)if(this.wrapCache[r]==e)return this.wrapCache[r+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),r=[{match:this,type:null,via:null}];for(;r.length;){let s=r.shift(),i=s.match;if(i.matchType(e)){let o=[];for(let a=s;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<i.next.length;o++){let{type:a,next:l}=i.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!s.type||l.validEnd)&&(r.push({match:a.contentMatch,type:a,via:s}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(r){e.push(r);for(let s=0;s<r.next.length;s++)e.indexOf(r.next[s].next)==-1&&t(r.next[s].next)}return t(this),e.map((r,s)=>{let i=s+(r.validEnd?"*":" ")+" ";for(let o=0;o<r.next.length;o++)i+=(o?", ":"")+r.next[o].type.name+"->"+e.indexOf(r.next[o].next);return i}).join(`
`)}}An.empty=new An(!0);class Nb{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function jd(n){let e=[];do e.push(Rb(n));while(n.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function Rb(n){let e=[];do e.push(Pb(n));while(n.next&&n.next!=")"&&n.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function Pb(n){let e=jb(n);for(;;)if(n.eat("+"))e={type:"plus",expr:e};else if(n.eat("*"))e={type:"star",expr:e};else if(n.eat("?"))e={type:"opt",expr:e};else if(n.eat("{"))e=$b(n,e);else break;return e}function Ec(n){/\D/.test(n.next)&&n.err("Expected number, got '"+n.next+"'");let e=Number(n.next);return n.pos++,e}function $b(n,e){let t=Ec(n),r=t;return n.eat(",")&&(n.next!="}"?r=Ec(n):r=-1),n.eat("}")||n.err("Unclosed braced range"),{type:"range",min:t,max:r,expr:e}}function Db(n,e){let t=n.nodeTypes,r=t[e];if(r)return[r];let s=[];for(let i in t){let o=t[i];o.isInGroup(e)&&s.push(o)}return s.length==0&&n.err("No node type or group '"+e+"' found"),s}function jb(n){if(n.eat("(")){let e=jd(n);return n.eat(")")||n.err("Missing closing paren"),e}else if(/\W/.test(n.next))n.err("Unexpected token '"+n.next+"'");else{let e=Db(n,n.next).map(t=>(n.inline==null?n.inline=t.isInline:n.inline!=t.isInline&&n.err("Mixing inline and block content"),{type:"name",value:t}));return n.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function Lb(n){let e=[[]];return s(i(n,0),t()),e;function t(){return e.push([])-1}function r(o,a,l){let c={term:l,to:a};return e[o].push(c),c}function s(o,a){o.forEach(l=>l.to=a)}function i(o,a){if(o.type=="choice")return o.exprs.reduce((l,c)=>l.concat(i(c,a)),[]);if(o.type=="seq")for(let l=0;;l++){let c=i(o.exprs[l],a);if(l==o.exprs.length-1)return c;s(c,a=t())}else if(o.type=="star"){let l=t();return r(a,l),s(i(o.expr,l),l),[r(l)]}else if(o.type=="plus"){let l=t();return s(i(o.expr,a),l),s(i(o.expr,l),l),[r(l)]}else{if(o.type=="opt")return[r(a)].concat(i(o.expr,a));if(o.type=="range"){let l=a;for(let c=0;c<o.min;c++){let u=t();s(i(o.expr,l),u),l=u}if(o.max==-1)s(i(o.expr,l),l);else for(let c=o.min;c<o.max;c++){let u=t();r(l,u),s(i(o.expr,l),u),l=u}return[r(l)]}else{if(o.type=="name")return[r(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function Ld(n,e){return e-n}function Cc(n,e){let t=[];return r(e),t.sort(Ld);function r(s){let i=n[s];if(i.length==1&&!i[0].term)return r(i[0].to);t.push(s);for(let o=0;o<i.length;o++){let{term:a,to:l}=i[o];!a&&t.indexOf(l)==-1&&r(l)}}}function Bb(n){let e=Object.create(null);return t(Cc(n,0));function t(r){let s=[];r.forEach(o=>{n[o].forEach(({term:a,to:l})=>{if(!a)return;let c;for(let u=0;u<s.length;u++)s[u][0]==a&&(c=s[u][1]);Cc(n,l).forEach(u=>{c||s.push([a,c=[]]),c.indexOf(u)==-1&&c.push(u)})})});let i=e[r.join(",")]=new An(r.indexOf(n.length-1)>-1);for(let o=0;o<s.length;o++){let a=s[o][1].sort(Ld);i.next.push({type:s[o][0],next:e[a.join(",")]||t(a)})}return i}}function zb(n,e){for(let t=0,r=[n];t<r.length;t++){let s=r[t],i=!s.validEnd,o=[];for(let a=0;a<s.next.length;a++){let{type:l,next:c}=s.next[a];o.push(l.name),i&&!(l.isText||l.hasRequiredAttrs())&&(i=!1),r.indexOf(c)==-1&&r.push(c)}i&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function Bd(n){let e=Object.create(null);for(let t in n){let r=n[t];if(!r.hasDefault)return null;e[t]=r.default}return e}function zd(n,e){let t=Object.create(null);for(let r in n){let s=e&&e[r];if(s===void 0){let i=n[r];if(i.hasDefault)s=i.default;else throw new RangeError("No value supplied for attribute "+r)}t[r]=s}return t}function Fd(n,e,t,r){for(let s in e)if(!(s in n))throw new RangeError(`Unsupported attribute ${s} for ${t} of type ${s}`);for(let s in n){let i=n[s];i.validate&&i.validate(e[s])}}function Ud(n,e){let t=Object.create(null);if(e)for(let r in e)t[r]=new Ub(n,r,e[r]);return t}let Ac=class Hd{constructor(e,t,r){this.name=e,this.schema=t,this.spec=r,this.markSet=null,this.groups=r.group?r.group.split(" "):[],this.attrs=Ud(e,r.attrs),this.defaultAttrs=Bd(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(r.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==An.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}isInGroup(e){return this.groups.indexOf(e)>-1}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:zd(this.attrs,e)}create(e=null,t,r){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new nt(this,this.computeAttrs(e),_.from(t),Y.setFrom(r))}createChecked(e=null,t,r){return t=_.from(t),this.checkContent(t),new nt(this,this.computeAttrs(e),t,Y.setFrom(r))}createAndFill(e=null,t,r){if(e=this.computeAttrs(e),t=_.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let s=this.contentMatch.matchFragment(t),i=s&&s.fillBefore(_.empty,!0);return i?new nt(this,e,t.append(i),Y.setFrom(r)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let r=0;r<e.childCount;r++)if(!this.allowsMarks(e.child(r).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){Fd(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let r=0;r<e.length;r++)this.allowsMarkType(e[r].type)?t&&t.push(e[r]):t||(t=e.slice(0,r));return t?t.length?t:Y.none:e}static compile(e,t){let r=Object.create(null);e.forEach((i,o)=>r[i]=new Hd(i,t,o));let s=t.spec.topNode||"doc";if(!r[s])throw new RangeError("Schema is missing its top node type ('"+s+"')");if(!r.text)throw new RangeError("Every schema needs a 'text' type");for(let i in r.text.attrs)throw new RangeError("The text node type should not have attributes");return r}};function Fb(n,e,t){let r=t.split("|");return s=>{let i=s===null?"null":typeof s;if(r.indexOf(i)<0)throw new RangeError(`Expected value of type ${r} for attribute ${e} on type ${n}, got ${i}`)}}class Ub{constructor(e,t,r){this.hasDefault=Object.prototype.hasOwnProperty.call(r,"default"),this.default=r.default,this.validate=typeof r.validate=="string"?Fb(e,t,r.validate):r.validate}get isRequired(){return!this.hasDefault}}class Ji{constructor(e,t,r,s){this.name=e,this.rank=t,this.schema=r,this.spec=s,this.attrs=Ud(e,s.attrs),this.excluded=null;let i=Bd(this.attrs);this.instance=i?new Y(this,i):null}create(e=null){return!e&&this.instance?this.instance:new Y(this,zd(this.attrs,e))}static compile(e,t){let r=Object.create(null),s=0;return e.forEach((i,o)=>r[i]=new Ji(i,s++,t,o)),r}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){Fd(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class Vd{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let s in e)t[s]=e[s];t.nodes=_e.from(e.nodes),t.marks=_e.from(e.marks||{}),this.nodes=Ac.compile(this.spec.nodes,this),this.marks=Ji.compile(this.spec.marks,this);let r=Object.create(null);for(let s in this.nodes){if(s in this.marks)throw new RangeError(s+" can not be both a node and a mark");let i=this.nodes[s],o=i.spec.content||"",a=i.spec.marks;if(i.contentMatch=r[o]||(r[o]=An.parse(o,this.nodes)),i.inlineContent=i.contentMatch.inlineContent,i.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!i.isInline||!i.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=i}i.markSet=a=="_"?null:a?Oc(this,a.split(" ")):a==""||!i.inlineContent?[]:null}for(let s in this.marks){let i=this.marks[s],o=i.spec.excludes;i.excluded=o==null?[i]:o==""?[]:Oc(this,o.split(" "))}this.nodeFromJSON=s=>nt.fromJSON(this,s),this.markFromJSON=s=>Y.fromJSON(this,s),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,r,s){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof Ac){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,r,s)}text(e,t){let r=this.nodes.text;return new Gs(r,r.defaultAttrs,e,Y.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Oc(n,e){let t=[];for(let r=0;r<e.length;r++){let s=e[r],i=n.marks[s],o=i;if(i)t.push(i);else for(let a in n.marks){let l=n.marks[a];(s=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(s)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[r]+"'")}return t}function Hb(n){return n.tag!=null}function Vb(n){return n.style!=null}class Jt{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let r=this.matchedStyles=[];t.forEach(s=>{if(Hb(s))this.tags.push(s);else if(Vb(s)){let i=/[^=]*/.exec(s.style)[0];r.indexOf(i)<0&&r.push(i),this.styles.push(s)}}),this.normalizeLists=!this.tags.some(s=>{if(!/^(ul|ol)\b/.test(s.tag)||!s.node)return!1;let i=e.nodes[s.node];return i.contentMatch.matchType(i)})}parse(e,t={}){let r=new Ic(this,t,!1);return r.addAll(e,Y.none,t.from,t.to),r.finish()}parseSlice(e,t={}){let r=new Ic(this,t,!0);return r.addAll(e,Y.none,t.from,t.to),A.maxOpen(r.finish())}matchTag(e,t,r){for(let s=r?this.tags.indexOf(r)+1:0;s<this.tags.length;s++){let i=this.tags[s];if(Kb(e,i.tag)&&(i.namespace===void 0||e.namespaceURI==i.namespace)&&(!i.context||t.matchesContext(i.context))){if(i.getAttrs){let o=i.getAttrs(e);if(o===!1)continue;i.attrs=o||void 0}return i}}}matchStyle(e,t,r,s){for(let i=s?this.styles.indexOf(s)+1:0;i<this.styles.length;i++){let o=this.styles[i],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!r.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function r(s){let i=s.priority==null?50:s.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<i)break}t.splice(o,0,s)}for(let s in e.marks){let i=e.marks[s].spec.parseDOM;i&&i.forEach(o=>{r(o=Nc(o)),o.mark||o.ignore||o.clearMark||(o.mark=s)})}for(let s in e.nodes){let i=e.nodes[s].spec.parseDOM;i&&i.forEach(o=>{r(o=Nc(o)),o.node||o.ignore||o.mark||(o.node=s)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new Jt(e,Jt.schemaRules(e)))}}const qd={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},qb={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Wd={ol:!0,ul:!0},Wr=1,ba=2,Ar=4;function Mc(n,e,t){return e!=null?(e?Wr:0)|(e==="full"?ba:0):n&&n.whitespace=="pre"?Wr|ba:t&~Ar}class vs{constructor(e,t,r,s,i,o){this.type=e,this.attrs=t,this.marks=r,this.solid=s,this.options=o,this.content=[],this.activeMarks=Y.none,this.match=i||(o&Ar?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(_.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let r=this.type.contentMatch,s;return(s=r.findWrapping(e.type))?(this.match=r,s):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&Wr)){let r=this.content[this.content.length-1],s;if(r&&r.isText&&(s=/[ \t\r\n\u000c]+$/.exec(r.text))){let i=r;r.text.length==s[0].length?this.content.pop():this.content[this.content.length-1]=i.withText(i.text.slice(0,i.text.length-s[0].length))}}let t=_.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(_.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!qd.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class Ic{constructor(e,t,r){this.parser=e,this.options=t,this.isOpen=r,this.open=0,this.localPreserveWS=!1;let s=t.topNode,i,o=Mc(null,t.preserveWhitespace,0)|(r?Ar:0);s?i=new vs(s.type,s.attrs,Y.none,!0,t.topMatch||s.type.contentMatch,o):r?i=new vs(null,null,Y.none,!0,null,o):i=new vs(e.schema.topNodeType,null,Y.none,!0,null,o),this.nodes=[i],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e,t){e.nodeType==3?this.addTextNode(e,t):e.nodeType==1&&this.addElement(e,t)}addTextNode(e,t){let r=e.nodeValue,s=this.top,i=s.options&ba?"full":this.localPreserveWS||(s.options&Wr)>0,{schema:o}=this.parser;if(i==="full"||s.inlineContext(e)||/[^ \t\r\n\u000c]/.test(r)){if(i)if(i==="full")r=r.replace(/\r\n?/g,`
`);else if(o.linebreakReplacement&&/[\r\n]/.test(r)&&this.top.findWrapping(o.linebreakReplacement.create())){let a=r.split(/\r?\n|\r/);for(let l=0;l<a.length;l++)l&&this.insertNode(o.linebreakReplacement.create(),t,!0),a[l]&&this.insertNode(o.text(a[l]),t,!/\S/.test(a[l]));r=""}else r=r.replace(/\r?\n|\r/g," ");else if(r=r.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(r)&&this.open==this.nodes.length-1){let a=s.content[s.content.length-1],l=e.previousSibling;(!a||l&&l.nodeName=="BR"||a.isText&&/[ \t\r\n\u000c]$/.test(a.text))&&(r=r.slice(1))}r&&this.insertNode(o.text(r),t,!/\S/.test(r)),this.findInText(e)}else this.findInside(e)}addElement(e,t,r){let s=this.localPreserveWS,i=this.top;(e.tagName=="PRE"||/pre/.test(e.style&&e.style.whiteSpace))&&(this.localPreserveWS=!0);let o=e.nodeName.toLowerCase(),a;Wd.hasOwnProperty(o)&&this.parser.normalizeLists&&Wb(e);let l=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(a=this.parser.matchTag(e,this,r));e:if(l?l.ignore:qb.hasOwnProperty(o))this.findInside(e),this.ignoreFallback(e,t);else if(!l||l.skip||l.closeParent){l&&l.closeParent?this.open=Math.max(0,this.open-1):l&&l.skip.nodeType&&(e=l.skip);let c,u=this.needsBlock;if(qd.hasOwnProperty(o))i.content.length&&i.content[0].isInline&&this.open&&(this.open--,i=this.top),c=!0,i.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e,t);break e}let d=l&&l.skip?t:this.readStyles(e,t);d&&this.addAll(e,d),c&&this.sync(i),this.needsBlock=u}else{let c=this.readStyles(e,t);c&&this.addElementByRule(e,l,c,l.consuming===!1?a:void 0)}this.localPreserveWS=s}leafFallback(e,t){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`),t)}ignoreFallback(e,t){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"),t,!0)}readStyles(e,t){let r=e.style;if(r&&r.length)for(let s=0;s<this.parser.matchedStyles.length;s++){let i=this.parser.matchedStyles[s],o=r.getPropertyValue(i);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(i,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?t=t.filter(c=>!l.clearMark(c)):t=t.concat(this.parser.schema.marks[l.mark].create(l.attrs)),l.consuming===!1)a=l;else break}}return t}addElementByRule(e,t,r,s){let i,o;if(t.node)if(o=this.parser.schema.nodes[t.node],o.isLeaf)this.insertNode(o.create(t.attrs),r,e.nodeName=="BR")||this.leafFallback(e,r);else{let l=this.enter(o,t.attrs||null,r,t.preserveWhitespace);l&&(i=!0,r=l)}else{let l=this.parser.schema.marks[t.mark];r=r.concat(l.create(t.attrs))}let a=this.top;if(o&&o.isLeaf)this.findInside(e);else if(s)this.addElement(e,r,s);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l,r,!1));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l,r),this.findAround(e,l,!1)}i&&this.sync(a)&&this.open--}addAll(e,t,r,s){let i=r||0;for(let o=r?e.childNodes[r]:e.firstChild,a=s==null?null:e.childNodes[s];o!=a;o=o.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(o,t);this.findAtPoint(e,i)}findPlace(e,t,r){let s,i;for(let o=this.open,a=0;o>=0;o--){let l=this.nodes[o],c=l.findWrapping(e);if(c&&(!s||s.length>c.length+a)&&(s=c,i=l,!c.length))break;if(l.solid){if(r)break;a+=2}}if(!s)return null;this.sync(i);for(let o=0;o<s.length;o++)t=this.enterInner(s[o],null,t,!1);return t}insertNode(e,t,r){if(e.isInline&&this.needsBlock&&!this.top.type){let i=this.textblockFromContext();i&&(t=this.enterInner(i,null,t))}let s=this.findPlace(e,t,r);if(s){this.closeExtra();let i=this.top;i.match&&(i.match=i.match.matchType(e.type));let o=Y.none;for(let a of s.concat(e.marks))(i.type?i.type.allowsMarkType(a.type):Rc(a.type,e.type))&&(o=a.addToSet(o));return i.content.push(e.mark(o)),!0}return!1}enter(e,t,r,s){let i=this.findPlace(e.create(t),r,!1);return i&&(i=this.enterInner(e,t,r,!0,s)),i}enterInner(e,t,r,s=!1,i){this.closeExtra();let o=this.top;o.match=o.match&&o.match.matchType(e);let a=Mc(e,i,o.options);o.options&Ar&&o.content.length==0&&(a|=Ar);let l=Y.none;return r=r.filter(c=>(o.type?o.type.allowsMarkType(c.type):Rc(c.type,e))?(l=c.addToSet(l),!1):!0),this.nodes.push(new vs(e,t,l,s,null,a)),this.open++,r}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(!!(this.isOpen||this.options.topOpen))}sync(e){for(let t=this.open;t>=0;t--){if(this.nodes[t]==e)return this.open=t,!0;this.localPreserveWS&&(this.nodes[t].options|=Wr)}return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let r=this.nodes[t].content;for(let s=r.length-1;s>=0;s--)e+=r[s].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let r=0;r<this.find.length;r++)this.find[r].node==e&&this.find[r].offset==t&&(this.find[r].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,r){if(e!=t&&this.find)for(let s=0;s<this.find.length;s++)this.find[s].pos==null&&e.nodeType==1&&e.contains(this.find[s].node)&&t.compareDocumentPosition(this.find[s].node)&(r?2:4)&&(this.find[s].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),r=this.options.context,s=!this.isOpen&&(!r||r.parent.type==this.nodes[0].type),i=-(r?r.depth+1:0)+(s?0:1),o=(a,l)=>{for(;a>=0;a--){let c=t[a];if(c==""){if(a==t.length-1||a==0)continue;for(;l>=i;l--)if(o(a-1,l))return!0;return!1}else{let u=l>0||l==0&&s?this.nodes[l].type:r&&l>=i?r.node(l-i).type:null;if(!u||u.name!=c&&!u.isInGroup(c))return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let r=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(r&&r.isTextblock&&r.defaultAttrs)return r}for(let t in this.parser.schema.nodes){let r=this.parser.schema.nodes[t];if(r.isTextblock&&r.defaultAttrs)return r}}}function Wb(n){for(let e=n.firstChild,t=null;e;e=e.nextSibling){let r=e.nodeType==1?e.nodeName.toLowerCase():null;r&&Wd.hasOwnProperty(r)&&t?(t.appendChild(e),e=t):r=="li"?t=e:r&&(t=null)}}function Kb(n,e){return(n.matches||n.msMatchesSelector||n.webkitMatchesSelector||n.mozMatchesSelector).call(n,e)}function Nc(n){let e={};for(let t in n)e[t]=n[t];return e}function Rc(n,e){let t=e.schema.nodes;for(let r in t){let s=t[r];if(!s.allowsMarkType(n))continue;let i=[],o=a=>{i.push(a);for(let l=0;l<a.edgeCount;l++){let{type:c,next:u}=a.edge(l);if(c==e||i.indexOf(u)<0&&o(u))return!0}};if(o(s.contentMatch))return!0}}class Pn{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},r){r||(r=xo(t).createDocumentFragment());let s=r,i=[];return e.forEach(o=>{if(i.length||o.marks.length){let a=0,l=0;for(;a<i.length&&l<o.marks.length;){let c=o.marks[l];if(!this.marks[c.type.name]){l++;continue}if(!c.eq(i[a][0])||c.type.spec.spanning===!1)break;a++,l++}for(;a<i.length;)s=i.pop()[1];for(;l<o.marks.length;){let c=o.marks[l++],u=this.serializeMark(c,o.isInline,t);u&&(i.push([c,s]),s.appendChild(u.dom),s=u.contentDOM||u.dom)}}s.appendChild(this.serializeNodeInner(o,t))}),r}serializeNodeInner(e,t){let{dom:r,contentDOM:s}=Rs(xo(t),this.nodes[e.type.name](e),null,e.attrs);if(s){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,s)}return r}serializeNode(e,t={}){let r=this.serializeNodeInner(e,t);for(let s=e.marks.length-1;s>=0;s--){let i=this.serializeMark(e.marks[s],e.isInline,t);i&&((i.contentDOM||i.dom).appendChild(r),r=i.dom)}return r}serializeMark(e,t,r={}){let s=this.marks[e.type.name];return s&&Rs(xo(r),s(e,t),null,e.attrs)}static renderSpec(e,t,r=null,s){return Rs(e,t,r,s)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new Pn(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=Pc(e.nodes);return t.text||(t.text=r=>r.text),t}static marksFromSchema(e){return Pc(e.marks)}}function Pc(n){let e={};for(let t in n){let r=n[t].spec.toDOM;r&&(e[t]=r)}return e}function xo(n){return n.document||window.document}const $c=new WeakMap;function Jb(n){let e=$c.get(n);return e===void 0&&$c.set(n,e=Gb(n)),e}function Gb(n){let e=null;function t(r){if(r&&typeof r=="object")if(Array.isArray(r))if(typeof r[0]=="string")e||(e=[]),e.push(r);else for(let s=0;s<r.length;s++)t(r[s]);else for(let s in r)t(r[s])}return t(n),e}function Rs(n,e,t,r){if(typeof e=="string")return{dom:n.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let s=e[0],i;if(typeof s!="string")throw new RangeError("Invalid array passed to renderSpec");if(r&&(i=Jb(r))&&i.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=s.indexOf(" ");o>0&&(t=s.slice(0,o),s=s.slice(o+1));let a,l=t?n.createElementNS(t,s):n.createElement(s),c=e[1],u=1;if(c&&typeof c=="object"&&c.nodeType==null&&!Array.isArray(c)){u=2;for(let d in c)if(c[d]!=null){let h=d.indexOf(" ");h>0?l.setAttributeNS(d.slice(0,h),d.slice(h+1),c[d]):d=="style"&&l.style?l.style.cssText=c[d]:l.setAttribute(d,c[d])}}for(let d=u;d<e.length;d++){let h=e[d];if(h===0){if(d<e.length-1||d>u)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:f,contentDOM:m}=Rs(n,h,t,r);if(l.appendChild(f),m){if(a)throw new RangeError("Multiple content holes");a=m}}}return{dom:l,contentDOM:a}}const Kd=65535,Jd=Math.pow(2,16);function Yb(n,e){return n+e*Jd}function Dc(n){return n&Kd}function Xb(n){return(n-(n&Kd))/Jd}const Gd=1,Yd=2,Ps=4,Xd=8;class wa{constructor(e,t,r){this.pos=e,this.delInfo=t,this.recover=r}get deleted(){return(this.delInfo&Xd)>0}get deletedBefore(){return(this.delInfo&(Gd|Ps))>0}get deletedAfter(){return(this.delInfo&(Yd|Ps))>0}get deletedAcross(){return(this.delInfo&Ps)>0}}class Be{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&Be.empty)return Be.empty}recover(e){let t=0,r=Dc(e);if(!this.inverted)for(let s=0;s<r;s++)t+=this.ranges[s*3+2]-this.ranges[s*3+1];return this.ranges[r*3]+t+Xb(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,r){let s=0,i=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let c=this.ranges[a+i],u=this.ranges[a+o],d=l+c;if(e<=d){let h=c?e==l?-1:e==d?1:t:t,f=l+s+(h<0?0:u);if(r)return f;let m=e==(t<0?l:d)?null:Yb(a/3,e-l),g=e==l?Yd:e==d?Gd:Ps;return(t<0?e!=l:e!=d)&&(g|=Xd),new wa(f,g,m)}s+=u-c}return r?e+s:new wa(e+s,0,null)}touches(e,t){let r=0,s=Dc(t),i=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?r:0);if(l>e)break;let c=this.ranges[a+i],u=l+c;if(e<=u&&a==s*3)return!0;r+=this.ranges[a+o]-c}return!1}forEach(e){let t=this.inverted?2:1,r=this.inverted?1:2;for(let s=0,i=0;s<this.ranges.length;s+=3){let o=this.ranges[s],a=o-(this.inverted?i:0),l=o+(this.inverted?0:i),c=this.ranges[s+t],u=this.ranges[s+r];e(a,a+c,l,l+u),i+=u-c}}invert(){return new Be(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?Be.empty:new Be(e<0?[0,-e,0]:[0,0,e])}}Be.empty=new Be([]);class Kr{constructor(e,t,r=0,s=e?e.length:0){this.mirror=t,this.from=r,this.to=s,this._maps=e||[],this.ownData=!(e||t)}get maps(){return this._maps}slice(e=0,t=this.maps.length){return new Kr(this._maps,this.mirror,e,t)}appendMap(e,t){this.ownData||(this._maps=this._maps.slice(),this.mirror=this.mirror&&this.mirror.slice(),this.ownData=!0),this.to=this._maps.push(e),t!=null&&this.setMirror(this._maps.length-1,t)}appendMapping(e){for(let t=0,r=this._maps.length;t<e._maps.length;t++){let s=e.getMirror(t);this.appendMap(e._maps[t],s!=null&&s<t?r+s:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,r=this._maps.length+e._maps.length;t>=0;t--){let s=e.getMirror(t);this.appendMap(e._maps[t].invert(),s!=null&&s>t?r-s-1:void 0)}}invert(){let e=new Kr;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let r=this.from;r<this.to;r++)e=this._maps[r].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,r){let s=0;for(let i=this.from;i<this.to;i++){let o=this._maps[i],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(i);if(l!=null&&l>i&&l<this.to){i=l,e=this._maps[l].recover(a.recover);continue}}s|=a.delInfo,e=a.pos}return r?e:new wa(e,s,null)}}const To=Object.create(null);class Oe{getMap(){return Be.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let r=To[t.stepType];if(!r)throw new RangeError(`No step type ${t.stepType} defined`);return r.fromJSON(e,t)}static jsonID(e,t){if(e in To)throw new RangeError("Duplicate use of step JSON ID "+e);return To[e]=t,t.prototype.jsonID=e,t}}class de{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new de(e,null)}static fail(e){return new de(null,e)}static fromReplace(e,t,r,s){try{return de.ok(e.replace(t,r,s))}catch(i){if(i instanceof Ws)return de.fail(i.message);throw i}}}function il(n,e,t){let r=[];for(let s=0;s<n.childCount;s++){let i=n.child(s);i.content.size&&(i=i.copy(il(i.content,e,i))),i.isInline&&(i=e(i,t,s)),r.push(i)}return _.fromArray(r)}class qt extends Oe{constructor(e,t,r){super(),this.from=e,this.to=t,this.mark=r}apply(e){let t=e.slice(this.from,this.to),r=e.resolve(this.from),s=r.node(r.sharedDepth(this.to)),i=new A(il(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),s),t.openStart,t.openEnd);return de.fromReplace(e,this.from,this.to,i)}invert(){return new tt(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deleted&&r.deleted||t.pos>=r.pos?null:new qt(t.pos,r.pos,this.mark)}merge(e){return e instanceof qt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new qt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new qt(t.from,t.to,e.markFromJSON(t.mark))}}Oe.jsonID("addMark",qt);class tt extends Oe{constructor(e,t,r){super(),this.from=e,this.to=t,this.mark=r}apply(e){let t=e.slice(this.from,this.to),r=new A(il(t.content,s=>s.mark(this.mark.removeFromSet(s.marks)),e),t.openStart,t.openEnd);return de.fromReplace(e,this.from,this.to,r)}invert(){return new qt(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deleted&&r.deleted||t.pos>=r.pos?null:new tt(t.pos,r.pos,this.mark)}merge(e){return e instanceof tt&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new tt(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new tt(t.from,t.to,e.markFromJSON(t.mark))}}Oe.jsonID("removeMark",tt);class Wt extends Oe{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return de.fail("No node at mark step's position");let r=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return de.fromReplace(e,this.pos,this.pos+1,new A(_.from(r),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let r=this.mark.addToSet(t.marks);if(r.length==t.marks.length){for(let s=0;s<t.marks.length;s++)if(!t.marks[s].isInSet(r))return new Wt(this.pos,t.marks[s]);return new Wt(this.pos,this.mark)}}return new On(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Wt(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new Wt(t.pos,e.markFromJSON(t.mark))}}Oe.jsonID("addNodeMark",Wt);class On extends Oe{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return de.fail("No node at mark step's position");let r=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return de.fromReplace(e,this.pos,this.pos+1,new A(_.from(r),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new Wt(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new On(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new On(t.pos,e.markFromJSON(t.mark))}}Oe.jsonID("removeNodeMark",On);class ye extends Oe{constructor(e,t,r,s=!1){super(),this.from=e,this.to=t,this.slice=r,this.structure=s}apply(e){return this.structure&&va(e,this.from,this.to)?de.fail("Structure replace would overwrite content"):de.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new Be([this.from,this.to-this.from,this.slice.size])}invert(e){return new ye(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deletedAcross&&r.deletedAcross?null:new ye(t.pos,Math.max(t.pos,r.pos),this.slice,this.structure)}merge(e){if(!(e instanceof ye)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?A.empty:new A(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new ye(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?A.empty:new A(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new ye(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new ye(t.from,t.to,A.fromJSON(e,t.slice),!!t.structure)}}Oe.jsonID("replace",ye);class we extends Oe{constructor(e,t,r,s,i,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=r,this.gapTo=s,this.slice=i,this.insert=o,this.structure=a}apply(e){if(this.structure&&(va(e,this.from,this.gapFrom)||va(e,this.gapTo,this.to)))return de.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return de.fail("Gap is not a flat range");let r=this.slice.insertAt(this.insert,t.content);return r?de.fromReplace(e,this.from,this.to,r):de.fail("Content does not fit in gap")}getMap(){return new Be([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new we(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1),s=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),i=this.to==this.gapTo?r.pos:e.map(this.gapTo,1);return t.deletedAcross&&r.deletedAcross||s<t.pos||i>r.pos?null:new we(t.pos,r.pos,s,i,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new we(t.from,t.to,t.gapFrom,t.gapTo,A.fromJSON(e,t.slice),t.insert,!!t.structure)}}Oe.jsonID("replaceAround",we);function va(n,e,t){let r=n.resolve(e),s=t-e,i=r.depth;for(;s>0&&i>0&&r.indexAfter(i)==r.node(i).childCount;)i--,s--;if(s>0){let o=r.node(i).maybeChild(r.indexAfter(i));for(;s>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,s--}}return!1}function Qb(n,e,t,r){let s=[],i=[],o,a;n.doc.nodesBetween(e,t,(l,c,u)=>{if(!l.isInline)return;let d=l.marks;if(!r.isInSet(d)&&u.type.allowsMarkType(r.type)){let h=Math.max(c,e),f=Math.min(c+l.nodeSize,t),m=r.addToSet(d);for(let g=0;g<d.length;g++)d[g].isInSet(m)||(o&&o.to==h&&o.mark.eq(d[g])?o.to=f:s.push(o=new tt(h,f,d[g])));a&&a.to==h?a.to=f:i.push(a=new qt(h,f,r))}}),s.forEach(l=>n.step(l)),i.forEach(l=>n.step(l))}function Zb(n,e,t,r){let s=[],i=0;n.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;i++;let l=null;if(r instanceof Ji){let c=o.marks,u;for(;u=r.isInSet(c);)(l||(l=[])).push(u),c=u.removeFromSet(c)}else r?r.isInSet(o.marks)&&(l=[r]):l=o.marks;if(l&&l.length){let c=Math.min(a+o.nodeSize,t);for(let u=0;u<l.length;u++){let d=l[u],h;for(let f=0;f<s.length;f++){let m=s[f];m.step==i-1&&d.eq(s[f].style)&&(h=m)}h?(h.to=c,h.step=i):s.push({style:d,from:Math.max(a,e),to:c,step:i})}}}),s.forEach(o=>n.step(new tt(o.from,o.to,o.style)))}function ol(n,e,t,r=t.contentMatch,s=!0){let i=n.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<i.childCount;l++){let c=i.child(l),u=a+c.nodeSize,d=r.matchType(c.type);if(!d)o.push(new ye(a,u,A.empty));else{r=d;for(let h=0;h<c.marks.length;h++)t.allowsMarkType(c.marks[h].type)||n.step(new tt(a,u,c.marks[h]));if(s&&c.isText&&t.whitespace!="pre"){let h,f=/\r?\n|\r/g,m;for(;h=f.exec(c.text);)m||(m=new A(_.from(t.schema.text(" ",t.allowedMarks(c.marks))),0,0)),o.push(new ye(a+h.index,a+h.index+h[0].length,m))}}a=u}if(!r.validEnd){let l=r.fillBefore(_.empty,!0);n.replace(a,a,new A(l,0,0))}for(let l=o.length-1;l>=0;l--)n.step(o[l])}function ew(n,e,t){return(e==0||n.canReplace(e,n.childCount))&&(t==n.childCount||n.canReplace(0,t))}function pr(n){let t=n.parent.content.cutByIndex(n.startIndex,n.endIndex);for(let r=n.depth,s=0,i=0;;--r){let o=n.$from.node(r),a=n.$from.index(r)+s,l=n.$to.indexAfter(r)-i;if(r<n.depth&&o.canReplace(a,l,t))return r;if(r==0||o.type.spec.isolating||!ew(o,a,l))break;a&&(s=1),l<o.childCount&&(i=1)}return null}function tw(n,e,t){let{$from:r,$to:s,depth:i}=e,o=r.before(i+1),a=s.after(i+1),l=o,c=a,u=_.empty,d=0;for(let m=i,g=!1;m>t;m--)g||r.index(m)>0?(g=!0,u=_.from(r.node(m).copy(u)),d++):l--;let h=_.empty,f=0;for(let m=i,g=!1;m>t;m--)g||s.after(m+1)<s.end(m)?(g=!0,h=_.from(s.node(m).copy(h)),f++):c++;n.step(new we(l,c,o,a,new A(u.append(h),d,f),u.size-d,!0))}function al(n,e,t=null,r=n){let s=nw(n,e),i=s&&rw(r,e);return i?s.map(jc).concat({type:e,attrs:t}).concat(i.map(jc)):null}function jc(n){return{type:n,attrs:null}}function nw(n,e){let{parent:t,startIndex:r,endIndex:s}=n,i=t.contentMatchAt(r).findWrapping(e);if(!i)return null;let o=i.length?i[0]:e;return t.canReplaceWith(r,s,o)?i:null}function rw(n,e){let{parent:t,startIndex:r,endIndex:s}=n,i=t.child(r),o=e.contentMatch.findWrapping(i.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let c=r;l&&c<s;c++)l=l.matchType(t.child(c).type);return!l||!l.validEnd?null:o}function sw(n,e,t){let r=_.empty;for(let o=t.length-1;o>=0;o--){if(r.size){let a=t[o].type.contentMatch.matchFragment(r);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}r=_.from(t[o].type.create(t[o].attrs,r))}let s=e.start,i=e.end;n.step(new we(s,i,s,i,new A(r,0,0),t.length,!0))}function iw(n,e,t,r,s){if(!r.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let i=n.steps.length;n.doc.nodesBetween(e,t,(o,a)=>{let l=typeof s=="function"?s(o):s;if(o.isTextblock&&!o.hasMarkup(r,l)&&ow(n.doc,n.mapping.slice(i).map(a),r)){let c=null;if(r.schema.linebreakReplacement){let f=r.whitespace=="pre",m=!!r.contentMatch.matchType(r.schema.linebreakReplacement);f&&!m?c=!1:!f&&m&&(c=!0)}c===!1&&Zd(n,o,a,i),ol(n,n.mapping.slice(i).map(a,1),r,void 0,c===null);let u=n.mapping.slice(i),d=u.map(a,1),h=u.map(a+o.nodeSize,1);return n.step(new we(d,h,d+1,h-1,new A(_.from(r.create(l,null,o.marks)),0,0),1,!0)),c===!0&&Qd(n,o,a,i),!1}})}function Qd(n,e,t,r){e.forEach((s,i)=>{if(s.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(s.text);){let l=n.mapping.slice(r).map(t+1+i+o.index);n.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function Zd(n,e,t,r){e.forEach((s,i)=>{if(s.type==s.type.schema.linebreakReplacement){let o=n.mapping.slice(r).map(t+1+i);n.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function ow(n,e,t){let r=n.resolve(e),s=r.index();return r.parent.canReplaceWith(s,s+1,t)}function aw(n,e,t,r,s){let i=n.doc.nodeAt(e);if(!i)throw new RangeError("No node at given position");t||(t=i.type);let o=t.create(r,null,s||i.marks);if(i.isLeaf)return n.replaceWith(e,e+i.nodeSize,o);if(!t.validContent(i.content))throw new RangeError("Invalid content for node type "+t.name);n.step(new we(e,e+i.nodeSize,e+1,e+i.nodeSize-1,new A(_.from(o),0,0),1,!0))}function _t(n,e,t=1,r){let s=n.resolve(e),i=s.depth-t,o=r&&r[r.length-1]||s.parent;if(i<0||s.parent.type.spec.isolating||!s.parent.canReplace(s.index(),s.parent.childCount)||!o.type.validContent(s.parent.content.cutByIndex(s.index(),s.parent.childCount)))return!1;for(let c=s.depth-1,u=t-2;c>i;c--,u--){let d=s.node(c),h=s.index(c);if(d.type.spec.isolating)return!1;let f=d.content.cutByIndex(h,d.childCount),m=r&&r[u+1];m&&(f=f.replaceChild(0,m.type.create(m.attrs)));let g=r&&r[u]||d;if(!d.canReplace(h+1,d.childCount)||!g.type.validContent(f))return!1}let a=s.indexAfter(i),l=r&&r[0];return s.node(i).canReplaceWith(a,a,l?l.type:s.node(i+1).type)}function lw(n,e,t=1,r){let s=n.doc.resolve(e),i=_.empty,o=_.empty;for(let a=s.depth,l=s.depth-t,c=t-1;a>l;a--,c--){i=_.from(s.node(a).copy(i));let u=r&&r[c];o=_.from(u?u.type.create(u.attrs,o):s.node(a).copy(o))}n.step(new ye(e,e,new A(i.append(o),t,t),!0))}function nn(n,e){let t=n.resolve(e),r=t.index();return eh(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(r,r+1)}function cw(n,e){e.content.size||n.type.compatibleContent(e.type);let t=n.contentMatchAt(n.childCount),{linebreakReplacement:r}=n.type.schema;for(let s=0;s<e.childCount;s++){let i=e.child(s),o=i.type==r?n.type.schema.nodes.text:i.type;if(t=t.matchType(o),!t||!n.type.allowsMarks(i.marks))return!1}return t.validEnd}function eh(n,e){return!!(n&&e&&!n.isLeaf&&cw(n,e))}function Gi(n,e,t=-1){let r=n.resolve(e);for(let s=r.depth;;s--){let i,o,a=r.index(s);if(s==r.depth?(i=r.nodeBefore,o=r.nodeAfter):t>0?(i=r.node(s+1),a++,o=r.node(s).maybeChild(a)):(i=r.node(s).maybeChild(a-1),o=r.node(s+1)),i&&!i.isTextblock&&eh(i,o)&&r.node(s).canReplace(a,a+1))return e;if(s==0)break;e=t<0?r.before(s):r.after(s)}}function uw(n,e,t){let r=null,{linebreakReplacement:s}=n.doc.type.schema,i=n.doc.resolve(e-t),o=i.node().type;if(s&&o.inlineContent){let u=o.whitespace=="pre",d=!!o.contentMatch.matchType(s);u&&!d?r=!1:!u&&d&&(r=!0)}let a=n.steps.length;if(r===!1){let u=n.doc.resolve(e+t);Zd(n,u.node(),u.before(),a)}o.inlineContent&&ol(n,e+t-1,o,i.node().contentMatchAt(i.index()),r==null);let l=n.mapping.slice(a),c=l.map(e-t);if(n.step(new ye(c,l.map(e+t,-1),A.empty,!0)),r===!0){let u=n.doc.resolve(c);Qd(n,u.node(),u.before(),n.steps.length)}return n}function dw(n,e,t){let r=n.resolve(e);if(r.parent.canReplaceWith(r.index(),r.index(),t))return e;if(r.parentOffset==0)for(let s=r.depth-1;s>=0;s--){let i=r.index(s);if(r.node(s).canReplaceWith(i,i,t))return r.before(s+1);if(i>0)return null}if(r.parentOffset==r.parent.content.size)for(let s=r.depth-1;s>=0;s--){let i=r.indexAfter(s);if(r.node(s).canReplaceWith(i,i,t))return r.after(s+1);if(i<r.node(s).childCount)return null}return null}function th(n,e,t){let r=n.resolve(e);if(!t.content.size)return e;let s=t.content;for(let i=0;i<t.openStart;i++)s=s.firstChild.content;for(let i=1;i<=(t.openStart==0&&t.size?2:1);i++)for(let o=r.depth;o>=0;o--){let a=o==r.depth?0:r.pos<=(r.start(o+1)+r.end(o+1))/2?-1:1,l=r.index(o)+(a>0?1:0),c=r.node(o),u=!1;if(i==1)u=c.canReplace(l,l,s);else{let d=c.contentMatchAt(l).findWrapping(s.firstChild.type);u=d&&c.canReplaceWith(l,l,d[0])}if(u)return a==0?r.pos:a<0?r.before(o+1):r.after(o+1)}return null}function Yi(n,e,t=e,r=A.empty){if(e==t&&!r.size)return null;let s=n.resolve(e),i=n.resolve(t);return nh(s,i,r)?new ye(e,t,r):new hw(s,i,r).fit()}function nh(n,e,t){return!t.openStart&&!t.openEnd&&n.start()==e.start()&&n.parent.canReplace(n.index(),e.index(),t.content)}class hw{constructor(e,t,r){this.$from=e,this.$to=t,this.unplaced=r,this.frontier=[],this.placed=_.empty;for(let s=0;s<=e.depth;s++){let i=e.node(s);this.frontier.push({type:i.type,match:i.contentMatchAt(e.indexAfter(s))})}for(let s=e.depth;s>0;s--)this.placed=_.from(e.node(s).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let c=this.findFittable();c?this.placeNodes(c):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,r=this.$from,s=this.close(e<0?this.$to:r.doc.resolve(e));if(!s)return null;let i=this.placed,o=r.depth,a=s.depth;for(;o&&a&&i.childCount==1;)i=i.firstChild.content,o--,a--;let l=new A(i,o,a);return e>-1?new we(r.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||r.pos!=this.$to.pos?new ye(r.pos,s.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,r=0,s=this.unplaced.openEnd;r<e;r++){let i=t.firstChild;if(t.childCount>1&&(s=0),i.type.spec.isolating&&s<=r){e=r;break}t=i.content}for(let t=1;t<=2;t++)for(let r=t==1?e:this.unplaced.openStart;r>=0;r--){let s,i=null;r?(i=Eo(this.unplaced.content,r-1).firstChild,s=i.content):s=this.unplaced.content;let o=s.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:c}=this.frontier[a],u,d=null;if(t==1&&(o?c.matchType(o.type)||(d=c.fillBefore(_.from(o),!1)):i&&l.compatibleContent(i.type)))return{sliceDepth:r,frontierDepth:a,parent:i,inject:d};if(t==2&&o&&(u=c.findWrapping(o.type)))return{sliceDepth:r,frontierDepth:a,parent:i,wrap:u};if(i&&c.matchType(i.type))break}}}openMore(){let{content:e,openStart:t,openEnd:r}=this.unplaced,s=Eo(e,t);return!s.childCount||s.firstChild.isLeaf?!1:(this.unplaced=new A(e,t+1,Math.max(r,s.size+t>=e.size-r?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:r}=this.unplaced,s=Eo(e,t);if(s.childCount<=1&&t>0){let i=e.size-t<=t+s.size;this.unplaced=new A(kr(e,t-1,1),t-1,i?t-1:r)}else this.unplaced=new A(kr(e,t,1),t,r)}placeNodes({sliceDepth:e,frontierDepth:t,parent:r,inject:s,wrap:i}){for(;this.depth>t;)this.closeFrontierNode();if(i)for(let g=0;g<i.length;g++)this.openFrontierNode(i[g]);let o=this.unplaced,a=r?r.content:o.content,l=o.openStart-e,c=0,u=[],{match:d,type:h}=this.frontier[t];if(s){for(let g=0;g<s.childCount;g++)u.push(s.child(g));d=d.matchFragment(s)}let f=a.size+e-(o.content.size-o.openEnd);for(;c<a.childCount;){let g=a.child(c),y=d.matchType(g.type);if(!y)break;c++,(c>1||l==0||g.content.size)&&(d=y,u.push(rh(g.mark(h.allowedMarks(g.marks)),c==1?l:0,c==a.childCount?f:-1)))}let m=c==a.childCount;m||(f=-1),this.placed=Sr(this.placed,t,_.from(u)),this.frontier[t].match=d,m&&f<0&&r&&r.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let g=0,y=a;g<f;g++){let b=y.lastChild;this.frontier.push({type:b.type,match:b.contentMatchAt(b.childCount)}),y=b.content}this.unplaced=m?e==0?A.empty:new A(kr(o.content,e-1,1),e-1,f<0?o.openEnd:e-1):new A(kr(o.content,e,c),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!Co(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:r}=this.$to,s=this.$to.after(r);for(;r>1&&s==this.$to.end(--r);)++s;return s}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:r,type:s}=this.frontier[t],i=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=Co(e,t,s,r,i);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:c}=this.frontier[a],u=Co(e,a,c,l,!0);if(!u||u.childCount)continue e}return{depth:t,fit:o,move:i?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=Sr(this.placed,t.depth,t.fit)),e=t.move;for(let r=t.depth+1;r<=e.depth;r++){let s=e.node(r),i=s.type.contentMatch.fillBefore(s.content,!0,e.index(r));this.openFrontierNode(s.type,s.attrs,i)}return e}openFrontierNode(e,t=null,r){let s=this.frontier[this.depth];s.match=s.match.matchType(e),this.placed=Sr(this.placed,this.depth,_.from(e.create(t,r))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(_.empty,!0);t.childCount&&(this.placed=Sr(this.placed,this.frontier.length,t))}}function kr(n,e,t){return e==0?n.cutByIndex(t,n.childCount):n.replaceChild(0,n.firstChild.copy(kr(n.firstChild.content,e-1,t)))}function Sr(n,e,t){return e==0?n.append(t):n.replaceChild(n.childCount-1,n.lastChild.copy(Sr(n.lastChild.content,e-1,t)))}function Eo(n,e){for(let t=0;t<e;t++)n=n.firstChild.content;return n}function rh(n,e,t){if(e<=0)return n;let r=n.content;return e>1&&(r=r.replaceChild(0,rh(r.firstChild,e-1,r.childCount==1?t-1:0))),e>0&&(r=n.type.contentMatch.fillBefore(r).append(r),t<=0&&(r=r.append(n.type.contentMatch.matchFragment(r).fillBefore(_.empty,!0)))),n.copy(r)}function Co(n,e,t,r,s){let i=n.node(e),o=s?n.indexAfter(e):n.index(e);if(o==i.childCount&&!t.compatibleContent(i.type))return null;let a=r.fillBefore(i.content,!0,o);return a&&!fw(t,i.content,o)?a:null}function fw(n,e,t){for(let r=t;r<e.childCount;r++)if(!n.allowsMarks(e.child(r).marks))return!0;return!1}function pw(n){return n.spec.defining||n.spec.definingForContent}function mw(n,e,t,r){if(!r.size)return n.deleteRange(e,t);let s=n.doc.resolve(e),i=n.doc.resolve(t);if(nh(s,i,r))return n.step(new ye(e,t,r));let o=ih(s,i);o[o.length-1]==0&&o.pop();let a=-(s.depth+1);o.unshift(a);for(let h=s.depth,f=s.pos-1;h>0;h--,f--){let m=s.node(h).type.spec;if(m.defining||m.definingAsContext||m.isolating)break;o.indexOf(h)>-1?a=h:s.before(h)==f&&o.splice(1,0,-h)}let l=o.indexOf(a),c=[],u=r.openStart;for(let h=r.content,f=0;;f++){let m=h.firstChild;if(c.push(m),f==r.openStart)break;h=m.content}for(let h=u-1;h>=0;h--){let f=c[h],m=pw(f.type);if(m&&!f.sameMarkup(s.node(Math.abs(a)-1)))u=h;else if(m||!f.type.isTextblock)break}for(let h=r.openStart;h>=0;h--){let f=(h+u+1)%(r.openStart+1),m=c[f];if(m)for(let g=0;g<o.length;g++){let y=o[(g+l)%o.length],b=!0;y<0&&(b=!1,y=-y);let v=s.node(y-1),w=s.index(y-1);if(v.canReplaceWith(w,w,m.type,m.marks))return n.replace(s.before(y),b?i.after(y):t,new A(sh(r.content,0,r.openStart,f),f,r.openEnd))}}let d=n.steps.length;for(let h=o.length-1;h>=0&&(n.replace(e,t,r),!(n.steps.length>d));h--){let f=o[h];f<0||(e=s.before(f),t=i.after(f))}}function sh(n,e,t,r,s){if(e<t){let i=n.firstChild;n=n.replaceChild(0,i.copy(sh(i.content,e+1,t,r,i)))}if(e>r){let i=s.contentMatchAt(0),o=i.fillBefore(n).append(n);n=o.append(i.matchFragment(o).fillBefore(_.empty,!0))}return n}function gw(n,e,t,r){if(!r.isInline&&e==t&&n.doc.resolve(e).parent.content.size){let s=dw(n.doc,e,r.type);s!=null&&(e=t=s)}n.replaceRange(e,t,new A(_.from(r),0,0))}function yw(n,e,t){let r=n.doc.resolve(e),s=n.doc.resolve(t),i=ih(r,s);for(let o=0;o<i.length;o++){let a=i[o],l=o==i.length-1;if(l&&a==0||r.node(a).type.contentMatch.validEnd)return n.delete(r.start(a),s.end(a));if(a>0&&(l||r.node(a-1).canReplace(r.index(a-1),s.indexAfter(a-1))))return n.delete(r.before(a),s.after(a))}for(let o=1;o<=r.depth&&o<=s.depth;o++)if(e-r.start(o)==r.depth-o&&t>r.end(o)&&s.end(o)-t!=s.depth-o&&r.start(o-1)==s.start(o-1)&&r.node(o-1).canReplace(r.index(o-1),s.index(o-1)))return n.delete(r.before(o),t);n.delete(e,t)}function ih(n,e){let t=[],r=Math.min(n.depth,e.depth);for(let s=r;s>=0;s--){let i=n.start(s);if(i<n.pos-(n.depth-s)||e.end(s)>e.pos+(e.depth-s)||n.node(s).type.spec.isolating||e.node(s).type.spec.isolating)break;(i==e.start(s)||s==n.depth&&s==e.depth&&n.parent.inlineContent&&e.parent.inlineContent&&s&&e.start(s-1)==i-1)&&t.push(s)}return t}class tr extends Oe{constructor(e,t,r){super(),this.pos=e,this.attr=t,this.value=r}apply(e){let t=e.nodeAt(this.pos);if(!t)return de.fail("No node at attribute step's position");let r=Object.create(null);for(let i in t.attrs)r[i]=t.attrs[i];r[this.attr]=this.value;let s=t.type.create(r,null,t.marks);return de.fromReplace(e,this.pos,this.pos+1,new A(_.from(s),0,t.isLeaf?0:1))}getMap(){return Be.empty}invert(e){return new tr(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new tr(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new tr(t.pos,t.attr,t.value)}}Oe.jsonID("attr",tr);class Jr extends Oe{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let s in e.attrs)t[s]=e.attrs[s];t[this.attr]=this.value;let r=e.type.create(t,e.content,e.marks);return de.ok(r)}getMap(){return Be.empty}invert(e){return new Jr(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new Jr(t.attr,t.value)}}Oe.jsonID("docAttr",Jr);let ir=class extends Error{};ir=function n(e){let t=Error.call(this,e);return t.__proto__=n.prototype,t};ir.prototype=Object.create(Error.prototype);ir.prototype.constructor=ir;ir.prototype.name="TransformError";class oh{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new Kr}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new ir(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,r=A.empty){let s=Yi(this.doc,e,t,r);return s&&this.step(s),this}replaceWith(e,t,r){return this.replace(e,t,new A(_.from(r),0,0))}delete(e,t){return this.replace(e,t,A.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,r){return mw(this,e,t,r),this}replaceRangeWith(e,t,r){return gw(this,e,t,r),this}deleteRange(e,t){return yw(this,e,t),this}lift(e,t){return tw(this,e,t),this}join(e,t=1){return uw(this,e,t),this}wrap(e,t){return sw(this,e,t),this}setBlockType(e,t=e,r,s=null){return iw(this,e,t,r,s),this}setNodeMarkup(e,t,r=null,s){return aw(this,e,t,r,s),this}setNodeAttribute(e,t,r){return this.step(new tr(e,t,r)),this}setDocAttribute(e,t){return this.step(new Jr(e,t)),this}addNodeMark(e,t){return this.step(new Wt(e,t)),this}removeNodeMark(e,t){let r=this.doc.nodeAt(e);if(!r)throw new RangeError("No node at position "+e);if(t instanceof Y)t.isInSet(r.marks)&&this.step(new On(e,t));else{let s=r.marks,i,o=[];for(;i=t.isInSet(s);)o.push(new On(e,i)),s=i.removeFromSet(s);for(let a=o.length-1;a>=0;a--)this.step(o[a])}return this}split(e,t=1,r){return lw(this,e,t,r),this}addMark(e,t,r){return Qb(this,e,t,r),this}removeMark(e,t,r){return Zb(this,e,t,r),this}clearIncompatible(e,t,r){return ol(this,e,t,r),this}}const Ao=Object.create(null);class F{constructor(e,t,r){this.$anchor=e,this.$head=t,this.ranges=r||[new bw(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=A.empty){let r=t.content.lastChild,s=null;for(let a=0;a<t.openEnd;a++)s=r,r=r.lastChild;let i=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:c}=o[a],u=e.mapping.slice(i);e.replaceRange(u.map(l.pos),u.map(c.pos),a?A.empty:t),a==0&&zc(e,i,(r?r.isInline:s&&s.isTextblock)?-1:1)}}replaceWith(e,t){let r=e.steps.length,s=this.ranges;for(let i=0;i<s.length;i++){let{$from:o,$to:a}=s[i],l=e.mapping.slice(r),c=l.map(o.pos),u=l.map(a.pos);i?e.deleteRange(c,u):(e.replaceRangeWith(c,u,t),zc(e,r,t.isInline?-1:1))}}static findFrom(e,t,r=!1){let s=e.parent.inlineContent?new j(e):Wn(e.node(0),e.parent,e.pos,e.index(),t,r);if(s)return s;for(let i=e.depth-1;i>=0;i--){let o=t<0?Wn(e.node(0),e.node(i),e.before(i+1),e.index(i),t,r):Wn(e.node(0),e.node(i),e.after(i+1),e.index(i)+1,t,r);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new ze(e.node(0))}static atStart(e){return Wn(e,e,0,0,1)||new ze(e)}static atEnd(e){return Wn(e,e,e.content.size,e.childCount,-1)||new ze(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let r=Ao[t.type];if(!r)throw new RangeError(`No selection type ${t.type} defined`);return r.fromJSON(e,t)}static jsonID(e,t){if(e in Ao)throw new RangeError("Duplicate use of selection JSON ID "+e);return Ao[e]=t,t.prototype.jsonID=e,t}getBookmark(){return j.between(this.$anchor,this.$head).getBookmark()}}F.prototype.visible=!0;class bw{constructor(e,t){this.$from=e,this.$to=t}}let Lc=!1;function Bc(n){!Lc&&!n.parent.inlineContent&&(Lc=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+n.parent.type.name+")"))}class j extends F{constructor(e,t=e){Bc(e),Bc(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let r=e.resolve(t.map(this.head));if(!r.parent.inlineContent)return F.near(r);let s=e.resolve(t.map(this.anchor));return new j(s.parent.inlineContent?s:r,r)}replace(e,t=A.empty){if(super.replace(e,t),t==A.empty){let r=this.$from.marksAcross(this.$to);r&&e.ensureMarks(r)}}eq(e){return e instanceof j&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new Xi(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new j(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,r=t){let s=e.resolve(t);return new this(s,r==t?s:e.resolve(r))}static between(e,t,r){let s=e.pos-t.pos;if((!r||s)&&(r=s>=0?1:-1),!t.parent.inlineContent){let i=F.findFrom(t,r,!0)||F.findFrom(t,-r,!0);if(i)t=i.$head;else return F.near(t,r)}return e.parent.inlineContent||(s==0?e=t:(e=(F.findFrom(e,-r,!0)||F.findFrom(e,r,!0)).$anchor,e.pos<t.pos!=s<0&&(e=t))),new j(e,t)}}F.jsonID("text",j);class Xi{constructor(e,t){this.anchor=e,this.head=t}map(e){return new Xi(e.map(this.anchor),e.map(this.head))}resolve(e){return j.between(e.resolve(this.anchor),e.resolve(this.head))}}class N extends F{constructor(e){let t=e.nodeAfter,r=e.node(0).resolve(e.pos+t.nodeSize);super(e,r),this.node=t}map(e,t){let{deleted:r,pos:s}=t.mapResult(this.anchor),i=e.resolve(s);return r?F.near(i):new N(i)}content(){return new A(_.from(this.node),0,0)}eq(e){return e instanceof N&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new ll(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new N(e.resolve(t.anchor))}static create(e,t){return new N(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}N.prototype.visible=!1;F.jsonID("node",N);class ll{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:r}=e.mapResult(this.anchor);return t?new Xi(r,r):new ll(r)}resolve(e){let t=e.resolve(this.anchor),r=t.nodeAfter;return r&&N.isSelectable(r)?new N(t):F.near(t)}}class ze extends F{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=A.empty){if(t==A.empty){e.delete(0,e.doc.content.size);let r=F.atStart(e.doc);r.eq(e.selection)||e.setSelection(r)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new ze(e)}map(e){return new ze(e)}eq(e){return e instanceof ze}getBookmark(){return ww}}F.jsonID("all",ze);const ww={map(){return this},resolve(n){return new ze(n)}};function Wn(n,e,t,r,s,i=!1){if(e.inlineContent)return j.create(n,t);for(let o=r-(s>0?0:1);s>0?o<e.childCount:o>=0;o+=s){let a=e.child(o);if(a.isAtom){if(!i&&N.isSelectable(a))return N.create(n,t-(s<0?a.nodeSize:0))}else{let l=Wn(n,a,t+s,s<0?a.childCount:0,s,i);if(l)return l}t+=a.nodeSize*s}return null}function zc(n,e,t){let r=n.steps.length-1;if(r<e)return;let s=n.steps[r];if(!(s instanceof ye||s instanceof we))return;let i=n.mapping.maps[r],o;i.forEach((a,l,c,u)=>{o==null&&(o=u)}),n.setSelection(F.near(n.doc.resolve(o),t))}const Fc=1,ks=2,Uc=4;class vw extends oh{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|Fc)&~ks,this.storedMarks=null,this}get selectionSet(){return(this.updated&Fc)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=ks,this}ensureMarks(e){return Y.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&ks)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~ks,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let r=this.selection;return t&&(e=e.mark(this.storedMarks||(r.empty?r.$from.marks():r.$from.marksAcross(r.$to)||Y.none))),r.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,r){let s=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(s.text(e),!0):this.deleteSelection();{if(r==null&&(r=t),!e)return this.deleteRange(t,r);let i=this.storedMarks;if(!i){let o=this.doc.resolve(t);i=r==t?o.marks():o.marksAcross(this.doc.resolve(r))}return this.replaceRangeWith(t,r,s.text(e,i)),!this.selection.empty&&this.selection.to==t+e.length&&this.setSelection(F.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=Uc,this}get scrolledIntoView(){return(this.updated&Uc)>0}}function Hc(n,e){return!e||!n?n:n.bind(e)}class _r{constructor(e,t,r){this.name=e,this.init=Hc(t.init,r),this.apply=Hc(t.apply,r)}}const kw=[new _r("doc",{init(n){return n.doc||n.schema.topNodeType.createAndFill()},apply(n){return n.doc}}),new _r("selection",{init(n,e){return n.selection||F.atStart(e.doc)},apply(n){return n.selection}}),new _r("storedMarks",{init(n){return n.storedMarks||null},apply(n,e,t,r){return r.selection.$cursor?n.storedMarks:null}}),new _r("scrollToSelection",{init(){return 0},apply(n,e){return n.scrolledIntoView?e+1:e}})];class Oo{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=kw.slice(),t&&t.forEach(r=>{if(this.pluginsByKey[r.key])throw new RangeError("Adding different instances of a keyed plugin ("+r.key+")");this.plugins.push(r),this.pluginsByKey[r.key]=r,r.spec.state&&this.fields.push(new _r(r.key,r.spec.state,r))})}}class Xn{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let r=0;r<this.config.plugins.length;r++)if(r!=t){let s=this.config.plugins[r];if(s.spec.filterTransaction&&!s.spec.filterTransaction.call(s,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],r=this.applyInner(e),s=null;for(;;){let i=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=s?s[o].n:0,c=s?s[o].state:this,u=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,c,r);if(u&&r.filterTransaction(u,o)){if(u.setMeta("appendedTransaction",e),!s){s=[];for(let d=0;d<this.config.plugins.length;d++)s.push(d<o?{state:r,n:t.length}:{state:this,n:0})}t.push(u),r=r.applyInner(u),i=!0}s&&(s[o]={state:r,n:t.length})}}if(!i)return{state:r,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new Xn(this.config),r=this.config.fields;for(let s=0;s<r.length;s++){let i=r[s];t[i.name]=i.apply(e,this[i.name],this,t)}return t}get tr(){return new vw(this)}static create(e){let t=new Oo(e.doc?e.doc.type.schema:e.schema,e.plugins),r=new Xn(t);for(let s=0;s<t.fields.length;s++)r[t.fields[s].name]=t.fields[s].init(e,r);return r}reconfigure(e){let t=new Oo(this.schema,e.plugins),r=t.fields,s=new Xn(t);for(let i=0;i<r.length;i++){let o=r[i].name;s[o]=this.hasOwnProperty(o)?this[o]:r[i].init(e,s)}return s}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(r=>r.toJSON())),e&&typeof e=="object")for(let r in e){if(r=="doc"||r=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let s=e[r],i=s.spec.state;i&&i.toJSON&&(t[r]=i.toJSON.call(s,this[s.key]))}return t}static fromJSON(e,t,r){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let s=new Oo(e.schema,e.plugins),i=new Xn(s);return s.fields.forEach(o=>{if(o.name=="doc")i.doc=nt.fromJSON(e.schema,t.doc);else if(o.name=="selection")i.selection=F.fromJSON(i.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(i.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(r)for(let a in r){let l=r[a],c=l.spec.state;if(l.key==o.name&&c&&c.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){i[o.name]=c.fromJSON.call(l,e,t[a],i);return}}i[o.name]=o.init(e,i)}}),i}}function ah(n,e,t){for(let r in n){let s=n[r];s instanceof Function?s=s.bind(e):r=="handleDOMEvents"&&(s=ah(s,e,{})),t[r]=s}return t}class se{constructor(e){this.spec=e,this.props={},e.props&&ah(e.props,this,this.props),this.key=e.key?e.key.key:lh("plugin")}getState(e){return e[this.key]}}const Mo=Object.create(null);function lh(n){return n in Mo?n+"$"+ ++Mo[n]:(Mo[n]=0,n+"$")}class ge{constructor(e="key"){this.key=lh(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const cl=(n,e)=>n.selection.empty?!1:(e&&e(n.tr.deleteSelection().scrollIntoView()),!0);function ch(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("backward",n):t.parentOffset>0)?null:t}const uh=(n,e,t)=>{let r=ch(n,t);if(!r)return!1;let s=ul(r);if(!s){let o=r.blockRange(),a=o&&pr(o);return a==null?!1:(e&&e(n.tr.lift(o,a).scrollIntoView()),!0)}let i=s.nodeBefore;if(wh(n,s,e,-1))return!0;if(r.parent.content.size==0&&(or(i,"end")||N.isSelectable(i)))for(let o=r.depth;;o--){let a=Yi(n.doc,r.before(o),r.after(o),A.empty);if(a&&a.slice.size<a.to-a.from){if(e){let l=n.tr.step(a);l.setSelection(or(i,"end")?F.findFrom(l.doc.resolve(l.mapping.map(s.pos,-1)),-1):N.create(l.doc,s.pos-i.nodeSize)),e(l.scrollIntoView())}return!0}if(o==1||r.node(o-1).childCount>1)break}return i.isAtom&&s.depth==r.depth-1?(e&&e(n.tr.delete(s.pos-i.nodeSize,s.pos).scrollIntoView()),!0):!1},Sw=(n,e,t)=>{let r=ch(n,t);if(!r)return!1;let s=ul(r);return s?dh(n,s,e):!1},_w=(n,e,t)=>{let r=fh(n,t);if(!r)return!1;let s=dl(r);return s?dh(n,s,e):!1};function dh(n,e,t){let r=e.nodeBefore,s=r,i=e.pos-1;for(;!s.isTextblock;i--){if(s.type.spec.isolating)return!1;let u=s.lastChild;if(!u)return!1;s=u}let o=e.nodeAfter,a=o,l=e.pos+1;for(;!a.isTextblock;l++){if(a.type.spec.isolating)return!1;let u=a.firstChild;if(!u)return!1;a=u}let c=Yi(n.doc,i,l,A.empty);if(!c||c.from!=i||c instanceof ye&&c.slice.size>=l-i)return!1;if(t){let u=n.tr.step(c);u.setSelection(j.create(u.doc,i)),t(u.scrollIntoView())}return!0}function or(n,e,t=!1){for(let r=n;r;r=e=="start"?r.firstChild:r.lastChild){if(r.isTextblock)return!0;if(t&&r.childCount!=1)return!1}return!1}const hh=(n,e,t)=>{let{$head:r,empty:s}=n.selection,i=r;if(!s)return!1;if(r.parent.isTextblock){if(t?!t.endOfTextblock("backward",n):r.parentOffset>0)return!1;i=ul(r)}let o=i&&i.nodeBefore;return!o||!N.isSelectable(o)?!1:(e&&e(n.tr.setSelection(N.create(n.doc,i.pos-o.nodeSize)).scrollIntoView()),!0)};function ul(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){if(n.index(e)>0)return n.doc.resolve(n.before(e+1));if(n.node(e).type.spec.isolating)break}return null}function fh(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("forward",n):t.parentOffset<t.parent.content.size)?null:t}const ph=(n,e,t)=>{let r=fh(n,t);if(!r)return!1;let s=dl(r);if(!s)return!1;let i=s.nodeAfter;if(wh(n,s,e,1))return!0;if(r.parent.content.size==0&&(or(i,"start")||N.isSelectable(i))){let o=Yi(n.doc,r.before(),r.after(),A.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(or(i,"start")?F.findFrom(a.doc.resolve(a.mapping.map(s.pos)),1):N.create(a.doc,a.mapping.map(s.pos))),e(a.scrollIntoView())}return!0}}return i.isAtom&&s.depth==r.depth-1?(e&&e(n.tr.delete(s.pos,s.pos+i.nodeSize).scrollIntoView()),!0):!1},mh=(n,e,t)=>{let{$head:r,empty:s}=n.selection,i=r;if(!s)return!1;if(r.parent.isTextblock){if(t?!t.endOfTextblock("forward",n):r.parentOffset<r.parent.content.size)return!1;i=dl(r)}let o=i&&i.nodeAfter;return!o||!N.isSelectable(o)?!1:(e&&e(n.tr.setSelection(N.create(n.doc,i.pos)).scrollIntoView()),!0)};function dl(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){let t=n.node(e);if(n.index(e)+1<t.childCount)return n.doc.resolve(n.after(e+1));if(t.type.spec.isolating)break}return null}const xw=(n,e)=>{let t=n.selection,r=t instanceof N,s;if(r){if(t.node.isTextblock||!nn(n.doc,t.from))return!1;s=t.from}else if(s=Gi(n.doc,t.from,-1),s==null)return!1;if(e){let i=n.tr.join(s);r&&i.setSelection(N.create(i.doc,s-n.doc.resolve(s).nodeBefore.nodeSize)),e(i.scrollIntoView())}return!0},Tw=(n,e)=>{let t=n.selection,r;if(t instanceof N){if(t.node.isTextblock||!nn(n.doc,t.to))return!1;r=t.to}else if(r=Gi(n.doc,t.to,1),r==null)return!1;return e&&e(n.tr.join(r).scrollIntoView()),!0},Ew=(n,e)=>{let{$from:t,$to:r}=n.selection,s=t.blockRange(r),i=s&&pr(s);return i==null?!1:(e&&e(n.tr.lift(s,i).scrollIntoView()),!0)},gh=(n,e)=>{let{$head:t,$anchor:r}=n.selection;return!t.parent.type.spec.code||!t.sameParent(r)?!1:(e&&e(n.tr.insertText(`
`).scrollIntoView()),!0)};function hl(n){for(let e=0;e<n.edgeCount;e++){let{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}const Cw=(n,e)=>{let{$head:t,$anchor:r}=n.selection;if(!t.parent.type.spec.code||!t.sameParent(r))return!1;let s=t.node(-1),i=t.indexAfter(-1),o=hl(s.contentMatchAt(i));if(!o||!s.canReplaceWith(i,i,o))return!1;if(e){let a=t.after(),l=n.tr.replaceWith(a,a,o.createAndFill());l.setSelection(F.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},yh=(n,e)=>{let t=n.selection,{$from:r,$to:s}=t;if(t instanceof ze||r.parent.inlineContent||s.parent.inlineContent)return!1;let i=hl(s.parent.contentMatchAt(s.indexAfter()));if(!i||!i.isTextblock)return!1;if(e){let o=(!r.parentOffset&&s.index()<s.parent.childCount?r:s).pos,a=n.tr.insert(o,i.createAndFill());a.setSelection(j.create(a.doc,o+1)),e(a.scrollIntoView())}return!0},bh=(n,e)=>{let{$cursor:t}=n.selection;if(!t||t.parent.content.size)return!1;if(t.depth>1&&t.after()!=t.end(-1)){let i=t.before();if(_t(n.doc,i))return e&&e(n.tr.split(i).scrollIntoView()),!0}let r=t.blockRange(),s=r&&pr(r);return s==null?!1:(e&&e(n.tr.lift(r,s).scrollIntoView()),!0)};function Aw(n){return(e,t)=>{let{$from:r,$to:s}=e.selection;if(e.selection instanceof N&&e.selection.node.isBlock)return!r.parentOffset||!_t(e.doc,r.pos)?!1:(t&&t(e.tr.split(r.pos).scrollIntoView()),!0);if(!r.depth)return!1;let i=[],o,a,l=!1,c=!1;for(let f=r.depth;;f--)if(r.node(f).isBlock){l=r.end(f)==r.pos+(r.depth-f),c=r.start(f)==r.pos-(r.depth-f),a=hl(r.node(f-1).contentMatchAt(r.indexAfter(f-1))),i.unshift(l&&a?{type:a}:null),o=f;break}else{if(f==1)return!1;i.unshift(null)}let u=e.tr;(e.selection instanceof j||e.selection instanceof ze)&&u.deleteSelection();let d=u.mapping.map(r.pos),h=_t(u.doc,d,i.length,i);if(h||(i[0]=a?{type:a}:null,h=_t(u.doc,d,i.length,i)),!h)return!1;if(u.split(d,i.length,i),!l&&c&&r.node(o).type!=a){let f=u.mapping.map(r.before(o)),m=u.doc.resolve(f);a&&r.node(o-1).canReplaceWith(m.index(),m.index()+1,a)&&u.setNodeMarkup(u.mapping.map(r.before(o)),a)}return t&&t(u.scrollIntoView()),!0}}const Ow=Aw(),Mw=(n,e)=>{let{$from:t,to:r}=n.selection,s,i=t.sharedDepth(r);return i==0?!1:(s=t.before(i),e&&e(n.tr.setSelection(N.create(n.doc,s))),!0)};function Iw(n,e,t){let r=e.nodeBefore,s=e.nodeAfter,i=e.index();return!r||!s||!r.type.compatibleContent(s.type)?!1:!r.content.size&&e.parent.canReplace(i-1,i)?(t&&t(n.tr.delete(e.pos-r.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(i,i+1)||!(s.isTextblock||nn(n.doc,e.pos))?!1:(t&&t(n.tr.join(e.pos).scrollIntoView()),!0)}function wh(n,e,t,r){let s=e.nodeBefore,i=e.nodeAfter,o,a,l=s.type.spec.isolating||i.type.spec.isolating;if(!l&&Iw(n,e,t))return!0;let c=!l&&e.parent.canReplace(e.index(),e.index()+1);if(c&&(o=(a=s.contentMatchAt(s.childCount)).findWrapping(i.type))&&a.matchType(o[0]||i.type).validEnd){if(t){let f=e.pos+i.nodeSize,m=_.empty;for(let b=o.length-1;b>=0;b--)m=_.from(o[b].create(null,m));m=_.from(s.copy(m));let g=n.tr.step(new we(e.pos-1,f,e.pos,f,new A(m,1,0),o.length,!0)),y=g.doc.resolve(f+2*o.length);y.nodeAfter&&y.nodeAfter.type==s.type&&nn(g.doc,y.pos)&&g.join(y.pos),t(g.scrollIntoView())}return!0}let u=i.type.spec.isolating||r>0&&l?null:F.findFrom(e,1),d=u&&u.$from.blockRange(u.$to),h=d&&pr(d);if(h!=null&&h>=e.depth)return t&&t(n.tr.lift(d,h).scrollIntoView()),!0;if(c&&or(i,"start",!0)&&or(s,"end")){let f=s,m=[];for(;m.push(f),!f.isTextblock;)f=f.lastChild;let g=i,y=1;for(;!g.isTextblock;g=g.firstChild)y++;if(f.canReplace(f.childCount,f.childCount,g.content)){if(t){let b=_.empty;for(let w=m.length-1;w>=0;w--)b=_.from(m[w].copy(b));let v=n.tr.step(new we(e.pos-m.length,e.pos+i.nodeSize,e.pos+y,e.pos+i.nodeSize-y,new A(b,m.length,0),0,!0));t(v.scrollIntoView())}return!0}}return!1}function vh(n){return function(e,t){let r=e.selection,s=n<0?r.$from:r.$to,i=s.depth;for(;s.node(i).isInline;){if(!i)return!1;i--}return s.node(i).isTextblock?(t&&t(e.tr.setSelection(j.create(e.doc,n<0?s.start(i):s.end(i)))),!0):!1}}const Nw=vh(-1),Rw=vh(1);function Pw(n,e=null){return function(t,r){let{$from:s,$to:i}=t.selection,o=s.blockRange(i),a=o&&al(o,n,e);return a?(r&&r(t.tr.wrap(o,a).scrollIntoView()),!0):!1}}function Vc(n,e=null){return function(t,r){let s=!1;for(let i=0;i<t.selection.ranges.length&&!s;i++){let{$from:{pos:o},$to:{pos:a}}=t.selection.ranges[i];t.doc.nodesBetween(o,a,(l,c)=>{if(s)return!1;if(!(!l.isTextblock||l.hasMarkup(n,e)))if(l.type==n)s=!0;else{let u=t.doc.resolve(c),d=u.index();s=u.parent.canReplaceWith(d,d+1,n)}})}if(!s)return!1;if(r){let i=t.tr;for(let o=0;o<t.selection.ranges.length;o++){let{$from:{pos:a},$to:{pos:l}}=t.selection.ranges[o];i.setBlockType(a,l,n,e)}r(i.scrollIntoView())}return!0}}function fl(...n){return function(e,t,r){for(let s=0;s<n.length;s++)if(n[s](e,t,r))return!0;return!1}}fl(cl,uh,hh);fl(cl,ph,mh);fl(gh,yh,bh,Ow);typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform&&os.platform()=="darwin";function $w(n,e=null){return function(t,r){let{$from:s,$to:i}=t.selection,o=s.blockRange(i);if(!o)return!1;let a=r?t.tr:null;return Dw(a,o,n,e)?(r&&r(a.scrollIntoView()),!0):!1}}function Dw(n,e,t,r=null){let s=!1,i=e,o=e.$from.doc;if(e.depth>=2&&e.$from.node(e.depth-1).type.compatibleContent(t)&&e.startIndex==0){if(e.$from.index(e.depth-1)==0)return!1;let l=o.resolve(e.start-2);i=new Js(l,l,e.depth),e.endIndex<e.parent.childCount&&(e=new Js(e.$from,o.resolve(e.$to.end(e.depth)),e.depth)),s=!0}let a=al(i,t,r,e);return a?(n&&jw(n,e,a,s,t),!0):!1}function jw(n,e,t,r,s){let i=_.empty;for(let u=t.length-1;u>=0;u--)i=_.from(t[u].type.create(t[u].attrs,i));n.step(new we(e.start-(r?2:0),e.end,e.start,e.end,new A(i,0,0),t.length,!0));let o=0;for(let u=0;u<t.length;u++)t[u].type==s&&(o=u+1);let a=t.length-o,l=e.start+t.length-(r?2:0),c=e.parent;for(let u=e.startIndex,d=e.endIndex,h=!0;u<d;u++,h=!1)!h&&_t(n.doc,l,a)&&(n.split(l,a),l+=2*a),l+=c.child(u).nodeSize;return n}function Lw(n){return function(e,t){let{$from:r,$to:s}=e.selection,i=r.blockRange(s,o=>o.childCount>0&&o.firstChild.type==n);return i?t?r.node(i.depth-1).type==n?Bw(e,t,n,i):zw(e,t,i):!0:!1}}function Bw(n,e,t,r){let s=n.tr,i=r.end,o=r.$to.end(r.depth);i<o&&(s.step(new we(i-1,o,i,o,new A(_.from(t.create(null,r.parent.copy())),1,0),1,!0)),r=new Js(s.doc.resolve(r.$from.pos),s.doc.resolve(o),r.depth));const a=pr(r);if(a==null)return!1;s.lift(r,a);let l=s.doc.resolve(s.mapping.map(i,-1)-1);return nn(s.doc,l.pos)&&l.nodeBefore.type==l.nodeAfter.type&&s.join(l.pos),e(s.scrollIntoView()),!0}function zw(n,e,t){let r=n.tr,s=t.parent;for(let f=t.end,m=t.endIndex-1,g=t.startIndex;m>g;m--)f-=s.child(m).nodeSize,r.delete(f-1,f+1);let i=r.doc.resolve(t.start),o=i.nodeAfter;if(r.mapping.map(t.end)!=t.start+i.nodeAfter.nodeSize)return!1;let a=t.startIndex==0,l=t.endIndex==s.childCount,c=i.node(-1),u=i.index(-1);if(!c.canReplace(u+(a?0:1),u+1,o.content.append(l?_.empty:_.from(s))))return!1;let d=i.pos,h=d+o.nodeSize;return r.step(new we(d-(a?1:0),h+(l?1:0),d+1,h-1,new A((a?_.empty:_.from(s.copy(_.empty))).append(l?_.empty:_.from(s.copy(_.empty))),a?0:1,l?0:1),a?0:1)),e(r.scrollIntoView()),!0}function Fw(n){return function(e,t){let{$from:r,$to:s}=e.selection,i=r.blockRange(s,c=>c.childCount>0&&c.firstChild.type==n);if(!i)return!1;let o=i.startIndex;if(o==0)return!1;let a=i.parent,l=a.child(o-1);if(l.type!=n)return!1;if(t){let c=l.lastChild&&l.lastChild.type==a.type,u=_.from(c?n.create():null),d=new A(_.from(n.create(null,_.from(a.type.create(null,u)))),c?3:1,0),h=i.start,f=i.end;t(e.tr.step(new we(h-(c?3:1),f,h,f,d,1,!0)).scrollIntoView())}return!0}}const xe=function(n){for(var e=0;;e++)if(n=n.previousSibling,!n)return e},ar=function(n){let e=n.assignedSlot||n.parentNode;return e&&e.nodeType==11?e.host:e};let ka=null;const kt=function(n,e,t){let r=ka||(ka=document.createRange());return r.setEnd(n,t??n.nodeValue.length),r.setStart(n,e||0),r},Uw=function(){ka=null},Mn=function(n,e,t,r){return t&&(qc(n,e,t,r,-1)||qc(n,e,t,r,1))},Hw=/^(img|br|input|textarea|hr)$/i;function qc(n,e,t,r,s){for(var i;;){if(n==t&&e==r)return!0;if(e==(s<0?0:We(n))){let o=n.parentNode;if(!o||o.nodeType!=1||as(n)||Hw.test(n.nodeName)||n.contentEditable=="false")return!1;e=xe(n)+(s<0?0:1),n=o}else if(n.nodeType==1){let o=n.childNodes[e+(s<0?-1:0)];if(o.nodeType==1&&o.contentEditable=="false")if(!((i=o.pmViewDesc)===null||i===void 0)&&i.ignoreForSelection)e+=s;else return!1;else n=o,e=s<0?We(n):0}else return!1}}function We(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function Vw(n,e){for(;;){if(n.nodeType==3&&e)return n;if(n.nodeType==1&&e>0){if(n.contentEditable=="false")return null;n=n.childNodes[e-1],e=We(n)}else if(n.parentNode&&!as(n))e=xe(n),n=n.parentNode;else return null}}function qw(n,e){for(;;){if(n.nodeType==3&&e<n.nodeValue.length)return n;if(n.nodeType==1&&e<n.childNodes.length){if(n.contentEditable=="false")return null;n=n.childNodes[e],e=0}else if(n.parentNode&&!as(n))e=xe(n)+1,n=n.parentNode;else return null}}function Ww(n,e,t){for(let r=e==0,s=e==We(n);r||s;){if(n==t)return!0;let i=xe(n);if(n=n.parentNode,!n)return!1;r=r&&i==0,s=s&&i==We(n)}}function as(n){let e;for(let t=n;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==n||e.contentDOM==n)}const Qi=function(n){return n.focusNode&&Mn(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset)};function pn(n,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=n,t.key=t.code=e,t}function Kw(n){let e=n.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function Jw(n,e,t){if(n.caretPositionFromPoint)try{let r=n.caretPositionFromPoint(e,t);if(r)return{node:r.offsetNode,offset:Math.min(We(r.offsetNode),r.offset)}}catch{}if(n.caretRangeFromPoint){let r=n.caretRangeFromPoint(e,t);if(r)return{node:r.startContainer,offset:Math.min(We(r.startContainer),r.startOffset)}}}const dt=typeof navigator<"u"?navigator:null,Wc=typeof document<"u"?document:null,rn=dt&&dt.userAgent||"",Sa=/Edge\/(\d+)/.exec(rn),kh=/MSIE \d/.exec(rn),_a=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(rn),Pe=!!(kh||_a||Sa),Gt=kh?document.documentMode:_a?+_a[1]:Sa?+Sa[1]:0,Ke=!Pe&&/gecko\/(\d+)/i.test(rn);Ke&&+(/Firefox\/(\d+)/.exec(rn)||[0,0])[1];const xa=!Pe&&/Chrome\/(\d+)/.exec(rn),be=!!xa,Sh=xa?+xa[1]:0,Ae=!Pe&&!!dt&&/Apple Computer/.test(dt.vendor),lr=Ae&&(/Mobile\/\w+/.test(rn)||!!dt&&dt.maxTouchPoints>2),Ve=lr||(dt?/Mac/.test(dt.platform):!1),_h=dt?/Win/.test(dt.platform):!1,St=/Android \d/.test(rn),ls=!!Wc&&"webkitFontSmoothing"in Wc.documentElement.style,Gw=ls?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function Yw(n){let e=n.defaultView&&n.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:n.documentElement.clientWidth,top:0,bottom:n.documentElement.clientHeight}}function gt(n,e){return typeof n=="number"?n:n[e]}function Xw(n){let e=n.getBoundingClientRect(),t=e.width/n.offsetWidth||1,r=e.height/n.offsetHeight||1;return{left:e.left,right:e.left+n.clientWidth*t,top:e.top,bottom:e.top+n.clientHeight*r}}function Kc(n,e,t){let r=n.someProp("scrollThreshold")||0,s=n.someProp("scrollMargin")||5,i=n.dom.ownerDocument;for(let o=t||n.dom;o;){if(o.nodeType!=1){o=ar(o);continue}let a=o,l=a==i.body,c=l?Yw(i):Xw(a),u=0,d=0;if(e.top<c.top+gt(r,"top")?d=-(c.top-e.top+gt(s,"top")):e.bottom>c.bottom-gt(r,"bottom")&&(d=e.bottom-e.top>c.bottom-c.top?e.top+gt(s,"top")-c.top:e.bottom-c.bottom+gt(s,"bottom")),e.left<c.left+gt(r,"left")?u=-(c.left-e.left+gt(s,"left")):e.right>c.right-gt(r,"right")&&(u=e.right-c.right+gt(s,"right")),u||d)if(l)i.defaultView.scrollBy(u,d);else{let f=a.scrollLeft,m=a.scrollTop;d&&(a.scrollTop+=d),u&&(a.scrollLeft+=u);let g=a.scrollLeft-f,y=a.scrollTop-m;e={left:e.left-g,top:e.top-y,right:e.right-g,bottom:e.bottom-y}}let h=l?"fixed":getComputedStyle(o).position;if(/^(fixed|sticky)$/.test(h))break;o=h=="absolute"?o.offsetParent:ar(o)}}function Qw(n){let e=n.dom.getBoundingClientRect(),t=Math.max(0,e.top),r,s;for(let i=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=n.root.elementFromPoint(i,o);if(!a||a==n.dom||!n.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){r=a,s=l.top;break}}return{refDOM:r,refTop:s,stack:xh(n.dom)}}function xh(n){let e=[],t=n.ownerDocument;for(let r=n;r&&(e.push({dom:r,top:r.scrollTop,left:r.scrollLeft}),n!=t);r=ar(r));return e}function Zw({refDOM:n,refTop:e,stack:t}){let r=n?n.getBoundingClientRect().top:0;Th(t,r==0?0:r-e)}function Th(n,e){for(let t=0;t<n.length;t++){let{dom:r,top:s,left:i}=n[t];r.scrollTop!=s+e&&(r.scrollTop=s+e),r.scrollLeft!=i&&(r.scrollLeft=i)}}let Fn=null;function ev(n){if(n.setActive)return n.setActive();if(Fn)return n.focus(Fn);let e=xh(n);n.focus(Fn==null?{get preventScroll(){return Fn={preventScroll:!0},!0}}:void 0),Fn||(Fn=!1,Th(e,0))}function Eh(n,e){let t,r=2e8,s,i=0,o=e.top,a=e.top,l,c;for(let u=n.firstChild,d=0;u;u=u.nextSibling,d++){let h;if(u.nodeType==1)h=u.getClientRects();else if(u.nodeType==3)h=kt(u).getClientRects();else continue;for(let f=0;f<h.length;f++){let m=h[f];if(m.top<=o&&m.bottom>=a){o=Math.max(m.bottom,o),a=Math.min(m.top,a);let g=m.left>e.left?m.left-e.left:m.right<e.left?e.left-m.right:0;if(g<r){t=u,r=g,s=g&&t.nodeType==3?{left:m.right<e.left?m.right:m.left,top:e.top}:e,u.nodeType==1&&g&&(i=d+(e.left>=(m.left+m.right)/2?1:0));continue}}else m.top>e.top&&!l&&m.left<=e.left&&m.right>=e.left&&(l=u,c={left:Math.max(m.left,Math.min(m.right,e.left)),top:m.top});!t&&(e.left>=m.right&&e.top>=m.top||e.left>=m.left&&e.top>=m.bottom)&&(i=d+1)}}return!t&&l&&(t=l,s=c,r=0),t&&t.nodeType==3?tv(t,s):!t||r&&t.nodeType==1?{node:n,offset:i}:Eh(t,s)}function tv(n,e){let t=n.nodeValue.length,r=document.createRange(),s;for(let i=0;i<t;i++){r.setEnd(n,i+1),r.setStart(n,i);let o=$t(r,1);if(o.top!=o.bottom&&pl(e,o)){s={node:n,offset:i+(e.left>=(o.left+o.right)/2?1:0)};break}}return r.detach(),s||{node:n,offset:0}}function pl(n,e){return n.left>=e.left-1&&n.left<=e.right+1&&n.top>=e.top-1&&n.top<=e.bottom+1}function nv(n,e){let t=n.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<n.getBoundingClientRect().left?t:n}function rv(n,e,t){let{node:r,offset:s}=Eh(e,t),i=-1;if(r.nodeType==1&&!r.firstChild){let o=r.getBoundingClientRect();i=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return n.docView.posFromDOM(r,s,i)}function sv(n,e,t,r){let s=-1;for(let i=e,o=!1;i!=n.dom;){let a=n.docView.nearestDesc(i,!0),l;if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)&&((l=a.dom.getBoundingClientRect()).width||l.height)&&(a.node.isBlock&&a.parent&&!/^T(R|BODY|HEAD|FOOT)$/.test(a.dom.nodeName)&&(!o&&l.left>r.left||l.top>r.top?s=a.posBefore:(!o&&l.right<r.left||l.bottom<r.top)&&(s=a.posAfter),o=!0),!a.contentDOM&&s<0&&!a.node.isText))return(a.node.isBlock?r.top<(l.top+l.bottom)/2:r.left<(l.left+l.right)/2)?a.posBefore:a.posAfter;i=a.dom.parentNode}return s>-1?s:n.docView.posFromDOM(e,t,-1)}function Ch(n,e,t){let r=n.childNodes.length;if(r&&t.top<t.bottom)for(let s=Math.max(0,Math.min(r-1,Math.floor(r*(e.top-t.top)/(t.bottom-t.top))-2)),i=s;;){let o=n.childNodes[i];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let c=a[l];if(pl(e,c))return Ch(o,e,c)}}if((i=(i+1)%r)==s)break}return n}function iv(n,e){let t=n.dom.ownerDocument,r,s=0,i=Jw(t,e.left,e.top);i&&({node:r,offset:s}=i);let o=(n.root.elementFromPoint?n.root:t).elementFromPoint(e.left,e.top),a;if(!o||!n.dom.contains(o.nodeType!=1?o.parentNode:o)){let c=n.dom.getBoundingClientRect();if(!pl(e,c)||(o=Ch(n.dom,e,c),!o))return null}if(Ae)for(let c=o;r&&c;c=ar(c))c.draggable&&(r=void 0);if(o=nv(o,e),r){if(Ke&&r.nodeType==1&&(s=Math.min(s,r.childNodes.length),s<r.childNodes.length)){let u=r.childNodes[s],d;u.nodeName=="IMG"&&(d=u.getBoundingClientRect()).right<=e.left&&d.bottom>e.top&&s++}let c;ls&&s&&r.nodeType==1&&(c=r.childNodes[s-1]).nodeType==1&&c.contentEditable=="false"&&c.getBoundingClientRect().top>=e.top&&s--,r==n.dom&&s==r.childNodes.length-1&&r.lastChild.nodeType==1&&e.top>r.lastChild.getBoundingClientRect().bottom?a=n.state.doc.content.size:(s==0||r.nodeType!=1||r.childNodes[s-1].nodeName!="BR")&&(a=sv(n,r,s,e))}a==null&&(a=rv(n,o,e));let l=n.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function Jc(n){return n.top<n.bottom||n.left<n.right}function $t(n,e){let t=n.getClientRects();if(t.length){let r=t[e<0?0:t.length-1];if(Jc(r))return r}return Array.prototype.find.call(t,Jc)||n.getBoundingClientRect()}const ov=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function Ah(n,e,t){let{node:r,offset:s,atom:i}=n.docView.domFromPos(e,t<0?-1:1),o=ls||Ke;if(r.nodeType==3)if(o&&(ov.test(r.nodeValue)||(t<0?!s:s==r.nodeValue.length))){let l=$t(kt(r,s,s),t);if(Ke&&s&&/\s/.test(r.nodeValue[s-1])&&s<r.nodeValue.length){let c=$t(kt(r,s-1,s-1),-1);if(c.top==l.top){let u=$t(kt(r,s,s+1),-1);if(u.top!=l.top)return br(u,u.left<c.left)}}return l}else{let l=s,c=s,u=t<0?1:-1;return t<0&&!s?(c++,u=-1):t>=0&&s==r.nodeValue.length?(l--,u=1):t<0?l--:c++,br($t(kt(r,l,c),u),u<0)}if(!n.state.doc.resolve(e-(i||0)).parent.inlineContent){if(i==null&&s&&(t<0||s==We(r))){let l=r.childNodes[s-1];if(l.nodeType==1)return Io(l.getBoundingClientRect(),!1)}if(i==null&&s<We(r)){let l=r.childNodes[s];if(l.nodeType==1)return Io(l.getBoundingClientRect(),!0)}return Io(r.getBoundingClientRect(),t>=0)}if(i==null&&s&&(t<0||s==We(r))){let l=r.childNodes[s-1],c=l.nodeType==3?kt(l,We(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(c)return br($t(c,1),!1)}if(i==null&&s<We(r)){let l=r.childNodes[s];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let c=l?l.nodeType==3?kt(l,0,o?0:1):l.nodeType==1?l:null:null;if(c)return br($t(c,-1),!0)}return br($t(r.nodeType==3?kt(r):r,-t),t>=0)}function br(n,e){if(n.width==0)return n;let t=e?n.left:n.right;return{top:n.top,bottom:n.bottom,left:t,right:t}}function Io(n,e){if(n.height==0)return n;let t=e?n.top:n.bottom;return{top:t,bottom:t,left:n.left,right:n.right}}function Oh(n,e,t){let r=n.state,s=n.root.activeElement;r!=e&&n.updateState(e),s!=n.dom&&n.focus();try{return t()}finally{r!=e&&n.updateState(r),s!=n.dom&&s&&s.focus()}}function av(n,e,t){let r=e.selection,s=t=="up"?r.$from:r.$to;return Oh(n,e,()=>{let{node:i}=n.docView.domFromPos(s.pos,t=="up"?-1:1);for(;;){let a=n.docView.nearestDesc(i,!0);if(!a)break;if(a.node.isBlock){i=a.contentDOM||a.dom;break}i=a.dom.parentNode}let o=Ah(n,s.pos,1);for(let a=i.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=kt(a,0,a.nodeValue.length).getClientRects();else continue;for(let c=0;c<l.length;c++){let u=l[c];if(u.bottom>u.top+1&&(t=="up"?o.top-u.top>(u.bottom-o.top)*2:u.bottom-o.bottom>(o.bottom-u.top)*2))return!1}}return!0})}const lv=/[\u0590-\u08ac]/;function cv(n,e,t){let{$head:r}=e.selection;if(!r.parent.isTextblock)return!1;let s=r.parentOffset,i=!s,o=s==r.parent.content.size,a=n.domSelection();return a?!lv.test(r.parent.textContent)||!a.modify?t=="left"||t=="backward"?i:o:Oh(n,e,()=>{let{focusNode:l,focusOffset:c,anchorNode:u,anchorOffset:d}=n.domSelectionRange(),h=a.caretBidiLevel;a.modify("move",t,"character");let f=r.depth?n.docView.domAfterPos(r.before()):n.dom,{focusNode:m,focusOffset:g}=n.domSelectionRange(),y=m&&!f.contains(m.nodeType==1?m:m.parentNode)||l==m&&c==g;try{a.collapse(u,d),l&&(l!=u||c!=d)&&a.extend&&a.extend(l,c)}catch{}return h!=null&&(a.caretBidiLevel=h),y}):r.pos==r.start()||r.pos==r.end()}let Gc=null,Yc=null,Xc=!1;function uv(n,e,t){return Gc==e&&Yc==t?Xc:(Gc=e,Yc=t,Xc=t=="up"||t=="down"?av(n,e,t):cv(n,e,t))}const Je=0,Qc=1,gn=2,ht=3;class cs{constructor(e,t,r,s){this.parent=e,this.children=t,this.dom=r,this.contentDOM=s,this.dirty=Je,r.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,r){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,r=this.posAtStart;;t++){let s=this.children[t];if(s==e)return r;r+=s.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,r){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(r<0){let i,o;if(e==this.contentDOM)i=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;i=e.previousSibling}for(;i&&!((o=i.pmViewDesc)&&o.parent==this);)i=i.previousSibling;return i?this.posBeforeChild(o)+o.size:this.posAtStart}else{let i,o;if(e==this.contentDOM)i=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;i=e.nextSibling}for(;i&&!((o=i.pmViewDesc)&&o.parent==this);)i=i.nextSibling;return i?this.posBeforeChild(o):this.posAtEnd}let s;if(e==this.dom&&this.contentDOM)s=t>xe(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))s=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let i=e;;i=i.parentNode){if(i==this.dom){s=!1;break}if(i.previousSibling)break}if(s==null&&t==e.childNodes.length)for(let i=e;;i=i.parentNode){if(i==this.dom){s=!0;break}if(i.nextSibling)break}}return s??r>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let r=!0,s=e;s;s=s.parentNode){let i=this.getDesc(s),o;if(i&&(!t||i.node))if(r&&(o=i.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))r=!1;else return i}}getDesc(e){let t=e.pmViewDesc;for(let r=t;r;r=r.parent)if(r==this)return t}posFromDOM(e,t,r){for(let s=e;s;s=s.parentNode){let i=this.getDesc(s);if(i)return i.localPosFromDOM(e,t,r)}return-1}descAt(e){for(let t=0,r=0;t<this.children.length;t++){let s=this.children[t],i=r+s.size;if(r==e&&i!=r){for(;!s.border&&s.children.length;)for(let o=0;o<s.children.length;o++){let a=s.children[o];if(a.size){s=a;break}}return s}if(e<i)return s.descAt(e-r-s.border);r=i}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let r=0,s=0;for(let i=0;r<this.children.length;r++){let o=this.children[r],a=i+o.size;if(a>e||o instanceof Ih){s=e-i;break}i=a}if(s)return this.children[r].domFromPos(s-this.children[r].border,t);for(let i;r&&!(i=this.children[r-1]).size&&i instanceof Mh&&i.side>=0;r--);if(t<=0){let i,o=!0;for(;i=r?this.children[r-1]:null,!(!i||i.dom.parentNode==this.contentDOM);r--,o=!1);return i&&t&&o&&!i.border&&!i.domAtom?i.domFromPos(i.size,t):{node:this.contentDOM,offset:i?xe(i.dom)+1:0}}else{let i,o=!0;for(;i=r<this.children.length?this.children[r]:null,!(!i||i.dom.parentNode==this.contentDOM);r++,o=!1);return i&&o&&!i.border&&!i.domAtom?i.domFromPos(0,t):{node:this.contentDOM,offset:i?xe(i.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,r=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let s=-1,i=-1;for(let o=r,a=0;;a++){let l=this.children[a],c=o+l.size;if(s==-1&&e<=c){let u=o+l.border;if(e>=u&&t<=c-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,u);e=o;for(let d=a;d>0;d--){let h=this.children[d-1];if(h.size&&h.dom.parentNode==this.contentDOM&&!h.emptyChildAt(1)){s=xe(h.dom)+1;break}e-=h.size}s==-1&&(s=0)}if(s>-1&&(c>t||a==this.children.length-1)){t=c;for(let u=a+1;u<this.children.length;u++){let d=this.children[u];if(d.size&&d.dom.parentNode==this.contentDOM&&!d.emptyChildAt(-1)){i=xe(d.dom);break}t+=d.size}i==-1&&(i=this.contentDOM.childNodes.length);break}o=c}return{node:this.contentDOM,from:e,to:t,fromOffset:s,toOffset:i}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:r}=this.domFromPos(e,0);if(t.nodeType!=1||r==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[r]}setSelection(e,t,r,s=!1){let i=Math.min(e,t),o=Math.max(e,t);for(let f=0,m=0;f<this.children.length;f++){let g=this.children[f],y=m+g.size;if(i>m&&o<y)return g.setSelection(e-m-g.border,t-m-g.border,r,s);m=y}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),c=r.root.getSelection(),u=r.domSelectionRange(),d=!1;if((Ke||Ae)&&e==t){let{node:f,offset:m}=a;if(f.nodeType==3){if(d=!!(m&&f.nodeValue[m-1]==`
`),d&&m==f.nodeValue.length)for(let g=f,y;g;g=g.parentNode){if(y=g.nextSibling){y.nodeName=="BR"&&(a=l={node:y.parentNode,offset:xe(y)+1});break}let b=g.pmViewDesc;if(b&&b.node&&b.node.isBlock)break}}else{let g=f.childNodes[m-1];d=g&&(g.nodeName=="BR"||g.contentEditable=="false")}}if(Ke&&u.focusNode&&u.focusNode!=l.node&&u.focusNode.nodeType==1){let f=u.focusNode.childNodes[u.focusOffset];f&&f.contentEditable=="false"&&(s=!0)}if(!(s||d&&Ae)&&Mn(a.node,a.offset,u.anchorNode,u.anchorOffset)&&Mn(l.node,l.offset,u.focusNode,u.focusOffset))return;let h=!1;if((c.extend||e==t)&&!(d&&Ke)){c.collapse(a.node,a.offset);try{e!=t&&c.extend(l.node,l.offset),h=!0}catch{}}if(!h){if(e>t){let m=a;a=l,l=m}let f=document.createRange();f.setEnd(l.node,l.offset),f.setStart(a.node,a.offset),c.removeAllRanges(),c.addRange(f)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let r=0,s=0;s<this.children.length;s++){let i=this.children[s],o=r+i.size;if(r==o?e<=o&&t>=r:e<o&&t>r){let a=r+i.border,l=o-i.border;if(e>=a&&t<=l){this.dirty=e==r||t==o?gn:Qc,e==a&&t==l&&(i.contentLost||i.dom.parentNode!=this.contentDOM)?i.dirty=ht:i.markDirty(e-a,t-a);return}else i.dirty=i.dom==i.contentDOM&&i.dom.parentNode==this.contentDOM&&!i.children.length?gn:ht}r=o}this.dirty=gn}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let r=e==1?gn:Qc;t.dirty<r&&(t.dirty=r)}}get domAtom(){return!1}get ignoreForCoords(){return!1}get ignoreForSelection(){return!1}isText(e){return!1}}class Mh extends cs{constructor(e,t,r,s){let i,o=t.type.toDOM;if(typeof o=="function"&&(o=o(r,()=>{if(!i)return s;if(i.parent)return i.parent.posBeforeChild(i)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,i=this}matchesWidget(e){return this.dirty==Je&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get ignoreForSelection(){return!!this.widget.type.spec.relaxedSide}get side(){return this.widget.type.side}}class dv extends cs{constructor(e,t,r,s){super(e,[],t,null),this.textDOM=r,this.text=s}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class In extends cs{constructor(e,t,r,s,i){super(e,[],r,s),this.mark=t,this.spec=i}static create(e,t,r,s){let i=s.nodeViews[t.type.name],o=i&&i(t,s,r);return(!o||!o.dom)&&(o=Pn.renderSpec(document,t.type.spec.toDOM(t,r),null,t.attrs)),new In(e,t,o.dom,o.contentDOM||o.dom,o)}parseRule(){return this.dirty&ht||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=ht&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=Je){let r=this.parent;for(;!r.node;)r=r.parent;r.dirty<this.dirty&&(r.dirty=this.dirty),this.dirty=Je}}slice(e,t,r){let s=In.create(this.parent,this.mark,!0,r),i=this.children,o=this.size;t<o&&(i=Ea(i,t,o,r)),e>0&&(i=Ea(i,0,e,r));for(let a=0;a<i.length;a++)i[a].parent=s;return s.children=i,s}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}}class Yt extends cs{constructor(e,t,r,s,i,o,a,l,c){super(e,[],i,o),this.node=t,this.outerDeco=r,this.innerDeco=s,this.nodeDOM=a}static create(e,t,r,s,i,o){let a=i.nodeViews[t.type.name],l,c=a&&a(t,i,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},r,s),u=c&&c.dom,d=c&&c.contentDOM;if(t.isText){if(!u)u=document.createTextNode(t.text);else if(u.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else u||({dom:u,contentDOM:d}=Pn.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!d&&!t.isText&&u.nodeName!="BR"&&(u.hasAttribute("contenteditable")||(u.contentEditable="false"),t.type.spec.draggable&&(u.draggable=!0));let h=u;return u=Ph(u,r,t),c?l=new hv(e,t,r,s,u,d||null,h,c,i,o+1):t.isText?new Zi(e,t,r,s,u,h,i):new Yt(e,t,r,s,u,d||null,h,i,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let r=this.children[t];if(this.dom.contains(r.dom.parentNode)){e.contentElement=r.dom.parentNode;break}}e.contentElement||(e.getContent=()=>_.empty)}return e}matchesNode(e,t,r){return this.dirty==Je&&e.eq(this.node)&&Ys(t,this.outerDeco)&&r.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let r=this.node.inlineContent,s=t,i=e.composing?this.localCompositionInfo(e,t):null,o=i&&i.pos>-1?i:null,a=i&&i.pos<0,l=new pv(this,o&&o.node,e);yv(this.node,this.innerDeco,(c,u,d)=>{c.spec.marks?l.syncToMarks(c.spec.marks,r,e):c.type.side>=0&&!d&&l.syncToMarks(u==this.node.childCount?Y.none:this.node.child(u).marks,r,e),l.placeWidget(c,e,s)},(c,u,d,h)=>{l.syncToMarks(c.marks,r,e);let f;l.findNodeMatch(c,u,d,h)||a&&e.state.selection.from>s&&e.state.selection.to<s+c.nodeSize&&(f=l.findIndexWithChild(i.node))>-1&&l.updateNodeAt(c,u,d,f,e)||l.updateNextNode(c,u,d,e,h,s)||l.addNode(c,u,d,e,s),s+=c.nodeSize}),l.syncToMarks([],r,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==gn)&&(o&&this.protectLocalComposition(e,o),Nh(this.contentDOM,this.children,e),lr&&bv(this.dom))}localCompositionInfo(e,t){let{from:r,to:s}=e.state.selection;if(!(e.state.selection instanceof j)||r<t||s>t+this.node.content.size)return null;let i=e.input.compositionNode;if(!i||!this.dom.contains(i.parentNode))return null;if(this.node.inlineContent){let o=i.nodeValue,a=wv(this.node.content,o,r-t,s-t);return a<0?null:{node:i,pos:a,text:o}}else return{node:i,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:r,text:s}){if(this.getDesc(t))return;let i=t;for(;i.parentNode!=this.contentDOM;i=i.parentNode){for(;i.previousSibling;)i.parentNode.removeChild(i.previousSibling);for(;i.nextSibling;)i.parentNode.removeChild(i.nextSibling);i.pmViewDesc&&(i.pmViewDesc=void 0)}let o=new dv(this,i,t,s);e.input.compositionNodes.push(o),this.children=Ea(this.children,r,r+s.length,e,o)}update(e,t,r,s){return this.dirty==ht||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,r,s),!0)}updateInner(e,t,r,s){this.updateOuterDeco(t),this.node=e,this.innerDeco=r,this.contentDOM&&this.updateChildren(s,this.posAtStart),this.dirty=Je}updateOuterDeco(e){if(Ys(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,r=this.dom;this.dom=Rh(this.dom,this.nodeDOM,Ta(this.outerDeco,this.node,t),Ta(e,this.node,t)),this.dom!=r&&(r.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.nodeDOM.draggable=!0))}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.nodeDOM.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function Zc(n,e,t,r,s){Ph(r,e,n);let i=new Yt(void 0,n,e,t,r,r,r,s,0);return i.contentDOM&&i.updateChildren(s,0),i}class Zi extends Yt{constructor(e,t,r,s,i,o,a){super(e,t,r,s,i,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,r,s){return this.dirty==ht||this.dirty!=Je&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=Je||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,s.trackWrites==this.nodeDOM&&(s.trackWrites=null)),this.node=e,this.dirty=Je,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,r){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,r)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,r){let s=this.node.cut(e,t),i=document.createTextNode(s.text);return new Zi(this.parent,s,this.outerDeco,this.innerDeco,i,i,r)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=ht)}get domAtom(){return!1}isText(e){return this.node.text==e}}class Ih extends cs{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==Je&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class hv extends Yt{constructor(e,t,r,s,i,o,a,l,c,u){super(e,t,r,s,i,o,a,c,u),this.spec=l}update(e,t,r,s){if(this.dirty==ht)return!1;if(this.spec.update&&(this.node.type==e.type||this.spec.multiType)){let i=this.spec.update(e,t,r);return i&&this.updateInner(e,t,r,s),i}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,r,s)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,r,s){this.spec.setSelection?this.spec.setSelection(e,t,r.root):super.setSelection(e,t,r,s)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function Nh(n,e,t){let r=n.firstChild,s=!1;for(let i=0;i<e.length;i++){let o=e[i],a=o.dom;if(a.parentNode==n){for(;a!=r;)r=eu(r),s=!0;r=r.nextSibling}else s=!0,n.insertBefore(a,r);if(o instanceof In){let l=r?r.previousSibling:n.lastChild;Nh(o.contentDOM,o.children,t),r=l?l.nextSibling:n.firstChild}}for(;r;)r=eu(r),s=!0;s&&t.trackWrites==n&&(t.trackWrites=null)}const Or=function(n){n&&(this.nodeName=n)};Or.prototype=Object.create(null);const yn=[new Or];function Ta(n,e,t){if(n.length==0)return yn;let r=t?yn[0]:new Or,s=[r];for(let i=0;i<n.length;i++){let o=n[i].type.attrs;if(o){o.nodeName&&s.push(r=new Or(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&s.length==1&&s.push(r=new Or(e.isInline?"span":"div")),a=="class"?r.class=(r.class?r.class+" ":"")+l:a=="style"?r.style=(r.style?r.style+";":"")+l:a!="nodeName"&&(r[a]=l))}}}return s}function Rh(n,e,t,r){if(t==yn&&r==yn)return e;let s=e;for(let i=0;i<r.length;i++){let o=r[i],a=t[i];if(i){let l;a&&a.nodeName==o.nodeName&&s!=n&&(l=s.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(s),a=yn[0]),s=l}fv(s,a||yn[0],o)}return s}function fv(n,e,t){for(let r in e)r!="class"&&r!="style"&&r!="nodeName"&&!(r in t)&&n.removeAttribute(r);for(let r in t)r!="class"&&r!="style"&&r!="nodeName"&&t[r]!=e[r]&&n.setAttribute(r,t[r]);if(e.class!=t.class){let r=e.class?e.class.split(" ").filter(Boolean):[],s=t.class?t.class.split(" ").filter(Boolean):[];for(let i=0;i<r.length;i++)s.indexOf(r[i])==-1&&n.classList.remove(r[i]);for(let i=0;i<s.length;i++)r.indexOf(s[i])==-1&&n.classList.add(s[i]);n.classList.length==0&&n.removeAttribute("class")}if(e.style!=t.style){if(e.style){let r=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,s;for(;s=r.exec(e.style);)n.style.removeProperty(s[1])}t.style&&(n.style.cssText+=t.style)}}function Ph(n,e,t){return Rh(n,n,yn,Ta(e,t,n.nodeType!=1))}function Ys(n,e){if(n.length!=e.length)return!1;for(let t=0;t<n.length;t++)if(!n[t].type.eq(e[t].type))return!1;return!0}function eu(n){let e=n.nextSibling;return n.parentNode.removeChild(n),e}class pv{constructor(e,t,r){this.lock=t,this.view=r,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=mv(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let r=e;r<t;r++)this.top.children[r].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,r){let s=0,i=this.stack.length>>1,o=Math.min(i,e.length);for(;s<o&&(s==i-1?this.top:this.stack[s+1<<1]).matchesMark(e[s])&&e[s].type.spec.spanning!==!1;)s++;for(;s<i;)this.destroyRest(),this.top.dirty=Je,this.index=this.stack.pop(),this.top=this.stack.pop(),i--;for(;i<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let c=this.top.children[l];if(c.matchesMark(e[i])&&!this.isLocked(c.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=In.create(this.top,e[i],t,r);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,i++}}findNodeMatch(e,t,r,s){let i=-1,o;if(s>=this.preMatch.index&&(o=this.preMatch.matches[s-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,r))i=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let c=this.top.children[a];if(c.matchesNode(e,t,r)&&!this.preMatch.matched.has(c)){i=a;break}}return i<0?!1:(this.destroyBetween(this.index,i),this.index++,!0)}updateNodeAt(e,t,r,s,i){let o=this.top.children[s];return o.dirty==ht&&o.dom==o.contentDOM&&(o.dirty=gn),o.update(e,t,r,i)?(this.destroyBetween(this.index,s),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let r=e.pmViewDesc;if(r){for(let s=this.index;s<this.top.children.length;s++)if(this.top.children[s]==r)return s}return-1}e=t}}updateNextNode(e,t,r,s,i,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof Yt){let c=this.preMatch.matched.get(l);if(c!=null&&c!=i)return!1;let u=l.dom,d,h=this.isLocked(u)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=ht&&Ys(t,l.outerDeco));if(!h&&l.update(e,t,r,s))return this.destroyBetween(this.index,a),l.dom!=u&&(this.changed=!0),this.index++,!0;if(!h&&(d=this.recreateWrapper(l,e,t,r,s,o)))return this.destroyBetween(this.index,a),this.top.children[this.index]=d,d.contentDOM&&(d.dirty=gn,d.updateChildren(s,o+1),d.dirty=Je),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,r,s,i,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content)||!Ys(r,e.outerDeco)||!s.eq(e.innerDeco))return null;let a=Yt.create(this.top,t,r,s,i,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,r,s,i){let o=Yt.create(this.top,e,t,r,s,i);o.contentDOM&&o.updateChildren(s,i+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,r){let s=this.index<this.top.children.length?this.top.children[this.index]:null;if(s&&s.matchesWidget(e)&&(e==s.widget||!s.widget.type.toDOM.parentNode))this.index++;else{let i=new Mh(this.top,e,t,r);this.top.children.splice(this.index++,0,i),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof In;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof Zi)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((Ae||be)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let r=document.createElement(e);e=="IMG"&&(r.className="ProseMirror-separator",r.alt=""),e=="BR"&&(r.className="ProseMirror-trailingBreak");let s=new Ih(this.top,[],r,null);t!=this.top?t.children.push(s):t.children.splice(this.index++,0,s),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function mv(n,e){let t=e,r=t.children.length,s=n.childCount,i=new Map,o=[];e:for(;s>0;){let a;for(;;)if(r){let c=t.children[r-1];if(c instanceof In)t=c,r=c.children.length;else{a=c,r--;break}}else{if(t==e)break e;r=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=n.child(s-1))break;--s,i.set(a,s),o.push(a)}}return{index:s,matched:i,matches:o.reverse()}}function gv(n,e){return n.type.side-e.type.side}function yv(n,e,t,r){let s=e.locals(n),i=0;if(s.length==0){for(let c=0;c<n.childCount;c++){let u=n.child(c);r(u,s,e.forChild(i,u),c),i+=u.nodeSize}return}let o=0,a=[],l=null;for(let c=0;;){let u,d;for(;o<s.length&&s[o].to==i;){let y=s[o++];y.widget&&(u?(d||(d=[u])).push(y):u=y)}if(u)if(d){d.sort(gv);for(let y=0;y<d.length;y++)t(d[y],c,!!l)}else t(u,c,!!l);let h,f;if(l)f=-1,h=l,l=null;else if(c<n.childCount)f=c,h=n.child(c++);else break;for(let y=0;y<a.length;y++)a[y].to<=i&&a.splice(y--,1);for(;o<s.length&&s[o].from<=i&&s[o].to>i;)a.push(s[o++]);let m=i+h.nodeSize;if(h.isText){let y=m;o<s.length&&s[o].from<y&&(y=s[o].from);for(let b=0;b<a.length;b++)a[b].to<y&&(y=a[b].to);y<m&&(l=h.cut(y-i),h=h.cut(0,y-i),m=y,f=-1)}else for(;o<s.length&&s[o].to<m;)o++;let g=h.isInline&&!h.isLeaf?a.filter(y=>!y.inline):a.slice();r(h,g,e.forChild(i,h),f),i=m}}function bv(n){if(n.nodeName=="UL"||n.nodeName=="OL"){let e=n.style.cssText;n.style.cssText=e+"; list-style: square !important",window.getComputedStyle(n).listStyle,n.style.cssText=e}}function wv(n,e,t,r){for(let s=0,i=0;s<n.childCount&&i<=r;){let o=n.child(s++),a=i;if(i+=o.nodeSize,!o.isText)continue;let l=o.text;for(;s<n.childCount;){let c=n.child(s++);if(i+=c.nodeSize,!c.isText)break;l+=c.text}if(i>=t){if(i>=r&&l.slice(r-e.length-a,r-a)==e)return r-e.length;let c=a<r?l.lastIndexOf(e,r-a-1):-1;if(c>=0&&c+e.length+a>=t)return a+c;if(t==r&&l.length>=r+e.length-a&&l.slice(r-a,r-a+e.length)==e)return r}}return-1}function Ea(n,e,t,r,s){let i=[];for(let o=0,a=0;o<n.length;o++){let l=n[o],c=a,u=a+=l.size;c>=t||u<=e?i.push(l):(c<e&&i.push(l.slice(0,e-c,r)),s&&(i.push(s),s=void 0),u>t&&i.push(l.slice(t-c,l.size,r)))}return i}function ml(n,e=null){let t=n.domSelectionRange(),r=n.state.doc;if(!t.focusNode)return null;let s=n.docView.nearestDesc(t.focusNode),i=s&&s.size==0,o=n.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=r.resolve(o),l,c;if(Qi(t)){for(l=o;s&&!s.node;)s=s.parent;let d=s.node;if(s&&d.isAtom&&N.isSelectable(d)&&s.parent&&!(d.isInline&&Ww(t.focusNode,t.focusOffset,s.dom))){let h=s.posBefore;c=new N(o==h?a:r.resolve(h))}}else{if(t instanceof n.dom.ownerDocument.defaultView.Selection&&t.rangeCount>1){let d=o,h=o;for(let f=0;f<t.rangeCount;f++){let m=t.getRangeAt(f);d=Math.min(d,n.docView.posFromDOM(m.startContainer,m.startOffset,1)),h=Math.max(h,n.docView.posFromDOM(m.endContainer,m.endOffset,-1))}if(d<0)return null;[l,o]=h==n.state.selection.anchor?[h,d]:[d,h],a=r.resolve(o)}else l=n.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(l<0)return null}let u=r.resolve(l);if(!c){let d=e=="pointer"||n.state.selection.head<a.pos&&!i?1:-1;c=gl(n,u,a,d)}return c}function $h(n){return n.editable?n.hasFocus():jh(n)&&document.activeElement&&document.activeElement.contains(n.dom)}function xt(n,e=!1){let t=n.state.selection;if(Dh(n,t),!!$h(n)){if(!e&&n.input.mouseDown&&n.input.mouseDown.allowDefault&&be){let r=n.domSelectionRange(),s=n.domObserver.currentSelection;if(r.anchorNode&&s.anchorNode&&Mn(r.anchorNode,r.anchorOffset,s.anchorNode,s.anchorOffset)){n.input.mouseDown.delayedSelectionSync=!0,n.domObserver.setCurSelection();return}}if(n.domObserver.disconnectSelection(),n.cursorWrapper)kv(n);else{let{anchor:r,head:s}=t,i,o;tu&&!(t instanceof j)&&(t.$from.parent.inlineContent||(i=nu(n,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=nu(n,t.to))),n.docView.setSelection(r,s,n,e),tu&&(i&&ru(i),o&&ru(o)),t.visible?n.dom.classList.remove("ProseMirror-hideselection"):(n.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&vv(n))}n.domObserver.setCurSelection(),n.domObserver.connectSelection()}}const tu=Ae||be&&Sh<63;function nu(n,e){let{node:t,offset:r}=n.docView.domFromPos(e,0),s=r<t.childNodes.length?t.childNodes[r]:null,i=r?t.childNodes[r-1]:null;if(Ae&&s&&s.contentEditable=="false")return No(s);if((!s||s.contentEditable=="false")&&(!i||i.contentEditable=="false")){if(s)return No(s);if(i)return No(i)}}function No(n){return n.contentEditable="true",Ae&&n.draggable&&(n.draggable=!1,n.wasDraggable=!0),n}function ru(n){n.contentEditable="false",n.wasDraggable&&(n.draggable=!0,n.wasDraggable=null)}function vv(n){let e=n.dom.ownerDocument;e.removeEventListener("selectionchange",n.input.hideSelectionGuard);let t=n.domSelectionRange(),r=t.anchorNode,s=t.anchorOffset;e.addEventListener("selectionchange",n.input.hideSelectionGuard=()=>{(t.anchorNode!=r||t.anchorOffset!=s)&&(e.removeEventListener("selectionchange",n.input.hideSelectionGuard),setTimeout(()=>{(!$h(n)||n.state.selection.visible)&&n.dom.classList.remove("ProseMirror-hideselection")},20))})}function kv(n){let e=n.domSelection();if(!e)return;let t=n.cursorWrapper.dom,r=t.nodeName=="IMG";r?e.collapse(t.parentNode,xe(t)+1):e.collapse(t,0),!r&&!n.state.selection.visible&&Pe&&Gt<=11&&(t.disabled=!0,t.disabled=!1)}function Dh(n,e){if(e instanceof N){let t=n.docView.descAt(e.from);t!=n.lastSelectedViewDesc&&(su(n),t&&t.selectNode(),n.lastSelectedViewDesc=t)}else su(n)}function su(n){n.lastSelectedViewDesc&&(n.lastSelectedViewDesc.parent&&n.lastSelectedViewDesc.deselectNode(),n.lastSelectedViewDesc=void 0)}function gl(n,e,t,r){return n.someProp("createSelectionBetween",s=>s(n,e,t))||j.between(e,t,r)}function iu(n){return n.editable&&!n.hasFocus()?!1:jh(n)}function jh(n){let e=n.domSelectionRange();if(!e.anchorNode)return!1;try{return n.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(n.editable||n.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function Sv(n){let e=n.docView.domFromPos(n.state.selection.anchor,0),t=n.domSelectionRange();return Mn(e.node,e.offset,t.anchorNode,t.anchorOffset)}function Ca(n,e){let{$anchor:t,$head:r}=n.selection,s=e>0?t.max(r):t.min(r),i=s.parent.inlineContent?s.depth?n.doc.resolve(e>0?s.after():s.before()):null:s;return i&&F.findFrom(i,e)}function jt(n,e){return n.dispatch(n.state.tr.setSelection(e).scrollIntoView()),!0}function ou(n,e,t){let r=n.state.selection;if(r instanceof j)if(t.indexOf("s")>-1){let{$head:s}=r,i=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter;if(!i||i.isText||!i.isLeaf)return!1;let o=n.state.doc.resolve(s.pos+i.nodeSize*(e<0?-1:1));return jt(n,new j(r.$anchor,o))}else if(r.empty){if(n.endOfTextblock(e>0?"forward":"backward")){let s=Ca(n.state,e);return s&&s instanceof N?jt(n,s):!1}else if(!(Ve&&t.indexOf("m")>-1)){let s=r.$head,i=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter,o;if(!i||i.isText)return!1;let a=e<0?s.pos-i.nodeSize:s.pos;return i.isAtom||(o=n.docView.descAt(a))&&!o.contentDOM?N.isSelectable(i)?jt(n,new N(e<0?n.state.doc.resolve(s.pos-i.nodeSize):s)):ls?jt(n,new j(n.state.doc.resolve(e<0?a:a+i.nodeSize))):!1:!1}}else return!1;else{if(r instanceof N&&r.node.isInline)return jt(n,new j(e>0?r.$to:r.$from));{let s=Ca(n.state,e);return s?jt(n,s):!1}}}function Xs(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function Mr(n,e){let t=n.pmViewDesc;return t&&t.size==0&&(e<0||n.nextSibling||n.nodeName!="BR")}function Un(n,e){return e<0?_v(n):xv(n)}function _v(n){let e=n.domSelectionRange(),t=e.focusNode,r=e.focusOffset;if(!t)return;let s,i,o=!1;for(Ke&&t.nodeType==1&&r<Xs(t)&&Mr(t.childNodes[r],-1)&&(o=!0);;)if(r>0){if(t.nodeType!=1)break;{let a=t.childNodes[r-1];if(Mr(a,-1))s=t,i=--r;else if(a.nodeType==3)t=a,r=t.nodeValue.length;else break}}else{if(Lh(t))break;{let a=t.previousSibling;for(;a&&Mr(a,-1);)s=t.parentNode,i=xe(a),a=a.previousSibling;if(a)t=a,r=Xs(t);else{if(t=t.parentNode,t==n.dom)break;r=0}}}o?Aa(n,t,r):s&&Aa(n,s,i)}function xv(n){let e=n.domSelectionRange(),t=e.focusNode,r=e.focusOffset;if(!t)return;let s=Xs(t),i,o;for(;;)if(r<s){if(t.nodeType!=1)break;let a=t.childNodes[r];if(Mr(a,1))i=t,o=++r;else break}else{if(Lh(t))break;{let a=t.nextSibling;for(;a&&Mr(a,1);)i=a.parentNode,o=xe(a)+1,a=a.nextSibling;if(a)t=a,r=0,s=Xs(t);else{if(t=t.parentNode,t==n.dom)break;r=s=0}}}i&&Aa(n,i,o)}function Lh(n){let e=n.pmViewDesc;return e&&e.node&&e.node.isBlock}function Tv(n,e){for(;n&&e==n.childNodes.length&&!as(n);)e=xe(n)+1,n=n.parentNode;for(;n&&e<n.childNodes.length;){let t=n.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=0}}function Ev(n,e){for(;n&&!e&&!as(n);)e=xe(n),n=n.parentNode;for(;n&&e;){let t=n.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=n.childNodes.length}}function Aa(n,e,t){if(e.nodeType!=3){let i,o;(o=Tv(e,t))?(e=o,t=0):(i=Ev(e,t))&&(e=i,t=i.nodeValue.length)}let r=n.domSelection();if(!r)return;if(Qi(r)){let i=document.createRange();i.setEnd(e,t),i.setStart(e,t),r.removeAllRanges(),r.addRange(i)}else r.extend&&r.extend(e,t);n.domObserver.setCurSelection();let{state:s}=n;setTimeout(()=>{n.state==s&&xt(n)},50)}function au(n,e){let t=n.state.doc.resolve(e);if(!(be||_h)&&t.parent.inlineContent){let s=n.coordsAtPos(e);if(e>t.start()){let i=n.coordsAtPos(e-1),o=(i.top+i.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(i.left-s.left)>1)return i.left<s.left?"ltr":"rtl"}if(e<t.end()){let i=n.coordsAtPos(e+1),o=(i.top+i.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(i.left-s.left)>1)return i.left>s.left?"ltr":"rtl"}}return getComputedStyle(n.dom).direction=="rtl"?"rtl":"ltr"}function lu(n,e,t){let r=n.state.selection;if(r instanceof j&&!r.empty||t.indexOf("s")>-1||Ve&&t.indexOf("m")>-1)return!1;let{$from:s,$to:i}=r;if(!s.parent.inlineContent||n.endOfTextblock(e<0?"up":"down")){let o=Ca(n.state,e);if(o&&o instanceof N)return jt(n,o)}if(!s.parent.inlineContent){let o=e<0?s:i,a=r instanceof ze?F.near(o,e):F.findFrom(o,e);return a?jt(n,a):!1}return!1}function cu(n,e){if(!(n.state.selection instanceof j))return!0;let{$head:t,$anchor:r,empty:s}=n.state.selection;if(!t.sameParent(r))return!0;if(!s)return!1;if(n.endOfTextblock(e>0?"forward":"backward"))return!0;let i=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(i&&!i.isText){let o=n.state.tr;return e<0?o.delete(t.pos-i.nodeSize,t.pos):o.delete(t.pos,t.pos+i.nodeSize),n.dispatch(o),!0}return!1}function uu(n,e,t){n.domObserver.stop(),e.contentEditable=t,n.domObserver.start()}function Cv(n){if(!Ae||n.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let r=e.firstChild;uu(n,r,"true"),setTimeout(()=>uu(n,r,"false"),20)}return!1}function Av(n){let e="";return n.ctrlKey&&(e+="c"),n.metaKey&&(e+="m"),n.altKey&&(e+="a"),n.shiftKey&&(e+="s"),e}function Ov(n,e){let t=e.keyCode,r=Av(e);if(t==8||Ve&&t==72&&r=="c")return cu(n,-1)||Un(n,-1);if(t==46&&!e.shiftKey||Ve&&t==68&&r=="c")return cu(n,1)||Un(n,1);if(t==13||t==27)return!0;if(t==37||Ve&&t==66&&r=="c"){let s=t==37?au(n,n.state.selection.from)=="ltr"?-1:1:-1;return ou(n,s,r)||Un(n,s)}else if(t==39||Ve&&t==70&&r=="c"){let s=t==39?au(n,n.state.selection.from)=="ltr"?1:-1:1;return ou(n,s,r)||Un(n,s)}else{if(t==38||Ve&&t==80&&r=="c")return lu(n,-1,r)||Un(n,-1);if(t==40||Ve&&t==78&&r=="c")return Cv(n)||lu(n,1,r)||Un(n,1);if(r==(Ve?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function yl(n,e){n.someProp("transformCopied",f=>{e=f(e,n)});let t=[],{content:r,openStart:s,openEnd:i}=e;for(;s>1&&i>1&&r.childCount==1&&r.firstChild.childCount==1;){s--,i--;let f=r.firstChild;t.push(f.type.name,f.attrs!=f.type.defaultAttrs?f.attrs:null),r=f.content}let o=n.someProp("clipboardSerializer")||Pn.fromSchema(n.state.schema),a=Vh(),l=a.createElement("div");l.appendChild(o.serializeFragment(r,{document:a}));let c=l.firstChild,u,d=0;for(;c&&c.nodeType==1&&(u=Hh[c.nodeName.toLowerCase()]);){for(let f=u.length-1;f>=0;f--){let m=a.createElement(u[f]);for(;l.firstChild;)m.appendChild(l.firstChild);l.appendChild(m),d++}c=l.firstChild}c&&c.nodeType==1&&c.setAttribute("data-pm-slice",`${s} ${i}${d?` -${d}`:""} ${JSON.stringify(t)}`);let h=n.someProp("clipboardTextSerializer",f=>f(e,n))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:h,slice:e}}function Bh(n,e,t,r,s){let i=s.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=!!e&&(r||i||!t);if(l){if(n.someProp("transformPastedText",h=>{e=h(e,i||r,n)}),i)return a=new A(_.from(n.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0),n.someProp("transformPasted",h=>{a=h(a,n,!0)}),a;let d=n.someProp("clipboardTextParser",h=>h(e,s,r,n));if(d)a=d;else{let h=s.marks(),{schema:f}=n.state,m=Pn.fromSchema(f);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(g=>{let y=o.appendChild(document.createElement("p"));g&&y.appendChild(m.serializeNode(f.text(g,h)))})}}else n.someProp("transformPastedHTML",d=>{t=d(t,n)}),o=Rv(t),ls&&Pv(o);let c=o&&o.querySelector("[data-pm-slice]"),u=c&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"");if(u&&u[3])for(let d=+u[3];d>0;d--){let h=o.firstChild;for(;h&&h.nodeType!=1;)h=h.nextSibling;if(!h)break;o=h}if(a||(a=(n.someProp("clipboardParser")||n.someProp("domParser")||Jt.fromSchema(n.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||u),context:s,ruleFromNode(h){return h.nodeName=="BR"&&!h.nextSibling&&h.parentNode&&!Mv.test(h.parentNode.nodeName)?{ignore:!0}:null}})),u)a=$v(du(a,+u[1],+u[2]),u[4]);else if(a=A.maxOpen(Iv(a.content,s),!0),a.openStart||a.openEnd){let d=0,h=0;for(let f=a.content.firstChild;d<a.openStart&&!f.type.spec.isolating;d++,f=f.firstChild);for(let f=a.content.lastChild;h<a.openEnd&&!f.type.spec.isolating;h++,f=f.lastChild);a=du(a,d,h)}return n.someProp("transformPasted",d=>{a=d(a,n,l)}),a}const Mv=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Iv(n,e){if(n.childCount<2)return n;for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.index(t)),i,o=[];if(n.forEach(a=>{if(!o)return;let l=s.findWrapping(a.type),c;if(!l)return o=null;if(c=o.length&&i.length&&Fh(l,i,a,o[o.length-1],0))o[o.length-1]=c;else{o.length&&(o[o.length-1]=Uh(o[o.length-1],i.length));let u=zh(a,l);o.push(u),s=s.matchType(u.type),i=l}}),o)return _.from(o)}return n}function zh(n,e,t=0){for(let r=e.length-1;r>=t;r--)n=e[r].create(null,_.from(n));return n}function Fh(n,e,t,r,s){if(s<n.length&&s<e.length&&n[s]==e[s]){let i=Fh(n,e,t,r.lastChild,s+1);if(i)return r.copy(r.content.replaceChild(r.childCount-1,i));if(r.contentMatchAt(r.childCount).matchType(s==n.length-1?t.type:n[s+1]))return r.copy(r.content.append(_.from(zh(t,n,s+1))))}}function Uh(n,e){if(e==0)return n;let t=n.content.replaceChild(n.childCount-1,Uh(n.lastChild,e-1)),r=n.contentMatchAt(n.childCount).fillBefore(_.empty,!0);return n.copy(t.append(r))}function Oa(n,e,t,r,s,i){let o=e<0?n.firstChild:n.lastChild,a=o.content;return n.childCount>1&&(i=0),s<r-1&&(a=Oa(a,e,t,r,s+1,i)),s>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,i<=s).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(_.empty,!0))),n.replaceChild(e<0?0:n.childCount-1,o.copy(a))}function du(n,e,t){return e<n.openStart&&(n=new A(Oa(n.content,-1,e,n.openStart,0,n.openEnd),e,n.openEnd)),t<n.openEnd&&(n=new A(Oa(n.content,1,t,n.openEnd,0,0),n.openStart,t)),n}const Hh={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let hu=null;function Vh(){return hu||(hu=document.implementation.createHTMLDocument("title"))}let Ro=null;function Nv(n){let e=window.trustedTypes;return e?(Ro||(Ro=e.defaultPolicy||e.createPolicy("ProseMirrorClipboard",{createHTML:t=>t})),Ro.createHTML(n)):n}function Rv(n){let e=/^(\s*<meta [^>]*>)*/.exec(n);e&&(n=n.slice(e[0].length));let t=Vh().createElement("div"),r=/<([a-z][^>\s]+)/i.exec(n),s;if((s=r&&Hh[r[1].toLowerCase()])&&(n=s.map(i=>"<"+i+">").join("")+n+s.map(i=>"</"+i+">").reverse().join("")),t.innerHTML=Nv(n),s)for(let i=0;i<s.length;i++)t=t.querySelector(s[i])||t;return t}function Pv(n){let e=n.querySelectorAll(be?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let r=e[t];r.childNodes.length==1&&r.textContent==""&&r.parentNode&&r.parentNode.replaceChild(n.ownerDocument.createTextNode(" "),r)}}function $v(n,e){if(!n.size)return n;let t=n.content.firstChild.type.schema,r;try{r=JSON.parse(e)}catch{return n}let{content:s,openStart:i,openEnd:o}=n;for(let a=r.length-2;a>=0;a-=2){let l=t.nodes[r[a]];if(!l||l.hasRequiredAttrs())break;s=_.from(l.create(r[a+1],s)),i++,o++}return new A(s,i,o)}const Ie={},Ne={},Dv={touchstart:!0,touchmove:!0};class jv{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:"",button:0},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastChromeDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function Lv(n){for(let e in Ie){let t=Ie[e];n.dom.addEventListener(e,n.input.eventHandlers[e]=r=>{zv(n,r)&&!bl(n,r)&&(n.editable||!(r.type in Ne))&&t(n,r)},Dv[e]?{passive:!0}:void 0)}Ae&&n.dom.addEventListener("input",()=>null),Ma(n)}function Kt(n,e){n.input.lastSelectionOrigin=e,n.input.lastSelectionTime=Date.now()}function Bv(n){n.domObserver.stop();for(let e in n.input.eventHandlers)n.dom.removeEventListener(e,n.input.eventHandlers[e]);clearTimeout(n.input.composingTimeout),clearTimeout(n.input.lastIOSEnterFallbackTimeout)}function Ma(n){n.someProp("handleDOMEvents",e=>{for(let t in e)n.input.eventHandlers[t]||n.dom.addEventListener(t,n.input.eventHandlers[t]=r=>bl(n,r))})}function bl(n,e){return n.someProp("handleDOMEvents",t=>{let r=t[e.type];return r?r(n,e)||e.defaultPrevented:!1})}function zv(n,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=n.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function Fv(n,e){!bl(n,e)&&Ie[e.type]&&(n.editable||!(e.type in Ne))&&Ie[e.type](n,e)}Ne.keydown=(n,e)=>{let t=e;if(n.input.shiftKey=t.keyCode==16||t.shiftKey,!Wh(n,t)&&(n.input.lastKeyCode=t.keyCode,n.input.lastKeyCodeTime=Date.now(),!(St&&be&&t.keyCode==13)))if(t.keyCode!=229&&n.domObserver.forceFlush(),lr&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let r=Date.now();n.input.lastIOSEnter=r,n.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{n.input.lastIOSEnter==r&&(n.someProp("handleKeyDown",s=>s(n,pn(13,"Enter"))),n.input.lastIOSEnter=0)},200)}else n.someProp("handleKeyDown",r=>r(n,t))||Ov(n,t)?t.preventDefault():Kt(n,"key")};Ne.keyup=(n,e)=>{e.keyCode==16&&(n.input.shiftKey=!1)};Ne.keypress=(n,e)=>{let t=e;if(Wh(n,t)||!t.charCode||t.ctrlKey&&!t.altKey||Ve&&t.metaKey)return;if(n.someProp("handleKeyPress",s=>s(n,t))){t.preventDefault();return}let r=n.state.selection;if(!(r instanceof j)||!r.$from.sameParent(r.$to)){let s=String.fromCharCode(t.charCode),i=()=>n.state.tr.insertText(s).scrollIntoView();!/[\r\n]/.test(s)&&!n.someProp("handleTextInput",o=>o(n,r.$from.pos,r.$to.pos,s,i))&&n.dispatch(i()),t.preventDefault()}};function eo(n){return{left:n.clientX,top:n.clientY}}function Uv(n,e){let t=e.x-n.clientX,r=e.y-n.clientY;return t*t+r*r<100}function wl(n,e,t,r,s){if(r==-1)return!1;let i=n.state.doc.resolve(r);for(let o=i.depth+1;o>0;o--)if(n.someProp(e,a=>o>i.depth?a(n,t,i.nodeAfter,i.before(o),s,!0):a(n,t,i.node(o),i.before(o),s,!1)))return!0;return!1}function nr(n,e,t){if(n.focused||n.focus(),n.state.selection.eq(e))return;let r=n.state.tr.setSelection(e);r.setMeta("pointer",!0),n.dispatch(r)}function Hv(n,e){if(e==-1)return!1;let t=n.state.doc.resolve(e),r=t.nodeAfter;return r&&r.isAtom&&N.isSelectable(r)?(nr(n,new N(t)),!0):!1}function Vv(n,e){if(e==-1)return!1;let t=n.state.selection,r,s;t instanceof N&&(r=t.node);let i=n.state.doc.resolve(e);for(let o=i.depth+1;o>0;o--){let a=o>i.depth?i.nodeAfter:i.node(o);if(N.isSelectable(a)){r&&t.$from.depth>0&&o>=t.$from.depth&&i.before(t.$from.depth+1)==t.$from.pos?s=i.before(t.$from.depth):s=i.before(o);break}}return s!=null?(nr(n,N.create(n.state.doc,s)),!0):!1}function qv(n,e,t,r,s){return wl(n,"handleClickOn",e,t,r)||n.someProp("handleClick",i=>i(n,e,r))||(s?Vv(n,t):Hv(n,t))}function Wv(n,e,t,r){return wl(n,"handleDoubleClickOn",e,t,r)||n.someProp("handleDoubleClick",s=>s(n,e,r))}function Kv(n,e,t,r){return wl(n,"handleTripleClickOn",e,t,r)||n.someProp("handleTripleClick",s=>s(n,e,r))||Jv(n,t,r)}function Jv(n,e,t){if(t.button!=0)return!1;let r=n.state.doc;if(e==-1)return r.inlineContent?(nr(n,j.create(r,0,r.content.size)),!0):!1;let s=r.resolve(e);for(let i=s.depth+1;i>0;i--){let o=i>s.depth?s.nodeAfter:s.node(i),a=s.before(i);if(o.inlineContent)nr(n,j.create(r,a+1,a+1+o.content.size));else if(N.isSelectable(o))nr(n,N.create(r,a));else continue;return!0}}function vl(n){return Qs(n)}const qh=Ve?"metaKey":"ctrlKey";Ie.mousedown=(n,e)=>{let t=e;n.input.shiftKey=t.shiftKey;let r=vl(n),s=Date.now(),i="singleClick";s-n.input.lastClick.time<500&&Uv(t,n.input.lastClick)&&!t[qh]&&n.input.lastClick.button==t.button&&(n.input.lastClick.type=="singleClick"?i="doubleClick":n.input.lastClick.type=="doubleClick"&&(i="tripleClick")),n.input.lastClick={time:s,x:t.clientX,y:t.clientY,type:i,button:t.button};let o=n.posAtCoords(eo(t));o&&(i=="singleClick"?(n.input.mouseDown&&n.input.mouseDown.done(),n.input.mouseDown=new Gv(n,o,t,!!r)):(i=="doubleClick"?Wv:Kv)(n,o.pos,o.inside,t)?t.preventDefault():Kt(n,"pointer"))};class Gv{constructor(e,t,r,s){this.view=e,this.pos=t,this.event=r,this.flushed=s,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!r[qh],this.allowDefault=r.shiftKey;let i,o;if(t.inside>-1)i=e.state.doc.nodeAt(t.inside),o=t.inside;else{let u=e.state.doc.resolve(t.pos);i=u.parent,o=u.depth?u.before():0}const a=s?null:r.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.nodeDOM.nodeType==1?l.nodeDOM:null;let{selection:c}=e.state;(r.button==0&&i.type.spec.draggable&&i.type.spec.selectable!==!1||c instanceof N&&c.from<=o&&c.to>o)&&(this.mightDrag={node:i,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&Ke&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),Kt(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>xt(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(eo(e))),this.updateAllowDefault(e),this.allowDefault||!t?Kt(this.view,"pointer"):qv(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||Ae&&this.mightDrag&&!this.mightDrag.node.isAtom||be&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(nr(this.view,F.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):Kt(this.view,"pointer")}move(e){this.updateAllowDefault(e),Kt(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}Ie.touchstart=n=>{n.input.lastTouch=Date.now(),vl(n),Kt(n,"pointer")};Ie.touchmove=n=>{n.input.lastTouch=Date.now(),Kt(n,"pointer")};Ie.contextmenu=n=>vl(n);function Wh(n,e){return n.composing?!0:Ae&&Math.abs(e.timeStamp-n.input.compositionEndedAt)<500?(n.input.compositionEndedAt=-2e8,!0):!1}const Yv=St?5e3:-1;Ne.compositionstart=Ne.compositionupdate=n=>{if(!n.composing){n.domObserver.flush();let{state:e}=n,t=e.selection.$to;if(e.selection instanceof j&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(r=>r.type.spec.inclusive===!1)||be&&_h&&Xv(n)))n.markCursor=n.state.storedMarks||t.marks(),Qs(n,!0),n.markCursor=null;else if(Qs(n,!e.selection.empty),Ke&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let r=n.domSelectionRange();for(let s=r.focusNode,i=r.focusOffset;s&&s.nodeType==1&&i!=0;){let o=i<0?s.lastChild:s.childNodes[i-1];if(!o)break;if(o.nodeType==3){let a=n.domSelection();a&&a.collapse(o,o.nodeValue.length);break}else s=o,i=-1}}n.input.composing=!0}Kh(n,Yv)};function Xv(n){let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(!e||e.nodeType!=1||t>=e.childNodes.length)return!1;let r=e.childNodes[t];return r.nodeType==1&&r.contentEditable=="false"}Ne.compositionend=(n,e)=>{n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=e.timeStamp,n.input.compositionPendingChanges=n.domObserver.pendingRecords().length?n.input.compositionID:0,n.input.compositionNode=null,n.input.compositionPendingChanges&&Promise.resolve().then(()=>n.domObserver.flush()),n.input.compositionID++,Kh(n,20))};function Kh(n,e){clearTimeout(n.input.composingTimeout),e>-1&&(n.input.composingTimeout=setTimeout(()=>Qs(n),e))}function Jh(n){for(n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=Zv());n.input.compositionNodes.length>0;)n.input.compositionNodes.pop().markParentsDirty()}function Qv(n){let e=n.domSelectionRange();if(!e.focusNode)return null;let t=Vw(e.focusNode,e.focusOffset),r=qw(e.focusNode,e.focusOffset);if(t&&r&&t!=r){let s=r.pmViewDesc,i=n.domObserver.lastChangedTextNode;if(t==i||r==i)return i;if(!s||!s.isText(r.nodeValue))return r;if(n.input.compositionNode==r){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return r}}return t||r}function Zv(){let n=document.createEvent("Event");return n.initEvent("event",!0,!0),n.timeStamp}function Qs(n,e=!1){if(!(St&&n.domObserver.flushingSoon>=0)){if(n.domObserver.forceFlush(),Jh(n),e||n.docView&&n.docView.dirty){let t=ml(n),r=n.state.selection;return t&&!t.eq(r)?n.dispatch(n.state.tr.setSelection(t)):(n.markCursor||e)&&!r.$from.node(r.$from.sharedDepth(r.to)).inlineContent?n.dispatch(n.state.tr.deleteSelection()):n.updateState(n.state),!0}return!1}}function e0(n,e){if(!n.dom.parentNode)return;let t=n.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let r=getSelection(),s=document.createRange();s.selectNodeContents(e),n.dom.blur(),r.removeAllRanges(),r.addRange(s),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.focus()},50)}const Gr=Pe&&Gt<15||lr&&Gw<604;Ie.copy=Ne.cut=(n,e)=>{let t=e,r=n.state.selection,s=t.type=="cut";if(r.empty)return;let i=Gr?null:t.clipboardData,o=r.content(),{dom:a,text:l}=yl(n,o);i?(t.preventDefault(),i.clearData(),i.setData("text/html",a.innerHTML),i.setData("text/plain",l)):e0(n,a),s&&n.dispatch(n.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function t0(n){return n.openStart==0&&n.openEnd==0&&n.content.childCount==1?n.content.firstChild:null}function n0(n,e){if(!n.dom.parentNode)return;let t=n.input.shiftKey||n.state.selection.$from.parent.type.spec.code,r=n.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(r.contentEditable="true"),r.style.cssText="position: fixed; left: -10000px; top: 10px",r.focus();let s=n.input.shiftKey&&n.input.lastKeyCode!=45;setTimeout(()=>{n.focus(),r.parentNode&&r.parentNode.removeChild(r),t?Yr(n,r.value,null,s,e):Yr(n,r.textContent,r.innerHTML,s,e)},50)}function Yr(n,e,t,r,s){let i=Bh(n,e,t,r,n.state.selection.$from);if(n.someProp("handlePaste",l=>l(n,s,i||A.empty)))return!0;if(!i)return!1;let o=t0(i),a=o?n.state.tr.replaceSelectionWith(o,r):n.state.tr.replaceSelection(i);return n.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function Gh(n){let e=n.getData("text/plain")||n.getData("Text");if(e)return e;let t=n.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Ne.paste=(n,e)=>{let t=e;if(n.composing&&!St)return;let r=Gr?null:t.clipboardData,s=n.input.shiftKey&&n.input.lastKeyCode!=45;r&&Yr(n,Gh(r),r.getData("text/html"),s,t)?t.preventDefault():n0(n,t)};class Yh{constructor(e,t,r){this.slice=e,this.move=t,this.node=r}}const r0=Ve?"altKey":"ctrlKey";function Xh(n,e){let t=n.someProp("dragCopies",r=>!r(e));return t??!e[r0]}Ie.dragstart=(n,e)=>{let t=e,r=n.input.mouseDown;if(r&&r.done(),!t.dataTransfer)return;let s=n.state.selection,i=s.empty?null:n.posAtCoords(eo(t)),o;if(!(i&&i.pos>=s.from&&i.pos<=(s instanceof N?s.to-1:s.to))){if(r&&r.mightDrag)o=N.create(n.state.doc,r.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let d=n.docView.nearestDesc(t.target,!0);d&&d.node.type.spec.draggable&&d!=n.docView&&(o=N.create(n.state.doc,d.posBefore))}}let a=(o||n.state.selection).content(),{dom:l,text:c,slice:u}=yl(n,a);(!t.dataTransfer.files.length||!be||Sh>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(Gr?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",Gr||t.dataTransfer.setData("text/plain",c),n.dragging=new Yh(u,Xh(n,t),o)};Ie.dragend=n=>{let e=n.dragging;window.setTimeout(()=>{n.dragging==e&&(n.dragging=null)},50)};Ne.dragover=Ne.dragenter=(n,e)=>e.preventDefault();Ne.drop=(n,e)=>{try{s0(n,e,n.dragging)}finally{n.dragging=null}};function s0(n,e,t){if(!e.dataTransfer)return;let r=n.posAtCoords(eo(e));if(!r)return;let s=n.state.doc.resolve(r.pos),i=t&&t.slice;i?n.someProp("transformPasted",f=>{i=f(i,n,!1)}):i=Bh(n,Gh(e.dataTransfer),Gr?null:e.dataTransfer.getData("text/html"),!1,s);let o=!!(t&&Xh(n,e));if(n.someProp("handleDrop",f=>f(n,e,i||A.empty,o))){e.preventDefault();return}if(!i)return;e.preventDefault();let a=i?th(n.state.doc,s.pos,i):s.pos;a==null&&(a=s.pos);let l=n.state.tr;if(o){let{node:f}=t;f?f.replace(l):l.deleteSelection()}let c=l.mapping.map(a),u=i.openStart==0&&i.openEnd==0&&i.content.childCount==1,d=l.doc;if(u?l.replaceRangeWith(c,c,i.content.firstChild):l.replaceRange(c,c,i),l.doc.eq(d))return;let h=l.doc.resolve(c);if(u&&N.isSelectable(i.content.firstChild)&&h.nodeAfter&&h.nodeAfter.sameMarkup(i.content.firstChild))l.setSelection(new N(h));else{let f=l.mapping.map(a);l.mapping.maps[l.mapping.maps.length-1].forEach((m,g,y,b)=>f=b),l.setSelection(gl(n,h,l.doc.resolve(f)))}n.focus(),n.dispatch(l.setMeta("uiEvent","drop"))}Ie.focus=n=>{n.input.lastFocus=Date.now(),n.focused||(n.domObserver.stop(),n.dom.classList.add("ProseMirror-focused"),n.domObserver.start(),n.focused=!0,setTimeout(()=>{n.docView&&n.hasFocus()&&!n.domObserver.currentSelection.eq(n.domSelectionRange())&&xt(n)},20))};Ie.blur=(n,e)=>{let t=e;n.focused&&(n.domObserver.stop(),n.dom.classList.remove("ProseMirror-focused"),n.domObserver.start(),t.relatedTarget&&n.dom.contains(t.relatedTarget)&&n.domObserver.currentSelection.clear(),n.focused=!1)};Ie.beforeinput=(n,e)=>{if(be&&St&&e.inputType=="deleteContentBackward"){n.domObserver.flushSoon();let{domChangeCount:r}=n.input;setTimeout(()=>{if(n.input.domChangeCount!=r||(n.dom.blur(),n.focus(),n.someProp("handleKeyDown",i=>i(n,pn(8,"Backspace")))))return;let{$cursor:s}=n.state.selection;s&&s.pos>0&&n.dispatch(n.state.tr.delete(s.pos-1,s.pos).scrollIntoView())},50)}};for(let n in Ne)Ie[n]=Ne[n];function Xr(n,e){if(n==e)return!0;for(let t in n)if(n[t]!==e[t])return!1;for(let t in e)if(!(t in n))return!1;return!0}class Zs{constructor(e,t){this.toDOM=e,this.spec=t||xn,this.side=this.spec.side||0}map(e,t,r,s){let{pos:i,deleted:o}=e.mapResult(t.from+s,this.side<0?-1:1);return o?null:new Me(i-r,i-r,this)}valid(){return!0}eq(e){return this==e||e instanceof Zs&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&Xr(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class Xt{constructor(e,t){this.attrs=e,this.spec=t||xn}map(e,t,r,s){let i=e.map(t.from+s,this.spec.inclusiveStart?-1:1)-r,o=e.map(t.to+s,this.spec.inclusiveEnd?1:-1)-r;return i>=o?null:new Me(i,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof Xt&&Xr(this.attrs,e.attrs)&&Xr(this.spec,e.spec)}static is(e){return e.type instanceof Xt}destroy(){}}class kl{constructor(e,t){this.attrs=e,this.spec=t||xn}map(e,t,r,s){let i=e.mapResult(t.from+s,1);if(i.deleted)return null;let o=e.mapResult(t.to+s,-1);return o.deleted||o.pos<=i.pos?null:new Me(i.pos-r,o.pos-r,this)}valid(e,t){let{index:r,offset:s}=e.content.findIndex(t.from),i;return s==t.from&&!(i=e.child(r)).isText&&s+i.nodeSize==t.to}eq(e){return this==e||e instanceof kl&&Xr(this.attrs,e.attrs)&&Xr(this.spec,e.spec)}destroy(){}}class Me{constructor(e,t,r){this.from=e,this.to=t,this.type=r}copy(e,t){return new Me(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,r){return this.type.map(e,this,t,r)}static widget(e,t,r){return new Me(e,e,new Zs(t,r))}static inline(e,t,r,s){return new Me(e,t,new Xt(r,s))}static node(e,t,r,s){return new Me(e,t,new kl(r,s))}get spec(){return this.type.spec}get inline(){return this.type instanceof Xt}get widget(){return this.type instanceof Zs}}const Kn=[],xn={};class re{constructor(e,t){this.local=e.length?e:Kn,this.children=t.length?t:Kn}static create(e,t){return t.length?ei(t,e,0,xn):Ee}find(e,t,r){let s=[];return this.findInner(e??0,t??1e9,s,0,r),s}findInner(e,t,r,s,i){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!i||i(a.spec))&&r.push(a.copy(a.from+s,a.to+s))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,r,s+a,i)}}map(e,t,r){return this==Ee||e.maps.length==0?this:this.mapInner(e,t,0,0,r||xn)}mapInner(e,t,r,s,i){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,r,s);l&&l.type.valid(t,l)?(o||(o=[])).push(l):i.onRemove&&i.onRemove(this.local[a].spec)}return this.children.length?i0(this.children,o||[],e,t,r,s,i):o?new re(o.sort(Tn),Kn):Ee}add(e,t){return t.length?this==Ee?re.create(e,t):this.addInner(e,t,0):this}addInner(e,t,r){let s,i=0;e.forEach((a,l)=>{let c=l+r,u;if(u=Zh(t,a,c)){for(s||(s=this.children.slice());i<s.length&&s[i]<l;)i+=3;s[i]==l?s[i+2]=s[i+2].addInner(a,u,c+1):s.splice(i,0,l,l+a.nodeSize,ei(u,a,c+1,xn)),i+=3}});let o=Qh(i?ef(t):t,-r);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new re(o.length?this.local.concat(o).sort(Tn):this.local,s||this.children)}remove(e){return e.length==0||this==Ee?this:this.removeInner(e,0)}removeInner(e,t){let r=this.children,s=this.local;for(let i=0;i<r.length;i+=3){let o,a=r[i]+t,l=r[i+1]+t;for(let u=0,d;u<e.length;u++)(d=e[u])&&d.from>a&&d.to<l&&(e[u]=null,(o||(o=[])).push(d));if(!o)continue;r==this.children&&(r=this.children.slice());let c=r[i+2].removeInner(o,a+1);c!=Ee?r[i+2]=c:(r.splice(i,3),i-=3)}if(s.length){for(let i=0,o;i<e.length;i++)if(o=e[i])for(let a=0;a<s.length;a++)s[a].eq(o,t)&&(s==this.local&&(s=this.local.slice()),s.splice(a--,1))}return r==this.children&&s==this.local?this:s.length||r.length?new re(s,r):Ee}forChild(e,t){if(this==Ee)return this;if(t.isLeaf)return re.empty;let r,s;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(r=this.children[a+2]);break}let i=e+1,o=i+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>i&&l.type instanceof Xt){let c=Math.max(i,l.from)-i,u=Math.min(o,l.to)-i;c<u&&(s||(s=[])).push(l.copy(c,u))}}if(s){let a=new re(s.sort(Tn),Kn);return r?new Ut([a,r]):a}return r||Ee}eq(e){if(this==e)return!0;if(!(e instanceof re)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return Sl(this.localsInner(e))}localsInner(e){if(this==Ee)return Kn;if(e.inlineContent||!this.local.some(Xt.is))return this.local;let t=[];for(let r=0;r<this.local.length;r++)this.local[r].type instanceof Xt||t.push(this.local[r]);return t}forEachSet(e){e(this)}}re.empty=new re([],[]);re.removeOverlap=Sl;const Ee=re.empty;class Ut{constructor(e){this.members=e}map(e,t){const r=this.members.map(s=>s.map(e,t,xn));return Ut.from(r)}forChild(e,t){if(t.isLeaf)return re.empty;let r=[];for(let s=0;s<this.members.length;s++){let i=this.members[s].forChild(e,t);i!=Ee&&(i instanceof Ut?r=r.concat(i.members):r.push(i))}return Ut.from(r)}eq(e){if(!(e instanceof Ut)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,r=!0;for(let s=0;s<this.members.length;s++){let i=this.members[s].localsInner(e);if(i.length)if(!t)t=i;else{r&&(t=t.slice(),r=!1);for(let o=0;o<i.length;o++)t.push(i[o])}}return t?Sl(r?t:t.sort(Tn)):Kn}static from(e){switch(e.length){case 0:return Ee;case 1:return e[0];default:return new Ut(e.every(t=>t instanceof re)?e:e.reduce((t,r)=>t.concat(r instanceof re?r:r.members),[]))}}forEachSet(e){for(let t=0;t<this.members.length;t++)this.members[t].forEachSet(e)}}function i0(n,e,t,r,s,i,o){let a=n.slice();for(let c=0,u=i;c<t.maps.length;c++){let d=0;t.maps[c].forEach((h,f,m,g)=>{let y=g-m-(f-h);for(let b=0;b<a.length;b+=3){let v=a[b+1];if(v<0||h>v+u-d)continue;let w=a[b]+u-d;f>=w?a[b+1]=h<=w?-2:-1:h>=u&&y&&(a[b]+=y,a[b+1]+=y)}d+=y}),u=t.maps[c].map(u,-1)}let l=!1;for(let c=0;c<a.length;c+=3)if(a[c+1]<0){if(a[c+1]==-2){l=!0,a[c+1]=-1;continue}let u=t.map(n[c]+i),d=u-s;if(d<0||d>=r.content.size){l=!0;continue}let h=t.map(n[c+1]+i,-1),f=h-s,{index:m,offset:g}=r.content.findIndex(d),y=r.maybeChild(m);if(y&&g==d&&g+y.nodeSize==f){let b=a[c+2].mapInner(t,y,u+1,n[c]+i+1,o);b!=Ee?(a[c]=d,a[c+1]=f,a[c+2]=b):(a[c+1]=-2,l=!0)}else l=!0}if(l){let c=o0(a,n,e,t,s,i,o),u=ei(c,r,0,o);e=u.local;for(let d=0;d<a.length;d+=3)a[d+1]<0&&(a.splice(d,3),d-=3);for(let d=0,h=0;d<u.children.length;d+=3){let f=u.children[d];for(;h<a.length&&a[h]<f;)h+=3;a.splice(h,0,u.children[d],u.children[d+1],u.children[d+2])}}return new re(e.sort(Tn),a)}function Qh(n,e){if(!e||!n.length)return n;let t=[];for(let r=0;r<n.length;r++){let s=n[r];t.push(new Me(s.from+e,s.to+e,s.type))}return t}function o0(n,e,t,r,s,i,o){function a(l,c){for(let u=0;u<l.local.length;u++){let d=l.local[u].map(r,s,c);d?t.push(d):o.onRemove&&o.onRemove(l.local[u].spec)}for(let u=0;u<l.children.length;u+=3)a(l.children[u+2],l.children[u]+c+1)}for(let l=0;l<n.length;l+=3)n[l+1]==-1&&a(n[l+2],e[l]+i+1);return t}function Zh(n,e,t){if(e.isLeaf)return null;let r=t+e.nodeSize,s=null;for(let i=0,o;i<n.length;i++)(o=n[i])&&o.from>t&&o.to<r&&((s||(s=[])).push(o),n[i]=null);return s}function ef(n){let e=[];for(let t=0;t<n.length;t++)n[t]!=null&&e.push(n[t]);return e}function ei(n,e,t,r){let s=[],i=!1;e.forEach((a,l)=>{let c=Zh(n,a,l+t);if(c){i=!0;let u=ei(c,a,t+l+1,r);u!=Ee&&s.push(l,l+a.nodeSize,u)}});let o=Qh(i?ef(n):n,-t).sort(Tn);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(r.onRemove&&r.onRemove(o[a].spec),o.splice(a--,1));return o.length||s.length?new re(o,s):Ee}function Tn(n,e){return n.from-e.from||n.to-e.to}function Sl(n){let e=n;for(let t=0;t<e.length-1;t++){let r=e[t];if(r.from!=r.to)for(let s=t+1;s<e.length;s++){let i=e[s];if(i.from==r.from){i.to!=r.to&&(e==n&&(e=n.slice()),e[s]=i.copy(i.from,r.to),fu(e,s+1,i.copy(r.to,i.to)));continue}else{i.from<r.to&&(e==n&&(e=n.slice()),e[t]=r.copy(r.from,i.from),fu(e,s,r.copy(i.from,r.to)));break}}}return e}function fu(n,e,t){for(;e<n.length&&Tn(t,n[e])>0;)e++;n.splice(e,0,t)}function Po(n){let e=[];return n.someProp("decorations",t=>{let r=t(n.state);r&&r!=Ee&&e.push(r)}),n.cursorWrapper&&e.push(re.create(n.state.doc,[n.cursorWrapper.deco])),Ut.from(e)}const a0={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},l0=Pe&&Gt<=11;class c0{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class u0{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new c0,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(r=>{for(let s=0;s<r.length;s++)this.queue.push(r[s]);Pe&&Gt<=11&&r.some(s=>s.type=="childList"&&s.removedNodes.length||s.type=="characterData"&&s.oldValue.length>s.target.nodeValue.length)?this.flushSoon():this.flush()}),l0&&(this.onCharData=r=>{this.queue.push({target:r.target,type:"characterData",oldValue:r.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,a0)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(iu(this.view)){if(this.suppressingSelectionUpdates)return xt(this.view);if(Pe&&Gt<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Mn(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,r;for(let i=e.focusNode;i;i=ar(i))t.add(i);for(let i=e.anchorNode;i;i=ar(i))if(t.has(i)){r=i;break}let s=r&&this.view.docView.nearestDesc(r);if(s&&s.ignoreMutation({type:"selection",target:r.nodeType==3?r.parentNode:r}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let r=e.domSelectionRange(),s=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(r)&&iu(e)&&!this.ignoreSelectionChange(r),i=-1,o=-1,a=!1,l=[];if(e.editable)for(let u=0;u<t.length;u++){let d=this.registerMutation(t[u],l);d&&(i=i<0?d.from:Math.min(d.from,i),o=o<0?d.to:Math.max(d.to,o),d.typeOver&&(a=!0))}if(Ke&&l.length){let u=l.filter(d=>d.nodeName=="BR");if(u.length==2){let[d,h]=u;d.parentNode&&d.parentNode.parentNode==h.parentNode?h.remove():d.remove()}else{let{focusNode:d}=this.currentSelection;for(let h of u){let f=h.parentNode;f&&f.nodeName=="LI"&&(!d||f0(e,d)!=f)&&h.remove()}}}else if((be||Ae)&&l.some(u=>u.nodeName=="BR")&&(e.input.lastKeyCode==8||e.input.lastKeyCode==46)){for(let u of l)if(u.nodeName=="BR"&&u.parentNode){let d=u.nextSibling;d&&d.nodeType==1&&d.contentEditable=="false"&&u.parentNode.removeChild(u)}}let c=null;i<0&&s&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Qi(r)&&(c=ml(e))&&c.eq(F.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,xt(e),this.currentSelection.set(r),e.scrollToSelection()):(i>-1||s)&&(i>-1&&(e.docView.markDirty(i,o),d0(e)),this.handleDOMChange(i,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(r)||xt(e),this.currentSelection.set(r))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let r=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(r==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!r||r.ignoreMutation(e))return null;if(e.type=="childList"){for(let u=0;u<e.addedNodes.length;u++){let d=e.addedNodes[u];t.push(d),d.nodeType==3&&(this.lastChangedTextNode=d)}if(r.contentDOM&&r.contentDOM!=r.dom&&!r.contentDOM.contains(e.target))return{from:r.posBefore,to:r.posAfter};let s=e.previousSibling,i=e.nextSibling;if(Pe&&Gt<=11&&e.addedNodes.length)for(let u=0;u<e.addedNodes.length;u++){let{previousSibling:d,nextSibling:h}=e.addedNodes[u];(!d||Array.prototype.indexOf.call(e.addedNodes,d)<0)&&(s=d),(!h||Array.prototype.indexOf.call(e.addedNodes,h)<0)&&(i=h)}let o=s&&s.parentNode==e.target?xe(s)+1:0,a=r.localPosFromDOM(e.target,o,-1),l=i&&i.parentNode==e.target?xe(i):e.target.childNodes.length,c=r.localPosFromDOM(e.target,l,1);return{from:a,to:c}}else return e.type=="attributes"?{from:r.posAtStart-r.border,to:r.posAtEnd+r.border}:(this.lastChangedTextNode=e.target,{from:r.posAtStart,to:r.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let pu=new WeakMap,mu=!1;function d0(n){if(!pu.has(n)&&(pu.set(n,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(n.dom).whiteSpace)!==-1)){if(n.requiresGeckoHackNode=Ke,mu)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),mu=!0}}function gu(n,e){let t=e.startContainer,r=e.startOffset,s=e.endContainer,i=e.endOffset,o=n.domAtPos(n.state.selection.anchor);return Mn(o.node,o.offset,s,i)&&([t,r,s,i]=[s,i,t,r]),{anchorNode:t,anchorOffset:r,focusNode:s,focusOffset:i}}function h0(n,e){if(e.getComposedRanges){let s=e.getComposedRanges(n.root)[0];if(s)return gu(n,s)}let t;function r(s){s.preventDefault(),s.stopImmediatePropagation(),t=s.getTargetRanges()[0]}return n.dom.addEventListener("beforeinput",r,!0),document.execCommand("indent"),n.dom.removeEventListener("beforeinput",r,!0),t?gu(n,t):null}function f0(n,e){for(let t=e.parentNode;t&&t!=n.dom;t=t.parentNode){let r=n.docView.nearestDesc(t,!0);if(r&&r.node.isBlock)return t}return null}function p0(n,e,t){let{node:r,fromOffset:s,toOffset:i,from:o,to:a}=n.docView.parseRange(e,t),l=n.domSelectionRange(),c,u=l.anchorNode;if(u&&n.dom.contains(u.nodeType==1?u:u.parentNode)&&(c=[{node:u,offset:l.anchorOffset}],Qi(l)||c.push({node:l.focusNode,offset:l.focusOffset})),be&&n.input.lastKeyCode===8)for(let y=i;y>s;y--){let b=r.childNodes[y-1],v=b.pmViewDesc;if(b.nodeName=="BR"&&!v){i=y;break}if(!v||v.size)break}let d=n.state.doc,h=n.someProp("domParser")||Jt.fromSchema(n.state.schema),f=d.resolve(o),m=null,g=h.parse(r,{topNode:f.parent,topMatch:f.parent.contentMatchAt(f.index()),topOpen:!0,from:s,to:i,preserveWhitespace:f.parent.type.whitespace=="pre"?"full":!0,findPositions:c,ruleFromNode:m0,context:f});if(c&&c[0].pos!=null){let y=c[0].pos,b=c[1]&&c[1].pos;b==null&&(b=y),m={anchor:y+o,head:b+o}}return{doc:g,sel:m,from:o,to:a}}function m0(n){let e=n.pmViewDesc;if(e)return e.parseRule();if(n.nodeName=="BR"&&n.parentNode){if(Ae&&/^(ul|ol)$/i.test(n.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(n.parentNode.lastChild==n||Ae&&/^(tr|table)$/i.test(n.parentNode.nodeName))return{ignore:!0}}else if(n.nodeName=="IMG"&&n.getAttribute("mark-placeholder"))return{ignore:!0};return null}const g0=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|img|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function y0(n,e,t,r,s){let i=n.input.compositionPendingChanges||(n.composing?n.input.compositionID:0);if(n.input.compositionPendingChanges=0,e<0){let x=n.input.lastSelectionTime>Date.now()-50?n.input.lastSelectionOrigin:null,C=ml(n,x);if(C&&!n.state.selection.eq(C)){if(be&&St&&n.input.lastKeyCode===13&&Date.now()-100<n.input.lastKeyCodeTime&&n.someProp("handleKeyDown",X=>X(n,pn(13,"Enter"))))return;let R=n.state.tr.setSelection(C);x=="pointer"?R.setMeta("pointer",!0):x=="key"&&R.scrollIntoView(),i&&R.setMeta("composition",i),n.dispatch(R)}return}let o=n.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=n.state.doc.resolve(t).after(a+1);let l=n.state.selection,c=p0(n,e,t),u=n.state.doc,d=u.slice(c.from,c.to),h,f;n.input.lastKeyCode===8&&Date.now()-100<n.input.lastKeyCodeTime?(h=n.state.selection.to,f="end"):(h=n.state.selection.from,f="start"),n.input.lastKeyCode=null;let m=v0(d.content,c.doc.content,c.from,h,f);if(m&&n.input.domChangeCount++,(lr&&n.input.lastIOSEnter>Date.now()-225||St)&&s.some(x=>x.nodeType==1&&!g0.test(x.nodeName))&&(!m||m.endA>=m.endB)&&n.someProp("handleKeyDown",x=>x(n,pn(13,"Enter")))){n.input.lastIOSEnter=0;return}if(!m)if(r&&l instanceof j&&!l.empty&&l.$head.sameParent(l.$anchor)&&!n.composing&&!(c.sel&&c.sel.anchor!=c.sel.head))m={start:l.from,endA:l.to,endB:l.to};else{if(c.sel){let x=yu(n,n.state.doc,c.sel);if(x&&!x.eq(n.state.selection)){let C=n.state.tr.setSelection(x);i&&C.setMeta("composition",i),n.dispatch(C)}}return}n.state.selection.from<n.state.selection.to&&m.start==m.endB&&n.state.selection instanceof j&&(m.start>n.state.selection.from&&m.start<=n.state.selection.from+2&&n.state.selection.from>=c.from?m.start=n.state.selection.from:m.endA<n.state.selection.to&&m.endA>=n.state.selection.to-2&&n.state.selection.to<=c.to&&(m.endB+=n.state.selection.to-m.endA,m.endA=n.state.selection.to)),Pe&&Gt<=11&&m.endB==m.start+1&&m.endA==m.start&&m.start>c.from&&c.doc.textBetween(m.start-c.from-1,m.start-c.from+1)==" "&&(m.start--,m.endA--,m.endB--);let g=c.doc.resolveNoCache(m.start-c.from),y=c.doc.resolveNoCache(m.endB-c.from),b=u.resolve(m.start),v=g.sameParent(y)&&g.parent.inlineContent&&b.end()>=m.endA;if((lr&&n.input.lastIOSEnter>Date.now()-225&&(!v||s.some(x=>x.nodeName=="DIV"||x.nodeName=="P"))||!v&&g.pos<c.doc.content.size&&(!g.sameParent(y)||!g.parent.inlineContent)&&g.pos<y.pos&&!/\S/.test(c.doc.textBetween(g.pos,y.pos,"","")))&&n.someProp("handleKeyDown",x=>x(n,pn(13,"Enter")))){n.input.lastIOSEnter=0;return}if(n.state.selection.anchor>m.start&&w0(u,m.start,m.endA,g,y)&&n.someProp("handleKeyDown",x=>x(n,pn(8,"Backspace")))){St&&be&&n.domObserver.suppressSelectionUpdates();return}be&&m.endB==m.start&&(n.input.lastChromeDelete=Date.now()),St&&!v&&g.start()!=y.start()&&y.parentOffset==0&&g.depth==y.depth&&c.sel&&c.sel.anchor==c.sel.head&&c.sel.head==m.endA&&(m.endB-=2,y=c.doc.resolveNoCache(m.endB-c.from),setTimeout(()=>{n.someProp("handleKeyDown",function(x){return x(n,pn(13,"Enter"))})},20));let w=m.start,k=m.endA,T=x=>{let C=x||n.state.tr.replace(w,k,c.doc.slice(m.start-c.from,m.endB-c.from));if(c.sel){let R=yu(n,C.doc,c.sel);R&&!(be&&n.composing&&R.empty&&(m.start!=m.endB||n.input.lastChromeDelete<Date.now()-100)&&(R.head==w||R.head==C.mapping.map(k)-1)||Pe&&R.empty&&R.head==w)&&C.setSelection(R)}return i&&C.setMeta("composition",i),C.scrollIntoView()},S;if(v)if(g.pos==y.pos){Pe&&Gt<=11&&g.parentOffset==0&&(n.domObserver.suppressSelectionUpdates(),setTimeout(()=>xt(n),20));let x=T(n.state.tr.delete(w,k)),C=u.resolve(m.start).marksAcross(u.resolve(m.endA));C&&x.ensureMarks(C),n.dispatch(x)}else if(m.endA==m.endB&&(S=b0(g.parent.content.cut(g.parentOffset,y.parentOffset),b.parent.content.cut(b.parentOffset,m.endA-b.start())))){let x=T(n.state.tr);S.type=="add"?x.addMark(w,k,S.mark):x.removeMark(w,k,S.mark),n.dispatch(x)}else if(g.parent.child(g.index()).isText&&g.index()==y.index()-(y.textOffset?0:1)){let x=g.parent.textBetween(g.parentOffset,y.parentOffset),C=()=>T(n.state.tr.insertText(x,w,k));n.someProp("handleTextInput",R=>R(n,w,k,x,C))||n.dispatch(C())}else n.dispatch(T());else n.dispatch(T())}function yu(n,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:gl(n,e.resolve(t.anchor),e.resolve(t.head))}function b0(n,e){let t=n.firstChild.marks,r=e.firstChild.marks,s=t,i=r,o,a,l;for(let u=0;u<r.length;u++)s=r[u].removeFromSet(s);for(let u=0;u<t.length;u++)i=t[u].removeFromSet(i);if(s.length==1&&i.length==0)a=s[0],o="add",l=u=>u.mark(a.addToSet(u.marks));else if(s.length==0&&i.length==1)a=i[0],o="remove",l=u=>u.mark(a.removeFromSet(u.marks));else return null;let c=[];for(let u=0;u<e.childCount;u++)c.push(l(e.child(u)));if(_.from(c).eq(n))return{mark:a,type:o}}function w0(n,e,t,r,s){if(t-e<=s.pos-r.pos||$o(r,!0,!1)<s.pos)return!1;let i=n.resolve(e);if(!r.parent.isTextblock){let a=i.nodeAfter;return a!=null&&t==e+a.nodeSize}if(i.parentOffset<i.parent.content.size||!i.parent.isTextblock)return!1;let o=n.resolve($o(i,!0,!0));return!o.parent.isTextblock||o.pos>t||$o(o,!0,!1)<t?!1:r.parent.content.cut(r.parentOffset).eq(o.parent.content)}function $o(n,e,t){let r=n.depth,s=e?n.end():n.pos;for(;r>0&&(e||n.indexAfter(r)==n.node(r).childCount);)r--,s++,e=!1;if(t){let i=n.node(r).maybeChild(n.indexAfter(r));for(;i&&!i.isLeaf;)i=i.firstChild,s++}return s}function v0(n,e,t,r,s){let i=n.findDiffStart(e,t);if(i==null)return null;let{a:o,b:a}=n.findDiffEnd(e,t+n.size,t+e.size);if(s=="end"){let l=Math.max(0,i-Math.min(o,a));r-=o+l-i}if(o<i&&n.size<e.size){let l=r<=i&&r>=o?i-r:0;i-=l,i&&i<e.size&&bu(e.textBetween(i-1,i+1))&&(i+=l?1:-1),a=i+(a-o),o=i}else if(a<i){let l=r<=i&&r>=a?i-r:0;i-=l,i&&i<n.size&&bu(n.textBetween(i-1,i+1))&&(i+=l?1:-1),o=i+(o-a),a=i}return{start:i,endA:o,endB:a}}function bu(n){if(n.length!=2)return!1;let e=n.charCodeAt(0),t=n.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class tf{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new jv,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(_u),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=ku(this),vu(this),this.nodeViews=Su(this),this.docView=Zc(this.state.doc,wu(this),Po(this),this.dom,this),this.domObserver=new u0(this,(r,s,i,o)=>y0(this,r,s,i,o)),this.domObserver.start(),Lv(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&Ma(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(_u),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let r in this._props)t[r]=this._props[r];t.state=this.state;for(let r in e)t[r]=e[r];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var r;let s=this.state,i=!1,o=!1;e.storedMarks&&this.composing&&(Jh(this),o=!0),this.state=e;let a=s.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let f=Su(this);S0(f,this.nodeViews)&&(this.nodeViews=f,i=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&Ma(this),this.editable=ku(this),vu(this);let l=Po(this),c=wu(this),u=s.plugins!=e.plugins&&!s.doc.eq(e.doc)?"reset":e.scrollToSelection>s.scrollToSelection?"to selection":"preserve",d=i||!this.docView.matchesNode(e.doc,c,l);(d||!e.selection.eq(s.selection))&&(o=!0);let h=u=="preserve"&&o&&this.dom.style.overflowAnchor==null&&Qw(this);if(o){this.domObserver.stop();let f=d&&(Pe||be)&&!this.composing&&!s.selection.empty&&!e.selection.empty&&k0(s.selection,e.selection);if(d){let m=be?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=Qv(this)),(i||!this.docView.update(e.doc,c,l,this))&&(this.docView.updateOuterDeco(c),this.docView.destroy(),this.docView=Zc(e.doc,c,l,this.dom,this)),m&&!this.trackWrites&&(f=!0)}f||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&Sv(this))?xt(this,f):(Dh(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(s),!((r=this.dragging)===null||r===void 0)&&r.node&&!s.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,s),u=="reset"?this.dom.scrollTop=0:u=="to selection"?this.scrollToSelection():h&&Zw(h)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!(!e||!this.dom.contains(e.nodeType==1?e:e.parentNode))){if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof N){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&Kc(this,t.getBoundingClientRect(),e)}else Kc(this,this.coordsAtPos(this.state.selection.head,1),e)}}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let r=this.directPlugins[t];r.spec.view&&this.pluginViews.push(r.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let r=this.state.plugins[t];r.spec.view&&this.pluginViews.push(r.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let r=this.pluginViews[t];r.update&&r.update(this,e)}}updateDraggedNode(e,t){let r=e.node,s=-1;if(this.state.doc.nodeAt(r.from)==r.node)s=r.from;else{let i=r.from+(this.state.doc.content.size-t.doc.content.size);(i>0&&this.state.doc.nodeAt(i))==r.node&&(s=i)}this.dragging=new Yh(e.slice,e.move,s<0?void 0:N.create(this.state.doc,s))}someProp(e,t){let r=this._props&&this._props[e],s;if(r!=null&&(s=t?t(r):r))return s;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(s=t?t(a):a))return s}let i=this.state.plugins;if(i)for(let o=0;o<i.length;o++){let a=i[o].props[e];if(a!=null&&(s=t?t(a):a))return s}}hasFocus(){if(Pe){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&ev(this.dom),xt(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return iv(this,e)}coordsAtPos(e,t=1){return Ah(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,r=-1){let s=this.docView.posFromDOM(e,t,r);if(s==null)throw new RangeError("DOM position not inside the editor");return s}endOfTextblock(e,t){return uv(this,t||this.state,e)}pasteHTML(e,t){return Yr(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return Yr(this,e,null,!0,t||new ClipboardEvent("paste"))}serializeForClipboard(e){return yl(this,e)}destroy(){this.docView&&(Bv(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],Po(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,Uw())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return Fv(this,e)}domSelectionRange(){let e=this.domSelection();return e?Ae&&this.root.nodeType===11&&Kw(this.dom.ownerDocument)==this.dom&&h0(this,e)||e:{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0}}domSelection(){return this.root.getSelection()}}tf.prototype.dispatch=function(n){let e=this._props.dispatchTransaction;e?e.call(this,n):this.updateState(this.state.apply(n))};function wu(n){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(n.editable),n.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(n.state)),t)for(let r in t)r=="class"?e.class+=" "+t[r]:r=="style"?e.style=(e.style?e.style+";":"")+t[r]:!e[r]&&r!="contenteditable"&&r!="nodeName"&&(e[r]=String(t[r]))}),e.translate||(e.translate="no"),[Me.node(0,n.state.doc.content.size,e)]}function vu(n){if(n.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),n.cursorWrapper={dom:e,deco:Me.widget(n.state.selection.from,e,{raw:!0,marks:n.markCursor})}}else n.cursorWrapper=null}function ku(n){return!n.someProp("editable",e=>e(n.state)===!1)}function k0(n,e){let t=Math.min(n.$anchor.sharedDepth(n.head),e.$anchor.sharedDepth(e.head));return n.$anchor.start(t)!=e.$anchor.start(t)}function Su(n){let e=Object.create(null);function t(r){for(let s in r)Object.prototype.hasOwnProperty.call(e,s)||(e[s]=r[s])}return n.someProp("nodeViews",t),n.someProp("markViews",t),e}function S0(n,e){let t=0,r=0;for(let s in n){if(n[s]!=e[s])return!0;t++}for(let s in e)r++;return t!=r}function _u(n){if(n.spec.state||n.spec.filterTransaction||n.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}var Qt={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},ti={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},_0=typeof navigator<"u"&&/Mac/.test(navigator.platform),x0=typeof navigator<"u"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);for(var Te=0;Te<10;Te++)Qt[48+Te]=Qt[96+Te]=String(Te);for(var Te=1;Te<=24;Te++)Qt[Te+111]="F"+Te;for(var Te=65;Te<=90;Te++)Qt[Te]=String.fromCharCode(Te+32),ti[Te]=String.fromCharCode(Te);for(var Do in Qt)ti.hasOwnProperty(Do)||(ti[Do]=Qt[Do]);function T0(n){var e=_0&&n.metaKey&&n.shiftKey&&!n.ctrlKey&&!n.altKey||x0&&n.shiftKey&&n.key&&n.key.length==1||n.key=="Unidentified",t=!e&&n.key||(n.shiftKey?ti:Qt)[n.keyCode]||n.key||"Unidentified";return t=="Esc"&&(t="Escape"),t=="Del"&&(t="Delete"),t=="Left"&&(t="ArrowLeft"),t=="Up"&&(t="ArrowUp"),t=="Right"&&(t="ArrowRight"),t=="Down"&&(t="ArrowDown"),t}const E0=typeof navigator<"u"&&/Mac|iP(hone|[oa]d)/.test(navigator.platform),C0=typeof navigator<"u"&&/Win/.test(navigator.platform);function A0(n){let e=n.split(/-(?!$)/),t=e[e.length-1];t=="Space"&&(t=" ");let r,s,i,o;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))r=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))i=!0;else if(/^mod$/i.test(l))E0?o=!0:s=!0;else throw new Error("Unrecognized modifier name: "+l)}return r&&(t="Alt-"+t),s&&(t="Ctrl-"+t),o&&(t="Meta-"+t),i&&(t="Shift-"+t),t}function O0(n){let e=Object.create(null);for(let t in n)e[A0(t)]=n[t];return e}function jo(n,e,t=!0){return e.altKey&&(n="Alt-"+n),e.ctrlKey&&(n="Ctrl-"+n),e.metaKey&&(n="Meta-"+n),t&&e.shiftKey&&(n="Shift-"+n),n}function M0(n){return new se({props:{handleKeyDown:nf(n)}})}function nf(n){let e=O0(n);return function(t,r){let s=T0(r),i,o=e[jo(s,r)];if(o&&o(t.state,t.dispatch,t))return!0;if(s.length==1&&s!=" "){if(r.shiftKey){let a=e[jo(s,r,!1)];if(a&&a(t.state,t.dispatch,t))return!0}if((r.altKey||r.metaKey||r.ctrlKey)&&!(C0&&r.ctrlKey&&r.altKey)&&(i=Qt[r.keyCode])&&i!=s){let a=e[jo(i,r)];if(a&&a(t.state,t.dispatch,t))return!0}}return!1}}var I0=Object.defineProperty,_l=(n,e)=>{for(var t in e)I0(n,t,{get:e[t],enumerable:!0})};function to(n){const{state:e,transaction:t}=n;let{selection:r}=t,{doc:s}=t,{storedMarks:i}=t;return{...e,apply:e.apply.bind(e),applyTransaction:e.applyTransaction.bind(e),plugins:e.plugins,schema:e.schema,reconfigure:e.reconfigure.bind(e),toJSON:e.toJSON.bind(e),get storedMarks(){return i},get selection(){return r},get doc(){return s},get tr(){return r=t.selection,s=t.doc,i=t.storedMarks,t}}}var no=class{constructor(n){this.editor=n.editor,this.rawCommands=this.editor.extensionManager.commands,this.customState=n.state}get hasCustomState(){return!!this.customState}get state(){return this.customState||this.editor.state}get commands(){const{rawCommands:n,editor:e,state:t}=this,{view:r}=e,{tr:s}=t,i=this.buildProps(s);return Object.fromEntries(Object.entries(n).map(([o,a])=>[o,(...c)=>{const u=a(...c)(i);return!s.getMeta("preventDispatch")&&!this.hasCustomState&&r.dispatch(s),u}]))}get chain(){return()=>this.createChain()}get can(){return()=>this.createCan()}createChain(n,e=!0){const{rawCommands:t,editor:r,state:s}=this,{view:i}=r,o=[],a=!!n,l=n||s.tr,c=()=>(!a&&e&&!l.getMeta("preventDispatch")&&!this.hasCustomState&&i.dispatch(l),o.every(d=>d===!0)),u={...Object.fromEntries(Object.entries(t).map(([d,h])=>[d,(...m)=>{const g=this.buildProps(l,e),y=h(...m)(g);return o.push(y),u}])),run:c};return u}createCan(n){const{rawCommands:e,state:t}=this,r=!1,s=n||t.tr,i=this.buildProps(s,r);return{...Object.fromEntries(Object.entries(e).map(([a,l])=>[a,(...c)=>l(...c)({...i,dispatch:void 0})])),chain:()=>this.createChain(s,r)}}buildProps(n,e=!0){const{rawCommands:t,editor:r,state:s}=this,{view:i}=r,o={tr:n,editor:r,view:i,state:to({state:s,transaction:n}),dispatch:e?()=>{}:void 0,chain:()=>this.createChain(n,e),can:()=>this.createCan(n),get commands(){return Object.fromEntries(Object.entries(t).map(([a,l])=>[a,(...c)=>l(...c)(o)]))}};return o}},rf={};_l(rf,{blur:()=>N0,clearContent:()=>R0,clearNodes:()=>P0,command:()=>$0,createParagraphNear:()=>D0,cut:()=>j0,deleteCurrentNode:()=>L0,deleteNode:()=>B0,deleteRange:()=>z0,deleteSelection:()=>F0,enter:()=>U0,exitCode:()=>H0,extendMarkRange:()=>V0,first:()=>q0,focus:()=>K0,forEach:()=>J0,insertContent:()=>G0,insertContentAt:()=>Q0,joinBackward:()=>tk,joinDown:()=>ek,joinForward:()=>nk,joinItemBackward:()=>rk,joinItemForward:()=>sk,joinTextblockBackward:()=>ik,joinTextblockForward:()=>ok,joinUp:()=>Z0,keyboardShortcut:()=>lk,lift:()=>ck,liftEmptyBlock:()=>uk,liftListItem:()=>dk,newlineInCode:()=>hk,resetAttributes:()=>fk,scrollIntoView:()=>pk,selectAll:()=>mk,selectNodeBackward:()=>gk,selectNodeForward:()=>yk,selectParentNode:()=>bk,selectTextblockEnd:()=>wk,selectTextblockStart:()=>vk,setContent:()=>kk,setMark:()=>Fk,setMeta:()=>Uk,setNode:()=>Hk,setNodeSelection:()=>Vk,setTextDirection:()=>qk,setTextSelection:()=>Wk,sinkListItem:()=>Kk,splitBlock:()=>Jk,splitListItem:()=>Gk,toggleList:()=>Yk,toggleMark:()=>Xk,toggleNode:()=>Qk,toggleWrap:()=>Zk,undoInputRule:()=>eS,unsetAllMarks:()=>tS,unsetMark:()=>nS,unsetTextDirection:()=>rS,updateAttributes:()=>sS,wrapIn:()=>iS,wrapInList:()=>oS});var N0=()=>({editor:n,view:e})=>(requestAnimationFrame(()=>{var t;n.isDestroyed||(e.dom.blur(),(t=window?.getSelection())==null||t.removeAllRanges())}),!0),R0=(n=!0)=>({commands:e})=>e.setContent("",{emitUpdate:n}),P0=()=>({state:n,tr:e,dispatch:t})=>{const{selection:r}=e,{ranges:s}=r;return t&&s.forEach(({$from:i,$to:o})=>{n.doc.nodesBetween(i.pos,o.pos,(a,l)=>{if(a.type.isText)return;const{doc:c,mapping:u}=e,d=c.resolve(u.map(l)),h=c.resolve(u.map(l+a.nodeSize)),f=d.blockRange(h);if(!f)return;const m=pr(f);if(a.type.isTextblock){const{defaultType:g}=d.parent.contentMatchAt(d.index());e.setNodeMarkup(f.start,g)}(m||m===0)&&e.lift(f,m)})}),!0},$0=n=>e=>n(e),D0=()=>({state:n,dispatch:e})=>yh(n,e),j0=(n,e)=>({editor:t,tr:r})=>{const{state:s}=t,i=s.doc.slice(n.from,n.to);r.deleteRange(n.from,n.to);const o=r.mapping.map(e);return r.insert(o,i.content),r.setSelection(new j(r.doc.resolve(Math.max(o-1,0)))),!0},L0=()=>({tr:n,dispatch:e})=>{const{selection:t}=n,r=t.$anchor.node();if(r.content.size>0)return!1;const s=n.selection.$anchor;for(let i=s.depth;i>0;i-=1)if(s.node(i).type===r.type){if(e){const a=s.before(i),l=s.after(i);n.delete(a,l).scrollIntoView()}return!0}return!1};function he(n,e){if(typeof n=="string"){if(!e.nodes[n])throw Error(`There is no node type named '${n}'. Maybe you forgot to add the extension?`);return e.nodes[n]}return n}var B0=n=>({tr:e,state:t,dispatch:r})=>{const s=he(n,t.schema),i=e.selection.$anchor;for(let o=i.depth;o>0;o-=1)if(i.node(o).type===s){if(r){const l=i.before(o),c=i.after(o);e.delete(l,c).scrollIntoView()}return!0}return!1},z0=n=>({tr:e,dispatch:t})=>{const{from:r,to:s}=n;return t&&e.delete(r,s),!0},F0=()=>({state:n,dispatch:e})=>cl(n,e),U0=()=>({commands:n})=>n.keyboardShortcut("Enter"),H0=()=>({state:n,dispatch:e})=>Cw(n,e);function xl(n){return Object.prototype.toString.call(n)==="[object RegExp]"}function ni(n,e,t={strict:!0}){const r=Object.keys(e);return r.length?r.every(s=>t.strict?e[s]===n[s]:xl(e[s])?e[s].test(n[s]):e[s]===n[s]):!0}function sf(n,e,t={}){return n.find(r=>r.type===e&&ni(Object.fromEntries(Object.keys(t).map(s=>[s,r.attrs[s]])),t))}function xu(n,e,t={}){return!!sf(n,e,t)}function Tl(n,e,t){var r;if(!n||!e)return;let s=n.parent.childAfter(n.parentOffset);if((!s.node||!s.node.marks.some(u=>u.type===e))&&(s=n.parent.childBefore(n.parentOffset)),!s.node||!s.node.marks.some(u=>u.type===e)||(t=t||((r=s.node.marks[0])==null?void 0:r.attrs),!sf([...s.node.marks],e,t)))return;let o=s.index,a=n.start()+s.offset,l=o+1,c=a+s.node.nodeSize;for(;o>0&&xu([...n.parent.child(o-1).marks],e,t);)o-=1,a-=n.parent.child(o).nodeSize;for(;l<n.parent.childCount&&xu([...n.parent.child(l).marks],e,t);)c+=n.parent.child(l).nodeSize,l+=1;return{from:a,to:c}}function Mt(n,e){if(typeof n=="string"){if(!e.marks[n])throw Error(`There is no mark type named '${n}'. Maybe you forgot to add the extension?`);return e.marks[n]}return n}var V0=(n,e={})=>({tr:t,state:r,dispatch:s})=>{const i=Mt(n,r.schema),{doc:o,selection:a}=t,{$from:l,from:c,to:u}=a;if(s){const d=Tl(l,i,e);if(d&&d.from<=c&&d.to>=u){const h=j.create(o,d.from,d.to);t.setSelection(h)}}return!0},q0=n=>e=>{const t=typeof n=="function"?n(e):n;for(let r=0;r<t.length;r+=1)if(t[r](e))return!0;return!1};function of(n){return n instanceof j}function bn(n=0,e=0,t=0){return Math.min(Math.max(n,e),t)}function af(n,e=null){if(!e)return null;const t=F.atStart(n),r=F.atEnd(n);if(e==="start"||e===!0)return t;if(e==="end")return r;const s=t.from,i=r.to;return e==="all"?j.create(n,bn(0,s,i),bn(n.content.size,s,i)):j.create(n,bn(e,s,i),bn(e,s,i))}function Tu(){return navigator.platform==="Android"||/android/i.test(navigator.userAgent)}function ri(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function W0(){return typeof navigator<"u"?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}var K0=(n=null,e={})=>({editor:t,view:r,tr:s,dispatch:i})=>{e={scrollIntoView:!0,...e};const o=()=>{(ri()||Tu())&&r.dom.focus(),W0()&&!ri()&&!Tu()&&r.dom.focus({preventScroll:!0}),requestAnimationFrame(()=>{t.isDestroyed||(r.focus(),e?.scrollIntoView&&t.commands.scrollIntoView())})};if(r.hasFocus()&&n===null||n===!1)return!0;if(i&&n===null&&!of(t.state.selection))return o(),!0;const a=af(s.doc,n)||t.state.selection,l=t.state.selection.eq(a);return i&&(l||s.setSelection(a),l&&s.storedMarks&&s.setStoredMarks(s.storedMarks),o()),!0},J0=(n,e)=>t=>n.every((r,s)=>e(r,{...t,index:s})),G0=(n,e)=>({tr:t,commands:r})=>r.insertContentAt({from:t.selection.from,to:t.selection.to},n,e),lf=n=>{const e=n.childNodes;for(let t=e.length-1;t>=0;t-=1){const r=e[t];r.nodeType===3&&r.nodeValue&&/^(\n\s\s|\n)$/.test(r.nodeValue)?n.removeChild(r):r.nodeType===1&&lf(r)}return n};function Ss(n){if(typeof window>"u")throw new Error("[tiptap error]: there is no window object available, so this function cannot be used");const e=`<body>${n}</body>`,t=new window.DOMParser().parseFromString(e,"text/html").body;return lf(t)}function Qr(n,e,t){if(n instanceof nt||n instanceof _)return n;t={slice:!0,parseOptions:{},...t};const r=typeof n=="object"&&n!==null,s=typeof n=="string";if(r)try{if(Array.isArray(n)&&n.length>0)return _.fromArray(n.map(a=>e.nodeFromJSON(a)));const o=e.nodeFromJSON(n);return t.errorOnInvalidContent&&o.check(),o}catch(i){if(t.errorOnInvalidContent)throw new Error("[tiptap error]: Invalid JSON content",{cause:i});return console.warn("[tiptap warn]: Invalid content.","Passed value:",n,"Error:",i),Qr("",e,t)}if(s){if(t.errorOnInvalidContent){let o=!1,a="";const l=new Vd({topNode:e.spec.topNode,marks:e.spec.marks,nodes:e.spec.nodes.append({__tiptap__private__unknown__catch__all__node:{content:"inline*",group:"block",parseDOM:[{tag:"*",getAttrs:c=>(o=!0,a=typeof c=="string"?c:c.outerHTML,null)}]}})});if(t.slice?Jt.fromSchema(l).parseSlice(Ss(n),t.parseOptions):Jt.fromSchema(l).parse(Ss(n),t.parseOptions),t.errorOnInvalidContent&&o)throw new Error("[tiptap error]: Invalid HTML content",{cause:new Error(`Invalid element found: ${a}`)})}const i=Jt.fromSchema(e);return t.slice?i.parseSlice(Ss(n),t.parseOptions).content:i.parse(Ss(n),t.parseOptions)}return Qr("",e,t)}function Y0(n,e,t){const r=n.steps.length-1;if(r<e)return;const s=n.steps[r];if(!(s instanceof ye||s instanceof we))return;const i=n.mapping.maps[r];let o=0;i.forEach((a,l,c,u)=>{o===0&&(o=u)}),n.setSelection(F.near(n.doc.resolve(o),t))}var X0=n=>!("type"in n),Q0=(n,e,t)=>({tr:r,dispatch:s,editor:i})=>{var o;if(s){t={parseOptions:i.options.parseOptions,updateSelection:!0,applyInputRules:!1,applyPasteRules:!1,...t};let a;const l=y=>{i.emit("contentError",{editor:i,error:y,disableCollaboration:()=>{"collaboration"in i.storage&&typeof i.storage.collaboration=="object"&&i.storage.collaboration&&(i.storage.collaboration.isDisabled=!0)}})},c={preserveWhitespace:"full",...t.parseOptions};if(!t.errorOnInvalidContent&&!i.options.enableContentCheck&&i.options.emitContentError)try{Qr(e,i.schema,{parseOptions:c,errorOnInvalidContent:!0})}catch(y){l(y)}try{a=Qr(e,i.schema,{parseOptions:c,errorOnInvalidContent:(o=t.errorOnInvalidContent)!=null?o:i.options.enableContentCheck})}catch(y){return l(y),!1}let{from:u,to:d}=typeof n=="number"?{from:n,to:n}:{from:n.from,to:n.to},h=!0,f=!0;if((X0(a)?a:[a]).forEach(y=>{y.check(),h=h?y.isText&&y.marks.length===0:!1,f=f?y.isBlock:!1}),u===d&&f){const{parent:y}=r.doc.resolve(u);y.isTextblock&&!y.type.spec.code&&!y.childCount&&(u-=1,d+=1)}let g;if(h){if(Array.isArray(e))g=e.map(y=>y.text||"").join("");else if(e instanceof _){let y="";e.forEach(b=>{b.text&&(y+=b.text)}),g=y}else typeof e=="object"&&e&&e.text?g=e.text:g=e;r.insertText(g,u,d)}else{g=a;const y=r.doc.resolve(u),b=y.node(),v=y.parentOffset===0,w=b.isText||b.isTextblock,k=b.content.size>0;v&&w&&k&&(u=Math.max(0,u-1)),r.replaceWith(u,d,g)}t.updateSelection&&Y0(r,r.steps.length-1,-1),t.applyInputRules&&r.setMeta("applyInputRules",{from:u,text:g}),t.applyPasteRules&&r.setMeta("applyPasteRules",{from:u,text:g})}return!0},Z0=()=>({state:n,dispatch:e})=>xw(n,e),ek=()=>({state:n,dispatch:e})=>Tw(n,e),tk=()=>({state:n,dispatch:e})=>uh(n,e),nk=()=>({state:n,dispatch:e})=>ph(n,e),rk=()=>({state:n,dispatch:e,tr:t})=>{try{const r=Gi(n.doc,n.selection.$from.pos,-1);return r==null?!1:(t.join(r,2),e&&e(t),!0)}catch{return!1}},sk=()=>({state:n,dispatch:e,tr:t})=>{try{const r=Gi(n.doc,n.selection.$from.pos,1);return r==null?!1:(t.join(r,2),e&&e(t),!0)}catch{return!1}},ik=()=>({state:n,dispatch:e})=>Sw(n,e),ok=()=>({state:n,dispatch:e})=>_w(n,e);function cf(){return typeof navigator<"u"?/Mac/.test(navigator.platform):!1}function ak(n){const e=n.split(/-(?!$)/);let t=e[e.length-1];t==="Space"&&(t=" ");let r,s,i,o;for(let a=0;a<e.length-1;a+=1){const l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))r=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))i=!0;else if(/^mod$/i.test(l))ri()||cf()?o=!0:s=!0;else throw new Error(`Unrecognized modifier name: ${l}`)}return r&&(t=`Alt-${t}`),s&&(t=`Ctrl-${t}`),o&&(t=`Meta-${t}`),i&&(t=`Shift-${t}`),t}var lk=n=>({editor:e,view:t,tr:r,dispatch:s})=>{const i=ak(n).split(/-(?!$)/),o=i.find(c=>!["Alt","Ctrl","Meta","Shift"].includes(c)),a=new KeyboardEvent("keydown",{key:o==="Space"?" ":o,altKey:i.includes("Alt"),ctrlKey:i.includes("Ctrl"),metaKey:i.includes("Meta"),shiftKey:i.includes("Shift"),bubbles:!0,cancelable:!0}),l=e.captureTransaction(()=>{t.someProp("handleKeyDown",c=>c(t,a))});return l?.steps.forEach(c=>{const u=c.map(r.mapping);u&&s&&r.maybeStep(u)}),!0};function Zt(n,e,t={}){const{from:r,to:s,empty:i}=n.selection,o=e?he(e,n.schema):null,a=[];n.doc.nodesBetween(r,s,(d,h)=>{if(d.isText)return;const f=Math.max(r,h),m=Math.min(s,h+d.nodeSize);a.push({node:d,from:f,to:m})});const l=s-r,c=a.filter(d=>o?o.name===d.node.type.name:!0).filter(d=>ni(d.node.attrs,t,{strict:!1}));return i?!!c.length:c.reduce((d,h)=>d+h.to-h.from,0)>=l}var ck=(n,e={})=>({state:t,dispatch:r})=>{const s=he(n,t.schema);return Zt(t,s,e)?Ew(t,r):!1},uk=()=>({state:n,dispatch:e})=>bh(n,e),dk=n=>({state:e,dispatch:t})=>{const r=he(n,e.schema);return Lw(r)(e,t)},hk=()=>({state:n,dispatch:e})=>gh(n,e);function ro(n,e){return e.nodes[n]?"node":e.marks[n]?"mark":null}function Eu(n,e){const t=typeof e=="string"?[e]:e;return Object.keys(n).reduce((r,s)=>(t.includes(s)||(r[s]=n[s]),r),{})}var fk=(n,e)=>({tr:t,state:r,dispatch:s})=>{let i=null,o=null;const a=ro(typeof n=="string"?n:n.name,r.schema);if(!a)return!1;a==="node"&&(i=he(n,r.schema)),a==="mark"&&(o=Mt(n,r.schema));let l=!1;return t.selection.ranges.forEach(c=>{r.doc.nodesBetween(c.$from.pos,c.$to.pos,(u,d)=>{i&&i===u.type&&(l=!0,s&&t.setNodeMarkup(d,void 0,Eu(u.attrs,e))),o&&u.marks.length&&u.marks.forEach(h=>{o===h.type&&(l=!0,s&&t.addMark(d,d+u.nodeSize,o.create(Eu(h.attrs,e))))})})}),l},pk=()=>({tr:n,dispatch:e})=>(e&&n.scrollIntoView(),!0),mk=()=>({tr:n,dispatch:e})=>{if(e){const t=new ze(n.doc);n.setSelection(t)}return!0},gk=()=>({state:n,dispatch:e})=>hh(n,e),yk=()=>({state:n,dispatch:e})=>mh(n,e),bk=()=>({state:n,dispatch:e})=>Mw(n,e),wk=()=>({state:n,dispatch:e})=>Rw(n,e),vk=()=>({state:n,dispatch:e})=>Nw(n,e);function Ia(n,e,t={},r={}){return Qr(n,e,{slice:!1,parseOptions:t,errorOnInvalidContent:r.errorOnInvalidContent})}var kk=(n,{errorOnInvalidContent:e,emitUpdate:t=!0,parseOptions:r={}}={})=>({editor:s,tr:i,dispatch:o,commands:a})=>{const{doc:l}=i;if(r.preserveWhitespace!=="full"){const c=Ia(n,s.schema,r,{errorOnInvalidContent:e??s.options.enableContentCheck});return o&&i.replaceWith(0,l.content.size,c).setMeta("preventUpdate",!t),!0}return o&&i.setMeta("preventUpdate",!t),a.insertContentAt({from:0,to:l.content.size},n,{parseOptions:r,errorOnInvalidContent:e??s.options.enableContentCheck})};function uf(n,e){const t=Mt(e,n.schema),{from:r,to:s,empty:i}=n.selection,o=[];i?(n.storedMarks&&o.push(...n.storedMarks),o.push(...n.selection.$head.marks())):n.doc.nodesBetween(r,s,l=>{o.push(...l.marks)});const a=o.find(l=>l.type.name===t.name);return a?{...a.attrs}:{}}function df(n,e){const t=new oh(n);return e.forEach(r=>{r.steps.forEach(s=>{t.step(s)})}),t}function Sk(n){for(let e=0;e<n.edgeCount;e+=1){const{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}function _k(n,e,t){const r=[];return n.nodesBetween(e.from,e.to,(s,i)=>{t(s)&&r.push({node:s,pos:i})}),r}function xk(n,e){for(let t=n.depth;t>0;t-=1){const r=n.node(t);if(e(r))return{pos:t>0?n.before(t):0,start:n.start(t),depth:t,node:r}}}function so(n){return e=>xk(e.$from,n)}function M(n,e,t){return n.config[e]===void 0&&n.parent?M(n.parent,e,t):typeof n.config[e]=="function"?n.config[e].bind({...t,parent:n.parent?M(n.parent,e,t):null}):n.config[e]}function El(n){return n.map(e=>{const t={name:e.name,options:e.options,storage:e.storage},r=M(e,"addExtensions",t);return r?[e,...El(r())]:e}).flat(10)}function Cl(n,e){const t=Pn.fromSchema(e).serializeFragment(n),s=document.implementation.createHTMLDocument().createElement("div");return s.appendChild(t),s.innerHTML}function hf(n){return typeof n=="function"}function J(n,e=void 0,...t){return hf(n)?e?n.bind(e)(...t):n(...t):n}function Tk(n={}){return Object.keys(n).length===0&&n.constructor===Object}function cr(n){const e=n.filter(s=>s.type==="extension"),t=n.filter(s=>s.type==="node"),r=n.filter(s=>s.type==="mark");return{baseExtensions:e,nodeExtensions:t,markExtensions:r}}function ff(n){const e=[],{nodeExtensions:t,markExtensions:r}=cr(n),s=[...t,...r],i={default:null,validate:void 0,rendered:!0,renderHTML:null,parseHTML:null,keepOnSplit:!0,isRequired:!1};return n.forEach(o=>{const a={name:o.name,options:o.options,storage:o.storage,extensions:s},l=M(o,"addGlobalAttributes",a);if(!l)return;l().forEach(u=>{u.types.forEach(d=>{Object.entries(u.attributes).forEach(([h,f])=>{e.push({type:d,name:h,attribute:{...i,...f}})})})})}),s.forEach(o=>{const a={name:o.name,options:o.options,storage:o.storage},l=M(o,"addAttributes",a);if(!l)return;const c=l();Object.entries(c).forEach(([u,d])=>{const h={...i,...d};typeof h?.default=="function"&&(h.default=h.default()),h?.isRequired&&h?.default===void 0&&delete h.default,e.push({type:o.name,name:u,attribute:h})})}),e}function le(...n){return n.filter(e=>!!e).reduce((e,t)=>{const r={...e};return Object.entries(t).forEach(([s,i])=>{if(!r[s]){r[s]=i;return}if(s==="class"){const a=i?String(i).split(" "):[],l=r[s]?r[s].split(" "):[],c=a.filter(u=>!l.includes(u));r[s]=[...l,...c].join(" ")}else if(s==="style"){const a=i?i.split(";").map(u=>u.trim()).filter(Boolean):[],l=r[s]?r[s].split(";").map(u=>u.trim()).filter(Boolean):[],c=new Map;l.forEach(u=>{const[d,h]=u.split(":").map(f=>f.trim());c.set(d,h)}),a.forEach(u=>{const[d,h]=u.split(":").map(f=>f.trim());c.set(d,h)}),r[s]=Array.from(c.entries()).map(([u,d])=>`${u}: ${d}`).join("; ")}else r[s]=i}),r},{})}function Zr(n,e){return e.filter(t=>t.type===n.type.name).filter(t=>t.attribute.rendered).map(t=>t.attribute.renderHTML?t.attribute.renderHTML(n.attrs)||{}:{[t.name]:n.attrs[t.name]}).reduce((t,r)=>le(t,r),{})}function Ek(n){return typeof n!="string"?n:n.match(/^[+-]?(?:\d*\.)?\d+$/)?Number(n):n==="true"?!0:n==="false"?!1:n}function Cu(n,e){return"style"in n?n:{...n,getAttrs:t=>{const r=n.getAttrs?n.getAttrs(t):n.attrs;if(r===!1)return!1;const s=e.reduce((i,o)=>{const a=o.attribute.parseHTML?o.attribute.parseHTML(t):Ek(t.getAttribute(o.name));return a==null?i:{...i,[o.name]:a}},{});return{...r,...s}}}}function Au(n){return Object.fromEntries(Object.entries(n).filter(([e,t])=>e==="attrs"&&Tk(t)?!1:t!=null))}function Ou(n){var e,t;const r={};return!((e=n?.attribute)!=null&&e.isRequired)&&"default"in(n?.attribute||{})&&(r.default=n.attribute.default),((t=n?.attribute)==null?void 0:t.validate)!==void 0&&(r.validate=n.attribute.validate),[n.name,r]}function Ck(n,e){var t;const r=ff(n),{nodeExtensions:s,markExtensions:i}=cr(n),o=(t=s.find(c=>M(c,"topNode")))==null?void 0:t.name,a=Object.fromEntries(s.map(c=>{const u=r.filter(b=>b.type===c.name),d={name:c.name,options:c.options,storage:c.storage,editor:e},h=n.reduce((b,v)=>{const w=M(v,"extendNodeSchema",d);return{...b,...w?w(c):{}}},{}),f=Au({...h,content:J(M(c,"content",d)),marks:J(M(c,"marks",d)),group:J(M(c,"group",d)),inline:J(M(c,"inline",d)),atom:J(M(c,"atom",d)),selectable:J(M(c,"selectable",d)),draggable:J(M(c,"draggable",d)),code:J(M(c,"code",d)),whitespace:J(M(c,"whitespace",d)),linebreakReplacement:J(M(c,"linebreakReplacement",d)),defining:J(M(c,"defining",d)),isolating:J(M(c,"isolating",d)),attrs:Object.fromEntries(u.map(Ou))}),m=J(M(c,"parseHTML",d));m&&(f.parseDOM=m.map(b=>Cu(b,u)));const g=M(c,"renderHTML",d);g&&(f.toDOM=b=>g({node:b,HTMLAttributes:Zr(b,u)}));const y=M(c,"renderText",d);return y&&(f.toText=y),[c.name,f]})),l=Object.fromEntries(i.map(c=>{const u=r.filter(y=>y.type===c.name),d={name:c.name,options:c.options,storage:c.storage,editor:e},h=n.reduce((y,b)=>{const v=M(b,"extendMarkSchema",d);return{...y,...v?v(c):{}}},{}),f=Au({...h,inclusive:J(M(c,"inclusive",d)),excludes:J(M(c,"excludes",d)),group:J(M(c,"group",d)),spanning:J(M(c,"spanning",d)),code:J(M(c,"code",d)),attrs:Object.fromEntries(u.map(Ou))}),m=J(M(c,"parseHTML",d));m&&(f.parseDOM=m.map(y=>Cu(y,u)));const g=M(c,"renderHTML",d);return g&&(f.toDOM=y=>g({mark:y,HTMLAttributes:Zr(y,u)})),[c.name,f]}));return new Vd({topNode:o,nodes:a,marks:l})}function Ak(n){const e=n.filter((t,r)=>n.indexOf(t)!==r);return Array.from(new Set(e))}function si(n){return n.sort((t,r)=>{const s=M(t,"priority")||100,i=M(r,"priority")||100;return s>i?-1:s<i?1:0})}function pf(n){const e=si(El(n)),t=Ak(e.map(r=>r.name));return t.length&&console.warn(`[tiptap warn]: Duplicate extension names found: [${t.map(r=>`'${r}'`).join(", ")}]. This can lead to issues.`),e}function mf(n,e,t){const{from:r,to:s}=e,{blockSeparator:i=`

`,textSerializers:o={}}=t||{};let a="";return n.nodesBetween(r,s,(l,c,u,d)=>{var h;l.isBlock&&c>r&&(a+=i);const f=o?.[l.type.name];if(f)return u&&(a+=f({node:l,pos:c,parent:u,index:d,range:e})),!1;l.isText&&(a+=(h=l?.text)==null?void 0:h.slice(Math.max(r,c)-c,s-c))}),a}function Ok(n,e){const t={from:0,to:n.content.size};return mf(n,t,e)}function gf(n){return Object.fromEntries(Object.entries(n.nodes).filter(([,e])=>e.spec.toText).map(([e,t])=>[e,t.spec.toText]))}function Mk(n,e){const t=he(e,n.schema),{from:r,to:s}=n.selection,i=[];n.doc.nodesBetween(r,s,a=>{i.push(a)});const o=i.reverse().find(a=>a.type.name===t.name);return o?{...o.attrs}:{}}function yf(n,e){const t=ro(typeof e=="string"?e:e.name,n.schema);return t==="node"?Mk(n,e):t==="mark"?uf(n,e):{}}function Ik(n,e=JSON.stringify){const t={};return n.filter(r=>{const s=e(r);return Object.prototype.hasOwnProperty.call(t,s)?!1:t[s]=!0})}function Nk(n){const e=Ik(n);return e.length===1?e:e.filter((t,r)=>!e.filter((i,o)=>o!==r).some(i=>t.oldRange.from>=i.oldRange.from&&t.oldRange.to<=i.oldRange.to&&t.newRange.from>=i.newRange.from&&t.newRange.to<=i.newRange.to))}function bf(n){const{mapping:e,steps:t}=n,r=[];return e.maps.forEach((s,i)=>{const o=[];if(s.ranges.length)s.forEach((a,l)=>{o.push({from:a,to:l})});else{const{from:a,to:l}=t[i];if(a===void 0||l===void 0)return;o.push({from:a,to:l})}o.forEach(({from:a,to:l})=>{const c=e.slice(i).map(a,-1),u=e.slice(i).map(l),d=e.invert().map(c,-1),h=e.invert().map(u);r.push({oldRange:{from:d,to:h},newRange:{from:c,to:u}})})}),Nk(r)}function Al(n,e,t){const r=[];return n===e?t.resolve(n).marks().forEach(s=>{const i=t.resolve(n),o=Tl(i,s.type);o&&r.push({mark:s,...o})}):t.nodesBetween(n,e,(s,i)=>{!s||s?.nodeSize===void 0||r.push(...s.marks.map(o=>({from:i,to:i+s.nodeSize,mark:o})))}),r}var Rk=(n,e,t,r=20)=>{const s=n.doc.resolve(t);let i=r,o=null;for(;i>0&&o===null;){const a=s.node(i);a?.type.name===e?o=a:i-=1}return[o,i]};function _s(n,e){return e.nodes[n]||e.marks[n]||null}function $s(n,e,t){return Object.fromEntries(Object.entries(t).filter(([r])=>{const s=n.find(i=>i.type===e&&i.name===r);return s?s.attribute.keepOnSplit:!1}))}var Pk=(n,e=500)=>{let t="";const r=n.parentOffset;return n.parent.nodesBetween(Math.max(0,r-e),r,(s,i,o,a)=>{var l,c;const u=((c=(l=s.type.spec).toText)==null?void 0:c.call(l,{node:s,pos:i,parent:o,index:a}))||s.textContent||"%leaf%";t+=s.isAtom&&!s.isText?u:u.slice(0,Math.max(0,r-i))}),t};function Na(n,e,t={}){const{empty:r,ranges:s}=n.selection,i=e?Mt(e,n.schema):null;if(r)return!!(n.storedMarks||n.selection.$from.marks()).filter(d=>i?i.name===d.type.name:!0).find(d=>ni(d.attrs,t,{strict:!1}));let o=0;const a=[];if(s.forEach(({$from:d,$to:h})=>{const f=d.pos,m=h.pos;n.doc.nodesBetween(f,m,(g,y)=>{if(!g.isText&&!g.marks.length)return;const b=Math.max(f,y),v=Math.min(m,y+g.nodeSize),w=v-b;o+=w,a.push(...g.marks.map(k=>({mark:k,from:b,to:v})))})}),o===0)return!1;const l=a.filter(d=>i?i.name===d.mark.type.name:!0).filter(d=>ni(d.mark.attrs,t,{strict:!1})).reduce((d,h)=>d+h.to-h.from,0),c=a.filter(d=>i?d.mark.type!==i&&d.mark.type.excludes(i):!0).reduce((d,h)=>d+h.to-h.from,0);return(l>0?l+c:l)>=o}function $k(n,e,t={}){if(!e)return Zt(n,null,t)||Na(n,null,t);const r=ro(e,n.schema);return r==="node"?Zt(n,e,t):r==="mark"?Na(n,e,t):!1}var Dk=(n,e)=>{const{$from:t,$to:r,$anchor:s}=n.selection;if(e){const i=so(a=>a.type.name===e)(n.selection);if(!i)return!1;const o=n.doc.resolve(i.pos+1);return s.pos+1===o.end()}return!(r.parentOffset<r.parent.nodeSize-2||t.pos!==r.pos)},jk=n=>{const{$from:e,$to:t}=n.selection;return!(e.parentOffset>0||e.pos!==t.pos)};function Mu(n,e){return Array.isArray(e)?e.some(t=>(typeof t=="string"?t:t.name)===n.name):e}function Iu(n,e){const{nodeExtensions:t}=cr(e),r=t.find(o=>o.name===n);if(!r)return!1;const s={name:r.name,options:r.options,storage:r.storage},i=J(M(r,"group",s));return typeof i!="string"?!1:i.split(" ").includes("list")}function io(n,{checkChildren:e=!0,ignoreWhitespace:t=!1}={}){var r;if(t){if(n.type.name==="hardBreak")return!0;if(n.isText)return/^\s*$/m.test((r=n.text)!=null?r:"")}if(n.isText)return!n.text;if(n.isAtom||n.isLeaf)return!1;if(n.content.childCount===0)return!0;if(e){let s=!0;return n.content.forEach(i=>{s!==!1&&(io(i,{ignoreWhitespace:t,checkChildren:e})||(s=!1))}),s}return!1}function wf(n){return n instanceof N}var vf=class kf{constructor(e){this.position=e}static fromJSON(e){return new kf(e.position)}toJSON(){return{position:this.position}}};function Lk(n,e){const t=e.mapping.mapResult(n.position);return{position:new vf(t.pos),mapResult:t}}function Bk(n){return new vf(n)}function zk(n,e,t){var r;const{selection:s}=e;let i=null;if(of(s)&&(i=s.$cursor),i){const a=(r=n.storedMarks)!=null?r:i.marks();return i.parent.type.allowsMarkType(t)&&(!!t.isInSet(a)||!a.some(c=>c.type.excludes(t)))}const{ranges:o}=s;return o.some(({$from:a,$to:l})=>{let c=a.depth===0?n.doc.inlineContent&&n.doc.type.allowsMarkType(t):!1;return n.doc.nodesBetween(a.pos,l.pos,(u,d,h)=>{if(c)return!1;if(u.isInline){const f=!h||h.type.allowsMarkType(t),m=!!t.isInSet(u.marks)||!u.marks.some(g=>g.type.excludes(t));c=f&&m}return!c}),c})}var Fk=(n,e={})=>({tr:t,state:r,dispatch:s})=>{const{selection:i}=t,{empty:o,ranges:a}=i,l=Mt(n,r.schema);if(s)if(o){const c=uf(r,l);t.addStoredMark(l.create({...c,...e}))}else a.forEach(c=>{const u=c.$from.pos,d=c.$to.pos;r.doc.nodesBetween(u,d,(h,f)=>{const m=Math.max(f,u),g=Math.min(f+h.nodeSize,d);h.marks.find(b=>b.type===l)?h.marks.forEach(b=>{l===b.type&&t.addMark(m,g,l.create({...b.attrs,...e}))}):t.addMark(m,g,l.create(e))})});return zk(r,t,l)},Uk=(n,e)=>({tr:t})=>(t.setMeta(n,e),!0),Hk=(n,e={})=>({state:t,dispatch:r,chain:s})=>{const i=he(n,t.schema);let o;return t.selection.$anchor.sameParent(t.selection.$head)&&(o=t.selection.$anchor.parent.attrs),i.isTextblock?s().command(({commands:a})=>Vc(i,{...o,...e})(t)?!0:a.clearNodes()).command(({state:a})=>Vc(i,{...o,...e})(a,r)).run():(console.warn('[tiptap warn]: Currently "setNode()" only supports text block nodes.'),!1)},Vk=n=>({tr:e,dispatch:t})=>{if(t){const{doc:r}=e,s=bn(n,0,r.content.size),i=N.create(r,s);e.setSelection(i)}return!0},qk=(n,e)=>({tr:t,state:r,dispatch:s})=>{const{selection:i}=r;let o,a;return typeof e=="number"?(o=e,a=e):e&&"from"in e&&"to"in e?(o=e.from,a=e.to):(o=i.from,a=i.to),s&&t.doc.nodesBetween(o,a,(l,c)=>{l.isText||t.setNodeMarkup(c,void 0,{...l.attrs,dir:n})}),!0},Wk=n=>({tr:e,dispatch:t})=>{if(t){const{doc:r}=e,{from:s,to:i}=typeof n=="number"?{from:n,to:n}:n,o=j.atStart(r).from,a=j.atEnd(r).to,l=bn(s,o,a),c=bn(i,o,a),u=j.create(r,l,c);e.setSelection(u)}return!0},Kk=n=>({state:e,dispatch:t})=>{const r=he(n,e.schema);return Fw(r)(e,t)};function Nu(n,e){const t=n.storedMarks||n.selection.$to.parentOffset&&n.selection.$from.marks();if(t){const r=t.filter(s=>e?.includes(s.type.name));n.tr.ensureMarks(r)}}var Jk=({keepMarks:n=!0}={})=>({tr:e,state:t,dispatch:r,editor:s})=>{const{selection:i,doc:o}=e,{$from:a,$to:l}=i,c=s.extensionManager.attributes,u=$s(c,a.node().type.name,a.node().attrs);if(i instanceof N&&i.node.isBlock)return!a.parentOffset||!_t(o,a.pos)?!1:(r&&(n&&Nu(t,s.extensionManager.splittableMarks),e.split(a.pos).scrollIntoView()),!0);if(!a.parent.isBlock)return!1;const d=l.parentOffset===l.parent.content.size,h=a.depth===0?void 0:Sk(a.node(-1).contentMatchAt(a.indexAfter(-1)));let f=d&&h?[{type:h,attrs:u}]:void 0,m=_t(e.doc,e.mapping.map(a.pos),1,f);if(!f&&!m&&_t(e.doc,e.mapping.map(a.pos),1,h?[{type:h}]:void 0)&&(m=!0,f=h?[{type:h,attrs:u}]:void 0),r){if(m&&(i instanceof j&&e.deleteSelection(),e.split(e.mapping.map(a.pos),1,f),h&&!d&&!a.parentOffset&&a.parent.type!==h)){const g=e.mapping.map(a.before()),y=e.doc.resolve(g);a.node(-1).canReplaceWith(y.index(),y.index()+1,h)&&e.setNodeMarkup(e.mapping.map(a.before()),h)}n&&Nu(t,s.extensionManager.splittableMarks),e.scrollIntoView()}return m},Gk=(n,e={})=>({tr:t,state:r,dispatch:s,editor:i})=>{var o;const a=he(n,r.schema),{$from:l,$to:c}=r.selection,u=r.selection.node;if(u&&u.isBlock||l.depth<2||!l.sameParent(c))return!1;const d=l.node(-1);if(d.type!==a)return!1;const h=i.extensionManager.attributes;if(l.parent.content.size===0&&l.node(-1).childCount===l.indexAfter(-1)){if(l.depth===2||l.node(-3).type!==a||l.index(-2)!==l.node(-2).childCount-1)return!1;if(s){let b=_.empty;const v=l.index(-1)?1:l.index(-2)?2:3;for(let C=l.depth-v;C>=l.depth-3;C-=1)b=_.from(l.node(C).copy(b));const w=l.indexAfter(-1)<l.node(-2).childCount?1:l.indexAfter(-2)<l.node(-3).childCount?2:3,k={...$s(h,l.node().type.name,l.node().attrs),...e},T=((o=a.contentMatch.defaultType)==null?void 0:o.createAndFill(k))||void 0;b=b.append(_.from(a.createAndFill(null,T)||void 0));const S=l.before(l.depth-(v-1));t.replace(S,l.after(-w),new A(b,4-v,0));let x=-1;t.doc.nodesBetween(S,t.doc.content.size,(C,R)=>{if(x>-1)return!1;C.isTextblock&&C.content.size===0&&(x=R+1)}),x>-1&&t.setSelection(j.near(t.doc.resolve(x))),t.scrollIntoView()}return!0}const f=c.pos===l.end()?d.contentMatchAt(0).defaultType:null,m={...$s(h,d.type.name,d.attrs),...e},g={...$s(h,l.node().type.name,l.node().attrs),...e};t.delete(l.pos,c.pos);const y=f?[{type:a,attrs:m},{type:f,attrs:g}]:[{type:a,attrs:m}];if(!_t(t.doc,l.pos,2))return!1;if(s){const{selection:b,storedMarks:v}=r,{splittableMarks:w}=i.extensionManager,k=v||b.$to.parentOffset&&b.$from.marks();if(t.split(l.pos,2,y).scrollIntoView(),!k||!s)return!0;const T=k.filter(S=>w.includes(S.type.name));t.ensureMarks(T)}return!0},Lo=(n,e)=>{const t=so(o=>o.type===e)(n.selection);if(!t)return!0;const r=n.doc.resolve(Math.max(0,t.pos-1)).before(t.depth);if(r===void 0)return!0;const s=n.doc.nodeAt(r);return t.node.type===s?.type&&nn(n.doc,t.pos)&&n.join(t.pos),!0},Bo=(n,e)=>{const t=so(o=>o.type===e)(n.selection);if(!t)return!0;const r=n.doc.resolve(t.start).after(t.depth);if(r===void 0)return!0;const s=n.doc.nodeAt(r);return t.node.type===s?.type&&nn(n.doc,r)&&n.join(r),!0},Yk=(n,e,t,r={})=>({editor:s,tr:i,state:o,dispatch:a,chain:l,commands:c,can:u})=>{const{extensions:d,splittableMarks:h}=s.extensionManager,f=he(n,o.schema),m=he(e,o.schema),{selection:g,storedMarks:y}=o,{$from:b,$to:v}=g,w=b.blockRange(v),k=y||g.$to.parentOffset&&g.$from.marks();if(!w)return!1;const T=so(S=>Iu(S.type.name,d))(g);if(w.depth>=1&&T&&w.depth-T.depth<=1){if(T.node.type===f)return c.liftListItem(m);if(Iu(T.node.type.name,d)&&f.validContent(T.node.content)&&a)return l().command(()=>(i.setNodeMarkup(T.pos,f),!0)).command(()=>Lo(i,f)).command(()=>Bo(i,f)).run()}return!t||!k||!a?l().command(()=>u().wrapInList(f,r)?!0:c.clearNodes()).wrapInList(f,r).command(()=>Lo(i,f)).command(()=>Bo(i,f)).run():l().command(()=>{const S=u().wrapInList(f,r),x=k.filter(C=>h.includes(C.type.name));return i.ensureMarks(x),S?!0:c.clearNodes()}).wrapInList(f,r).command(()=>Lo(i,f)).command(()=>Bo(i,f)).run()},Xk=(n,e={},t={})=>({state:r,commands:s})=>{const{extendEmptyMarkRange:i=!1}=t,o=Mt(n,r.schema);return Na(r,o,e)?s.unsetMark(o,{extendEmptyMarkRange:i}):s.setMark(o,e)},Qk=(n,e,t={})=>({state:r,commands:s})=>{const i=he(n,r.schema),o=he(e,r.schema),a=Zt(r,i,t);let l;return r.selection.$anchor.sameParent(r.selection.$head)&&(l=r.selection.$anchor.parent.attrs),a?s.setNode(o,l):s.setNode(i,{...l,...t})},Zk=(n,e={})=>({state:t,commands:r})=>{const s=he(n,t.schema);return Zt(t,s,e)?r.lift(s):r.wrapIn(s,e)},eS=()=>({state:n,dispatch:e})=>{const t=n.plugins;for(let r=0;r<t.length;r+=1){const s=t[r];let i;if(s.spec.isInputRules&&(i=s.getState(n))){if(e){const o=n.tr,a=i.transform;for(let l=a.steps.length-1;l>=0;l-=1)o.step(a.steps[l].invert(a.docs[l]));if(i.text){const l=o.doc.resolve(i.from).marks();o.replaceWith(i.from,i.to,n.schema.text(i.text,l))}else o.delete(i.from,i.to)}return!0}}return!1},tS=()=>({tr:n,dispatch:e})=>{const{selection:t}=n,{empty:r,ranges:s}=t;return r||e&&s.forEach(i=>{n.removeMark(i.$from.pos,i.$to.pos)}),!0},nS=(n,e={})=>({tr:t,state:r,dispatch:s})=>{var i;const{extendEmptyMarkRange:o=!1}=e,{selection:a}=t,l=Mt(n,r.schema),{$from:c,empty:u,ranges:d}=a;if(!s)return!0;if(u&&o){let{from:h,to:f}=a;const m=(i=c.marks().find(y=>y.type===l))==null?void 0:i.attrs,g=Tl(c,l,m);g&&(h=g.from,f=g.to),t.removeMark(h,f,l)}else d.forEach(h=>{t.removeMark(h.$from.pos,h.$to.pos,l)});return t.removeStoredMark(l),!0},rS=n=>({tr:e,state:t,dispatch:r})=>{const{selection:s}=t;let i,o;return typeof n=="number"?(i=n,o=n):n&&"from"in n&&"to"in n?(i=n.from,o=n.to):(i=s.from,o=s.to),r&&e.doc.nodesBetween(i,o,(a,l)=>{if(a.isText)return;const c={...a.attrs};delete c.dir,e.setNodeMarkup(l,void 0,c)}),!0},sS=(n,e={})=>({tr:t,state:r,dispatch:s})=>{let i=null,o=null;const a=ro(typeof n=="string"?n:n.name,r.schema);if(!a)return!1;a==="node"&&(i=he(n,r.schema)),a==="mark"&&(o=Mt(n,r.schema));let l=!1;return t.selection.ranges.forEach(c=>{const u=c.$from.pos,d=c.$to.pos;let h,f,m,g;t.selection.empty?r.doc.nodesBetween(u,d,(y,b)=>{i&&i===y.type&&(l=!0,m=Math.max(b,u),g=Math.min(b+y.nodeSize,d),h=b,f=y)}):r.doc.nodesBetween(u,d,(y,b)=>{b<u&&i&&i===y.type&&(l=!0,m=Math.max(b,u),g=Math.min(b+y.nodeSize,d),h=b,f=y),b>=u&&b<=d&&(i&&i===y.type&&(l=!0,s&&t.setNodeMarkup(b,void 0,{...y.attrs,...e})),o&&y.marks.length&&y.marks.forEach(v=>{if(o===v.type&&(l=!0,s)){const w=Math.max(b,u),k=Math.min(b+y.nodeSize,d);t.addMark(w,k,o.create({...v.attrs,...e}))}}))}),f&&(h!==void 0&&s&&t.setNodeMarkup(h,void 0,{...f.attrs,...e}),o&&f.marks.length&&f.marks.forEach(y=>{o===y.type&&s&&t.addMark(m,g,o.create({...y.attrs,...e}))}))}),l},iS=(n,e={})=>({state:t,dispatch:r})=>{const s=he(n,t.schema);return Pw(s,e)(t,r)},oS=(n,e={})=>({state:t,dispatch:r})=>{const s=he(n,t.schema);return $w(s,e)(t,r)},aS=class{constructor(){this.callbacks={}}on(n,e){return this.callbacks[n]||(this.callbacks[n]=[]),this.callbacks[n].push(e),this}emit(n,...e){const t=this.callbacks[n];return t&&t.forEach(r=>r.apply(this,e)),this}off(n,e){const t=this.callbacks[n];return t&&(e?this.callbacks[n]=t.filter(r=>r!==e):delete this.callbacks[n]),this}once(n,e){const t=(...r)=>{this.off(n,t),e.apply(this,r)};return this.on(n,t)}removeAllListeners(){this.callbacks={}}},us=class{constructor(n){var e;this.find=n.find,this.handler=n.handler,this.undoable=(e=n.undoable)!=null?e:!0}},lS=(n,e)=>{if(xl(e))return e.exec(n);const t=e(n);if(!t)return null;const r=[t.text];return r.index=t.index,r.input=n,r.data=t.data,t.replaceWith&&(t.text.includes(t.replaceWith)||console.warn('[tiptap warn]: "inputRuleMatch.replaceWith" must be part of "inputRuleMatch.text".'),r.push(t.replaceWith)),r};function xs(n){var e;const{editor:t,from:r,to:s,text:i,rules:o,plugin:a}=n,{view:l}=t;if(l.composing)return!1;const c=l.state.doc.resolve(r);if(c.parent.type.spec.code||(e=c.nodeBefore||c.nodeAfter)!=null&&e.marks.find(h=>h.type.spec.code))return!1;let u=!1;const d=Pk(c)+i;return o.forEach(h=>{if(u)return;const f=lS(d,h.find);if(!f)return;const m=l.state.tr,g=to({state:l.state,transaction:m}),y={from:r-(f[0].length-i.length),to:s},{commands:b,chain:v,can:w}=new no({editor:t,state:g});h.handler({state:g,range:y,match:f,commands:b,chain:v,can:w})===null||!m.steps.length||(h.undoable&&m.setMeta(a,{transform:m,from:r,to:s,text:i}),l.dispatch(m),u=!0)}),u}function cS(n){const{editor:e,rules:t}=n,r=new se({state:{init(){return null},apply(s,i,o){const a=s.getMeta(r);if(a)return a;const l=s.getMeta("applyInputRules");return l&&setTimeout(()=>{let{text:u}=l;typeof u=="string"?u=u:u=Cl(_.from(u),o.schema);const{from:d}=l,h=d+u.length;xs({editor:e,from:d,to:h,text:u,rules:t,plugin:r})}),s.selectionSet||s.docChanged?null:i}},props:{handleTextInput(s,i,o,a){return xs({editor:e,from:i,to:o,text:a,rules:t,plugin:r})},handleDOMEvents:{compositionend:s=>(setTimeout(()=>{const{$cursor:i}=s.state.selection;i&&xs({editor:e,from:i.pos,to:i.pos,text:"",rules:t,plugin:r})}),!1)},handleKeyDown(s,i){if(i.key!=="Enter")return!1;const{$cursor:o}=s.state.selection;return o?xs({editor:e,from:o.pos,to:o.pos,text:`
`,rules:t,plugin:r}):!1}},isInputRules:!0});return r}function uS(n){return Object.prototype.toString.call(n).slice(8,-1)}function Ts(n){return uS(n)!=="Object"?!1:n.constructor===Object&&Object.getPrototypeOf(n)===Object.prototype}function Sf(n,e){const t={...n};return Ts(n)&&Ts(e)&&Object.keys(e).forEach(r=>{Ts(e[r])&&Ts(n[r])?t[r]=Sf(n[r],e[r]):t[r]=e[r]}),t}var Ol=class{constructor(n={}){this.type="extendable",this.parent=null,this.child=null,this.name="",this.config={name:this.name},this.config={...this.config,...n},this.name=this.config.name}get options(){return{...J(M(this,"addOptions",{name:this.name}))||{}}}get storage(){return{...J(M(this,"addStorage",{name:this.name,options:this.options}))||{}}}configure(n={}){const e=this.extend({...this.config,addOptions:()=>Sf(this.options,n)});return e.name=this.name,e.parent=this.parent,e}extend(n={}){const e=new this.constructor({...this.config,...n});return e.parent=this,this.child=e,e.name="name"in n?n.name:e.parent.name,e}},It=class _f extends Ol{constructor(){super(...arguments),this.type="mark"}static create(e={}){const t=typeof e=="function"?e():e;return new _f(t)}static handleExit({editor:e,mark:t}){const{tr:r}=e.state,s=e.state.selection.$from;if(s.pos===s.end()){const o=s.marks();if(!!!o.find(c=>c?.type.name===t.name))return!1;const l=o.find(c=>c?.type.name===t.name);return l&&r.removeStoredMark(l),r.insertText(" ",s.pos),e.view.dispatch(r),!0}return!1}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}};function dS(n){return typeof n=="number"}var hS=class{constructor(n){this.find=n.find,this.handler=n.handler}},fS=(n,e,t)=>{if(xl(e))return[...n.matchAll(e)];const r=e(n,t);return r?r.map(s=>{const i=[s.text];return i.index=s.index,i.input=n,i.data=s.data,s.replaceWith&&(s.text.includes(s.replaceWith)||console.warn('[tiptap warn]: "pasteRuleMatch.replaceWith" must be part of "pasteRuleMatch.text".'),i.push(s.replaceWith)),i}):[]};function pS(n){const{editor:e,state:t,from:r,to:s,rule:i,pasteEvent:o,dropEvent:a}=n,{commands:l,chain:c,can:u}=new no({editor:e,state:t}),d=[];return t.doc.nodesBetween(r,s,(f,m)=>{var g,y,b,v,w;if((y=(g=f.type)==null?void 0:g.spec)!=null&&y.code||!(f.isText||f.isTextblock||f.isInline))return;const k=(w=(v=(b=f.content)==null?void 0:b.size)!=null?v:f.nodeSize)!=null?w:0,T=Math.max(r,m),S=Math.min(s,m+k);if(T>=S)return;const x=f.isText?f.text||"":f.textBetween(T-m,S-m,void 0,"");fS(x,i.find,o).forEach(R=>{if(R.index===void 0)return;const X=T+R.index+1,I=X+R[0].length,H={from:t.tr.mapping.map(X),to:t.tr.mapping.map(I)},pe=i.handler({state:t,range:H,match:R,commands:l,chain:c,can:u,pasteEvent:o,dropEvent:a});d.push(pe)})}),d.every(f=>f!==null)}var Es=null,mS=n=>{var e;const t=new ClipboardEvent("paste",{clipboardData:new DataTransfer});return(e=t.clipboardData)==null||e.setData("text/html",n),t};function gS(n){const{editor:e,rules:t}=n;let r=null,s=!1,i=!1,o=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,a;try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}const l=({state:u,from:d,to:h,rule:f,pasteEvt:m})=>{const g=u.tr,y=to({state:u,transaction:g});if(!(!pS({editor:e,state:y,from:Math.max(d-1,0),to:h.b-1,rule:f,pasteEvent:m,dropEvent:a})||!g.steps.length)){try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}return o=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,g}};return t.map(u=>new se({view(d){const h=m=>{var g;r=(g=d.dom.parentElement)!=null&&g.contains(m.target)?d.dom.parentElement:null,r&&(Es=e)},f=()=>{Es&&(Es=null)};return window.addEventListener("dragstart",h),window.addEventListener("dragend",f),{destroy(){window.removeEventListener("dragstart",h),window.removeEventListener("dragend",f)}}},props:{handleDOMEvents:{drop:(d,h)=>{if(i=r===d.dom.parentElement,a=h,!i){const f=Es;f?.isEditable&&setTimeout(()=>{const m=f.state.selection;m&&f.commands.deleteRange({from:m.from,to:m.to})},10)}return!1},paste:(d,h)=>{var f;const m=(f=h.clipboardData)==null?void 0:f.getData("text/html");return o=h,s=!!m?.includes("data-pm-slice"),!1}}},appendTransaction:(d,h,f)=>{const m=d[0],g=m.getMeta("uiEvent")==="paste"&&!s,y=m.getMeta("uiEvent")==="drop"&&!i,b=m.getMeta("applyPasteRules"),v=!!b;if(!g&&!y&&!v)return;if(v){let{text:T}=b;typeof T=="string"?T=T:T=Cl(_.from(T),f.schema);const{from:S}=b,x=S+T.length,C=mS(T);return l({rule:u,state:f,from:S,to:{b:x},pasteEvt:C})}const w=h.doc.content.findDiffStart(f.doc.content),k=h.doc.content.findDiffEnd(f.doc.content);if(!(!dS(w)||!k||w===k.b))return l({rule:u,state:f,from:w,to:k,pasteEvt:o})}}))}var oo=class{constructor(n,e){this.splittableMarks=[],this.editor=e,this.baseExtensions=n,this.extensions=pf(n),this.schema=Ck(this.extensions,e),this.setupExtensions()}get commands(){return this.extensions.reduce((n,e)=>{const t={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:_s(e.name,this.schema)},r=M(e,"addCommands",t);return r?{...n,...r()}:n},{})}get plugins(){const{editor:n}=this;return si([...this.extensions].reverse()).flatMap(r=>{const s={name:r.name,options:r.options,storage:this.editor.extensionStorage[r.name],editor:n,type:_s(r.name,this.schema)},i=[],o=M(r,"addKeyboardShortcuts",s);let a={};if(r.type==="mark"&&M(r,"exitable",s)&&(a.ArrowRight=()=>It.handleExit({editor:n,mark:r})),o){const h=Object.fromEntries(Object.entries(o()).map(([f,m])=>[f,()=>m({editor:n})]));a={...a,...h}}const l=M0(a);i.push(l);const c=M(r,"addInputRules",s);if(Mu(r,n.options.enableInputRules)&&c){const h=c();if(h&&h.length){const f=cS({editor:n,rules:h}),m=Array.isArray(f)?f:[f];i.push(...m)}}const u=M(r,"addPasteRules",s);if(Mu(r,n.options.enablePasteRules)&&u){const h=u();if(h&&h.length){const f=gS({editor:n,rules:h});i.push(...f)}}const d=M(r,"addProseMirrorPlugins",s);if(d){const h=d();i.push(...h)}return i})}get attributes(){return ff(this.extensions)}get nodeViews(){const{editor:n}=this,{nodeExtensions:e}=cr(this.extensions);return Object.fromEntries(e.filter(t=>!!M(t,"addNodeView")).map(t=>{const r=this.attributes.filter(l=>l.type===t.name),s={name:t.name,options:t.options,storage:this.editor.extensionStorage[t.name],editor:n,type:he(t.name,this.schema)},i=M(t,"addNodeView",s);if(!i)return[];const o=i();if(!o)return[];const a=(l,c,u,d,h)=>{const f=Zr(l,r);return o({node:l,view:c,getPos:u,decorations:d,innerDecorations:h,editor:n,extension:t,HTMLAttributes:f})};return[t.name,a]}))}dispatchTransaction(n){const{editor:e}=this;return si([...this.extensions].reverse()).reduceRight((r,s)=>{const i={name:s.name,options:s.options,storage:this.editor.extensionStorage[s.name],editor:e,type:_s(s.name,this.schema)},o=M(s,"dispatchTransaction",i);return o?a=>{o.call(i,{transaction:a,next:r})}:r},n)}get markViews(){const{editor:n}=this,{markExtensions:e}=cr(this.extensions);return Object.fromEntries(e.filter(t=>!!M(t,"addMarkView")).map(t=>{const r=this.attributes.filter(a=>a.type===t.name),s={name:t.name,options:t.options,storage:this.editor.extensionStorage[t.name],editor:n,type:Mt(t.name,this.schema)},i=M(t,"addMarkView",s);if(!i)return[];const o=(a,l,c)=>{const u=Zr(a,r);return i()({mark:a,view:l,inline:c,editor:n,extension:t,HTMLAttributes:u,updateAttributes:d=>{MS(a,n,d)}})};return[t.name,o]}))}setupExtensions(){const n=this.extensions;this.editor.extensionStorage=Object.fromEntries(n.map(e=>[e.name,e.storage])),n.forEach(e=>{var t;const r={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:_s(e.name,this.schema)};e.type==="mark"&&((t=J(M(e,"keepOnSplit",r)))==null||t)&&this.splittableMarks.push(e.name);const s=M(e,"onBeforeCreate",r),i=M(e,"onCreate",r),o=M(e,"onUpdate",r),a=M(e,"onSelectionUpdate",r),l=M(e,"onTransaction",r),c=M(e,"onFocus",r),u=M(e,"onBlur",r),d=M(e,"onDestroy",r);s&&this.editor.on("beforeCreate",s),i&&this.editor.on("create",i),o&&this.editor.on("update",o),a&&this.editor.on("selectionUpdate",a),l&&this.editor.on("transaction",l),c&&this.editor.on("focus",c),u&&this.editor.on("blur",u),d&&this.editor.on("destroy",d)})}};oo.resolve=pf;oo.sort=si;oo.flatten=El;var yS={};_l(yS,{ClipboardTextSerializer:()=>Tf,Commands:()=>Ef,Delete:()=>Cf,Drop:()=>Af,Editable:()=>Of,FocusEvents:()=>If,Keymap:()=>Nf,Paste:()=>Rf,Tabindex:()=>Pf,TextDirection:()=>$f,focusEventsPluginKey:()=>Mf});var K=class xf extends Ol{constructor(){super(...arguments),this.type="extension"}static create(e={}){const t=typeof e=="function"?e():e;return new xf(t)}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}},Tf=K.create({name:"clipboardTextSerializer",addOptions(){return{blockSeparator:void 0}},addProseMirrorPlugins(){return[new se({key:new ge("clipboardTextSerializer"),props:{clipboardTextSerializer:()=>{const{editor:n}=this,{state:e,schema:t}=n,{doc:r,selection:s}=e,{ranges:i}=s,o=Math.min(...i.map(u=>u.$from.pos)),a=Math.max(...i.map(u=>u.$to.pos)),l=gf(t);return mf(r,{from:o,to:a},{...this.options.blockSeparator!==void 0?{blockSeparator:this.options.blockSeparator}:{},textSerializers:l})}}})]}}),Ef=K.create({name:"commands",addCommands(){return{...rf}}}),Cf=K.create({name:"delete",onUpdate({transaction:n,appendedTransactions:e}){var t,r,s;const i=()=>{var o,a,l,c;if((c=(l=(a=(o=this.editor.options.coreExtensionOptions)==null?void 0:o.delete)==null?void 0:a.filterTransaction)==null?void 0:l.call(a,n))!=null?c:n.getMeta("y-sync$"))return;const u=df(n.before,[n,...e]);bf(u).forEach(f=>{u.mapping.mapResult(f.oldRange.from).deletedAfter&&u.mapping.mapResult(f.oldRange.to).deletedBefore&&u.before.nodesBetween(f.oldRange.from,f.oldRange.to,(m,g)=>{const y=g+m.nodeSize-2,b=f.oldRange.from<=g&&y<=f.oldRange.to;this.editor.emit("delete",{type:"node",node:m,from:g,to:y,newFrom:u.mapping.map(g),newTo:u.mapping.map(y),deletedRange:f.oldRange,newRange:f.newRange,partial:!b,editor:this.editor,transaction:n,combinedTransform:u})})});const h=u.mapping;u.steps.forEach((f,m)=>{var g,y;if(f instanceof tt){const b=h.slice(m).map(f.from,-1),v=h.slice(m).map(f.to),w=h.invert().map(b,-1),k=h.invert().map(v),T=(g=u.doc.nodeAt(b-1))==null?void 0:g.marks.some(x=>x.eq(f.mark)),S=(y=u.doc.nodeAt(v))==null?void 0:y.marks.some(x=>x.eq(f.mark));this.editor.emit("delete",{type:"mark",mark:f.mark,from:f.from,to:f.to,deletedRange:{from:w,to:k},newRange:{from:b,to:v},partial:!!(S||T),editor:this.editor,transaction:n,combinedTransform:u})}})};(s=(r=(t=this.editor.options.coreExtensionOptions)==null?void 0:t.delete)==null?void 0:r.async)==null||s?setTimeout(i,0):i()}}),Af=K.create({name:"drop",addProseMirrorPlugins(){return[new se({key:new ge("tiptapDrop"),props:{handleDrop:(n,e,t,r)=>{this.editor.emit("drop",{editor:this.editor,event:e,slice:t,moved:r})}}})]}}),Of=K.create({name:"editable",addProseMirrorPlugins(){return[new se({key:new ge("editable"),props:{editable:()=>this.editor.options.editable}})]}}),Mf=new ge("focusEvents"),If=K.create({name:"focusEvents",addProseMirrorPlugins(){const{editor:n}=this;return[new se({key:Mf,props:{handleDOMEvents:{focus:(e,t)=>{n.isFocused=!0;const r=n.state.tr.setMeta("focus",{event:t}).setMeta("addToHistory",!1);return e.dispatch(r),!1},blur:(e,t)=>{n.isFocused=!1;const r=n.state.tr.setMeta("blur",{event:t}).setMeta("addToHistory",!1);return e.dispatch(r),!1}}}})]}}),Nf=K.create({name:"keymap",addKeyboardShortcuts(){const n=()=>this.editor.commands.first(({commands:o})=>[()=>o.undoInputRule(),()=>o.command(({tr:a})=>{const{selection:l,doc:c}=a,{empty:u,$anchor:d}=l,{pos:h,parent:f}=d,m=d.parent.isTextblock&&h>0?a.doc.resolve(h-1):d,g=m.parent.type.spec.isolating,y=d.pos-d.parentOffset,b=g&&m.parent.childCount===1?y===d.pos:F.atStart(c).from===h;return!u||!f.type.isTextblock||f.textContent.length||!b||b&&d.parent.type.name==="paragraph"?!1:o.clearNodes()}),()=>o.deleteSelection(),()=>o.joinBackward(),()=>o.selectNodeBackward()]),e=()=>this.editor.commands.first(({commands:o})=>[()=>o.deleteSelection(),()=>o.deleteCurrentNode(),()=>o.joinForward(),()=>o.selectNodeForward()]),r={Enter:()=>this.editor.commands.first(({commands:o})=>[()=>o.newlineInCode(),()=>o.createParagraphNear(),()=>o.liftEmptyBlock(),()=>o.splitBlock()]),"Mod-Enter":()=>this.editor.commands.exitCode(),Backspace:n,"Mod-Backspace":n,"Shift-Backspace":n,Delete:e,"Mod-Delete":e,"Mod-a":()=>this.editor.commands.selectAll()},s={...r},i={...r,"Ctrl-h":n,"Alt-Backspace":n,"Ctrl-d":e,"Ctrl-Alt-Backspace":e,"Alt-Delete":e,"Alt-d":e,"Ctrl-a":()=>this.editor.commands.selectTextblockStart(),"Ctrl-e":()=>this.editor.commands.selectTextblockEnd()};return ri()||cf()?i:s},addProseMirrorPlugins(){return[new se({key:new ge("clearDocument"),appendTransaction:(n,e,t)=>{if(n.some(g=>g.getMeta("composition")))return;const r=n.some(g=>g.docChanged)&&!e.doc.eq(t.doc),s=n.some(g=>g.getMeta("preventClearDocument"));if(!r||s)return;const{empty:i,from:o,to:a}=e.selection,l=F.atStart(e.doc).from,c=F.atEnd(e.doc).to;if(i||!(o===l&&a===c)||!io(t.doc))return;const h=t.tr,f=to({state:t,transaction:h}),{commands:m}=new no({editor:this.editor,state:f});if(m.clearNodes(),!!h.steps.length)return h}})]}}),Rf=K.create({name:"paste",addProseMirrorPlugins(){return[new se({key:new ge("tiptapPaste"),props:{handlePaste:(n,e,t)=>{this.editor.emit("paste",{editor:this.editor,event:e,slice:t})}}})]}}),Pf=K.create({name:"tabindex",addProseMirrorPlugins(){return[new se({key:new ge("tabindex"),props:{attributes:()=>this.editor.isEditable?{tabindex:"0"}:{}}})]}}),$f=K.create({name:"textDirection",addOptions(){return{direction:void 0}},addGlobalAttributes(){if(!this.options.direction)return[];const{nodeExtensions:n}=cr(this.extensions);return[{types:n.filter(e=>e.name!=="text").map(e=>e.name),attributes:{dir:{default:this.options.direction,parseHTML:e=>{const t=e.getAttribute("dir");return t&&(t==="ltr"||t==="rtl"||t==="auto")?t:this.options.direction},renderHTML:e=>e.dir?{dir:e.dir}:{}}}}]},addProseMirrorPlugins(){return[new se({key:new ge("textDirection"),props:{attributes:()=>{const n=this.options.direction;return n?{dir:n}:{}}}})]}}),bS=class Jn{constructor(e,t,r=!1,s=null){this.currentNode=null,this.actualDepth=null,this.isBlock=r,this.resolvedPos=e,this.editor=t,this.currentNode=s}get name(){return this.node.type.name}get node(){return this.currentNode||this.resolvedPos.node()}get element(){return this.editor.view.domAtPos(this.pos).node}get depth(){var e;return(e=this.actualDepth)!=null?e:this.resolvedPos.depth}get pos(){return this.resolvedPos.pos}get content(){return this.node.content}set content(e){let t=this.from,r=this.to;if(this.isBlock){if(this.content.size===0){console.error(`You cant set content on a block node. Tried to set content on ${this.name} at ${this.pos}`);return}t=this.from+1,r=this.to-1}this.editor.commands.insertContentAt({from:t,to:r},e)}get attributes(){return this.node.attrs}get textContent(){return this.node.textContent}get size(){return this.node.nodeSize}get from(){return this.isBlock?this.pos:this.resolvedPos.start(this.resolvedPos.depth)}get range(){return{from:this.from,to:this.to}}get to(){return this.isBlock?this.pos+this.size:this.resolvedPos.end(this.resolvedPos.depth)+(this.node.isText?0:1)}get parent(){if(this.depth===0)return null;const e=this.resolvedPos.start(this.resolvedPos.depth-1),t=this.resolvedPos.doc.resolve(e);return new Jn(t,this.editor)}get before(){let e=this.resolvedPos.doc.resolve(this.from-(this.isBlock?1:2));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.from-3)),new Jn(e,this.editor)}get after(){let e=this.resolvedPos.doc.resolve(this.to+(this.isBlock?2:1));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.to+3)),new Jn(e,this.editor)}get children(){const e=[];return this.node.content.forEach((t,r)=>{const s=t.isBlock&&!t.isTextblock,i=t.isAtom&&!t.isText,o=this.pos+r+(i?0:1);if(o<0||o>this.resolvedPos.doc.nodeSize-2)return;const a=this.resolvedPos.doc.resolve(o);if(!s&&a.depth<=this.depth)return;const l=new Jn(a,this.editor,s,s?t:null);s&&(l.actualDepth=this.depth+1),e.push(new Jn(a,this.editor,s,s?t:null))}),e}get firstChild(){return this.children[0]||null}get lastChild(){const e=this.children;return e[e.length-1]||null}closest(e,t={}){let r=null,s=this.parent;for(;s&&!r;){if(s.node.type.name===e)if(Object.keys(t).length>0){const i=s.node.attrs,o=Object.keys(t);for(let a=0;a<o.length;a+=1){const l=o[a];if(i[l]!==t[l])break}}else r=s;s=s.parent}return r}querySelector(e,t={}){return this.querySelectorAll(e,t,!0)[0]||null}querySelectorAll(e,t={},r=!1){let s=[];if(!this.children||this.children.length===0)return s;const i=Object.keys(t);return this.children.forEach(o=>{r&&s.length>0||(o.node.type.name===e&&i.every(l=>t[l]===o.node.attrs[l])&&s.push(o),!(r&&s.length>0)&&(s=s.concat(o.querySelectorAll(e,t,r))))}),s}setAttribute(e){const{tr:t}=this.editor.state;t.setNodeMarkup(this.from,void 0,{...this.node.attrs,...e}),this.editor.view.dispatch(t)}},wS=`.ProseMirror {
  position: relative;
}

.ProseMirror {
  word-wrap: break-word;
  white-space: pre-wrap;
  white-space: break-spaces;
  -webkit-font-variant-ligatures: none;
  font-variant-ligatures: none;
  font-feature-settings: "liga" 0; /* the above doesn't seem to work in Edge */
}

.ProseMirror [contenteditable="false"] {
  white-space: normal;
}

.ProseMirror [contenteditable="false"] [contenteditable="true"] {
  white-space: pre-wrap;
}

.ProseMirror pre {
  white-space: pre-wrap;
}

img.ProseMirror-separator {
  display: inline !important;
  border: none !important;
  margin: 0 !important;
  width: 0 !important;
  height: 0 !important;
}

.ProseMirror-gapcursor {
  display: none;
  pointer-events: none;
  position: absolute;
  margin: 0;
}

.ProseMirror-gapcursor:after {
  content: "";
  display: block;
  position: absolute;
  top: -2px;
  width: 20px;
  border-top: 1px solid black;
  animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

.ProseMirror-hideselection *::selection {
  background: transparent;
}

.ProseMirror-hideselection *::-moz-selection {
  background: transparent;
}

.ProseMirror-hideselection * {
  caret-color: transparent;
}

.ProseMirror-focused .ProseMirror-gapcursor {
  display: block;
}`;function vS(n,e,t){const r=document.querySelector("style[data-tiptap-style]");if(r!==null)return r;const s=document.createElement("style");return e&&s.setAttribute("nonce",e),s.setAttribute("data-tiptap-style",""),s.innerHTML=n,document.getElementsByTagName("head")[0].appendChild(s),s}var kS=class extends aS{constructor(n={}){super(),this.css=null,this.className="tiptap",this.editorView=null,this.isFocused=!1,this.isInitialized=!1,this.extensionStorage={},this.instanceId=Math.random().toString(36).slice(2,9),this.options={element:typeof document<"u"?document.createElement("div"):null,content:"",injectCSS:!0,injectNonce:void 0,extensions:[],autofocus:!1,editable:!0,textDirection:void 0,editorProps:{},parseOptions:{},coreExtensionOptions:{},enableInputRules:!0,enablePasteRules:!0,enableCoreExtensions:!0,enableContentCheck:!1,emitContentError:!1,onBeforeCreate:()=>null,onCreate:()=>null,onMount:()=>null,onUnmount:()=>null,onUpdate:()=>null,onSelectionUpdate:()=>null,onTransaction:()=>null,onFocus:()=>null,onBlur:()=>null,onDestroy:()=>null,onContentError:({error:r})=>{throw r},onPaste:()=>null,onDrop:()=>null,onDelete:()=>null,enableExtensionDispatchTransaction:!0},this.isCapturingTransaction=!1,this.capturedTransaction=null,this.utils={getUpdatedPosition:Lk,createMappablePosition:Bk},this.setOptions(n),this.createExtensionManager(),this.createCommandManager(),this.createSchema(),this.on("beforeCreate",this.options.onBeforeCreate),this.emit("beforeCreate",{editor:this}),this.on("mount",this.options.onMount),this.on("unmount",this.options.onUnmount),this.on("contentError",this.options.onContentError),this.on("create",this.options.onCreate),this.on("update",this.options.onUpdate),this.on("selectionUpdate",this.options.onSelectionUpdate),this.on("transaction",this.options.onTransaction),this.on("focus",this.options.onFocus),this.on("blur",this.options.onBlur),this.on("destroy",this.options.onDestroy),this.on("drop",({event:r,slice:s,moved:i})=>this.options.onDrop(r,s,i)),this.on("paste",({event:r,slice:s})=>this.options.onPaste(r,s)),this.on("delete",this.options.onDelete);const e=this.createDoc(),t=af(e,this.options.autofocus);this.editorState=Xn.create({doc:e,schema:this.schema,selection:t||void 0}),this.options.element&&this.mount(this.options.element)}mount(n){if(typeof document>"u")throw new Error("[tiptap error]: The editor cannot be mounted because there is no 'document' defined in this environment.");this.createView(n),this.emit("mount",{editor:this}),this.css&&!document.head.contains(this.css)&&document.head.appendChild(this.css),window.setTimeout(()=>{this.isDestroyed||(this.options.autofocus!==!1&&this.options.autofocus!==null&&this.commands.focus(this.options.autofocus),this.emit("create",{editor:this}),this.isInitialized=!0)},0)}unmount(){if(this.editorView){const n=this.editorView.dom;n?.editor&&delete n.editor,this.editorView.destroy()}if(this.editorView=null,this.isInitialized=!1,this.css&&!document.querySelectorAll(`.${this.className}`).length)try{typeof this.css.remove=="function"?this.css.remove():this.css.parentNode&&this.css.parentNode.removeChild(this.css)}catch(n){console.warn("Failed to remove CSS element:",n)}this.css=null,this.emit("unmount",{editor:this})}get storage(){return this.extensionStorage}get commands(){return this.commandManager.commands}chain(){return this.commandManager.chain()}can(){return this.commandManager.can()}injectCSS(){this.options.injectCSS&&typeof document<"u"&&(this.css=vS(wS,this.options.injectNonce))}setOptions(n={}){this.options={...this.options,...n},!(!this.editorView||!this.state||this.isDestroyed)&&(this.options.editorProps&&this.view.setProps(this.options.editorProps),this.view.updateState(this.state))}setEditable(n,e=!0){this.setOptions({editable:n}),e&&this.emit("update",{editor:this,transaction:this.state.tr,appendedTransactions:[]})}get isEditable(){return this.options.editable&&this.view&&this.view.editable}get view(){return this.editorView?this.editorView:new Proxy({state:this.editorState,updateState:n=>{this.editorState=n},dispatch:n=>{this.dispatchTransaction(n)},composing:!1,dragging:null,editable:!0,isDestroyed:!1},{get:(n,e)=>{if(this.editorView)return this.editorView[e];if(e==="state")return this.editorState;if(e in n)return Reflect.get(n,e);throw new Error(`[tiptap error]: The editor view is not available. Cannot access view['${e}']. The editor may not be mounted yet.`)}})}get state(){return this.editorView&&(this.editorState=this.view.state),this.editorState}registerPlugin(n,e){const t=hf(e)?e(n,[...this.state.plugins]):[...this.state.plugins,n],r=this.state.reconfigure({plugins:t});return this.view.updateState(r),r}unregisterPlugin(n){if(this.isDestroyed)return;const e=this.state.plugins;let t=e;if([].concat(n).forEach(s=>{const i=typeof s=="string"?`${s}$`:s.key;t=t.filter(o=>!o.key.startsWith(i))}),e.length===t.length)return;const r=this.state.reconfigure({plugins:t});return this.view.updateState(r),r}createExtensionManager(){var n,e;const r=[...this.options.enableCoreExtensions?[Of,Tf.configure({blockSeparator:(e=(n=this.options.coreExtensionOptions)==null?void 0:n.clipboardTextSerializer)==null?void 0:e.blockSeparator}),Ef,If,Nf,Pf,Af,Rf,Cf,$f.configure({direction:this.options.textDirection})].filter(s=>typeof this.options.enableCoreExtensions=="object"?this.options.enableCoreExtensions[s.name]!==!1:!0):[],...this.options.extensions].filter(s=>["extension","node","mark"].includes(s?.type));this.extensionManager=new oo(r,this)}createCommandManager(){this.commandManager=new no({editor:this})}createSchema(){this.schema=this.extensionManager.schema}createDoc(){let n;try{n=Ia(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:this.options.enableContentCheck})}catch(e){if(!(e instanceof Error)||!["[tiptap error]: Invalid JSON content","[tiptap error]: Invalid HTML content"].includes(e.message))throw e;this.emit("contentError",{editor:this,error:e,disableCollaboration:()=>{"collaboration"in this.storage&&typeof this.storage.collaboration=="object"&&this.storage.collaboration&&(this.storage.collaboration.isDisabled=!0),this.options.extensions=this.options.extensions.filter(t=>t.name!=="collaboration"),this.createExtensionManager()}}),n=Ia(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:!1})}return n}createView(n){const{editorProps:e,enableExtensionDispatchTransaction:t}=this.options,r=e.dispatchTransaction||this.dispatchTransaction.bind(this),s=t?this.extensionManager.dispatchTransaction(r):r;this.editorView=new tf(n,{...e,attributes:{role:"textbox",...e?.attributes},dispatchTransaction:s,state:this.editorState,markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews});const i=this.state.reconfigure({plugins:this.extensionManager.plugins});this.view.updateState(i),this.prependClass(),this.injectCSS();const o=this.view.dom;o.editor=this}createNodeViews(){this.view.isDestroyed||this.view.setProps({markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews})}prependClass(){this.view.dom.className=`${this.className} ${this.view.dom.className}`}captureTransaction(n){this.isCapturingTransaction=!0,n(),this.isCapturingTransaction=!1;const e=this.capturedTransaction;return this.capturedTransaction=null,e}dispatchTransaction(n){if(this.view.isDestroyed)return;if(this.isCapturingTransaction){if(!this.capturedTransaction){this.capturedTransaction=n;return}n.steps.forEach(c=>{var u;return(u=this.capturedTransaction)==null?void 0:u.step(c)});return}const{state:e,transactions:t}=this.state.applyTransaction(n),r=!this.state.selection.eq(e.selection),s=t.includes(n),i=this.state;if(this.emit("beforeTransaction",{editor:this,transaction:n,nextState:e}),!s)return;this.view.updateState(e),this.emit("transaction",{editor:this,transaction:n,appendedTransactions:t.slice(1)}),r&&this.emit("selectionUpdate",{editor:this,transaction:n});const o=t.findLast(c=>c.getMeta("focus")||c.getMeta("blur")),a=o?.getMeta("focus"),l=o?.getMeta("blur");a&&this.emit("focus",{editor:this,event:a.event,transaction:o}),l&&this.emit("blur",{editor:this,event:l.event,transaction:o}),!(n.getMeta("preventUpdate")||!t.some(c=>c.docChanged)||i.doc.eq(e.doc))&&this.emit("update",{editor:this,transaction:n,appendedTransactions:t.slice(1)})}getAttributes(n){return yf(this.state,n)}isActive(n,e){const t=typeof n=="string"?n:null,r=typeof n=="string"?e:n;return $k(this.state,t,r)}getJSON(){return this.state.doc.toJSON()}getHTML(){return Cl(this.state.doc.content,this.schema)}getText(n){const{blockSeparator:e=`

`,textSerializers:t={}}=n||{};return Ok(this.state.doc,{blockSeparator:e,textSerializers:{...gf(this.schema),...t}})}get isEmpty(){return io(this.state.doc)}destroy(){this.emit("destroy"),this.unmount(),this.removeAllListeners()}get isDestroyed(){var n,e;return(e=(n=this.editorView)==null?void 0:n.isDestroyed)!=null?e:!0}$node(n,e){var t;return((t=this.$doc)==null?void 0:t.querySelector(n,e))||null}$nodes(n,e){var t;return((t=this.$doc)==null?void 0:t.querySelectorAll(n,e))||null}$pos(n){const e=this.state.doc.resolve(n);return new bS(e,this)}get $doc(){return this.$pos(0)}};function Nn(n){return new us({find:n.find,handler:({state:e,range:t,match:r})=>{const s=J(n.getAttributes,void 0,r);if(s===!1||s===null)return null;const{tr:i}=e,o=r[r.length-1],a=r[0];if(o){const l=a.search(/\S/),c=t.from+a.indexOf(o),u=c+o.length;if(Al(t.from,t.to,e.doc).filter(f=>f.mark.type.excluded.find(g=>g===n.type&&g!==f.mark.type)).filter(f=>f.to>c).length)return null;u<t.to&&i.delete(u,t.to),c>t.from&&i.delete(t.from+l,c);const h=t.from+l+o.length;i.addMark(t.from+l,h,n.type.create(s||{})),i.removeStoredMark(n.type)}},undoable:n.undoable})}function SS(n){return new us({find:n.find,handler:({state:e,range:t,match:r})=>{const s=J(n.getAttributes,void 0,r)||{},{tr:i}=e,o=t.from;let a=t.to;const l=n.type.create(s);if(r[1]){const c=r[0].lastIndexOf(r[1]);let u=o+c;u>a?u=a:a=u+r[1].length;const d=r[0][r[0].length-1];i.insertText(d,o+r[0].length-1),i.replaceWith(u,a,l)}else if(r[0]){const c=n.type.isInline?o:o-1;i.insert(c,n.type.create(s)).delete(i.mapping.map(o),i.mapping.map(a))}i.scrollIntoView()},undoable:n.undoable})}function Ra(n){return new us({find:n.find,handler:({state:e,range:t,match:r})=>{const s=e.doc.resolve(t.from),i=J(n.getAttributes,void 0,r)||{};if(!s.node(-1).canReplaceWith(s.index(-1),s.indexAfter(-1),n.type))return null;e.tr.delete(t.from,t.to).setBlockType(t.from,t.from,n.type,i)},undoable:n.undoable})}function ur(n){return new us({find:n.find,handler:({state:e,range:t,match:r,chain:s})=>{const i=J(n.getAttributes,void 0,r)||{},o=e.tr.delete(t.from,t.to),l=o.doc.resolve(t.from).blockRange(),c=l&&al(l,n.type,i);if(!c)return null;if(o.wrap(l,c),n.keepMarks&&n.editor){const{selection:d,storedMarks:h}=e,{splittableMarks:f}=n.editor.extensionManager,m=h||d.$to.parentOffset&&d.$from.marks();if(m){const g=m.filter(y=>f.includes(y.type.name));o.ensureMarks(g)}}if(n.keepAttributes){const d=n.type.name==="bulletList"||n.type.name==="orderedList"?"listItem":"taskList";s().updateAttributes(d,i).run()}const u=o.doc.resolve(t.from-1).nodeBefore;u&&u.type===n.type&&nn(o.doc,t.from-1)&&(!n.joinPredicate||n.joinPredicate(r,u))&&o.join(t.from-1)},undoable:n.undoable})}function _S(n,e){const{selection:t}=n,{$from:r}=t;if(t instanceof N){const i=r.index();return r.parent.canReplaceWith(i,i+1,e)}let s=r.depth;for(;s>=0;){const i=r.index(s);if(r.node(s).contentMatchAt(i).matchType(e))return!0;s-=1}return!1}var xS={};_l(xS,{createAtomBlockMarkdownSpec:()=>TS,createBlockMarkdownSpec:()=>ES,createInlineMarkdownSpec:()=>OS,parseAttributes:()=>Ml,parseIndentedBlocks:()=>Pa,renderNestedMarkdownContent:()=>Nl,serializeAttributes:()=>Il});function Ml(n){if(!n?.trim())return{};const e={},t=[],r=n.replace(/["']([^"']*)["']/g,c=>(t.push(c),`__QUOTED_${t.length-1}__`)),s=r.match(/(?:^|\s)\.([a-zA-Z][\w-]*)/g);if(s){const c=s.map(u=>u.trim().slice(1));e.class=c.join(" ")}const i=r.match(/(?:^|\s)#([a-zA-Z][\w-]*)/);i&&(e.id=i[1]);const o=/([a-zA-Z][\w-]*)\s*=\s*(__QUOTED_\d+__)/g;Array.from(r.matchAll(o)).forEach(([,c,u])=>{var d;const h=parseInt(((d=u.match(/__QUOTED_(\d+)__/))==null?void 0:d[1])||"0",10),f=t[h];f&&(e[c]=f.slice(1,-1))});const l=r.replace(/(?:^|\s)\.([a-zA-Z][\w-]*)/g,"").replace(/(?:^|\s)#([a-zA-Z][\w-]*)/g,"").replace(/([a-zA-Z][\w-]*)\s*=\s*__QUOTED_\d+__/g,"").trim();return l&&l.split(/\s+/).filter(Boolean).forEach(u=>{u.match(/^[a-zA-Z][\w-]*$/)&&(e[u]=!0)}),e}function Il(n){if(!n||Object.keys(n).length===0)return"";const e=[];return n.class&&String(n.class).split(/\s+/).filter(Boolean).forEach(r=>e.push(`.${r}`)),n.id&&e.push(`#${n.id}`),Object.entries(n).forEach(([t,r])=>{t==="class"||t==="id"||(r===!0?e.push(t):r!==!1&&r!=null&&e.push(`${t}="${String(r)}"`))}),e.join(" ")}function TS(n){const{nodeName:e,name:t,parseAttributes:r=Ml,serializeAttributes:s=Il,defaultAttributes:i={},requiredAttributes:o=[],allowedAttributes:a}=n,l=t||e,c=u=>{if(!a)return u;const d={};return a.forEach(h=>{h in u&&(d[h]=u[h])}),d};return{parseMarkdown:(u,d)=>{const h={...i,...u.attributes};return d.createNode(e,h,[])},markdownTokenizer:{name:e,level:"block",start(u){var d;const h=new RegExp(`^:::${l}(?:\\s|$)`,"m"),f=(d=u.match(h))==null?void 0:d.index;return f!==void 0?f:-1},tokenize(u,d,h){const f=new RegExp(`^:::${l}(?:\\s+\\{([^}]*)\\})?\\s*:::(?:\\n|$)`),m=u.match(f);if(!m)return;const g=m[1]||"",y=r(g);if(!o.find(v=>!(v in y)))return{type:e,raw:m[0],attributes:y}}},renderMarkdown:u=>{const d=c(u.attrs||{}),h=s(d),f=h?` {${h}}`:"";return`:::${l}${f} :::`}}}function ES(n){const{nodeName:e,name:t,getContent:r,parseAttributes:s=Ml,serializeAttributes:i=Il,defaultAttributes:o={},content:a="block",allowedAttributes:l}=n,c=t||e,u=d=>{if(!l)return d;const h={};return l.forEach(f=>{f in d&&(h[f]=d[f])}),h};return{parseMarkdown:(d,h)=>{let f;if(r){const g=r(d);f=typeof g=="string"?[{type:"text",text:g}]:g}else a==="block"?f=h.parseChildren(d.tokens||[]):f=h.parseInline(d.tokens||[]);const m={...o,...d.attributes};return h.createNode(e,m,f)},markdownTokenizer:{name:e,level:"block",start(d){var h;const f=new RegExp(`^:::${c}`,"m"),m=(h=d.match(f))==null?void 0:h.index;return m!==void 0?m:-1},tokenize(d,h,f){var m;const g=new RegExp(`^:::${c}(?:\\s+\\{([^}]*)\\})?\\s*\\n`),y=d.match(g);if(!y)return;const[b,v=""]=y,w=s(v);let k=1;const T=b.length;let S="";const x=/^:::([\w-]*)(\s.*)?/gm,C=d.slice(T);for(x.lastIndex=0;;){const R=x.exec(C);if(R===null)break;const X=R.index,I=R[1];if(!((m=R[2])!=null&&m.endsWith(":::"))){if(I)k+=1;else if(k-=1,k===0){const H=C.slice(0,X);S=H.trim();const pe=d.slice(0,T+X+R[0].length);let te=[];if(S)if(a==="block")for(te=f.blockTokens(H),te.forEach(Z=>{Z.text&&(!Z.tokens||Z.tokens.length===0)&&(Z.tokens=f.inlineTokens(Z.text))});te.length>0;){const Z=te[te.length-1];if(Z.type==="paragraph"&&(!Z.text||Z.text.trim()===""))te.pop();else break}else te=f.inlineTokens(S);return{type:e,raw:pe,attributes:w,content:S,tokens:te}}}}}},renderMarkdown:(d,h)=>{const f=u(d.attrs||{}),m=i(f),g=m?` {${m}}`:"",y=h.renderChildren(d.content||[],`

`);return`:::${c}${g}

${y}

:::`}}}function CS(n){if(!n.trim())return{};const e={},t=/(\w+)=(?:"([^"]*)"|'([^']*)')/g;let r=t.exec(n);for(;r!==null;){const[,s,i,o]=r;e[s]=i||o,r=t.exec(n)}return e}function AS(n){return Object.entries(n).filter(([,e])=>e!=null).map(([e,t])=>`${e}="${t}"`).join(" ")}function OS(n){const{nodeName:e,name:t,getContent:r,parseAttributes:s=CS,serializeAttributes:i=AS,defaultAttributes:o={},selfClosing:a=!1,allowedAttributes:l}=n,c=t||e,u=h=>{if(!l)return h;const f={};return l.forEach(m=>{const g=typeof m=="string"?m:m.name,y=typeof m=="string"?void 0:m.skipIfDefault;if(g in h){const b=h[g];if(y!==void 0&&b===y)return;f[g]=b}}),f},d=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return{parseMarkdown:(h,f)=>{const m={...o,...h.attributes};if(a)return f.createNode(e,m);const g=r?r(h):h.content||"";return g?f.createNode(e,m,[f.createTextNode(g)]):f.createNode(e,m,[])},markdownTokenizer:{name:e,level:"inline",start(h){const f=a?new RegExp(`\\[${d}\\s*[^\\]]*\\]`):new RegExp(`\\[${d}\\s*[^\\]]*\\][\\s\\S]*?\\[\\/${d}\\]`),m=h.match(f),g=m?.index;return g!==void 0?g:-1},tokenize(h,f,m){const g=a?new RegExp(`^\\[${d}\\s*([^\\]]*)\\]`):new RegExp(`^\\[${d}\\s*([^\\]]*)\\]([\\s\\S]*?)\\[\\/${d}\\]`),y=h.match(g);if(!y)return;let b="",v="";if(a){const[,k]=y;v=k}else{const[,k,T]=y;v=k,b=T||""}const w=s(v.trim());return{type:e,raw:y[0],content:b.trim(),attributes:w}}},renderMarkdown:h=>{let f="";r?f=r(h):h.content&&h.content.length>0&&(f=h.content.filter(b=>b.type==="text").map(b=>b.text).join(""));const m=u(h.attrs||{}),g=i(m),y=g?` ${g}`:"";return a?`[${c}${y}]`:`[${c}${y}]${f}[/${c}]`}}}function Pa(n,e,t){var r,s,i,o;const a=n.split(`
`),l=[];let c="",u=0;const d=e.baseIndentSize||2;for(;u<a.length;){const h=a[u],f=h.match(e.itemPattern);if(!f){if(l.length>0)break;if(h.trim()===""){u+=1,c=`${c}${h}
`;continue}else return}const m=e.extractItemData(f),{indentLevel:g,mainContent:y}=m;c=`${c}${h}
`;const b=[y];for(u+=1;u<a.length;){const T=a[u];if(T.trim()===""){const x=a.slice(u+1).findIndex(X=>X.trim()!=="");if(x===-1)break;if((((s=(r=a[u+1+x].match(/^(\s*)/))==null?void 0:r[1])==null?void 0:s.length)||0)>g){b.push(T),c=`${c}${T}
`,u+=1;continue}else break}if((((o=(i=T.match(/^(\s*)/))==null?void 0:i[1])==null?void 0:o.length)||0)>g)b.push(T),c=`${c}${T}
`,u+=1;else break}let v;const w=b.slice(1);if(w.length>0){const T=w.map(S=>S.slice(g+d)).join(`
`);T.trim()&&(e.customNestedParser?v=e.customNestedParser(T):v=t.blockTokens(T))}const k=e.createToken(m,v);l.push(k)}if(l.length!==0)return{items:l,raw:c}}function Nl(n,e,t,r){if(!n||!Array.isArray(n.content))return"";const s=typeof t=="function"?t(r):t,[i,...o]=n.content,a=e.renderChildren([i]),l=[`${s}${a}`];return o&&o.length>0&&o.forEach(c=>{const u=e.renderChildren([c]);if(u){const d=u.split(`
`).map(h=>h?e.indent(h):"").join(`
`);l.push(d)}}),l.join(`
`)}function MS(n,e,t={}){const{state:r}=e,{doc:s,tr:i}=r,o=n;s.descendants((a,l)=>{const c=i.mapping.map(l),u=i.mapping.map(l)+a.nodeSize;let d=null;if(a.marks.forEach(f=>{if(f!==o)return!1;d=f}),!d)return;let h=!1;if(Object.keys(t).forEach(f=>{t[f]!==d.attrs[f]&&(h=!0)}),h){const f=n.type.create({...n.attrs,...t});i.removeMark(c,u,n.type),i.addMark(c,u,f)}}),i.docChanged&&e.view.dispatch(i)}var Fe=class Df extends Ol{constructor(){super(...arguments),this.type="node"}static create(e={}){const t=typeof e=="function"?e():e;return new Df(t)}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}};function en(n){return new hS({find:n.find,handler:({state:e,range:t,match:r,pasteEvent:s})=>{const i=J(n.getAttributes,void 0,r,s);if(i===!1||i===null)return null;const{tr:o}=e,a=r[r.length-1],l=r[0];let c=t.to;if(a){const u=l.search(/\S/),d=t.from+l.indexOf(a),h=d+a.length;if(Al(t.from,t.to,e.doc).filter(m=>m.mark.type.excluded.find(y=>y===n.type&&y!==m.mark.type)).filter(m=>m.to>d).length)return null;h<t.to&&o.delete(h,t.to),d>t.from&&o.delete(t.from+u,d),c=t.from+u+a.length,o.addMark(t.from+u,c,n.type.create(i||{})),o.removeStoredMark(n.type)}}})}var ii=(n,e)=>{if(n==="slot")return 0;if(n instanceof Function)return n(e);const{children:t,...r}=e??{};if(n==="svg")throw new Error("SVG elements are not supported in the JSX syntax, use the array syntax instead");return[n,r,t]},IS=/^\s*>\s$/,NS=Fe.create({name:"blockquote",addOptions(){return{HTMLAttributes:{}}},content:"block+",group:"block",defining:!0,parseHTML(){return[{tag:"blockquote"}]},renderHTML({HTMLAttributes:n}){return ii("blockquote",{...le(this.options.HTMLAttributes,n),children:ii("slot",{})})},parseMarkdown:(n,e)=>e.createNode("blockquote",void 0,e.parseChildren(n.tokens||[])),renderMarkdown:(n,e)=>{if(!n.content)return"";const t=">",r=[];return n.content.forEach(s=>{const a=e.renderChildren([s]).split(`
`).map(l=>l.trim()===""?t:`${t} ${l}`);r.push(a.join(`
`))}),r.join(`
${t}
`)},addCommands(){return{setBlockquote:()=>({commands:n})=>n.wrapIn(this.name),toggleBlockquote:()=>({commands:n})=>n.toggleWrap(this.name),unsetBlockquote:()=>({commands:n})=>n.lift(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-b":()=>this.editor.commands.toggleBlockquote()}},addInputRules(){return[ur({find:IS,type:this.type})]}}),RS=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))$/,PS=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))/g,$S=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))$/,DS=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))/g,jS=It.create({name:"bold",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"strong"},{tag:"b",getAttrs:n=>n.style.fontWeight!=="normal"&&null},{style:"font-weight=400",clearMark:n=>n.type.name===this.name},{style:"font-weight",getAttrs:n=>/^(bold(er)?|[5-9]\d{2,})$/.test(n)&&null}]},renderHTML({HTMLAttributes:n}){return ii("strong",{...le(this.options.HTMLAttributes,n),children:ii("slot",{})})},markdownTokenName:"strong",parseMarkdown:(n,e)=>e.applyMark("bold",e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>`**${e.renderChildren(n)}**`,addCommands(){return{setBold:()=>({commands:n})=>n.setMark(this.name),toggleBold:()=>({commands:n})=>n.toggleMark(this.name),unsetBold:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-b":()=>this.editor.commands.toggleBold(),"Mod-B":()=>this.editor.commands.toggleBold()}},addInputRules(){return[Nn({find:RS,type:this.type}),Nn({find:$S,type:this.type})]},addPasteRules(){return[en({find:PS,type:this.type}),en({find:DS,type:this.type})]}}),LS=/(^|[^`])`([^`]+)`(?!`)$/,BS=/(^|[^`])`([^`]+)`(?!`)/g,zS=It.create({name:"code",addOptions(){return{HTMLAttributes:{}}},excludes:"_",code:!0,exitable:!0,parseHTML(){return[{tag:"code"}]},renderHTML({HTMLAttributes:n}){return["code",le(this.options.HTMLAttributes,n),0]},markdownTokenName:"codespan",parseMarkdown:(n,e)=>e.applyMark("code",[{type:"text",text:n.text||""}]),renderMarkdown:(n,e)=>n.content?`\`${e.renderChildren(n.content)}\``:"",addCommands(){return{setCode:()=>({commands:n})=>n.setMark(this.name),toggleCode:()=>({commands:n})=>n.toggleMark(this.name),unsetCode:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-e":()=>this.editor.commands.toggleCode()}},addInputRules(){return[Nn({find:LS,type:this.type})]},addPasteRules(){return[en({find:BS,type:this.type})]}}),zo=4,FS=/^```([a-z]+)?[\s\n]$/,US=/^~~~([a-z]+)?[\s\n]$/,HS=Fe.create({name:"codeBlock",addOptions(){return{languageClassPrefix:"language-",exitOnTripleEnter:!0,exitOnArrowDown:!0,defaultLanguage:null,enableTabIndentation:!1,tabSize:zo,HTMLAttributes:{}}},content:"text*",marks:"",group:"block",code:!0,defining:!0,addAttributes(){return{language:{default:this.options.defaultLanguage,parseHTML:n=>{var e;const{languageClassPrefix:t}=this.options;if(!t)return null;const i=[...((e=n.firstElementChild)==null?void 0:e.classList)||[]].filter(o=>o.startsWith(t)).map(o=>o.replace(t,""))[0];return i||null},rendered:!1}}},parseHTML(){return[{tag:"pre",preserveWhitespace:"full"}]},renderHTML({node:n,HTMLAttributes:e}){return["pre",le(this.options.HTMLAttributes,e),["code",{class:n.attrs.language?this.options.languageClassPrefix+n.attrs.language:null},0]]},markdownTokenName:"code",parseMarkdown:(n,e)=>{var t;return((t=n.raw)==null?void 0:t.startsWith("```"))===!1&&n.codeBlockStyle!=="indented"?[]:e.createNode("codeBlock",{language:n.lang||null},n.text?[e.createTextNode(n.text)]:[])},renderMarkdown:(n,e)=>{var t;let r="";const s=((t=n.attrs)==null?void 0:t.language)||"";return n.content?r=[`\`\`\`${s}`,e.renderChildren(n.content),"```"].join(`
`):r=`\`\`\`${s}

\`\`\``,r},addCommands(){return{setCodeBlock:n=>({commands:e})=>e.setNode(this.name,n),toggleCodeBlock:n=>({commands:e})=>e.toggleNode(this.name,"paragraph",n)}},addKeyboardShortcuts(){return{"Mod-Alt-c":()=>this.editor.commands.toggleCodeBlock(),Backspace:()=>{const{empty:n,$anchor:e}=this.editor.state.selection,t=e.pos===1;return!n||e.parent.type.name!==this.name?!1:t||!e.parent.textContent.length?this.editor.commands.clearNodes():!1},Tab:({editor:n})=>{var e;if(!this.options.enableTabIndentation)return!1;const t=(e=this.options.tabSize)!=null?e:zo,{state:r}=n,{selection:s}=r,{$from:i,empty:o}=s;if(i.parent.type!==this.type)return!1;const a=" ".repeat(t);return o?n.commands.insertContent(a):n.commands.command(({tr:l})=>{const{from:c,to:u}=s,f=r.doc.textBetween(c,u,`
`,`
`).split(`
`).map(m=>a+m).join(`
`);return l.replaceWith(c,u,r.schema.text(f)),!0})},"Shift-Tab":({editor:n})=>{var e;if(!this.options.enableTabIndentation)return!1;const t=(e=this.options.tabSize)!=null?e:zo,{state:r}=n,{selection:s}=r,{$from:i,empty:o}=s;return i.parent.type!==this.type?!1:o?n.commands.command(({tr:a})=>{var l;const{pos:c}=i,u=i.start(),d=i.end(),f=r.doc.textBetween(u,d,`
`,`
`).split(`
`);let m=0,g=0;const y=c-u;for(let S=0;S<f.length;S+=1){if(g+f[S].length>=y){m=S;break}g+=f[S].length+1}const v=((l=f[m].match(/^ */))==null?void 0:l[0])||"",w=Math.min(v.length,t);if(w===0)return!0;let k=u;for(let S=0;S<m;S+=1)k+=f[S].length+1;return a.delete(k,k+w),c-k<=w&&a.setSelection(j.create(a.doc,k)),!0}):n.commands.command(({tr:a})=>{const{from:l,to:c}=s,h=r.doc.textBetween(l,c,`
`,`
`).split(`
`).map(f=>{var m;const g=((m=f.match(/^ */))==null?void 0:m[0])||"",y=Math.min(g.length,t);return f.slice(y)}).join(`
`);return a.replaceWith(l,c,r.schema.text(h)),!0})},Enter:({editor:n})=>{if(!this.options.exitOnTripleEnter)return!1;const{state:e}=n,{selection:t}=e,{$from:r,empty:s}=t;if(!s||r.parent.type!==this.type)return!1;const i=r.parentOffset===r.parent.nodeSize-2,o=r.parent.textContent.endsWith(`

`);return!i||!o?!1:n.chain().command(({tr:a})=>(a.delete(r.pos-2,r.pos),!0)).exitCode().run()},ArrowDown:({editor:n})=>{if(!this.options.exitOnArrowDown)return!1;const{state:e}=n,{selection:t,doc:r}=e,{$from:s,empty:i}=t;if(!i||s.parent.type!==this.type||!(s.parentOffset===s.parent.nodeSize-2))return!1;const a=s.after();return a===void 0?!1:r.nodeAt(a)?n.commands.command(({tr:c})=>(c.setSelection(F.near(r.resolve(a))),!0)):n.commands.exitCode()}}},addInputRules(){return[Ra({find:FS,type:this.type,getAttributes:n=>({language:n[1]})}),Ra({find:US,type:this.type,getAttributes:n=>({language:n[1]})})]},addProseMirrorPlugins(){return[new se({key:new ge("codeBlockVSCodeHandler"),props:{handlePaste:(n,e)=>{if(!e.clipboardData||this.editor.isActive(this.type.name))return!1;const t=e.clipboardData.getData("text/plain"),r=e.clipboardData.getData("vscode-editor-data"),s=r?JSON.parse(r):void 0,i=s?.mode;if(!t||!i)return!1;const{tr:o,schema:a}=n.state,l=a.text(t.replace(/\r\n?/g,`
`));return o.replaceSelectionWith(this.type.create({language:i},l)),o.selection.$from.parent.type!==this.type&&o.setSelection(j.near(o.doc.resolve(Math.max(0,o.selection.from-2)))),o.setMeta("paste",!0),n.dispatch(o),!0}}})]}}),VS=Fe.create({name:"doc",topNode:!0,content:"block+",renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`

`):""}),qS=Fe.create({name:"hardBreak",markdownTokenName:"br",addOptions(){return{keepMarks:!0,HTMLAttributes:{}}},inline:!0,group:"inline",selectable:!1,linebreakReplacement:!0,parseHTML(){return[{tag:"br"}]},renderHTML({HTMLAttributes:n}){return["br",le(this.options.HTMLAttributes,n)]},renderText(){return`
`},renderMarkdown:()=>`  
`,parseMarkdown:()=>({type:"hardBreak"}),addCommands(){return{setHardBreak:()=>({commands:n,chain:e,state:t,editor:r})=>n.first([()=>n.exitCode(),()=>n.command(()=>{const{selection:s,storedMarks:i}=t;if(s.$from.parent.type.spec.isolating)return!1;const{keepMarks:o}=this.options,{splittableMarks:a}=r.extensionManager,l=i||s.$to.parentOffset&&s.$from.marks();return e().insertContent({type:this.name}).command(({tr:c,dispatch:u})=>{if(u&&l&&o){const d=l.filter(h=>a.includes(h.type.name));c.ensureMarks(d)}return!0}).run()})])}},addKeyboardShortcuts(){return{"Mod-Enter":()=>this.editor.commands.setHardBreak(),"Shift-Enter":()=>this.editor.commands.setHardBreak()}}}),WS=Fe.create({name:"heading",addOptions(){return{levels:[1,2,3,4,5,6],HTMLAttributes:{}}},content:"inline*",group:"block",defining:!0,addAttributes(){return{level:{default:1,rendered:!1}}},parseHTML(){return this.options.levels.map(n=>({tag:`h${n}`,attrs:{level:n}}))},renderHTML({node:n,HTMLAttributes:e}){return[`h${this.options.levels.includes(n.attrs.level)?n.attrs.level:this.options.levels[0]}`,le(this.options.HTMLAttributes,e),0]},parseMarkdown:(n,e)=>e.createNode("heading",{level:n.depth||1},e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>{var t;const r=(t=n.attrs)!=null&&t.level?parseInt(n.attrs.level,10):1,s="#".repeat(r);return n.content?`${s} ${e.renderChildren(n.content)}`:""},addCommands(){return{setHeading:n=>({commands:e})=>this.options.levels.includes(n.level)?e.setNode(this.name,n):!1,toggleHeading:n=>({commands:e})=>this.options.levels.includes(n.level)?e.toggleNode(this.name,"paragraph",n):!1}},addKeyboardShortcuts(){return this.options.levels.reduce((n,e)=>({...n,[`Mod-Alt-${e}`]:()=>this.editor.commands.toggleHeading({level:e})}),{})},addInputRules(){return this.options.levels.map(n=>Ra({find:new RegExp(`^(#{${Math.min(...this.options.levels)},${n}})\\s$`),type:this.type,getAttributes:{level:n}}))}}),KS=Fe.create({name:"horizontalRule",addOptions(){return{HTMLAttributes:{},nextNodeType:"paragraph"}},group:"block",parseHTML(){return[{tag:"hr"}]},renderHTML({HTMLAttributes:n}){return["hr",le(this.options.HTMLAttributes,n)]},markdownTokenName:"hr",parseMarkdown:(n,e)=>e.createNode("horizontalRule"),renderMarkdown:()=>"---",addCommands(){return{setHorizontalRule:()=>({chain:n,state:e})=>{if(!_S(e,e.schema.nodes[this.name]))return!1;const{selection:t}=e,{$to:r}=t,s=n();return wf(t)?s.insertContentAt(r.pos,{type:this.name}):s.insertContent({type:this.name}),s.command(({state:i,tr:o,dispatch:a})=>{if(a){const{$to:l}=o.selection,c=l.end();if(l.nodeAfter)l.nodeAfter.isTextblock?o.setSelection(j.create(o.doc,l.pos+1)):l.nodeAfter.isBlock?o.setSelection(N.create(o.doc,l.pos)):o.setSelection(j.create(o.doc,l.pos));else{const u=i.schema.nodes[this.options.nextNodeType]||l.parent.type.contentMatch.defaultType,d=u?.create();d&&(o.insert(c,d),o.setSelection(j.create(o.doc,c+1)))}o.scrollIntoView()}return!0}).run()}}},addInputRules(){return[SS({find:/^(?:---|-|___\s|\*\*\*\s)$/,type:this.type})]}}),JS=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))$/,GS=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))/g,YS=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))$/,XS=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))/g,QS=It.create({name:"italic",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"em"},{tag:"i",getAttrs:n=>n.style.fontStyle!=="normal"&&null},{style:"font-style=normal",clearMark:n=>n.type.name===this.name},{style:"font-style=italic"}]},renderHTML({HTMLAttributes:n}){return["em",le(this.options.HTMLAttributes,n),0]},addCommands(){return{setItalic:()=>({commands:n})=>n.setMark(this.name),toggleItalic:()=>({commands:n})=>n.toggleMark(this.name),unsetItalic:()=>({commands:n})=>n.unsetMark(this.name)}},markdownTokenName:"em",parseMarkdown:(n,e)=>e.applyMark("italic",e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>`*${e.renderChildren(n)}*`,addKeyboardShortcuts(){return{"Mod-i":()=>this.editor.commands.toggleItalic(),"Mod-I":()=>this.editor.commands.toggleItalic()}},addInputRules(){return[Nn({find:JS,type:this.type}),Nn({find:YS,type:this.type})]},addPasteRules(){return[en({find:GS,type:this.type}),en({find:XS,type:this.type})]}});const ZS="aaa1rp3bb0ott3vie4c1le2ogado5udhabi7c0ademy5centure6ountant0s9o1tor4d0s1ult4e0g1ro2tna4f0l1rica5g0akhan5ency5i0g1rbus3force5tel5kdn3l0ibaba4pay4lfinanz6state5y2sace3tom5m0azon4ericanexpress7family11x2fam3ica3sterdam8nalytics7droid5quan4z2o0l2partments8p0le4q0uarelle8r0ab1mco4chi3my2pa2t0e3s0da2ia2sociates9t0hleta5torney7u0ction5di0ble3o3spost5thor3o0s4w0s2x0a2z0ure5ba0by2idu3namex4d1k2r0celona5laycard4s5efoot5gains6seball5ketball8uhaus5yern5b0c1t1va3cg1n2d1e0ats2uty4er2rlin4st0buy5t2f1g1h0arti5i0ble3d1ke2ng0o3o1z2j1lack0friday9ockbuster8g1omberg7ue3m0s1w2n0pparibas9o0ats3ehringer8fa2m1nd2o0k0ing5sch2tik2on4t1utique6x2r0adesco6idgestone9oadway5ker3ther5ussels7s1t1uild0ers6siness6y1zz3v1w1y1z0h3ca0b1fe2l0l1vinklein9m0era3p2non3petown5ital0one8r0avan4ds2e0er0s4s2sa1e1h1ino4t0ering5holic7ba1n1re3c1d1enter4o1rn3f0a1d2g1h0anel2nel4rity4se2t2eap3intai5ristmas6ome4urch5i0priani6rcle4sco3tadel4i0c2y3k1l0aims4eaning6ick2nic1que6othing5ud3ub0med6m1n1o0ach3des3ffee4llege4ogne5m0mbank4unity6pany2re3uter5sec4ndos3struction8ulting7tact3ractors9oking4l1p2rsica5untry4pon0s4rses6pa2r0edit0card4union9icket5own3s1uise0s6u0isinella9v1w1x1y0mru3ou3z2dad1nce3ta1e1ing3sun4y2clk3ds2e0al0er2s3gree4livery5l1oitte5ta3mocrat6ntal2ist5si0gn4v2hl2iamonds6et2gital5rect0ory7scount3ver5h2y2j1k1m1np2o0cs1tor4g1mains5t1wnload7rive4tv2ubai3nlop4pont4rban5vag2r2z2earth3t2c0o2deka3u0cation8e1g1mail3erck5nergy4gineer0ing9terprises10pson4quipment8r0icsson6ni3s0q1tate5t1u0rovision8s2vents5xchange6pert3osed4ress5traspace10fage2il1rwinds6th3mily4n0s2rm0ers5shion4t3edex3edback6rrari3ero6i0delity5o2lm2nal1nce1ial7re0stone6mdale6sh0ing5t0ness6j1k1lickr3ghts4r2orist4wers5y2m1o0o0d1tball6rd1ex2sale4um3undation8x2r0ee1senius7l1ogans4ntier7tr2ujitsu5n0d2rniture7tbol5yi3ga0l0lery3o1up4me0s3p1rden4y2b0iz3d0n2e0a1nt0ing5orge5f1g0ee3h1i0ft0s3ves2ing5l0ass3e1obal2o4m0ail3bh2o1x2n1odaddy5ld0point6f2o0dyear5g0le4p1t1v2p1q1r0ainger5phics5tis4een3ipe3ocery4up4s1t1u0cci3ge2ide2tars5ru3w1y2hair2mburg5ngout5us3bo2dfc0bank7ealth0care8lp1sinki6re1mes5iphop4samitsu7tachi5v2k0t2m1n1ockey4ldings5iday5medepot5goods5s0ense7nda3rse3spital5t0ing5t0els3mail5use3w2r1sbc3t1u0ghes5yatt3undai7ibm2cbc2e1u2d1e0ee3fm2kano4l1m0amat4db2mo0bilien9n0c1dustries8finiti5o2g1k1stitute6urance4e4t0ernational10uit4vestments10o1piranga7q1r0ish4s0maili5t0anbul7t0au2v3jaguar4va3cb2e0ep2tzt3welry6io2ll2m0p2nj2o0bs1urg4t1y2p0morgan6rs3uegos4niper7kaufen5ddi3e0rryhotels6properties14fh2g1h1i0a1ds2m1ndle4tchen5wi3m1n1oeln3matsu5sher5p0mg2n2r0d1ed3uokgroup8w1y0oto4z2la0caixa5mborghini8er3nd0rover6xess5salle5t0ino3robe5w0yer5b1c1ds2ease3clerc5frak4gal2o2xus4gbt3i0dl2fe0insurance9style7ghting6ke2lly3mited4o2ncoln4k2ve1ing5k1lc1p2oan0s3cker3us3l1ndon4tte1o3ve3pl0financial11r1s1t0d0a3u0ndbeck6xe1ury5v1y2ma0drid4if1son4keup4n0agement7go3p1rket0ing3s4riott5shalls7ttel5ba2c0kinsey7d1e0d0ia3et2lbourne7me1orial6n0u2rckmsd7g1h1iami3crosoft7l1ni1t2t0subishi9k1l0b1s2m0a2n1o0bi0le4da2e1i1m1nash3ey2ster5rmon3tgage6scow4to0rcycles9v0ie4p1q1r1s0d2t0n1r2u0seum3ic4v1w1x1y1z2na0b1goya4me2vy3ba2c1e0c1t0bank4flix4work5ustar5w0s2xt0direct7us4f0l2g0o2hk2i0co2ke1on3nja3ssan1y5l1o0kia3rton4w0ruz3tv4p1r0a1w2tt2u1yc2z2obi1server7ffice5kinawa6layan0group9lo3m0ega4ne1g1l0ine5oo2pen3racle3nge4g0anic5igins6saka4tsuka4t2vh3pa0ge2nasonic7ris2s1tners4s1y3y2ccw3e0t2f0izer5g1h0armacy6d1ilips5one2to0graphy6s4ysio5ics1tet2ures6d1n0g1k2oneer5zza4k1l0ace2y0station9umbing5s3m1n0c2ohl2ker3litie5rn2st3r0axi3ess3ime3o0d0uctions8f1gressive8mo2perties3y5tection8u0dential9s1t1ub2w0c2y2qa1pon3uebec3st5racing4dio4e0ad1lestate6tor2y4cipes5d0stone5umbrella9hab3ise0n3t2liance6n0t0als5pair3ort3ublican8st0aurant8view0s5xroth6ich0ardli6oh3l1o1p2o0cks3deo3gers4om3s0vp3u0gby3hr2n2w0e2yukyu6sa0arland6fe0ty4kura4le1on3msclub4ung5ndvik0coromant12ofi4p1rl2s1ve2xo3b0i1s2c0b1haeffler7midt4olarships8ol3ule3warz5ience5ot3d1e0arch3t2cure1ity6ek2lect4ner3rvices6ven3w1x0y3fr2g1h0angrila6rp3ell3ia1ksha5oes2p0ping5uji3w3i0lk2na1gles5te3j1k0i0n2y0pe4l0ing4m0art3ile4n0cf3o0ccer3ial4ftbank4ware6hu2lar2utions7ng1y2y2pa0ce3ort2t3r0l2s1t0ada2ples4r1tebank4farm7c0group6ockholm6rage3e3ream4udio2y3yle4u0cks3pplies3y2ort5rf1gery5zuki5v1watch4iss4x1y0dney4stems6z2tab1ipei4lk2obao4rget4tamotors6r2too4x0i3c0i2d0k2eam2ch0nology8l1masek5nnis4va3f1g1h0d1eater2re6iaa2ckets5enda4ps2res2ol4j0maxx4x2k0maxx5l1m0all4n1o0day3kyo3ols3p1ray3shiba5tal3urs3wn2yota3s3r0ade1ing4ining5vel0ers0insurance16ust3v2t1ube2i1nes3shu4v0s2w1z2ua1bank3s2g1k1nicom3versity8o2ol2ps2s1y1z2va0cations7na1guard7c1e0gas3ntures6risign5mgensberater2ung14sicherung10t2g1i0ajes4deo3g1king4llas4n1p1rgin4sa1ion4va1o3laanderen9n1odka3lvo3te1ing3o2yage5u2wales2mart4ter4ng0gou5tch0es6eather0channel12bcam3er2site5d0ding5ibo2r3f1hoswho6ien2ki2lliamhill9n0dows4e1ners6me2olterskluwer11odside6rk0s2ld3w2s1tc1f3xbox3erox4ihuan4n2xx2yz3yachts4hoo3maxun5ndex5e1odobashi7ga2kohama6u0tube6t1un3za0ppos4ra3ero3ip2m1one3uerich6w2",e_="121342632165322333335355455655552435435422463632574574330355524444661154543332344423364211133222221212112052232222232212222223222241112222224322321222",$a="numeric",Da="ascii",ja="alpha",Ir="asciinumeric",xr="alphanumeric",La="domain",jf="emoji",t_="scheme",n_="slashscheme",Fo="whitespace";function r_(n,e){return n in e||(e[n]=[]),e[n]}function wn(n,e,t){e[$a]&&(e[Ir]=!0,e[xr]=!0),e[Da]&&(e[Ir]=!0,e[ja]=!0),e[Ir]&&(e[xr]=!0),e[ja]&&(e[xr]=!0),e[xr]&&(e[La]=!0),e[jf]&&(e[La]=!0);for(const r in e){const s=r_(r,t);s.indexOf(n)<0&&s.push(n)}}function s_(n,e){const t={};for(const r in e)e[r].indexOf(n)>=0&&(t[r]=!0);return t}function Re(n=null){this.j={},this.jr=[],this.jd=null,this.t=n}Re.groups={};Re.prototype={accepts(){return!!this.t},go(n){const e=this,t=e.j[n];if(t)return t;for(let r=0;r<e.jr.length;r++){const s=e.jr[r][0],i=e.jr[r][1];if(i&&s.test(n))return i}return e.jd},has(n,e=!1){return e?n in this.j:!!this.go(n)},ta(n,e,t,r){for(let s=0;s<n.length;s++)this.tt(n[s],e,t,r)},tr(n,e,t,r){r=r||Re.groups;let s;return e&&e.j?s=e:(s=new Re(e),t&&r&&wn(e,t,r)),this.jr.push([n,s]),s},ts(n,e,t,r){let s=this;const i=n.length;if(!i)return s;for(let o=0;o<i-1;o++)s=s.tt(n[o]);return s.tt(n[i-1],e,t,r)},tt(n,e,t,r){r=r||Re.groups;const s=this;if(e&&e.j)return s.j[n]=e,e;const i=e;let o,a=s.go(n);if(a?(o=new Re,Object.assign(o.j,a.j),o.jr.push.apply(o.jr,a.jr),o.jd=a.jd,o.t=a.t):o=new Re,i){if(r)if(o.t&&typeof o.t=="string"){const l=Object.assign(s_(o.t,r),t);wn(i,l,r)}else t&&wn(i,t,r);o.t=i}return s.j[n]=o,o}};const z=(n,e,t,r,s)=>n.ta(e,t,r,s),ie=(n,e,t,r,s)=>n.tr(e,t,r,s),Ru=(n,e,t,r,s)=>n.ts(e,t,r,s),E=(n,e,t,r,s)=>n.tt(e,t,r,s),wt="WORD",Ba="UWORD",Lf="ASCIINUMERICAL",Bf="ALPHANUMERICAL",es="LOCALHOST",za="TLD",Fa="UTLD",Ds="SCHEME",Gn="SLASH_SCHEME",Rl="NUM",Ua="WS",Pl="NL",Nr="OPENBRACE",Rr="CLOSEBRACE",oi="OPENBRACKET",ai="CLOSEBRACKET",li="OPENPAREN",ci="CLOSEPAREN",ui="OPENANGLEBRACKET",di="CLOSEANGLEBRACKET",hi="FULLWIDTHLEFTPAREN",fi="FULLWIDTHRIGHTPAREN",pi="LEFTCORNERBRACKET",mi="RIGHTCORNERBRACKET",gi="LEFTWHITECORNERBRACKET",yi="RIGHTWHITECORNERBRACKET",bi="FULLWIDTHLESSTHAN",wi="FULLWIDTHGREATERTHAN",vi="AMPERSAND",ki="APOSTROPHE",Si="ASTERISK",Lt="AT",_i="BACKSLASH",xi="BACKTICK",Ti="CARET",Ht="COLON",$l="COMMA",Ei="DOLLAR",ot="DOT",Ci="EQUALS",Dl="EXCLAMATION",He="HYPHEN",Pr="PERCENT",Ai="PIPE",Oi="PLUS",Mi="POUND",$r="QUERY",jl="QUOTE",zf="FULLWIDTHMIDDLEDOT",Ll="SEMI",at="SLASH",Dr="TILDE",Ii="UNDERSCORE",Ff="EMOJI",Ni="SYM";var Uf=Object.freeze({__proto__:null,ALPHANUMERICAL:Bf,AMPERSAND:vi,APOSTROPHE:ki,ASCIINUMERICAL:Lf,ASTERISK:Si,AT:Lt,BACKSLASH:_i,BACKTICK:xi,CARET:Ti,CLOSEANGLEBRACKET:di,CLOSEBRACE:Rr,CLOSEBRACKET:ai,CLOSEPAREN:ci,COLON:Ht,COMMA:$l,DOLLAR:Ei,DOT:ot,EMOJI:Ff,EQUALS:Ci,EXCLAMATION:Dl,FULLWIDTHGREATERTHAN:wi,FULLWIDTHLEFTPAREN:hi,FULLWIDTHLESSTHAN:bi,FULLWIDTHMIDDLEDOT:zf,FULLWIDTHRIGHTPAREN:fi,HYPHEN:He,LEFTCORNERBRACKET:pi,LEFTWHITECORNERBRACKET:gi,LOCALHOST:es,NL:Pl,NUM:Rl,OPENANGLEBRACKET:ui,OPENBRACE:Nr,OPENBRACKET:oi,OPENPAREN:li,PERCENT:Pr,PIPE:Ai,PLUS:Oi,POUND:Mi,QUERY:$r,QUOTE:jl,RIGHTCORNERBRACKET:mi,RIGHTWHITECORNERBRACKET:yi,SCHEME:Ds,SEMI:Ll,SLASH:at,SLASH_SCHEME:Gn,SYM:Ni,TILDE:Dr,TLD:za,UNDERSCORE:Ii,UTLD:Fa,UWORD:Ba,WORD:wt,WS:Ua});const yt=/[a-z]/,wr=new RegExp("\\p{L}","u"),Uo=new RegExp("\\p{Emoji}","u"),bt=/\d/,Ho=/\s/,Pu="\r",Vo=`
`,i_="",o_="",qo="";let Cs=null,As=null;function a_(n=[]){const e={};Re.groups=e;const t=new Re;Cs==null&&(Cs=$u(ZS)),As==null&&(As=$u(e_)),E(t,"'",ki),E(t,"{",Nr),E(t,"}",Rr),E(t,"[",oi),E(t,"]",ai),E(t,"(",li),E(t,")",ci),E(t,"<",ui),E(t,">",di),E(t,"",hi),E(t,"",fi),E(t,"",pi),E(t,"",mi),E(t,"",gi),E(t,"",yi),E(t,"",bi),E(t,"",wi),E(t,"&",vi),E(t,"*",Si),E(t,"@",Lt),E(t,"`",xi),E(t,"^",Ti),E(t,":",Ht),E(t,",",$l),E(t,"$",Ei),E(t,".",ot),E(t,"=",Ci),E(t,"!",Dl),E(t,"-",He),E(t,"%",Pr),E(t,"|",Ai),E(t,"+",Oi),E(t,"#",Mi),E(t,"?",$r),E(t,'"',jl),E(t,"/",at),E(t,";",Ll),E(t,"~",Dr),E(t,"_",Ii),E(t,"\\",_i),E(t,"",zf);const r=ie(t,bt,Rl,{[$a]:!0});ie(r,bt,r);const s=ie(r,yt,Lf,{[Ir]:!0}),i=ie(r,wr,Bf,{[xr]:!0}),o=ie(t,yt,wt,{[Da]:!0});ie(o,bt,s),ie(o,yt,o),ie(s,bt,s),ie(s,yt,s);const a=ie(t,wr,Ba,{[ja]:!0});ie(a,yt),ie(a,bt,i),ie(a,wr,a),ie(i,bt,i),ie(i,yt),ie(i,wr,i);const l=E(t,Vo,Pl,{[Fo]:!0}),c=E(t,Pu,Ua,{[Fo]:!0}),u=ie(t,Ho,Ua,{[Fo]:!0});E(t,qo,u),E(c,Vo,l),E(c,qo,u),ie(c,Ho,u),E(u,Pu),E(u,Vo),ie(u,Ho,u),E(u,qo,u);const d=ie(t,Uo,Ff,{[jf]:!0});E(d,"#"),ie(d,Uo,d),E(d,i_,d);const h=E(d,o_);E(h,"#"),ie(h,Uo,d);const f=[[yt,o],[bt,s]],m=[[yt,null],[wr,a],[bt,i]];for(let g=0;g<Cs.length;g++)Pt(t,Cs[g],za,wt,f);for(let g=0;g<As.length;g++)Pt(t,As[g],Fa,Ba,m);wn(za,{tld:!0,ascii:!0},e),wn(Fa,{utld:!0,alpha:!0},e),Pt(t,"file",Ds,wt,f),Pt(t,"mailto",Ds,wt,f),Pt(t,"http",Gn,wt,f),Pt(t,"https",Gn,wt,f),Pt(t,"ftp",Gn,wt,f),Pt(t,"ftps",Gn,wt,f),wn(Ds,{scheme:!0,ascii:!0},e),wn(Gn,{slashscheme:!0,ascii:!0},e),n=n.sort((g,y)=>g[0]>y[0]?1:-1);for(let g=0;g<n.length;g++){const y=n[g][0],v=n[g][1]?{[t_]:!0}:{[n_]:!0};y.indexOf("-")>=0?v[La]=!0:yt.test(y)?bt.test(y)?v[Ir]=!0:v[Da]=!0:v[$a]=!0,Ru(t,y,y,v)}return Ru(t,"localhost",es,{ascii:!0}),t.jd=new Re(Ni),{start:t,tokens:Object.assign({groups:e},Uf)}}function Hf(n,e){const t=l_(e.replace(/[A-Z]/g,a=>a.toLowerCase())),r=t.length,s=[];let i=0,o=0;for(;o<r;){let a=n,l=null,c=0,u=null,d=-1,h=-1;for(;o<r&&(l=a.go(t[o]));)a=l,a.accepts()?(d=0,h=0,u=a):d>=0&&(d+=t[o].length,h++),c+=t[o].length,i+=t[o].length,o++;i-=d,o-=h,c-=d,s.push({t:u.t,v:e.slice(i-c,i),s:i-c,e:i})}return s}function l_(n){const e=[],t=n.length;let r=0;for(;r<t;){let s=n.charCodeAt(r),i,o=s<55296||s>56319||r+1===t||(i=n.charCodeAt(r+1))<56320||i>57343?n[r]:n.slice(r,r+2);e.push(o),r+=o.length}return e}function Pt(n,e,t,r,s){let i;const o=e.length;for(let a=0;a<o-1;a++){const l=e[a];n.j[l]?i=n.j[l]:(i=new Re(r),i.jr=s.slice(),n.j[l]=i),n=i}return i=new Re(t),i.jr=s.slice(),n.j[e[o-1]]=i,i}function $u(n){const e=[],t=[];let r=0,s="0123456789";for(;r<n.length;){let i=0;for(;s.indexOf(n[r+i])>=0;)i++;if(i>0){e.push(t.join(""));for(let o=parseInt(n.substring(r,r+i),10);o>0;o--)t.pop();r+=i}else t.push(n[r]),r++}return e}const ts={defaultProtocol:"http",events:null,format:Du,formatHref:Du,nl2br:!1,tagName:"a",target:null,rel:null,validate:!0,truncate:1/0,className:null,attributes:null,ignoreTags:[],render:null};function Bl(n,e=null){let t=Object.assign({},ts);n&&(t=Object.assign(t,n instanceof Bl?n.o:n));const r=t.ignoreTags,s=[];for(let i=0;i<r.length;i++)s.push(r[i].toUpperCase());this.o=t,e&&(this.defaultRender=e),this.ignoreTags=s}Bl.prototype={o:ts,ignoreTags:[],defaultRender(n){return n},check(n){return this.get("validate",n.toString(),n)},get(n,e,t){const r=e!=null;let s=this.o[n];return s&&(typeof s=="object"?(s=t.t in s?s[t.t]:ts[n],typeof s=="function"&&r&&(s=s(e,t))):typeof s=="function"&&r&&(s=s(e,t.t,t)),s)},getObj(n,e,t){let r=this.o[n];return typeof r=="function"&&e!=null&&(r=r(e,t.t,t)),r},render(n){const e=n.render(this);return(this.get("render",null,n)||this.defaultRender)(e,n.t,n)}};function Du(n){return n}function Vf(n,e){this.t="token",this.v=n,this.tk=e}Vf.prototype={isLink:!1,toString(){return this.v},toHref(n){return this.toString()},toFormattedString(n){const e=this.toString(),t=n.get("truncate",e,this),r=n.get("format",e,this);return t&&r.length>t?r.substring(0,t)+"":r},toFormattedHref(n){return n.get("formatHref",this.toHref(n.get("defaultProtocol")),this)},startIndex(){return this.tk[0].s},endIndex(){return this.tk[this.tk.length-1].e},toObject(n=ts.defaultProtocol){return{type:this.t,value:this.toString(),isLink:this.isLink,href:this.toHref(n),start:this.startIndex(),end:this.endIndex()}},toFormattedObject(n){return{type:this.t,value:this.toFormattedString(n),isLink:this.isLink,href:this.toFormattedHref(n),start:this.startIndex(),end:this.endIndex()}},validate(n){return n.get("validate",this.toString(),this)},render(n){const e=this,t=this.toHref(n.get("defaultProtocol")),r=n.get("formatHref",t,this),s=n.get("tagName",t,e),i=this.toFormattedString(n),o={},a=n.get("className",t,e),l=n.get("target",t,e),c=n.get("rel",t,e),u=n.getObj("attributes",t,e),d=n.getObj("events",t,e);return o.href=r,a&&(o.class=a),l&&(o.target=l),c&&(o.rel=c),u&&Object.assign(o,u),{tagName:s,attributes:o,content:i,eventListeners:d}}};function ao(n,e){class t extends Vf{constructor(s,i){super(s,i),this.t=n}}for(const r in e)t.prototype[r]=e[r];return t.t=n,t}const ju=ao("email",{isLink:!0,toHref(){return"mailto:"+this.toString()}}),Lu=ao("text"),c_=ao("nl"),Os=ao("url",{isLink:!0,toHref(n=ts.defaultProtocol){return this.hasProtocol()?this.v:`${n}://${this.v}`},hasProtocol(){const n=this.tk;return n.length>=2&&n[0].t!==es&&n[1].t===Ht}}),Ue=n=>new Re(n);function u_({groups:n}){const e=n.domain.concat([vi,Si,Lt,_i,xi,Ti,Ei,Ci,He,Rl,Pr,Ai,Oi,Mi,at,Ni,Dr,Ii]),t=[ki,Ht,$l,ot,Dl,Pr,$r,jl,Ll,ui,di,Nr,Rr,ai,oi,li,ci,hi,fi,pi,mi,gi,yi,bi,wi],r=[vi,ki,Si,_i,xi,Ti,Ei,Ci,He,Nr,Rr,Pr,Ai,Oi,Mi,$r,at,Ni,Dr,Ii],s=Ue(),i=E(s,Dr);z(i,r,i),z(i,n.domain,i);const o=Ue(),a=Ue(),l=Ue();z(s,n.domain,o),z(s,n.scheme,a),z(s,n.slashscheme,l),z(o,r,i),z(o,n.domain,o);const c=E(o,Lt);E(i,Lt,c),E(a,Lt,c),E(l,Lt,c);const u=E(i,ot);z(u,r,i),z(u,n.domain,i);const d=Ue();z(c,n.domain,d),z(d,n.domain,d);const h=E(d,ot);z(h,n.domain,d);const f=Ue(ju);z(h,n.tld,f),z(h,n.utld,f),E(c,es,f);const m=E(d,He);E(m,He,m),z(m,n.domain,d),z(f,n.domain,d),E(f,ot,h),E(f,He,m);const g=E(f,Ht);z(g,n.numeric,ju);const y=E(o,He),b=E(o,ot);E(y,He,y),z(y,n.domain,o),z(b,r,i),z(b,n.domain,o);const v=Ue(Os);z(b,n.tld,v),z(b,n.utld,v),z(v,n.domain,o),z(v,r,i),E(v,ot,b),E(v,He,y),E(v,Lt,c);const w=E(v,Ht),k=Ue(Os);z(w,n.numeric,k);const T=Ue(Os),S=Ue();z(T,e,T),z(T,t,S),z(S,e,T),z(S,t,S),E(v,at,T),E(k,at,T);const x=E(a,Ht),C=E(l,Ht),R=E(C,at),X=E(R,at);z(a,n.domain,o),E(a,ot,b),E(a,He,y),z(l,n.domain,o),E(l,ot,b),E(l,He,y),z(x,n.domain,T),E(x,at,T),E(x,$r,T),z(X,n.domain,T),z(X,e,T),E(X,at,T);const I=[[Nr,Rr],[oi,ai],[li,ci],[ui,di],[hi,fi],[pi,mi],[gi,yi],[bi,wi]];for(let H=0;H<I.length;H++){const[pe,te]=I[H],Z=E(T,pe);E(S,pe,Z),E(Z,te,T);const Ge=Ue(Os);z(Z,e,Ge);const st=Ue();z(Z,t),z(Ge,e,Ge),z(Ge,t,st),z(st,e,Ge),z(st,t,st),E(Ge,te,T),E(st,te,T)}return E(s,es,v),E(s,Pl,c_),{start:s,tokens:Uf}}function d_(n,e,t){let r=t.length,s=0,i=[],o=[];for(;s<r;){let a=n,l=null,c=null,u=0,d=null,h=-1;for(;s<r&&!(l=a.go(t[s].t));)o.push(t[s++]);for(;s<r&&(c=l||a.go(t[s].t));)l=null,a=c,a.accepts()?(h=0,d=a):h>=0&&h++,s++,u++;if(h<0)s-=u,s<r&&(o.push(t[s]),s++);else{o.length>0&&(i.push(Wo(Lu,e,o)),o=[]),s-=h,u-=h;const f=d.t,m=t.slice(s-u,s);i.push(Wo(f,e,m))}}return o.length>0&&i.push(Wo(Lu,e,o)),i}function Wo(n,e,t){const r=t[0].s,s=t[t.length-1].e,i=e.slice(r,s);return new n(i,t)}const h_=typeof console<"u"&&console&&console.warn||(()=>{}),f_="until manual call of linkify.init(). Register all schemes and plugins before invoking linkify the first time.",ee={scanner:null,parser:null,tokenQueue:[],pluginQueue:[],customSchemes:[],initialized:!1};function p_(){return Re.groups={},ee.scanner=null,ee.parser=null,ee.tokenQueue=[],ee.pluginQueue=[],ee.customSchemes=[],ee.initialized=!1,ee}function Bu(n,e=!1){if(ee.initialized&&h_(`linkifyjs: already initialized - will not register custom scheme "${n}" ${f_}`),!/^[0-9a-z]+(-[0-9a-z]+)*$/.test(n))throw new Error(`linkifyjs: incorrect scheme format.
1. Must only contain digits, lowercase ASCII letters or "-"
2. Cannot start or end with "-"
3. "-" cannot repeat`);ee.customSchemes.push([n,e])}function m_(){ee.scanner=a_(ee.customSchemes);for(let n=0;n<ee.tokenQueue.length;n++)ee.tokenQueue[n][1]({scanner:ee.scanner});ee.parser=u_(ee.scanner.tokens);for(let n=0;n<ee.pluginQueue.length;n++)ee.pluginQueue[n][1]({scanner:ee.scanner,parser:ee.parser});return ee.initialized=!0,ee}function zl(n){return ee.initialized||m_(),d_(ee.parser.start,n,Hf(ee.scanner.start,n))}zl.scan=Hf;function qf(n,e=null,t=null){if(e&&typeof e=="object"){if(t)throw Error(`linkifyjs: Invalid link type ${e}; must be a string`);t=e,e=null}const r=new Bl(t),s=zl(n),i=[];for(let o=0;o<s.length;o++){const a=s[o];a.isLink&&(!e||a.t===e)&&r.check(a)&&i.push(a.toFormattedObject(r))}return i}var Fl="[\0- -\u2029]",g_=new RegExp(Fl),y_=new RegExp(`${Fl}$`),b_=new RegExp(Fl,"g");function w_(n){return n.length===1?n[0].isLink:n.length===3&&n[1].isLink?["()","[]"].includes(n[0].value+n[2].value):!1}function v_(n){return new se({key:new ge("autolink"),appendTransaction:(e,t,r)=>{const s=e.some(c=>c.docChanged)&&!t.doc.eq(r.doc),i=e.some(c=>c.getMeta("preventAutolink"));if(!s||i)return;const{tr:o}=r,a=df(t.doc,[...e]);if(bf(a).forEach(({newRange:c})=>{const u=_k(r.doc,c,f=>f.isTextblock);let d,h;if(u.length>1)d=u[0],h=r.doc.textBetween(d.pos,d.pos+d.node.nodeSize,void 0," ");else if(u.length){const f=r.doc.textBetween(c.from,c.to," "," ");if(!y_.test(f))return;d=u[0],h=r.doc.textBetween(d.pos,c.to,void 0," ")}if(d&&h){const f=h.split(g_).filter(Boolean);if(f.length<=0)return!1;const m=f[f.length-1],g=d.pos+h.lastIndexOf(m);if(!m)return!1;const y=zl(m).map(b=>b.toObject(n.defaultProtocol));if(!w_(y))return!1;y.filter(b=>b.isLink).map(b=>({...b,from:g+b.start+1,to:g+b.end+1})).filter(b=>r.schema.marks.code?!r.doc.rangeHasMark(b.from,b.to,r.schema.marks.code):!0).filter(b=>n.validate(b.value)).filter(b=>n.shouldAutoLink(b.value)).forEach(b=>{Al(b.from,b.to,r.doc).some(v=>v.mark.type===n.type)||o.addMark(b.from,b.to,n.type.create({href:b.href}))})}}),!!o.steps.length)return o}})}function k_(n){return new se({key:new ge("handleClickLink"),props:{handleClick:(e,t,r)=>{var s,i;if(r.button!==0||!e.editable)return!1;let o=!1;if(n.enableClickSelection&&(o=n.editor.commands.extendMarkRange(n.type.name)),n.openOnClick){let a=null;if(r.target instanceof HTMLAnchorElement)a=r.target;else{let d=r.target;const h=[];for(;d.nodeName!=="DIV";)h.push(d),d=d.parentNode;a=h.find(f=>f.nodeName==="A")}if(!a)return o;const l=yf(e.state,n.type.name),c=(s=a?.href)!=null?s:l.href,u=(i=a?.target)!=null?i:l.target;a&&c&&(window.open(c,u),o=!0)}return o}}})}function S_(n){return new se({key:new ge("handlePasteLink"),props:{handlePaste:(e,t,r)=>{const{shouldAutoLink:s}=n,{state:i}=e,{selection:o}=i,{empty:a}=o;if(a)return!1;let l="";r.content.forEach(u=>{l+=u.textContent});const c=qf(l,{defaultProtocol:n.defaultProtocol}).find(u=>u.isLink&&u.value===l);return!l||!c||s!==void 0&&!s(c.value)?!1:n.editor.commands.setMark(n.type,{href:c.href})}}})}function ln(n,e){const t=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(r=>{const s=typeof r=="string"?r:r.scheme;s&&t.push(s)}),!n||n.replace(b_,"").match(new RegExp(`^(?:(?:${t.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var __=It.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate,console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")),this.options.protocols.forEach(n=>{if(typeof n=="string"){Bu(n);return}Bu(n.scheme,n.optionalSlashes)})},onDestroy(){p_()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,enableClickSelection:!1,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(n,e)=>!!ln(n,e.protocols),validate:n=>!!n,shouldAutoLink:n=>{const e=/^[a-z][a-z0-9+.-]*:\/\//i.test(n),t=/^[a-z][a-z0-9+.-]*:/i.test(n);if(e||t&&!n.includes("@"))return!0;const s=(n.includes("@")?n.split("@").pop():n).split(/[/?#:]/)[0];return!(/^\d{1,3}(\.\d{1,3}){3}$/.test(s)||!/\./.test(s))}}},addAttributes(){return{href:{default:null,parseHTML(n){return n.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:n=>{const e=n.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:t=>!!ln(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:n}){return this.options.isAllowedUri(n.href,{defaultValidate:e=>!!ln(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",le(this.options.HTMLAttributes,n),0]:["a",le(this.options.HTMLAttributes,{...n,href:""}),0]},markdownTokenName:"link",parseMarkdown:(n,e)=>e.applyMark("link",e.parseInline(n.tokens||[]),{href:n.href,title:n.title||null}),renderMarkdown:(n,e)=>{var t;const r=((t=n.attrs)==null?void 0:t.href)||"";return`[${e.renderChildren(n)}](${r})`},addCommands(){return{setLink:n=>({chain:e})=>{const{href:t}=n;return this.options.isAllowedUri(t,{defaultValidate:r=>!!ln(r,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,n).setMeta("preventAutolink",!0).run():!1},toggleLink:n=>({chain:e})=>{const{href:t}=n||{};return t&&!this.options.isAllowedUri(t,{defaultValidate:r=>!!ln(r,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:e().toggleMark(this.name,n,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()},unsetLink:()=>({chain:n})=>n().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[en({find:n=>{const e=[];if(n){const{protocols:t,defaultProtocol:r}=this.options,s=qf(n).filter(i=>i.isLink&&this.options.isAllowedUri(i.value,{defaultValidate:o=>!!ln(o,t),protocols:t,defaultProtocol:r}));s.length&&s.forEach(i=>{this.options.shouldAutoLink(i.value)&&e.push({text:i.value,data:{href:i.href},index:i.start})})}return e},type:this.type,getAttributes:n=>{var e;return{href:(e=n.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const n=[],{protocols:e,defaultProtocol:t}=this.options;return this.options.autolink&&n.push(v_({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:r=>this.options.isAllowedUri(r,{defaultValidate:s=>!!ln(s,e),protocols:e,defaultProtocol:t}),shouldAutoLink:this.options.shouldAutoLink})),n.push(k_({type:this.type,editor:this.editor,openOnClick:this.options.openOnClick==="whenNotEditable"?!0:this.options.openOnClick,enableClickSelection:this.options.enableClickSelection})),this.options.linkOnPaste&&n.push(S_({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type,shouldAutoLink:this.options.shouldAutoLink})),n}}),x_=Object.defineProperty,T_=(n,e)=>{for(var t in e)x_(n,t,{get:e[t],enumerable:!0})},E_="listItem",zu="textStyle",Fu=/^\s*([-+*])\s$/,Wf=Fe.create({name:"bulletList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:"ul"}]},renderHTML({HTMLAttributes:n}){return["ul",le(this.options.HTMLAttributes,n),0]},markdownTokenName:"list",parseMarkdown:(n,e)=>n.type!=="list"||n.ordered?[]:{type:"bulletList",content:n.items?e.parseChildren(n.items):[]},renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`
`):"",markdownOptions:{indentsContent:!0},addCommands(){return{toggleBulletList:()=>({commands:n,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(E_,this.editor.getAttributes(zu)).run():n.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-8":()=>this.editor.commands.toggleBulletList()}},addInputRules(){let n=ur({find:Fu,type:this.type});return(this.options.keepMarks||this.options.keepAttributes)&&(n=ur({find:Fu,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:()=>this.editor.getAttributes(zu),editor:this.editor})),[n]}}),Kf=Fe.create({name:"listItem",addOptions(){return{HTMLAttributes:{},bulletListTypeName:"bulletList",orderedListTypeName:"orderedList"}},content:"paragraph block*",defining:!0,parseHTML(){return[{tag:"li"}]},renderHTML({HTMLAttributes:n}){return["li",le(this.options.HTMLAttributes,n),0]},markdownTokenName:"list_item",parseMarkdown:(n,e)=>{if(n.type!=="list_item")return[];let t=[];if(n.tokens&&n.tokens.length>0)if(n.tokens.some(s=>s.type==="paragraph"))t=e.parseChildren(n.tokens);else{const s=n.tokens[0];if(s&&s.type==="text"&&s.tokens&&s.tokens.length>0){if(t=[{type:"paragraph",content:e.parseInline(s.tokens)}],n.tokens.length>1){const o=n.tokens.slice(1),a=e.parseChildren(o);t.push(...a)}}else t=e.parseChildren(n.tokens)}return t.length===0&&(t=[{type:"paragraph",content:[]}]),{type:"listItem",content:t}},renderMarkdown:(n,e,t)=>Nl(n,e,r=>r.parentType==="bulletList"?"- ":r.parentType==="orderedList"?`${r.index+1}. `:"- ",t),addKeyboardShortcuts(){return{Enter:()=>this.editor.commands.splitListItem(this.name),Tab:()=>this.editor.commands.sinkListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)}}}),C_={};T_(C_,{findListItemPos:()=>ds,getNextListDepth:()=>Ul,handleBackspace:()=>Ha,handleDelete:()=>Va,hasListBefore:()=>Jf,hasListItemAfter:()=>A_,hasListItemBefore:()=>Gf,listItemHasSubList:()=>Yf,nextListIsDeeper:()=>Xf,nextListIsHigher:()=>Qf});var ds=(n,e)=>{const{$from:t}=e.selection,r=he(n,e.schema);let s=null,i=t.depth,o=t.pos,a=null;for(;i>0&&a===null;)s=t.node(i),s.type===r?a=i:(i-=1,o-=1);return a===null?null:{$pos:e.doc.resolve(o),depth:a}},Ul=(n,e)=>{const t=ds(n,e);if(!t)return!1;const[,r]=Rk(e,n,t.$pos.pos+4);return r},Jf=(n,e,t)=>{const{$anchor:r}=n.selection,s=Math.max(0,r.pos-2),i=n.doc.resolve(s).node();return!(!i||!t.includes(i.type.name))},Gf=(n,e)=>{var t;const{$anchor:r}=e.selection,s=e.doc.resolve(r.pos-2);return!(s.index()===0||((t=s.nodeBefore)==null?void 0:t.type.name)!==n)},Yf=(n,e,t)=>{if(!t)return!1;const r=he(n,e.schema);let s=!1;return t.descendants(i=>{i.type===r&&(s=!0)}),s},Ha=(n,e,t)=>{if(n.commands.undoInputRule())return!0;if(n.state.selection.from!==n.state.selection.to)return!1;if(!Zt(n.state,e)&&Jf(n.state,e,t)){const{$anchor:a}=n.state.selection,l=n.state.doc.resolve(a.before()-1),c=[];l.node().descendants((h,f)=>{h.type.name===e&&c.push({node:h,pos:f})});const u=c.at(-1);if(!u)return!1;const d=n.state.doc.resolve(l.start()+u.pos+1);return n.chain().cut({from:a.start()-1,to:a.end()+1},d.end()).joinForward().run()}if(!Zt(n.state,e)||!jk(n.state))return!1;const r=ds(e,n.state);if(!r)return!1;const i=n.state.doc.resolve(r.$pos.pos-2).node(r.depth),o=Yf(e,n.state,i);return Gf(e,n.state)&&!o?n.commands.joinItemBackward():n.chain().liftListItem(e).run()},Xf=(n,e)=>{const t=Ul(n,e),r=ds(n,e);return!r||!t?!1:t>r.depth},Qf=(n,e)=>{const t=Ul(n,e),r=ds(n,e);return!r||!t?!1:t<r.depth},Va=(n,e)=>{if(!Zt(n.state,e)||!Dk(n.state,e))return!1;const{selection:t}=n.state,{$from:r,$to:s}=t;return!t.empty&&r.sameParent(s)?!1:Xf(e,n.state)?n.chain().focus(n.state.selection.from+4).lift(e).joinBackward().run():Qf(e,n.state)?n.chain().joinForward().joinBackward().run():n.commands.joinItemForward()},A_=(n,e)=>{var t;const{$anchor:r}=e.selection,s=e.doc.resolve(r.pos-r.parentOffset-2);return!(s.index()===s.parent.childCount-1||((t=s.nodeAfter)==null?void 0:t.type.name)!==n)},Zf=K.create({name:"listKeymap",addOptions(){return{listTypes:[{itemName:"listItem",wrapperNames:["bulletList","orderedList"]},{itemName:"taskItem",wrapperNames:["taskList"]}]}},addKeyboardShortcuts(){return{Delete:({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t})=>{n.state.schema.nodes[t]!==void 0&&Va(n,t)&&(e=!0)}),e},"Mod-Delete":({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t})=>{n.state.schema.nodes[t]!==void 0&&Va(n,t)&&(e=!0)}),e},Backspace:({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t,wrapperNames:r})=>{n.state.schema.nodes[t]!==void 0&&Ha(n,t,r)&&(e=!0)}),e},"Mod-Backspace":({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t,wrapperNames:r})=>{n.state.schema.nodes[t]!==void 0&&Ha(n,t,r)&&(e=!0)}),e}}}}),Uu=/^(\s*)(\d+)\.\s+(.*)$/,O_=/^\s/;function M_(n){const e=[];let t=0,r=0;for(;t<n.length;){const s=n[t],i=s.match(Uu);if(!i)break;const[,o,a,l]=i,c=o.length;let u=l,d=t+1;const h=[s];for(;d<n.length;){const f=n[d];if(f.match(Uu))break;if(f.trim()==="")h.push(f),u+=`
`,d+=1;else if(f.match(O_))h.push(f),u+=`
${f.slice(c+2)}`,d+=1;else break}e.push({indent:c,number:parseInt(a,10),content:u.trim(),raw:h.join(`
`)}),r=d,t=d}return[e,r]}function ep(n,e,t){var r;const s=[];let i=0;for(;i<n.length;){const o=n[i];if(o.indent===e){const a=o.content.split(`
`),l=((r=a[0])==null?void 0:r.trim())||"",c=[];l&&c.push({type:"paragraph",raw:l,tokens:t.inlineTokens(l)});const u=a.slice(1).join(`
`).trim();if(u){const f=t.blockTokens(u);c.push(...f)}let d=i+1;const h=[];for(;d<n.length&&n[d].indent>e;)h.push(n[d]),d+=1;if(h.length>0){const f=Math.min(...h.map(g=>g.indent)),m=ep(h,f,t);c.push({type:"list",ordered:!0,start:h[0].number,items:m,raw:h.map(g=>g.raw).join(`
`)})}s.push({type:"list_item",raw:o.raw,tokens:c}),i=d}else i+=1}return s}function I_(n,e){return n.map(t=>{if(t.type!=="list_item")return e.parseChildren([t])[0];const r=[];return t.tokens&&t.tokens.length>0&&t.tokens.forEach(s=>{if(s.type==="paragraph"||s.type==="list"||s.type==="blockquote"||s.type==="code")r.push(...e.parseChildren([s]));else if(s.type==="text"&&s.tokens){const i=e.parseChildren([s]);r.push({type:"paragraph",content:i})}else{const i=e.parseChildren([s]);i.length>0&&r.push(...i)}}),{type:"listItem",content:r}})}var N_="listItem",Hu="textStyle",Vu=/^(\d+)\.\s$/,tp=Fe.create({name:"orderedList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},addAttributes(){return{start:{default:1,parseHTML:n=>n.hasAttribute("start")?parseInt(n.getAttribute("start")||"",10):1},type:{default:null,parseHTML:n=>n.getAttribute("type")}}},parseHTML(){return[{tag:"ol"}]},renderHTML({HTMLAttributes:n}){const{start:e,...t}=n;return e===1?["ol",le(this.options.HTMLAttributes,t),0]:["ol",le(this.options.HTMLAttributes,n),0]},markdownTokenName:"list",parseMarkdown:(n,e)=>{if(n.type!=="list"||!n.ordered)return[];const t=n.start||1,r=n.items?I_(n.items,e):[];return t!==1?{type:"orderedList",attrs:{start:t},content:r}:{type:"orderedList",content:r}},renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`
`):"",markdownTokenizer:{name:"orderedList",level:"block",start:n=>{const e=n.match(/^(\s*)(\d+)\.\s+/),t=e?.index;return t!==void 0?t:-1},tokenize:(n,e,t)=>{var r;const s=n.split(`
`),[i,o]=M_(s);if(i.length===0)return;const a=ep(i,0,t);return a.length===0?void 0:{type:"list",ordered:!0,start:((r=i[0])==null?void 0:r.number)||1,items:a,raw:s.slice(0,o).join(`
`)}}},markdownOptions:{indentsContent:!0},addCommands(){return{toggleOrderedList:()=>({commands:n,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(N_,this.editor.getAttributes(Hu)).run():n.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-7":()=>this.editor.commands.toggleOrderedList()}},addInputRules(){let n=ur({find:Vu,type:this.type,getAttributes:e=>({start:+e[1]}),joinPredicate:(e,t)=>t.childCount+t.attrs.start===+e[1]});return(this.options.keepMarks||this.options.keepAttributes)&&(n=ur({find:Vu,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:e=>({start:+e[1],...this.editor.getAttributes(Hu)}),joinPredicate:(e,t)=>t.childCount+t.attrs.start===+e[1],editor:this.editor})),[n]}}),R_=/^\s*(\[([( |x])?\])\s$/,P_=Fe.create({name:"taskItem",addOptions(){return{nested:!1,HTMLAttributes:{},taskListTypeName:"taskList",a11y:void 0}},content(){return this.options.nested?"paragraph block*":"paragraph+"},defining:!0,addAttributes(){return{checked:{default:!1,keepOnSplit:!1,parseHTML:n=>{const e=n.getAttribute("data-checked");return e===""||e==="true"},renderHTML:n=>({"data-checked":n.checked})}}},parseHTML(){return[{tag:`li[data-type="${this.name}"]`,priority:51}]},renderHTML({node:n,HTMLAttributes:e}){return["li",le(this.options.HTMLAttributes,e,{"data-type":this.name}),["label",["input",{type:"checkbox",checked:n.attrs.checked?"checked":null}],["span"]],["div",0]]},parseMarkdown:(n,e)=>{const t=[];if(n.tokens&&n.tokens.length>0?t.push(e.createNode("paragraph",{},e.parseInline(n.tokens))):n.text?t.push(e.createNode("paragraph",{},[e.createNode("text",{text:n.text})])):t.push(e.createNode("paragraph",{},[])),n.nestedTokens&&n.nestedTokens.length>0){const r=e.parseChildren(n.nestedTokens);t.push(...r)}return e.createNode("taskItem",{checked:n.checked||!1},t)},renderMarkdown:(n,e)=>{var t;const s=`- [${(t=n.attrs)!=null&&t.checked?"x":" "}] `;return Nl(n,e,s)},addKeyboardShortcuts(){const n={Enter:()=>this.editor.commands.splitListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)};return this.options.nested?{...n,Tab:()=>this.editor.commands.sinkListItem(this.name)}:n},addNodeView(){return({node:n,HTMLAttributes:e,getPos:t,editor:r})=>{const s=document.createElement("li"),i=document.createElement("label"),o=document.createElement("span"),a=document.createElement("input"),l=document.createElement("div"),c=d=>{var h,f;a.ariaLabel=((f=(h=this.options.a11y)==null?void 0:h.checkboxLabel)==null?void 0:f.call(h,d,a.checked))||`Task item checkbox for ${d.textContent||"empty task item"}`};c(n),i.contentEditable="false",a.type="checkbox",a.addEventListener("mousedown",d=>d.preventDefault()),a.addEventListener("change",d=>{if(!r.isEditable&&!this.options.onReadOnlyChecked){a.checked=!a.checked;return}const{checked:h}=d.target;r.isEditable&&typeof t=="function"&&r.chain().focus(void 0,{scrollIntoView:!1}).command(({tr:f})=>{const m=t();if(typeof m!="number")return!1;const g=f.doc.nodeAt(m);return f.setNodeMarkup(m,void 0,{...g?.attrs,checked:h}),!0}).run(),!r.isEditable&&this.options.onReadOnlyChecked&&(this.options.onReadOnlyChecked(n,h)||(a.checked=!a.checked))}),Object.entries(this.options.HTMLAttributes).forEach(([d,h])=>{s.setAttribute(d,h)}),s.dataset.checked=n.attrs.checked,a.checked=n.attrs.checked,i.append(a,o),s.append(i,l),Object.entries(e).forEach(([d,h])=>{s.setAttribute(d,h)});let u=new Set(Object.keys(e));return{dom:s,contentDOM:l,update:d=>{if(d.type!==this.type)return!1;s.dataset.checked=d.attrs.checked,a.checked=d.attrs.checked,c(d);const h=r.extensionManager.attributes,f=Zr(d,h),m=new Set(Object.keys(f)),g=this.options.HTMLAttributes;return u.forEach(y=>{m.has(y)||(y in g?s.setAttribute(y,g[y]):s.removeAttribute(y))}),Object.entries(f).forEach(([y,b])=>{b==null?y in g?s.setAttribute(y,g[y]):s.removeAttribute(y):s.setAttribute(y,b)}),u=m,!0}}}},addInputRules(){return[ur({find:R_,type:this.type,getAttributes:n=>({checked:n[n.length-1]==="x"})})]}}),$_=Fe.create({name:"taskList",addOptions(){return{itemTypeName:"taskItem",HTMLAttributes:{}}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:`ul[data-type="${this.name}"]`,priority:51}]},renderHTML({HTMLAttributes:n}){return["ul",le(this.options.HTMLAttributes,n,{"data-type":this.name}),0]},parseMarkdown:(n,e)=>e.createNode("taskList",{},e.parseChildren(n.items||[])),renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`
`):"",markdownTokenizer:{name:"taskList",level:"block",start(n){var e;const t=(e=n.match(/^\s*[-+*]\s+\[([ xX])\]\s+/))==null?void 0:e.index;return t!==void 0?t:-1},tokenize(n,e,t){const r=i=>{const o=Pa(i,{itemPattern:/^(\s*)([-+*])\s+\[([ xX])\]\s+(.*)$/,extractItemData:a=>({indentLevel:a[1].length,mainContent:a[4],checked:a[3].toLowerCase()==="x"}),createToken:(a,l)=>({type:"taskItem",raw:"",mainContent:a.mainContent,indentLevel:a.indentLevel,checked:a.checked,text:a.mainContent,tokens:t.inlineTokens(a.mainContent),nestedTokens:l}),customNestedParser:r},t);return o?[{type:"taskList",raw:o.raw,items:o.items}]:t.blockTokens(i)},s=Pa(n,{itemPattern:/^(\s*)([-+*])\s+\[([ xX])\]\s+(.*)$/,extractItemData:i=>({indentLevel:i[1].length,mainContent:i[4],checked:i[3].toLowerCase()==="x"}),createToken:(i,o)=>({type:"taskItem",raw:"",mainContent:i.mainContent,indentLevel:i.indentLevel,checked:i.checked,text:i.mainContent,tokens:t.inlineTokens(i.mainContent),nestedTokens:o}),customNestedParser:r},t);if(s)return{type:"taskList",raw:s.raw,items:s.items}}},markdownOptions:{indentsContent:!0},addCommands(){return{toggleTaskList:()=>({commands:n})=>n.toggleList(this.name,this.options.itemTypeName)}},addKeyboardShortcuts(){return{"Mod-Shift-9":()=>this.editor.commands.toggleTaskList()}}});K.create({name:"listKit",addExtensions(){const n=[];return this.options.bulletList!==!1&&n.push(Wf.configure(this.options.bulletList)),this.options.listItem!==!1&&n.push(Kf.configure(this.options.listItem)),this.options.listKeymap!==!1&&n.push(Zf.configure(this.options.listKeymap)),this.options.orderedList!==!1&&n.push(tp.configure(this.options.orderedList)),this.options.taskItem!==!1&&n.push(P_.configure(this.options.taskItem)),this.options.taskList!==!1&&n.push($_.configure(this.options.taskList)),n}});var D_=Fe.create({name:"paragraph",priority:1e3,addOptions(){return{HTMLAttributes:{}}},group:"block",content:"inline*",parseHTML(){return[{tag:"p"}]},renderHTML({HTMLAttributes:n}){return["p",le(this.options.HTMLAttributes,n),0]},parseMarkdown:(n,e)=>{const t=n.tokens||[];return t.length===1&&t[0].type==="image"?e.parseChildren([t[0]]):e.createNode("paragraph",void 0,e.parseInline(t))},renderMarkdown:(n,e)=>!n||!Array.isArray(n.content)?"":e.renderChildren(n.content),addCommands(){return{setParagraph:()=>({commands:n})=>n.setNode(this.name)}},addKeyboardShortcuts(){return{"Mod-Alt-0":()=>this.editor.commands.setParagraph()}}}),j_=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))$/,L_=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))/g,B_=It.create({name:"strike",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"s"},{tag:"del"},{tag:"strike"},{style:"text-decoration",consuming:!1,getAttrs:n=>n.includes("line-through")?{}:!1}]},renderHTML({HTMLAttributes:n}){return["s",le(this.options.HTMLAttributes,n),0]},markdownTokenName:"del",parseMarkdown:(n,e)=>e.applyMark("strike",e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>`~~${e.renderChildren(n)}~~`,addCommands(){return{setStrike:()=>({commands:n})=>n.setMark(this.name),toggleStrike:()=>({commands:n})=>n.toggleMark(this.name),unsetStrike:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-s":()=>this.editor.commands.toggleStrike()}},addInputRules(){return[Nn({find:j_,type:this.type})]},addPasteRules(){return[en({find:L_,type:this.type})]}}),z_=Fe.create({name:"text",group:"inline",parseMarkdown:n=>({type:"text",text:n.text||""}),renderMarkdown:n=>n.text||""}),F_=It.create({name:"underline",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"u"},{style:"text-decoration",consuming:!1,getAttrs:n=>n.includes("underline")?{}:!1}]},renderHTML({HTMLAttributes:n}){return["u",le(this.options.HTMLAttributes,n),0]},parseMarkdown(n,e){return e.applyMark(this.name||"underline",e.parseInline(n.tokens||[]))},renderMarkdown(n,e){return`++${e.renderChildren(n)}++`},markdownTokenizer:{name:"underline",level:"inline",start(n){return n.indexOf("++")},tokenize(n,e,t){const s=/^(\+\+)([\s\S]+?)(\+\+)/.exec(n);if(!s)return;const i=s[2].trim();return{type:"underline",raw:s[0],text:i,tokens:t.inlineTokens(i)}}},addCommands(){return{setUnderline:()=>({commands:n})=>n.setMark(this.name),toggleUnderline:()=>({commands:n})=>n.toggleMark(this.name),unsetUnderline:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-u":()=>this.editor.commands.toggleUnderline(),"Mod-U":()=>this.editor.commands.toggleUnderline()}}});function U_(n={}){return new se({view(e){return new H_(e,n)}})}class H_{constructor(e,t){var r;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(r=t.width)!==null&&r!==void 0?r:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(s=>{let i=o=>{this[s](o)};return e.dom.addEventListener(s,i),{name:s,handler:i}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,r,s=this.editorView.dom,i=s.getBoundingClientRect(),o=i.width/s.offsetWidth,a=i.height/s.offsetHeight;if(t){let d=e.nodeBefore,h=e.nodeAfter;if(d||h){let f=this.editorView.nodeDOM(this.cursorPos-(d?d.nodeSize:0));if(f){let m=f.getBoundingClientRect(),g=d?m.bottom:m.top;d&&h&&(g=(g+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2);let y=this.width/2*a;r={left:m.left,right:m.right,top:g-y,bottom:g+y}}}}if(!r){let d=this.editorView.coordsAtPos(this.cursorPos),h=this.width/2*o;r={left:d.left-h,right:d.left+h,top:d.top,bottom:d.bottom}}let l=this.editorView.dom.offsetParent;this.element||(this.element=l.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let c,u;if(!l||l==document.body&&getComputedStyle(l).position=="static")c=-pageXOffset,u=-pageYOffset;else{let d=l.getBoundingClientRect(),h=d.width/l.offsetWidth,f=d.height/l.offsetHeight;c=d.left-l.scrollLeft*h,u=d.top-l.scrollTop*f}this.element.style.left=(r.left-c)/o+"px",this.element.style.top=(r.top-u)/a+"px",this.element.style.width=(r.right-r.left)/o+"px",this.element.style.height=(r.bottom-r.top)/a+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),r=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),s=r&&r.type.spec.disableDropCursor,i=typeof s=="function"?s(this.editorView,t,e):s;if(t&&!i){let o=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=th(this.editorView.state.doc,o,this.editorView.dragging.slice);a!=null&&(o=a)}this.setCursor(o),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){this.editorView.dom.contains(e.relatedTarget)||this.setCursor(null)}}class ae extends F{constructor(e){super(e,e)}map(e,t){let r=e.resolve(t.map(this.head));return ae.valid(r)?new ae(r):F.near(r)}content(){return A.empty}eq(e){return e instanceof ae&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new ae(e.resolve(t.pos))}getBookmark(){return new Hl(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!V_(e)||!q_(e))return!1;let r=t.type.spec.allowGapCursor;if(r!=null)return r;let s=t.contentMatchAt(e.index()).defaultType;return s&&s.isTextblock}static findGapCursorFrom(e,t,r=!1){e:for(;;){if(!r&&ae.valid(e))return e;let s=e.pos,i=null;for(let o=e.depth;;o--){let a=e.node(o);if(t>0?e.indexAfter(o)<a.childCount:e.index(o)>0){i=a.child(t>0?e.indexAfter(o):e.index(o)-1);break}else if(o==0)return null;s+=t;let l=e.doc.resolve(s);if(ae.valid(l))return l}for(;;){let o=t>0?i.firstChild:i.lastChild;if(!o){if(i.isAtom&&!i.isText&&!N.isSelectable(i)){e=e.doc.resolve(s+i.nodeSize*t),r=!1;continue e}break}i=o,s+=t;let a=e.doc.resolve(s);if(ae.valid(a))return a}return null}}}ae.prototype.visible=!1;ae.findFrom=ae.findGapCursorFrom;F.jsonID("gapcursor",ae);class Hl{constructor(e){this.pos=e}map(e){return new Hl(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return ae.valid(t)?new ae(t):F.near(t)}}function np(n){return n.isAtom||n.spec.isolating||n.spec.createGapCursor}function V_(n){for(let e=n.depth;e>=0;e--){let t=n.index(e),r=n.node(e);if(t==0){if(r.type.spec.isolating)return!0;continue}for(let s=r.child(t-1);;s=s.lastChild){if(s.childCount==0&&!s.inlineContent||np(s.type))return!0;if(s.inlineContent)return!1}}return!0}function q_(n){for(let e=n.depth;e>=0;e--){let t=n.indexAfter(e),r=n.node(e);if(t==r.childCount){if(r.type.spec.isolating)return!0;continue}for(let s=r.child(t);;s=s.firstChild){if(s.childCount==0&&!s.inlineContent||np(s.type))return!0;if(s.inlineContent)return!1}}return!0}function W_(){return new se({props:{decorations:Y_,createSelectionBetween(n,e,t){return e.pos==t.pos&&ae.valid(t)?new ae(t):null},handleClick:J_,handleKeyDown:K_,handleDOMEvents:{beforeinput:G_}}})}const K_=nf({ArrowLeft:Ms("horiz",-1),ArrowRight:Ms("horiz",1),ArrowUp:Ms("vert",-1),ArrowDown:Ms("vert",1)});function Ms(n,e){const t=n=="vert"?e>0?"down":"up":e>0?"right":"left";return function(r,s,i){let o=r.selection,a=e>0?o.$to:o.$from,l=o.empty;if(o instanceof j){if(!i.endOfTextblock(t)||a.depth==0)return!1;l=!1,a=r.doc.resolve(e>0?a.after():a.before())}let c=ae.findGapCursorFrom(a,e,l);return c?(s&&s(r.tr.setSelection(new ae(c))),!0):!1}}function J_(n,e,t){if(!n||!n.editable)return!1;let r=n.state.doc.resolve(e);if(!ae.valid(r))return!1;let s=n.posAtCoords({left:t.clientX,top:t.clientY});return s&&s.inside>-1&&N.isSelectable(n.state.doc.nodeAt(s.inside))?!1:(n.dispatch(n.state.tr.setSelection(new ae(r))),!0)}function G_(n,e){if(e.inputType!="insertCompositionText"||!(n.state.selection instanceof ae))return!1;let{$from:t}=n.state.selection,r=t.parent.contentMatchAt(t.index()).findWrapping(n.state.schema.nodes.text);if(!r)return!1;let s=_.empty;for(let o=r.length-1;o>=0;o--)s=_.from(r[o].createAndFill(null,s));let i=n.state.tr.replace(t.pos,t.pos,new A(s,0,0));return i.setSelection(j.near(i.doc.resolve(t.pos+1))),n.dispatch(i),!1}function Y_(n){if(!(n.selection instanceof ae))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",re.create(n.doc,[Me.widget(n.selection.head,e,{key:"gapcursor"})])}var Ri=200,ve=function(){};ve.prototype.append=function(e){return e.length?(e=ve.from(e),!this.length&&e||e.length<Ri&&this.leafAppend(e)||this.length<Ri&&e.leafPrepend(this)||this.appendInner(e)):this};ve.prototype.prepend=function(e){return e.length?ve.from(e).append(this):this};ve.prototype.appendInner=function(e){return new X_(this,e)};ve.prototype.slice=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=this.length),e>=t?ve.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,t))};ve.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)};ve.prototype.forEach=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=this.length),t<=r?this.forEachInner(e,t,r,0):this.forEachInvertedInner(e,t,r,0)};ve.prototype.map=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=this.length);var s=[];return this.forEach(function(i,o){return s.push(e(i,o))},t,r),s};ve.from=function(e){return e instanceof ve?e:e&&e.length?new rp(e):ve.empty};var rp=(function(n){function e(r){n.call(this),this.values=r}n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e;var t={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(s,i){return s==0&&i==this.length?this:new e(this.values.slice(s,i))},e.prototype.getInner=function(s){return this.values[s]},e.prototype.forEachInner=function(s,i,o,a){for(var l=i;l<o;l++)if(s(this.values[l],a+l)===!1)return!1},e.prototype.forEachInvertedInner=function(s,i,o,a){for(var l=i-1;l>=o;l--)if(s(this.values[l],a+l)===!1)return!1},e.prototype.leafAppend=function(s){if(this.length+s.length<=Ri)return new e(this.values.concat(s.flatten()))},e.prototype.leafPrepend=function(s){if(this.length+s.length<=Ri)return new e(s.flatten().concat(this.values))},t.length.get=function(){return this.values.length},t.depth.get=function(){return 0},Object.defineProperties(e.prototype,t),e})(ve);ve.empty=new rp([]);var X_=(function(n){function e(t,r){n.call(this),this.left=t,this.right=r,this.length=t.length+r.length,this.depth=Math.max(t.depth,r.depth)+1}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(r){return r<this.left.length?this.left.get(r):this.right.get(r-this.left.length)},e.prototype.forEachInner=function(r,s,i,o){var a=this.left.length;if(s<a&&this.left.forEachInner(r,s,Math.min(i,a),o)===!1||i>a&&this.right.forEachInner(r,Math.max(s-a,0),Math.min(this.length,i)-a,o+a)===!1)return!1},e.prototype.forEachInvertedInner=function(r,s,i,o){var a=this.left.length;if(s>a&&this.right.forEachInvertedInner(r,s-a,Math.max(i,a)-a,o+a)===!1||i<a&&this.left.forEachInvertedInner(r,Math.min(s,a),i,o)===!1)return!1},e.prototype.sliceInner=function(r,s){if(r==0&&s==this.length)return this;var i=this.left.length;return s<=i?this.left.slice(r,s):r>=i?this.right.slice(r-i,s-i):this.left.slice(r,i).append(this.right.slice(0,s-i))},e.prototype.leafAppend=function(r){var s=this.right.leafAppend(r);if(s)return new e(this.left,s)},e.prototype.leafPrepend=function(r){var s=this.left.leafPrepend(r);if(s)return new e(s,this.right)},e.prototype.appendInner=function(r){return this.left.depth>=Math.max(this.right.depth,r.depth)+1?new e(this.left,new e(this.right,r)):new e(this,r)},e})(ve);const Q_=500;class et{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let r=this.items.length;for(;;r--)if(this.items.get(r-1).selection){--r;break}let s,i;t&&(s=this.remapping(r,this.items.length),i=s.maps.length);let o=e.tr,a,l,c=[],u=[];return this.items.forEach((d,h)=>{if(!d.step){s||(s=this.remapping(r,h+1),i=s.maps.length),i--,u.push(d);return}if(s){u.push(new lt(d.map));let f=d.step.map(s.slice(i)),m;f&&o.maybeStep(f).doc&&(m=o.mapping.maps[o.mapping.maps.length-1],c.push(new lt(m,void 0,void 0,c.length+u.length))),i--,m&&s.appendMap(m,i)}else o.maybeStep(d.step);if(d.selection)return a=s?d.selection.map(s.slice(i)):d.selection,l=new et(this.items.slice(0,r).append(u.reverse().concat(c)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,r,s){let i=[],o=this.eventCount,a=this.items,l=!s&&a.length?a.get(a.length-1):null;for(let u=0;u<e.steps.length;u++){let d=e.steps[u].invert(e.docs[u]),h=new lt(e.mapping.maps[u],d,t),f;(f=l&&l.merge(h))&&(h=f,u?i.pop():a=a.slice(0,a.length-1)),i.push(h),t&&(o++,t=void 0),s||(l=h)}let c=o-r.depth;return c>ex&&(a=Z_(a,c),o-=c),new et(a.append(i),o)}remapping(e,t){let r=new Kr;return this.items.forEach((s,i)=>{let o=s.mirrorOffset!=null&&i-s.mirrorOffset>=e?r.maps.length-s.mirrorOffset:void 0;r.appendMap(s.map,o)},e,t),r}addMaps(e){return this.eventCount==0?this:new et(this.items.append(e.map(t=>new lt(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let r=[],s=Math.max(0,this.items.length-t),i=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(h=>{h.selection&&a--},s);let l=t;this.items.forEach(h=>{let f=i.getMirror(--l);if(f==null)return;o=Math.min(o,f);let m=i.maps[f];if(h.step){let g=e.steps[f].invert(e.docs[f]),y=h.selection&&h.selection.map(i.slice(l+1,f));y&&a++,r.push(new lt(m,g,y))}else r.push(new lt(m))},s);let c=[];for(let h=t;h<o;h++)c.push(new lt(i.maps[h]));let u=this.items.slice(0,s).append(c).append(r),d=new et(u,a);return d.emptyItemCount()>Q_&&(d=d.compress(this.items.length-r.length)),d}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),r=t.maps.length,s=[],i=0;return this.items.forEach((o,a)=>{if(a>=e)s.push(o),o.selection&&i++;else if(o.step){let l=o.step.map(t.slice(r)),c=l&&l.getMap();if(r--,c&&t.appendMap(c,r),l){let u=o.selection&&o.selection.map(t.slice(r));u&&i++;let d=new lt(c.invert(),l,u),h,f=s.length-1;(h=s.length&&s[f].merge(d))?s[f]=h:s.push(d)}}else o.map&&r--},this.items.length,0),new et(ve.from(s.reverse()),i)}}et.empty=new et(ve.empty,0);function Z_(n,e){let t;return n.forEach((r,s)=>{if(r.selection&&e--==0)return t=s,!1}),n.slice(t)}class lt{constructor(e,t,r,s){this.map=e,this.step=t,this.selection=r,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new lt(t.getMap().invert(),t,this.selection)}}}class Bt{constructor(e,t,r,s,i){this.done=e,this.undone=t,this.prevRanges=r,this.prevTime=s,this.prevComposition=i}}const ex=20;function tx(n,e,t,r){let s=t.getMeta(En),i;if(s)return s.historyState;t.getMeta(sx)&&(n=new Bt(n.done,n.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(o&&o.getMeta(En))return o.getMeta(En).redo?new Bt(n.done.addTransform(t,void 0,r,js(e)),n.undone,qu(t.mapping.maps),n.prevTime,n.prevComposition):new Bt(n.done,n.undone.addTransform(t,void 0,r,js(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=n.prevTime==0||!o&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-r.newGroupDelay||!nx(t,n.prevRanges)),c=o?Ko(n.prevRanges,t.mapping):qu(t.mapping.maps);return new Bt(n.done.addTransform(t,l?e.selection.getBookmark():void 0,r,js(e)),et.empty,c,t.time,a??n.prevComposition)}else return(i=t.getMeta("rebased"))?new Bt(n.done.rebased(t,i),n.undone.rebased(t,i),Ko(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new Bt(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),Ko(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function nx(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((r,s)=>{for(let i=0;i<e.length;i+=2)r<=e[i+1]&&s>=e[i]&&(t=!0)}),t}function qu(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((r,s,i,o)=>e.push(i,o));return e}function Ko(n,e){if(!n)return null;let t=[];for(let r=0;r<n.length;r+=2){let s=e.map(n[r],1),i=e.map(n[r+1],-1);s<=i&&t.push(s,i)}return t}function rx(n,e,t){let r=js(e),s=En.get(e).spec.config,i=(t?n.undone:n.done).popEvent(e,r);if(!i)return null;let o=i.selection.resolve(i.transform.doc),a=(t?n.done:n.undone).addTransform(i.transform,e.selection.getBookmark(),s,r),l=new Bt(t?a:i.remaining,t?i.remaining:a,null,0,-1);return i.transform.setSelection(o).setMeta(En,{redo:t,historyState:l})}let Jo=!1,Wu=null;function js(n){let e=n.plugins;if(Wu!=e){Jo=!1,Wu=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){Jo=!0;break}}return Jo}const En=new ge("history"),sx=new ge("closeHistory");function ix(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new se({key:En,state:{init(){return new Bt(et.empty,et.empty,null,0,-1)},apply(e,t,r){return tx(t,r,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let r=t.inputType,s=r=="historyUndo"?ip:r=="historyRedo"?op:null;return!s||!e.editable?!1:(t.preventDefault(),s(e.state,e.dispatch))}}}})}function sp(n,e){return(t,r)=>{let s=En.getState(t);if(!s||(n?s.undone:s.done).eventCount==0)return!1;if(r){let i=rx(s,t,n);i&&r(e?i.scrollIntoView():i)}return!0}}const ip=sp(!1,!0),op=sp(!0,!0);K.create({name:"characterCount",addOptions(){return{limit:null,mode:"textSize",textCounter:n=>n.length,wordCounter:n=>n.split(" ").filter(e=>e!=="").length}},addStorage(){return{characters:()=>0,words:()=>0}},onBeforeCreate(){this.storage.characters=n=>{const e=n?.node||this.editor.state.doc;if((n?.mode||this.options.mode)==="textSize"){const r=e.textBetween(0,e.content.size,void 0," ");return this.options.textCounter(r)}return e.nodeSize},this.storage.words=n=>{const e=n?.node||this.editor.state.doc,t=e.textBetween(0,e.content.size," "," ");return this.options.wordCounter(t)}},addProseMirrorPlugins(){let n=!1;return[new se({key:new ge("characterCount"),appendTransaction:(e,t,r)=>{if(n)return;const s=this.options.limit;if(s==null||s===0){n=!0;return}const i=this.storage.characters({node:r.doc});if(i>s){const o=i-s,a=0,l=o;console.warn(`[CharacterCount] Initial content exceeded limit of ${s} characters. Content was automatically trimmed.`);const c=r.tr.deleteRange(a,l);return n=!0,c}n=!0},filterTransaction:(e,t)=>{const r=this.options.limit;if(!e.docChanged||r===0||r===null||r===void 0)return!0;const s=this.storage.characters({node:t.doc}),i=this.storage.characters({node:e.doc});if(i<=r||s>r&&i>r&&i<=s)return!0;if(s>r&&i>r&&i>s||!e.getMeta("paste"))return!1;const a=e.selection.$head.pos,l=i-r,c=a-l,u=a;return e.deleteRange(c,u),!(this.storage.characters({node:e.doc})>r)}})]}});var ox=K.create({name:"dropCursor",addOptions(){return{color:"currentColor",width:1,class:void 0}},addProseMirrorPlugins(){return[U_(this.options)]}});K.create({name:"focus",addOptions(){return{className:"has-focus",mode:"all"}},addProseMirrorPlugins(){return[new se({key:new ge("focus"),props:{decorations:({doc:n,selection:e})=>{const{isEditable:t,isFocused:r}=this.editor,{anchor:s}=e,i=[];if(!t||!r)return re.create(n,[]);let o=0;this.options.mode==="deepest"&&n.descendants((l,c)=>{if(l.isText)return;if(!(s>=c&&s<=c+l.nodeSize-1))return!1;o+=1});let a=0;return n.descendants((l,c)=>{if(l.isText||!(s>=c&&s<=c+l.nodeSize-1))return!1;if(a+=1,this.options.mode==="deepest"&&o-a>0||this.options.mode==="shallowest"&&a>1)return this.options.mode==="deepest";i.push(Me.node(c,c+l.nodeSize,{class:this.options.className}))}),re.create(n,i)}}})]}});var ax=K.create({name:"gapCursor",addProseMirrorPlugins(){return[W_()]},extendNodeSchema(n){var e;const t={name:n.name,options:n.options,storage:n.storage};return{allowGapCursor:(e=J(M(n,"allowGapCursor",t)))!=null?e:null}}});K.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something ",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new se({key:new ge("placeholder"),props:{decorations:({doc:n,selection:e})=>{const t=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:r}=e,s=[];if(!t)return null;const i=this.editor.isEmpty;return n.descendants((o,a)=>{const l=r>=a&&r<=a+o.nodeSize,c=!o.isLeaf&&io(o);if((l||!this.options.showOnlyCurrent)&&c){const u=[this.options.emptyNodeClass];i&&u.push(this.options.emptyEditorClass);const d=Me.node(a,a+o.nodeSize,{class:u.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:o,pos:a,hasAnchor:l}):this.options.placeholder});s.push(d)}return this.options.includeChildren}),re.create(n,s)}}})]}});K.create({name:"selection",addOptions(){return{className:"selection"}},addProseMirrorPlugins(){const{editor:n,options:e}=this;return[new se({key:new ge("selection"),props:{decorations(t){return t.selection.empty||n.isFocused||!n.isEditable||wf(t.selection)||n.view.dragging?null:re.create(t.doc,[Me.inline(t.selection.from,t.selection.to,{class:e.className})])}}})]}});function Ku({types:n,node:e}){return e&&Array.isArray(n)&&n.includes(e.type)||e?.type===n}var lx=K.create({name:"trailingNode",addOptions(){return{node:void 0,notAfter:[]}},addProseMirrorPlugins(){var n;const e=new ge(this.name),t=this.options.node||((n=this.editor.schema.topNodeType.contentMatch.defaultType)==null?void 0:n.name)||"paragraph",r=Object.entries(this.editor.schema.nodes).map(([,s])=>s).filter(s=>(this.options.notAfter||[]).concat(t).includes(s.name));return[new se({key:e,appendTransaction:(s,i,o)=>{const{doc:a,tr:l,schema:c}=o,u=e.getState(o),d=a.content.size,h=c.nodes[t];if(u)return l.insert(d,h.create())},state:{init:(s,i)=>{const o=i.tr.doc.lastChild;return!Ku({node:o,types:r})},apply:(s,i)=>{if(!s.docChanged||s.getMeta("__uniqueIDTransaction"))return i;const o=s.doc.lastChild;return!Ku({node:o,types:r})}}})]}}),cx=K.create({name:"undoRedo",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:n,dispatch:e})=>ip(n,e),redo:()=>({state:n,dispatch:e})=>op(n,e)}},addProseMirrorPlugins(){return[ix(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-":()=>this.editor.commands.undo(),"Shift-Mod-":()=>this.editor.commands.redo()}}}),ux=K.create({name:"starterKit",addExtensions(){var n,e,t,r;const s=[];return this.options.bold!==!1&&s.push(jS.configure(this.options.bold)),this.options.blockquote!==!1&&s.push(NS.configure(this.options.blockquote)),this.options.bulletList!==!1&&s.push(Wf.configure(this.options.bulletList)),this.options.code!==!1&&s.push(zS.configure(this.options.code)),this.options.codeBlock!==!1&&s.push(HS.configure(this.options.codeBlock)),this.options.document!==!1&&s.push(VS.configure(this.options.document)),this.options.dropcursor!==!1&&s.push(ox.configure(this.options.dropcursor)),this.options.gapcursor!==!1&&s.push(ax.configure(this.options.gapcursor)),this.options.hardBreak!==!1&&s.push(qS.configure(this.options.hardBreak)),this.options.heading!==!1&&s.push(WS.configure(this.options.heading)),this.options.undoRedo!==!1&&s.push(cx.configure(this.options.undoRedo)),this.options.horizontalRule!==!1&&s.push(KS.configure(this.options.horizontalRule)),this.options.italic!==!1&&s.push(QS.configure(this.options.italic)),this.options.listItem!==!1&&s.push(Kf.configure(this.options.listItem)),this.options.listKeymap!==!1&&s.push(Zf.configure((n=this.options)==null?void 0:n.listKeymap)),this.options.link!==!1&&s.push(__.configure((e=this.options)==null?void 0:e.link)),this.options.orderedList!==!1&&s.push(tp.configure(this.options.orderedList)),this.options.paragraph!==!1&&s.push(D_.configure(this.options.paragraph)),this.options.strike!==!1&&s.push(B_.configure(this.options.strike)),this.options.text!==!1&&s.push(z_.configure(this.options.text)),this.options.underline!==!1&&s.push(F_.configure((t=this.options)==null?void 0:t.underline)),this.options.trailingNode!==!1&&s.push(lx.configure((r=this.options)==null?void 0:r.trailingNode)),s}}),dx=ux,hx=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,fx=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,px=It.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:n=>n.getAttribute("data-color")||n.style.backgroundColor,renderHTML:n=>n.color?{"data-color":n.color,style:`background-color: ${n.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:n}){return["mark",le(this.options.HTMLAttributes,n),0]},renderMarkdown:(n,e)=>`==${e.renderChildren(n)}==`,parseMarkdown:(n,e)=>e.applyMark("highlight",e.parseInline(n.tokens||[])),markdownTokenizer:{name:"highlight",level:"inline",start:n=>n.indexOf("=="),tokenize(n,e,t){const s=/^(==)([^=]+)(==)/.exec(n);if(s){const i=s[2].trim(),o=t.inlineTokens(i);return{type:"highlight",raw:s[0],text:i,tokens:o}}}},addCommands(){return{setHighlight:n=>({commands:e})=>e.setMark(this.name,n),toggleHighlight:n=>({commands:e})=>e.toggleMark(this.name,n),unsetHighlight:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[Nn({find:hx,type:this.type})]},addPasteRules(){return[en({find:fx,type:this.type})]}}),mx=K.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:n=>{const e=n.style.textAlign;return this.options.alignments.includes(e)?e:this.options.defaultAlignment},renderHTML:n=>n.textAlign?{style:`text-align: ${n.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:n=>({commands:e})=>this.options.alignments.includes(n)?this.options.types.map(t=>e.updateAttributes(t,{textAlign:n})).some(t=>t):!1,unsetTextAlign:()=>({commands:n})=>this.options.types.map(e=>n.resetAttributes(e,"textAlign")).some(e=>e),toggleTextAlign:n=>({editor:e,commands:t})=>this.options.alignments.includes(n)?e.isActive({textAlign:n})?t.unsetTextAlign():t.setTextAlign(n):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),gx=20,ap=(n,e=0)=>{const t=[];return!n.children.length||e>gx||Array.from(n.children).forEach(r=>{r.tagName==="SPAN"?t.push(r):r.children.length&&t.push(...ap(r,e+1))}),t},yx=n=>{if(!n.children.length)return;const e=ap(n);e&&e.forEach(t=>{var r,s;const i=t.getAttribute("style"),o=(s=(r=t.parentElement)==null?void 0:r.closest("span"))==null?void 0:s.getAttribute("style");t.setAttribute("style",`${o};${i}`)})},lp=It.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:n=>n.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&yx(n),{}):!1}]},renderHTML({HTMLAttributes:n}){return["span",le(this.options.HTMLAttributes,n),0]},addCommands(){return{toggleTextStyle:n=>({commands:e})=>e.toggleMark(this.name,n),removeEmptyTextStyle:()=>({tr:n})=>{const{selection:e}=n;return n.doc.nodesBetween(e.from,e.to,(t,r)=>{if(t.isTextblock)return!0;t.marks.filter(s=>s.type===this.type).some(s=>Object.values(s.attrs).some(i=>!!i))||n.removeMark(r,r+t.nodeSize,this.type)}),!0}}}}),bx=K.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:n=>{var e;const t=n.getAttribute("style");if(t){const r=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s=r.length-1;s>=0;s-=1){const i=r[s].split(":");if(i.length>=2){const o=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(o==="background-color")return a.replace(/['"]+/g,"")}}}return(e=n.style.backgroundColor)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:n=>n.backgroundColor?{style:`background-color: ${n.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:n=>({chain:e})=>e().setMark("textStyle",{backgroundColor:n}).run(),unsetBackgroundColor:()=>({chain:n})=>n().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),wx=K.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:n=>{var e;const t=n.getAttribute("style");if(t){const r=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s=r.length-1;s>=0;s-=1){const i=r[s].split(":");if(i.length>=2){const o=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(o==="color")return a.replace(/['"]+/g,"")}}}return(e=n.style.color)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:n=>n.color?{style:`color: ${n.color}`}:{}}}}]},addCommands(){return{setColor:n=>({chain:e})=>e().setMark("textStyle",{color:n}).run(),unsetColor:()=>({chain:n})=>n().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),vx=K.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:n=>n.style.fontFamily,renderHTML:n=>n.fontFamily?{style:`font-family: ${n.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:n=>({chain:e})=>e().setMark("textStyle",{fontFamily:n}).run(),unsetFontFamily:()=>({chain:n})=>n().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),kx=K.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:n=>n.style.fontSize,renderHTML:n=>n.fontSize?{style:`font-size: ${n.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:n=>({chain:e})=>e().setMark("textStyle",{fontSize:n}).run(),unsetFontSize:()=>({chain:n})=>n().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),Sx=K.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:n=>n.style.lineHeight,renderHTML:n=>n.lineHeight?{style:`line-height: ${n.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:n=>({chain:e})=>e().setMark("textStyle",{lineHeight:n}).run(),unsetLineHeight:()=>({chain:n})=>n().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});K.create({name:"textStyleKit",addExtensions(){const n=[];return this.options.backgroundColor!==!1&&n.push(bx.configure(this.options.backgroundColor)),this.options.color!==!1&&n.push(wx.configure(this.options.color)),this.options.fontFamily!==!1&&n.push(vx.configure(this.options.fontFamily)),this.options.fontSize!==!1&&n.push(kx.configure(this.options.fontSize)),this.options.lineHeight!==!1&&n.push(Sx.configure(this.options.lineHeight)),this.options.textStyle!==!1&&n.push(lp.configure(this.options.textStyle)),n}});let V=null,ct=null,jr=null,Qn=null,Lr=null,rr=null;const _x=K.create({name:"fontSize",addGlobalAttributes(){return[{types:["textStyle"],attributes:{fontSize:{default:null,parseHTML:n=>n.style.fontSize||null,renderHTML:n=>n.fontSize?{style:`font-size: ${n.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:n=>({chain:e})=>e().setMark("textStyle",{fontSize:n}).run(),unsetFontSize:()=>({chain:n})=>n().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),xx=K.create({name:"tabIndent",addKeyboardShortcuts(){return{Tab:()=>this.editor.isActive("listItem")?!1:this.editor.commands.insertContent("	"),"Shift-Tab":()=>{if(this.editor.isActive("listItem"))return!1;const{state:n}=this.editor,{from:e,empty:t}=n.selection;return!t||e<=1?this.editor.commands.command(()=>!0):n.doc.textBetween(e-1,e,"\0","\0")!=="	"?this.editor.commands.command(()=>!0):this.editor.commands.command(({tr:s})=>(s.delete(e-1,e),!0))}}}}),Tx=K.create({name:"dialogueDash",addGlobalAttributes(){return[{types:["paragraph"],attributes:{dialogueIndent:{default:!1,parseHTML:n=>n.getAttribute("data-dialogue-indent")==="true",renderHTML:n=>n.dialogueIndent?{"data-dialogue-indent":"true",class:"dialogue-indent"}:{}}}}]},addInputRules(){return[new us({find:/^(\s*)--$/,handler:({state:n,range:e,match:t})=>{const{$from:r}=n.selection;if(!r.parent||r.parent.type.name!=="paragraph")return null;for(let c=0;c<=r.depth;c+=1){const u=r.node(c).type.name;if(u==="heading"||u==="codeBlock"||u==="listItem")return null}const i=`${t[1]??""} `;let o=n.tr.insertText(i,e.from,e.to);const a=r.before();o=o.setNodeMarkup(a,void 0,{...r.parent.attrs,dialogueIndent:!0});const l=e.from+i.length;return o=o.setSelection(j.create(o.doc,l)),o}})]}});function Ex(n){const e=n.trim();if(!e)return 0;const t=e.match(/\S+/g);return t?t.length:0}function Ju(){if(!V)return;const n=document.querySelector("#editor-word-count");if(!n)return;const e=Ex(V.state.doc.textContent??"");n.textContent=`${e} mot${e===1?"":"s"}`}function Cx(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ax(n){return n?n.split(`
`).map(e=>`<p>${Cx(e)}</p>`).join(""):"<p></p>"}function Ox(n){return/<\/?[a-z][\s\S]*>/i.test(n)}function Mx(n){if(!n.includes('data-type="page"'))return n;const e=document.createElement("div");e.innerHTML=n;const t=Array.from(e.querySelectorAll('div[data-type="page"]'));for(const r of t){const s=r.parentNode;if(s){for(;r.firstChild;)s.insertBefore(r.firstChild,r);s.removeChild(r)}}return e.innerHTML}function Ix(n){if(!n)return"<p></p>";const e=Ox(n)?n:Ax(n);return Mx(e)}function vn(){if(!V||!ct)return;const n=ct.querySelectorAll("[data-command]"),e=ct.querySelector('[data-command="font-size"]');for(const t of n){const r=t.dataset.command;let s=!1;if(r==="bold")s=V.isActive("bold");else if(r==="italic")s=V.isActive("italic");else if(r==="heading-1")s=V.isActive("heading",{level:1});else if(r==="heading-2")s=V.isActive("heading",{level:2});else if(r==="align-left")s=V.isActive({textAlign:"left"});else if(r==="align-center")s=V.isActive({textAlign:"center"});else if(r==="align-right")s=V.isActive({textAlign:"right"});else if(r==="align-justify")s=V.isActive({textAlign:"justify"});else if(r==="bullet-list")s=V.isActive("bulletList");else if(r==="ordered-list")s=V.isActive("orderedList");else if(r==="highlight")s=V.isActive("highlight");else if(r&&r.startsWith("font-")){const i=`${r.replace("font-","")}px`;s=V.isActive("textStyle",{fontSize:i})}if(r==="align-left"&&!s){const i=V.getAttributes("paragraph").textAlign,o=V.getAttributes("heading").textAlign;!i&&!o&&(s=!0)}t.classList.toggle("is-active",s),r==="undo"&&(t.disabled=!V.can().undo()),r==="redo"&&(t.disabled=!V.can().redo())}if(e){if(document.activeElement===e)return;const t=V.getAttributes("textStyle").fontSize||"";e.value=t?t.replace("px",""):"16"}}function Nx(n){if(n.target instanceof HTMLSelectElement||n.target instanceof HTMLOptionElement)return;const e=n.target.closest("[data-command]");if(!e||!V||e instanceof HTMLSelectElement)return;const t=e.dataset.command,r=V.chain().focus();if(t==="bold")r.toggleBold().run();else if(t==="italic")r.toggleItalic().run();else if(t==="heading-1")r.toggleHeading({level:1}).run();else if(t==="heading-2")r.toggleHeading({level:2}).run();else if(t==="align-left")r.setTextAlign("left").run();else if(t==="align-center")r.setTextAlign("center").run();else if(t==="align-right")r.setTextAlign("right").run();else if(t==="align-justify")r.setTextAlign("justify").run();else if(t==="bullet-list")r.toggleBulletList().run();else if(t==="ordered-list")r.toggleOrderedList().run();else if(t==="highlight")V.isActive("highlight")?r.unsetHighlight().run():r.toggleHighlight({color:"var(--token-highlight)"}).run();else if(t&&t.startsWith("font-")){const s=`${t.replace("font-","")}px`;r.setFontSize(s).run()}else t==="undo"?r.undo().run():t==="redo"&&r.redo().run();vn()}function cp(n){const e=n.target;if(!V||!(e instanceof HTMLSelectElement)||e.dataset.command!=="font-size")return;const t=e.value,r=V.chain().focus();if(!t){r.unsetFontSize().run(),vn();return}const s=`${t}px`;r.setFontSize(s).run(),vn()}function Rx(){if(!Qn)return;const n=Qn.clientWidth;if(!n)return;const e=Math.min(980,Math.max(640,n)),t=Math.round(Math.min(56,Math.max(32,e*.06)));Qn.style.setProperty("--page-width",`${e}px`),Qn.style.setProperty("--page-padding",`${t}px`)}function Gu(){rr||(rr=window.requestAnimationFrame(()=>{rr=null,Rx()}))}function Px({content:n="",onUpdate:e}={}){const t=document.querySelector("#chapter-editor"),r=document.querySelector("#editor-toolbar"),s=document.querySelector(".paper-shell");if(!t||!r||!s){Vl();return}V&&(V.destroy(),V=null),ct=r,jr=Nx,ct.addEventListener("click",jr),ct.addEventListener("change",cp),Qn=s,Lr=Gu,window.addEventListener("resize",Lr),Gu(),V=new kS({element:t,extensions:[dx.configure({gapcursor:!1}),mx.configure({types:["paragraph","heading"]}),px,lp,_x,xx,Tx],content:Ix(n),onUpdate({editor:i}){e&&e(i.getHTML()),vn(),Ju()},onSelectionUpdate:vn,onTransaction:vn}),vn(),Ju()}function Vl(){ct&&jr&&(ct.removeEventListener("click",jr),ct.removeEventListener("change",cp)),ct=null,jr=null,Qn=null,Lr&&(window.removeEventListener("resize",Lr),Lr=null),rr&&(window.cancelAnimationFrame(rr),rr=null),V&&(V.destroy(),V=null)}const up="Bucketplumeo",$x="latest.json";function dp(n){return`${n}/${$x}`}async function hp(){const n=await ft();if(!n.ok)return n;try{const e=await q("projects"),t=await q("chapters"),r=await q("characters"),s=await q("inspiration"),i=await q("ideas"),o=await q("mindmap_nodes"),a=await q("mindmap_edges"),l={schema:1,saved_at:new Date().toISOString(),projects:e,chapters:t,characters:r,inspiration:s,ideas:i,mindmapNodes:o,mindmapEdges:a},c=new Blob([JSON.stringify(l)],{type:"application/json"}),u=dp(n.userId),{error:d}=await ce.storage.from(up).upload(u,c,{upsert:!0,contentType:"application/json"});return d?{ok:!1,errorMessage:d.message}:{ok:!0,savedAt:l.saved_at}}catch(e){return{ok:!1,errorMessage:e.message}}}async function fp({applyIfNewer:n=!1}={}){const e=await ft();if(!e.ok)return e;try{const t=dp(e.userId),{data:r,error:s}=await ce.storage.from(up).download(t);if(s)return{ok:!1,errorMessage:s.message};const i=await r.text(),o=JSON.parse(i),a=o?.saved_at,l=a?Date.parse(a):null,c=qi();if(n&&l&&Number.isFinite(l)&&c&&Number.isFinite(c)&&l<=c)return{ok:!0,savedAt:l,skipped:!0};const u=Array.isArray(o?.projects)?o.projects:[],d=Array.isArray(o?.chapters)?o.chapters:[],h=Array.isArray(o?.characters)?o.characters:[],f=Array.isArray(o?.inspiration)?o.inspiration:[],m=Array.isArray(o?.ideas)?o.ideas:[],g=Array.isArray(o?.mindmapNodes)?o.mindmapNodes:[],y=Array.isArray(o?.mindmapEdges)?o.mindmapEdges:[];return await fr(u),await is(d,{force:!0}),await Promise.all([...h.map(b=>W("characters",b)),...f.map(b=>W("inspiration",b)),...m.map(b=>W("ideas",b)),...g.map(b=>W("mindmap_nodes",b)),...y.map(b=>W("mindmap_edges",b))]),l&&Number.isFinite(l)&&sl(l),{ok:!0,savedAt:l}}catch(t){return{ok:!1,errorMessage:t.message}}}const fe=document.querySelector("#app"),p={projects:[],projectsStats:{},projectsMenuOpenId:null,selectedProjectId:null,chapters:[],selectedChapterId:null,chapterDetail:null,versions:[],statusText:"",homeMessage:"",editingProjectId:null,lastChapterTitle:null,lastCloudSaveAt:null,cloudStatus:"",cloudBusy:!1,backupStatus:"",homeStats:null,editorTab:"session",ideas:[],ideasQuery:"",ideasTagFilter:"",ideasStatusFilter:"all",ideasSort:"desc",ideasFiltersOpen:!1,ideasProjectId:null,ideasNoteExpanded:!1,selectedIdeaId:null,writingNav:"chapter",characters:[],selectedCharacterId:null,characterFilter:"",inspirationItems:[],inspirationSearch:"",inspirationTag:"",inspirationModal:{open:!1,step:"type",type:null,draft:null},inspirationDetailId:null,mindmapNodes:[],mindmapEdges:[],mindmapSelectedNodeId:null,mindmapMode:"select",mindmapLinkSourceId:null,mindmapSearch:"",mindmapCreateType:"note",mindmapLinkTypeMenu:null,mindmapFlashNodeId:null,mindmapView:{offsetX:0,offsetY:0,scale:1},characterSections:{civil:!0,physique:!1,caractere:!1,profil:!1,storyRole:!1,evolution:!1,inventaire:!1,possession:!1,autres:!1},accountMenuOpen:!1,backupMenuOpen:!1},Dx=300*1e3,jx=300*1e3;let Ls=null,Is=null,Yu=!1,qe="",qa=!1,mr=!1,ut=null,kn=null;const Go=new Map,sr=new Map,Pi=new Map,Yo=new Set,lo=180,co=64;let Ze=null,Vt=null,Xo=null;function ql(){Ls&&(clearTimeout(Ls),Ls=null)}function Ns(n){Is&&(clearInterval(Is),Is=null),n&&(Is=window.setInterval(async()=>{if(p.cloudBusy||!qe)return;const e=await hp();if(e.ok){const t=Date.now();sl(t),p.lastCloudSaveAt=t}else console.error("cloud autosave error",e.errorMessage)},jx))}async function Qo(){if(qa||!qe)return;qa=!0;const n=window.location.hostname,e=n&&n!=="localhost"&&n!=="127.0.0.1";e&&(p.cloudStatus="Chargement cloud...");const t=await fp({applyIfNewer:!e});if(!t.ok){p.cloudStatus=`Erreur cloud: ${t.errorMessage}`,console.error("cloud bootstrap error",t.errorMessage);return}t.skipped||(mr=!0),t.savedAt&&Number.isFinite(t.savedAt)&&(p.lastCloudSaveAt=t.savedAt),e&&(p.cloudStatus=t.skipped?"Cloud deja a jour.":"Cloud charge.")}function Zo(n){const e=document.querySelector("#message");e&&(e.textContent=n)}function G(n){p.statusText=n;const e=document.querySelector("#status-text");e&&(e.textContent=n)}function dr(n){p.homeMessage=n;const e=document.querySelector("#home-message");e&&(e.textContent=n)}function P(){Vl(),new Set(["chapter","characters","ideas","inspiration","mindmap"]).has(p.writingNav)||(p.writingNav="chapter"),p.writingNav!=="inspiration"&&(p.inspirationDetailId=null,p.inspirationModal={open:!1,step:"type",type:null,mode:"create",draft:null}),p.writingNav!=="mindmap"&&(p.mindmapMode="select",p.mindmapLinkSourceId=null,p.mindmapLinkTypeMenu=null),p.writingNav==="characters"&&!p.selectedCharacterId&&p.characters.length&&(p.selectedCharacterId=p.characters[0].id),fe.innerHTML=qy({userEmail:qe,projects:p.projects,selectedProjectId:p.selectedProjectId,editingProjectId:p.editingProjectId,chapters:p.chapters,selectedChapterId:p.selectedChapterId,chapterDetail:p.chapterDetail,versions:p.versions,statusText:p.statusText,editorTab:p.editorTab,writingNav:p.writingNav,characters:p.characters,selectedCharacterId:p.selectedCharacterId,characterFilter:p.characterFilter,inspirationItems:p.inspirationItems,inspirationSearch:p.inspirationSearch,inspirationTag:p.inspirationTag,inspirationModal:p.inspirationModal,inspirationDetailId:p.inspirationDetailId,ideas:eT(),selectedIdeaId:p.selectedIdeaId,ideasQuery:p.ideasQuery,ideasTagFilter:p.ideasTagFilter,ideasStatusFilter:p.ideasStatusFilter,ideasSort:p.ideasSort,ideasFiltersOpen:p.ideasFiltersOpen,ideasNoteExpanded:p.ideasNoteExpanded,mindmapNodes:p.mindmapNodes,mindmapEdges:p.mindmapEdges,mindmapSelectedNodeId:p.mindmapSelectedNodeId,mindmapMode:p.mindmapMode,mindmapLinkSourceId:p.mindmapLinkSourceId,mindmapSearch:p.mindmapSearch,mindmapCreateType:p.mindmapCreateType,mindmapLinkTypeMenu:p.mindmapLinkTypeMenu,mindmapFlashNodeId:p.mindmapFlashNodeId,mindmapView:p.mindmapView,characterSections:p.characterSections,lastCloudSaveAt:p.lastCloudSaveAt,cloudStatus:p.cloudStatus,cloudBusy:p.cloudBusy,accountMenuOpen:p.accountMenuOpen,backupStatus:p.backupStatus,backupMenuOpen:p.backupMenuOpen}),zx(),p.chapterDetail&&Px({content:p.chapterDetail.content_md??"",onUpdate:xp})}function Lx(){fe.innerHTML=zy({userEmail:qe,projects:p.projects,lastProjectId:Ot(),lastChapterTitle:p.lastChapterTitle,lastCloudSaveAt:p.lastCloudSaveAt,cloudStatus:p.cloudStatus,cloudBusy:p.cloudBusy,homeStats:p.homeStats,homeMessage:p.homeMessage,accountMenuOpen:p.accountMenuOpen,backupStatus:p.backupStatus,backupMenuOpen:p.backupMenuOpen})}function Bx(){fe.innerHTML=Uy({userEmail:qe,projects:p.projects,projectStats:p.projectsStats,projectsMenuOpenId:p.projectsMenuOpenId,editingProjectId:p.editingProjectId,lastProjectId:Ot(),lastCloudSaveAt:p.lastCloudSaveAt,cloudStatus:p.cloudStatus,cloudBusy:p.cloudBusy,accountMenuOpen:p.accountMenuOpen,backupStatus:p.backupStatus,backupMenuOpen:p.backupMenuOpen})}function L(){if(window.location.hash.startsWith("#/project/")||window.location.hash.startsWith("#/editor")){P();return}if(window.location.hash.startsWith("#/home")){Lx();return}if(window.location.hash.startsWith("#/projects")){Bx();return}}function zx(){const n=document.querySelector("#project-export");if(!n)return;const t=!!p.projects.find(r=>r.id===p.selectedProjectId);n.disabled=!t,n.setAttribute("aria-disabled",t?"false":"true")}function Xu(){const n=document.querySelector("#email"),e=document.querySelector("#password");return{email:n?n.value.trim():"",password:e?e.value:""}}async function $e({allowFallback:n=!0}={}){const e=await ob();if(p.projects=e,p.projects.length===0){p.selectedProjectId=null;return}!p.projects.some(r=>r.id===p.selectedProjectId)&&n&&(p.selectedProjectId=p.projects[0].id)}async function $i(){const n={};for(const e of p.projects){const t=await nl(e.id);let r=0;const s=e.created_at?new Date(e.created_at).getTime():null;let i=Number.isNaN(s)?null:s;for(const o of t){const a=yp(o.content_md??"");r+=gp(a);const l=o.updated_local_at??o.updated_at??o.created_at??null;if(l){const c=new Date(l).getTime();Number.isNaN(c)||(i=i?Math.max(i,c):c)}}n[e.id]={chapterCount:t.length,wordCount:r,updatedAt:i}}p.projectsStats=n}async function hr(){if(!p.selectedProjectId){p.chapters=[],p.selectedChapterId=null,p.chapterDetail=null,p.versions=[];return}const n=await nl(p.selectedProjectId);if(p.chapters=n,p.chapters.length===0){p.selectedChapterId=null,p.chapterDetail=null,p.versions=[];return}p.chapters.some(t=>t.id===p.selectedChapterId)||(p.selectedChapterId=p.chapters[0].id)}async function tn(){if(!p.selectedProjectId){p.characters=[],p.selectedCharacterId=null;return}p.characters=await ub(p.selectedProjectId),p.characters.some(e=>e.id===p.selectedCharacterId)||(p.selectedCharacterId=p.characters[0]?.id??null)}async function Di(){if(!p.selectedProjectId){p.inspirationItems=[];return}p.inspirationItems=await fb(p.selectedProjectId)}async function Qu(){if(!p.selectedProjectId){p.mindmapNodes=[],p.mindmapEdges=[],p.mindmapSelectedNodeId=null;return}const n=await yb(p.selectedProjectId);p.mindmapNodes=n.nodes,p.mindmapEdges=n.edges,p.mindmapNodes.some(t=>t.id===p.mindmapSelectedNodeId)||(p.mindmapSelectedNodeId=null)}async function Tt(){if(!p.selectedChapterId){p.chapterDetail=null;return}p.chapterDetail=await Hi(p.selectedChapterId)}async function Et(n){if(!n){p.versions=[];return}const e=await Zy(n);if(!e.ok){p.versions=[];return}p.versions=e.data}async function Wl(){const n=await Wy();if(!n.ok){G(`Erreur: ${n.errorMessage}`);return}await fr(n.data),await $e()}async function Fx(n){const e=await Jy(n);if(!e.ok){G(`Erreur: ${e.errorMessage}`);return}await is(e.data),await hr()}async function Zu(){}async function pp(){p.editingProjectId=null,p.lastCloudSaveAt=qi(),await $e(),await Zu(),await Rn(),await Bi(),L(),mr||(await Wl(),await $e(),await Zu(),await Rn(),await Bi(),L())}async function mp(){p.lastCloudSaveAt=qi(),await $e({allowFallback:!1}),await $i(),L(),mr||(await Wl(),await $e({allowFallback:!1}),await $i(),L())}async function Ux({projectId:n=null,render:e=!0}={}){p.lastCloudSaveAt=qi(),p.ideasProjectId=n,p.ideas=await Vi({projectId:n}),p.selectedIdeaId&&(p.ideas.some(r=>r.id===p.selectedIdeaId)||(p.selectedIdeaId=null)),e&&L()}function gp(n){const e=n.trim();if(!e)return 0;const t=e.match(/\S+/g);return t?t.length:0}function yp(n){if(!n)return"";if(!/<[a-z][\s\S]*>/i.test(n))return n;const e=document.createElement("div");return e.innerHTML=n,e.textContent??""}async function Rn(){const n=await q("chapters"),e=Date.now();let t=0,r=null,s=n.length>0;for(const c of n){const u=yp(c.content_md??"");t+=gp(u);const d=c.created_at??c.updated_at??c.updated_local_at??null;if(d){const h=new Date(d).getTime();Number.isNaN(h)||(r=r===null?h:Math.min(r,h))}}if(!s){p.homeStats={totalWords:null,wordsPerDay:null,pagesTotal:null,pagesPerDay:null,timeSpent:null,timePerDay:null,favoriteTime:null};return}const i=r===null?1:Math.max(1,Math.ceil((e-r)/864e5)),o=t?Math.round(t/i):0,a=t?Math.ceil(t/250):0,l=a?a/i:0;p.homeStats={totalWords:t,wordsPerDay:o,pagesTotal:a,pagesPerDay:l,timeSpent:null,timePerDay:null,favoriteTime:null}}function Hx(){return p.chapters.map((e,t)=>({chapter:e,index:t})).sort((e,t)=>{const r=(e.chapter.order_index??0)-(t.chapter.order_index??0);return r!==0?r:e.index-t.index}).map(e=>e.chapter)}async function Vx(n){const e=[];if(n.forEach((t,r)=>{const s=(r+1)*10;(t.order_index??0)!==s&&e.push({chapter:t,order_index:s})}),!!e.length){for(const t of e){const r={...t.chapter,order_index:t.order_index};await W("chapters",r)}p.chapters=n.map(t=>{const r=e.find(s=>s.chapter.id===t.id);return r?{...t,order_index:r.order_index}:t}),navigator.onLine&&await Promise.all(e.map(t=>Xy(t.chapter.id,{order_index:t.order_index})))}}async function qx(n,e){if(!n||!e||n===e)return;const t=Hx(),r=t.findIndex(a=>a.id===n),s=t.findIndex(a=>a.id===e);if(r===-1||s===-1)return;const i=[...t],[o]=i.splice(r,1);i.splice(s,0,o),await Vx(i),P()}function ji(){return p.characters.find(n=>n.id===p.selectedCharacterId)}async function Wx(){if(!p.selectedProjectId){G("Cree un projet avant d'ajouter un personnage.");return}const n=await db(p.selectedProjectId);await tn(),p.selectedCharacterId=n?.id??p.selectedCharacterId,P()}async function Kx(n){!n||n===p.selectedCharacterId||(p.selectedCharacterId=n,P())}async function Jx(n){if(!n)return;const e=p.characters.find(s=>s.id===n),t=e?.first_name||e?.last_name?`${e?.first_name??""} ${e?.last_name??""}`.trim():"ce personnage";window.confirm(`Supprimer ${t} ?`)&&(await hb(n),await tn(),P())}function Gx(n){p.characterFilter=n,P()}function Yx(n){!n||!(n in p.characterSections)||(p.characterSections={...p.characterSections,[n]:!p.characterSections[n]},P())}async function Xx(n){const e=ji();if(!e)return;const t=Math.max(0,Math.min(5,n));await Vs(e.id,{role_rating:t}),await tn(),P()}function Qx(n,e){const t=n;Go.has(t)&&clearTimeout(Go.get(t));const r=window.setTimeout(async()=>{await Vs(n,e),await tn(),P()},400);Go.set(t,r)}function bp(n,e,t=null){const r=ji();if(!r)return;const s=t?{meta:{[t]:{...r.meta?.[t]??{},[n]:e}}}:{[n]:e};Qx(r.id,s)}function Zx(){G("Bientot disponible.")}function Zn(n){return String(n||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function Li(n){return String(n||"").split(",").map(e=>e.trim()).filter(Boolean)}function eT(){let n=[...p.ideas];const e=p.ideasQuery.trim();if(e){const r=Zn(e);n=n.filter(s=>{const i=[s.content,s.note,...s.tags??[]].filter(Boolean).join(" ");return Zn(i).includes(r)})}if(p.ideasTagFilter.trim()){const r=Zn(p.ideasTagFilter.trim());n=n.filter(s=>(s.tags??[]).some(i=>Zn(i).includes(r)))}p.ideasStatusFilter!=="all"&&(n=n.filter(r=>r.status===p.ideasStatusFilter));const t=p.ideasSort==="asc"?1:-1;return n.sort((r,s)=>{const i=r.created_at??0,o=s.created_at??0;return t*(i-o)}),n}function ed(n,e,t=700){if(!n)return;const r=Pi.get(n)??{};Pi.set(n,{...r,...e}),sr.has(n)&&clearTimeout(sr.get(n));const s=window.setTimeout(()=>{wp(n)},t);sr.set(n,s)}async function Wa(n,e,{render:t=!1}={}){if(!n)return;const r=await Sb(n,e);r?p.ideas=p.ideas.map(s=>s.id===n?r:s):p.ideas=await Vi({projectId:p.ideasProjectId}),t&&L()}async function wp(n,{render:e=!1}={}){const t=Pi.get(n);t&&(Pi.delete(n),sr.has(n)&&(clearTimeout(sr.get(n)),sr.delete(n)),await Wa(n,t,{render:e}))}async function tT(n,{select:e=!1}={}){const t=n.trim();if(!t)return;const r=await kb({content:t,status:"raw",tags:[],note:"",project_id:p.ideasProjectId});p.ideas=await Vi({projectId:p.ideasProjectId}),e&&r?.id&&(p.selectedIdeaId=r.id,p.ideasNoteExpanded=!1),L()}async function nT(n){!n||!window.confirm("Supprimer cette idee ?")||(await _b(n),p.ideas=await Vi({projectId:p.ideasProjectId}),p.selectedIdeaId===n&&(p.selectedIdeaId=p.ideas[0]?.id??null,p.ideasNoteExpanded=!1),L())}function Kl(n="type",e=null,t=null,r="create"){p.inspirationModal={open:!0,step:n,type:e,mode:r,draft:t},P()}function vp(){p.inspirationModal={open:!1,step:"type",type:null,mode:"create",draft:null},P()}function rT(n){p.inspirationDetailId=n,P()}function sT(){p.inspirationDetailId=null,P()}async function iT(){if(!p.selectedProjectId){G("Cree un projet avant d'ajouter une inspiration.");return}p.inspirationDetailId=null,Kl("type",null,{tags:[]},"create")}function oT(n){if(!n)return;const e=p.inspirationModal?.draft??{tags:[]};Kl("form",n,{...e,type:n},p.inspirationModal?.mode??"create")}async function aT(){const n=p.inspirationModal;if(!n?.open||n.step!=="form")return;const e=n.type,t=document.querySelector("#inspiration-title")?.value??"",r=document.querySelector("#inspiration-note")?.value??"",s=document.querySelector("#inspiration-tags")?.value??"",i=document.querySelector("#inspiration-url")?.value??"",o=document.querySelector("#inspiration-link-chapter")?.value??"",a=document.querySelector("#inspiration-link-character")?.value??"",l=Li(s),c=n.draft?.image_data??"";if(e==="image"&&!c){window.alert("Ajoute une image avant d'enregistrer.");return}if((e==="link"||e==="video")&&!i.trim()){window.alert("Ajoute une URL avant d'enregistrer.");return}n.mode==="edit"&&n.draft?.id?await mb(n.draft.id,{title:t,note:r,tags:l,url:i,image_data:c,linkedChapterId:o,linkedCharacterId:a}):await pb(p.selectedProjectId,{type:e,title:t,note:r,tags:l,url:i,image_data:c,linkedChapterId:o,linkedCharacterId:a}),await Di(),vp()}function lT(n){p.inspirationSearch=n,P()}function cT(n){p.inspirationTag=n,P()}async function uT(n){const e=p.inspirationItems.find(s=>s.id===n);if(!e)return;const t=e.title||e.url||"cet element";window.confirm(`Supprimer ${t} ?`)&&(await gb(n),await Di(),p.inspirationDetailId=null,P())}function dT(n){const e=p.inspirationItems.find(r=>r.id===n);if(!e)return;p.inspirationDetailId=null;const t={...e,tags:e.tags??[]};Kl("form",e.type,t,"edit")}function ns(n){return p.mindmapNodes.find(e=>e.id===n)}async function kp(n=null){if(!p.selectedProjectId){G("Cree un projet avant d'ajouter une carte mentale.");return}const t=document.querySelector(".mindmap-canvas")?.getBoundingClientRect(),r=t?.width??800,s=t?.height??500,i=n?.x??(r/2-p.mindmapView.offsetX)/p.mindmapView.scale-lo/2,o=n?.y??(s/2-p.mindmapView.offsetY)/p.mindmapView.scale-co/2,a=await bb(p.selectedProjectId,{x:i,y:o,type:p.mindmapCreateType});p.mindmapNodes=[...p.mindmapNodes,a],p.mindmapSelectedNodeId=a.id,P()}async function hT(n){n&&(await wb(n),p.mindmapNodes=p.mindmapNodes.filter(e=>e.id!==n),p.mindmapEdges=p.mindmapEdges.filter(e=>e.fromNodeId!==n&&e.toNodeId!==n),p.mindmapSelectedNodeId===n&&(p.mindmapSelectedNodeId=null),P())}async function Ka(n,e){const t=await Ad(n,e);t&&(p.mindmapNodes=p.mindmapNodes.map(r=>r.id===n?t:r),P())}async function ea(n,e,t="linked"){if(!n||!e||n===e)return;const r=await vb(p.selectedProjectId,{fromNodeId:n,toNodeId:e,type:t});p.mindmapEdges=[...p.mindmapEdges,r]}function fT(n){p.mindmapSelectedNodeId=n,P()}function pT(){p.mindmapView={offsetX:0,offsetY:0,scale:1},P()}function mT(n){const e=document.querySelector(".mindmap-canvas");if(!e)return;const t=e.getBoundingClientRect(),r=p.mindmapView.scale,s=t.width/2-(n.x+lo/2)*r,i=t.height/2-(n.y+co/2)*r;p.mindmapView={...p.mindmapView,offsetX:s,offsetY:i}}function gT(n){Xo&&clearTimeout(Xo),p.mindmapFlashNodeId=n,P(),Xo=window.setTimeout(()=>{p.mindmapFlashNodeId=null,P()},600)}async function yT(n){const e=ns(n);if(e){if(e.linkedChapterId){p.writingNav="chapter",await Tp(e.linkedChapterId);return}e.linkedCharacterId&&(p.writingNav="characters",p.selectedCharacterId=e.linkedCharacterId,P())}}async function bT(){if(p.cloudBusy)return;p.cloudBusy=!0,p.cloudStatus="Sauvegarde...",L();const n=await hp();if(n.ok){const e=Date.now();sl(e),p.lastCloudSaveAt=e,p.cloudStatus="Sauvegarde terminee."}else p.cloudStatus=`Erreur: ${n.errorMessage}`;p.cloudBusy=!1,L()}async function wT(){if(p.cloudBusy)return;p.cloudBusy=!0,p.cloudStatus="Chargement...",L();const n=await fp();if(n.ok){n.skipped||(mr=!0);const e=window.location.hash;if(e.startsWith("#/project/")||e.startsWith("#/editor")){const t=p.selectedProjectId??e.replace("#/project/","").split("/")[0];t?await Sp(t):(await $e({allowFallback:!1}),L())}else e.startsWith("#/projects")?await mp():e.startsWith("#/home")?await pp():(await $e({allowFallback:!1}),await Rn(),await Bi(),L());p.cloudStatus="Chargement termine."}else p.cloudStatus=`Erreur: ${n.errorMessage}`;p.cloudBusy=!1,L()}async function vT(){const n=await q("projects"),e=await q("chapters"),t=await q("outbox"),r=await q("characters"),s=await q("inspiration"),i=await q("ideas"),o=await q("mindmap_nodes"),a=await q("mindmap_edges"),l={version:1,exportedAt:new Date().toISOString(),data:{projects:n,chapters:e,outbox:t,characters:r,inspiration:s,ideas:i,mindmapNodes:o,mindmapEdges:a}},c=new Blob([JSON.stringify(l)],{type:"application/json"}),u=URL.createObjectURL(c),h=`plumeo-backup-${new Date().toISOString().slice(0,10)}.json`,f=document.createElement("a");f.href=u,f.download=h,document.body.appendChild(f),f.click(),f.remove(),URL.revokeObjectURL(u),p.backupStatus="Export termine.",L()}async function cn(n,e){const t=await q(n);for(const r of t)r&&r[e]!=null&&await Ce(n,r[e])}async function kT(n){if(!n)return;let e;try{const f=await n.text();e=JSON.parse(f)}catch{p.backupStatus="Import echoue.",L();return}if(!e||e.version!==1||!e.data){p.backupStatus="Import refuse (format).",L();return}const t=e.data,r=Array.isArray(t.projects)?t.projects:null,s=Array.isArray(t.chapters)?t.chapters:null;Array.isArray(t.outbox)&&t.outbox;const i=Array.isArray(t.characters)?t.characters:[],o=Array.isArray(t.inspiration)?t.inspiration:[],a=Array.isArray(t.ideas)?t.ideas:[],l=Array.isArray(t.mindmapNodes)?t.mindmapNodes:[],c=Array.isArray(t.mindmapEdges)?t.mindmapEdges:[];if(!r||!s){p.backupStatus="Import refuse (donnees).",L();return}const u=await q("projects"),d=await q("chapters");if(!((u.length>0||d.length>0)&&!window.confirm("Importer ce backup va remplacer les donnees locales. Continuer ?"))){await cn("projects","id"),await cn("chapters","id"),await cn("outbox","opId"),await cn("ideas","id"),await cn("inspiration","id"),await cn("mindmap_nodes","id"),await cn("mindmap_edges","id");for(const f of i)await W("characters",f);for(const f of o)await W("inspiration",f);for(const f of a)await W("ideas",f);for(const f of l)await W("mindmap_nodes",f);for(const f of c)await W("mindmap_edges",f);p.backupStatus="Import termine.",await $e({allowFallback:!1}),await Rn(),await Bi(),L()}}async function Bi(){const n=Ot(),e=xb();if(!n||!e){p.lastChapterTitle=null;return}const t=await Hi(e);if(!t||t.project_id!==n){p.lastChapterTitle=null;return}p.lastChapterTitle=t.title||"Sans titre"}async function ST(n){return n?(p.selectedProjectId=n,await $e({allowFallback:!1}),p.projects.some(t=>t.id===n)?!0:(await Wl(),await $e({allowFallback:!1}),p.projects.some(t=>t.id===n))):!1}async function Sp(n){if(!await ST(n)){window.location.hash="#/projects";return}rt(n),p.statusText="",p.editingProjectId=p.editingProjectId===n?n:null,await hr(),await tn(),await Di(),await Qu(),p.ideasProjectId=p.writingNav==="ideas"?n:null,p.writingNav==="ideas"&&await Ux({projectId:n,render:!1}),await Tt(),p.selectedChapterId&&Cn(p.selectedChapterId),await Et(p.selectedChapterId),P(),mr||(await Fx(n),await Tt(),await tn(),await Di(),await Qu(),p.selectedChapterId&&Cn(p.selectedChapterId),await Et(p.selectedChapterId),P())}async function _T(){const n=await tl("Sans titre");if(!n.ok){G(`Erreur: ${n.errorMessage}`);return}await fr([n.data]),rt(n.data.id),p.editingProjectId=n.data.id,window.location.hash=`#/project/${n.data.id}/write`}async function xT(){const n=await tl("Sans titre");if(!n.ok){G(`Erreur: ${n.errorMessage}`);return}await fr([n.data]),rt(n.data.id),p.editingProjectId=n.data.id,window.location.hash=`#/project/${n.data.id}/write`}function TT(n){n&&window.requestAnimationFrame(()=>{const e=document.querySelector(`.project-edit-input[data-id="${n}"]`);e&&(e.focus(),e.select())})}function ET(n,e){if(!n)return;const t=document.querySelector(`.project-edit-input[data-id="${n}"]`);t&&(t.setAttribute("aria-invalid","true"),t.setAttribute("title",e),t.focus(),t.select()),G(e)}async function CT(n){if(!n)return;if(!p.projects.find(t=>t.id===n)){console.warn("project rename: project not found",n);return}p.editingProjectId=n,p.projectsMenuOpenId=null,L(),TT(n)}async function AT(n){if(!n)return;const e=document.querySelector(`.project-edit-input[data-id="${n}"]`),t=e?e.value:"";await _p(n,t)}async function OT(n,e){!n||!e||(await xd(n,{status:e}),await $e({allowFallback:!1}),await $i(),await Rn(),e==="archived"&&Ot()===n&&rt(null),p.projectsMenuOpenId=null,L())}async function MT(n){if(!n)return;const e=p.projects.find(i=>i.id===n),t=e?.title?`"${e.title}"`:"ce projet";if(!window.confirm(`Supprimer ${t} ? Cette action est definitive.`))return;const s=await wd(n);if(!s.ok){G(`Erreur: ${s.errorMessage}`);return}await _d(n),await Td(n),await Ed(n),await Cd(n),await $e({allowFallback:!1}),await $i(),await Rn(),p.selectedProjectId===n&&(p.selectedProjectId=null,p.selectedChapterId=null,p.chapterDetail=null,p.chapters=[],p.versions=[]),p.editingProjectId===n&&(p.editingProjectId=null),Ot()===n&&rt(null),p.projectsMenuOpenId=null,L()}async function IT(n){n!==p.selectedProjectId&&(rt(n),p.editingProjectId=null,window.location.hash=`#/project/${n}/write`)}async function NT(n){n&&(rt(n),window.location.hash=`#/project/${n}/write`)}async function RT(){const n=Ot();n&&(window.location.hash=`#/project/${n}/write`)}async function PT(){const n=await tl("Sans titre");if(!n.ok){dr(`Erreur: ${n.errorMessage}`);return}dr(""),await fr([n.data]),rt(n.data.id),p.editingProjectId=n.data.id,window.location.hash=`#/project/${n.data.id}/write`}async function $T(n){if(!n)return;const e=p.projects.find(i=>i.id===n),t=e?.title?`"${e.title}"`:"ce projet";if(!window.confirm(`Supprimer ${t} ? Cette action est definitive.`))return;const s=await wd(n);if(!s.ok){dr(`Erreur: ${s.errorMessage}`);return}await _d(n),await Td(n),await Ed(n),await Cd(n),await $e({allowFallback:!1}),p.selectedProjectId===n&&(p.selectedProjectId=null,p.selectedChapterId=null,p.chapterDetail=null,p.chapters=[],p.versions=[]),p.editingProjectId===n&&(p.editingProjectId=null),Ot()===n&&rt(null),dr("Projet supprime."),L()}async function _p(n,e){if(!n||Yo.has(n))return;const t=p.projects.find(l=>l.id===n);if(!t){console.warn("project rename: project not found",n),p.editingProjectId=null,L();return}const s=(typeof e=="string"?e:"").trim();if(!s){ET(n,"Le titre ne peut pas etre vide.");return}const i=t.title??"Sans titre";if(s===i){p.editingProjectId=null,L();return}Yo.add(n);let o=null,a=null;try{const l=new Date().toISOString();o=await xd(n,{title:s,updated_at:l}),o&&(p.projects=p.projects.map(c=>c.id===n?o:c)),p.editingProjectId=null,L(),navigator.onLine&&(a=await Ky(n,s),a.ok?(await fr([a.data]),await $e({allowFallback:!1})):G(`Erreur: ${a.errorMessage}`))}finally{Yo.delete(n),L()}}async function xp(n){if(!p.selectedChapterId)return;const e=await rl(p.selectedChapterId,{content_md:n});p.chapterDetail=e;const t=navigator.onLine?"Synchronisation...":"En attente (offline)";G(t),ql();const r=p.selectedChapterId;Ls=window.setTimeout(async()=>{if(await Rn(),await Wi(r),navigator.onLine){const s=await Ki();await uo(s)}},1200)}async function DT(){if(!p.selectedProjectId){G("Cree un projet avant d'ajouter un chapitre.");return}if(!p.projects.find(a=>a.id===p.selectedProjectId)){G("Projet introuvable. Recharge la liste des projets.");return}const e=window.prompt("Titre du chapitre");if(!e)return;const t=e.trim();if(!t){G("Le titre du chapitre ne peut pas etre vide.");return}const r=p.chapters.length,s=async a=>{const l=await cb(p.selectedProjectId,t,r);if(!l){G("Erreur: creation locale du chapitre impossible.");return}await Wi(l.id),p.selectedChapterId=l.id,Cn(l.id),await hr(),await Tt(),await Et(p.selectedChapterId),G(a),P()};if(!navigator.onLine){await s("Chapitre enregistre localement. Synchronisation en attente.");return}const i=await bd(p.selectedProjectId);if(!i.ok||!i.exists){await s("Projet pas encore synchronise. Chapitre enregistre localement.");return}const o=await vd(p.selectedProjectId,t,r);if(!o.ok){if(o.errorMessage?.includes("chapters_project_id_fkey")||o.errorMessage?.toLowerCase().includes("foreign key constraint")){await s("Projet non synchronise. Chapitre enregistre localement.");return}G(`Erreur: ${o.errorMessage}`);return}await is([o.data]),p.selectedChapterId=o.data.id,Cn(o.data.id),await hr(),await Tt(),await Et(p.selectedChapterId),P()}async function Tp(n){if(n!==p.selectedChapterId){if(ql(),p.selectedChapterId=n,Cn(n),p.statusText="",await Tt(),!p.chapterDetail){const e=await kd(n);e.ok&&(await is([e.data]),await Tt())}await Et(n),P()}}async function jT(n){if(!n||!p.selectedProjectId)return;if(p.cloudBusy){G("Synchronisation en cours...");return}const t=p.chapters.find(s=>s.id===n)?.title?.trim()||"Sans titre";window.confirm(`Supprimer le chapitre "${t}" ? Cette action est irreversible.`)&&(await ab(n),p.selectedChapterId===n&&(p.selectedChapterId=null,p.chapterDetail=null,p.versions=[]),await hr(),p.selectedChapterId?(Cn(p.selectedChapterId),await Tt(),await Et(p.selectedChapterId)):Cn(null),P())}async function LT(){if(!p.chapterDetail?.server_copy)return;const n=p.chapterDetail.server_copy,e={...p.chapterDetail,title:n.title??p.chapterDetail.title,content_md:n.content_md??"",remote_revision:n.revision??p.chapterDetail.remote_revision??0,conflict:!1,dirty:!1,server_copy:null};await W("chapters",e),p.chapterDetail=e,G("Charge depuis serveur"),P()}async function BT(){if(!p.selectedProjectId||!p.chapterDetail)return;const e=`${p.chapterDetail.title||"Chapitre"} (copie)`,t=p.chapters.length,r=await vd(p.selectedProjectId,e,t);if(!r.ok){G(`Erreur: ${r.errorMessage}`);return}await is([r.data]);const s=await rl(r.data.id,{content_md:p.chapterDetail.content_md??""});p.selectedChapterId=r.data.id,p.chapterDetail=s;const i=navigator.onLine?"Synchronisation...":"En attente (offline)";if(G(i),await Wi(r.data.id),navigator.onLine){const o=await Ki();await uo(o)}await hr(),await Et(p.selectedChapterId),P()}async function zT(){if(!p.selectedChapterId||!p.chapterDetail)return;const n=window.prompt("Label du snapshot (optionnel)"),e=await Sd(p.selectedChapterId,p.chapterDetail.content_md??"",n||null);if(!e.ok){G(`Erreur: ${e.errorMessage}`);return}await Et(p.selectedChapterId),P()}async function FT(n){if(!p.selectedChapterId)return;const e=p.versions.find(s=>s.id===n);if(!e)return;const t=await rl(p.selectedChapterId,{content_md:e.content_md??""});p.chapterDetail=t;const r=navigator.onLine?"Synchronisation...":"En attente (offline)";if(G(r),await Wi(p.selectedChapterId),navigator.onLine){const s=await Ki();await uo(s)}P()}async function UT(){if(!p.selectedProjectId)return;const n=await nl(p.selectedProjectId),t=p.projects.find(c=>c.id===p.selectedProjectId)?.title??"Projet",r=[`# ${t}`,""],s=c=>{if(!c)return"";if(!/<[a-z][\s\S]*>/i.test(c))return c;const u=document.createElement("div");return u.innerHTML=c,u.textContent??""};for(const c of n)r.push(`## ${c.title??"Sans titre"}`),r.push(s(c.content_md??"")),r.push("");const i=new Blob([r.join(`
`)],{type:"text/markdown"}),o=URL.createObjectURL(i),a=`${t}`.replace(/[\\/:*?"<>|]/g,"-").trim()||"projet",l=document.createElement("a");l.href=o,l.download=`${a}.md`,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(o)}async function HT(n){const e=await Hi(n);if(!e)return;const t=e.last_snapshot_at??0;if(Date.now()-t<Dx||!(await Sd(n,e.content_md??"","Auto")).ok)return;const s={...e,last_snapshot_at:Date.now()};await W("chapters",s),n===p.selectedChapterId&&await Et(n)}const VT=()=>{if(!p.selectedChapterId||p.writingNav!=="chapter")return!1;const n=document.activeElement;return n?!!(n.closest&&n.closest(".ProseMirror")):!1};async function uo(n){if(!n||n.length===0)return;for(const t of n)t.status==="synced"&&await HT(t.chapterId);const e=n.find(t=>t.chapterId===p.selectedChapterId);if(e){if(e.status==="synced"){if(VT()){G("Enregistre");return}await Tt(),G("Enregistre"),P();return}e.status==="conflict"&&(await Tt(),G("Conflit detecte"),P())}}fe.addEventListener("click",async n=>{const e=n.target.closest("[data-action]");if(!e)return;const t=e.dataset.action;if(t==="sign-out"){(await _c()).ok&&(window.location.hash="#login");return}if(t==="backup-toggle"){p.backupMenuOpen=!p.backupMenuOpen,p.accountMenuOpen=!1,L();return}if(t==="account-toggle"){p.accountMenuOpen=!p.accountMenuOpen,p.backupMenuOpen=!1,L();return}if(t==="nav-home"){p.accountMenuOpen=!1,p.backupMenuOpen=!1,window.location.hash="#/home";return}if(t==="nav-ideas"){p.accountMenuOpen=!1,p.backupMenuOpen=!1;const r=Ot();window.location.hash=r?`#/project/${r}/ideas`:"#/projects";return}if(t==="nav-projects"){p.accountMenuOpen=!1,p.backupMenuOpen=!1,window.location.hash="#/projects";return}if(t==="projects-open"){const r=e.dataset.id;if(!r||p.editingProjectId===r)return;p.editingProjectId=null,rt(r),p.projectsMenuOpenId=null,window.location.hash=`#/project/${r}/write`;return}if(t==="projects-create"){await xT();return}if(t==="projects-menu-toggle"){const r=e.dataset.id;p.projectsMenuOpenId=p.projectsMenuOpenId===r?null:r,L();return}if(t==="projects-rename"){await CT(e.dataset.id);return}if(t==="projects-rename-confirm"){await AT(e.dataset.id);return}if(t==="projects-rename-cancel"){p.editingProjectId=null,L();return}if(t!=="projects-rename-input"){if(t==="projects-status"){await OT(e.dataset.id,e.dataset.status);return}if(t==="projects-delete"){await MT(e.dataset.id);return}if(t==="ideas-select"){const r=e.dataset.id;if(r){if(r===p.selectedIdeaId){p.selectedIdeaId=null,p.ideasNoteExpanded=!1,L();return}p.selectedIdeaId=r,p.ideasNoteExpanded=!1,L()}return}if(t==="ideas-delete"){await nT(e.dataset.id);return}if(t==="ideas-note-toggle"){p.ideasNoteExpanded=!p.ideasNoteExpanded,L();return}if(t==="ideas-filters-toggle"){p.ideasFiltersOpen=!p.ideasFiltersOpen,L();return}if(t==="project-create"){await _T();return}if(t==="home-project-create"){await PT();return}if(t==="home-project-open"){await NT(e.dataset.id);return}if(t==="home-backup-export"){p.backupMenuOpen=!1,await vT();return}if(t==="home-backup-import"){p.backupMenuOpen=!1;const r=document.querySelector("#home-backup-file");r&&(r.value="",r.click());return}if(t==="home-cloud-save"){p.accountMenuOpen=!1,await bT();return}if(t==="home-cloud-load"){p.accountMenuOpen=!1,await wT();return}if(t==="home-sign-out"){p.accountMenuOpen=!1;const r=await _c();if(!r.ok){console.error(r.errorMessage),dr(`Erreur: ${r.errorMessage}`);return}qe="",dr(""),L();return}if(t==="home-project-delete"){await $T(e.dataset.id);return}if(t==="home-project-continue"){await RT();return}if(t==="home-scroll-next"){const r=document.querySelector("#home-next");r&&r.scrollIntoView({behavior:"smooth",block:"start"});return}if(t==="project-select"){await IT(e.dataset.id);return}if(t==="project-export-md"){await UT();return}if(t==="chapter-create"){await DT();return}if(t==="chapter-select"){await Tp(e.dataset.id);return}if(t==="chapter-delete"){await jT(e.dataset.id);return}if(t==="conflict-reload-server"){await LT();return}if(t==="conflict-duplicate-local"){await BT();return}if(t==="version-create"){await zT();return}if(t==="version-restore"&&await FT(e.dataset.id),t==="editor-tab"){const r=e.dataset.tab;r&&r!==p.editorTab&&(p.editorTab=r,P());return}if(t==="writing-nav"){const r=e.dataset.nav;if(r&&r!==p.writingNav){const s=p.selectedProjectId;if(!s)return;const i={chapter:"write",characters:"characters",inspiration:"inspiration",ideas:"ideas",mindmap:"mindmap"};window.location.hash=`#/project/${s}/${i[r]??"write"}`}return}if(t==="inspiration-add"){await iT();return}if(t==="inspiration-choose-type"){oT(e.dataset.type);return}if(t==="inspiration-save"){await aT();return}if(t==="inspiration-cancel"){vp();return}if(t==="inspiration-open"){rT(e.dataset.id);return}if(t==="inspiration-close"){sT();return}if(t==="inspiration-edit"){dT(e.dataset.id);return}if(t==="inspiration-delete"){await uT(e.dataset.id);return}if(t==="mindmap-add-node"){await kp();return}if(t==="mindmap-link-mode"){p.mindmapMode=p.mindmapMode==="link"?"select":"link",p.mindmapLinkSourceId=null,P();return}if(t==="mindmap-reset"){pT();return}if(t==="mindmap-node"){const r=e.dataset.id;if(!r)return;if(p.mindmapMode==="link"){if(!p.mindmapLinkSourceId){p.mindmapLinkSourceId=r,P();return}const s=ns(p.mindmapLinkSourceId),i=ns(r);if(!s||!i){p.mindmapMode="select",p.mindmapLinkSourceId=null,P();return}const o=(s.x+i.x)/2+lo/2-80,a=(s.y+i.y)/2+co/2-20;p.mindmapLinkTypeMenu={open:!0,fromId:s.id,toId:i.id,x:o,y:a},P();return}fT(r);return}if(t==="mindmap-canvas"){if(p.mindmapLinkTypeMenu?.open){const r=p.mindmapLinkTypeMenu;r?.fromId&&r?.toId&&await ea(r.fromId,r.toId,"linked"),p.mindmapLinkTypeMenu=null,p.mindmapMode="select",p.mindmapLinkSourceId=null,P();return}p.mindmapSelectedNodeId=null,p.mindmapMode==="link"&&(p.mindmapLinkSourceId=null),P();return}if(t==="mindmap-delete-node"){await hT(e.dataset.id);return}if(t==="mindmap-open-source"){await yT(e.dataset.id);return}if(t==="mindmap-link-type"){const r=e.dataset.type||"linked",s=p.mindmapLinkTypeMenu;s?.fromId&&s?.toId&&await ea(s.fromId,s.toId,r),p.mindmapLinkTypeMenu=null,p.mindmapMode="select",p.mindmapLinkSourceId=null,P();return}if(t==="mindmap-link-cancel"){const r=p.mindmapLinkTypeMenu;r?.fromId&&r?.toId&&await ea(r.fromId,r.toId,"linked"),p.mindmapLinkTypeMenu=null,p.mindmapMode="select",p.mindmapLinkSourceId=null,P();return}if(t==="character-create"){await Wx();return}if(t==="character-select"){await Kx(e.dataset.id);return}if(t==="character-delete"){await Jx(e.dataset.id);return}if(t==="character-toggle"){Yx(e.dataset.section);return}if(t==="character-rate"){const r=Number(e.dataset.rating);Number.isFinite(r)&&await Xx(r);return}if(t==="character-write"){Zx();return}if(t==="character-avatar"){const r=document.querySelector("#character-avatar-input");r instanceof HTMLInputElement&&(r.value="",r.click());return}if(t==="character-physique"){const r=document.querySelector("#character-physique-input");r instanceof HTMLInputElement&&(r.value="",r.click());return}}});function Ja(){document.querySelectorAll(".chapter-item.is-dragging, .chapter-item.is-drop-target").forEach(n=>n.classList.remove("is-dragging","is-drop-target"))}fe.addEventListener("dragstart",n=>{const e=n.target.closest(".chapter-item");!e||!(n.dataTransfer instanceof DataTransfer)||(ut=e.dataset.id||null,ut&&(e.classList.add("is-dragging"),n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",ut)))});fe.addEventListener("dragover",n=>{const e=n.target.closest(".chapter-item");if(!e||!ut)return;const t=e.dataset.id;if(!(!t||t===ut)){if(n.preventDefault(),kn&&kn!==t){const r=document.querySelector(`.chapter-item[data-id="${kn}"]`);r&&r.classList.remove("is-drop-target")}kn=t,e.classList.add("is-drop-target"),n.dataTransfer&&(n.dataTransfer.dropEffect="move")}});fe.addEventListener("drop",async n=>{const e=n.target.closest(".chapter-item");if(!e||!ut){Ja(),ut=null,kn=null;return}n.preventDefault();const t=e.dataset.id;Ja();const r=ut;ut=null,kn=null,t&&await qx(r,t)});fe.addEventListener("dragend",()=>{Ja(),ut=null,kn=null});fe.addEventListener("mousedown",n=>{if(p.writingNav!=="mindmap")return;const e=n.target;if(!(e instanceof Element))return;const t=e.closest(".mindmap-node");if(e.closest(".mindmap-canvas")){if(t){const s=t.dataset.id,i=ns(s);if(!i)return;Ze={id:i.id,startX:n.clientX,startY:n.clientY,originX:i.x,originY:i.y},n.preventDefault();return}Vt={startX:n.clientX,startY:n.clientY,originX:p.mindmapView.offsetX,originY:p.mindmapView.offsetY},n.preventDefault()}});fe.addEventListener("dblclick",async n=>{if(p.writingNav!=="mindmap")return;const e=n.target;if(!(e instanceof Element))return;const t=e.closest(".mindmap-canvas");if(!t)return;const r=t.getBoundingClientRect(),s=(n.clientX-r.left-p.mindmapView.offsetX)/p.mindmapView.scale-lo/2,i=(n.clientY-r.top-p.mindmapView.offsetY)/p.mindmapView.scale-co/2;await kp({x:s,y:i})});fe.addEventListener("mousemove",n=>{if(p.writingNav==="mindmap"){if(Ze){const e=(n.clientX-Ze.startX)/p.mindmapView.scale,t=(n.clientY-Ze.startY)/p.mindmapView.scale,r=Ze.originX+e,s=Ze.originY+t;p.mindmapNodes=p.mindmapNodes.map(i=>i.id===Ze.id?{...i,x:r,y:s}:i),P();return}if(Vt){const e=n.clientX-Vt.startX,t=n.clientY-Vt.startY;p.mindmapView={...p.mindmapView,offsetX:Vt.originX+e,offsetY:Vt.originY+t},P()}}});fe.addEventListener("mouseup",async()=>{if(p.writingNav!=="mindmap"){Ze=null,Vt=null;return}if(Ze){const n=ns(Ze.id);n&&await Ad(n.id,{x:n.x,y:n.y})}Ze=null,Vt=null});fe.addEventListener("wheel",n=>{if(p.writingNav!=="mindmap")return;const e=n.target;if(!(e instanceof Element))return;const t=e.closest(".mindmap-canvas");if(!t)return;n.preventDefault();const r=t.getBoundingClientRect(),s=n.clientX-r.left,i=n.clientY-r.top,o=p.mindmapView.scale,a=Math.min(2,Math.max(.4,o+(n.deltaY>0?-.08:.08))),l=a/o,c=s-(s-p.mindmapView.offsetX)*l,u=i-(i-p.mindmapView.offsetY)*l;p.mindmapView={offsetX:c,offsetY:u,scale:a},P()},{passive:!1});fe.addEventListener("input",async n=>{const e=n.target;if(e){if(e instanceof HTMLInputElement&&e.classList.contains("project-edit-input")){e.getAttribute("aria-invalid")==="true"&&(e.removeAttribute("aria-invalid"),e.removeAttribute("title"));return}if(e.id==="character-filter"){Gx(e.value);return}if(e.id==="ideas-search"){p.ideasQuery=e.value,L();return}if(e.id==="ideas-tag-filter"){p.ideasTagFilter=e.value,L();return}if(e.id==="inspiration-search"){lT(e.value);return}if(e.id==="mindmap-search"){p.mindmapSearch=e.value;const t=e.value.trim();if(t){const r=Zn(t),s=p.mindmapNodes.find(i=>{const o=[i.title,i.summary,...i.tags??[]].filter(Boolean).join(" ");return Zn(o).includes(r)});s&&(p.mindmapSelectedNodeId=s.id,mT(s),gT(s.id))}P();return}if(e.dataset.mindmapField){const t=e.dataset.mindmapField,r=e.dataset.id;if(r){const s=e.value;if(t==="tags"){const i=Li(s);Ka(r,{tags:i});return}Ka(r,{[t]:s});return}}if(e.dataset.ideaField){const t=e.dataset.ideaField,r=e.dataset.id;if(r){if(t==="tags"){const s=Li(e.value);ed(r,{tags:s});return}ed(r,{[t]:e.value});return}}if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){const t=e.dataset.characterField,r=e.dataset.characterMeta||null;if(t){bp(t,e.value,r);return}}e.id==="chapter-content"&&await xp(e.value)}});fe.addEventListener("focusout",async n=>{const e=n.target;if(e instanceof Element&&e.dataset.ideaField){const t=e.dataset.id;t&&await wp(t,{render:!1})}});fe.addEventListener("change",async n=>{const e=n.target;if(!(e instanceof HTMLInputElement||e instanceof HTMLSelectElement))return;if(e.dataset.characterField){const r=e.dataset.characterField,s=e.dataset.characterMeta||null;bp(r,e.value,s);return}if(e.dataset.mindmapField){const r=e.dataset.mindmapField,s=e.dataset.id;s&&Ka(s,{[r]:e.value});return}if(e.dataset.ideaField){const r=e.dataset.ideaField,s=e.dataset.id;if(s){if(r==="tags"){const i=Li(e.value);await Wa(s,{tags:i},{render:!0});return}await Wa(s,{[r]:e.value},{render:!0})}return}if(e.id==="inspiration-tag-filter"){cT(e.value);return}if(e.id==="ideas-status-filter"){p.ideasStatusFilter=e.value,L();return}if(e.id==="ideas-sort"){p.ideasSort=e.value,L();return}if(e.id==="mindmap-create-type"){p.mindmapCreateType=e.value;return}if(e.id==="inspiration-image-input"){const r=e.files?.[0]??null;if(!r)return;const s=new FileReader;s.onload=()=>{const i=typeof s.result=="string"?s.result:"";if(!i)return;const o=p.inspirationModal?.draft??{};p.inspirationModal={...p.inspirationModal??{},open:!0,step:"form",type:"image",draft:{...o,image_data:i}},P()},s.readAsDataURL(r);return}if(e.id==="character-avatar-input"){const r=e.files?.[0]??null;if(!r)return;const s=new FileReader;s.onload=async()=>{const i=typeof s.result=="string"?s.result:"",o=ji();o&&i&&(await Vs(o.id,{avatar_url:i}),await tn(),P())},s.readAsDataURL(r);return}if(e.id==="character-physique-input"){const r=e.files?.[0]??null;if(!r)return;const s=new FileReader;s.onload=async()=>{const i=typeof s.result=="string"?s.result:"",o=ji();if(o&&i){const a={...o.meta??{},physique:{...o.meta?.physique??{},image_url:i}};await Vs(o.id,{meta:a}),await tn(),P()}},s.readAsDataURL(r);return}if(e.id!=="home-backup-file")return;const t=e.files?.[0]??null;await kT(t),e.value=""});document.addEventListener("click",n=>{if(!p.accountMenuOpen)return;const e=n.target;e instanceof Element&&(e.closest(".topbar-account")||e.closest(".topbar-backup"))||(p.accountMenuOpen=!1,p.backupMenuOpen=!1,L())});document.addEventListener("click",n=>{if(!p.projectsMenuOpenId)return;const e=n.target;e instanceof Element&&(e.closest(".project-menu")||e.closest(".project-menu-toggle")||(p.projectsMenuOpenId=null,L()))});document.addEventListener("keydown",n=>{const e=n.target,t=e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLElement&&e.isContentEditable;if(n.key==="Escape"){if(!p.accountMenuOpen&&!p.backupMenuOpen)return;p.accountMenuOpen=!1,p.backupMenuOpen=!1,L();return}if(t)return;const r=n.key.toLowerCase(),s=(n.ctrlKey||n.metaKey)&&n.shiftKey&&r==="i",i=n.ctrlKey&&n.altKey&&r==="i";if(s||i){n.preventDefault(),p.accountMenuOpen=!1,p.backupMenuOpen=!1;const o=Ot();window.location.hash=o?`#/project/${o}/ideas`:"#/projects"}});fe.addEventListener("keydown",async n=>{const e=n.target;if(e instanceof HTMLInputElement&&e.classList.contains("project-edit-input")){if(n.key==="Enter"){n.preventDefault();const t=e.dataset.id;t&&await _p(t,e.value);return}n.key==="Escape"&&(n.preventDefault(),p.editingProjectId=null,L())}});fe.addEventListener("keydown",async n=>{const e=n.target;if(!(e instanceof HTMLTextAreaElement)||e.id!=="ideas-create-input"||n.key!=="Enter"||n.shiftKey)return;n.preventDefault();const t=e.value;await tT(t),e.value=""});fe.addEventListener("keydown",n=>{const e=n.target;if(e instanceof HTMLElement&&!(e.dataset.action!=="projects-open"||e.tagName==="BUTTON")&&(n.key==="Enter"||n.key===" ")){n.preventDefault();const t=e.dataset.id;if(!t||p.editingProjectId===t)return;rt(t),p.projectsMenuOpenId=null,window.location.hash=`#/project/${t}/write`}});async function Ep(){const{page:n,props:e}=await jy();if(ql(),n==="editor"){p.accountMenuOpen=!1,p.backupMenuOpen=!1,qe=e.userEmail,Ns(!!qe),await Qo(),Yu||(Eb(uo),Yu=!0),e.writingNav&&(p.writingNav=e.writingNav),await Sp(e.projectId);return}if(Vl(),n==="home"){p.accountMenuOpen=!1,p.backupMenuOpen=!1,qe=e.userEmail,Ns(!!qe),await Qo(),await pp();return}if(n==="projects"){p.accountMenuOpen=!1,p.backupMenuOpen=!1,qe=e.userEmail,Ns(!!qe),await Qo(),await mp();return}fe.innerHTML=By({message:e.message}),Ns(!1),qa=!1,mr=!1;const t=document.querySelector("#sign-in"),r=document.querySelector("#sign-up");t&&t.addEventListener("click",async()=>{const{email:s,password:i}=Xu(),o=await $y(s,i);if(!o.ok){Zo(o.errorMessage);return}window.location.hash="#/home"}),r&&r.addEventListener("click",async()=>{const{email:s,password:i}=Xu(),o=await Py(s,i);if(!o.ok){Zo(o.errorMessage);return}Zo("Compte cree. Verifie tes emails si besoin.")})}window.addEventListener("hashchange",Ep);Ep();
