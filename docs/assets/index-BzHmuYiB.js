(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function Lo(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t}function fy(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(d){try{c(r.next(d))}catch(h){o(h)}}function l(d){try{c(r.throw(d))}catch(h){o(h)}}function c(d){d.done?i(d.value):s(d.value).then(a,l)}c((r=r.apply(n,e||[])).next())})}const py=n=>n?(...e)=>n(...e):(...e)=>fetch(...e);class cc extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class my extends cc{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class vd extends cc{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class kd extends cc{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var fl;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(fl||(fl={}));class gy{constructor(e,{headers:t={},customFetch:r,region:s=fl.Any}={}){this.url=e,this.headers=t,this.region=s,this.fetch=py(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return fy(this,arguments,void 0,function*(t,r={}){var s;let i,o;try{const{headers:a,method:l,body:c,signal:d,timeout:h}=r;let f={},{region:p}=r;p||(p=this.region);const m=new URL(`${this.url}/${t}`);p&&p!=="any"&&(f["x-region"]=p,m.searchParams.set("forceFunctionRegion",p));let g;c&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(f["Content-Type"]="application/octet-stream",g=c):typeof c=="string"?(f["Content-Type"]="text/plain",g=c):typeof FormData<"u"&&c instanceof FormData?g=c:(f["Content-Type"]="application/json",g=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?g=JSON.stringify(c):g=c;let y=d;h&&(o=new AbortController,i=setTimeout(()=>o.abort(),h),d?(y=o.signal,d.addEventListener("abort",()=>o.abort())):y=o.signal);const w=yield this.fetch(m.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},f),this.headers),a),body:g,signal:y}).catch(k=>{throw new my(k)}),v=w.headers.get("x-relay-error");if(v&&v==="true")throw new vd(w);if(!w.ok)throw new kd(w);let b=((s=w.headers.get("Content-Type"))!==null&&s!==void 0?s:"text/plain").split(";")[0].trim(),S;return b==="application/json"?S=yield w.json():b==="application/octet-stream"||b==="application/pdf"?S=yield w.blob():b==="text/event-stream"?S=w:b==="multipart/form-data"?S=yield w.formData():S=yield w.text(),{data:S,error:null,response:w}}catch(a){return{data:null,error:a,response:a instanceof kd||a instanceof vd?a.context:void 0}}finally{i&&clearTimeout(i)}})}}var yy=class extends Error{constructor(n){super(n.message),this.name="PostgrestError",this.details=n.details,this.hint=n.hint,this.code=n.code}},wy=class{constructor(n){var e,t;this.shouldThrowOnError=!1,this.method=n.method,this.url=n.url,this.headers=new Headers(n.headers),this.schema=n.schema,this.body=n.body,this.shouldThrowOnError=(e=n.shouldThrowOnError)!==null&&e!==void 0?e:!1,this.signal=n.signal,this.isMaybeSingle=(t=n.isMaybeSingle)!==null&&t!==void 0?t:!1,n.fetch?this.fetch=n.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(n,e){return this.headers=new Headers(this.headers),this.headers.set(n,e),this}then(n,e){var t=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const r=this.fetch;let s=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{let o=null,a=null,l=null,c=i.status,d=i.statusText;if(i.ok){var h,f;if(t.method!=="HEAD"){var p;const w=await i.text();w===""||(t.headers.get("Accept")==="text/csv"||t.headers.get("Accept")&&(!((p=t.headers.get("Accept"))===null||p===void 0)&&p.includes("application/vnd.pgrst.plan+text"))?a=w:a=JSON.parse(w))}const g=(h=t.headers.get("Prefer"))===null||h===void 0?void 0:h.match(/count=(exact|planned|estimated)/),y=(f=i.headers.get("content-range"))===null||f===void 0?void 0:f.split("/");g&&y&&y.length>1&&(l=parseInt(y[1])),t.isMaybeSingle&&t.method==="GET"&&Array.isArray(a)&&(a.length>1?(o={code:"PGRST116",details:`Results contain ${a.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},a=null,l=null,c=406,d="Not Acceptable"):a.length===1?a=a[0]:a=null)}else{var m;const g=await i.text();try{o=JSON.parse(g),Array.isArray(o)&&i.status===404&&(a=[],o=null,c=200,d="OK")}catch{i.status===404&&g===""?(c=204,d="No Content"):o={message:g}}if(o&&t.isMaybeSingle&&(!(o==null||(m=o.details)===null||m===void 0)&&m.includes("0 rows"))&&(o=null,c=200,d="OK"),o&&t.shouldThrowOnError)throw new yy(o)}return{error:o,data:a,count:l,status:c,statusText:d}});return this.shouldThrowOnError||(s=s.catch(i=>{var o;let a="";const l=i?.cause;if(l){var c,d,h,f;const m=(c=l?.message)!==null&&c!==void 0?c:"",g=(d=l?.code)!==null&&d!==void 0?d:"";a=`${(h=i?.name)!==null&&h!==void 0?h:"FetchError"}: ${i?.message}`,a+=`

Caused by: ${(f=l?.name)!==null&&f!==void 0?f:"Error"}: ${m}`,g&&(a+=` (${g})`),l?.stack&&(a+=`
${l.stack}`)}else{var p;a=(p=i?.stack)!==null&&p!==void 0?p:""}return{error:{message:`${(o=i?.name)!==null&&o!==void 0?o:"FetchError"}: ${i?.message}`,details:a,hint:"",code:""},data:null,count:null,status:0,statusText:""}})),s.then(n,e)}returns(){return this}overrideTypes(){return this}},by=class extends wy{select(n){let e=!1;const t=(n??"*").split("").map(r=>/\s/.test(r)&&!e?"":(r==='"'&&(e=!e),r)).join("");return this.url.searchParams.set("select",t),this.headers.append("Prefer","return=representation"),this}order(n,{ascending:e=!0,nullsFirst:t,foreignTable:r,referencedTable:s=r}={}){const i=s?`${s}.order`:"order",o=this.url.searchParams.get(i);return this.url.searchParams.set(i,`${o?`${o},`:""}${n}.${e?"asc":"desc"}${t===void 0?"":t?".nullsfirst":".nullslast"}`),this}limit(n,{foreignTable:e,referencedTable:t=e}={}){const r=typeof t>"u"?"limit":`${t}.limit`;return this.url.searchParams.set(r,`${n}`),this}range(n,e,{foreignTable:t,referencedTable:r=t}={}){const s=typeof r>"u"?"offset":`${r}.offset`,i=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(s,`${n}`),this.url.searchParams.set(i,`${e-n+1}`),this}abortSignal(n){return this.signal=n,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:n=!1,verbose:e=!1,settings:t=!1,buffers:r=!1,wal:s=!1,format:i="text"}={}){var o;const a=[n?"analyze":null,e?"verbose":null,t?"settings":null,r?"buffers":null,s?"wal":null].filter(Boolean).join("|"),l=(o=this.headers.get("Accept"))!==null&&o!==void 0?o:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${i}; for="${l}"; options=${a};`),i==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(n){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${n}`),this}};const Sd=new RegExp("[,()]");var dr=class extends by{eq(n,e){return this.url.searchParams.append(n,`eq.${e}`),this}neq(n,e){return this.url.searchParams.append(n,`neq.${e}`),this}gt(n,e){return this.url.searchParams.append(n,`gt.${e}`),this}gte(n,e){return this.url.searchParams.append(n,`gte.${e}`),this}lt(n,e){return this.url.searchParams.append(n,`lt.${e}`),this}lte(n,e){return this.url.searchParams.append(n,`lte.${e}`),this}like(n,e){return this.url.searchParams.append(n,`like.${e}`),this}likeAllOf(n,e){return this.url.searchParams.append(n,`like(all).{${e.join(",")}}`),this}likeAnyOf(n,e){return this.url.searchParams.append(n,`like(any).{${e.join(",")}}`),this}ilike(n,e){return this.url.searchParams.append(n,`ilike.${e}`),this}ilikeAllOf(n,e){return this.url.searchParams.append(n,`ilike(all).{${e.join(",")}}`),this}ilikeAnyOf(n,e){return this.url.searchParams.append(n,`ilike(any).{${e.join(",")}}`),this}regexMatch(n,e){return this.url.searchParams.append(n,`match.${e}`),this}regexIMatch(n,e){return this.url.searchParams.append(n,`imatch.${e}`),this}is(n,e){return this.url.searchParams.append(n,`is.${e}`),this}isDistinct(n,e){return this.url.searchParams.append(n,`isdistinct.${e}`),this}in(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&Sd.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`in.(${t})`),this}notIn(n,e){const t=Array.from(new Set(e)).map(r=>typeof r=="string"&&Sd.test(r)?`"${r}"`:`${r}`).join(",");return this.url.searchParams.append(n,`not.in.(${t})`),this}contains(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cs.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cs.{${e.join(",")}}`):this.url.searchParams.append(n,`cs.${JSON.stringify(e)}`),this}containedBy(n,e){return typeof e=="string"?this.url.searchParams.append(n,`cd.${e}`):Array.isArray(e)?this.url.searchParams.append(n,`cd.{${e.join(",")}}`):this.url.searchParams.append(n,`cd.${JSON.stringify(e)}`),this}rangeGt(n,e){return this.url.searchParams.append(n,`sr.${e}`),this}rangeGte(n,e){return this.url.searchParams.append(n,`nxl.${e}`),this}rangeLt(n,e){return this.url.searchParams.append(n,`sl.${e}`),this}rangeLte(n,e){return this.url.searchParams.append(n,`nxr.${e}`),this}rangeAdjacent(n,e){return this.url.searchParams.append(n,`adj.${e}`),this}overlaps(n,e){return typeof e=="string"?this.url.searchParams.append(n,`ov.${e}`):this.url.searchParams.append(n,`ov.{${e.join(",")}}`),this}textSearch(n,e,{config:t,type:r}={}){let s="";r==="plain"?s="pl":r==="phrase"?s="ph":r==="websearch"&&(s="w");const i=t===void 0?"":`(${t})`;return this.url.searchParams.append(n,`${s}fts${i}.${e}`),this}match(n){return Object.entries(n).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(n,e,t){return this.url.searchParams.append(n,`not.${e}.${t}`),this}or(n,{foreignTable:e,referencedTable:t=e}={}){const r=t?`${t}.or`:"or";return this.url.searchParams.append(r,`(${n})`),this}filter(n,e,t){return this.url.searchParams.append(n,`${e}.${t}`),this}},vy=class{constructor(n,{headers:e={},schema:t,fetch:r}){this.url=n,this.headers=new Headers(e),this.schema=t,this.fetch=r}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(n,e){const{head:t=!1,count:r}=e??{},s=t?"HEAD":"GET";let i=!1;const o=(n??"*").split("").map(c=>/\s/.test(c)&&!i?"":(c==='"'&&(i=!i),c)).join(""),{url:a,headers:l}=this.cloneRequestState();return a.searchParams.set("select",o),r&&l.append("Prefer",`count=${r}`),new dr({method:s,url:a,headers:l,schema:this.schema,fetch:this.fetch})}insert(n,{count:e,defaultToNull:t=!0}={}){var r;const s="POST",{url:i,headers:o}=this.cloneRequestState();if(e&&o.append("Prefer",`count=${e}`),t||o.append("Prefer","missing=default"),Array.isArray(n)){const a=n.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(a.length>0){const l=[...new Set(a)].map(c=>`"${c}"`);i.searchParams.set("columns",l.join(","))}}return new dr({method:s,url:i,headers:o,schema:this.schema,body:n,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch})}upsert(n,{onConflict:e,ignoreDuplicates:t=!1,count:r,defaultToNull:s=!0}={}){var i;const o="POST",{url:a,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${t?"ignore":"merge"}-duplicates`),e!==void 0&&a.searchParams.set("on_conflict",e),r&&l.append("Prefer",`count=${r}`),s||l.append("Prefer","missing=default"),Array.isArray(n)){const c=n.reduce((d,h)=>d.concat(Object.keys(h)),[]);if(c.length>0){const d=[...new Set(c)].map(h=>`"${h}"`);a.searchParams.set("columns",d.join(","))}}return new dr({method:o,url:a,headers:l,schema:this.schema,body:n,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch})}update(n,{count:e}={}){var t;const r="PATCH",{url:s,headers:i}=this.cloneRequestState();return e&&i.append("Prefer",`count=${e}`),new dr({method:r,url:s,headers:i,schema:this.schema,body:n,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch})}delete({count:n}={}){var e;const t="DELETE",{url:r,headers:s}=this.cloneRequestState();return n&&s.append("Prefer",`count=${n}`),new dr({method:t,url:r,headers:s,schema:this.schema,fetch:(e=this.fetch)!==null&&e!==void 0?e:fetch})}},ky=class Ah{constructor(e,{headers:t={},schema:r,fetch:s}={}){this.url=e,this.headers=new Headers(t),this.schemaName=r,this.fetch=s}from(e){if(!e||typeof e!="string"||e.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new vy(new URL(`${this.url}/${e}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new Ah(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,get:s=!1,count:i}={}){var o;let a;const l=new URL(`${this.url}/rpc/${e}`);let c;const d=p=>p!==null&&typeof p=="object"&&(!Array.isArray(p)||p.some(d)),h=r&&Object.values(t).some(d);h?(a="POST",c=t):r||s?(a=r?"HEAD":"GET",Object.entries(t).filter(([p,m])=>m!==void 0).map(([p,m])=>[p,Array.isArray(m)?`{${m.join(",")}}`:`${m}`]).forEach(([p,m])=>{l.searchParams.append(p,m)})):(a="POST",c=t);const f=new Headers(this.headers);return h?f.set("Prefer",i?`count=${i},return=minimal`:"return=minimal"):i&&f.set("Prefer",`count=${i}`),new dr({method:a,url:l,headers:f,schema:this.schemaName,body:c,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}};class Sy{constructor(){}static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const t=globalThis.process;if(t){const r=t.versions;if(r&&r.node){const s=r.node,i=parseInt(s.replace(/^v/,"").split(".")[0]);return i>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${i} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${i} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const _y="2.90.1",xy=`realtime-js/${_y}`,Mh="1.0.0",Ty="2.0.0",_d=Mh,pl=1e4,Ey=1e3,Cy=100;var Jt;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(Jt||(Jt={}));var ke;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(ke||(ke={}));var ut;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(ut||(ut={}));var ml;(function(n){n.websocket="websocket"})(ml||(ml={}));var Mn;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(Mn||(Mn={}));class Ay{constructor(e){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=e??[]}encode(e,t){if(e.event===this.BROADCAST_EVENT&&!(e.payload instanceof ArrayBuffer)&&typeof e.payload.event=="string")return t(this._binaryEncodeUserBroadcastPush(e));let r=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(r))}_binaryEncodeUserBroadcastPush(e){var t;return this._isArrayBuffer((t=e.payload)===null||t===void 0?void 0:t.payload)?this._encodeBinaryUserBroadcastPush(e):this._encodeJsonUserBroadcastPush(e)}_encodeBinaryUserBroadcastPush(e){var t,r;const s=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:new ArrayBuffer(0);return this._encodeUserBroadcastPush(e,this.BINARY_ENCODING,s)}_encodeJsonUserBroadcastPush(e){var t,r;const s=(r=(t=e.payload)===null||t===void 0?void 0:t.payload)!==null&&r!==void 0?r:{},o=new TextEncoder().encode(JSON.stringify(s)).buffer;return this._encodeUserBroadcastPush(e,this.JSON_ENCODING,o)}_encodeUserBroadcastPush(e,t,r){var s,i;const o=e.topic,a=(s=e.ref)!==null&&s!==void 0?s:"",l=(i=e.join_ref)!==null&&i!==void 0?i:"",c=e.payload.event,d=this.allowedMetadataKeys?this._pick(e.payload,this.allowedMetadataKeys):{},h=Object.keys(d).length===0?"":JSON.stringify(d);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(a.length>255)throw new Error(`ref length ${a.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`topic length ${o.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(h.length>255)throw new Error(`metadata length ${h.length} exceeds maximum of 255`);const f=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+a.length+o.length+c.length+h.length,p=new ArrayBuffer(this.HEADER_LENGTH+f);let m=new DataView(p),g=0;m.setUint8(g++,this.KINDS.userBroadcastPush),m.setUint8(g++,l.length),m.setUint8(g++,a.length),m.setUint8(g++,o.length),m.setUint8(g++,c.length),m.setUint8(g++,h.length),m.setUint8(g++,t),Array.from(l,w=>m.setUint8(g++,w.charCodeAt(0))),Array.from(a,w=>m.setUint8(g++,w.charCodeAt(0))),Array.from(o,w=>m.setUint8(g++,w.charCodeAt(0))),Array.from(c,w=>m.setUint8(g++,w.charCodeAt(0))),Array.from(h,w=>m.setUint8(g++,w.charCodeAt(0)));var y=new Uint8Array(p.byteLength+r.byteLength);return y.set(new Uint8Array(p),0),y.set(new Uint8Array(r),p.byteLength),y.buffer}decode(e,t){if(this._isArrayBuffer(e)){let r=this._binaryDecode(e);return t(r)}if(typeof e=="string"){const r=JSON.parse(e),[s,i,o,a,l]=r;return t({join_ref:s,ref:i,topic:o,event:a,payload:l})}return t({})}_binaryDecode(e){const t=new DataView(e),r=t.getUint8(0),s=new TextDecoder;if(r===this.KINDS.userBroadcast)return this._decodeUserBroadcast(e,t,s)}_decodeUserBroadcast(e,t,r){const s=t.getUint8(1),i=t.getUint8(2),o=t.getUint8(3),a=t.getUint8(4);let l=this.HEADER_LENGTH+4;const c=r.decode(e.slice(l,l+s));l=l+s;const d=r.decode(e.slice(l,l+i));l=l+i;const h=r.decode(e.slice(l,l+o));l=l+o;const f=e.slice(l,e.byteLength),p=a===this.JSON_ENCODING?JSON.parse(r.decode(f)):f,m={type:this.BROADCAST_EVENT,event:d,payload:p};return o>0&&(m.meta=JSON.parse(h)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:m}}_isArrayBuffer(e){var t;return e instanceof ArrayBuffer||((t=e?.constructor)===null||t===void 0?void 0:t.name)==="ArrayBuffer"}_pick(e,t){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([r])=>t.includes(r)))}}class Ih{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var se;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(se||(se={}));const xd=(n,e,t={})=>{var r;const s=(r=t.skipTypes)!==null&&r!==void 0?r:[];return e?Object.keys(e).reduce((i,o)=>(i[o]=My(o,n,e,s),i),{}):{}},My=(n,e,t,r)=>{const s=e.find(a=>a.name===n),i=s?.type,o=t[n];return i&&!r.includes(i)?Oh(i,o):gl(o)},Oh=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return $y(e,t)}switch(n){case se.bool:return Iy(e);case se.float4:case se.float8:case se.int2:case se.int4:case se.int8:case se.numeric:case se.oid:return Oy(e);case se.json:case se.jsonb:return Ny(e);case se.timestamp:return Ry(e);case se.abstime:case se.date:case se.daterange:case se.int4range:case se.int8range:case se.money:case se.reltime:case se.text:case se.time:case se.timestamptz:case se.timetz:case se.tsrange:case se.tstzrange:return gl(e);default:return gl(e)}},gl=n=>n,Iy=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Oy=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Ny=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch{return n}return n},$y=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let i;const o=n.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(a=>Oh(e,a))}return n},Ry=n=>typeof n=="string"?n.replace(" ","T"):n,Nh=n=>{const e=new URL(n);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class xa{constructor(e,t,r={},s=pl){this.channel=e,this.event=t,this.payload=r,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Td;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(Td||(Td={}));class es{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},s=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.joinRef=this.channel._joinRef(),this.state=es.syncState(this.state,s,i,o),this.pendingDiffs.forEach(l=>{this.state=es.syncDiff(this.state,l,i,o)}),this.pendingDiffs=[],a()}),this.channel._on(r.diff,{},s=>{const{onJoin:i,onLeave:o,onSync:a}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=es.syncDiff(this.state,s,i,o),a())}),this.onJoin((s,i,o)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:o})}),this.onLeave((s,i,o)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,s){const i=this.cloneDeep(e),o=this.transformState(t),a={},l={};return this.map(i,(c,d)=>{o[c]||(l[c]=d)}),this.map(o,(c,d)=>{const h=i[c];if(h){const f=d.map(y=>y.presence_ref),p=h.map(y=>y.presence_ref),m=d.filter(y=>p.indexOf(y.presence_ref)<0),g=h.filter(y=>f.indexOf(y.presence_ref)<0);m.length>0&&(a[c]=m),g.length>0&&(l[c]=g)}else a[c]=d}),this.syncDiff(i,{joins:a,leaves:l},r,s)}static syncDiff(e,t,r,s){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),s||(s=()=>{}),this.map(i,(a,l)=>{var c;const d=(c=e[a])!==null&&c!==void 0?c:[];if(e[a]=this.cloneDeep(l),d.length>0){const h=e[a].map(p=>p.presence_ref),f=d.filter(p=>h.indexOf(p.presence_ref)<0);e[a].unshift(...f)}r(a,d,l)}),this.map(o,(a,l)=>{let c=e[a];if(!c)return;const d=l.map(h=>h.presence_ref);c=c.filter(h=>d.indexOf(h.presence_ref)<0),e[a]=c,s(a,c,l),c.length===0&&delete e[a]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const s=e[r];return"metas"in s?t[r]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[r]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Ed;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(Ed||(Ed={}));var ts;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(ts||(ts={}));var Rt;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(Rt||(Rt={}));class yr{constructor(e,t={config:{}},r){var s,i;if(this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=ke.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new xa(this,ut.join,this.params,this.timeout),this.rejoinTimer=new Ih(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=ke.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(o=>o.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=ke.closed,this.socket._remove(this)}),this._onError(o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=ke.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=ke.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",o=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,o),this.state=ke.errored,this.rejoinTimer.scheduleTimeout())}),this._on(ut.reply,{},(o,a)=>{this._trigger(this._replyEventName(a),o)}),this.presence=new es(this),this.broadcastEndpointURL=Nh(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((i=(s=this.params.config)===null||s===void 0?void 0:s.broadcast)===null||i===void 0)&&i.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var r,s,i;if(this.socket.isConnected()||this.socket.connect(),this.state==ke.closed){const{config:{broadcast:o,presence:a,private:l}}=this.params,c=(s=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(p=>p.filter))!==null&&s!==void 0?s:[],d=!!this.bindings[ts.PRESENCE]&&this.bindings[ts.PRESENCE].length>0||((i=this.params.config.presence)===null||i===void 0?void 0:i.enabled)===!0,h={},f={broadcast:o,presence:Object.assign(Object.assign({},a),{enabled:d}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(h.access_token=this.socket.accessTokenValue),this._onError(p=>e?.(Rt.CHANNEL_ERROR,p)),this._onClose(()=>e?.(Rt.CLOSED)),this.updateJoinPayload(Object.assign({config:f},h)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:p})=>{var m;if(this.socket._isManualToken()||this.socket.setAuth(),p===void 0){e?.(Rt.SUBSCRIBED);return}else{const g=this.bindings.postgres_changes,y=(m=g?.length)!==null&&m!==void 0?m:0,w=[];for(let v=0;v<y;v++){const b=g[v],{filter:{event:S,schema:k,table:_,filter:x}}=b,E=p&&p[v];if(E&&E.event===S&&yr.isFilterValueEqual(E.schema,k)&&yr.isFilterValueEqual(E.table,_)&&yr.isFilterValueEqual(E.filter,x))w.push(Object.assign(Object.assign({},b),{id:E.id}));else{this.unsubscribe(),this.state=ke.errored,e?.(Rt.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=w,e&&e(Rt.SUBSCRIBED);return}}).receive("error",p=>{this.state=ke.errored,e?.(Rt.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(p).join(", ")||"error")))}).receive("timeout",()=>{e?.(Rt.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===ke.joined&&e===ts.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(e,t,r)}async httpSend(e,t,r={}){var s;if(t==null)return Promise.reject("Payload is required for httpSend()");const i={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(i.Authorization=`Bearer ${this.socket.accessTokenValue}`);const o={method:"POST",headers:i,body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},a=await this._fetchWithTimeout(this.broadcastEndpointURL,o,(s=r.timeout)!==null&&s!==void 0?s:this.timeout);if(a.status===202)return{success:!0};let l=a.statusText;try{const c=await a.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(e,t={}){var r,s;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:i,payload:o}=e,a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((s=c.body)===null||s===void 0?void 0:s.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,a,l;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((l=(a=(o=this.params)===null||o===void 0?void 0:o.config)===null||a===void 0?void 0:a.broadcast)===null||l===void 0)&&l.ack)&&i("ok"),c.receive("ok",()=>i("ok")),c.receive("error",()=>i("error")),c.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=ke.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(ut.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(s=>{r=new xa(this,ut.leave,{},e),r.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=ke.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){const s=new AbortController,i=setTimeout(()=>s.abort(),r),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(i),o}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new xa(this,e,t,r);return this._canPush()?s.send():this._addToPushBuffer(s),s}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Cy){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var s,i;const o=e.toLocaleLowerCase(),{close:a,error:l,leave:c,join:d}=ut;if(r&&[a,l,c,d].indexOf(o)>=0&&r!==this._joinRef())return;let f=this._onMessage(o,t,r);if(t&&!f)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(p=>{var m,g,y;return((m=p.filter)===null||m===void 0?void 0:m.event)==="*"||((y=(g=p.filter)===null||g===void 0?void 0:g.event)===null||y===void 0?void 0:y.toLocaleLowerCase())===o}).map(p=>p.callback(f,r)):(i=this.bindings[o])===null||i===void 0||i.filter(p=>{var m,g,y,w,v,b,S,k;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in p){const _=p.id,x=(m=p.filter)===null||m===void 0?void 0:m.event;return _&&((g=t.ids)===null||g===void 0?void 0:g.includes(_))&&(x==="*"||x?.toLocaleLowerCase()===((y=t.data)===null||y===void 0?void 0:y.type.toLocaleLowerCase()))&&(!(!((w=p.filter)===null||w===void 0)&&w.table)||p.filter.table===((v=t.data)===null||v===void 0?void 0:v.table))}else{const _=(S=(b=p?.filter)===null||b===void 0?void 0:b.event)===null||S===void 0?void 0:S.toLocaleLowerCase();return _==="*"||_===((k=t?.event)===null||k===void 0?void 0:k.toLocaleLowerCase())}else return p.type.toLocaleLowerCase()===o}).map(p=>{if(typeof f=="object"&&"ids"in f){const m=f.data,{schema:g,table:y,commit_timestamp:w,type:v,errors:b}=m;f=Object.assign(Object.assign({},{schema:g,table:y,commit_timestamp:w,eventType:v,new:{},old:{},errors:b}),this._getPayloadRecords(m))}p.callback(f,r)})}_isClosed(){return this.state===ke.closed}_isJoined(){return this.state===ke.joined}_isJoining(){return this.state===ke.joining}_isLeaving(){return this.state===ke.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:r};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===r&&yr.isEqual(s.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}static isFilterValueEqual(e,t){return(e??void 0)===(t??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(ut.close,{},e)}_onError(e){this._on(ut.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=ke.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=xd(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=xd(e.columns,e.old_record)),t}}const Ta=()=>{},oi={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Py=[1e3,2e3,5e3,1e4],Dy=1e4,Ly=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class jy{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=pl,this.transport=null,this.heartbeatIntervalMs=oi.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Ta,this.ref=0,this.reconnectTimer=null,this.vsn=_d,this.logger=Ta,this.conn=null,this.sendBuffer=[],this.serializer=new Ay,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=s=>s?(...i)=>s(...i):(...i)=>fetch(...i),!(!((r=t?.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${ml.websocket}`,this.httpEndpoint=Nh(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Sy.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(e?this.conn.close(e,t??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case Jt.connecting:return Mn.Connecting;case Jt.open:return Mn.Open;case Jt.closing:return Mn.Closing;default:return Mn.Closed}}isConnected(){return this.connectionState()===Mn.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const r=`realtime:${e}`,s=this.getChannels().find(i=>i.topic===r);if(s)return s;{const i=new yr(`realtime:${e}`,t,this);return this.channels.push(i),i}}push(e){const{topic:t,event:r,payload:s,ref:i}=e,o=()=>{this.encode(e,a=>{var l;(l=this.conn)===null||l===void 0||l.send(a)})};this.log("push",`${t} ${r} (${i})`,s),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Ey,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},oi.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply"&&t.ref&&t.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error",c)}catch(d){this.log("error","error in heartbeat callback",d)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:r,event:s,payload:i,ref:o}=t,a=o?`(${o})`:"",l=i.status||"";this.log("receive",`${l} ${r} ${s} ${a}`.trim(),i),this.channels.filter(c=>c._isMember(r)).forEach(c=>c._trigger(s,i,o)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e),this.conn.readyState===Jt.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===Jt.open||this.conn.readyState===Jt.connecting)try{this.conn.close()}catch(e){this.log("error","Error closing connection",e)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(t=>{this.log("error","error waiting for auth on connect",t),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this._terminateWorker()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(ut.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${r}${s}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([Ly],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t,r=!1;if(e)t=e,r=!0;else if(this.accessToken)try{t=await this.accessToken()}catch(s){this.log("error","Error fetching access token from callback",s),t=this.accessTokenValue}else t=this.accessTokenValue;r?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(s=>{const i={access_token:t,version:xy};t&&s.updateJoinPayload(i),s.joinedOnce&&s._isJoined()&&s._push(ut.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this._isManualToken()||this.setAuth().catch(t=>{this.log("error",`Error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(s){this.log("error",`error in ${e} callback`,s)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new Ih(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},oi.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,s,i,o,a,l,c,d,h,f,p;switch(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e?.timeout)!==null&&r!==void 0?r:pl,this.heartbeatIntervalMs=(s=e?.heartbeatIntervalMs)!==null&&s!==void 0?s:oi.HEARTBEAT_INTERVAL,this.worker=(i=e?.worker)!==null&&i!==void 0?i:!1,this.accessToken=(o=e?.accessToken)!==null&&o!==void 0?o:null,this.heartbeatCallback=(a=e?.heartbeatCallback)!==null&&a!==void 0?a:Ta,this.vsn=(l=e?.vsn)!==null&&l!==void 0?l:_d,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e?.reconnectAfterMs)!==null&&c!==void 0?c:(m=>Py[m-1]||Dy),this.vsn){case Mh:this.encode=(d=e?.encode)!==null&&d!==void 0?d:((m,g)=>g(JSON.stringify(m))),this.decode=(h=e?.decode)!==null&&h!==void 0?h:((m,g)=>g(JSON.parse(m)));break;case Ty:this.encode=(f=e?.encode)!==null&&f!==void 0?f:this.serializer.encode.bind(this.serializer),this.decode=(p=e?.decode)!==null&&p!==void 0?p:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}}var ys=class extends Error{constructor(n,e){super(n),this.name="IcebergError",this.status=e.status,this.icebergType=e.icebergType,this.icebergCode=e.icebergCode,this.details=e.details,this.isCommitStateUnknown=e.icebergType==="CommitStateUnknownException"||[500,502,504].includes(e.status)&&e.icebergType?.includes("CommitState")===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function By(n,e,t){const r=new URL(e,n);if(t)for(const[s,i]of Object.entries(t))i!==void 0&&r.searchParams.set(s,i);return r.toString()}async function Fy(n){return!n||n.type==="none"?{}:n.type==="bearer"?{Authorization:`Bearer ${n.token}`}:n.type==="header"?{[n.name]:n.value}:n.type==="custom"?await n.getHeaders():{}}function Uy(n){const e=n.fetchImpl??globalThis.fetch;return{async request({method:t,path:r,query:s,body:i,headers:o}){const a=By(n.baseUrl,r,s),l=await Fy(n.auth),c=await e(a,{method:t,headers:{...i?{"Content-Type":"application/json"}:{},...l,...o},body:i?JSON.stringify(i):void 0}),d=await c.text(),h=(c.headers.get("content-type")||"").includes("application/json"),f=h&&d?JSON.parse(d):d;if(!c.ok){const p=h?f:void 0,m=p?.error;throw new ys(m?.message??`Request failed with status ${c.status}`,{status:c.status,icebergType:m?.type,icebergCode:m?.code,details:p})}return{status:c.status,headers:c.headers,data:f}}}}function ai(n){return n.join("")}var zy=class{constructor(n,e=""){this.client=n,this.prefix=e}async listNamespaces(n){const e=n?{parent:ai(n.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:e})).data.namespaces.map(r=>({namespace:r}))}async createNamespace(n,e){const t={namespace:n.namespace,properties:e?.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:t})).data}async dropNamespace(n){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${ai(n.namespace)}`})}async loadNamespaceMetadata(n){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${ai(n.namespace)}`})).data.properties}}async namespaceExists(n){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${ai(n.namespace)}`}),!0}catch(e){if(e instanceof ys&&e.status===404)return!1;throw e}}async createNamespaceIfNotExists(n,e){try{return await this.createNamespace(n,e)}catch(t){if(t instanceof ys&&t.status===409)return;throw t}}};function nr(n){return n.join("")}var Hy=class{constructor(n,e="",t){this.client=n,this.prefix=e,this.accessDelegation=t}async listTables(n){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${nr(n.namespace)}/tables`})).data.identifiers}async createTable(n,e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${nr(n.namespace)}/tables`,body:e,headers:t})).data.metadata}async updateTable(n,e){const t=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${nr(n.namespace)}/tables/${n.name}`,body:e});return{"metadata-location":t.data["metadata-location"],metadata:t.data.metadata}}async dropTable(n,e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${nr(n.namespace)}/tables/${n.name}`,query:{purgeRequested:String(e?.purge??!1)}})}async loadTable(n){const e={};return this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${nr(n.namespace)}/tables/${n.name}`,headers:e})).data.metadata}async tableExists(n){const e={};this.accessDelegation&&(e["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${nr(n.namespace)}/tables/${n.name}`,headers:e}),!0}catch(t){if(t instanceof ys&&t.status===404)return!1;throw t}}async createTableIfNotExists(n,e){try{return await this.createTable(n,e)}catch(t){if(t instanceof ys&&t.status===409)return await this.loadTable({namespace:n.namespace,name:e.name});throw t}}},Vy=class{constructor(n){let e="v1";n.catalogName&&(e+=`/${n.catalogName}`);const t=n.baseUrl.endsWith("/")?n.baseUrl:`${n.baseUrl}/`;this.client=Uy({baseUrl:t,auth:n.auth,fetchImpl:n.fetch}),this.accessDelegation=n.accessDelegation?.join(","),this.namespaceOps=new zy(this.client,e),this.tableOps=new Hy(this.client,e,this.accessDelegation)}async listNamespaces(n){return this.namespaceOps.listNamespaces(n)}async createNamespace(n,e){return this.namespaceOps.createNamespace(n,e)}async dropNamespace(n){await this.namespaceOps.dropNamespace(n)}async loadNamespaceMetadata(n){return this.namespaceOps.loadNamespaceMetadata(n)}async listTables(n){return this.tableOps.listTables(n)}async createTable(n,e){return this.tableOps.createTable(n,e)}async updateTable(n,e){return this.tableOps.updateTable(n,e)}async dropTable(n,e){await this.tableOps.dropTable(n,e)}async loadTable(n){return this.tableOps.loadTable(n)}async namespaceExists(n){return this.namespaceOps.namespaceExists(n)}async tableExists(n){return this.tableOps.tableExists(n)}async createNamespaceIfNotExists(n,e){return this.namespaceOps.createNamespaceIfNotExists(n,e)}async createTableIfNotExists(n,e){return this.tableOps.createTableIfNotExists(n,e)}},jo=class extends Error{constructor(n){super(n),this.__isStorageError=!0,this.name="StorageError"}};function ce(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}var qy=class extends jo{constructor(n,e,t){super(n),this.name="StorageApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},yl=class extends jo{constructor(n,e){super(n),this.name="StorageUnknownError",this.originalError=e}};const dc=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Wy=()=>Response,wl=n=>{if(Array.isArray(n))return n.map(t=>wl(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,r])=>{const s=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[s]=wl(r)}),e},Ky=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},Gy=n=>!n||typeof n!="string"||n.length===0||n.length>100||n.trim()!==n||n.includes("/")||n.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(n);function ws(n){"@babel/helpers - typeof";return ws=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ws(n)}function Jy(n,e){if(ws(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(ws(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Yy(n){var e=Jy(n,"string");return ws(e)=="symbol"?e:e+""}function Xy(n,e,t){return(e=Yy(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Cd(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,r)}return t}function B(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Cd(Object(t),!0).forEach(function(r){Xy(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):Cd(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const Ea=n=>{var e;return n.msg||n.message||n.error_description||(typeof n.error=="string"?n.error:(e=n.error)===null||e===void 0?void 0:e.message)||JSON.stringify(n)},Qy=async(n,e,t)=>{n instanceof await Wy()&&!t?.noResolveJson?n.json().then(r=>{const s=n.status||500,i=r?.statusCode||s+"";e(new qy(Ea(r),s,i))}).catch(r=>{e(new yl(Ea(r),r))}):e(new yl(Ea(n),n))},Zy=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return n==="GET"||!r?s:(Ky(r)?(s.headers=B({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,e?.duplex&&(s.duplex=e.duplex),B(B({},s),t))};async function js(n,e,t,r,s,i){return new Promise((o,a)=>{n(t,Zy(e,r,s,i)).then(l=>{if(!l.ok)throw l;return r?.noResolveJson?l:l.json()}).then(l=>o(l)).catch(l=>Qy(l,a,r))})}async function bs(n,e,t,r){return js(n,"GET",e,t,r)}async function dt(n,e,t,r,s){return js(n,"POST",e,r,s,t)}async function bl(n,e,t,r,s){return js(n,"PUT",e,r,s,t)}async function ew(n,e,t,r){return js(n,"HEAD",e,B(B({},t),{},{noResolveJson:!0}),r)}async function uc(n,e,t,r,s){return js(n,"DELETE",e,r,s,t)}var tw=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e}then(n,e){return this.execute().then(n,e)}async execute(){var n=this;try{return{data:(await n.downloadFn()).body,error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(ce(e))return{data:null,error:e};throw e}}};let $h;$h=Symbol.toStringTag;var nw=class{constructor(n,e){this.downloadFn=n,this.shouldThrowOnError=e,this[$h]="BlobDownloadBuilder",this.promise=null}asStream(){return new tw(this.downloadFn,this.shouldThrowOnError)}then(n,e){return this.getPromise().then(n,e)}catch(n){return this.getPromise().catch(n)}finally(n){return this.getPromise().finally(n)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var n=this;try{return{data:await(await n.downloadFn()).blob(),error:null}}catch(e){if(n.shouldThrowOnError)throw e;if(ce(e))return{data:null,error:e};throw e}}};const rw={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Ad={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var sw=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1,this.url=n,this.headers=e,this.bucketId=t,this.fetch=dc(r)}throwOnError(){return this.shouldThrowOnError=!0,this}async uploadOrUpdate(n,e,t,r){var s=this;try{let i;const o=B(B({},Ad),r);let a=B(B({},s.headers),n==="POST"&&{"x-upsert":String(o.upsert)});const l=o.metadata;typeof Blob<"u"&&t instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),l&&i.append("metadata",s.encodeMetadata(l)),i.append("",t)):typeof FormData<"u"&&t instanceof FormData?(i=t,i.has("cacheControl")||i.append("cacheControl",o.cacheControl),l&&!i.has("metadata")&&i.append("metadata",s.encodeMetadata(l))):(i=t,a["cache-control"]=`max-age=${o.cacheControl}`,a["content-type"]=o.contentType,l&&(a["x-metadata"]=s.toBase64(s.encodeMetadata(l))),(typeof ReadableStream<"u"&&i instanceof ReadableStream||i&&typeof i=="object"&&"pipe"in i&&typeof i.pipe=="function")&&!o.duplex&&(o.duplex="half")),r?.headers&&(a=B(B({},a),r.headers));const c=s._removeEmptyFolders(e),d=s._getFinalPath(c),h=await(n=="PUT"?bl:dt)(s.fetch,`${s.url}/object/${d}`,i,B({headers:a},o?.duplex?{duplex:o.duplex}:{}));return{data:{path:c,id:h.Id,fullPath:h.Key},error:null}}catch(i){if(s.shouldThrowOnError)throw i;if(ce(i))return{data:null,error:i};throw i}}async upload(n,e,t){return this.uploadOrUpdate("POST",n,e,t)}async uploadToSignedUrl(n,e,t,r){var s=this;const i=s._removeEmptyFolders(n),o=s._getFinalPath(i),a=new URL(s.url+`/object/upload/sign/${o}`);a.searchParams.set("token",e);try{let l;const c=B({upsert:Ad.upsert},r),d=B(B({},s.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&t instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",t)):typeof FormData<"u"&&t instanceof FormData?(l=t,l.append("cacheControl",c.cacheControl)):(l=t,d["cache-control"]=`max-age=${c.cacheControl}`,d["content-type"]=c.contentType),{data:{path:i,fullPath:(await bl(s.fetch,a.toString(),l,{headers:d})).Key},error:null}}catch(l){if(s.shouldThrowOnError)throw l;if(ce(l))return{data:null,error:l};throw l}}async createSignedUploadUrl(n,e){var t=this;try{let r=t._getFinalPath(n);const s=B({},t.headers);e?.upsert&&(s["x-upsert"]="true");const i=await dt(t.fetch,`${t.url}/object/upload/sign/${r}`,{},{headers:s}),o=new URL(t.url+i.url),a=o.searchParams.get("token");if(!a)throw new jo("No token returned by API");return{data:{signedUrl:o.toString(),path:n,token:a},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ce(r))return{data:null,error:r};throw r}}async update(n,e,t){return this.uploadOrUpdate("PUT",n,e,t)}async move(n,e,t){var r=this;try{return{data:await dt(r.fetch,`${r.url}/object/move`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t?.destinationBucket},{headers:r.headers}),error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ce(s))return{data:null,error:s};throw s}}async copy(n,e,t){var r=this;try{return{data:{path:(await dt(r.fetch,`${r.url}/object/copy`,{bucketId:r.bucketId,sourceKey:n,destinationKey:e,destinationBucket:t?.destinationBucket},{headers:r.headers})).Key},error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ce(s))return{data:null,error:s};throw s}}async createSignedUrl(n,e,t){var r=this;try{let s=r._getFinalPath(n),i=await dt(r.fetch,`${r.url}/object/sign/${s}`,B({expiresIn:e},t?.transform?{transform:t.transform}:{}),{headers:r.headers});const o=t?.download?`&download=${t.download===!0?"":t.download}`:"";return i={signedUrl:encodeURI(`${r.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ce(s))return{data:null,error:s};throw s}}async createSignedUrls(n,e,t){var r=this;try{const s=await dt(r.fetch,`${r.url}/object/sign/${r.bucketId}`,{expiresIn:e,paths:n},{headers:r.headers}),i=t?.download?`&download=${t.download===!0?"":t.download}`:"";return{data:s.map(o=>B(B({},o),{},{signedUrl:o.signedURL?encodeURI(`${r.url}${o.signedURL}${i}`):null})),error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ce(s))return{data:null,error:s};throw s}}download(n,e){const t=typeof e?.transform<"u"?"render/image/authenticated":"object",r=this.transformOptsToQueryString(e?.transform||{}),s=r?`?${r}`:"",i=this._getFinalPath(n),o=()=>bs(this.fetch,`${this.url}/${t}/${i}${s}`,{headers:this.headers,noResolveJson:!0});return new nw(o,this.shouldThrowOnError)}async info(n){var e=this;const t=e._getFinalPath(n);try{return{data:wl(await bs(e.fetch,`${e.url}/object/info/${t}`,{headers:e.headers})),error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(ce(r))return{data:null,error:r};throw r}}async exists(n){var e=this;const t=e._getFinalPath(n);try{return await ew(e.fetch,`${e.url}/object/${t}`,{headers:e.headers}),{data:!0,error:null}}catch(r){if(e.shouldThrowOnError)throw r;if(ce(r)&&r instanceof yl){const s=r.originalError;if([400,404].includes(s?.status))return{data:!1,error:r}}throw r}}getPublicUrl(n,e){const t=this._getFinalPath(n),r=[],s=e?.download?`download=${e.download===!0?"":e.download}`:"";s!==""&&r.push(s);const i=typeof e?.transform<"u"?"render/image":"object",o=this.transformOptsToQueryString(e?.transform||{});o!==""&&r.push(o);let a=r.join("&");return a!==""&&(a=`?${a}`),{data:{publicUrl:encodeURI(`${this.url}/${i}/public/${t}${a}`)}}}async remove(n){var e=this;try{return{data:await uc(e.fetch,`${e.url}/object/${e.bucketId}`,{prefixes:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}async list(n,e,t){var r=this;try{const s=B(B(B({},rw),e),{},{prefix:n||""});return{data:await dt(r.fetch,`${r.url}/object/list/${r.bucketId}`,s,{headers:r.headers},t),error:null}}catch(s){if(r.shouldThrowOnError)throw s;if(ce(s))return{data:null,error:s};throw s}}async listV2(n,e){var t=this;try{const r=B({},n);return{data:await dt(t.fetch,`${t.url}/object/list-v2/${t.bucketId}`,r,{headers:t.headers},e),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ce(r))return{data:null,error:r};throw r}}encodeMetadata(n){return JSON.stringify(n)}toBase64(n){return typeof Buffer<"u"?Buffer.from(n).toString("base64"):btoa(n)}_getFinalPath(n){return`${this.bucketId}/${n.replace(/^\/+/,"")}`}_removeEmptyFolders(n){return n.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(n){const e=[];return n.width&&e.push(`width=${n.width}`),n.height&&e.push(`height=${n.height}`),n.resize&&e.push(`resize=${n.resize}`),n.format&&e.push(`format=${n.format}`),n.quality&&e.push(`quality=${n.quality}`),e.join("&")}};const Rh="2.90.1",Ph={"X-Client-Info":`storage-js/${Rh}`};var iw=class{constructor(n,e={},t,r){this.shouldThrowOnError=!1;const s=new URL(n);r?.useNewHostname&&/supabase\.(co|in|red)$/.test(s.hostname)&&!s.hostname.includes("storage.supabase.")&&(s.hostname=s.hostname.replace("supabase.","storage.supabase.")),this.url=s.href.replace(/\/$/,""),this.headers=B(B({},Ph),e),this.fetch=dc(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async listBuckets(n){var e=this;try{const t=e.listBucketOptionsToQueryString(n);return{data:await bs(e.fetch,`${e.url}/bucket${t}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await bs(e.fetch,`${e.url}/bucket/${n}`,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}async createBucket(n,e={public:!1}){var t=this;try{return{data:await dt(t.fetch,`${t.url}/bucket`,{id:n,name:n,type:e.type,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ce(r))return{data:null,error:r};throw r}}async updateBucket(n,e){var t=this;try{return{data:await bl(t.fetch,`${t.url}/bucket/${n}`,{id:n,name:n,public:e.public,file_size_limit:e.fileSizeLimit,allowed_mime_types:e.allowedMimeTypes},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(ce(r))return{data:null,error:r};throw r}}async emptyBucket(n){var e=this;try{return{data:await dt(e.fetch,`${e.url}/bucket/${n}/empty`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await uc(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}listBucketOptionsToQueryString(n){const e={};return n&&("limit"in n&&(e.limit=String(n.limit)),"offset"in n&&(e.offset=String(n.offset)),n.search&&(e.search=n.search),n.sortColumn&&(e.sortColumn=n.sortColumn),n.sortOrder&&(e.sortOrder=n.sortOrder)),Object.keys(e).length>0?"?"+new URLSearchParams(e).toString():""}},ow=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=B(B({},Ph),e),this.fetch=dc(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await dt(e.fetch,`${e.url}/bucket`,{name:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}async listBuckets(n){var e=this;try{const t=new URLSearchParams;n?.limit!==void 0&&t.set("limit",n.limit.toString()),n?.offset!==void 0&&t.set("offset",n.offset.toString()),n?.sortColumn&&t.set("sortColumn",n.sortColumn),n?.sortOrder&&t.set("sortOrder",n.sortOrder),n?.search&&t.set("search",n.search);const r=t.toString(),s=r?`${e.url}/bucket?${r}`:`${e.url}/bucket`;return{data:await bs(e.fetch,s,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await uc(e.fetch,`${e.url}/bucket/${n}`,{},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(ce(t))return{data:null,error:t};throw t}}from(n){var e=this;if(!Gy(n))throw new jo("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const t=new Vy({baseUrl:this.url,catalogName:n,auth:{type:"custom",getHeaders:async()=>e.headers},fetch:this.fetch}),r=this.shouldThrowOnError;return new Proxy(t,{get(s,i){const o=s[i];return typeof o!="function"?o:async(...a)=>{try{return{data:await o.apply(s,a),error:null}}catch(l){if(r)throw l;return{data:null,error:l}}}}})}};const hc={"X-Client-Info":`storage-js/${Rh}`,"Content-Type":"application/json"};var Dh=class extends Error{constructor(n){super(n),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}};function qe(n){return typeof n=="object"&&n!==null&&"__isStorageVectorsError"in n}var Ca=class extends Dh{constructor(n,e,t){super(n),this.name="StorageVectorsApiError",this.status=e,this.statusCode=t}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},aw=class extends Dh{constructor(n,e){super(n),this.name="StorageVectorsUnknownError",this.originalError=e}};const fc=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),lw=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},Md=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),cw=async(n,e,t)=>{if(n&&typeof n=="object"&&"status"in n&&"ok"in n&&typeof n.status=="number"&&!t?.noResolveJson){const r=n.status||500,s=n;if(typeof s.json=="function")s.json().then(i=>{const o=i?.statusCode||i?.code||r+"";e(new Ca(Md(i),r,o))}).catch(()=>{const i=r+"";e(new Ca(s.statusText||`HTTP ${r} error`,r,i))});else{const i=r+"";e(new Ca(s.statusText||`HTTP ${r} error`,r,i))}}else e(new aw(Md(n),n))},dw=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return r?(lw(r)?(s.headers=B({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,B(B({},s),t)):s};async function uw(n,e,t,r,s,i){return new Promise((o,a)=>{n(t,dw(e,r,s,i)).then(l=>{if(!l.ok)throw l;if(r?.noResolveJson)return l;const c=l.headers.get("content-type");return!c||!c.includes("application/json")?{}:l.json()}).then(l=>o(l)).catch(l=>cw(l,a,r))})}async function We(n,e,t,r,s){return uw(n,"POST",e,r,s,t)}var hw=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=B(B({},hc),e),this.fetch=fc(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createIndex(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/CreateIndex`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async getIndex(n,e){var t=this;try{return{data:await We(t.fetch,`${t.url}/GetIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers}),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(qe(r))return{data:null,error:r};throw r}}async listIndexes(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/ListIndexes`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async deleteIndex(n,e){var t=this;try{return{data:await We(t.fetch,`${t.url}/DeleteIndex`,{vectorBucketName:n,indexName:e},{headers:t.headers})||{},error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(qe(r))return{data:null,error:r};throw r}}},fw=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=B(B({},hc),e),this.fetch=fc(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async putVectors(n){var e=this;try{if(n.vectors.length<1||n.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:await We(e.fetch,`${e.url}/PutVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async getVectors(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/GetVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async listVectors(n){var e=this;try{if(n.segmentCount!==void 0){if(n.segmentCount<1||n.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(n.segmentIndex!==void 0&&(n.segmentIndex<0||n.segmentIndex>=n.segmentCount))throw new Error(`segmentIndex must be between 0 and ${n.segmentCount-1}`)}return{data:await We(e.fetch,`${e.url}/ListVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async queryVectors(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/QueryVectors`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async deleteVectors(n){var e=this;try{if(n.keys.length<1||n.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:await We(e.fetch,`${e.url}/DeleteVectors`,n,{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}},pw=class{constructor(n,e={},t){this.shouldThrowOnError=!1,this.url=n.replace(/\/$/,""),this.headers=B(B({},hc),e),this.fetch=fc(t)}throwOnError(){return this.shouldThrowOnError=!0,this}async createBucket(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/CreateVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async getBucket(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/GetVectorBucket`,{vectorBucketName:n},{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async listBuckets(n={}){var e=this;try{return{data:await We(e.fetch,`${e.url}/ListVectorBuckets`,n,{headers:e.headers}),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}async deleteBucket(n){var e=this;try{return{data:await We(e.fetch,`${e.url}/DeleteVectorBucket`,{vectorBucketName:n},{headers:e.headers})||{},error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(qe(t))return{data:null,error:t};throw t}}},mw=class extends pw{constructor(n,e={}){super(n,e.headers||{},e.fetch)}from(n){return new gw(this.url,this.headers,n,this.fetch)}async createBucket(n){var e=()=>super.createBucket,t=this;return e().call(t,n)}async getBucket(n){var e=()=>super.getBucket,t=this;return e().call(t,n)}async listBuckets(n={}){var e=()=>super.listBuckets,t=this;return e().call(t,n)}async deleteBucket(n){var e=()=>super.deleteBucket,t=this;return e().call(t,n)}},gw=class extends hw{constructor(n,e,t,r){super(n,e,r),this.vectorBucketName=t}async createIndex(n){var e=()=>super.createIndex,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName}))}async listIndexes(n={}){var e=()=>super.listIndexes,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName}))}async getIndex(n){var e=()=>super.getIndex,t=this;return e().call(t,t.vectorBucketName,n)}async deleteIndex(n){var e=()=>super.deleteIndex,t=this;return e().call(t,t.vectorBucketName,n)}index(n){return new yw(this.url,this.headers,this.vectorBucketName,n,this.fetch)}},yw=class extends fw{constructor(n,e,t,r,s){super(n,e,s),this.vectorBucketName=t,this.indexName=r}async putVectors(n){var e=()=>super.putVectors,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async getVectors(n){var e=()=>super.getVectors,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async listVectors(n={}){var e=()=>super.listVectors,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async queryVectors(n){var e=()=>super.queryVectors,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}async deleteVectors(n){var e=()=>super.deleteVectors,t=this;return e().call(t,B(B({},n),{},{vectorBucketName:t.vectorBucketName,indexName:t.indexName}))}},ww=class extends iw{constructor(n,e={},t,r){super(n,e,t,r)}from(n){return new sw(this.url,this.headers,n,this.fetch)}get vectors(){return new mw(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new ow(this.url+"/iceberg",this.headers,this.fetch)}};const Lh="2.90.1",ur=30*1e3,vl=3,Aa=vl*ur,bw="http://localhost:9999",vw="supabase.auth.token",kw={"X-Client-Info":`gotrue-js/${Lh}`},kl="X-Supabase-Api-Version",jh={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Sw=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,_w=600*1e3;class vs extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}}function $(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class xw extends vs{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}}function Tw(n){return $(n)&&n.name==="AuthApiError"}class In extends vs{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class Ht extends vs{constructor(e,t,r,s){super(e,r,s),this.name=t,this.status=r}}class Ve extends Ht{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function Ew(n){return $(n)&&n.name==="AuthSessionMissingError"}class rr extends Ht{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class li extends Ht{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class ci extends Ht{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Cw(n){return $(n)&&n.name==="AuthImplicitGrantRedirectError"}class Id extends Ht{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Aw extends Ht{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class Sl extends Ht{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Ma(n){return $(n)&&n.name==="AuthRetryableFetchError"}class Od extends Ht{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}}class _l extends Ht{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const $i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Nd=` 	
\r=`.split(""),Mw=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<Nd.length;e+=1)n[Nd[e].charCodeAt(0)]=-2;for(let e=0;e<$i.length;e+=1)n[$i[e].charCodeAt(0)]=e;return n})();function $d(n,e,t){if(n!==null)for(e.queue=e.queue<<8|n,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t($i[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t($i[r]),e.queuedBits-=6}}function Bh(n,e,t){const r=Mw[n];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function Rd(n){const e=[],t=o=>{e.push(String.fromCodePoint(o))},r={utf8seq:0,codepoint:0},s={queue:0,queuedBits:0},i=o=>{Nw(o,r,t)};for(let o=0;o<n.length;o+=1)Bh(n.charCodeAt(o),s,i);return e.join("")}function Iw(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function Ow(n,e){for(let t=0;t<n.length;t+=1){let r=n.charCodeAt(t);if(r>55295&&r<=56319){const s=(r-55296)*1024&65535;r=(n.charCodeAt(t+1)-56320&65535|s)+65536,t+=1}Iw(r,e)}}function Nw(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let r=1;r<6;r+=1)if((n>>7-r&1)===0){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function vr(n){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};for(let s=0;s<n.length;s+=1)Bh(n.charCodeAt(s),t,r);return new Uint8Array(e)}function $w(n){const e=[];return Ow(n,t=>e.push(t)),new Uint8Array(e)}function Nn(n){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};return n.forEach(s=>$d(s,t,r)),$d(null,t,r),e.join("")}function Rw(n){return Math.round(Date.now()/1e3)+n}function Pw(){return Symbol("auth-callback")}const Me=()=>typeof window<"u"&&typeof document<"u",xn={tested:!1,writable:!1},Fh=()=>{if(!Me())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(xn.tested)return xn.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),xn.tested=!0,xn.writable=!0}catch{xn.tested=!0,xn.writable=!1}return xn.writable};function Dw(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,i)=>{e[i]=s})}catch{}return t.searchParams.forEach((r,s)=>{e[s]=r}),e}const Uh=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Lw=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",hr=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},Tn=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},Ae=async(n,e)=>{await n.removeItem(e)};class Bo{constructor(){this.promise=new Bo.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Bo.promiseConstructor=Promise;function Ia(n){const e=n.split(".");if(e.length!==3)throw new _l("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!Sw.test(e[r]))throw new _l("JWT not in base64url format");return{header:JSON.parse(Rd(e[0])),payload:JSON.parse(Rd(e[1])),signature:vr(e[2]),raw:{header:e[0],payload:e[1]}}}async function jw(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function Bw(n,e){return new Promise((r,s)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await n(i);if(!e(i,null,o)){r(o);return}}catch(o){if(!e(i,o)){s(o);return}}})()})}function Fw(n){return("0"+n.toString(16)).substr(-2)}function Uw(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*r));return s}return crypto.getRandomValues(e),Array.from(e,Fw).join("")}async function zw(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(r);return Array.from(s).map(i=>String.fromCharCode(i)).join("")}async function Hw(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await zw(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function sr(n,e,t=!1){const r=Uw();let s=r;t&&(s+="/PASSWORD_RECOVERY"),await hr(n,`${e}-code-verifier`,s);const i=await Hw(r);return[i,r===i?"plain":"s256"]}const Vw=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function qw(n){const e=n.headers.get(kl);if(!e||!e.match(Vw))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Ww(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function Kw(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Gw=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function ir(n){if(!Gw.test(n))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Oa(){const n={};return new Proxy(n,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Jw(n,e){return new Proxy(n,{get:(t,r,s)=>{if(r==="__isInsecureUserWarningProxy")return!0;if(typeof r=="symbol"){const i=r.toString();if(i==="Symbol(Symbol.toPrimitive)"||i==="Symbol(Symbol.toStringTag)"||i==="Symbol(util.inspect.custom)"||i==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,r,s)}return!e.value&&typeof r=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,r,s)}})}function Pd(n){return JSON.parse(JSON.stringify(n))}const Cn=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),Yw=[502,503,504];async function Dd(n){var e;if(!Lw(n))throw new Sl(Cn(n),0);if(Yw.includes(n.status))throw new Sl(Cn(n),n.status);let t;try{t=await n.json()}catch(i){throw new In(Cn(i),i)}let r;const s=qw(n);if(s&&s.getTime()>=jh["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new Od(Cn(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new Ve}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new Od(Cn(t),n.status,t.weak_password.reasons);throw new xw(Cn(t),n.status||500,r)}const Xw=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};async function j(n,e,t,r){var s;const i=Object.assign({},r?.headers);i[kl]||(i[kl]=jh["2024-01-01"].name),r?.jwt&&(i.Authorization=`Bearer ${r.jwt}`);const o=(s=r?.query)!==null&&s!==void 0?s:{};r?.redirectTo&&(o.redirect_to=r.redirectTo);const a=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",l=await Qw(n,e,t+a,{headers:i,noResolveJson:r?.noResolveJson},{},r?.body);return r?.xform?r?.xform(l):{data:Object.assign({},l),error:null}}async function Qw(n,e,t,r,s,i){const o=Xw(e,r,s,i);let a;try{a=await n(t,Object.assign({},o))}catch(l){throw console.error(l),new Sl(Cn(l),0)}if(a.ok||await Dd(a),r?.noResolveJson)return a;try{return await a.json()}catch(l){await Dd(l)}}function ct(n){var e;let t=null;tb(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=Rw(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function Ld(n){const e=ct(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function Zt(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function Zw(n){return{data:n,error:null}}function eb(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i}=n,o=Lo(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),a={action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i},l=Object.assign({},o);return{data:{properties:a,user:l},error:null}}function jd(n){return n}function tb(n){return n.access_token&&n.refresh_token&&n.expires_in}const Na=["global","local","others"];class nb{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=Uh(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=Na[0]){if(Na.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Na.join(", ")}`);try{return await j(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if($(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await j(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:Zt})}catch(r){if($(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=Lo(e,["options"]),s=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(s.new_email=r?.newEmail,delete s.newEmail),await j(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:eb,redirectTo:t?.redirectTo})}catch(t){if($(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await j(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:Zt})}catch(t){if($(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,s,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},d=await j(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:jd});if(d.error)throw d.error;const h=await d.json(),f=(o=d.headers.get("x-total-count"))!==null&&o!==void 0?o:0,p=(l=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return p.length>0&&(p.forEach(m=>{const g=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),y=JSON.parse(m.split(";")[1].split("=")[1]);c[`${y}Page`]=g}),c.total=parseInt(f)),{data:Object.assign(Object.assign({},h),c),error:null}}catch(c){if($(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){ir(e);try{return await j(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:Zt})}catch(t){if($(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){ir(e);try{return await j(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:Zt})}catch(r){if($(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){ir(e);try{return await j(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:Zt})}catch(r){if($(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){ir(e.userId);try{const{data:t,error:r}=await j(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:r}}catch(t){if($(t))return{data:null,error:t};throw t}}async _deleteFactor(e){ir(e.userId),ir(e.id);try{return{data:await j(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if($(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,r,s,i,o,a,l;try{const c={nextPage:null,lastPage:0,total:0},d=await j(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:jd});if(d.error)throw d.error;const h=await d.json(),f=(o=d.headers.get("x-total-count"))!==null&&o!==void 0?o:0,p=(l=(a=d.headers.get("link"))===null||a===void 0?void 0:a.split(","))!==null&&l!==void 0?l:[];return p.length>0&&(p.forEach(m=>{const g=parseInt(m.split(";")[0].split("=")[1].substring(0,1)),y=JSON.parse(m.split(";")[1].split("=")[1]);c[`${y}Page`]=g}),c.total=parseInt(f)),{data:Object.assign(Object.assign({},h),c),error:null}}catch(c){if($(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(e){try{return await j(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if($(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await j(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if($(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await j(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if($(r))return{data:null,error:r};throw r}}async _deleteOAuthClient(e){try{return await j(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if($(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await j(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if($(t))return{data:null,error:t};throw t}}}function Bd(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}const or={debug:!!(globalThis&&Fh()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class zh extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class rb extends zh{}async function sb(n,e,t){or.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),or.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async s=>{if(s){or.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,s.name);try{return await t()}finally{or.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,s.name)}}else{if(e===0)throw or.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new rb(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(or.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function ib(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function Hh(n){if(!/^0x[a-fA-F0-9]{40}$/.test(n))throw new Error(`@supabase/auth-js: Address "${n}" is invalid.`);return n.toLowerCase()}function ob(n){return parseInt(n,16)}function ab(n){const e=new TextEncoder().encode(n);return"0x"+Array.from(e,r=>r.toString(16).padStart(2,"0")).join("")}function lb(n){var e;const{chainId:t,domain:r,expirationTime:s,issuedAt:i=new Date,nonce:o,notBefore:a,requestId:l,resources:c,scheme:d,uri:h,version:f}=n;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!r)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(o&&o.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${o}`);if(!h)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(f!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${f}`);if(!((e=n.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${n.statement}`)}const p=Hh(n.address),m=d?`${d}://${r}`:r,g=n.statement?`${n.statement}
`:"",y=`${m} wants you to sign in with your Ethereum account:
${p}

${g}`;let w=`URI: ${h}
Version: ${f}
Chain ID: ${t}${o?`
Nonce: ${o}`:""}
Issued At: ${i.toISOString()}`;if(s&&(w+=`
Expiration Time: ${s.toISOString()}`),a&&(w+=`
Not Before: ${a.toISOString()}`),l&&(w+=`
Request ID: ${l}`),c){let v=`
Resources:`;for(const b of c){if(!b||typeof b!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${b}`);v+=`
- ${b}`}w+=v}return`${y}
${w}`}class we extends Error{constructor({message:e,code:t,cause:r,name:s}){var i;super(e,{cause:r}),this.__isWebAuthnError=!0,this.name=(i=s??(r instanceof Error?r.name:void 0))!==null&&i!==void 0?i:"Unknown Error",this.code=t}}class Ri extends we{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function cb({error:n,options:e}){var t,r,s;const{publicKey:i}=e;if(!i)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new we({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else if(n.name==="ConstraintError"){if(((t=i.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new we({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:n});if(e.mediation==="conditional"&&((r=i.authenticatorSelection)===null||r===void 0?void 0:r.userVerification)==="required")return new we({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:n});if(((s=i.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new we({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:n})}else{if(n.name==="InvalidStateError")return new we({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:n});if(n.name==="NotAllowedError")return new we({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="NotSupportedError")return i.pubKeyCredParams.filter(a=>a.type==="public-key").length===0?new we({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:n}):new we({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:n});if(n.name==="SecurityError"){const o=window.location.hostname;if(Vh(o)){if(i.rp.id!==o)return new we({message:`The RP ID "${i.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new we({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="TypeError"){if(i.user.id.byteLength<1||i.user.id.byteLength>64)return new we({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:n})}else if(n.name==="UnknownError")return new we({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new we({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}function db({error:n,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(n.name==="AbortError"){if(e.signal instanceof AbortSignal)return new we({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:n})}else{if(n.name==="NotAllowedError")return new we({message:n.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n});if(n.name==="SecurityError"){const r=window.location.hostname;if(Vh(r)){if(t.rpId!==r)return new we({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:n})}else return new we({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:n})}else if(n.name==="UnknownError")return new we({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:n})}return new we({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:n})}class ub{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const hb=new ub;function fb(n){if(!n)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(n);const{challenge:e,user:t,excludeCredentials:r}=n,s=Lo(n,["challenge","user","excludeCredentials"]),i=vr(e).buffer,o=Object.assign(Object.assign({},t),{id:vr(t.id).buffer}),a=Object.assign(Object.assign({},s),{challenge:i,user:o});if(r&&r.length>0){a.excludeCredentials=new Array(r.length);for(let l=0;l<r.length;l++){const c=r[l];a.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:vr(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return a}function pb(n){if(!n)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(n);const{challenge:e,allowCredentials:t}=n,r=Lo(n,["challenge","allowCredentials"]),s=vr(e).buffer,i=Object.assign(Object.assign({},r),{challenge:s});if(t&&t.length>0){i.allowCredentials=new Array(t.length);for(let o=0;o<t.length;o++){const a=t[o];i.allowCredentials[o]=Object.assign(Object.assign({},a),{id:vr(a.id).buffer,type:a.type||"public-key",transports:a.transports})}}return i}function mb(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n;return{id:n.id,rawId:n.id,response:{attestationObject:Nn(new Uint8Array(n.response.attestationObject)),clientDataJSON:Nn(new Uint8Array(n.response.clientDataJSON))},type:"public-key",clientExtensionResults:n.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function gb(n){var e;if("toJSON"in n&&typeof n.toJSON=="function")return n.toJSON();const t=n,r=n.getClientExtensionResults(),s=n.response;return{id:n.id,rawId:n.id,response:{authenticatorData:Nn(new Uint8Array(s.authenticatorData)),clientDataJSON:Nn(new Uint8Array(s.clientDataJSON)),signature:Nn(new Uint8Array(s.signature)),userHandle:s.userHandle?Nn(new Uint8Array(s.userHandle)):void 0},type:"public-key",clientExtensionResults:r,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Vh(n){return n==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(n)}function Fd(){var n,e;return!!(Me()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((n=navigator?.credentials)===null||n===void 0?void 0:n.create)=="function"&&typeof((e=navigator?.credentials)===null||e===void 0?void 0:e.get)=="function")}async function yb(n){try{const e=await navigator.credentials.create(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ri("Browser returned unexpected credential type",e)}:{data:null,error:new Ri("Empty credential response",e)}}catch(e){return{data:null,error:cb({error:e,options:n})}}}async function wb(n){try{const e=await navigator.credentials.get(n);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Ri("Browser returned unexpected credential type",e)}:{data:null,error:new Ri("Empty credential response",e)}}catch(e){return{data:null,error:db({error:e,options:n})}}}const bb={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},vb={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Pi(...n){const e=s=>s!==null&&typeof s=="object"&&!Array.isArray(s),t=s=>s instanceof ArrayBuffer||ArrayBuffer.isView(s),r={};for(const s of n)if(s)for(const i in s){const o=s[i];if(o!==void 0)if(Array.isArray(o))r[i]=o;else if(t(o))r[i]=o;else if(e(o)){const a=r[i];e(a)?r[i]=Pi(a,o):r[i]=Pi(o)}else r[i]=o}return r}function kb(n,e){return Pi(bb,n,e||{})}function Sb(n,e){return Pi(vb,n,e||{})}class _b{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:r,signal:s},i){try{const{data:o,error:a}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!o)return{data:null,error:a};const l=s??hb.createNewAbortSignal();if(o.webauthn.type==="create"){const{user:c}=o.webauthn.credential_options.publicKey;c.name||(c.name=`${c.id}:${r}`),c.displayName||(c.displayName=c.name)}switch(o.webauthn.type){case"create":{const c=kb(o.webauthn.credential_options.publicKey,i?.create),{data:d,error:h}=await yb({publicKey:c,signal:l});return d?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:d}},error:null}:{data:null,error:h}}case"request":{const c=Sb(o.webauthn.credential_options.publicKey,i?.request),{data:d,error:h}=await wb(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:c,signal:l}));return d?{data:{factorId:e,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:d}},error:null}:{data:null,error:h}}}}catch(o){return $(o)?{data:null,error:o}:{data:null,error:new In("Unexpected error in challenge",o)}}}async _verify({challengeId:e,factorId:t,webauthn:r}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:r})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},i){if(!t)return{data:null,error:new vs("rpId is required for WebAuthn authentication")};try{if(!Fd())return{data:null,error:new In("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:r},signal:s},{request:i});if(!o)return{data:null,error:a};const{webauthn:l}=o;return this._verify({factorId:e,challengeId:o.challengeId,webauthn:{type:l.type,rpId:t,rpOrigins:r,credential_response:l.credential_response}})}catch(o){return $(o)?{data:null,error:o}:{data:null,error:new In("Unexpected error in authenticate",o)}}}async _register({friendlyName:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:r=typeof window<"u"?[window.location.origin]:void 0,signal:s}={}},i){if(!t)return{data:null,error:new vs("rpId is required for WebAuthn registration")};try{if(!Fd())return{data:null,error:new In("Browser does not support WebAuthn",null)};const{data:o,error:a}=await this._enroll({friendlyName:e});if(!o)return await this.client.mfa.listFactors().then(d=>{var h;return(h=d.data)===null||h===void 0?void 0:h.all.find(f=>f.factor_type==="webauthn"&&f.friendly_name===e&&f.status!=="unverified")}).then(d=>d?this.client.mfa.unenroll({factorId:d?.id}):void 0),{data:null,error:a};const{data:l,error:c}=await this._challenge({factorId:o.id,friendlyName:o.friendly_name,webauthn:{rpId:t,rpOrigins:r},signal:s},{create:i});return l?this._verify({factorId:o.id,challengeId:l.challengeId,webauthn:{rpId:t,rpOrigins:r,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(o){return $(o)?{data:null,error:o}:{data:null,error:new In("Unexpected error in register",o)}}}}ib();const xb={url:bw,storageKey:vw,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:kw,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function Ud(n,e,t){return await t()}const ar={};class ks{get jwks(){var e,t;return(t=(e=ar[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){ar[this.storageKey]=Object.assign(Object.assign({},ar[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=ar[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){ar[this.storageKey]=Object.assign(Object.assign({},ar[this.storageKey]),{cachedAt:e})}constructor(e){var t,r,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const i=Object.assign(Object.assign({},xb),e);if(this.storageKey=i.storageKey,this.instanceID=(t=ks.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,ks.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!i.debug,typeof i.debug=="function"&&(this.logger=i.debug),this.instanceID>0&&Me()){const o=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(o),this.logDebugMessages&&console.trace(o)}if(this.persistSession=i.persistSession,this.autoRefreshToken=i.autoRefreshToken,this.admin=new nb({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=Uh(i.fetch),this.lock=i.lock||Ud,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,this.throwOnError=i.throwOnError,this.lockAcquireTimeout=i.lockAcquireTimeout,i.lock?this.lock=i.lock:this.persistSession&&Me()&&(!((r=globalThis?.navigator)===null||r===void 0)&&r.locks)?this.lock=sb:this.lock=Ud,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new _b(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(i.storage?this.storage=i.storage:Fh()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Bd(this.memoryStorage)),i.userStorage&&(this.userStorage=i.userStorage)):(this.memoryStorage={},this.storage=Bd(this.memoryStorage)),Me()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(o){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",o)}(s=this.broadcastChannel)===null||s===void 0||s.addEventListener("message",async o=>{this._debug("received broadcast notification from other tab or client",o),await this._notifyAllSubscribers(o.data.event,o.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${Lh}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},r="none";if(Me()&&(t=Dw(window.location.href),this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce")),Me()&&this.detectSessionInUrl&&r!=="none"){const{data:s,error:i}=await this._getSessionFromURL(t,r);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),Cw(i)){const l=(e=i.details)===null||e===void 0?void 0:e.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:i}}return{error:i}}const{session:o,redirectType:a}=s;return this._debug("#_initialize()","detected session in URL",o,"redirect type",a),await this._saveSession(o),setTimeout(async()=>{a==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return $(t)?this._returnResult({error:t}):this._returnResult({error:new In("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,s;try{const i=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(s=e?.options)===null||s===void 0?void 0:s.captchaToken}},xform:ct}),{data:o,error:a}=i;if(a||!o)return this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if($(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signUp(e){var t,r,s;try{let i;if("email"in e){const{email:d,password:h,options:f}=e;let p=null,m=null;this.flowType==="pkce"&&([p,m]=await sr(this.storage,this.storageKey)),i=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:f?.emailRedirectTo,body:{email:d,password:h,data:(t=f?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:f?.captchaToken},code_challenge:p,code_challenge_method:m},xform:ct})}else if("phone"in e){const{phone:d,password:h,options:f}=e;i=await j(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:h,data:(r=f?.data)!==null&&r!==void 0?r:{},channel:(s=f?.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:f?.captchaToken}},xform:ct})}else throw new li("You must provide either an email or phone number and a password");const{data:o,error:a}=i;if(a||!o)return await Ae(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:a});const l=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(i){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(i))return this._returnResult({data:{user:null,session:null},error:i});throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:o,options:a}=e;t=await j(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:Ld})}else if("phone"in e){const{phone:i,password:o,options:a}=e;t=await j(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:a?.captchaToken}},xform:Ld})}else throw new li("You must provide either an email or phone number and a password");const{data:r,error:s}=t;if(s)return this._returnResult({data:{user:null,session:null},error:s});if(!r||!r.session||!r.user){const i=new rr;return this._returnResult({data:{user:null,session:null},error:i})}return r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),this._returnResult({data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:s})}catch(t){if($(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,r,s,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,r,s,i,o,a,l,c,d,h,f;let p,m;if("message"in e)p=e.message,m=e.signature;else{const{chain:g,wallet:y,statement:w,options:v}=e;let b;if(Me())if(typeof y=="object")b=y;else{const N=window;if("ethereum"in N&&typeof N.ethereum=="object"&&"request"in N.ethereum&&typeof N.ethereum.request=="function")b=N.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof y!="object"||!v?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");b=y}const S=new URL((t=v?.url)!==null&&t!==void 0?t:window.location.href),k=await b.request({method:"eth_requestAccounts"}).then(N=>N).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!k||k.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const _=Hh(k[0]);let x=(r=v?.signInWithEthereum)===null||r===void 0?void 0:r.chainId;if(!x){const N=await b.request({method:"eth_chainId"});x=ob(N)}const E={domain:S.host,address:_,statement:w,uri:S.href,version:"1",chainId:x,nonce:(s=v?.signInWithEthereum)===null||s===void 0?void 0:s.nonce,issuedAt:(o=(i=v?.signInWithEthereum)===null||i===void 0?void 0:i.issuedAt)!==null&&o!==void 0?o:new Date,expirationTime:(a=v?.signInWithEthereum)===null||a===void 0?void 0:a.expirationTime,notBefore:(l=v?.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=v?.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(d=v?.signInWithEthereum)===null||d===void 0?void 0:d.resources};p=lb(E),m=await b.request({method:"personal_sign",params:[ab(p),_]})}try{const{data:g,error:y}=await j(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:p,signature:m},!((h=e.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(f=e.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:ct});if(y)throw y;if(!g||!g.session||!g.user){const w=new rr;return this._returnResult({data:{user:null,session:null},error:w})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:y})}catch(g){if($(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async signInWithSolana(e){var t,r,s,i,o,a,l,c,d,h,f,p;let m,g;if("message"in e)m=e.message,g=e.signature;else{const{chain:y,wallet:w,statement:v,options:b}=e;let S;if(Me())if(typeof w=="object")S=w;else{const _=window;if("solana"in _&&typeof _.solana=="object"&&("signIn"in _.solana&&typeof _.solana.signIn=="function"||"signMessage"in _.solana&&typeof _.solana.signMessage=="function"))S=_.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof w!="object"||!b?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");S=w}const k=new URL((t=b?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in S&&S.signIn){const _=await S.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},b?.signInWithSolana),{version:"1",domain:k.host,uri:k.href}),v?{statement:v}:null));let x;if(Array.isArray(_)&&_[0]&&typeof _[0]=="object")x=_[0];else if(_&&typeof _=="object"&&"signedMessage"in _&&"signature"in _)x=_;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in x&&"signature"in x&&(typeof x.signedMessage=="string"||x.signedMessage instanceof Uint8Array)&&x.signature instanceof Uint8Array)m=typeof x.signedMessage=="string"?x.signedMessage:new TextDecoder().decode(x.signedMessage),g=x.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in S)||typeof S.signMessage!="function"||!("publicKey"in S)||typeof S!="object"||!S.publicKey||!("toBase58"in S.publicKey)||typeof S.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");m=[`${k.host} wants you to sign in with your Solana account:`,S.publicKey.toBase58(),...v?["",v,""]:[""],"Version: 1",`URI: ${k.href}`,`Issued At: ${(s=(r=b?.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&s!==void 0?s:new Date().toISOString()}`,...!((i=b?.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${b.signInWithSolana.notBefore}`]:[],...!((o=b?.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${b.signInWithSolana.expirationTime}`]:[],...!((a=b?.signInWithSolana)===null||a===void 0)&&a.chainId?[`Chain ID: ${b.signInWithSolana.chainId}`]:[],...!((l=b?.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${b.signInWithSolana.nonce}`]:[],...!((c=b?.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${b.signInWithSolana.requestId}`]:[],...!((h=(d=b?.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||h===void 0)&&h.length?["Resources",...b.signInWithSolana.resources.map(x=>`- ${x}`)]:[]].join(`
`);const _=await S.signMessage(new TextEncoder().encode(m),"utf8");if(!_||!(_ instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=_}}try{const{data:y,error:w}=await j(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:m,signature:Nn(g)},!((f=e.options)===null||f===void 0)&&f.captchaToken?{gotrue_meta_security:{captcha_token:(p=e.options)===null||p===void 0?void 0:p.captchaToken}}:null),xform:ct});if(w)throw w;if(!y||!y.session||!y.user){const v=new rr;return this._returnResult({data:{user:null,session:null},error:v})}return y.session&&(await this._saveSession(y.session),await this._notifyAllSubscribers("SIGNED_IN",y.session)),this._returnResult({data:Object.assign({},y),error:w})}catch(y){if($(y))return this._returnResult({data:{user:null,session:null},error:y});throw y}}async _exchangeCodeForSession(e){const t=await Tn(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(t??"").split("/");try{if(!r&&this.flowType==="pkce")throw new Aw;const{data:i,error:o}=await j(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:ct});if(await Ae(this.storage,`${this.storageKey}-code-verifier`),o)throw o;if(!i||!i.session||!i.user){const a=new rr;return this._returnResult({data:{user:null,session:null,redirectType:null},error:a})}return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),this._returnResult({data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:o})}catch(i){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(i))return this._returnResult({data:{user:null,session:null,redirectType:null},error:i});throw i}}async signInWithIdToken(e){try{const{options:t,provider:r,token:s,access_token:i,nonce:o}=e,a=await j(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:ct}),{data:l,error:c}=a;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const d=new rr;return this._returnResult({data:{user:null,session:null},error:d})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(t){if($(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,r,s,i,o;try{if("email"in e){const{email:a,options:l}=e;let c=null,d=null;this.flowType==="pkce"&&([c,d]=await sr(this.storage,this.storageKey));const{error:h}=await j(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:a,data:(t=l?.data)!==null&&t!==void 0?t:{},create_user:(r=l?.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},code_challenge:c,code_challenge_method:d},redirectTo:l?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:h})}if("phone"in e){const{phone:a,options:l}=e,{data:c,error:d}=await j(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:a,data:(s=l?.data)!==null&&s!==void 0?s:{},create_user:(i=l?.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:l?.captchaToken},channel:(o=l?.channel)!==null&&o!==void 0?o:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c?.message_id},error:d})}throw new li("You must provide either an email or phone number.")}catch(a){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async verifyOtp(e){var t,r;try{let s,i;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:o,error:a}=await j(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:ct});if(a)throw a;if(!o)throw new Error("An error occurred on token verification.");const l=o.session,c=o.user;return l?.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(s){if($(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}}async signInWithSSO(e){var t,r,s,i,o;try{let a=null,l=null;this.flowType==="pkce"&&([a,l]=await sr(this.storage,this.storageKey));const c=await j(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=e?.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:l}),headers:this.headers,xform:Zw});return!((i=c.data)===null||i===void 0)&&i.url&&Me()&&!(!((o=e.options)===null||o===void 0)&&o.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(a){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new Ve;const{error:s}=await j(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:s})})}catch(e){if($(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:s,options:i}=e,{error:o}=await j(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}},redirectTo:i?.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:o})}else if("phone"in e){const{phone:r,type:s,options:i}=e,{data:o,error:a}=await j(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:o?.message_id},error:a})}throw new li("You must provide either an email or phone number and a type")}catch(t){if($(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await Tn(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<Aa:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const o=await Tn(this.userStorage,this.storageKey+"-user");o?.user?e.user=o.user:e.user=Oa()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const o={value:this.suppressGetSessionWarning};e.user=Jw(e.user,o),o.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{session:null},error:i}):this._returnResult({data:{session:s},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){if(e)return await this._getUser(e);await this.initializePromise;const t=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return t.data.user&&(this.suppressGetSessionWarning=!0),t}async _getUser(e){try{return e?await j(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:Zt}):await this._useSession(async t=>{var r,s,i;const{data:o,error:a}=t;if(a)throw a;return!(!((r=o.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Ve}:await j(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(s=o.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0,xform:Zt})})}catch(t){if($(t))return Ew(t)&&(await this._removeSession(),await Ae(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:s,error:i}=r;if(i)throw i;if(!s.session)throw new Ve;const o=s.session;let a=null,l=null;this.flowType==="pkce"&&e.email!=null&&([a,l]=await sr(this.storage,this.storageKey));const{data:c,error:d}=await j(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:l}),jwt:o.access_token,xform:Zt});if(d)throw d;return o.user=c.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),this._returnResult({data:{user:o.user},error:null})})}catch(r){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(r))return this._returnResult({data:{user:null},error:r});throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Ve;const t=Date.now()/1e3;let r=t,s=!0,i=null;const{payload:o}=Ia(e.access_token);if(o.exp&&(r=o.exp,s=r<=t),s){const{data:a,error:l}=await this._callRefreshToken(e.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!a)return{data:{user:null,session:null},error:null};i=a}else{const{data:a,error:l}=await this._getUser(e.access_token);if(l)throw l;i={access_token:e.access_token,refresh_token:e.refresh_token,user:a.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return this._returnResult({data:{user:i.user,session:i},error:null})}catch(t){if($(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:o,error:a}=t;if(a)throw a;e=(r=o.session)!==null&&r!==void 0?r:void 0}if(!e?.refresh_token)throw new Ve;const{data:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?this._returnResult({data:{user:null,session:null},error:i}):s?this._returnResult({data:{user:s.user,session:s},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if($(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!Me())throw new ci("No browser detected.");if(e.error||e.error_description||e.error_code)throw new ci(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new Id("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new ci("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new Id("No code detected.");const{data:v,error:b}=await this._exchangeCodeForSession(e.code);if(b)throw b;const S=new URL(window.location.href);return S.searchParams.delete("code"),window.history.replaceState(window.history.state,"",S.toString()),{data:{session:v.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:s,access_token:i,refresh_token:o,expires_in:a,expires_at:l,token_type:c}=e;if(!i||!a||!o||!c)throw new ci("No session defined in URL");const d=Math.round(Date.now()/1e3),h=parseInt(a);let f=d+h;l&&(f=parseInt(l));const p=f-d;p*1e3<=ur&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${p}s, should have been closer to ${h}s`);const m=f-h;d-m>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",m,f,d):d-m<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",m,f,d);const{data:g,error:y}=await this._getUser(i);if(y)throw y;const w={provider_token:r,provider_refresh_token:s,access_token:i,expires_in:h,expires_at:f,refresh_token:o,token_type:c,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:w,redirectType:e.type},error:null})}catch(r){if($(r))return this._returnResult({data:{session:null,redirectType:null},error:r});throw r}}_isImplicitGrantCallback(e){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),e):!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await Tn(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return this._returnResult({error:i});const o=(r=s.session)===null||r===void 0?void 0:r.access_token;if(o){const{error:a}=await this.admin.signOut(o,e);if(a&&!(Tw(a)&&(a.status===404||a.status===401||a.status===403)))return this._returnResult({error:a})}return e!=="others"&&(await this._removeSession(),await Ae(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=Pw(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,s;try{const{data:{session:i},error:o}=t;if(o)throw o;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let r=null,s=null;this.flowType==="pkce"&&([r,s]=await sr(this.storage,this.storageKey,!0));try{return await j(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(i))return this._returnResult({data:null,error:i});throw i}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:r,error:s}=await this._useSession(async i=>{var o,a,l,c,d;const{data:h,error:f}=i;if(f)throw f;const p=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(a=e.options)===null||a===void 0?void 0:a.scopes,queryParams:(l=e.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await j(this.fetch,"GET",p,{headers:this.headers,jwt:(d=(c=h.session)===null||c===void 0?void 0:c.access_token)!==null&&d!==void 0?d:void 0})});if(s)throw s;return Me()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r?.url),this._returnResult({data:{provider:e.provider,url:r?.url},error:null})}catch(r){if($(r))return this._returnResult({data:{provider:e.provider,url:null},error:r});throw r}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var r;try{const{error:s,data:{session:i}}=t;if(s)throw s;const{options:o,provider:a,token:l,access_token:c,nonce:d}=e,h=await j(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(r=i?.access_token)!==null&&r!==void 0?r:void 0,body:{provider:a,id_token:l,access_token:c,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:o?.captchaToken}},xform:ct}),{data:f,error:p}=h;return p?this._returnResult({data:{user:null,session:null},error:p}):!f||!f.session||!f.user?this._returnResult({data:{user:null,session:null},error:new rr}):(f.session&&(await this._saveSession(f.session),await this._notifyAllSubscribers("USER_UPDATED",f.session)),this._returnResult({data:f,error:p}))}catch(s){if(await Ae(this.storage,`${this.storageKey}-code-verifier`),$(s))return this._returnResult({data:{user:null,session:null},error:s});throw s}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:o}=t;if(o)throw o;return await j(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await Bw(async s=>(s>0&&await jw(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await j(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:ct})),(s,i)=>{const o=200*Math.pow(2,s);return i&&Ma(i)&&Date.now()+o-r<ur})}catch(r){if(this._debug(t,"error",r),$(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),Me()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const s=await Tn(this.storage,this.storageKey);if(s&&this.userStorage){let o=await Tn(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!o&&(o={user:s.user},await hr(this.userStorage,this.storageKey+"-user",o)),s.user=(e=o?.user)!==null&&e!==void 0?e:Oa()}else if(s&&!s.user&&!s.user){const o=await Tn(this.storage,this.storageKey+"-user");o&&o?.user?(s.user=o.user,await Ae(this.storage,this.storageKey+"-user"),await hr(this.storage,this.storageKey,s)):s.user=Oa()}if(this._debug(r,"session from storage",s),!this._isValidSession(s)){this._debug(r,"session is not valid"),s!==null&&await this._removeSession();return}const i=((t=s.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Aa;if(this._debug(r,`session has${i?"":" not"} expired with margin of ${Aa}s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:o}=await this._callRefreshToken(s.refresh_token);o&&(console.error(o),Ma(o)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else if(s.user&&s.user.__isUserNotAvailableProxy===!0)try{const{data:o,error:a}=await this._getUser(s.access_token);!a&&o?.user?(s.user=o.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(o){console.error("Error getting user data:",o),this._debug(r,"error getting user data, skipping SIGNED_IN notification",o)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(r,"error",s),console.error(s);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new Ve;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new Bo;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new Ve;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const a={data:i.session,error:null};return this.refreshingDeferred.resolve(a),a}catch(i){if(this._debug(s,"error",i),$(i)){const o={data:null,error:i};return Ma(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,r=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async a=>{try{await a.callback(e,t)}catch(l){i.push(l)}});if(await Promise.all(o),i.length>0){for(let a=0;a<i.length;a+=1)console.error(i[a]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0,await Ae(this.storage,`${this.storageKey}-code-verifier`);const t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await hr(this.userStorage,this.storageKey+"-user",{user:t.user});const s=Object.assign({},t);delete s.user;const i=Pd(s);await hr(this.storage,this.storageKey,i)}else{const s=Pd(t);await hr(this.storage,this.storageKey,s)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await Ae(this.storage,this.storageKey),await Ae(this.storage,this.storageKey+"-code-verifier"),await Ae(this.storage,this.storageKey+"-user"),this.userStorage&&await Ae(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Me()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),ur);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e);const t=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e);const t=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,t&&clearTimeout(t)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-e)/ur);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${ur}ms, refresh threshold is ${vl} ticks`),s<=vl&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof zh)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Me()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const s=[`provider=${encodeURIComponent(t)}`];if(r?.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r?.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[i,o]=await sr(this.storage,this.storageKey),a=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});s.push(a.toString())}if(r?.queryParams){const i=new URLSearchParams(r.queryParams);s.push(i.toString())}return r?.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?this._returnResult({data:null,error:i}):await j(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:o}=t;if(o)return this._returnResult({data:null,error:o});const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:l,error:c}=await j(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:(r=i?.session)===null||r===void 0?void 0:r.access_token});return c?this._returnResult({data:null,error:c}):(e.factorType==="totp"&&l.type==="totp"&&(!((s=l?.totp)===null||s===void 0)&&s.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?mb(e.webauthn.credential_response):gb(e.webauthn.credential_response)})}:{code:e.code}),{data:a,error:l}=await j(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:o,headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),this._returnResult({data:a,error:l}))})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=await j(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});if(o.error)return o;const{data:a}=o;if(a.type!=="webauthn")return{data:a,error:null};switch(a.webauthn.type){case"create":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:fb(a.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},a),{webauthn:Object.assign(Object.assign({},a.webauthn),{credential_options:Object.assign(Object.assign({},a.webauthn.credential_options),{publicKey:pb(a.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?this._returnResult({data:null,error:r}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:r}=await this.getUser();if(r)return{data:null,error:r};const s={all:[],phone:[],totp:[],webauthn:[]};for(const i of(e=t?.factors)!==null&&e!==void 0?e:[])s.all.push(i),i.status==="verified"&&s[i.factor_type].push(i);return{data:s,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:r},error:s}=await this.getSession();if(s)return this._returnResult({data:null,error:s});if(!r)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:i}=Ia(r.access_token);let o=null;i.aal&&(o=i.aal);let a=o;((t=(e=r.user.factors)===null||e===void 0?void 0:e.filter(d=>d.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(a="aal2");const c=i.amr||[];return{data:{currentLevel:o,nextLevel:a,currentAuthenticationMethods:c},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?await j(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:r.access_token,xform:i=>({data:i,error:null})}):this._returnResult({data:null,error:new Ve})})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:s},error:i}=r;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new Ve});const o=await j(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"approve"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&Me()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(r){if($(r))return this._returnResult({data:null,error:r});throw r}}async _denyAuthorization(e,t){try{return await this._useSession(async r=>{const{data:{session:s},error:i}=r;if(i)return this._returnResult({data:null,error:i});if(!s)return this._returnResult({data:null,error:new Ve});const o=await j(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:s.access_token,body:{action:"deny"},xform:a=>({data:a,error:null})});return o.data&&o.data.redirect_url&&Me()&&!t?.skipBrowserRedirect&&window.location.assign(o.data.redirect_url),o})}catch(r){if($(r))return this._returnResult({data:null,error:r});throw r}}async _listOAuthGrants(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;return r?this._returnResult({data:null,error:r}):t?await j(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:t.access_token,xform:s=>({data:s,error:null})}):this._returnResult({data:null,error:new Ve})})}catch(e){if($(e))return this._returnResult({data:null,error:e});throw e}}async _revokeOAuthGrant(e){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?(await j(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,query:{client_id:e.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new Ve})})}catch(t){if($(t))return this._returnResult({data:null,error:t});throw t}}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(a=>a.kid===e);if(r)return r;const s=Date.now();if(r=this.jwks.keys.find(a=>a.kid===e),r&&this.jwks_cached_at+_w>s)return r;const{data:i,error:o}=await j(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return!i.keys||i.keys.length===0||(this.jwks=i,this.jwks_cached_at=s,r=i.keys.find(a=>a.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){const{data:p,error:m}=await this.getSession();if(m||!p.session)return this._returnResult({data:null,error:m});r=p.session.access_token}const{header:s,payload:i,signature:o,raw:{header:a,payload:l}}=Ia(r);t?.allowExpired||Ww(i.exp);const c=!s.alg||s.alg.startsWith("HS")||!s.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(s.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!c){const{error:p}=await this.getUser(r);if(p)throw p;return{data:{claims:i,header:s,signature:o},error:null}}const d=Kw(s.alg),h=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,h,o,$w(`${a}.${l}`)))throw new _l("Invalid JWT signature");return{data:{claims:i,header:s,signature:o},error:null}}catch(r){if($(r))return this._returnResult({data:null,error:r});throw r}}}ks.nextInstanceID={};const Tb=ks,Eb="2.90.1";let Jr="";typeof Deno<"u"?Jr="deno":typeof document<"u"?Jr="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Jr="react-native":Jr="node";const Cb={"X-Client-Info":`supabase-js-${Jr}/${Eb}`},Ab={headers:Cb},Mb={schema:"public"},Ib={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Ob={};function Ss(n){"@babel/helpers - typeof";return Ss=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ss(n)}function Nb(n,e){if(Ss(n)!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var r=t.call(n,e);if(Ss(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function $b(n){var e=Nb(n,"string");return Ss(e)=="symbol"?e:e+""}function Rb(n,e,t){return(e=$b(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function zd(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);e&&(r=r.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,r)}return t}function ue(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zd(Object(t),!0).forEach(function(r){Rb(n,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):zd(Object(t)).forEach(function(r){Object.defineProperty(n,r,Object.getOwnPropertyDescriptor(t,r))})}return n}const Pb=n=>n?(...e)=>n(...e):(...e)=>fetch(...e),Db=()=>Headers,Lb=(n,e,t)=>{const r=Pb(t),s=Db();return async(i,o)=>{var a;const l=(a=await e())!==null&&a!==void 0?a:n;let c=new s(o?.headers);return c.has("apikey")||c.set("apikey",n),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),r(i,ue(ue({},o),{},{headers:c}))}};function jb(n){return n.endsWith("/")?n:n+"/"}function Bb(n,e){var t,r;const{db:s,auth:i,realtime:o,global:a}=n,{db:l,auth:c,realtime:d,global:h}=e,f={db:ue(ue({},l),s),auth:ue(ue({},c),i),realtime:ue(ue({},d),o),storage:{},global:ue(ue(ue({},h),a),{},{headers:ue(ue({},(t=h?.headers)!==null&&t!==void 0?t:{}),(r=a?.headers)!==null&&r!==void 0?r:{})}),accessToken:async()=>""};return n.accessToken?f.accessToken=n.accessToken:delete f.accessToken,f}function Fb(n){const e=n?.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(jb(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var Ub=class extends Tb{constructor(n){super(n)}},zb=class{constructor(n,e,t){var r,s;this.supabaseUrl=n,this.supabaseKey=e;const i=Fb(n);if(!e)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",i),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",i),this.storageUrl=new URL("storage/v1",i),this.functionsUrl=new URL("functions/v1",i);const o=`sb-${i.hostname.split(".")[0]}-auth-token`,a={db:Mb,realtime:Ob,auth:ue(ue({},Ib),{},{storageKey:o}),global:Ab},l=Bb(t??{},a);if(this.storageKey=(r=l.auth.storageKey)!==null&&r!==void 0?r:"",this.headers=(s=l.global.headers)!==null&&s!==void 0?s:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(d,h)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(h)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=Lb(e,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(ue({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&this.accessToken().then(d=>this.realtime.setAuth(d)).catch(d=>console.warn("Failed to set initial Realtime auth token:",d)),this.rest=new ky(new URL("rest/v1",i).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch}),this.storage=new ww(this.storageUrl.href,this.headers,this.fetch,t?.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new gy(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(n){return this.rest.from(n)}schema(n){return this.rest.schema(n)}rpc(n,e={},t={head:!1,get:!1,count:void 0}){return this.rest.rpc(n,e,t)}channel(n,e={config:{}}){return this.realtime.channel(n,e)}getChannels(){return this.realtime.getChannels()}removeChannel(n){return this.realtime.removeChannel(n)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var n=this,e,t;if(n.accessToken)return await n.accessToken();const{data:r}=await n.auth.getSession();return(e=(t=r.session)===null||t===void 0?void 0:t.access_token)!==null&&e!==void 0?e:n.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:s,storageKey:i,flowType:o,lock:a,debug:l,throwOnError:c},d,h){const f={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Ub({url:this.authUrl.href,headers:ue(ue({},f),d),storageKey:i,autoRefreshToken:n,persistSession:e,detectSessionInUrl:t,storage:r,userStorage:s,flowType:o,lock:a,debug:l,throwOnError:c,fetch:h,hasCustomAuthorizationHeader:Object.keys(this.headers).some(p=>p.toLowerCase()==="authorization")})}_initRealtimeClient(n){return new jy(this.realtimeUrl.href,ue(ue({},n),{},{params:ue(ue({},{apikey:this.supabaseKey}),n?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((n,e)=>{this._handleTokenChanged(n,"CLIENT",e?.access_token)})}_handleTokenChanged(n,e,t){(n==="TOKEN_REFRESHED"||n==="SIGNED_IN")&&this.changedAccessToken!==t?(this.changedAccessToken=t,this.realtime.setAuth(t)):n==="SIGNED_OUT"&&(this.realtime.setAuth(),e=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const Hb=(n,e,t)=>new zb(n,e,t);function Vb(){if(typeof window<"u")return!1;const n=globalThis.process;if(!n)return!1;const e=n.version;if(e==null)return!1;const t=e.match(/^v(\d+)\./);return t?parseInt(t[1],10)<=18:!1}Vb()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Hd={SUPABASE_URL:"https://bwmbsjbbyleqjxcxujxo.supabase.co",SUPABASE_ANON_KEY:"sb_publishable_iHVkoe07I55N3QWUeN3ZTQ_TbvT1eyc"},ye=Hb(Hd.SUPABASE_URL,Hd.SUPABASE_ANON_KEY,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}});async function qb(n,e){try{const{error:t}=await ye.auth.signUp({email:n,password:e});return t?{ok:!1,errorMessage:t.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Wb(n,e){try{const{error:t}=await ye.auth.signInWithPassword({email:n,password:e});return t?{ok:!1,errorMessage:t.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Vd(){try{const{error:n}=await ye.auth.signOut();return n?{ok:!1,errorMessage:n.message}:{ok:!0}}catch(n){return{ok:!1,errorMessage:n.message}}}async function Kb(){try{const{data:n,error:e}=await ye.auth.getUser();return e?{ok:!1,errorMessage:e.message}:{ok:!0,user:n.user??null}}catch(n){return{ok:!1,errorMessage:n.message}}}async function Gb(){const n=window.location.hash||"#/home",e=await Kb();if(!e.ok)return{page:"login",props:{message:e.errorMessage}};if(e.user===null)return n!=="#login"&&n!=="#/login"&&(window.location.hash="#login"),{page:"login",props:{message:"Veuillez vous connecter."}};if(n==="#login"||n==="#/login"||n==="#app")return window.location.hash="#/home",{page:"home",props:{userEmail:e.user?.email??""}};if(n==="#/home")return{page:"home",props:{userEmail:e.user?.email??""}};if(n==="#/ideas")return window.location.hash="#/projects",{page:"projects",props:{userEmail:e.user?.email??""}};if(n==="#/projects")return{page:"projects",props:{userEmail:e.user?.email??""}};if(n.startsWith("#/project/")){const t=n.replace("#/project/","").split("/").filter(Boolean),r=t[0];if(!r)return window.location.hash="#/projects",{page:"projects",props:{userEmail:e.user?.email??""}};const s=t[1]??"write",i={write:"chapter",characters:"characters",ideas:"ideas",inspiration:"inspiration",mindmap:"mindmap",stats:"stats",knowledge:"knowledge",settings:"chapter"};return s in i||(window.location.hash=`#/project/${r}/write`),{page:"editor",props:{userEmail:e.user?.email??"",projectId:r,writingNav:i[s]??"chapter"}}}if(n.startsWith("#/editor/")){const t=n.replace("#/editor/","").trim();return t?(window.location.hash=`#/project/${t}/write`,{page:"editor",props:{userEmail:e.user?.email??"",projectId:t,writingNav:"chapter"}}):(window.location.hash="#/projects",{page:"projects",props:{userEmail:e.user?.email??""}})}return window.location.hash="#/home",{page:"home",props:{userEmail:e.user?.email??""}}}const Jb="/Plumeo/";function Yb({onSignIn:n,onSignUp:e,message:t=""}={}){return`
    <section class="page">
      <h1>Login</h1>
      <p>Connecte-toi pour acceder a l'app.</p>
      <form id="auth-form" class="form" autocomplete="on">
        <label class="field">
          <span>Email</span>
          <input class="input" id="email" type="email" required placeholder="email@exemple.com" />
        </label>
        <label class="field">
          <span>Mot de passe</span>
          <input class="input" id="password" type="password" required minlength="6" />
        </label>
        <div class="actions">
          <button class="btn btn-primary" id="sign-in" type="button">Se connecter</button>
          <button id="sign-up" class="btn btn-secondary" type="button">Creer un compte</button>
        </div>
      </form>
      <p id="message" class="message">${t}</p>
    </section>
  `}function _s(n){if(!n)return"";const e=new Date(n);return Number.isNaN(e.getTime())?n:e.toLocaleString()}function Di(n){if(!n)return"";const e=new Date(n);if(Number.isNaN(e.getTime()))return"";const t=e.toLocaleDateString("fr-FR",{day:"2-digit",month:"short"}),r=e.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});return`${t} ${r}`}function he(n){return String(n??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function pc({userEmail:n="",activeRoute:e="home",lastProjectId:t=null,lastCloudSaveAt:r=null,cloudStatus:s="",cloudBusy:i=!1,accountMenuOpen:o=!1,backupStatus:a="",backupMenuOpen:l=!1}={}){const c=e==="home"?" is-active":"",d=e==="projects"?" is-active":"",h=l?" is-active":"",f=o?" is-active":"",p=!!n,m=n?n.split("@")[0].slice(0,14):"Non connecte",g=n?n.trim().charAt(0).toUpperCase():"?",y=r?_s(new Date(r).toISOString()):"-",w=!p||i?"disabled":"",v=!p||i?"disabled":"",b=p?'<button class="btn btn-ghost topbar-popover-item" data-action="home-sign-out" type="button"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 4h6a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12H4m0 0l3-3m-3 3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Deconnexion</span></button>':"",S=a?`<p class="topbar-popover-meta"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 7v5l3 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">${a}</span></p>`:"",k=l?`
        <div class="topbar-popover" role="menu" aria-label="Backup">
          <button class="btn btn-ghost topbar-popover-item" data-action="home-backup-export" type="button"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5v10m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 19h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></span><span class="topbar-popover-label">Exporter</span></button>
          <button class="btn btn-ghost topbar-popover-item" data-action="home-backup-import" type="button"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 19V9m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 5h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></span><span class="topbar-popover-label">Importer</span></button>
          <input id="home-backup-file" type="file" accept=".json" hidden />
          ${S}
        </div>
      `:"",_=o?`
        <div class="topbar-popover" role="menu" aria-label="Compte">
          <button class="btn btn-ghost topbar-popover-item" data-action="home-cloud-save" type="button" ${w}><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 18a4 4 0 0 1 .7-7.95A5.5 5.5 0 0 1 19 10a3.5 3.5 0 0 1 0 7H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 15V9m0 0l-3 3m3-3l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Sauver cloud</span></button>
          <button class="btn btn-ghost topbar-popover-item" data-action="home-cloud-load" type="button" ${v}><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 18a4 4 0 0 1 .7-7.95A5.5 5.5 0 0 1 19 10a3.5 3.5 0 0 1 0 7H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9v6m0 0l-3-3m3 3l3-3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Charger cloud</span></button>
          <div class="topbar-popover-sep" role="presentation"></div>
          ${b}
          <p class="topbar-popover-meta"><span class="topbar-popover-icon"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="1.6"/><path d="M12 7v5l3 2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="topbar-popover-label">Sauvegarde : ${y}</span></p>
        </div>
      `:"",x=s?`<span class="status topbar-cloud-status">${s}</span>`:"";return`
    <header class="topbar">
      <div class="topbar-inner layout-container">
        <div class="topbar-left">
          <h1>Plumeo</h1>
        </div>
        <div class="topbar-right">
          <div class="topbar-nav">
            <button data-action="nav-home" type="button" class="topbar-pill${c}">Accueil</button>
            <button data-action="nav-projects" type="button" class="topbar-pill${d}">Projets</button>
          </div>
          ${x}
          <div class="topbar-backup">
            <button
              class="topbar-pill${h}"
              type="button"
              data-action="backup-toggle"
              aria-haspopup="menu"
              aria-expanded="${l?"true":"false"}"
              title="Backup"
            >
              <span class="topbar-account-avatar">B</span>
              <span class="topbar-account-label">Backup</span>
            </button>
            ${k}
          </div>
          <div class="topbar-account">
            <button
              type="button"
              data-action="account-toggle"
              aria-haspopup="menu"
              aria-expanded="${o?"true":"false"}"
              class="topbar-pill${f}"
            >
              <span class="topbar-account-avatar">${g}</span>
              <span class="topbar-account-label">${m}</span>
            </button>
            ${_}
          </div>
        </div>
      </div>
    </header>
  `}function Xb({userEmail:n="",projects:e=[],lastProjectId:t=null,lastChapterTitle:r=null,lastCloudSaveAt:s=null,cloudStatus:i="",cloudBusy:o=!1,backupStatus:a="",homeStats:l=null,homeMessage:c="",accountMenuOpen:d=!1,backupMenuOpen:h=!1}={}){e.length>0;const f=e.find(P=>P.id===t);f?.title,f&&`${f.id}`,s&&_s(new Date(s).toISOString());const p=l??{totalWords:null,wordsPerDay:null,pagesTotal:null,pagesPerDay:null,timeSpent:null,timePerDay:null,favoriteTime:null,favoriteTimeStatus:null},m=(P,Y)=>P==null?"--":Y(P),g=P=>{if(!Number.isFinite(P))return"";const Y=Math.round(P);if(Y<60)return`${Y} min`;const I=Math.floor(Y/60),q=Y%60;return q?`${I} h ${q} min`:`${I} h`},y="Non disponible",w=Number.isFinite(p.timeSpent),v=Number.isFinite(p.timePerDay),b=w?g(p.timeSpent):y,S=v?g(p.timePerDay):y,k=v?" / jour":"",_=m(p.totalWords,P=>`${P} mots`),x=m(p.wordsPerDay,P=>`${P} mots`),E=m(p.pagesTotal,P=>`${P}`),N=m(p.pagesPerDay,P=>`${P.toFixed(1)} pages`),H=p.favoriteTimeStatus??(p.favoriteTime?"ok":"unavailable"),A=H==="ok"?p.favoriteTime:H==="insufficient"?"Non determine":"Non disponible",J=H==="ok"?p.favoriteTime:H==="insufficient"?"Donnees insuffisantes":"Aucune donnee pour le moment",ee=H==="unavailable"?'<span class="home-analysis-insight-note">Mesure via vos sessions de focus.</span>':"";return e.map(P=>{const Y=P.id===t,I=Y?"Actif":"En pause",q=Y?" is-active":"",re=Y?"En cours":"Brouillon",_e=P.created_at?`Modifie le ${_s(P.created_at)}`:"A reprendre";return`
        <div class="project-card${Y?" is-active":""}">
          <button class="project-card-main" data-action="home-project-open" data-id="${P.id}" type="button">
            <h3>${P.title}</h3>
            <div class="project-card-meta">
              <span class="project-card-status${q}">${I}</span>
              <span class="project-card-progress">${re}</span>
              <span class="project-card-info">${_e}</span>
            </div>
          </button>
          <button class="project-card-delete danger-hover" data-action="home-project-delete" data-id="${P.id}" type="button" aria-label="Supprimer le projet" title="Supprimer">
            Supprimer
          </button>
        </div>
      `}).join(""),`
    <section class="page-shell home-shell">
      ${pc({userEmail:n,activeRoute:"home",lastProjectId:t,lastCloudSaveAt:s,cloudStatus:i,cloudBusy:o,accountMenuOpen:d,backupStatus:a,backupMenuOpen:h})}
      <div class="page dashboard">
        <main class="home-landing layout-container">
          <section class="home-hero-split">
            <div class="home-hero-copy">
              <h1 class="home-hero-title-large">Bonjour, Louis</h1>
              <blockquote class="home-hero-quote">&Eacute;crire, c'est tenter de savoir ce qu'on &eacute;crirait si on &eacute;crivait</blockquote>
              <button
                class="home-hero-cta"
                data-action="home-project-continue"
                type="button"
              >
                Continuer a ecrire
              </button>
            </div>
            <div class="home-hero-art" aria-hidden="true"></div>
          </section>
          <section id="home-next" class="home-next" aria-hidden="true"></section>
          <section id="home-analysis" class="home-analysis">
            <div class="analysis-frame">
              <div class="analysis-frame-header">
                <h2 class="analysis-title">Analyse</h2>
              </div>
              <div class="analysis-frame-body">
                <div class="home-analysis-left">
                  <img
                    class="home-analysis-illustration"
                    src="${Jb}assets/illustrations/analysis.png"
                    alt="Illustration des statistiques d'ecriture"
                    loading="lazy"
                  />
                </div>
                <div class="home-analysis-right">
                  <section class="home-analysis-card">
                    <h3>Vos statistiques d'&eacute;criture</h3>
                    <div class="home-analysis-kpis">
                      <div class="home-analysis-kpi">
                        <span class="home-analysis-kpi-label">Temps pass&eacute; &agrave; &eacute;crire</span>
                        <span class="home-analysis-kpi-value">${b}</span>
                        <span class="home-analysis-kpi-meta">${S}${k}</span>
                      </div>
                      <div class="home-analysis-kpi">
                        <span class="home-analysis-kpi-label">Nombre total de mots</span>
                        <span class="home-analysis-kpi-value">${_??"--"}</span>
                        <span class="home-analysis-kpi-meta">${x??"--"} / jour</span>
                      </div>
                      <div class="home-analysis-kpi">
                        <span class="home-analysis-kpi-label">Nombre total de pages</span>
                        <span class="home-analysis-kpi-value">${E??"--"}</span>
                        <span class="home-analysis-kpi-meta">${N??"--"} / jour</span>
                      </div>
                    </div>
                  </section>
                  <section class="home-analysis-card home-analysis-insight">
                    <h3>Moment pr&eacute;f&eacute;r&eacute; pour &eacute;crire</h3>
                    <div class="home-analysis-insight-visual">
                      <span class="${H==="ok"?"home-analysis-insight-label":"home-analysis-insight-empty"}">${J}</span>
                    </div>
                    <p class="home-analysis-insight-text">Moment pr&eacute;f&eacute;r&eacute; pour &eacute;crire : ${A}${ee}</p>
                  </section>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </section>
  `}function Qb({ideas:n=[],selectedIdeaId:e=null,ideasQuery:t="",ideasTagFilter:r="",ideasStatusFilter:s="all",ideasSort:i="desc",ideasFiltersOpen:o=!1,ideasNoteExpanded:a=!1}={}){const l=n.find(y=>y.id===e)??null,c={raw:"Brute",used:"Exploitee",abandoned:"Abandonnee"},d=n.map(y=>{const w=y.content?.trim()||"Sans contenu",v=w.length>80?`${w.slice(0,77)}...`:w,b=Di(y.created_at),S=c[y.status]??"Brute",k=`<span class="ideas-item__status status-${y.status}">${S}</span>`,_=Array.isArray(y.tags)?y.tags.length:0,x=_===1?`tags: ${y.tags[0]}`:_>1?`tags: +${_}`:"",E=[b,k,x].filter(Boolean);return`
        <button type="button" class="ideas-item${y.id===e?" is-selected":""}" data-action="ideas-select" data-id="${y.id}">
          <span class="ideas-item__line1">${v}</span>
          <span class="ideas-item__meta">${E.join("  ")}</span>
        </button>
      `}).join(""),h=l?.note??"",f=!!h.trim(),p=a?"Masquer la note":f?"Afficher la note":"Ajouter une note",m=l?`
        <div class="ideas-detail-body">
          <textarea
            class="ideas-detail-input"
            rows="8"
            data-idea-field="content"
            data-id="${l.id}"
            placeholder="Ecris ton idee..."
          >${l.content??""}</textarea>
          <div class="ideas-detail-meta">
            <label class="ideas-meta-field">
              <span>Statut</span>
              <select class="input" data-idea-field="status" data-id="${l.id}">
                <option value="raw"${l.status==="raw"?" selected":""}>Brute</option>
                <option value="used"${l.status==="used"?" selected":""}>Exploitee</option>
                <option value="abandoned"${l.status==="abandoned"?" selected":""}>Abandonnee</option>
              </select>
            </label>
            <label class="ideas-meta-field">
              <span>Tags</span>
              <input class="input" type="text" value="${(l.tags??[]).join(", ")}" data-idea-field="tags" data-id="${l.id}" placeholder="tag1, tag2" />
            </label>
          </div>
          <div class="ideas-detail-note">
            <button type="button" class="btn btn-ghost ideas-note-toggle" data-action="ideas-note-toggle">
              ${p}
            </button>
            ${a?`<textarea class="input ideas-note-input" rows="3" data-idea-field="note" data-id="${l.id}" placeholder="Note">${h}</textarea>`:""}
          </div>
          <div class="ideas-detail-footer">
            <div class="ideas-detail-actions">
              <button type="button" class="btn btn-secondary" disabled>Associer a un projet</button>
              <button type="button" class="btn btn-secondary" disabled>Transformer en chapitre</button>
            </div>
            <button type="button" class="btn btn-danger ideas-delete danger-hover" data-action="ideas-delete" data-id="${l.id}">Supprimer</button>
          </div>
        </div>
      `:`
        <div class="ideas-detail-empty">
          <h3>Selectionne une idee</h3>
          <p>La idee apparaitra ici pour etre enrichie.</p>
        </div>
      `,g=o?`
        <div class="ideas-filters-panel" id="ideas-filters-panel">
          <label class="field">
            <span>Tag</span>
            <input id="ideas-tag-filter" class="input" type="text" placeholder="Tag" value="${r}" />
          </label>
          <label class="field">
            <span>Statut</span>
            <select id="ideas-status-filter" class="input">
              <option value="all"${s==="all"?" selected":""}>Tous</option>
              <option value="raw"${s==="raw"?" selected":""}>Brute</option>
              <option value="used"${s==="used"?" selected":""}>Exploitee</option>
              <option value="abandoned"${s==="abandoned"?" selected":""}>Abandonnee</option>
            </select>
          </label>
          <label class="field">
            <span>Tri</span>
            <select id="ideas-sort" class="input">
              <option value="desc"${i==="desc"?" selected":""}>Plus recentes</option>
              <option value="asc"${i==="asc"?" selected":""}>Plus anciennes</option>
            </select>
          </label>
        </div>
      `:"";return`
    <section class="ideas-create panel card">
      <h3>Ajouter une idee</h3>
      <textarea
        id="ideas-create-input"
        class="input ideas-create-input"
        rows="3"
        placeholder="Une phrase, une scene, un concept, une question..."
        aria-label="Ajouter une idee"
      ></textarea>
      <div class="ideas-create-hint"> Entree pour ajouter</div>
    </section>

    <section class="ideas-controls">
      <div class="ideas-controls-main">
        <input id="ideas-search" class="input" type="text" placeholder="Rechercher..." value="${t}" />
        <button
          type="button"
          class="btn btn-ghost ideas-filters-toggle"
          data-action="ideas-filters-toggle"
          aria-expanded="${o?"true":"false"}"
          aria-controls="ideas-filters-panel"
        >
          Filtres v
        </button>
      </div>
      ${g}
    </section>

    <div class="ideas-layout ideas-layout--master-detail">
      <div class="ideas-list">
        ${d||'<p class="ideas-empty">Ajoute une idee ci-dessus.</p>'}
      </div>
      <div class="ideas-detail">
        ${m}
      </div>
    </div>
  `}function Zb({userEmail:n="",projects:e=[],projectStats:t={},projectsMenuOpenId:r=null,editingProjectId:s=null,lastProjectId:i=null,lastCloudSaveAt:o=null,cloudStatus:a="",cloudBusy:l=!1,accountMenuOpen:c=!1,backupStatus:d="",backupMenuOpen:h=!1}={}){const f=e.length>0,p={active:"Actif",paused:"En pause",done:"Termine",archived:"Archive"},m=e.map(y=>{const w=t[y.id]??{},v=w.updatedAt?Di(w.updatedAt):y.created_at?Di(y.created_at):"",b=typeof w.chapterCount=="number"?w.chapterCount:"",S=typeof w.wordCount=="number"?w.wordCount:"",k=b===""?"":`${b} chapitre${b===1?"":"s"}`,_=S===""?"":`${S} mot${S===1?"":"s"}`,x=y.status??"active",E=p[x]??"Actif",N=y.id===i,H=N?'<span class="project-badge">Actif</span>':"",A=x!=="active"?`<span class="project-status status-${x}">${E}</span>`:"",ee=s===y.id?`
            <div class="project-title-edit">
              <input
                class="project-edit-input"
                data-action="projects-rename-input"
                data-id="${y.id}"
                type="text"
                value="${y.title??""}"
                placeholder="Sans titre"
                spellcheck="false"
              />
              <div class="project-title-actions">
                <button type="button" class="btn btn-secondary btn-compact" data-action="projects-rename-confirm" data-id="${y.id}">OK</button>
                <button type="button" class="btn btn-ghost btn-compact" data-action="projects-rename-cancel" data-id="${y.id}">Annuler</button>
              </div>
            </div>
            ${H}
            ${A}
          `:`
            <h3>${y.title??"Sans titre"}</h3>
            ${H}
            ${A}
          `,P=r===y.id,Y=P?`
            <div class="project-menu" role="menu" aria-label="Actions projet">
              <button type="button" class="project-menu-item" data-action="projects-rename" data-id="${y.id}">Renommer</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="active">Actif</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="paused">En pause</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="done">Termine</button>
              <button type="button" class="project-menu-item" data-action="projects-status" data-id="${y.id}" data-status="archived">Archive</button>
              <button type="button" class="project-menu-item danger-hover" data-action="projects-delete" data-id="${y.id}">Supprimer</button>
            </div>
          `:"";return`
        <article
          class="project-card project-card--projects${N?" is-active":""}"
          data-action="projects-open"
          data-id="${y.id}"
          role="button"
          tabindex="0"
        >
          <div class="project-card-main">
            <div class="project-card-title">
              ${ee}
            </div>
            <div class="project-card-meta">
              <span class="project-card-info">Derniere modification : ${v}  ${k}  ${_}</span>
            </div>
          </div>
          <div class="project-card-actions">
            <button class="project-menu-toggle" type="button" data-action="projects-menu-toggle" data-id="${y.id}" aria-haspopup="menu" aria-expanded="${P?"true":"false"}" aria-label="Menu projet"></button>
            ${Y}
          </div>
        </article>
      `}).join("");return`
    <section class="page projects-page">
      ${pc({userEmail:n,activeRoute:"projects",lastProjectId:i,lastCloudSaveAt:o,cloudStatus:a,cloudBusy:l,accountMenuOpen:c,backupStatus:d,backupMenuOpen:h})}
      <main class="projects-content layout-container">
        <header class="projects-header">
          <h2>Projets</h2>
          <button class="btn btn-secondary" data-action="projects-create" type="button">+ Nouveau projet</button>
        </header>
        <section class="projects-grid">
          ${f?m:`
      <div class="projects-empty">
        <p>Aucun projet pour le moment.</p>
        <button class="btn btn-secondary" data-action="projects-create" type="button">+ Nouveau projet</button>
      </div>
    `}
        </section>
      </main>
    </section>
  `}function Li(n){return String(n||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function di(n){try{return new URL(n).hostname.replace(/^www\./,"")}catch{return n}}function qd(n=[]){if(!n.length)return"";const e=n.slice(0,2),t=n.length-e.length,r=e.map(i=>`<span class="inspiration-tag">${i}</span>`).join(""),s=t>0?`<span class="inspiration-tag">+${t}</span>`:"";return`<div class="inspiration-tags">${r}${s}</div>`}function ev({projectTitle:n="-",inspirationItems:e=[],inspirationSearch:t="",inspirationTag:r="",inspirationModal:s=null,inspirationDetailId:i=null,chapters:o=[],characters:a=[]}={}){const l=Li(t),c=e.filter(E=>{const N=[E.title,E.note,E.url,...E.tags??[]].map(J=>Li(J)).join(" "),H=l?N.includes(l):!0,A=r?(E.tags??[]).includes(r):!0;return H&&A}),d=Array.from(new Set(e.flatMap(E=>E.tags??[]))),h=c.length?c.map(E=>{const N=E.type==="image",H=E.type==="video",A=N?`<img src="${E.image_data}" alt="" loading="lazy" />`:`<div class="inspiration-preview-icon">
                <span>${H?"Video":"Lien"}</span>
                <span class="inspiration-preview-domain">${di(E.url)}</span>
              </div>`,J=E.title?.trim()||di(E.url)||"Sans titre";return`
            <article class="inspiration-card" data-action="inspiration-open" data-id="${E.id}">
              <div class="inspiration-preview${N?" is-image":""}">
                ${A}
              </div>
              <div class="inspiration-card-body">
                <h4 class="inspiration-card-title">${J}</h4>
                ${qd(E.tags??[])}
                <div class="inspiration-card-actions">
                  <button type="button" class="btn btn-ghost" data-action="inspiration-edit" data-id="${E.id}">Modifier</button>
                  <button type="button" class="btn btn-ghost danger-hover" data-action="inspiration-delete" data-id="${E.id}">Supprimer</button>
                </div>
              </div>
            </article>
          `}).join(""):'<p class="muted">Aucune inspiration pour ce projet.</p>',f=e.length,p=`${f} inspiration${f>1?"s":""}`,m=s?.open,g=s?.step??"type",y=s?.type??"",w=s?.draft??{},v=s?.mode==="edit"?"Modifier":"Ajouter",b=w.image_data?`<div class="inspiration-preview is-image"><img src="${w.image_data}" alt="" /></div>`:"",S=g==="type"?`
          <div class="inspiration-modal-options">
            <button type="button" class="btn btn-secondary" data-action="inspiration-choose-type" data-type="image">Image</button>
            <button type="button" class="btn btn-secondary" data-action="inspiration-choose-type" data-type="link">Lien</button>
            <button type="button" class="btn btn-secondary" data-action="inspiration-choose-type" data-type="video">Video</button>
          </div>
        `:`
          <form class="inspiration-form">
            ${y==="image"?`<label class="field"><span>Image</span><input id="inspiration-image-input" type="file" accept="image/*" /></label>${b}`:""}
            ${y!=="image"?`<label class="field"><span>URL</span><input id="inspiration-url" class="input" type="url" value="${w.url??""}" placeholder="https://..." /></label>`:""}
            <label class="field"><span>Titre</span><input id="inspiration-title" class="input" type="text" value="${w.title??""}" placeholder="Titre (optionnel)" /></label>
            <label class="field"><span>Tags</span><input id="inspiration-tags" class="input" type="text" value="${(w.tags??[]).join(", ")}" placeholder="tag1, tag2" /></label>
            <label class="field"><span>Note</span><textarea id="inspiration-note" class="input" rows="3" placeholder="Note">${w.note??""}</textarea></label>
            <label class="field"><span>Lie a un chapitre</span>
              <select id="inspiration-link-chapter" class="input">
                <option value="">Aucun</option>
                ${o.map(E=>`<option value="${E.id}" ${w.linkedChapterId===E.id?"selected":""}>${E.title||"Sans titre"}</option>`).join("")}
              </select>
            </label>
            <label class="field"><span>Lie a un personnage</span>
              <select id="inspiration-link-character" class="input">
                <option value="">Aucun</option>
                ${a.map(E=>{const H=`${E.first_name??""} ${E.last_name??""}`.trim()||"Sans nom";return`<option value="${E.id}" ${w.linkedCharacterId===E.id?"selected":""}>${H}</option>`}).join("")}
              </select>
            </label>
          </form>
        `,k=m?`
        <div class="inspiration-modal-backdrop" role="dialog" aria-modal="true">
          <div class="inspiration-modal">
            <header class="inspiration-modal-header">
              <h3>${v}</h3>
            </header>
            <div class="inspiration-modal-body">
              ${S}
            </div>
            <footer class="inspiration-modal-actions">
              <button type="button" class="btn btn-ghost" data-action="inspiration-cancel">Annuler</button>
              ${g==="form"?'<button type="button" class="btn btn-primary" data-action="inspiration-save">Enregistrer</button>':""}
            </footer>
          </div>
        </div>
      `:"",_=e.find(E=>E.id===i),x=_?`
        <div class="inspiration-modal-backdrop" role="dialog" aria-modal="true">
          <div class="inspiration-modal">
            <header class="inspiration-modal-header">
              <h3>${_.title||di(_.url)||"Sans titre"}</h3>
            </header>
            <div class="inspiration-modal-body">
              ${_.type==="image"?`<div class="inspiration-preview is-image"><img src="${_.image_data}" alt="" /></div>`:`<div class="inspiration-preview">${di(_.url)}</div>`}
              ${_.note?`<p>${_.note}</p>`:""}
              ${qd(_.tags??[])}
            </div>
            <footer class="inspiration-modal-actions">
              <button type="button" class="btn btn-ghost" data-action="inspiration-close">Fermer</button>
              <button type="button" class="btn btn-secondary" data-action="inspiration-edit" data-id="${_.id}">Modifier</button>
              <button type="button" class="btn btn-danger danger-hover" data-action="inspiration-delete" data-id="${_.id}">Supprimer</button>
            </footer>
          </div>
        </div>
      `:"";return`
    <section class="panel inspiration-panel">
      <header class="inspiration-header">
        <div class="inspiration-header-main">
          <h2 class="inspiration-title">Inspiration  Projet : ${n}</h2>
          <span class="inspiration-count">${p}</span>
        </div>
        <div class="inspiration-actions">
          <button type="button" class="btn btn-primary inspiration-create" data-action="inspiration-add">+ Ajouter</button>
          <label class="inspiration-field" for="inspiration-search">
            <span>Rechercher</span>
            <input id="inspiration-search" class="input" type="text" placeholder="Rechercher..." value="${t}" />
          </label>
          <label class="inspiration-field" for="inspiration-tag-filter">
            <span>Tags</span>
            <select id="inspiration-tag-filter" class="input">
              <option value="">Tous les tags</option>
              ${d.map(E=>`<option value="${E}" ${E===r?"selected":""}>${E}</option>`).join("")}
            </select>
          </label>
        </div>
      </header>
      <div class="inspiration-grid">
        ${h}
      </div>
      ${k}
      ${x}
    </section>
  `}function ji(n,e,t){const r=n.x+n.width/2,s=n.y+n.height/2,i=t.x-e.x,o=t.y-e.y;if(i===0&&o===0)return{x:r,y:s};const a=n.width/2,l=n.height/2,c=Math.min(a/Math.max(Math.abs(i),1e-6),l/Math.max(Math.abs(o),1e-6));return{x:r+i*c,y:s+o*c}}function tv({projectTitle:n="-",nodes:e=[],edges:t=[],selectedNodeId:r=null,mode:s="select",linkSourceId:i=null,search:o="",createType:a="note",linkTypeMenu:l=null,flashNodeId:c=null,mindmapDeleteConfirmId:d=null,mindmapContextMenu:h=null,view:f={offsetX:0,offsetY:0,scale:1},chapters:p=[],characters:m=[]}={}){const w=e.find(I=>I.id===r)||null,v=Li(o),b=v?e.filter(I=>{const q=[I.title,I.summary,...I.tags??[]].filter(Boolean).join(" ");return Li(q).includes(v)}):e,S=new Set(b.map(I=>I.id)),k={linked:"li&eacute; &agrave;",conflict:"conflit",appears:"appara&icirc;t dans",cause:"cause-cons&eacute;quence"},_=t.filter(I=>S.has(I.fromNodeId)&&S.has(I.toNodeId)).map(I=>{const q=e.find(Hr=>Hr.id===I.fromNodeId),re=e.find(Hr=>Hr.id===I.toNodeId);if(!q||!re)return"";const _e={x:q.x,y:q.y,width:180,height:64},$e={x:re.x,y:re.y,width:180,height:64},kn={x:_e.x+_e.width/2,y:_e.y+_e.height/2},Ct={x:$e.x+$e.width/2,y:$e.y+$e.height/2},Js=ji(_e,kn,Ct),Ys=ji($e,Ct,kn),Fr=Js.x,Ur=Js.y,Sn=Ys.x,zr=Ys.y,Xs=k[I.type]??I.type??"",pa=(Fr+Sn)/2,ma=(Ur+zr)/2,Qs=Ur-zr,Zs=Sn-Fr,ei=Math.hypot(Qs,Zs)||1,ti=8,ga=pa+Qs/ei*ti,ya=ma+Zs/ei*ti;return`
        <line x1="${Fr}" y1="${Ur}" x2="${Sn}" y2="${zr}" />
        ${Xs?`<text x="${ga}" y="${ya}" class="mindmap-edge-label">${Xs}</text>`:""}
      `}).join(""),x={chapter:"Chapitre",character:"Personnage",place:"Lieu",theme:"Th&egrave;me",event:"&Eacute;v&eacute;nement",note:"Id&eacute;e"},E=b.map(I=>{const q=I.id===r,re=I.id===i,_e=I.id===c,$e=x[I.type]??"Id&eacute;e";return`
        <button
          type="button"
          class="mindmap-node node--${I.type}${q?" is-active":""}${re?" is-source":""}${_e?" is-flash":""}"
          data-action="mindmap-node"
          data-id="${I.id}"
          style="transform: translate(${I.x}px, ${I.y}px);"
          aria-label="${I.title}"
        >
          <span class="mindmap-node-title">${I.title}</span>
          <span class="mindmap-node-type">${$e}</span>
        </button>
      `}).join(""),N=I=>p.map(q=>{const re=q.id===I?"selected":"";return`<option value="${q.id}" ${re}>${q.title||"Sans titre"}</option>`}).join(""),H=I=>m.map(q=>{const _e=`${q.first_name??""} ${q.last_name??""}`.trim()||"Sans nom",$e=q.id===I?"selected":"";return`<option value="${q.id}" ${$e}>${_e}</option>`}).join(""),A=w?`
      <aside class="mindmap-sidebar">
        <header class="mindmap-sidebar-header">
          <h3>N&oelig;ud : ${w.title||"Sans titre"}</h3>
        </header>
        <div class="mindmap-sidebar-body">
          <label class="field"><span>Titre</span>
            <input class="input" type="text" value="${w.title}" data-mindmap-field="title" data-id="${w.id}" />
          </label>
          <label class="field"><span>Type du n&oelig;ud</span>
            <select class="input" data-mindmap-field="type" data-id="${w.id}">
              ${["chapter","character","place","theme","event","note"].map(I=>`<option value="${I}" ${I===w.type?"selected":""}>${x[I]}</option>`).join("")}
            </select>
          </label>
          <label class="field"><span>R&eacute;sum&eacute;</span>
            <textarea class="input" rows="3" data-mindmap-field="summary" data-id="${w.id}">${w.summary??""}</textarea>
          </label>
          <label class="field"><span>Tags</span>
          <input class="input" type="text" value="${(w.tags??[]).join(", ")}" data-mindmap-field="tags" data-id="${w.id}" placeholder="tag1, tag2" />
          </label>
          <label class="field"><span>Lier un chapitre</span>
            <select class="input" data-mindmap-field="linkedChapterId" data-id="${w.id}">
              <option value="">Aucun</option>
              ${N(w.linkedChapterId)}
            </select>
          </label>
          <label class="field"><span>Lier un personnage</span>
            <select class="input" data-mindmap-field="linkedCharacterId" data-id="${w.id}">
              <option value="">Aucun</option>
              ${H(w.linkedCharacterId)}
            </select>
          </label>
          ${w.linkedChapterId||w.linkedCharacterId?`<button type="button" class="btn btn-secondary" data-action="mindmap-open-source" data-id="${w.id}">Ouvrir la source</button>`:""}
        </div>
        <div class="mindmap-sidebar-actions">
          <div class="mindmap-sidebar-divider"></div>
          <button type="button" class="btn btn-danger" data-action="mindmap-delete-node" data-id="${w.id}">Supprimer</button>
        </div>
      </aside>
    `:`
      <aside class="mindmap-sidebar">
        <div class="mindmap-empty">
          <h3>S&eacute;lectionne un n&oelig;ud</h3>
          <p>Choisis un n&oelig;ud pour afficher ses d&eacute;tails.</p>
        </div>
      </aside>
    `,J=l?.open?`
        <div class="mindmap-link-menu" style="transform: translate(${l.x}px, ${l.y}px);">
          <button type="button" data-action="mindmap-link-type" data-type="linked">li&eacute; &agrave;</button>
          <button type="button" data-action="mindmap-link-type" data-type="conflict">conflit</button>
          <button type="button" data-action="mindmap-link-type" data-type="appears">appara&icirc;t dans</button>
          <button type="button" data-action="mindmap-link-type" data-type="cause">cause-cons&eacute;quence</button>
          <button type="button" data-action="mindmap-link-cancel">Valider</button>
        </div>
      `:"",ee=h?.open?`
        <div class="mindmap-context-menu" style="left: ${h.x}px; top: ${h.y}px;">
          <button type="button" class="btn btn-primary" data-action="mindmap-context-add-node">+ N&oelig;ud</button>
          <button type="button" class="btn btn-secondary" data-action="mindmap-context-link">+ Lien</button>
        </div>
      `:"",P=r&&d===r,Y=w?.title||"Sans titre";return`
    <section class="panel card mindmap-panel">
      <header class="mindmap-toolbar">
        <div class="mindmap-toolbar-left">
          <h2>Carte mentale &mdash; Projet : ${n}</h2>
          <p class="mindmap-subtitle">Visualise la structure de ton r&eacute;cit</p>
        </div>
        <div class="mm-controls">
          <div class="mm-controls__group mm-controls__group--actions">
            <button type="button" class="btn btn-primary" data-action="mindmap-add-node">+ N&oelig;ud</button>
            <button type="button" class="btn btn-secondary${s==="link"?" is-active":""}" data-action="mindmap-link-mode">+ Lien</button>
          </div>
          <div class="mm-controls__group mm-controls__group--type">
            <label class="mm-controls__field">
              <span>Type du nouveau n&oelig;ud</span>
              <select id="mindmap-create-type" class="input" data-action="mindmap-create-type">
                ${["chapter","character","place","theme","event","note"].map(I=>`<option value="${I}" ${I===a?"selected":""}>${x[I]}</option>`).join("")}
              </select>
            </label>
          </div>
          <div class="mm-controls__group mm-controls__group--nav">
            <label class="mm-controls__field">
              <span>Recherche</span>
              <div class="mm-controls__row">
                <input class="input" type="text" id="mindmap-search" placeholder="Rechercher..." value="${o}" />
                <button type="button" class="btn btn-secondary mm-controls__recenter" data-action="mindmap-reset" title="Centrer la carte sur l'ensemble des n&oelig;uds">Recentrer</button>
              </div>
            </label>
          </div>
        </div>
      </header>
      <div class="mindmap-body">
        <div class="mindmap-canvas" data-action="mindmap-canvas">
          <div class="mindmap-viewport" style="transform: translate(${f.offsetX}px, ${f.offsetY}px) scale(${f.scale});">
            <svg class="mindmap-edges" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              ${_}
            </svg>
            ${E}
            ${J}
            ${ee}
          </div>
        </div>
        ${A}
      </div>
      ${P?`
        <div class="mindmap-confirm-backdrop" role="dialog" aria-modal="true">
          <div class="mindmap-confirm">
            <h3>Supprimer le n&oelig;ud &quot;${Y}&quot;&nbsp;?</h3>
            <p>Cette action est d&eacute;finitive.</p>
            <div class="mindmap-confirm-actions">
              <button type="button" class="btn btn-ghost" data-action="mindmap-delete-cancel">Annuler</button>
              <button type="button" class="btn btn-danger" data-action="mindmap-delete-confirm" data-id="${r}">Supprimer</button>
            </div>
          </div>
        </div>
      `:""}
    </section>
  `}function nv(n=""){const e=/\[\[([^\]]+)\]\]/g;let t=0,r="",s;for(;(s=e.exec(n))!==null;){const i=n.slice(t,s.index);r+=he(i);const o=s[1]??"",a=o.indexOf("|"),l=a===-1?o:o.slice(0,a),c=a===-1?"":o.slice(a+1),d=l.trim(),h=(c.trim()||d).trim();d?r+=`<button type="button" class="knowledge-link" data-action="knowledge-open-link" data-title="${encodeURIComponent(d)}">${he(h)}</button>`:r+=he(s[0]),t=e.lastIndex}return r+=he(n.slice(t)),r.replace(/\n/g,"<br>")}function rv(n={},e={}){const{nodes:t=[],edges:r=[],selectedNodeId:s=null,view:i={offsetX:0,offsetY:0,scale:1},search:o="",minDegree:a=0,showOrphans:l=!1,blockedMessage:c="",panelCollapsed:d=!1,settingsOpen:h=!1}=n;e.outgoing?.length,e.backlinks?.length;const f={sm:10,md:14,lg:18},p=t.map(A=>A.degree??0).sort((A,J)=>A-J),m=A=>p.length?p[Math.floor((p.length-1)*A)]:0,g=m(.33),y=m(.66),w=A=>!p.length||g===y?"md":A<=g?"sm":A>=y?"lg":"md",v=A=>f[w(A)]??f.md,b=new Map(t.map(A=>[A.id,v(A.degree??0)])),S=new Map(t.map(A=>[A.id,A])),k=new Set;s&&r.forEach(A=>{A.fromId===s?k.add(A.toId):A.toId===s&&k.add(A.fromId)});const _=r.map(A=>{const J=S.get(A.fromId),ee=S.get(A.toId);if(!J||!ee)return"";const P=b.get(A.fromId)??f.md,Y=b.get(A.toId)??f.md,I={x:J.x,y:J.y,width:P,height:P},q={x:ee.x,y:ee.y,width:Y,height:Y},re={x:I.x+I.width/2,y:I.y+I.height/2},_e={x:q.x+q.width/2,y:q.y+q.height/2},$e=ji(I,re,_e),kn=ji(q,_e,re);let Ct="graph-edge";return s&&(A.fromId===s?Ct+=" is-outgoing":A.toId===s?Ct+=" is-incoming":Ct+=" is-dim"),`
        <line class="${Ct}" data-from="${A.fromId}" data-to="${A.toId}" x1="${$e.x}" y1="${$e.y}" x2="${kn.x}" y2="${kn.y}" />
      `}).join(""),x=t.map(A=>{const J=A.id===s,ee=k.has(A.id);let P="mindmap-node graph-node";J?P+=" is-active":ee?P+=" is-neighbor":s&&(P+=" is-dim");const Y=w(A.degree??0);P+=` graph-node--${Y}`;const I=b.get(A.id)??f.md;return`
        <button
          type="button"
          class="${P}"
          data-action="mindmap-node"
          data-id="${A.id}"
          data-title="${encodeURIComponent(A.title||"Sans titre")}"
          aria-label="${he(A.title)}"
          style="transform: translate(${A.x}px, ${A.y}px); width: ${I}px; height: ${I}px;"
        >
          <span class="mindmap-node-title">${he(A.title||"Sans titre")}</span>
        </button>
      `}).join("");(e.outgoing??[]).map(A=>{const J=A.count>1?`<span class="graph-link-count">x${A.count}</span>`:"";return`
        <button type="button" class="graph-link" data-action="wiki-graph-select" data-id="${A.id}">
          <span>${he(A.title)}</span>
          ${J}
        </button>
      `}).join(""),(e.backlinks??[]).map(A=>{const J=(A.contexts??[]).map(ee=>`<p class="graph-backlink-context">${he(ee)}</p>`).join("");return`
        <div class="graph-backlink-item">
          <button type="button" class="graph-link" data-action="wiki-graph-select" data-id="${A.id}">
            <span>${he(A.title||"Sans titre")}</span>
          </button>
          ${J}
        </div>
      `}).join("");const E=`graph-settings-menu${h?" is-open":""}`,N=h?"true":"false",H=c?`<div class="graph-blocked">${he(c)}</div>`:t.length?`
        <div class="knowledge-graph-body">
          <div class="knowledge-graph-canvas">
            <div class="mindmap-canvas wiki-graph-canvas" data-action="mindmap-canvas">
              <div class="mindmap-viewport wiki-graph-viewport" style="transform: translate(${i.offsetX}px, ${i.offsetY}px) scale(${i.scale});">
                <svg class="mindmap-edges graph-edges" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  ${_}
                </svg>
                ${x}
              </div>
            </div>
          </div>
        </div>
      `:'<div class="graph-blocked">Aucune note a afficher pour le moment.</div>';return`
    <div class="knowledge-graph">
      <div class="graph-settings">
        <button
          type="button"
          class="graph-settings-toggle"
          data-action="wiki-graph-settings-toggle"
          aria-expanded="${N}"
          aria-controls="graph-settings-menu"
        >
          &#x2699;
        </button>
        <div id="graph-settings-menu" class="${E}" role="menu">
          <label class="graph-settings-field">
            <span>Recherche</span>
            <input
              id="wiki-graph-search"
              class="input"
              type="text"
              placeholder="Recherche"
              aria-label="Recherche"
              value="${he(o)}"
            />
          </label>
          <div class="graph-settings-field" aria-label="Min connexions">
            <span>Min connexions</span>
            <div class="graph-settings-thresholds">
              <button type="button" class="graph-threshold${Number(a)===0?" is-active":""}" data-action="wiki-graph-min" data-value="0">Tous</button>
              <button type="button" class="graph-threshold${Number(a)===1?" is-active":""}" data-action="wiki-graph-min" data-value="1">1+</button>
              <button type="button" class="graph-threshold${Number(a)===2?" is-active":""}" data-action="wiki-graph-min" data-value="2">2+</button>
              <button type="button" class="graph-threshold${Number(a)===3?" is-active":""}" data-action="wiki-graph-min" data-value="3">3+</button>
              <button type="button" class="graph-threshold${Number(a)===5?" is-active":""}" data-action="wiki-graph-min" data-value="5">5+</button>
            </div>
          </div>
          <label class="graph-settings-toggle-field" title="Afficher orphelines">
            <input id="wiki-graph-orphans" type="checkbox" ${l?"checked":""} />
            <span>Orphelines</span>
          </label>
        </div>
      </div>
      ${H}
      <div id="graph-tooltip" class="graph-tooltip" role="tooltip" aria-hidden="true"></div>
    </div>
  `}function sv({projectTitle:n="",notes:e=[],activeNote:t=null,backlinks:r=[],hasAnyNotes:s=!1,titleDrafts:i={},titleError:o="",duplicates:a=[],renameBusy:l=!1,search:c="",sort:d="recent",previewOpen:h=!1,autocomplete:f={open:!1},tab:p="notes",graph:m={},graphDetails:g={}}={}){const y=p==="graph"?"graph":"notes",w=e.length>0,v=t?.id??null,b=t?.title??"",S=t?.content??"",k=e.map(I=>{const q=I.id===v,re=i[I.id],_e=re!==void 0?re:I.title,$e=Di(I.updated_at);return`
        <button type="button" class="knowledge-note-item${q?" is-active":""}" data-action="knowledge-select" data-id="${I.id}">
          <span class="knowledge-note-title">${he(_e||"Sans titre")}</span>
          <span class="knowledge-note-meta">${$e||""}</span>
        </button>
      `}).join(""),_=c.trim()?"Aucune note ne correspond &agrave; la recherche.":"Aucune note pour l&apos;instant.",x=w?k:s?`
        <div class="knowledge-empty">
          <p>${_}</p>
        </div>
      `:`
        <div class="knowledge-empty">
          <p>${_}</p>
          <button type="button" class="btn btn-secondary" data-action="knowledge-create">Cr&eacute;er la premi&egrave;re note</button>
        </div>
      `,E=v&&Object.prototype.hasOwnProperty.call(i,v)?i[v]:b,N=t?`
        <div class="knowledge-editor">
          <div class="knowledge-editor-header">
            <label class="field knowledge-title-field">
              <span>Titre</span>
              <input id="knowledge-title" class="input" type="text" value="${he(E)}" data-id="${t.id}"${o?' aria-invalid="true"':""} />
              <p id="knowledge-title-error" class="knowledge-title-error${o?" is-visible":""}">${he(o)}</p>
            </label>
            <button type="button" class="btn btn-secondary knowledge-preview-toggle" data-action="knowledge-preview-toggle">
              ${h?"Editer":"Aper&ccedil;u"}
            </button>
          </div>
          <div class="knowledge-editor-body">
            ${h?`<div class="knowledge-preview">${nv(S)}</div>`:`<textarea id="knowledge-content" class="input knowledge-content" rows="14" data-id="${t.id}" placeholder="&Eacute;cris en Markdown. Utilise [[Titre]] pour lier une note.">${he(S)}</textarea>`}
            <div id="knowledge-autocomplete" class="knowledge-autocomplete${f.open?" is-open":""}"></div>
          </div>
          <div class="knowledge-editor-footer">
            <button type="button" class="btn btn-danger danger-hover" data-action="knowledge-delete" data-id="${t.id}">Supprimer</button>
          </div>
        </div>
      `:`
        <div class="knowledge-empty knowledge-empty--editor">
          <h3>S&eacute;lectionne une note</h3>
          <p>Ou cr&eacute;e la premi&egrave;re pour d&eacute;marrer ton wiki.</p>
          <button type="button" class="btn btn-primary" data-action="knowledge-create">+ Nouvelle note</button>
        </div>
      `,H=r.map(I=>{const q=(I.contexts??[]).map(re=>`<p class="knowledge-backlink-context">${he(re)}</p>`).join("");return`
        <div class="knowledge-backlink-item">
          <button type="button" class="knowledge-backlink" data-action="knowledge-select" data-id="${I.id}">
            <span>${he(I.title||"Sans titre")}</span>
          </button>
          ${q}
        </div>
      `}).join(""),A=H||'<p class="knowledge-empty">Aucun lien entrant pour l&apos;instant.</p>',J=a.length?`
        <div class="knowledge-duplicates">
          <div class="knowledge-duplicates-title">Doublons detectes</div>
          ${a.map(I=>{const q=I.notes.slice(1).map(re=>`
                    <div class="knowledge-duplicate-row">
                      <span>${he(re.title||"Sans titre")}</span>
                      <button type="button" class="btn btn-secondary btn-compact" data-action="knowledge-duplicate-rename" data-id="${re.id}">Renommer</button>
                    </div>
                  `).join("");return`
                <div class="knowledge-duplicate-group">
                  <div class="knowledge-duplicate-label">${he(I.title||"Sans titre")}</div>
                  ${q}
                </div>
              `}).join("")}
        </div>
      `:"",ee=`
      <div class="knowledge-tabs" role="tablist" aria-label="Connaissance">
        <button type="button" class="knowledge-tab${y==="notes"?" is-active":""}" data-action="knowledge-tab" data-tab="notes" role="tab" aria-selected="${y==="notes"?"true":"false"}">Notes</button>
        <button type="button" class="knowledge-tab${y==="graph"?" is-active":""}" data-action="knowledge-tab" data-tab="graph" role="tab" aria-selected="${y==="graph"?"true":"false"}">Graphe</button>
      </div>
    `,P=`
      ${J}
      <div class="knowledge-layout">
        <aside class="knowledge-sidebar">
          <div class="knowledge-sidebar-controls">
            <input id="knowledge-search" class="input" type="text" placeholder="Rechercher..." value="${he(c)}" />
            <div class="knowledge-sidebar-actions">
              <button type="button" class="btn btn-primary" data-action="knowledge-create">+ Nouvelle note</button>
              <button type="button" class="btn btn-secondary" data-action="knowledge-sort-toggle">
                ${d==="alpha"?"R&eacute;cents":"A-Z"}
              </button>
            </div>
          </div>
          <div class="knowledge-list">
            ${x}
          </div>
        </aside>
        <section class="knowledge-main">
          ${N}
        </section>
        <aside class="knowledge-backlinks">
          <h3>Li&eacute; depuis</h3>
          ${A}
        </aside>
      </div>
    `,Y=y==="graph"?rv(m,g):"";return`
    <section class="panel card knowledge-panel${y==="graph"?" knowledge-panel--graph":""}">
      <header class="knowledge-header">
        <div>
          <h2>Connaissance</h2>
          <p class="knowledge-subtitle">Projet : ${he(n)}</p>
          ${l?'<p class="knowledge-busy">Mise a jour des liens...</p>':""}
        </div>
        ${ee}
      </header>
      ${y==="graph"?Y:P}
    </section>
  `}function iv({onSignOut:n,userEmail:e="",projects:t=[],selectedProjectId:r=null,editingProjectId:s=null,chapters:i=[],selectedChapterId:o=null,chapterDetail:a=null,versions:l=[],statusText:c="",editorTab:d="session",writingNav:h="chapter",characters:f=[],selectedCharacterId:p=null,characterFilter:m="",inspirationItems:g=[],inspirationSearch:y="",inspirationTag:w="",inspirationModal:v=null,inspirationDetailId:b=null,ideas:S=[],selectedIdeaId:k=null,ideasQuery:_="",ideasTagFilter:x="",ideasStatusFilter:E="all",ideasSort:N="desc",ideasFiltersOpen:H=!1,ideasNoteExpanded:A=!1,knowledgeNotes:J=[],knowledgeActiveNote:ee=null,knowledgeBacklinks:P=[],knowledgeHasNotes:Y=!1,knowledgeSearch:I="",knowledgeSort:q="recent",knowledgeTab:re="notes",knowledgePreviewOpen:_e=!1,knowledgeAutocomplete:$e={open:!1},knowledgeTitleDrafts:kn={},knowledgeTitleError:Ct="",knowledgeDuplicates:Js=[],knowledgeRenameBusy:Ys=!1,wikiGraph:Fr={},wikiGraphDetails:Ur={note:null,outgoing:[],backlinks:[]},focusActive:Sn=!1,focusButtonLabel:zr=" Dmarrer le focus",focusIndicatorLabel:Xs="",mindmapNodes:pa=[],mindmapEdges:ma=[],mindmapSelectedNodeId:Qs=null,mindmapMode:Zs="select",mindmapLinkSourceId:ei=null,mindmapSearch:ti="",mindmapCreateType:ga="note",mindmapLinkTypeMenu:ya=null,mindmapFlashNodeId:Hr=null,mindmapDeleteConfirmId:Eg=null,mindmapContextMenu:Cg=null,mindmapView:Ag={offsetX:0,offsetY:0,scale:1},projectStatsView:Mg=null,characterSections:At={},lastCloudSaveAt:Ig=null,cloudStatus:Og="",cloudBusy:Ng=!1,accountMenuOpen:$g=!1,backupStatus:Rg="",backupMenuOpen:Pg=!1}={}){const _n=!!r,Dg=i.length>0,Vr=!!a,Lg=(_n?t.find(L=>L.id===r):null)?.title??"Sans titre",qr=_n?Lg:"-",fd=Vr?i.findIndex(L=>L.id===o)+1:0;Vr&&fd>0&&i.length&&`${fd}${i.length}`;const jg=i.map(L=>{const Xe=L.id===o;return`
        <li class="chapter-item" draggable="true" data-id="${L.id}">
          <button
            class="list-button${Xe?" is-selected":""}"
            data-action="chapter-select"
            data-id="${L.id}"
          >
            ${L.title}
          </button>
          <button
            type="button"
            class="chapter-delete danger-hover"
            data-action="chapter-delete"
            data-id="${L.id}"
            aria-label="Supprimer le chapitre"
            title="Supprimer"
          >
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </li>
      `}).join("");l.map(L=>`
        <li class="version-item">
          <div>
            <strong>${L.label??"Version"}</strong>
            <div class="muted">${_s(L.created_at)}</div>
          </div>
          <button class="btn btn-primary"
            data-action="version-restore"
            data-id="${L.id}"
            type="button"
          >
            Restaurer
          </button>
        </li>
      `).join("");const Bg=a?.conflict?`
      <div class="conflict">
        <p>Conflit detecte (serveur different).</p>
        <div class="actions">
          <button class="btn btn-primary" data-action="conflict-reload-server" type="button">
            Recharger serveur
          </button>
          <button data-action="conflict-duplicate-local" class="btn btn-secondary" type="button">
            Dupliquer local
          </button>
        </div>
      </div>
    `:"",Fg=Vr?`
      ${Bg}
      <div class="field editor-field">
        <div id="editor-toolbar" class="editor-toolbar" role="toolbar" aria-label="Outils de mise en forme">
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-bold" data-command="bold" aria-label="Gras" title="Gras">
              <span aria-hidden="true">G</span>
            </button>
            <button type="button" class="toolbar-button icon-italic" data-command="italic" aria-label="Italique" title="Italique">
              <span aria-hidden="true">I</span>
            </button>
            <button type="button" class="toolbar-button icon-heading" data-command="heading-1" aria-label="Titre 1" title="Titre 1">
              <span aria-hidden="true">H1</span>
            </button>
            <button type="button" class="toolbar-button icon-heading" data-command="heading-2" aria-label="Titre 2" title="Titre 2">
              <span aria-hidden="true">H2</span>
            </button>
          </div>
          <div class="toolbar-group toolbar-segment" role="group" aria-label="Alignement">
            <button type="button" class="toolbar-button icon-align icon-align-left" data-command="align-left" aria-label="Aligner a gauche" title="Aligner a gauche">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-center" data-command="align-center" aria-label="Centrer" title="Centrer">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-right" data-command="align-right" aria-label="Aligner a droite" title="Aligner a droite">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-align icon-align-justify" data-command="align-justify" aria-label="Justifier" title="Justifier">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-list icon-list-bullet" data-command="bullet-list" aria-label="Liste a puces" title="Liste a puces">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-list icon-list-ordered" data-command="ordered-list" aria-label="Liste numerotee" title="Liste numerotee">
              <span aria-hidden="true"></span>
            </button>
          </div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-button icon-highlight" data-command="highlight" aria-label="Surligner" title="Surligner">
              <span aria-hidden="true">A</span>
            </button>
          </div>
          <div class="toolbar-group">
            <label class="toolbar-label" for="toolbar-font-size">Taille</label>
            <select id="toolbar-font-size" class="toolbar-select input input-sm" data-command="font-size" aria-label="Taille de police" title="Taille de police">
              <option value="12">12</option>
              <option value="14">14</option>
              <option value="16">16</option>
              <option value="18">18</option>
              <option value="24">24</option>
            </select>
          </div>
          <div class="toolbar-group toolbar-group-right">
            <button
              type="button"
              class="focus-toggle${Sn?" is-active":""}"
              data-action="focus-toggle"
              aria-pressed="${Sn?"true":"false"}"
            >
              <span class="focus-toggle-label">${zr}</span>
            </button>
            <button type="button" class="toolbar-button icon-history" data-command="undo" aria-label="Annuler" title="Annuler">
              <span aria-hidden="true"></span>
            </button>
            <button type="button" class="toolbar-button icon-history" data-command="redo" aria-label="Retablir" title="Retablir">
              <span aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="paper-shell">
          <div id="chapter-editor" class="editor-canvas" aria-label="Contenu du chapitre"></div>
        </div>
      </div>
    `:`
      <div class="empty">
        <p>${_n?"Cree un chapitre pour ecrire.":"Commence par creer un projet."}</p>
      </div>
    `,Ug="",zg=`
    <button
      id="project-export"
      data-action="project-export-md"
      type="button"
      class="btn btn-secondary btn-compact"
      ${_n?"":"disabled"}
      aria-disabled="${_n?"false":"true"}"
      aria-label="Exporter le projet en Markdown"
      title="Exporter le projet en Markdown"
    >
      Exporter
    </button>
  `,Hg=Vr?a?.title??"":"-",ni=f.filter(L=>{if(!m.trim())return!0;const Xe=m.trim().toLowerCase(),ot=`${L.first_name??""} ${L.last_name??""}`.toLowerCase(),at=(L.nickname??"").toLowerCase();return ot.includes(Xe)||at.includes(Xe)}),pd=p??ni[0]?.id??null,W=f.find(L=>L.id===pd)??null,md=W?.first_name||W?.last_name?`${W?.first_name??""} ${W?.last_name??""}`.trim():"Personnage sans nom",Vg=md.split(" ").filter(Boolean).slice(0,2).map(L=>L[0]?.toUpperCase()).join("")||"?",qg=W?.avatar_url?.trim()?W.avatar_url.trim():"/character-placeholder.svg",Wg=W?.age?`${W.age} ans`:"",Kg=(W?.residence??"").trim()||(W?.birth_place??"").trim(),gd=[Wg,Kg].filter(Boolean).join("  "),Gg=Math.max(0,Math.min(5,Number(W?.role_rating??0))),Mt=(L,Xe,ot,at)=>`
        <section class="character-accordion${at?" is-open":""}">
          <button
            type="button"
            class="character-accordion-header"
            data-action="character-toggle"
            data-section="${L}"
            aria-expanded="${at}"
          >
            <span class="character-dot"></span>
            <span>${Xe}</span>
            <span class="character-accordion-icon" aria-hidden="true">></span>
          </button>
          ${at?`<div class="character-accordion-body">${ot}</div>`:""}
        </section>
      `,Jg=W?`
      <div class="character-detail-panel">
        <div class="character-hero">
          <button type="button" class="character-hero-avatar" data-action="character-avatar" aria-label="Changer l'avatar">
            <img src="${qg}" alt="${Vg}" />
          </button>
          <input id="character-avatar-input" type="file" accept="image/*" hidden />
          <div class="character-hero-info">
            <h3>${md}</h3>
            ${gd?`<div class="character-meta">${gd}</div>`:""}
          </div>
            <div class="character-hero-meta">
              <p>Role :</p>
              <div class="character-stars" role="radiogroup" aria-label="Role">
                ${[1,2,3,4,5].map(L=>`
                  <button
                    type="button"
                    class="character-star${L<=Gg?" is-active":""}"
                    data-action="character-rate"
                    data-rating="${L}"
                    aria-label="${L} etoiles"
                  >
                    
                  </button>
                `).join("")}
              </div>
            </div>
        </div>
        <div class="character-sections">
          ${Mt("civil","Etat civil",`
              <div class="character-grid">
                <label>
                  <span>Prenom</span>
                  <input class="input" type="text" value="${W.first_name??""}" data-character-field="first_name" />
                </label>
                <label>
                  <span>Nom de famille</span>
                  <input class="input" type="text" value="${W.last_name??""}" data-character-field="last_name" />
                </label>
                <label>
                  <span>Surnom</span>
                  <input class="input" type="text" value="${W.nickname??""}" data-character-field="nickname" />
                </label>
                <label>
                  <span>Pronoms</span>
                  <input class="input" type="text" value="${W.pronouns??""}" data-character-field="pronouns" />
                </label>
                <label class="character-inline">
                  <span>Sexe</span>
                  <div class="character-inline-row">
                    <label><input type="radio" name="sex" value="femme" data-character-field="sex" ${W.sex==="femme"?"checked":""} />Femme</label>
                    <label><input type="radio" name="sex" value="homme" data-character-field="sex" ${W.sex==="homme"?"checked":""} />Homme</label>
                    <label><input type="radio" name="sex" value="autre" data-character-field="sex" ${W.sex==="autre"?"checked":""} />Autre</label>
                  </div>
                </label>
                <label>
                  <span>Race</span>
                  <input class="input" type="text" value="${W.race??""}" data-character-field="race" />
                </label>
                <label>
                  <span>Age</span>
                  <input class="input" type="number" value="${W.age??""}" data-character-field="age" />
                </label>
                <label>
                  <span>Date de naissance</span>
                  <input class="input" type="date" value="${W.birth_date??""}" data-character-field="birth_date" />
                </label>
                <label>
                  <span>Lieu de naissance</span>
                  <input class="input" type="text" value="${W.birth_place??""}" data-character-field="birth_place" />
                </label>
                <label>
                  <span>Lieu de residence</span>
                  <input class="input" type="text" value="${W.residence??""}" data-character-field="residence" />
                </label>
                <label>
                  <span>Occupation</span>
                  <input class="input" type="text" value="${W.occupation??""}" data-character-field="occupation" />
                </label>
              </div>
            `,At.civil)}
          ${Mt("physique","Physique",`
              <div class="character-physique">
                <div class="character-physique-preview">
                  <img
                    src="${W.meta?.physique?.image_url?.trim()?W.meta.physique.image_url.trim():"/character-placeholder.svg"}"
                    alt="Physique du personnage"
                  />
                </div>
                <button type="button" class="btn btn-secondary btn-compact" data-action="character-physique">
                  Charger une image
                </button>
                <input id="character-physique-input" type="file" accept="image/*" hidden />
              </div>
            `,At.physique)}
          ${Mt("caractere","Caractere",`
              <div class="character-grid">
                <label>
                  <span>Traits dominants</span>
                  <textarea data-character-meta="caractere" data-character-field="traits">${W.meta?.caractere?.traits??""}</textarea>
                </label>
                <label>
                  <span>Qualites</span>
                  <textarea data-character-meta="caractere" data-character-field="qualites">${W.meta?.caractere?.qualites??""}</textarea>
                </label>
                <label>
                  <span>Defauts</span>
                  <textarea data-character-meta="caractere" data-character-field="defauts">${W.meta?.caractere?.defauts??""}</textarea>
                </label>
                <label>
                  <span>Peur(s)</span>
                  <textarea data-character-meta="caractere" data-character-field="peurs">${W.meta?.caractere?.peurs??""}</textarea>
                </label>
              </div>
            `,At.caractere)}
          ${Mt("profil","Profil",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Histoire courte</span>
                  <textarea data-character-meta="profil" data-character-field="histoire">${W.meta?.profil?.histoire??""}</textarea>
                </label>
                <label>
                  <span>Objectifs</span>
                  <textarea data-character-meta="profil" data-character-field="objectifs">${W.meta?.profil?.objectifs??""}</textarea>
                </label>
                <label>
                  <span>Relations</span>
                  <textarea data-character-meta="profil" data-character-field="relations">${W.meta?.profil?.relations??""}</textarea>
                </label>
              </div>
            `,At.profil)}
          ${Mt("storyRole","Role dans l'histoire",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Role dans l'histoire</span>
                  <textarea data-character-field="storyRole" placeholder="Decris la fonction narrative du personnage...">${W.storyRole??""}</textarea>
                </label>
              </div>
            `,At.storyRole)}
          ${Mt("evolution","Evolution",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Arc</span>
                  <textarea data-character-meta="evolution" data-character-field="arc">${W.meta?.evolution?.arc??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Changements</span>
                  <textarea data-character-meta="evolution" data-character-field="changements">${W.meta?.evolution?.changements??""}</textarea>
                </label>
                <label class="character-inline">
                  <span>Etapes cles</span>
                  <textarea data-character-meta="evolution" data-character-field="etapes">${W.meta?.evolution?.etapes??""}</textarea>
                </label>
              </div>
            `,At.evolution)}
          ${Mt("inventaire","Inventaire",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Objets</span>
                  <textarea data-character-meta="inventaire" data-character-field="items">${W.meta?.inventaire?.items??""}</textarea>
                </label>
              </div>
            `,At.inventaire)}
          ${Mt("possession","Possession",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Biens & lieux</span>
                  <textarea data-character-meta="possession" data-character-field="biens">${W.meta?.possession?.biens??""}</textarea>
                </label>
              </div>
            `,At.possession)}
          ${Mt("autres","Autres",`
              <div class="character-grid">
                <label class="character-inline">
                  <span>Notes libres</span>
                  <textarea data-character-meta="autres" data-character-field="notes">${W.meta?.autres?.notes??""}</textarea>
                </label>
              </div>
            `,At.autres)}
        </div>
      </div>
    `:`
      <div class="character-detail-panel empty">
        <p>Selectionnez un personnage.</p>
      </div>
    `,Yg=`
        <section class="panel card character-panel characters-skin">
          <div class="character-shell">
            <aside class="character-list characters-panel">
              <div class="characters-panel__header">
                <div class="characters-panel__title">
                  Personnages <span class="characters-panel__count"> ${ni.length}</span>
                </div>
                <button type="button" class="characters-panel__create btn btn-secondary btn-compact" data-action="character-create" aria-label="Nouveau personnage" title="Nouveau personnage">
                  <span aria-hidden="true">+</span> Nouveau personnage
                </button>
              </div>
              <div class="characters-panel__search">
                <input class="input" id="character-filter" type="text" placeholder="Rechercher..." value="${m}" />
              </div>
              <div class="characters-list">
                ${ni.length?ni.map(L=>{const Xe=`${L.first_name??""} ${L.last_name??""}`.trim(),ot=!!Xe,at=ot?Xe:"Sans nom",wa=ot?Xe.split(" ").filter(Boolean).slice(0,2).map(ka=>ka[0]?.toUpperCase()).join(""):"NP",ba=L.avatar_url?.trim()?L.avatar_url.trim():"/character-placeholder.svg",ri=ot?"":'<span class="characters-item__meta">Brouillon</span>',va=ot?`Supprimer ${at}`:"Supprimer ce personnage";return`
                            <div class="characters-item${L.id===pd?" is-active":""}" data-action="character-select" data-id="${L.id}">
                              <button
                                type="button"
                                class="characters-item__main"
                                data-action="character-select"
                                data-id="${L.id}"
                              >
                                <span class="characters-item__avatar">
                                  <img src="${ba}" alt="${wa}" />
                                </span>
                                <span class="characters-item__content">
                                  <span class="characters-item__name">${at}</span>
                                  ${ri}
                                </span>
                              </button>
                              <button
                                type="button"
                                class="characters-item__delete danger-hover"
                                data-action="character-delete"
                                data-id="${L.id}"
                                aria-label="${va}"
                                title="Supprimer"
                              >
                                <span aria-hidden="true"></span>
                              </button>
                            </div>
                          `}).join(""):`<p class="muted">Aucun personnage pour le moment.
                  Cree ton premier personnage pour commencer.</p>`}
              </div>
            </aside>
            ${Jg}
          </div>
        </section>
      `,Xg=ev({projectTitle:qr,inspirationItems:g,inspirationSearch:y,inspirationTag:w,inspirationModal:v,inspirationDetailId:b,chapters:i,characters:f}),Qg=tv({projectTitle:qr,nodes:pa,edges:ma,selectedNodeId:Qs,mode:Zs,linkSourceId:ei,search:ti,createType:ga,linkTypeMenu:ya,flashNodeId:Hr,mindmapDeleteConfirmId:Eg,mindmapContextMenu:Cg,view:Ag,chapters:i,characters:f}),Zg=sv({projectTitle:qr,notes:J,activeNote:ee,backlinks:P,hasAnyNotes:Y,titleDrafts:kn,titleError:Ct,duplicates:Js,renameBusy:Ys,search:I,sort:q,tab:re,previewOpen:_e,autocomplete:$e,graph:Fr,graphDetails:Ur}),ey=`
        <section class="ideas-panel">
          <div class="ideas-content ideas-content--embedded">
            ${Qb({ideas:S,selectedIdeaId:k,ideasQuery:_,ideasTagFilter:x,ideasStatusFilter:E,ideasSort:N,ideasFiltersOpen:H,ideasNoteExpanded:A})}
          </div>
        </section>
      `,ty=`
        <aside class="writing-secondary">
          <section class="panel card story-panel">
            <header class="story-panel__header">
              <h3>Chapitres</h3>
              <button type="button" class="btn btn-secondary btn-compact" data-action="chapter-create" aria-label="Nouveau chapitre" title="Nouveau chapitre" ${_n?"":"disabled"}>
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
                              </button>
            </header>
            <div class="story-panel__divider"></div>

            <div class="story-panel__section story-panel__search">
              <div class="story-panel__search-row">
                <input class="input" id="chapter-search-input" type="text" placeholder="Rechercher..." />
              </div>
            </div>

            <div class="story-panel__section story-panel__chapters">
              <div class="story-panel__list">
                ${_n?Dg?`<ul class="list chapter-list">${jg}</ul>`:'<p class="muted">Cree un chapitre pour ecrire.</p>':'<p class="muted">Selectionne un projet.</p>'}
              </div>
            </div>

            <div class="story-panel__section story-panel__footer">
              <div class="story-panel__file-actions">
                <button type="button" class="btn btn-secondary btn-compact">Importer</button>
                ${zg}
              </div>
            </div>
          </section>
        </aside>
      `,ny=(()=>{const L=Mg;if(!L)return`
        <section class="panel card stats-panel">
          <header class="stats-header">
            <div>
              <h2>Statistiques</h2>
              <p class="muted">Projet : ${qr}</p>
            </div>
          </header>
          <p class="muted">Chargement des statistiques...</p>
        </section>
      `;const Xe=L.totalWords??0,ot=L.totalChapters??0,at=L.daysActive??0,wa=ot>0,ba=L.timeSpentMinutes?`${L.timeSpentMinutes} min`:"",ri=L.timeSpentMinutes?"":"Tes sessions appara&icirc;tront ici d&egrave;s que tu utiliseras le focus.",va=L.timePerDayMinutes?`${L.timePerDayMinutes} min`:"",ka=L.wordsPerDay?`${L.wordsPerDay} mots / jour`:"",si=L.lastActivity,ry=si?.timestamp?_s(new Date(si.timestamp).toISOString()):"Aucune activit&eacute;",sy=si?`${si.words} mots`:"",Wr=L.series??[],iy=Wr.length>0?(()=>{const Sa=Math.max(...Wr.map(_a=>_a.words),1),ii=6,wd=Math.max(8,(420-ii*(Wr.length-1))/Wr.length);return`
              <svg class="stats-chart" viewBox="0 0 420 140" role="img" aria-label="Evolution des mots">
                ${Wr.map((_a,dy)=>{const bd=Math.round(_a.words/Sa*120),uy=Math.round(dy*(wd+ii)),hy=140-bd;return`<rect x="${uy}" y="${hy}" width="${wd}" height="${bd}" rx="4"></rect>`}).join("")}
              </svg>
            `})():`
          <div class="stats-evolution-placeholder">
            <div class="stats-evolution-dots">
              <span></span><span></span><span></span><span></span>
            </div>
            <p class="stats-empty">Ton &eacute;volution appara&icirc;tra ici d&egrave;s tes premi&egrave;res sessions d&apos;&eacute;criture.</p>
          </div>
        `,oy=Math.max(...(L.chapters??[]).map(tr=>tr.words),1),ay=(L.chapters??[]).map((tr,yd)=>{const Sa=tr.title||`Chapitre ${yd+1}`,ii=Math.round(tr.words/oy*100);return`
          <div class="stats-chapter-row">
            <div class="stats-chapter-meta">
              <span class="stats-chapter-title">${Sa}</span>
              <span class="stats-chapter-words">${tr.words} mots</span>
            </div>
            <div class="stats-chapter-bar">
              <span style="width: ${ii}%;"></span>
            </div>
          </div>
        `}).join(""),ly=at?`
          <div class="stats-rhythm">
            <div>
              <span class="stats-rhythm-label">Moyenne</span>
              <span class="stats-rhythm-value">${ka}</span>
              <span class="stats-rhythm-meta">${va} / jour</span>
            </div>
            <div class="stats-rhythm-item stats-rhythm-item--last">
              <span class="stats-rhythm-label">Derni&egrave;re activit&eacute;</span>
              <span class="stats-rhythm-value">${ry}</span>
              <span class="stats-rhythm-meta">${sy}</span>
            </div>
          </div>
        `:'<p class="stats-empty">Ton rythme se dessinera naturellement au fil des jours.</p>',cy=(L.chapters??[]).length>0?`
          <div class="stats-chapters">
            ${ay}
          </div>
        `:'<p class="stats-empty">Commence &agrave; &eacute;crire pour voir appara&icirc;tre tes statistiques.</p>';return`
      <section class="panel card stats-panel">
        <header class="stats-header">
          <div>
            <h2>Statistiques</h2>
            <p class="stats-subtitle">Projet : ${qr}</p>
            <p class="stats-note">Donn&eacute;es calcul&eacute;es automatiquement &agrave; partir de l&apos;&eacute;criture.</p>
            ${wa?"":'<p class="stats-empty">Commence &agrave; &eacute;crire pour voir appara&icirc;tre tes statistiques.</p>'}
          </div>
        </header>
        <section class="stats-kpis">
          <div class="stats-kpi">
            <span class="stats-kpi__value">${ba}</span>
            <span class="stats-kpi__label">Temps d&apos;&eacute;criture</span>
            ${ri?`<span class="stats-kpi__note">${ri}</span>`:""}
          </div>
          <div class="stats-kpi">
            <span class="stats-kpi__value">${Xe}</span>
            <span class="stats-kpi__label">Mots &eacute;crits</span>
          </div>
          <div class="stats-kpi">
            <span class="stats-kpi__value">${ot}</span>
            <span class="stats-kpi__label">Chapitres</span>
          </div>
          <div class="stats-kpi">
            <span class="stats-kpi__value">${at}</span>
            <span class="stats-kpi__label">Jours actifs</span>
          </div>
        </section>
        <section class="stats-section">
          <h3>Rythme</h3>
          ${ly}
        </section>
        <section class="stats-section">
          <h3>&Eacute;volution dans le temps</h3>
          ${iy}
        </section>
        <section class="stats-section">
          <h3>R&eacute;partition par chapitre</h3>
          ${cy}
        </section>
      </section>
    `})();return`
    <section class="page-shell writing-page${h==="knowledge"&&re==="graph"?" writing-page--graph":""}">
      ${pc({userEmail:e,activeRoute:"projects",lastProjectId:r,lastCloudSaveAt:Ig,cloudStatus:Og,cloudBusy:Ng,accountMenuOpen:$g,backupStatus:Rg,backupMenuOpen:Pg})}
    <div class="page app-shell">
        <div class="writing-layout${h==="chapter"?" with-chapter":""}${h==="stats"?" has-stats":""}${h==="knowledge"&&re==="graph"?" writing-layout--graph":""}">
        <aside class="writing-sidebar editor-sidebar">
          <section class="panel card writing-nav">
            <div class="writing-nav-header">Plumeo</div>
            <nav class="writing-nav-list" aria-label="Navigation ecriture">
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="chapter"?" is-active":""}" data-action="writing-nav" data-nav="chapter" aria-label="Chapitre" title="Chapitre">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M4 20l4-1 11-11-3-3-11 11-1 4z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M14 6l3 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Chapitre</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="characters"?" is-active":""}" data-action="writing-nav" data-nav="characters" aria-label="Personnages" title="Personnages">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="8" r="4.5" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M5 20c1.6-3.2 5-5 7-5s5.4 1.8 7 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Personnages</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="inspiration"?" is-active":""}" data-action="writing-nav" data-nav="inspiration" aria-label="Inspiration" title="Inspiration">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M12 3a6 6 0 0 0-3 11.2V17h6v-2.8A6 6 0 0 0 12 3z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M9 21h6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Inspiration</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="ideas"?" is-active":""}" data-action="writing-nav" data-nav="ideas" aria-label="Idees" title="Idees">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 4h9l3 3v13H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M15 4v3h3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Idees</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="mindmap"?" is-active":""}" data-action="writing-nav" data-nav="mindmap" aria-label="Carte mentale" title="Carte mentale">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <circle cx="8" cy="8" r="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <circle cx="16" cy="16" r="2" fill="none" stroke="currentColor" stroke-width="1.6"/>
                    <path d="M9.5 9.5l5 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Carte mentale</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="knowledge"?" is-active":""}" data-action="writing-nav" data-nav="knowledge" aria-label="Connaissance" title="Connaissance">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M6 4h10a2 2 0 0 1 2 2v12a1 1 0 0 1-1 1H7a2 2 0 0 0-2 2V6a2 2 0 0 1 2-2z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                    <path d="M6 8h8M6 12h8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Connaissance</span>
              </button>
              <button type="button" class="writing-nav-item editor-sidebar__item${h==="stats"?" is-active":""}" data-action="writing-nav" data-nav="stats" aria-label="Statistiques" title="Statistiques">
                <span class="writing-nav-icon editor-sidebar__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24">
                    <path d="M5 18V9m7 9V6m7 12v-7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    <path d="M4 18h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
                <span class="editor-sidebar__label">Statistiques</span>
              </button>
            </nav>
          </section>
        </aside>

        ${h==="chapter"?ty:""}

        <main class="writing-editor${h==="inspiration"?" writing-editor--wide":""}${h==="ideas"?" writing-editor--ideas":""}${h==="mindmap"?" writing-editor--mindmap":""}${h==="knowledge"?" writing-editor--knowledge":""}${h==="stats"?" writing-editor--stats":""}${h==="knowledge"&&re==="graph"?" writing-editor--knowledge-graph":""}">
        ${h==="characters"?Yg:h==="inspiration"?Xg:h==="ideas"?ey:h==="mindmap"?Qg:h==="knowledge"?Zg:h==="stats"?ny:`
            <section class="panel card editor ${Vr?"":"is-disabled"}">
              <div class="panel-header editor-header">
                <div class="editor-header-left">
                  <span class="chapter-title">${he(Hg||"Sans titre")}</span>
                  <span id="focus-indicator" class="focus-indicator${Sn?" is-active":""}">${Xs}</span>
                </div>
                <div class="editor-header-right">
                  <span id="status-text" class="status">${c}</span>
                  <span id="editor-word-count" class="status"></span>
                </div>
              </div>
              <div class="editor-body">
                ${Fg}
              </div>
            </section>
          `}
        </main>
        </div>
        ${Ug}
        
      </div>
    </section>
  `}async function Et(){try{const{data:n,error:e}=await ye.auth.getUser();return e?{ok:!1,errorMessage:e.message}:n.user?{ok:!0,userId:n.user.id}:{ok:!1,errorMessage:"User not authenticated"}}catch(n){return{ok:!1,errorMessage:n.message}}}async function ov(){const n=await Et();if(!n.ok)return n;try{const{data:e,error:t}=await ye.from("projects").select("id,title,created_at").eq("user_id",n.userId).order("created_at",{ascending:!0});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function qh(n){const e=await Et();if(!e.ok)return e;if(!n)return{ok:!1,errorMessage:"Missing project id"};try{const{data:t,error:r}=await ye.from("projects").select("id").eq("id",n).eq("user_id",e.userId).maybeSingle();return r?{ok:!1,errorMessage:r.message}:{ok:!0,exists:!!t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function mc(n){const e=await Et();if(!e.ok)return e;try{const{data:t,error:r}=await ye.from("projects").insert({title:n,user_id:e.userId}).select("id,title,created_at").single();return r?{ok:!1,errorMessage:r.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function av(n,e){try{const{data:t,error:r}=await ye.from("projects").update({title:e}).eq("id",n).select("id,title").single();return r?{ok:!1,errorMessage:r.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function Wh(n){const e=await Et();if(!e.ok)return e;try{const{error:t}=await ye.from("chapters").delete().eq("project_id",n).eq("user_id",e.userId);if(t)return{ok:!1,errorMessage:t.message};const{error:r}=await ye.from("projects").delete().eq("id",n).eq("user_id",e.userId);return r?{ok:!1,errorMessage:r.message}:{ok:!0}}catch(t){return{ok:!1,errorMessage:t.message}}}async function lv(n){try{const{data:e,error:t}=await ye.from("chapters").select("id,project_id,title,order_index,revision").eq("project_id",n).order("order_index",{ascending:!0});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Kh(n,e,t){const r=await Et();if(!r.ok)return r;try{const{data:s,error:i}=await ye.from("chapters").insert({project_id:n,title:e,order_index:t,user_id:r.userId}).select("id,project_id,title,order_index,revision,content_md").single();return i?{ok:!1,errorMessage:i.message}:{ok:!0,data:s}}catch(s){return{ok:!1,errorMessage:s.message}}}async function cv({id:n,projectId:e,title:t,orderIndex:r,contentMd:s=""}){const i=await Et();if(!i.ok)return i;if(!n||!e)return{ok:!1,errorMessage:"Missing chapter id or project id"};try{const{data:o,error:a}=await ye.from("chapters").insert({id:n,project_id:e,title:t,order_index:r,content_md:s,user_id:i.userId}).select("id,project_id,title,order_index,revision,content_md").single();return a?{ok:!1,errorMessage:a.message}:{ok:!0,data:o}}catch(o){return{ok:!1,errorMessage:o.message}}}async function dv(n){try{const{data:e,error:t}=await ye.from("chapters").select("id,project_id,title,content_md,order_index,revision").eq("id",n).single();return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Gh(n){return dv(n)}async function uv(n,e){try{const{data:t,error:r}=await ye.from("chapters").update(e).eq("id",n).select("id").single();return r?{ok:!1,errorMessage:r.message}:{ok:!0,data:t}}catch(t){return{ok:!1,errorMessage:t.message}}}async function hv({id:n,title:e,content_md:t,baseRevision:r}){const s=await Et();if(!s.ok)return s;const i=o=>{if(Array.isArray(o)){const a=o[0];return a&&typeof a.new_revision<"u"?Number(a.new_revision):Number(o[0])}return o&&typeof o.new_revision<"u"?Number(o.new_revision):Number(o)};try{const{data:o,error:a}=await ye.rpc("update_chapter_if_revision",{p_id:n,p_user_id:s.userId,p_title:e,p_content_md:t,p_base_revision:r});if(a)return{ok:!1,errorMessage:a.message};const l=i(o);return{ok:!0,newRevision:Number.isFinite(l)?l:-1}}catch(o){return{ok:!1,errorMessage:o.message}}}async function fv(n){try{const{data:e,error:t}=await ye.from("versions").select("id,chapter_id,label,content_md,created_at").eq("chapter_id",n).order("created_at",{ascending:!1});return t?{ok:!1,errorMessage:t.message}:{ok:!0,data:e??[]}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Jh(n,e,t=null){const r=await Et();if(!r.ok)return r;try{const{data:s,error:i}=await ye.from("versions").insert({chapter_id:n,user_id:r.userId,content_md:e,label:t}).select("id,chapter_id,label,content_md,created_at").single();return i?{ok:!1,errorMessage:i.message}:{ok:!0,data:s}}catch(s){return{ok:!1,errorMessage:s.message}}}const pv="writer_db",mv=8;let An=null,en=null;function gv(){return An||(An=new Promise((n,e)=>{const t=indexedDB.open(pv,mv);t.onupgradeneeded=()=>{const r=t.result;r.objectStoreNames.contains("projects")||r.createObjectStore("projects",{keyPath:"id"}),r.objectStoreNames.contains("chapters")||r.createObjectStore("chapters",{keyPath:"id"}),r.objectStoreNames.contains("outbox")||r.createObjectStore("outbox",{keyPath:"opId"}),r.objectStoreNames.contains("characters")||r.createObjectStore("characters",{keyPath:"id"}),r.objectStoreNames.contains("inspiration")||r.createObjectStore("inspiration",{keyPath:"id"}),r.objectStoreNames.contains("mindmap_nodes")||r.createObjectStore("mindmap_nodes",{keyPath:"id"}),r.objectStoreNames.contains("mindmap_edges")||r.createObjectStore("mindmap_edges",{keyPath:"id"}),r.objectStoreNames.contains("ideas")||r.createObjectStore("ideas",{keyPath:"id"}),r.objectStoreNames.contains("knowledge_notes")||r.createObjectStore("knowledge_notes",{keyPath:"id"}),r.objectStoreNames.contains("knowledge_links")||r.createObjectStore("knowledge_links",{keyPath:"id"}),r.objectStoreNames.contains("writing_sessions")||r.createObjectStore("writing_sessions",{keyPath:"id"}),r.objectStoreNames.contains("focus_sessions")||r.createObjectStore("focus_sessions",{keyPath:"id"})},t.onsuccess=()=>{en=t.result,en.onversionchange=()=>{try{en.close()}catch{}en=null,An=null},n(en)},t.onerror=()=>{An=null,e(t.error)},t.onblocked=()=>{}}),An)}const yv=n=>n&&["InvalidStateError","TransactionInactiveError","AbortError"].includes(n.name);async function Bs(n,e=1){try{const t=await gv();return await n(t)}catch(t){if(e>0&&yv(t)){if(en)try{en.close()}catch{}return en=null,An=null,Bs(n,e-1)}throw t}}async function V(n,e){return Bs(t=>new Promise((r,s)=>{const i=t.transaction(n,"readwrite");i.oncomplete=()=>r(),i.onerror=()=>s(i.error),i.objectStore(n).put(e)}))}async function mt(n,e){return Bs(t=>new Promise((r,s)=>{const o=t.transaction(n,"readonly").objectStore(n).get(e);o.onsuccess=()=>r(o.result),o.onerror=()=>s(o.error)}))}async function F(n){return Bs(e=>new Promise((t,r)=>{const i=e.transaction(n,"readonly").objectStore(n).getAll();i.onsuccess=()=>t(i.result),i.onerror=()=>r(i.error)}))}async function pe(n,e){return Bs(t=>new Promise((r,s)=>{const i=t.transaction(n,"readwrite");i.oncomplete=()=>r(),i.onerror=()=>s(i.error),i.objectStore(n).delete(e)}))}function wv(n,e,t=!1){const r=e??{},s=n.revision??n.remote_revision??r.remote_revision??0,i=!t&&(r.dirty===!0||r.conflict===!0),o=i?r.content_md??n.content_md??"":n.content_md??r.content_md??"",a=i?r.title??n.title??"":n.title??r.title??"";return{id:n.id??r.id,project_id:n.project_id??r.project_id,title:a,content_md:o,order_index:n.order_index??r.order_index??0,remote_revision:i?r.remote_revision??s:s,dirty:t?!1:r.dirty??!1,conflict:t?!1:r.conflict??!1,server_copy:t?null:r.server_copy??null,updated_local_at:r.updated_local_at??null,last_snapshot_at:r.last_snapshot_at??null,pending_create:t?!1:r.pending_create??!1}}function bv(n,e){const t=e??{};return{...t,...n,status:n.status??t.status??"active"}}async function Lr(n){for(const e of n){const t=await mt("projects",e.id),r=bv(e,t);await V("projects",r)}}async function Fs(n,{force:e=!1}={}){for(const t of n){const r=await mt("chapters",t.id),s=wv(t,r,e);await V("chapters",s)}}async function vv(){return F("projects")}async function Fo(n){return(await F("chapters")).filter(t=>t.project_id===n).sort((t,r)=>(t.order_index??0)-(r.order_index??0))}async function Uo(n){return mt("chapters",n)}async function kv(n){n&&await pe("chapters",n)}async function Yh(n){n&&await pe("projects",n)}async function Xh(n,e){if(!n)return null;const t=await mt("projects",n);if(!t)return null;const r={...t,...e};return await V("projects",r),r}async function Qh(n){if(!n)return;const t=(await F("chapters")).filter(r=>r.project_id===n);for(const r of t)await pe("chapters",r.id)}async function Zh(n){if(!n)return;const t=(await F("inspiration")).filter(r=>r.project_id===n);for(const r of t)await pe("inspiration",r.id)}async function ef(n){if(!n)return;const e=await F("mindmap_nodes"),t=await F("mindmap_edges"),r=e.filter(i=>i.project_id===n),s=t.filter(i=>i.project_id===n);for(const i of r)await pe("mindmap_nodes",i.id);for(const i of s)await pe("mindmap_edges",i.id)}async function tf(n){if(!n)return;const e=await F("knowledge_notes"),t=await F("knowledge_links"),r=e.filter(i=>i.project_id===n),s=t.filter(i=>i.project_id===n);for(const i of r)await pe("knowledge_notes",i.id);for(const i of s)await pe("knowledge_links",i.id)}async function nf(n){if(!n)return;const t=(await F("focus_sessions")).filter(r=>r.project_id===n);for(const r of t)await pe("focus_sessions",r.id)}async function gc(n,e){const t=await mt("chapters",n),r={...t??{id:n},...e,remote_revision:e.remote_revision??t?.remote_revision??0,dirty:!0,conflict:t?.conflict??!1,server_copy:t?.server_copy??null,updated_local_at:Date.now(),last_snapshot_at:e.last_snapshot_at??t?.last_snapshot_at??null,pending_create:t?.pending_create??!1};return await V("chapters",r),r}function Sv(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}async function _v(n,e,t){if(!n)return null;const r=Date.now(),s={id:Sv(),project_id:n,title:e,content_md:"",order_index:t??0,remote_revision:0,dirty:!0,conflict:!1,server_copy:null,updated_local_at:r,last_snapshot_at:null,pending_create:!0,created_at:r};return await V("chapters",s),s}function xv(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}async function Tv(n){const e=Date.now(),t=Number.isFinite(n?.started_at)?n.started_at:e,r=Number.isFinite(n?.ended_at)?n.ended_at:t,s=Number.isFinite(n?.duration_ms)?n.duration_ms:Math.max(0,r-t),i={id:xv(),project_id:n?.project_id??null,chapter_id:n?.chapter_id??null,started_at:t,ended_at:r,duration_ms:s,created_at:e};return await V("writing_sessions",i),i}async function Ev(){return F("writing_sessions")}async function Cv(n){return(await F("characters")).filter(t=>t.project_id===n).sort((t,r)=>(t.created_at??0)-(r.created_at??0))}async function Av(n){const e=Date.now(),t={id:`${e}-${Math.random().toString(16).slice(2)}`,project_id:n,first_name:"",last_name:"",nickname:"",pronouns:"",sex:"",race:"",age:"",birth_date:"",birth_place:"",residence:"",occupation:"",role_rating:0,storyRole:"",avatar_url:"",meta:{physique:{taille:"",corpulence:"",signes:"",style:"",image_url:""},caractere:{traits:"",qualites:"",defauts:"",peurs:""},profil:{histoire:"",objectifs:"",relations:""},evolution:{arc:"",changements:"",etapes:""},inventaire:{items:""},possession:{biens:""},autres:{notes:""}},created_at:e,updated_at:e};return await V("characters",t),t}async function Bi(n,e){const t=await mt("characters",n);if(!t)return null;const r={...t,...e,meta:{...t.meta??{},...e.meta??{}},updated_at:Date.now()};return await V("characters",r),r}async function Mv(n){n&&await pe("characters",n)}async function Iv(n){return(await F("inspiration")).filter(t=>t.project_id===n).sort((t,r)=>(r.created_at??0)-(t.created_at??0))}async function Ov(n,e){const t=Date.now(),r={id:`${t}-${Math.random().toString(16).slice(2)}`,project_id:n,type:e.type,title:e.title??"",note:e.note??"",tags:Array.isArray(e.tags)?e.tags:[],url:e.url??"",image_data:e.image_data??"",linkedChapterId:e.linkedChapterId??"",linkedCharacterId:e.linkedCharacterId??"",created_at:t,updated_at:t};return await V("inspiration",r),r}async function Nv(n,e){const t=await mt("inspiration",n);if(!t)return null;const r={...t,...e,tags:Array.isArray(e.tags)?e.tags:t.tags??[],updated_at:Date.now()};return await V("inspiration",r),r}async function $v(n){n&&await pe("inspiration",n)}async function Rv(n){const[e,t]=await Promise.all([F("mindmap_nodes"),F("mindmap_edges")]);return{nodes:e.filter(r=>r.project_id===n),edges:t.filter(r=>r.project_id===n)}}async function Pv(n,e){const t=Date.now(),r={id:`${t}-${Math.random().toString(16).slice(2)}`,project_id:n,title:e.title??"Nouveau noeud",type:e.type??"note",summary:e.summary??"",tags:Array.isArray(e.tags)?e.tags:[],x:Number.isFinite(e.x)?e.x:120,y:Number.isFinite(e.y)?e.y:120,linkedChapterId:e.linkedChapterId??"",linkedCharacterId:e.linkedCharacterId??"",created_at:t,updated_at:t};return await V("mindmap_nodes",r),r}async function rf(n,e){const t=await mt("mindmap_nodes",n);if(!t)return null;const r={...t,...e,tags:Array.isArray(e.tags)?e.tags:t.tags??[],x:Number.isFinite(e.x)?e.x:t.x??0,y:Number.isFinite(e.y)?e.y:t.y??0,updated_at:Date.now()};return await V("mindmap_nodes",r),r}async function Dv(n){if(!n)return;await pe("mindmap_nodes",n);const t=(await F("mindmap_edges")).filter(r=>r.fromNodeId===n||r.toNodeId===n);for(const r of t)await pe("mindmap_edges",r.id)}async function Lv(n,e){const t=Date.now(),r={id:`${t}-${Math.random().toString(16).slice(2)}`,project_id:n,fromNodeId:e.fromNodeId,toNodeId:e.toNodeId,type:e.type??"link",created_at:t,updated_at:t};return await V("mindmap_edges",r),r}function jv(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}function Bv(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`}async function sf(n){const e=await F("focus_sessions");return(n?e.filter(r=>r.project_id===n):e).sort((r,s)=>(s.start_at??0)-(r.start_at??0))}async function Fv(n,e,t={}){if(!n||!e)return null;const r=Date.now(),s={id:Bv(),project_id:n,chapter_id:e,start_at:t.start_at??r,end_at:t.end_at??null,duration_ms:t.duration_ms??null,word_count_start:t.word_count_start??0,word_count_end:t.word_count_end??null};return await V("focus_sessions",s),s}async function of(n,e={}){if(!n)return null;const t=await mt("focus_sessions",n);if(!t)return null;const r={...t,...e};return await V("focus_sessions",r),r}async function Cr(n){return(await F("knowledge_notes")).filter(t=>t.project_id===n).sort((t,r)=>(r.updated_at??0)-(t.updated_at??0))}async function af(n,e){if(!n)return null;const t=Date.now(),r={id:jv(),project_id:n,title:e??"Nouvelle note",content:"",created_at:t,updated_at:t};return await V("knowledge_notes",r),r}async function yc(n,e){const t=await mt("knowledge_notes",n);if(!t)return null;const r={...t,...e,updated_at:Date.now()};return await V("knowledge_notes",r),r}async function Uv(n){if(!n)return;await pe("knowledge_notes",n);const t=(await F("knowledge_links")).filter(r=>r.from_note_id===n);for(const r of t)await pe("knowledge_links",r.id)}async function fn(n){return(await F("knowledge_links")).filter(t=>t.project_id===n)}async function lf(n,e,t){if(!n)return;const s=(await F("knowledge_links")).filter(o=>o.from_note_id===n);for(const o of s)await pe("knowledge_links",o.id);if(!Array.isArray(t)||!t.length)return;const i=Array.from(new Set(t)).filter(Boolean);for(const o of i){const a={id:`${n}:${o}`,project_id:e,from_note_id:n,to_title:o};await V("knowledge_links",a)}}async function zo({projectId:n=null}={}){const e=await F("ideas");return(n?e.filter(r=>r.project_id===n):e).sort((r,s)=>(s.created_at??0)-(r.created_at??0))}async function zv(n){const e=Date.now(),t={id:`${e}-${Math.random().toString(16).slice(2)}`,project_id:n.project_id??null,content:n.content??"",note:n.note??"",tags:Array.isArray(n.tags)?n.tags:[],status:n.status??"raw",created_at:e,updated_at:e};return await V("ideas",t),t}async function Hv(n,e){const t=await mt("ideas",n);if(!t)return null;const r={...t,...e,tags:Array.isArray(e.tags)?e.tags:t.tags??[],updated_at:Date.now()};return await V("ideas",r),r}async function Vv(n){n&&await pe("ideas",n)}const xl="writer:lastProjectId",Tl="writer:lastChapterId",El="plumeo:lastCloudSaveAt";function Vt(){try{return localStorage.getItem(xl)}catch{return null}}function gt(n){try{if(!n){localStorage.removeItem(xl);return}localStorage.setItem(xl,n)}catch{}}function qv(){try{return localStorage.getItem(Tl)}catch{return null}}function qn(n){try{if(!n){localStorage.removeItem(Tl);return}localStorage.setItem(Tl,n)}catch{}}function Ho(){try{const n=localStorage.getItem(El);if(!n)return null;const e=Number(n);return Number.isFinite(e)?e:null}catch{return null}}function wc(n){try{if(!n){localStorage.removeItem(El);return}localStorage.setItem(El,String(n))}catch{}}function Wv(n){if(typeof n=="number")return n;if(typeof n=="string")try{const e=JSON.parse(n);return Array.isArray(e)&&e[0]?.new_revision!=null?Number(e[0].new_revision)||0:e&&e.new_revision!=null?Number(e.new_revision)||0:Number(e)||0}catch{return Number(n)||0}return n&&typeof n.new_revision<"u"?Number(n.new_revision)||0:Array.isArray(n)&&n[0]?.new_revision!=null?Number(n[0].new_revision)||0:Number(n)||0}async function Vo(n){const e={opId:`${Date.now()}-${Math.random().toString(16).slice(2)}`,type:"UPSERT_CHAPTER",chapterId:n,createdAt:Date.now()};return await V("outbox",e),e}async function qo(){if(!navigator.onLine)return[];const n=await F("outbox"),e=[];for(const t of n){if(t.type!=="UPSERT_CHAPTER")continue;const r=await Uo(t.chapterId);if(!r){await pe("outbox",t.opId);continue}if(r.pending_create){const o=await qh(r.project_id);if(!o.ok||!o.exists)continue;const a=await cv({id:r.id,projectId:r.project_id,title:r.title??"",orderIndex:r.order_index??0,contentMd:r.content_md??""});if(!a.ok)continue;const l={...r,...a.data,content_md:a.data.content_md??r.content_md??"",remote_revision:a.data.revision??r.remote_revision??0,dirty:!1,conflict:!1,server_copy:null,pending_create:!1};await V("chapters",l),await pe("outbox",t.opId),e.push({chapterId:r.id,status:"synced"});continue}const s=await hv({id:r.id,title:r.title??"",content_md:r.content_md??"",baseRevision:Wv(r.remote_revision)});if(!s.ok){console.error("syncOnce rpc error",s.errorMessage);continue}if(s.newRevision===-1){const o=await Gh(r.id);if(o.ok){const a={...r,conflict:!0,server_copy:o.data,dirty:!0};await V("chapters",a)}await pe("outbox",t.opId),e.push({chapterId:r.id,status:"conflict"});continue}const i={...r,remote_revision:s.newRevision,dirty:!1,conflict:!1,server_copy:null};await V("chapters",i),await pe("outbox",t.opId),e.push({chapterId:r.id,status:"synced"})}return e}function Kv(n){const e=async()=>{try{const r=await qo();n&&await n(r)}catch(r){console.error("syncLoop error",r)}},t=window.setInterval(e,5e3);return window.addEventListener("online",e),t}function Ie(n){this.content=n}Ie.prototype={constructor:Ie,find:function(n){for(var e=0;e<this.content.length;e+=2)if(this.content[e]===n)return e;return-1},get:function(n){var e=this.find(n);return e==-1?void 0:this.content[e+1]},update:function(n,e,t){var r=t&&t!=n?this.remove(t):this,s=r.find(n),i=r.content.slice();return s==-1?i.push(t||n,e):(i[s+1]=e,t&&(i[s]=t)),new Ie(i)},remove:function(n){var e=this.find(n);if(e==-1)return this;var t=this.content.slice();return t.splice(e,2),new Ie(t)},addToStart:function(n,e){return new Ie([n,e].concat(this.remove(n).content))},addToEnd:function(n,e){var t=this.remove(n).content.slice();return t.push(n,e),new Ie(t)},addBefore:function(n,e,t){var r=this.remove(e),s=r.content.slice(),i=r.find(n);return s.splice(i==-1?s.length:i,0,e,t),new Ie(s)},forEach:function(n){for(var e=0;e<this.content.length;e+=2)n(this.content[e],this.content[e+1])},prepend:function(n){return n=Ie.from(n),n.size?new Ie(n.content.concat(this.subtract(n).content)):this},append:function(n){return n=Ie.from(n),n.size?new Ie(this.subtract(n).content.concat(n.content)):this},subtract:function(n){var e=this;n=Ie.from(n);for(var t=0;t<n.content.length;t+=2)e=e.remove(n.content[t]);return e},toObject:function(){var n={};return this.forEach(function(e,t){n[e]=t}),n},get size(){return this.content.length>>1}};Ie.from=function(n){if(n instanceof Ie)return n;var e=[];if(n)for(var t in n)e.push(t,n[t]);return new Ie(e)};function cf(n,e,t){for(let r=0;;r++){if(r==n.childCount||r==e.childCount)return n.childCount==e.childCount?null:t;let s=n.child(r),i=e.child(r);if(s==i){t+=s.nodeSize;continue}if(!s.sameMarkup(i))return t;if(s.isText&&s.text!=i.text){for(let o=0;s.text[o]==i.text[o];o++)t++;return t}if(s.content.size||i.content.size){let o=cf(s.content,i.content,t+1);if(o!=null)return o}t+=s.nodeSize}}function df(n,e,t,r){for(let s=n.childCount,i=e.childCount;;){if(s==0||i==0)return s==i?null:{a:t,b:r};let o=n.child(--s),a=e.child(--i),l=o.nodeSize;if(o==a){t-=l,r-=l;continue}if(!o.sameMarkup(a))return{a:t,b:r};if(o.isText&&o.text!=a.text){let c=0,d=Math.min(o.text.length,a.text.length);for(;c<d&&o.text[o.text.length-c-1]==a.text[a.text.length-c-1];)c++,t--,r--;return{a:t,b:r}}if(o.content.size||a.content.size){let c=df(o.content,a.content,t-1,r-1);if(c)return c}t-=l,r-=l}}class T{constructor(e,t){if(this.content=e,this.size=t||0,t==null)for(let r=0;r<e.length;r++)this.size+=e[r].nodeSize}nodesBetween(e,t,r,s=0,i){for(let o=0,a=0;a<t;o++){let l=this.content[o],c=a+l.nodeSize;if(c>e&&r(l,s+a,i||null,o)!==!1&&l.content.size){let d=a+1;l.nodesBetween(Math.max(0,e-d),Math.min(l.content.size,t-d),r,s+d)}a=c}}descendants(e){this.nodesBetween(0,this.size,e)}textBetween(e,t,r,s){let i="",o=!0;return this.nodesBetween(e,t,(a,l)=>{let c=a.isText?a.text.slice(Math.max(e,l)-l,t-l):a.isLeaf?s?typeof s=="function"?s(a):s:a.type.spec.leafText?a.type.spec.leafText(a):"":"";a.isBlock&&(a.isLeaf&&c||a.isTextblock)&&r&&(o?o=!1:i+=r),i+=c},0),i}append(e){if(!e.size)return this;if(!this.size)return e;let t=this.lastChild,r=e.firstChild,s=this.content.slice(),i=0;for(t.isText&&t.sameMarkup(r)&&(s[s.length-1]=t.withText(t.text+r.text),i=1);i<e.content.length;i++)s.push(e.content[i]);return new T(s,this.size+e.size)}cut(e,t=this.size){if(e==0&&t==this.size)return this;let r=[],s=0;if(t>e)for(let i=0,o=0;o<t;i++){let a=this.content[i],l=o+a.nodeSize;l>e&&((o<e||l>t)&&(a.isText?a=a.cut(Math.max(0,e-o),Math.min(a.text.length,t-o)):a=a.cut(Math.max(0,e-o-1),Math.min(a.content.size,t-o-1))),r.push(a),s+=a.nodeSize),o=l}return new T(r,s)}cutByIndex(e,t){return e==t?T.empty:e==0&&t==this.content.length?this:new T(this.content.slice(e,t))}replaceChild(e,t){let r=this.content[e];if(r==t)return this;let s=this.content.slice(),i=this.size+t.nodeSize-r.nodeSize;return s[e]=t,new T(s,i)}addToStart(e){return new T([e].concat(this.content),this.size+e.nodeSize)}addToEnd(e){return new T(this.content.concat(e),this.size+e.nodeSize)}eq(e){if(this.content.length!=e.content.length)return!1;for(let t=0;t<this.content.length;t++)if(!this.content[t].eq(e.content[t]))return!1;return!0}get firstChild(){return this.content.length?this.content[0]:null}get lastChild(){return this.content.length?this.content[this.content.length-1]:null}get childCount(){return this.content.length}child(e){let t=this.content[e];if(!t)throw new RangeError("Index "+e+" out of range for "+this);return t}maybeChild(e){return this.content[e]||null}forEach(e){for(let t=0,r=0;t<this.content.length;t++){let s=this.content[t];e(s,r,t),r+=s.nodeSize}}findDiffStart(e,t=0){return cf(this,e,t)}findDiffEnd(e,t=this.size,r=e.size){return df(this,e,t,r)}findIndex(e){if(e==0)return ui(0,e);if(e==this.size)return ui(this.content.length,e);if(e>this.size||e<0)throw new RangeError(`Position ${e} outside of fragment (${this})`);for(let t=0,r=0;;t++){let s=this.child(t),i=r+s.nodeSize;if(i>=e)return i==e?ui(t+1,i):ui(t,r);r=i}}toString(){return"<"+this.toStringInner()+">"}toStringInner(){return this.content.join(", ")}toJSON(){return this.content.length?this.content.map(e=>e.toJSON()):null}static fromJSON(e,t){if(!t)return T.empty;if(!Array.isArray(t))throw new RangeError("Invalid input for Fragment.fromJSON");return new T(t.map(e.nodeFromJSON))}static fromArray(e){if(!e.length)return T.empty;let t,r=0;for(let s=0;s<e.length;s++){let i=e[s];r+=i.nodeSize,s&&i.isText&&e[s-1].sameMarkup(i)?(t||(t=e.slice(0,s)),t[t.length-1]=i.withText(t[t.length-1].text+i.text)):t&&t.push(i)}return new T(t||e,r)}static from(e){if(!e)return T.empty;if(e instanceof T)return e;if(Array.isArray(e))return this.fromArray(e);if(e.attrs)return new T([e],e.nodeSize);throw new RangeError("Can not convert "+e+" to a Fragment"+(e.nodesBetween?" (looks like multiple versions of prosemirror-model were loaded)":""))}}T.empty=new T([],0);const $a={index:0,offset:0};function ui(n,e){return $a.index=n,$a.offset=e,$a}function Fi(n,e){if(n===e)return!0;if(!(n&&typeof n=="object")||!(e&&typeof e=="object"))return!1;let t=Array.isArray(n);if(Array.isArray(e)!=t)return!1;if(t){if(n.length!=e.length)return!1;for(let r=0;r<n.length;r++)if(!Fi(n[r],e[r]))return!1}else{for(let r in n)if(!(r in e)||!Fi(n[r],e[r]))return!1;for(let r in e)if(!(r in n))return!1}return!0}let ne=class Cl{constructor(e,t){this.type=e,this.attrs=t}addToSet(e){let t,r=!1;for(let s=0;s<e.length;s++){let i=e[s];if(this.eq(i))return e;if(this.type.excludes(i.type))t||(t=e.slice(0,s));else{if(i.type.excludes(this.type))return e;!r&&i.type.rank>this.type.rank&&(t||(t=e.slice(0,s)),t.push(this),r=!0),t&&t.push(i)}}return t||(t=e.slice()),r||t.push(this),t}removeFromSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return e.slice(0,t).concat(e.slice(t+1));return e}isInSet(e){for(let t=0;t<e.length;t++)if(this.eq(e[t]))return!0;return!1}eq(e){return this==e||this.type==e.type&&Fi(this.attrs,e.attrs)}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Mark.fromJSON");let r=e.marks[t.type];if(!r)throw new RangeError(`There is no mark type ${t.type} in this schema`);let s=r.create(t.attrs);return r.checkAttrs(s.attrs),s}static sameSet(e,t){if(e==t)return!0;if(e.length!=t.length)return!1;for(let r=0;r<e.length;r++)if(!e[r].eq(t[r]))return!1;return!0}static setFrom(e){if(!e||Array.isArray(e)&&e.length==0)return Cl.none;if(e instanceof Cl)return[e];let t=e.slice();return t.sort((r,s)=>r.type.rank-s.type.rank),t}};ne.none=[];class Ui extends Error{}class O{constructor(e,t,r){this.content=e,this.openStart=t,this.openEnd=r}get size(){return this.content.size-this.openStart-this.openEnd}insertAt(e,t){let r=hf(this.content,e+this.openStart,t);return r&&new O(r,this.openStart,this.openEnd)}removeBetween(e,t){return new O(uf(this.content,e+this.openStart,t+this.openStart),this.openStart,this.openEnd)}eq(e){return this.content.eq(e.content)&&this.openStart==e.openStart&&this.openEnd==e.openEnd}toString(){return this.content+"("+this.openStart+","+this.openEnd+")"}toJSON(){if(!this.content.size)return null;let e={content:this.content.toJSON()};return this.openStart>0&&(e.openStart=this.openStart),this.openEnd>0&&(e.openEnd=this.openEnd),e}static fromJSON(e,t){if(!t)return O.empty;let r=t.openStart||0,s=t.openEnd||0;if(typeof r!="number"||typeof s!="number")throw new RangeError("Invalid input for Slice.fromJSON");return new O(T.fromJSON(e,t.content),r,s)}static maxOpen(e,t=!0){let r=0,s=0;for(let i=e.firstChild;i&&!i.isLeaf&&(t||!i.type.spec.isolating);i=i.firstChild)r++;for(let i=e.lastChild;i&&!i.isLeaf&&(t||!i.type.spec.isolating);i=i.lastChild)s++;return new O(e,r,s)}}O.empty=new O(T.empty,0,0);function uf(n,e,t){let{index:r,offset:s}=n.findIndex(e),i=n.maybeChild(r),{index:o,offset:a}=n.findIndex(t);if(s==e||i.isText){if(a!=t&&!n.child(o).isText)throw new RangeError("Removing non-flat range");return n.cut(0,e).append(n.cut(t))}if(r!=o)throw new RangeError("Removing non-flat range");return n.replaceChild(r,i.copy(uf(i.content,e-s-1,t-s-1)))}function hf(n,e,t,r){let{index:s,offset:i}=n.findIndex(e),o=n.maybeChild(s);if(i==e||o.isText)return r&&!r.canReplace(s,s,t)?null:n.cut(0,e).append(t).append(n.cut(e));let a=hf(o.content,e-i-1,t,o);return a&&n.replaceChild(s,o.copy(a))}function Gv(n,e,t){if(t.openStart>n.depth)throw new Ui("Inserted content deeper than insertion position");if(n.depth-t.openStart!=e.depth-t.openEnd)throw new Ui("Inconsistent open depths");return ff(n,e,t,0)}function ff(n,e,t,r){let s=n.index(r),i=n.node(r);if(s==e.index(r)&&r<n.depth-t.openStart){let o=ff(n,e,t,r+1);return i.copy(i.content.replaceChild(s,o))}else if(t.content.size)if(!t.openStart&&!t.openEnd&&n.depth==r&&e.depth==r){let o=n.parent,a=o.content;return Un(o,a.cut(0,n.parentOffset).append(t.content).append(a.cut(e.parentOffset)))}else{let{start:o,end:a}=Jv(t,n);return Un(i,mf(n,o,a,e,r))}else return Un(i,zi(n,e,r))}function pf(n,e){if(!e.type.compatibleContent(n.type))throw new Ui("Cannot join "+e.type.name+" onto "+n.type.name)}function Al(n,e,t){let r=n.node(t);return pf(r,e.node(t)),r}function Fn(n,e){let t=e.length-1;t>=0&&n.isText&&n.sameMarkup(e[t])?e[t]=n.withText(e[t].text+n.text):e.push(n)}function ns(n,e,t,r){let s=(e||n).node(t),i=0,o=e?e.index(t):s.childCount;n&&(i=n.index(t),n.depth>t?i++:n.textOffset&&(Fn(n.nodeAfter,r),i++));for(let a=i;a<o;a++)Fn(s.child(a),r);e&&e.depth==t&&e.textOffset&&Fn(e.nodeBefore,r)}function Un(n,e){return n.type.checkContent(e),n.copy(e)}function mf(n,e,t,r,s){let i=n.depth>s&&Al(n,e,s+1),o=r.depth>s&&Al(t,r,s+1),a=[];return ns(null,n,s,a),i&&o&&e.index(s)==t.index(s)?(pf(i,o),Fn(Un(i,mf(n,e,t,r,s+1)),a)):(i&&Fn(Un(i,zi(n,e,s+1)),a),ns(e,t,s,a),o&&Fn(Un(o,zi(t,r,s+1)),a)),ns(r,null,s,a),new T(a)}function zi(n,e,t){let r=[];if(ns(null,n,t,r),n.depth>t){let s=Al(n,e,t+1);Fn(Un(s,zi(n,e,t+1)),r)}return ns(e,null,t,r),new T(r)}function Jv(n,e){let t=e.depth-n.openStart,s=e.node(t).copy(n.content);for(let i=t-1;i>=0;i--)s=e.node(i).copy(T.from(s));return{start:s.resolveNoCache(n.openStart+t),end:s.resolveNoCache(s.content.size-n.openEnd-t)}}class xs{constructor(e,t,r){this.pos=e,this.path=t,this.parentOffset=r,this.depth=t.length/3-1}resolveDepth(e){return e==null?this.depth:e<0?this.depth+e:e}get parent(){return this.node(this.depth)}get doc(){return this.node(0)}node(e){return this.path[this.resolveDepth(e)*3]}index(e){return this.path[this.resolveDepth(e)*3+1]}indexAfter(e){return e=this.resolveDepth(e),this.index(e)+(e==this.depth&&!this.textOffset?0:1)}start(e){return e=this.resolveDepth(e),e==0?0:this.path[e*3-1]+1}end(e){return e=this.resolveDepth(e),this.start(e)+this.node(e).content.size}before(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position before the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]}after(e){if(e=this.resolveDepth(e),!e)throw new RangeError("There is no position after the top-level node");return e==this.depth+1?this.pos:this.path[e*3-1]+this.path[e*3].nodeSize}get textOffset(){return this.pos-this.path[this.path.length-1]}get nodeAfter(){let e=this.parent,t=this.index(this.depth);if(t==e.childCount)return null;let r=this.pos-this.path[this.path.length-1],s=e.child(t);return r?e.child(t).cut(r):s}get nodeBefore(){let e=this.index(this.depth),t=this.pos-this.path[this.path.length-1];return t?this.parent.child(e).cut(0,t):e==0?null:this.parent.child(e-1)}posAtIndex(e,t){t=this.resolveDepth(t);let r=this.path[t*3],s=t==0?0:this.path[t*3-1]+1;for(let i=0;i<e;i++)s+=r.child(i).nodeSize;return s}marks(){let e=this.parent,t=this.index();if(e.content.size==0)return ne.none;if(this.textOffset)return e.child(t).marks;let r=e.maybeChild(t-1),s=e.maybeChild(t);if(!r){let a=r;r=s,s=a}let i=r.marks;for(var o=0;o<i.length;o++)i[o].type.spec.inclusive===!1&&(!s||!i[o].isInSet(s.marks))&&(i=i[o--].removeFromSet(i));return i}marksAcross(e){let t=this.parent.maybeChild(this.index());if(!t||!t.isInline)return null;let r=t.marks,s=e.parent.maybeChild(e.index());for(var i=0;i<r.length;i++)r[i].type.spec.inclusive===!1&&(!s||!r[i].isInSet(s.marks))&&(r=r[i--].removeFromSet(r));return r}sharedDepth(e){for(let t=this.depth;t>0;t--)if(this.start(t)<=e&&this.end(t)>=e)return t;return 0}blockRange(e=this,t){if(e.pos<this.pos)return e.blockRange(this);for(let r=this.depth-(this.parent.inlineContent||this.pos==e.pos?1:0);r>=0;r--)if(e.pos<=this.end(r)&&(!t||t(this.node(r))))return new Hi(this,e,r);return null}sameParent(e){return this.pos-this.parentOffset==e.pos-e.parentOffset}max(e){return e.pos>this.pos?e:this}min(e){return e.pos<this.pos?e:this}toString(){let e="";for(let t=1;t<=this.depth;t++)e+=(e?"/":"")+this.node(t).type.name+"_"+this.index(t-1);return e+":"+this.parentOffset}static resolve(e,t){if(!(t>=0&&t<=e.content.size))throw new RangeError("Position "+t+" out of range");let r=[],s=0,i=t;for(let o=e;;){let{index:a,offset:l}=o.content.findIndex(i),c=i-l;if(r.push(o,a,s+l),!c||(o=o.child(a),o.isText))break;i=c-1,s+=l+1}return new xs(t,r,i)}static resolveCached(e,t){let r=Wd.get(e);if(r)for(let i=0;i<r.elts.length;i++){let o=r.elts[i];if(o.pos==t)return o}else Wd.set(e,r=new Yv);let s=r.elts[r.i]=xs.resolve(e,t);return r.i=(r.i+1)%Xv,s}}class Yv{constructor(){this.elts=[],this.i=0}}const Xv=12,Wd=new WeakMap;class Hi{constructor(e,t,r){this.$from=e,this.$to=t,this.depth=r}get start(){return this.$from.before(this.depth+1)}get end(){return this.$to.after(this.depth+1)}get parent(){return this.$from.node(this.depth)}get startIndex(){return this.$from.index(this.depth)}get endIndex(){return this.$to.indexAfter(this.depth)}}const Qv=Object.create(null);class pt{constructor(e,t,r,s=ne.none){this.type=e,this.attrs=t,this.marks=s,this.content=r||T.empty}get children(){return this.content.content}get nodeSize(){return this.isLeaf?1:2+this.content.size}get childCount(){return this.content.childCount}child(e){return this.content.child(e)}maybeChild(e){return this.content.maybeChild(e)}forEach(e){this.content.forEach(e)}nodesBetween(e,t,r,s=0){this.content.nodesBetween(e,t,r,s,this)}descendants(e){this.nodesBetween(0,this.content.size,e)}get textContent(){return this.isLeaf&&this.type.spec.leafText?this.type.spec.leafText(this):this.textBetween(0,this.content.size,"")}textBetween(e,t,r,s){return this.content.textBetween(e,t,r,s)}get firstChild(){return this.content.firstChild}get lastChild(){return this.content.lastChild}eq(e){return this==e||this.sameMarkup(e)&&this.content.eq(e.content)}sameMarkup(e){return this.hasMarkup(e.type,e.attrs,e.marks)}hasMarkup(e,t,r){return this.type==e&&Fi(this.attrs,t||e.defaultAttrs||Qv)&&ne.sameSet(this.marks,r||ne.none)}copy(e=null){return e==this.content?this:new pt(this.type,this.attrs,e,this.marks)}mark(e){return e==this.marks?this:new pt(this.type,this.attrs,this.content,e)}cut(e,t=this.content.size){return e==0&&t==this.content.size?this:this.copy(this.content.cut(e,t))}slice(e,t=this.content.size,r=!1){if(e==t)return O.empty;let s=this.resolve(e),i=this.resolve(t),o=r?0:s.sharedDepth(t),a=s.start(o),c=s.node(o).content.cut(s.pos-a,i.pos-a);return new O(c,s.depth-o,i.depth-o)}replace(e,t,r){return Gv(this.resolve(e),this.resolve(t),r)}nodeAt(e){for(let t=this;;){let{index:r,offset:s}=t.content.findIndex(e);if(t=t.maybeChild(r),!t)return null;if(s==e||t.isText)return t;e-=s+1}}childAfter(e){let{index:t,offset:r}=this.content.findIndex(e);return{node:this.content.maybeChild(t),index:t,offset:r}}childBefore(e){if(e==0)return{node:null,index:0,offset:0};let{index:t,offset:r}=this.content.findIndex(e);if(r<e)return{node:this.content.child(t),index:t,offset:r};let s=this.content.child(t-1);return{node:s,index:t-1,offset:r-s.nodeSize}}resolve(e){return xs.resolveCached(this,e)}resolveNoCache(e){return xs.resolve(this,e)}rangeHasMark(e,t,r){let s=!1;return t>e&&this.nodesBetween(e,t,i=>(r.isInSet(i.marks)&&(s=!0),!s)),s}get isBlock(){return this.type.isBlock}get isTextblock(){return this.type.isTextblock}get inlineContent(){return this.type.inlineContent}get isInline(){return this.type.isInline}get isText(){return this.type.isText}get isLeaf(){return this.type.isLeaf}get isAtom(){return this.type.isAtom}toString(){if(this.type.spec.toDebugString)return this.type.spec.toDebugString(this);let e=this.type.name;return this.content.size&&(e+="("+this.content.toStringInner()+")"),gf(this.marks,e)}contentMatchAt(e){let t=this.type.contentMatch.matchFragment(this.content,0,e);if(!t)throw new Error("Called contentMatchAt on a node with invalid content");return t}canReplace(e,t,r=T.empty,s=0,i=r.childCount){let o=this.contentMatchAt(e).matchFragment(r,s,i),a=o&&o.matchFragment(this.content,t);if(!a||!a.validEnd)return!1;for(let l=s;l<i;l++)if(!this.type.allowsMarks(r.child(l).marks))return!1;return!0}canReplaceWith(e,t,r,s){if(s&&!this.type.allowsMarks(s))return!1;let i=this.contentMatchAt(e).matchType(r),o=i&&i.matchFragment(this.content,t);return o?o.validEnd:!1}canAppend(e){return e.content.size?this.canReplace(this.childCount,this.childCount,e.content):this.type.compatibleContent(e.type)}check(){this.type.checkContent(this.content),this.type.checkAttrs(this.attrs);let e=ne.none;for(let t=0;t<this.marks.length;t++){let r=this.marks[t];r.type.checkAttrs(r.attrs),e=r.addToSet(e)}if(!ne.sameSet(e,this.marks))throw new RangeError(`Invalid collection of marks for node ${this.type.name}: ${this.marks.map(t=>t.type.name)}`);this.content.forEach(t=>t.check())}toJSON(){let e={type:this.type.name};for(let t in this.attrs){e.attrs=this.attrs;break}return this.content.size&&(e.content=this.content.toJSON()),this.marks.length&&(e.marks=this.marks.map(t=>t.toJSON())),e}static fromJSON(e,t){if(!t)throw new RangeError("Invalid input for Node.fromJSON");let r;if(t.marks){if(!Array.isArray(t.marks))throw new RangeError("Invalid mark data for Node.fromJSON");r=t.marks.map(e.markFromJSON)}if(t.type=="text"){if(typeof t.text!="string")throw new RangeError("Invalid text node in JSON");return e.text(t.text,r)}let s=T.fromJSON(e,t.content),i=e.nodeType(t.type).create(t.attrs,s,r);return i.type.checkAttrs(i.attrs),i}}pt.prototype.text=void 0;class Vi extends pt{constructor(e,t,r,s){if(super(e,t,null,s),!r)throw new RangeError("Empty text nodes are not allowed");this.text=r}toString(){return this.type.spec.toDebugString?this.type.spec.toDebugString(this):gf(this.marks,JSON.stringify(this.text))}get textContent(){return this.text}textBetween(e,t){return this.text.slice(e,t)}get nodeSize(){return this.text.length}mark(e){return e==this.marks?this:new Vi(this.type,this.attrs,this.text,e)}withText(e){return e==this.text?this:new Vi(this.type,this.attrs,e,this.marks)}cut(e=0,t=this.text.length){return e==0&&t==this.text.length?this:this.withText(this.text.slice(e,t))}eq(e){return this.sameMarkup(e)&&this.text==e.text}toJSON(){let e=super.toJSON();return e.text=this.text,e}}function gf(n,e){for(let t=n.length-1;t>=0;t--)e=n[t].type.name+"("+e+")";return e}class Wn{constructor(e){this.validEnd=e,this.next=[],this.wrapCache=[]}static parse(e,t){let r=new Zv(e,t);if(r.next==null)return Wn.empty;let s=yf(r);r.next&&r.err("Unexpected trailing text");let i=ok(ik(s));return ak(i,r),i}matchType(e){for(let t=0;t<this.next.length;t++)if(this.next[t].type==e)return this.next[t].next;return null}matchFragment(e,t=0,r=e.childCount){let s=this;for(let i=t;s&&i<r;i++)s=s.matchType(e.child(i).type);return s}get inlineContent(){return this.next.length!=0&&this.next[0].type.isInline}get defaultType(){for(let e=0;e<this.next.length;e++){let{type:t}=this.next[e];if(!(t.isText||t.hasRequiredAttrs()))return t}return null}compatible(e){for(let t=0;t<this.next.length;t++)for(let r=0;r<e.next.length;r++)if(this.next[t].type==e.next[r].type)return!0;return!1}fillBefore(e,t=!1,r=0){let s=[this];function i(o,a){let l=o.matchFragment(e,r);if(l&&(!t||l.validEnd))return T.from(a.map(c=>c.createAndFill()));for(let c=0;c<o.next.length;c++){let{type:d,next:h}=o.next[c];if(!(d.isText||d.hasRequiredAttrs())&&s.indexOf(h)==-1){s.push(h);let f=i(h,a.concat(d));if(f)return f}}return null}return i(this,[])}findWrapping(e){for(let r=0;r<this.wrapCache.length;r+=2)if(this.wrapCache[r]==e)return this.wrapCache[r+1];let t=this.computeWrapping(e);return this.wrapCache.push(e,t),t}computeWrapping(e){let t=Object.create(null),r=[{match:this,type:null,via:null}];for(;r.length;){let s=r.shift(),i=s.match;if(i.matchType(e)){let o=[];for(let a=s;a.type;a=a.via)o.push(a.type);return o.reverse()}for(let o=0;o<i.next.length;o++){let{type:a,next:l}=i.next[o];!a.isLeaf&&!a.hasRequiredAttrs()&&!(a.name in t)&&(!s.type||l.validEnd)&&(r.push({match:a.contentMatch,type:a,via:s}),t[a.name]=!0)}}return null}get edgeCount(){return this.next.length}edge(e){if(e>=this.next.length)throw new RangeError(`There's no ${e}th edge in this content match`);return this.next[e]}toString(){let e=[];function t(r){e.push(r);for(let s=0;s<r.next.length;s++)e.indexOf(r.next[s].next)==-1&&t(r.next[s].next)}return t(this),e.map((r,s)=>{let i=s+(r.validEnd?"*":" ")+" ";for(let o=0;o<r.next.length;o++)i+=(o?", ":"")+r.next[o].type.name+"->"+e.indexOf(r.next[o].next);return i}).join(`
`)}}Wn.empty=new Wn(!0);class Zv{constructor(e,t){this.string=e,this.nodeTypes=t,this.inline=null,this.pos=0,this.tokens=e.split(/\s*(?=\b|\W|$)/),this.tokens[this.tokens.length-1]==""&&this.tokens.pop(),this.tokens[0]==""&&this.tokens.shift()}get next(){return this.tokens[this.pos]}eat(e){return this.next==e&&(this.pos++||!0)}err(e){throw new SyntaxError(e+" (in content expression '"+this.string+"')")}}function yf(n){let e=[];do e.push(ek(n));while(n.eat("|"));return e.length==1?e[0]:{type:"choice",exprs:e}}function ek(n){let e=[];do e.push(tk(n));while(n.next&&n.next!=")"&&n.next!="|");return e.length==1?e[0]:{type:"seq",exprs:e}}function tk(n){let e=sk(n);for(;;)if(n.eat("+"))e={type:"plus",expr:e};else if(n.eat("*"))e={type:"star",expr:e};else if(n.eat("?"))e={type:"opt",expr:e};else if(n.eat("{"))e=nk(n,e);else break;return e}function Kd(n){/\D/.test(n.next)&&n.err("Expected number, got '"+n.next+"'");let e=Number(n.next);return n.pos++,e}function nk(n,e){let t=Kd(n),r=t;return n.eat(",")&&(n.next!="}"?r=Kd(n):r=-1),n.eat("}")||n.err("Unclosed braced range"),{type:"range",min:t,max:r,expr:e}}function rk(n,e){let t=n.nodeTypes,r=t[e];if(r)return[r];let s=[];for(let i in t){let o=t[i];o.isInGroup(e)&&s.push(o)}return s.length==0&&n.err("No node type or group '"+e+"' found"),s}function sk(n){if(n.eat("(")){let e=yf(n);return n.eat(")")||n.err("Missing closing paren"),e}else if(/\W/.test(n.next))n.err("Unexpected token '"+n.next+"'");else{let e=rk(n,n.next).map(t=>(n.inline==null?n.inline=t.isInline:n.inline!=t.isInline&&n.err("Mixing inline and block content"),{type:"name",value:t}));return n.pos++,e.length==1?e[0]:{type:"choice",exprs:e}}}function ik(n){let e=[[]];return s(i(n,0),t()),e;function t(){return e.push([])-1}function r(o,a,l){let c={term:l,to:a};return e[o].push(c),c}function s(o,a){o.forEach(l=>l.to=a)}function i(o,a){if(o.type=="choice")return o.exprs.reduce((l,c)=>l.concat(i(c,a)),[]);if(o.type=="seq")for(let l=0;;l++){let c=i(o.exprs[l],a);if(l==o.exprs.length-1)return c;s(c,a=t())}else if(o.type=="star"){let l=t();return r(a,l),s(i(o.expr,l),l),[r(l)]}else if(o.type=="plus"){let l=t();return s(i(o.expr,a),l),s(i(o.expr,l),l),[r(l)]}else{if(o.type=="opt")return[r(a)].concat(i(o.expr,a));if(o.type=="range"){let l=a;for(let c=0;c<o.min;c++){let d=t();s(i(o.expr,l),d),l=d}if(o.max==-1)s(i(o.expr,l),l);else for(let c=o.min;c<o.max;c++){let d=t();r(l,d),s(i(o.expr,l),d),l=d}return[r(l)]}else{if(o.type=="name")return[r(a,void 0,o.value)];throw new Error("Unknown expr type")}}}}function wf(n,e){return e-n}function Gd(n,e){let t=[];return r(e),t.sort(wf);function r(s){let i=n[s];if(i.length==1&&!i[0].term)return r(i[0].to);t.push(s);for(let o=0;o<i.length;o++){let{term:a,to:l}=i[o];!a&&t.indexOf(l)==-1&&r(l)}}}function ok(n){let e=Object.create(null);return t(Gd(n,0));function t(r){let s=[];r.forEach(o=>{n[o].forEach(({term:a,to:l})=>{if(!a)return;let c;for(let d=0;d<s.length;d++)s[d][0]==a&&(c=s[d][1]);Gd(n,l).forEach(d=>{c||s.push([a,c=[]]),c.indexOf(d)==-1&&c.push(d)})})});let i=e[r.join(",")]=new Wn(r.indexOf(n.length-1)>-1);for(let o=0;o<s.length;o++){let a=s[o][1].sort(wf);i.next.push({type:s[o][0],next:e[a.join(",")]||t(a)})}return i}}function ak(n,e){for(let t=0,r=[n];t<r.length;t++){let s=r[t],i=!s.validEnd,o=[];for(let a=0;a<s.next.length;a++){let{type:l,next:c}=s.next[a];o.push(l.name),i&&!(l.isText||l.hasRequiredAttrs())&&(i=!1),r.indexOf(c)==-1&&r.push(c)}i&&e.err("Only non-generatable nodes ("+o.join(", ")+") in a required position (see https://prosemirror.net/docs/guide/#generatable)")}}function bf(n){let e=Object.create(null);for(let t in n){let r=n[t];if(!r.hasDefault)return null;e[t]=r.default}return e}function vf(n,e){let t=Object.create(null);for(let r in n){let s=e&&e[r];if(s===void 0){let i=n[r];if(i.hasDefault)s=i.default;else throw new RangeError("No value supplied for attribute "+r)}t[r]=s}return t}function kf(n,e,t,r){for(let s in e)if(!(s in n))throw new RangeError(`Unsupported attribute ${s} for ${t} of type ${s}`);for(let s in n){let i=n[s];i.validate&&i.validate(e[s])}}function Sf(n,e){let t=Object.create(null);if(e)for(let r in e)t[r]=new ck(n,r,e[r]);return t}let Jd=class _f{constructor(e,t,r){this.name=e,this.schema=t,this.spec=r,this.markSet=null,this.groups=r.group?r.group.split(" "):[],this.attrs=Sf(e,r.attrs),this.defaultAttrs=bf(this.attrs),this.contentMatch=null,this.inlineContent=null,this.isBlock=!(r.inline||e=="text"),this.isText=e=="text"}get isInline(){return!this.isBlock}get isTextblock(){return this.isBlock&&this.inlineContent}get isLeaf(){return this.contentMatch==Wn.empty}get isAtom(){return this.isLeaf||!!this.spec.atom}isInGroup(e){return this.groups.indexOf(e)>-1}get whitespace(){return this.spec.whitespace||(this.spec.code?"pre":"normal")}hasRequiredAttrs(){for(let e in this.attrs)if(this.attrs[e].isRequired)return!0;return!1}compatibleContent(e){return this==e||this.contentMatch.compatible(e.contentMatch)}computeAttrs(e){return!e&&this.defaultAttrs?this.defaultAttrs:vf(this.attrs,e)}create(e=null,t,r){if(this.isText)throw new Error("NodeType.create can't construct text nodes");return new pt(this,this.computeAttrs(e),T.from(t),ne.setFrom(r))}createChecked(e=null,t,r){return t=T.from(t),this.checkContent(t),new pt(this,this.computeAttrs(e),t,ne.setFrom(r))}createAndFill(e=null,t,r){if(e=this.computeAttrs(e),t=T.from(t),t.size){let o=this.contentMatch.fillBefore(t);if(!o)return null;t=o.append(t)}let s=this.contentMatch.matchFragment(t),i=s&&s.fillBefore(T.empty,!0);return i?new pt(this,e,t.append(i),ne.setFrom(r)):null}validContent(e){let t=this.contentMatch.matchFragment(e);if(!t||!t.validEnd)return!1;for(let r=0;r<e.childCount;r++)if(!this.allowsMarks(e.child(r).marks))return!1;return!0}checkContent(e){if(!this.validContent(e))throw new RangeError(`Invalid content for node ${this.name}: ${e.toString().slice(0,50)}`)}checkAttrs(e){kf(this.attrs,e,"node",this.name)}allowsMarkType(e){return this.markSet==null||this.markSet.indexOf(e)>-1}allowsMarks(e){if(this.markSet==null)return!0;for(let t=0;t<e.length;t++)if(!this.allowsMarkType(e[t].type))return!1;return!0}allowedMarks(e){if(this.markSet==null)return e;let t;for(let r=0;r<e.length;r++)this.allowsMarkType(e[r].type)?t&&t.push(e[r]):t||(t=e.slice(0,r));return t?t.length?t:ne.none:e}static compile(e,t){let r=Object.create(null);e.forEach((i,o)=>r[i]=new _f(i,t,o));let s=t.spec.topNode||"doc";if(!r[s])throw new RangeError("Schema is missing its top node type ('"+s+"')");if(!r.text)throw new RangeError("Every schema needs a 'text' type");for(let i in r.text.attrs)throw new RangeError("The text node type should not have attributes");return r}};function lk(n,e,t){let r=t.split("|");return s=>{let i=s===null?"null":typeof s;if(r.indexOf(i)<0)throw new RangeError(`Expected value of type ${r} for attribute ${e} on type ${n}, got ${i}`)}}class ck{constructor(e,t,r){this.hasDefault=Object.prototype.hasOwnProperty.call(r,"default"),this.default=r.default,this.validate=typeof r.validate=="string"?lk(e,t,r.validate):r.validate}get isRequired(){return!this.hasDefault}}class Wo{constructor(e,t,r,s){this.name=e,this.rank=t,this.schema=r,this.spec=s,this.attrs=Sf(e,s.attrs),this.excluded=null;let i=bf(this.attrs);this.instance=i?new ne(this,i):null}create(e=null){return!e&&this.instance?this.instance:new ne(this,vf(this.attrs,e))}static compile(e,t){let r=Object.create(null),s=0;return e.forEach((i,o)=>r[i]=new Wo(i,s++,t,o)),r}removeFromSet(e){for(var t=0;t<e.length;t++)e[t].type==this&&(e=e.slice(0,t).concat(e.slice(t+1)),t--);return e}isInSet(e){for(let t=0;t<e.length;t++)if(e[t].type==this)return e[t]}checkAttrs(e){kf(this.attrs,e,"mark",this.name)}excludes(e){return this.excluded.indexOf(e)>-1}}class xf{constructor(e){this.linebreakReplacement=null,this.cached=Object.create(null);let t=this.spec={};for(let s in e)t[s]=e[s];t.nodes=Ie.from(e.nodes),t.marks=Ie.from(e.marks||{}),this.nodes=Jd.compile(this.spec.nodes,this),this.marks=Wo.compile(this.spec.marks,this);let r=Object.create(null);for(let s in this.nodes){if(s in this.marks)throw new RangeError(s+" can not be both a node and a mark");let i=this.nodes[s],o=i.spec.content||"",a=i.spec.marks;if(i.contentMatch=r[o]||(r[o]=Wn.parse(o,this.nodes)),i.inlineContent=i.contentMatch.inlineContent,i.spec.linebreakReplacement){if(this.linebreakReplacement)throw new RangeError("Multiple linebreak nodes defined");if(!i.isInline||!i.isLeaf)throw new RangeError("Linebreak replacement nodes must be inline leaf nodes");this.linebreakReplacement=i}i.markSet=a=="_"?null:a?Yd(this,a.split(" ")):a==""||!i.inlineContent?[]:null}for(let s in this.marks){let i=this.marks[s],o=i.spec.excludes;i.excluded=o==null?[i]:o==""?[]:Yd(this,o.split(" "))}this.nodeFromJSON=s=>pt.fromJSON(this,s),this.markFromJSON=s=>ne.fromJSON(this,s),this.topNodeType=this.nodes[this.spec.topNode||"doc"],this.cached.wrappings=Object.create(null)}node(e,t=null,r,s){if(typeof e=="string")e=this.nodeType(e);else if(e instanceof Jd){if(e.schema!=this)throw new RangeError("Node type from different schema used ("+e.name+")")}else throw new RangeError("Invalid node type: "+e);return e.createChecked(t,r,s)}text(e,t){let r=this.nodes.text;return new Vi(r,r.defaultAttrs,e,ne.setFrom(t))}mark(e,t){return typeof e=="string"&&(e=this.marks[e]),e.create(t)}nodeType(e){let t=this.nodes[e];if(!t)throw new RangeError("Unknown node type: "+e);return t}}function Yd(n,e){let t=[];for(let r=0;r<e.length;r++){let s=e[r],i=n.marks[s],o=i;if(i)t.push(i);else for(let a in n.marks){let l=n.marks[a];(s=="_"||l.spec.group&&l.spec.group.split(" ").indexOf(s)>-1)&&t.push(o=l)}if(!o)throw new SyntaxError("Unknown mark type: '"+e[r]+"'")}return t}function dk(n){return n.tag!=null}function uk(n){return n.style!=null}class cn{constructor(e,t){this.schema=e,this.rules=t,this.tags=[],this.styles=[];let r=this.matchedStyles=[];t.forEach(s=>{if(dk(s))this.tags.push(s);else if(uk(s)){let i=/[^=]*/.exec(s.style)[0];r.indexOf(i)<0&&r.push(i),this.styles.push(s)}}),this.normalizeLists=!this.tags.some(s=>{if(!/^(ul|ol)\b/.test(s.tag)||!s.node)return!1;let i=e.nodes[s.node];return i.contentMatch.matchType(i)})}parse(e,t={}){let r=new Qd(this,t,!1);return r.addAll(e,ne.none,t.from,t.to),r.finish()}parseSlice(e,t={}){let r=new Qd(this,t,!0);return r.addAll(e,ne.none,t.from,t.to),O.maxOpen(r.finish())}matchTag(e,t,r){for(let s=r?this.tags.indexOf(r)+1:0;s<this.tags.length;s++){let i=this.tags[s];if(pk(e,i.tag)&&(i.namespace===void 0||e.namespaceURI==i.namespace)&&(!i.context||t.matchesContext(i.context))){if(i.getAttrs){let o=i.getAttrs(e);if(o===!1)continue;i.attrs=o||void 0}return i}}}matchStyle(e,t,r,s){for(let i=s?this.styles.indexOf(s)+1:0;i<this.styles.length;i++){let o=this.styles[i],a=o.style;if(!(a.indexOf(e)!=0||o.context&&!r.matchesContext(o.context)||a.length>e.length&&(a.charCodeAt(e.length)!=61||a.slice(e.length+1)!=t))){if(o.getAttrs){let l=o.getAttrs(t);if(l===!1)continue;o.attrs=l||void 0}return o}}}static schemaRules(e){let t=[];function r(s){let i=s.priority==null?50:s.priority,o=0;for(;o<t.length;o++){let a=t[o];if((a.priority==null?50:a.priority)<i)break}t.splice(o,0,s)}for(let s in e.marks){let i=e.marks[s].spec.parseDOM;i&&i.forEach(o=>{r(o=Zd(o)),o.mark||o.ignore||o.clearMark||(o.mark=s)})}for(let s in e.nodes){let i=e.nodes[s].spec.parseDOM;i&&i.forEach(o=>{r(o=Zd(o)),o.node||o.ignore||o.mark||(o.node=s)})}return t}static fromSchema(e){return e.cached.domParser||(e.cached.domParser=new cn(e,cn.schemaRules(e)))}}const Tf={address:!0,article:!0,aside:!0,blockquote:!0,canvas:!0,dd:!0,div:!0,dl:!0,fieldset:!0,figcaption:!0,figure:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,li:!0,noscript:!0,ol:!0,output:!0,p:!0,pre:!0,section:!0,table:!0,tfoot:!0,ul:!0},hk={head:!0,noscript:!0,object:!0,script:!0,style:!0,title:!0},Ef={ol:!0,ul:!0},Ts=1,Ml=2,rs=4;function Xd(n,e,t){return e!=null?(e?Ts:0)|(e==="full"?Ml:0):n&&n.whitespace=="pre"?Ts|Ml:t&~rs}class hi{constructor(e,t,r,s,i,o){this.type=e,this.attrs=t,this.marks=r,this.solid=s,this.options=o,this.content=[],this.activeMarks=ne.none,this.match=i||(o&rs?null:e.contentMatch)}findWrapping(e){if(!this.match){if(!this.type)return[];let t=this.type.contentMatch.fillBefore(T.from(e));if(t)this.match=this.type.contentMatch.matchFragment(t);else{let r=this.type.contentMatch,s;return(s=r.findWrapping(e.type))?(this.match=r,s):null}}return this.match.findWrapping(e.type)}finish(e){if(!(this.options&Ts)){let r=this.content[this.content.length-1],s;if(r&&r.isText&&(s=/[ \t\r\n\u000c]+$/.exec(r.text))){let i=r;r.text.length==s[0].length?this.content.pop():this.content[this.content.length-1]=i.withText(i.text.slice(0,i.text.length-s[0].length))}}let t=T.from(this.content);return!e&&this.match&&(t=t.append(this.match.fillBefore(T.empty,!0))),this.type?this.type.create(this.attrs,t,this.marks):t}inlineContext(e){return this.type?this.type.inlineContent:this.content.length?this.content[0].isInline:e.parentNode&&!Tf.hasOwnProperty(e.parentNode.nodeName.toLowerCase())}}class Qd{constructor(e,t,r){this.parser=e,this.options=t,this.isOpen=r,this.open=0,this.localPreserveWS=!1;let s=t.topNode,i,o=Xd(null,t.preserveWhitespace,0)|(r?rs:0);s?i=new hi(s.type,s.attrs,ne.none,!0,t.topMatch||s.type.contentMatch,o):r?i=new hi(null,null,ne.none,!0,null,o):i=new hi(e.schema.topNodeType,null,ne.none,!0,null,o),this.nodes=[i],this.find=t.findPositions,this.needsBlock=!1}get top(){return this.nodes[this.open]}addDOM(e,t){e.nodeType==3?this.addTextNode(e,t):e.nodeType==1&&this.addElement(e,t)}addTextNode(e,t){let r=e.nodeValue,s=this.top,i=s.options&Ml?"full":this.localPreserveWS||(s.options&Ts)>0,{schema:o}=this.parser;if(i==="full"||s.inlineContext(e)||/[^ \t\r\n\u000c]/.test(r)){if(i)if(i==="full")r=r.replace(/\r\n?/g,`
`);else if(o.linebreakReplacement&&/[\r\n]/.test(r)&&this.top.findWrapping(o.linebreakReplacement.create())){let a=r.split(/\r?\n|\r/);for(let l=0;l<a.length;l++)l&&this.insertNode(o.linebreakReplacement.create(),t,!0),a[l]&&this.insertNode(o.text(a[l]),t,!/\S/.test(a[l]));r=""}else r=r.replace(/\r?\n|\r/g," ");else if(r=r.replace(/[ \t\r\n\u000c]+/g," "),/^[ \t\r\n\u000c]/.test(r)&&this.open==this.nodes.length-1){let a=s.content[s.content.length-1],l=e.previousSibling;(!a||l&&l.nodeName=="BR"||a.isText&&/[ \t\r\n\u000c]$/.test(a.text))&&(r=r.slice(1))}r&&this.insertNode(o.text(r),t,!/\S/.test(r)),this.findInText(e)}else this.findInside(e)}addElement(e,t,r){let s=this.localPreserveWS,i=this.top;(e.tagName=="PRE"||/pre/.test(e.style&&e.style.whiteSpace))&&(this.localPreserveWS=!0);let o=e.nodeName.toLowerCase(),a;Ef.hasOwnProperty(o)&&this.parser.normalizeLists&&fk(e);let l=this.options.ruleFromNode&&this.options.ruleFromNode(e)||(a=this.parser.matchTag(e,this,r));e:if(l?l.ignore:hk.hasOwnProperty(o))this.findInside(e),this.ignoreFallback(e,t);else if(!l||l.skip||l.closeParent){l&&l.closeParent?this.open=Math.max(0,this.open-1):l&&l.skip.nodeType&&(e=l.skip);let c,d=this.needsBlock;if(Tf.hasOwnProperty(o))i.content.length&&i.content[0].isInline&&this.open&&(this.open--,i=this.top),c=!0,i.type||(this.needsBlock=!0);else if(!e.firstChild){this.leafFallback(e,t);break e}let h=l&&l.skip?t:this.readStyles(e,t);h&&this.addAll(e,h),c&&this.sync(i),this.needsBlock=d}else{let c=this.readStyles(e,t);c&&this.addElementByRule(e,l,c,l.consuming===!1?a:void 0)}this.localPreserveWS=s}leafFallback(e,t){e.nodeName=="BR"&&this.top.type&&this.top.type.inlineContent&&this.addTextNode(e.ownerDocument.createTextNode(`
`),t)}ignoreFallback(e,t){e.nodeName=="BR"&&(!this.top.type||!this.top.type.inlineContent)&&this.findPlace(this.parser.schema.text("-"),t,!0)}readStyles(e,t){let r=e.style;if(r&&r.length)for(let s=0;s<this.parser.matchedStyles.length;s++){let i=this.parser.matchedStyles[s],o=r.getPropertyValue(i);if(o)for(let a=void 0;;){let l=this.parser.matchStyle(i,o,this,a);if(!l)break;if(l.ignore)return null;if(l.clearMark?t=t.filter(c=>!l.clearMark(c)):t=t.concat(this.parser.schema.marks[l.mark].create(l.attrs)),l.consuming===!1)a=l;else break}}return t}addElementByRule(e,t,r,s){let i,o;if(t.node)if(o=this.parser.schema.nodes[t.node],o.isLeaf)this.insertNode(o.create(t.attrs),r,e.nodeName=="BR")||this.leafFallback(e,r);else{let l=this.enter(o,t.attrs||null,r,t.preserveWhitespace);l&&(i=!0,r=l)}else{let l=this.parser.schema.marks[t.mark];r=r.concat(l.create(t.attrs))}let a=this.top;if(o&&o.isLeaf)this.findInside(e);else if(s)this.addElement(e,r,s);else if(t.getContent)this.findInside(e),t.getContent(e,this.parser.schema).forEach(l=>this.insertNode(l,r,!1));else{let l=e;typeof t.contentElement=="string"?l=e.querySelector(t.contentElement):typeof t.contentElement=="function"?l=t.contentElement(e):t.contentElement&&(l=t.contentElement),this.findAround(e,l,!0),this.addAll(l,r),this.findAround(e,l,!1)}i&&this.sync(a)&&this.open--}addAll(e,t,r,s){let i=r||0;for(let o=r?e.childNodes[r]:e.firstChild,a=s==null?null:e.childNodes[s];o!=a;o=o.nextSibling,++i)this.findAtPoint(e,i),this.addDOM(o,t);this.findAtPoint(e,i)}findPlace(e,t,r){let s,i;for(let o=this.open,a=0;o>=0;o--){let l=this.nodes[o],c=l.findWrapping(e);if(c&&(!s||s.length>c.length+a)&&(s=c,i=l,!c.length))break;if(l.solid){if(r)break;a+=2}}if(!s)return null;this.sync(i);for(let o=0;o<s.length;o++)t=this.enterInner(s[o],null,t,!1);return t}insertNode(e,t,r){if(e.isInline&&this.needsBlock&&!this.top.type){let i=this.textblockFromContext();i&&(t=this.enterInner(i,null,t))}let s=this.findPlace(e,t,r);if(s){this.closeExtra();let i=this.top;i.match&&(i.match=i.match.matchType(e.type));let o=ne.none;for(let a of s.concat(e.marks))(i.type?i.type.allowsMarkType(a.type):eu(a.type,e.type))&&(o=a.addToSet(o));return i.content.push(e.mark(o)),!0}return!1}enter(e,t,r,s){let i=this.findPlace(e.create(t),r,!1);return i&&(i=this.enterInner(e,t,r,!0,s)),i}enterInner(e,t,r,s=!1,i){this.closeExtra();let o=this.top;o.match=o.match&&o.match.matchType(e);let a=Xd(e,i,o.options);o.options&rs&&o.content.length==0&&(a|=rs);let l=ne.none;return r=r.filter(c=>(o.type?o.type.allowsMarkType(c.type):eu(c.type,e))?(l=c.addToSet(l),!1):!0),this.nodes.push(new hi(e,t,l,s,null,a)),this.open++,r}closeExtra(e=!1){let t=this.nodes.length-1;if(t>this.open){for(;t>this.open;t--)this.nodes[t-1].content.push(this.nodes[t].finish(e));this.nodes.length=this.open+1}}finish(){return this.open=0,this.closeExtra(this.isOpen),this.nodes[0].finish(!!(this.isOpen||this.options.topOpen))}sync(e){for(let t=this.open;t>=0;t--){if(this.nodes[t]==e)return this.open=t,!0;this.localPreserveWS&&(this.nodes[t].options|=Ts)}return!1}get currentPos(){this.closeExtra();let e=0;for(let t=this.open;t>=0;t--){let r=this.nodes[t].content;for(let s=r.length-1;s>=0;s--)e+=r[s].nodeSize;t&&e++}return e}findAtPoint(e,t){if(this.find)for(let r=0;r<this.find.length;r++)this.find[r].node==e&&this.find[r].offset==t&&(this.find[r].pos=this.currentPos)}findInside(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].pos==null&&e.nodeType==1&&e.contains(this.find[t].node)&&(this.find[t].pos=this.currentPos)}findAround(e,t,r){if(e!=t&&this.find)for(let s=0;s<this.find.length;s++)this.find[s].pos==null&&e.nodeType==1&&e.contains(this.find[s].node)&&t.compareDocumentPosition(this.find[s].node)&(r?2:4)&&(this.find[s].pos=this.currentPos)}findInText(e){if(this.find)for(let t=0;t<this.find.length;t++)this.find[t].node==e&&(this.find[t].pos=this.currentPos-(e.nodeValue.length-this.find[t].offset))}matchesContext(e){if(e.indexOf("|")>-1)return e.split(/\s*\|\s*/).some(this.matchesContext,this);let t=e.split("/"),r=this.options.context,s=!this.isOpen&&(!r||r.parent.type==this.nodes[0].type),i=-(r?r.depth+1:0)+(s?0:1),o=(a,l)=>{for(;a>=0;a--){let c=t[a];if(c==""){if(a==t.length-1||a==0)continue;for(;l>=i;l--)if(o(a-1,l))return!0;return!1}else{let d=l>0||l==0&&s?this.nodes[l].type:r&&l>=i?r.node(l-i).type:null;if(!d||d.name!=c&&!d.isInGroup(c))return!1;l--}}return!0};return o(t.length-1,this.open)}textblockFromContext(){let e=this.options.context;if(e)for(let t=e.depth;t>=0;t--){let r=e.node(t).contentMatchAt(e.indexAfter(t)).defaultType;if(r&&r.isTextblock&&r.defaultAttrs)return r}for(let t in this.parser.schema.nodes){let r=this.parser.schema.nodes[t];if(r.isTextblock&&r.defaultAttrs)return r}}}function fk(n){for(let e=n.firstChild,t=null;e;e=e.nextSibling){let r=e.nodeType==1?e.nodeName.toLowerCase():null;r&&Ef.hasOwnProperty(r)&&t?(t.appendChild(e),e=t):r=="li"?t=e:r&&(t=null)}}function pk(n,e){return(n.matches||n.msMatchesSelector||n.webkitMatchesSelector||n.mozMatchesSelector).call(n,e)}function Zd(n){let e={};for(let t in n)e[t]=n[t];return e}function eu(n,e){let t=e.schema.nodes;for(let r in t){let s=t[r];if(!s.allowsMarkType(n))continue;let i=[],o=a=>{i.push(a);for(let l=0;l<a.edgeCount;l++){let{type:c,next:d}=a.edge(l);if(c==e||i.indexOf(d)<0&&o(d))return!0}};if(o(s.contentMatch))return!0}}class er{constructor(e,t){this.nodes=e,this.marks=t}serializeFragment(e,t={},r){r||(r=Ra(t).createDocumentFragment());let s=r,i=[];return e.forEach(o=>{if(i.length||o.marks.length){let a=0,l=0;for(;a<i.length&&l<o.marks.length;){let c=o.marks[l];if(!this.marks[c.type.name]){l++;continue}if(!c.eq(i[a][0])||c.type.spec.spanning===!1)break;a++,l++}for(;a<i.length;)s=i.pop()[1];for(;l<o.marks.length;){let c=o.marks[l++],d=this.serializeMark(c,o.isInline,t);d&&(i.push([c,s]),s.appendChild(d.dom),s=d.contentDOM||d.dom)}}s.appendChild(this.serializeNodeInner(o,t))}),r}serializeNodeInner(e,t){let{dom:r,contentDOM:s}=Ei(Ra(t),this.nodes[e.type.name](e),null,e.attrs);if(s){if(e.isLeaf)throw new RangeError("Content hole not allowed in a leaf node spec");this.serializeFragment(e.content,t,s)}return r}serializeNode(e,t={}){let r=this.serializeNodeInner(e,t);for(let s=e.marks.length-1;s>=0;s--){let i=this.serializeMark(e.marks[s],e.isInline,t);i&&((i.contentDOM||i.dom).appendChild(r),r=i.dom)}return r}serializeMark(e,t,r={}){let s=this.marks[e.type.name];return s&&Ei(Ra(r),s(e,t),null,e.attrs)}static renderSpec(e,t,r=null,s){return Ei(e,t,r,s)}static fromSchema(e){return e.cached.domSerializer||(e.cached.domSerializer=new er(this.nodesFromSchema(e),this.marksFromSchema(e)))}static nodesFromSchema(e){let t=tu(e.nodes);return t.text||(t.text=r=>r.text),t}static marksFromSchema(e){return tu(e.marks)}}function tu(n){let e={};for(let t in n){let r=n[t].spec.toDOM;r&&(e[t]=r)}return e}function Ra(n){return n.document||window.document}const nu=new WeakMap;function mk(n){let e=nu.get(n);return e===void 0&&nu.set(n,e=gk(n)),e}function gk(n){let e=null;function t(r){if(r&&typeof r=="object")if(Array.isArray(r))if(typeof r[0]=="string")e||(e=[]),e.push(r);else for(let s=0;s<r.length;s++)t(r[s]);else for(let s in r)t(r[s])}return t(n),e}function Ei(n,e,t,r){if(typeof e=="string")return{dom:n.createTextNode(e)};if(e.nodeType!=null)return{dom:e};if(e.dom&&e.dom.nodeType!=null)return e;let s=e[0],i;if(typeof s!="string")throw new RangeError("Invalid array passed to renderSpec");if(r&&(i=mk(r))&&i.indexOf(e)>-1)throw new RangeError("Using an array from an attribute object as a DOM spec. This may be an attempted cross site scripting attack.");let o=s.indexOf(" ");o>0&&(t=s.slice(0,o),s=s.slice(o+1));let a,l=t?n.createElementNS(t,s):n.createElement(s),c=e[1],d=1;if(c&&typeof c=="object"&&c.nodeType==null&&!Array.isArray(c)){d=2;for(let h in c)if(c[h]!=null){let f=h.indexOf(" ");f>0?l.setAttributeNS(h.slice(0,f),h.slice(f+1),c[h]):h=="style"&&l.style?l.style.cssText=c[h]:l.setAttribute(h,c[h])}}for(let h=d;h<e.length;h++){let f=e[h];if(f===0){if(h<e.length-1||h>d)throw new RangeError("Content hole must be the only child of its parent node");return{dom:l,contentDOM:l}}else{let{dom:p,contentDOM:m}=Ei(n,f,t,r);if(l.appendChild(p),m){if(a)throw new RangeError("Multiple content holes");a=m}}}return{dom:l,contentDOM:a}}const Cf=65535,Af=Math.pow(2,16);function yk(n,e){return n+e*Af}function ru(n){return n&Cf}function wk(n){return(n-(n&Cf))/Af}const Mf=1,If=2,Ci=4,Of=8;class Il{constructor(e,t,r){this.pos=e,this.delInfo=t,this.recover=r}get deleted(){return(this.delInfo&Of)>0}get deletedBefore(){return(this.delInfo&(Mf|Ci))>0}get deletedAfter(){return(this.delInfo&(If|Ci))>0}get deletedAcross(){return(this.delInfo&Ci)>0}}class Ke{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&Ke.empty)return Ke.empty}recover(e){let t=0,r=ru(e);if(!this.inverted)for(let s=0;s<r;s++)t+=this.ranges[s*3+2]-this.ranges[s*3+1];return this.ranges[r*3]+t+wk(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,r){let s=0,i=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?s:0);if(l>e)break;let c=this.ranges[a+i],d=this.ranges[a+o],h=l+c;if(e<=h){let f=c?e==l?-1:e==h?1:t:t,p=l+s+(f<0?0:d);if(r)return p;let m=e==(t<0?l:h)?null:yk(a/3,e-l),g=e==l?If:e==h?Mf:Ci;return(t<0?e!=l:e!=h)&&(g|=Of),new Il(p,g,m)}s+=d-c}return r?e+s:new Il(e+s,0,null)}touches(e,t){let r=0,s=ru(t),i=this.inverted?2:1,o=this.inverted?1:2;for(let a=0;a<this.ranges.length;a+=3){let l=this.ranges[a]-(this.inverted?r:0);if(l>e)break;let c=this.ranges[a+i],d=l+c;if(e<=d&&a==s*3)return!0;r+=this.ranges[a+o]-c}return!1}forEach(e){let t=this.inverted?2:1,r=this.inverted?1:2;for(let s=0,i=0;s<this.ranges.length;s+=3){let o=this.ranges[s],a=o-(this.inverted?i:0),l=o+(this.inverted?0:i),c=this.ranges[s+t],d=this.ranges[s+r];e(a,a+c,l,l+d),i+=d-c}}invert(){return new Ke(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?Ke.empty:new Ke(e<0?[0,-e,0]:[0,0,e])}}Ke.empty=new Ke([]);class Es{constructor(e,t,r=0,s=e?e.length:0){this.mirror=t,this.from=r,this.to=s,this._maps=e||[],this.ownData=!(e||t)}get maps(){return this._maps}slice(e=0,t=this.maps.length){return new Es(this._maps,this.mirror,e,t)}appendMap(e,t){this.ownData||(this._maps=this._maps.slice(),this.mirror=this.mirror&&this.mirror.slice(),this.ownData=!0),this.to=this._maps.push(e),t!=null&&this.setMirror(this._maps.length-1,t)}appendMapping(e){for(let t=0,r=this._maps.length;t<e._maps.length;t++){let s=e.getMirror(t);this.appendMap(e._maps[t],s!=null&&s<t?r+s:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,r=this._maps.length+e._maps.length;t>=0;t--){let s=e.getMirror(t);this.appendMap(e._maps[t].invert(),s!=null&&s>t?r-s-1:void 0)}}invert(){let e=new Es;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let r=this.from;r<this.to;r++)e=this._maps[r].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,r){let s=0;for(let i=this.from;i<this.to;i++){let o=this._maps[i],a=o.mapResult(e,t);if(a.recover!=null){let l=this.getMirror(i);if(l!=null&&l>i&&l<this.to){i=l,e=this._maps[l].recover(a.recover);continue}}s|=a.delInfo,e=a.pos}return r?e:new Il(e,s,null)}}const Pa=Object.create(null);class Le{getMap(){return Ke.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let r=Pa[t.stepType];if(!r)throw new RangeError(`No step type ${t.stepType} defined`);return r.fromJSON(e,t)}static jsonID(e,t){if(e in Pa)throw new RangeError("Duplicate use of step JSON ID "+e);return Pa[e]=t,t.prototype.jsonID=e,t}}class be{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new be(e,null)}static fail(e){return new be(null,e)}static fromReplace(e,t,r,s){try{return be.ok(e.replace(t,r,s))}catch(i){if(i instanceof Ui)return be.fail(i.message);throw i}}}function bc(n,e,t){let r=[];for(let s=0;s<n.childCount;s++){let i=n.child(s);i.content.size&&(i=i.copy(bc(i.content,e,i))),i.isInline&&(i=e(i,t,s)),r.push(i)}return T.fromArray(r)}class sn extends Le{constructor(e,t,r){super(),this.from=e,this.to=t,this.mark=r}apply(e){let t=e.slice(this.from,this.to),r=e.resolve(this.from),s=r.node(r.sharedDepth(this.to)),i=new O(bc(t.content,(o,a)=>!o.isAtom||!a.type.allowsMarkType(this.mark.type)?o:o.mark(this.mark.addToSet(o.marks)),s),t.openStart,t.openEnd);return be.fromReplace(e,this.from,this.to,i)}invert(){return new ft(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deleted&&r.deleted||t.pos>=r.pos?null:new sn(t.pos,r.pos,this.mark)}merge(e){return e instanceof sn&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new sn(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new sn(t.from,t.to,e.markFromJSON(t.mark))}}Le.jsonID("addMark",sn);class ft extends Le{constructor(e,t,r){super(),this.from=e,this.to=t,this.mark=r}apply(e){let t=e.slice(this.from,this.to),r=new O(bc(t.content,s=>s.mark(this.mark.removeFromSet(s.marks)),e),t.openStart,t.openEnd);return be.fromReplace(e,this.from,this.to,r)}invert(){return new sn(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deleted&&r.deleted||t.pos>=r.pos?null:new ft(t.pos,r.pos,this.mark)}merge(e){return e instanceof ft&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new ft(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new ft(t.from,t.to,e.markFromJSON(t.mark))}}Le.jsonID("removeMark",ft);class on extends Le{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return be.fail("No node at mark step's position");let r=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return be.fromReplace(e,this.pos,this.pos+1,new O(T.from(r),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let r=this.mark.addToSet(t.marks);if(r.length==t.marks.length){for(let s=0;s<t.marks.length;s++)if(!t.marks[s].isInSet(r))return new on(this.pos,t.marks[s]);return new on(this.pos,this.mark)}}return new Kn(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new on(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new on(t.pos,e.markFromJSON(t.mark))}}Le.jsonID("addNodeMark",on);class Kn extends Le{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return be.fail("No node at mark step's position");let r=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return be.fromReplace(e,this.pos,this.pos+1,new O(T.from(r),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new on(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new Kn(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new Kn(t.pos,e.markFromJSON(t.mark))}}Le.jsonID("removeNodeMark",Kn);class xe extends Le{constructor(e,t,r,s=!1){super(),this.from=e,this.to=t,this.slice=r,this.structure=s}apply(e){return this.structure&&Ol(e,this.from,this.to)?be.fail("Structure replace would overwrite content"):be.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new Ke([this.from,this.to-this.from,this.slice.size])}invert(e){return new xe(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deletedAcross&&r.deletedAcross?null:new xe(t.pos,Math.max(t.pos,r.pos),this.slice,this.structure)}merge(e){if(!(e instanceof xe)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?O.empty:new O(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new xe(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?O.empty:new O(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new xe(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new xe(t.from,t.to,O.fromJSON(e,t.slice),!!t.structure)}}Le.jsonID("replace",xe);class Ee extends Le{constructor(e,t,r,s,i,o,a=!1){super(),this.from=e,this.to=t,this.gapFrom=r,this.gapTo=s,this.slice=i,this.insert=o,this.structure=a}apply(e){if(this.structure&&(Ol(e,this.from,this.gapFrom)||Ol(e,this.gapTo,this.to)))return be.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return be.fail("Gap is not a flat range");let r=this.slice.insertAt(this.insert,t.content);return r?be.fromReplace(e,this.from,this.to,r):be.fail("Content does not fit in gap")}getMap(){return new Ke([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new Ee(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1),s=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),i=this.to==this.gapTo?r.pos:e.map(this.gapTo,1);return t.deletedAcross&&r.deletedAcross||s<t.pos||i>r.pos?null:new Ee(t.pos,r.pos,s,i,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new Ee(t.from,t.to,t.gapFrom,t.gapTo,O.fromJSON(e,t.slice),t.insert,!!t.structure)}}Le.jsonID("replaceAround",Ee);function Ol(n,e,t){let r=n.resolve(e),s=t-e,i=r.depth;for(;s>0&&i>0&&r.indexAfter(i)==r.node(i).childCount;)i--,s--;if(s>0){let o=r.node(i).maybeChild(r.indexAfter(i));for(;s>0;){if(!o||o.isLeaf)return!0;o=o.firstChild,s--}}return!1}function bk(n,e,t,r){let s=[],i=[],o,a;n.doc.nodesBetween(e,t,(l,c,d)=>{if(!l.isInline)return;let h=l.marks;if(!r.isInSet(h)&&d.type.allowsMarkType(r.type)){let f=Math.max(c,e),p=Math.min(c+l.nodeSize,t),m=r.addToSet(h);for(let g=0;g<h.length;g++)h[g].isInSet(m)||(o&&o.to==f&&o.mark.eq(h[g])?o.to=p:s.push(o=new ft(f,p,h[g])));a&&a.to==f?a.to=p:i.push(a=new sn(f,p,r))}}),s.forEach(l=>n.step(l)),i.forEach(l=>n.step(l))}function vk(n,e,t,r){let s=[],i=0;n.doc.nodesBetween(e,t,(o,a)=>{if(!o.isInline)return;i++;let l=null;if(r instanceof Wo){let c=o.marks,d;for(;d=r.isInSet(c);)(l||(l=[])).push(d),c=d.removeFromSet(c)}else r?r.isInSet(o.marks)&&(l=[r]):l=o.marks;if(l&&l.length){let c=Math.min(a+o.nodeSize,t);for(let d=0;d<l.length;d++){let h=l[d],f;for(let p=0;p<s.length;p++){let m=s[p];m.step==i-1&&h.eq(s[p].style)&&(f=m)}f?(f.to=c,f.step=i):s.push({style:h,from:Math.max(a,e),to:c,step:i})}}}),s.forEach(o=>n.step(new ft(o.from,o.to,o.style)))}function vc(n,e,t,r=t.contentMatch,s=!0){let i=n.doc.nodeAt(e),o=[],a=e+1;for(let l=0;l<i.childCount;l++){let c=i.child(l),d=a+c.nodeSize,h=r.matchType(c.type);if(!h)o.push(new xe(a,d,O.empty));else{r=h;for(let f=0;f<c.marks.length;f++)t.allowsMarkType(c.marks[f].type)||n.step(new ft(a,d,c.marks[f]));if(s&&c.isText&&t.whitespace!="pre"){let f,p=/\r?\n|\r/g,m;for(;f=p.exec(c.text);)m||(m=new O(T.from(t.schema.text(" ",t.allowedMarks(c.marks))),0,0)),o.push(new xe(a+f.index,a+f.index+f[0].length,m))}}a=d}if(!r.validEnd){let l=r.fillBefore(T.empty,!0);n.replace(a,a,new O(l,0,0))}for(let l=o.length-1;l>=0;l--)n.step(o[l])}function kk(n,e,t){return(e==0||n.canReplace(e,n.childCount))&&(t==n.childCount||n.canReplace(0,t))}function jr(n){let t=n.parent.content.cutByIndex(n.startIndex,n.endIndex);for(let r=n.depth,s=0,i=0;;--r){let o=n.$from.node(r),a=n.$from.index(r)+s,l=n.$to.indexAfter(r)-i;if(r<n.depth&&o.canReplace(a,l,t))return r;if(r==0||o.type.spec.isolating||!kk(o,a,l))break;a&&(s=1),l<o.childCount&&(i=1)}return null}function Sk(n,e,t){let{$from:r,$to:s,depth:i}=e,o=r.before(i+1),a=s.after(i+1),l=o,c=a,d=T.empty,h=0;for(let m=i,g=!1;m>t;m--)g||r.index(m)>0?(g=!0,d=T.from(r.node(m).copy(d)),h++):l--;let f=T.empty,p=0;for(let m=i,g=!1;m>t;m--)g||s.after(m+1)<s.end(m)?(g=!0,f=T.from(s.node(m).copy(f)),p++):c++;n.step(new Ee(l,c,o,a,new O(d.append(f),h,p),d.size-h,!0))}function kc(n,e,t=null,r=n){let s=_k(n,e),i=s&&xk(r,e);return i?s.map(su).concat({type:e,attrs:t}).concat(i.map(su)):null}function su(n){return{type:n,attrs:null}}function _k(n,e){let{parent:t,startIndex:r,endIndex:s}=n,i=t.contentMatchAt(r).findWrapping(e);if(!i)return null;let o=i.length?i[0]:e;return t.canReplaceWith(r,s,o)?i:null}function xk(n,e){let{parent:t,startIndex:r,endIndex:s}=n,i=t.child(r),o=e.contentMatch.findWrapping(i.type);if(!o)return null;let l=(o.length?o[o.length-1]:e).contentMatch;for(let c=r;l&&c<s;c++)l=l.matchType(t.child(c).type);return!l||!l.validEnd?null:o}function Tk(n,e,t){let r=T.empty;for(let o=t.length-1;o>=0;o--){if(r.size){let a=t[o].type.contentMatch.matchFragment(r);if(!a||!a.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}r=T.from(t[o].type.create(t[o].attrs,r))}let s=e.start,i=e.end;n.step(new Ee(s,i,s,i,new O(r,0,0),t.length,!0))}function Ek(n,e,t,r,s){if(!r.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let i=n.steps.length;n.doc.nodesBetween(e,t,(o,a)=>{let l=typeof s=="function"?s(o):s;if(o.isTextblock&&!o.hasMarkup(r,l)&&Ck(n.doc,n.mapping.slice(i).map(a),r)){let c=null;if(r.schema.linebreakReplacement){let p=r.whitespace=="pre",m=!!r.contentMatch.matchType(r.schema.linebreakReplacement);p&&!m?c=!1:!p&&m&&(c=!0)}c===!1&&$f(n,o,a,i),vc(n,n.mapping.slice(i).map(a,1),r,void 0,c===null);let d=n.mapping.slice(i),h=d.map(a,1),f=d.map(a+o.nodeSize,1);return n.step(new Ee(h,f,h+1,f-1,new O(T.from(r.create(l,null,o.marks)),0,0),1,!0)),c===!0&&Nf(n,o,a,i),!1}})}function Nf(n,e,t,r){e.forEach((s,i)=>{if(s.isText){let o,a=/\r?\n|\r/g;for(;o=a.exec(s.text);){let l=n.mapping.slice(r).map(t+1+i+o.index);n.replaceWith(l,l+1,e.type.schema.linebreakReplacement.create())}}})}function $f(n,e,t,r){e.forEach((s,i)=>{if(s.type==s.type.schema.linebreakReplacement){let o=n.mapping.slice(r).map(t+1+i);n.replaceWith(o,o+1,e.type.schema.text(`
`))}})}function Ck(n,e,t){let r=n.resolve(e),s=r.index();return r.parent.canReplaceWith(s,s+1,t)}function Ak(n,e,t,r,s){let i=n.doc.nodeAt(e);if(!i)throw new RangeError("No node at given position");t||(t=i.type);let o=t.create(r,null,s||i.marks);if(i.isLeaf)return n.replaceWith(e,e+i.nodeSize,o);if(!t.validContent(i.content))throw new RangeError("Invalid content for node type "+t.name);n.step(new Ee(e,e+i.nodeSize,e+1,e+i.nodeSize-1,new O(T.from(o),0,0),1,!0))}function Lt(n,e,t=1,r){let s=n.resolve(e),i=s.depth-t,o=r&&r[r.length-1]||s.parent;if(i<0||s.parent.type.spec.isolating||!s.parent.canReplace(s.index(),s.parent.childCount)||!o.type.validContent(s.parent.content.cutByIndex(s.index(),s.parent.childCount)))return!1;for(let c=s.depth-1,d=t-2;c>i;c--,d--){let h=s.node(c),f=s.index(c);if(h.type.spec.isolating)return!1;let p=h.content.cutByIndex(f,h.childCount),m=r&&r[d+1];m&&(p=p.replaceChild(0,m.type.create(m.attrs)));let g=r&&r[d]||h;if(!h.canReplace(f+1,h.childCount)||!g.type.validContent(p))return!1}let a=s.indexAfter(i),l=r&&r[0];return s.node(i).canReplaceWith(a,a,l?l.type:s.node(i+1).type)}function Mk(n,e,t=1,r){let s=n.doc.resolve(e),i=T.empty,o=T.empty;for(let a=s.depth,l=s.depth-t,c=t-1;a>l;a--,c--){i=T.from(s.node(a).copy(i));let d=r&&r[c];o=T.from(d?d.type.create(d.attrs,o):s.node(a).copy(o))}n.step(new xe(e,e,new O(i.append(o),t,t),!0))}function bn(n,e){let t=n.resolve(e),r=t.index();return Rf(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(r,r+1)}function Ik(n,e){e.content.size||n.type.compatibleContent(e.type);let t=n.contentMatchAt(n.childCount),{linebreakReplacement:r}=n.type.schema;for(let s=0;s<e.childCount;s++){let i=e.child(s),o=i.type==r?n.type.schema.nodes.text:i.type;if(t=t.matchType(o),!t||!n.type.allowsMarks(i.marks))return!1}return t.validEnd}function Rf(n,e){return!!(n&&e&&!n.isLeaf&&Ik(n,e))}function Ko(n,e,t=-1){let r=n.resolve(e);for(let s=r.depth;;s--){let i,o,a=r.index(s);if(s==r.depth?(i=r.nodeBefore,o=r.nodeAfter):t>0?(i=r.node(s+1),a++,o=r.node(s).maybeChild(a)):(i=r.node(s).maybeChild(a-1),o=r.node(s+1)),i&&!i.isTextblock&&Rf(i,o)&&r.node(s).canReplace(a,a+1))return e;if(s==0)break;e=t<0?r.before(s):r.after(s)}}function Ok(n,e,t){let r=null,{linebreakReplacement:s}=n.doc.type.schema,i=n.doc.resolve(e-t),o=i.node().type;if(s&&o.inlineContent){let d=o.whitespace=="pre",h=!!o.contentMatch.matchType(s);d&&!h?r=!1:!d&&h&&(r=!0)}let a=n.steps.length;if(r===!1){let d=n.doc.resolve(e+t);$f(n,d.node(),d.before(),a)}o.inlineContent&&vc(n,e+t-1,o,i.node().contentMatchAt(i.index()),r==null);let l=n.mapping.slice(a),c=l.map(e-t);if(n.step(new xe(c,l.map(e+t,-1),O.empty,!0)),r===!0){let d=n.doc.resolve(c);Nf(n,d.node(),d.before(),n.steps.length)}return n}function Nk(n,e,t){let r=n.resolve(e);if(r.parent.canReplaceWith(r.index(),r.index(),t))return e;if(r.parentOffset==0)for(let s=r.depth-1;s>=0;s--){let i=r.index(s);if(r.node(s).canReplaceWith(i,i,t))return r.before(s+1);if(i>0)return null}if(r.parentOffset==r.parent.content.size)for(let s=r.depth-1;s>=0;s--){let i=r.indexAfter(s);if(r.node(s).canReplaceWith(i,i,t))return r.after(s+1);if(i<r.node(s).childCount)return null}return null}function Pf(n,e,t){let r=n.resolve(e);if(!t.content.size)return e;let s=t.content;for(let i=0;i<t.openStart;i++)s=s.firstChild.content;for(let i=1;i<=(t.openStart==0&&t.size?2:1);i++)for(let o=r.depth;o>=0;o--){let a=o==r.depth?0:r.pos<=(r.start(o+1)+r.end(o+1))/2?-1:1,l=r.index(o)+(a>0?1:0),c=r.node(o),d=!1;if(i==1)d=c.canReplace(l,l,s);else{let h=c.contentMatchAt(l).findWrapping(s.firstChild.type);d=h&&c.canReplaceWith(l,l,h[0])}if(d)return a==0?r.pos:a<0?r.before(o+1):r.after(o+1)}return null}function Go(n,e,t=e,r=O.empty){if(e==t&&!r.size)return null;let s=n.resolve(e),i=n.resolve(t);return Df(s,i,r)?new xe(e,t,r):new $k(s,i,r).fit()}function Df(n,e,t){return!t.openStart&&!t.openEnd&&n.start()==e.start()&&n.parent.canReplace(n.index(),e.index(),t.content)}class $k{constructor(e,t,r){this.$from=e,this.$to=t,this.unplaced=r,this.frontier=[],this.placed=T.empty;for(let s=0;s<=e.depth;s++){let i=e.node(s);this.frontier.push({type:i.type,match:i.contentMatchAt(e.indexAfter(s))})}for(let s=e.depth;s>0;s--)this.placed=T.from(e.node(s).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let c=this.findFittable();c?this.placeNodes(c):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,r=this.$from,s=this.close(e<0?this.$to:r.doc.resolve(e));if(!s)return null;let i=this.placed,o=r.depth,a=s.depth;for(;o&&a&&i.childCount==1;)i=i.firstChild.content,o--,a--;let l=new O(i,o,a);return e>-1?new Ee(r.pos,e,this.$to.pos,this.$to.end(),l,t):l.size||r.pos!=this.$to.pos?new xe(r.pos,s.pos,l):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,r=0,s=this.unplaced.openEnd;r<e;r++){let i=t.firstChild;if(t.childCount>1&&(s=0),i.type.spec.isolating&&s<=r){e=r;break}t=i.content}for(let t=1;t<=2;t++)for(let r=t==1?e:this.unplaced.openStart;r>=0;r--){let s,i=null;r?(i=Da(this.unplaced.content,r-1).firstChild,s=i.content):s=this.unplaced.content;let o=s.firstChild;for(let a=this.depth;a>=0;a--){let{type:l,match:c}=this.frontier[a],d,h=null;if(t==1&&(o?c.matchType(o.type)||(h=c.fillBefore(T.from(o),!1)):i&&l.compatibleContent(i.type)))return{sliceDepth:r,frontierDepth:a,parent:i,inject:h};if(t==2&&o&&(d=c.findWrapping(o.type)))return{sliceDepth:r,frontierDepth:a,parent:i,wrap:d};if(i&&c.matchType(i.type))break}}}openMore(){let{content:e,openStart:t,openEnd:r}=this.unplaced,s=Da(e,t);return!s.childCount||s.firstChild.isLeaf?!1:(this.unplaced=new O(e,t+1,Math.max(r,s.size+t>=e.size-r?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:r}=this.unplaced,s=Da(e,t);if(s.childCount<=1&&t>0){let i=e.size-t<=t+s.size;this.unplaced=new O(Yr(e,t-1,1),t-1,i?t-1:r)}else this.unplaced=new O(Yr(e,t,1),t,r)}placeNodes({sliceDepth:e,frontierDepth:t,parent:r,inject:s,wrap:i}){for(;this.depth>t;)this.closeFrontierNode();if(i)for(let g=0;g<i.length;g++)this.openFrontierNode(i[g]);let o=this.unplaced,a=r?r.content:o.content,l=o.openStart-e,c=0,d=[],{match:h,type:f}=this.frontier[t];if(s){for(let g=0;g<s.childCount;g++)d.push(s.child(g));h=h.matchFragment(s)}let p=a.size+e-(o.content.size-o.openEnd);for(;c<a.childCount;){let g=a.child(c),y=h.matchType(g.type);if(!y)break;c++,(c>1||l==0||g.content.size)&&(h=y,d.push(Lf(g.mark(f.allowedMarks(g.marks)),c==1?l:0,c==a.childCount?p:-1)))}let m=c==a.childCount;m||(p=-1),this.placed=Xr(this.placed,t,T.from(d)),this.frontier[t].match=h,m&&p<0&&r&&r.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let g=0,y=a;g<p;g++){let w=y.lastChild;this.frontier.push({type:w.type,match:w.contentMatchAt(w.childCount)}),y=w.content}this.unplaced=m?e==0?O.empty:new O(Yr(o.content,e-1,1),e-1,p<0?o.openEnd:e-1):new O(Yr(o.content,e,c),o.openStart,o.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!La(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:r}=this.$to,s=this.$to.after(r);for(;r>1&&s==this.$to.end(--r);)++s;return s}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:r,type:s}=this.frontier[t],i=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),o=La(e,t,s,r,i);if(o){for(let a=t-1;a>=0;a--){let{match:l,type:c}=this.frontier[a],d=La(e,a,c,l,!0);if(!d||d.childCount)continue e}return{depth:t,fit:o,move:i?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=Xr(this.placed,t.depth,t.fit)),e=t.move;for(let r=t.depth+1;r<=e.depth;r++){let s=e.node(r),i=s.type.contentMatch.fillBefore(s.content,!0,e.index(r));this.openFrontierNode(s.type,s.attrs,i)}return e}openFrontierNode(e,t=null,r){let s=this.frontier[this.depth];s.match=s.match.matchType(e),this.placed=Xr(this.placed,this.depth,T.from(e.create(t,r))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(T.empty,!0);t.childCount&&(this.placed=Xr(this.placed,this.frontier.length,t))}}function Yr(n,e,t){return e==0?n.cutByIndex(t,n.childCount):n.replaceChild(0,n.firstChild.copy(Yr(n.firstChild.content,e-1,t)))}function Xr(n,e,t){return e==0?n.append(t):n.replaceChild(n.childCount-1,n.lastChild.copy(Xr(n.lastChild.content,e-1,t)))}function Da(n,e){for(let t=0;t<e;t++)n=n.firstChild.content;return n}function Lf(n,e,t){if(e<=0)return n;let r=n.content;return e>1&&(r=r.replaceChild(0,Lf(r.firstChild,e-1,r.childCount==1?t-1:0))),e>0&&(r=n.type.contentMatch.fillBefore(r).append(r),t<=0&&(r=r.append(n.type.contentMatch.matchFragment(r).fillBefore(T.empty,!0)))),n.copy(r)}function La(n,e,t,r,s){let i=n.node(e),o=s?n.indexAfter(e):n.index(e);if(o==i.childCount&&!t.compatibleContent(i.type))return null;let a=r.fillBefore(i.content,!0,o);return a&&!Rk(t,i.content,o)?a:null}function Rk(n,e,t){for(let r=t;r<e.childCount;r++)if(!n.allowsMarks(e.child(r).marks))return!0;return!1}function Pk(n){return n.spec.defining||n.spec.definingForContent}function Dk(n,e,t,r){if(!r.size)return n.deleteRange(e,t);let s=n.doc.resolve(e),i=n.doc.resolve(t);if(Df(s,i,r))return n.step(new xe(e,t,r));let o=Bf(s,i);o[o.length-1]==0&&o.pop();let a=-(s.depth+1);o.unshift(a);for(let f=s.depth,p=s.pos-1;f>0;f--,p--){let m=s.node(f).type.spec;if(m.defining||m.definingAsContext||m.isolating)break;o.indexOf(f)>-1?a=f:s.before(f)==p&&o.splice(1,0,-f)}let l=o.indexOf(a),c=[],d=r.openStart;for(let f=r.content,p=0;;p++){let m=f.firstChild;if(c.push(m),p==r.openStart)break;f=m.content}for(let f=d-1;f>=0;f--){let p=c[f],m=Pk(p.type);if(m&&!p.sameMarkup(s.node(Math.abs(a)-1)))d=f;else if(m||!p.type.isTextblock)break}for(let f=r.openStart;f>=0;f--){let p=(f+d+1)%(r.openStart+1),m=c[p];if(m)for(let g=0;g<o.length;g++){let y=o[(g+l)%o.length],w=!0;y<0&&(w=!1,y=-y);let v=s.node(y-1),b=s.index(y-1);if(v.canReplaceWith(b,b,m.type,m.marks))return n.replace(s.before(y),w?i.after(y):t,new O(jf(r.content,0,r.openStart,p),p,r.openEnd))}}let h=n.steps.length;for(let f=o.length-1;f>=0&&(n.replace(e,t,r),!(n.steps.length>h));f--){let p=o[f];p<0||(e=s.before(p),t=i.after(p))}}function jf(n,e,t,r,s){if(e<t){let i=n.firstChild;n=n.replaceChild(0,i.copy(jf(i.content,e+1,t,r,i)))}if(e>r){let i=s.contentMatchAt(0),o=i.fillBefore(n).append(n);n=o.append(i.matchFragment(o).fillBefore(T.empty,!0))}return n}function Lk(n,e,t,r){if(!r.isInline&&e==t&&n.doc.resolve(e).parent.content.size){let s=Nk(n.doc,e,r.type);s!=null&&(e=t=s)}n.replaceRange(e,t,new O(T.from(r),0,0))}function jk(n,e,t){let r=n.doc.resolve(e),s=n.doc.resolve(t),i=Bf(r,s);for(let o=0;o<i.length;o++){let a=i[o],l=o==i.length-1;if(l&&a==0||r.node(a).type.contentMatch.validEnd)return n.delete(r.start(a),s.end(a));if(a>0&&(l||r.node(a-1).canReplace(r.index(a-1),s.indexAfter(a-1))))return n.delete(r.before(a),s.after(a))}for(let o=1;o<=r.depth&&o<=s.depth;o++)if(e-r.start(o)==r.depth-o&&t>r.end(o)&&s.end(o)-t!=s.depth-o&&r.start(o-1)==s.start(o-1)&&r.node(o-1).canReplace(r.index(o-1),s.index(o-1)))return n.delete(r.before(o),t);n.delete(e,t)}function Bf(n,e){let t=[],r=Math.min(n.depth,e.depth);for(let s=r;s>=0;s--){let i=n.start(s);if(i<n.pos-(n.depth-s)||e.end(s)>e.pos+(e.depth-s)||n.node(s).type.spec.isolating||e.node(s).type.spec.isolating)break;(i==e.start(s)||s==n.depth&&s==e.depth&&n.parent.inlineContent&&e.parent.inlineContent&&s&&e.start(s-1)==i-1)&&t.push(s)}return t}class kr extends Le{constructor(e,t,r){super(),this.pos=e,this.attr=t,this.value=r}apply(e){let t=e.nodeAt(this.pos);if(!t)return be.fail("No node at attribute step's position");let r=Object.create(null);for(let i in t.attrs)r[i]=t.attrs[i];r[this.attr]=this.value;let s=t.type.create(r,null,t.marks);return be.fromReplace(e,this.pos,this.pos+1,new O(T.from(s),0,t.isLeaf?0:1))}getMap(){return Ke.empty}invert(e){return new kr(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new kr(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new kr(t.pos,t.attr,t.value)}}Le.jsonID("attr",kr);class Cs extends Le{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let s in e.attrs)t[s]=e.attrs[s];t[this.attr]=this.value;let r=e.type.create(t,e.content,e.marks);return be.ok(r)}getMap(){return Ke.empty}invert(e){return new Cs(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new Cs(t.attr,t.value)}}Le.jsonID("docAttr",Cs);let Ar=class extends Error{};Ar=function n(e){let t=Error.call(this,e);return t.__proto__=n.prototype,t};Ar.prototype=Object.create(Error.prototype);Ar.prototype.constructor=Ar;Ar.prototype.name="TransformError";class Ff{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new Es}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new Ar(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,r=O.empty){let s=Go(this.doc,e,t,r);return s&&this.step(s),this}replaceWith(e,t,r){return this.replace(e,t,new O(T.from(r),0,0))}delete(e,t){return this.replace(e,t,O.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,r){return Dk(this,e,t,r),this}replaceRangeWith(e,t,r){return Lk(this,e,t,r),this}deleteRange(e,t){return jk(this,e,t),this}lift(e,t){return Sk(this,e,t),this}join(e,t=1){return Ok(this,e,t),this}wrap(e,t){return Tk(this,e,t),this}setBlockType(e,t=e,r,s=null){return Ek(this,e,t,r,s),this}setNodeMarkup(e,t,r=null,s){return Ak(this,e,t,r,s),this}setNodeAttribute(e,t,r){return this.step(new kr(e,t,r)),this}setDocAttribute(e,t){return this.step(new Cs(e,t)),this}addNodeMark(e,t){return this.step(new on(e,t)),this}removeNodeMark(e,t){let r=this.doc.nodeAt(e);if(!r)throw new RangeError("No node at position "+e);if(t instanceof ne)t.isInSet(r.marks)&&this.step(new Kn(e,t));else{let s=r.marks,i,o=[];for(;i=t.isInSet(s);)o.push(new Kn(e,i)),s=i.removeFromSet(s);for(let a=o.length-1;a>=0;a--)this.step(o[a])}return this}split(e,t=1,r){return Mk(this,e,t,r),this}addMark(e,t,r){return bk(this,e,t,r),this}removeMark(e,t,r){return vk(this,e,t,r),this}clearIncompatible(e,t,r){return vc(this,e,t,r),this}}const ja=Object.create(null);class G{constructor(e,t,r){this.$anchor=e,this.$head=t,this.ranges=r||[new Bk(e.min(t),e.max(t))]}get anchor(){return this.$anchor.pos}get head(){return this.$head.pos}get from(){return this.$from.pos}get to(){return this.$to.pos}get $from(){return this.ranges[0].$from}get $to(){return this.ranges[0].$to}get empty(){let e=this.ranges;for(let t=0;t<e.length;t++)if(e[t].$from.pos!=e[t].$to.pos)return!1;return!0}content(){return this.$from.doc.slice(this.from,this.to,!0)}replace(e,t=O.empty){let r=t.content.lastChild,s=null;for(let a=0;a<t.openEnd;a++)s=r,r=r.lastChild;let i=e.steps.length,o=this.ranges;for(let a=0;a<o.length;a++){let{$from:l,$to:c}=o[a],d=e.mapping.slice(i);e.replaceRange(d.map(l.pos),d.map(c.pos),a?O.empty:t),a==0&&au(e,i,(r?r.isInline:s&&s.isTextblock)?-1:1)}}replaceWith(e,t){let r=e.steps.length,s=this.ranges;for(let i=0;i<s.length;i++){let{$from:o,$to:a}=s[i],l=e.mapping.slice(r),c=l.map(o.pos),d=l.map(a.pos);i?e.deleteRange(c,d):(e.replaceRangeWith(c,d,t),au(e,r,t.isInline?-1:1))}}static findFrom(e,t,r=!1){let s=e.parent.inlineContent?new z(e):fr(e.node(0),e.parent,e.pos,e.index(),t,r);if(s)return s;for(let i=e.depth-1;i>=0;i--){let o=t<0?fr(e.node(0),e.node(i),e.before(i+1),e.index(i),t,r):fr(e.node(0),e.node(i),e.after(i+1),e.index(i)+1,t,r);if(o)return o}return null}static near(e,t=1){return this.findFrom(e,t)||this.findFrom(e,-t)||new Je(e.node(0))}static atStart(e){return fr(e,e,0,0,1)||new Je(e)}static atEnd(e){return fr(e,e,e.content.size,e.childCount,-1)||new Je(e)}static fromJSON(e,t){if(!t||!t.type)throw new RangeError("Invalid input for Selection.fromJSON");let r=ja[t.type];if(!r)throw new RangeError(`No selection type ${t.type} defined`);return r.fromJSON(e,t)}static jsonID(e,t){if(e in ja)throw new RangeError("Duplicate use of selection JSON ID "+e);return ja[e]=t,t.prototype.jsonID=e,t}getBookmark(){return z.between(this.$anchor,this.$head).getBookmark()}}G.prototype.visible=!0;class Bk{constructor(e,t){this.$from=e,this.$to=t}}let iu=!1;function ou(n){!iu&&!n.parent.inlineContent&&(iu=!0,console.warn("TextSelection endpoint not pointing into a node with inline content ("+n.parent.type.name+")"))}class z extends G{constructor(e,t=e){ou(e),ou(t),super(e,t)}get $cursor(){return this.$anchor.pos==this.$head.pos?this.$head:null}map(e,t){let r=e.resolve(t.map(this.head));if(!r.parent.inlineContent)return G.near(r);let s=e.resolve(t.map(this.anchor));return new z(s.parent.inlineContent?s:r,r)}replace(e,t=O.empty){if(super.replace(e,t),t==O.empty){let r=this.$from.marksAcross(this.$to);r&&e.ensureMarks(r)}}eq(e){return e instanceof z&&e.anchor==this.anchor&&e.head==this.head}getBookmark(){return new Jo(this.anchor,this.head)}toJSON(){return{type:"text",anchor:this.anchor,head:this.head}}static fromJSON(e,t){if(typeof t.anchor!="number"||typeof t.head!="number")throw new RangeError("Invalid input for TextSelection.fromJSON");return new z(e.resolve(t.anchor),e.resolve(t.head))}static create(e,t,r=t){let s=e.resolve(t);return new this(s,r==t?s:e.resolve(r))}static between(e,t,r){let s=e.pos-t.pos;if((!r||s)&&(r=s>=0?1:-1),!t.parent.inlineContent){let i=G.findFrom(t,r,!0)||G.findFrom(t,-r,!0);if(i)t=i.$head;else return G.near(t,r)}return e.parent.inlineContent||(s==0?e=t:(e=(G.findFrom(e,-r,!0)||G.findFrom(e,r,!0)).$anchor,e.pos<t.pos!=s<0&&(e=t))),new z(e,t)}}G.jsonID("text",z);class Jo{constructor(e,t){this.anchor=e,this.head=t}map(e){return new Jo(e.map(this.anchor),e.map(this.head))}resolve(e){return z.between(e.resolve(this.anchor),e.resolve(this.head))}}class D extends G{constructor(e){let t=e.nodeAfter,r=e.node(0).resolve(e.pos+t.nodeSize);super(e,r),this.node=t}map(e,t){let{deleted:r,pos:s}=t.mapResult(this.anchor),i=e.resolve(s);return r?G.near(i):new D(i)}content(){return new O(T.from(this.node),0,0)}eq(e){return e instanceof D&&e.anchor==this.anchor}toJSON(){return{type:"node",anchor:this.anchor}}getBookmark(){return new Sc(this.anchor)}static fromJSON(e,t){if(typeof t.anchor!="number")throw new RangeError("Invalid input for NodeSelection.fromJSON");return new D(e.resolve(t.anchor))}static create(e,t){return new D(e.resolve(t))}static isSelectable(e){return!e.isText&&e.type.spec.selectable!==!1}}D.prototype.visible=!1;G.jsonID("node",D);class Sc{constructor(e){this.anchor=e}map(e){let{deleted:t,pos:r}=e.mapResult(this.anchor);return t?new Jo(r,r):new Sc(r)}resolve(e){let t=e.resolve(this.anchor),r=t.nodeAfter;return r&&D.isSelectable(r)?new D(t):G.near(t)}}class Je extends G{constructor(e){super(e.resolve(0),e.resolve(e.content.size))}replace(e,t=O.empty){if(t==O.empty){e.delete(0,e.doc.content.size);let r=G.atStart(e.doc);r.eq(e.selection)||e.setSelection(r)}else super.replace(e,t)}toJSON(){return{type:"all"}}static fromJSON(e){return new Je(e)}map(e){return new Je(e)}eq(e){return e instanceof Je}getBookmark(){return Fk}}G.jsonID("all",Je);const Fk={map(){return this},resolve(n){return new Je(n)}};function fr(n,e,t,r,s,i=!1){if(e.inlineContent)return z.create(n,t);for(let o=r-(s>0?0:1);s>0?o<e.childCount:o>=0;o+=s){let a=e.child(o);if(a.isAtom){if(!i&&D.isSelectable(a))return D.create(n,t-(s<0?a.nodeSize:0))}else{let l=fr(n,a,t+s,s<0?a.childCount:0,s,i);if(l)return l}t+=a.nodeSize*s}return null}function au(n,e,t){let r=n.steps.length-1;if(r<e)return;let s=n.steps[r];if(!(s instanceof xe||s instanceof Ee))return;let i=n.mapping.maps[r],o;i.forEach((a,l,c,d)=>{o==null&&(o=d)}),n.setSelection(G.near(n.doc.resolve(o),t))}const lu=1,fi=2,cu=4;class Uk extends Ff{constructor(e){super(e.doc),this.curSelectionFor=0,this.updated=0,this.meta=Object.create(null),this.time=Date.now(),this.curSelection=e.selection,this.storedMarks=e.storedMarks}get selection(){return this.curSelectionFor<this.steps.length&&(this.curSelection=this.curSelection.map(this.doc,this.mapping.slice(this.curSelectionFor)),this.curSelectionFor=this.steps.length),this.curSelection}setSelection(e){if(e.$from.doc!=this.doc)throw new RangeError("Selection passed to setSelection must point at the current document");return this.curSelection=e,this.curSelectionFor=this.steps.length,this.updated=(this.updated|lu)&~fi,this.storedMarks=null,this}get selectionSet(){return(this.updated&lu)>0}setStoredMarks(e){return this.storedMarks=e,this.updated|=fi,this}ensureMarks(e){return ne.sameSet(this.storedMarks||this.selection.$from.marks(),e)||this.setStoredMarks(e),this}addStoredMark(e){return this.ensureMarks(e.addToSet(this.storedMarks||this.selection.$head.marks()))}removeStoredMark(e){return this.ensureMarks(e.removeFromSet(this.storedMarks||this.selection.$head.marks()))}get storedMarksSet(){return(this.updated&fi)>0}addStep(e,t){super.addStep(e,t),this.updated=this.updated&~fi,this.storedMarks=null}setTime(e){return this.time=e,this}replaceSelection(e){return this.selection.replace(this,e),this}replaceSelectionWith(e,t=!0){let r=this.selection;return t&&(e=e.mark(this.storedMarks||(r.empty?r.$from.marks():r.$from.marksAcross(r.$to)||ne.none))),r.replaceWith(this,e),this}deleteSelection(){return this.selection.replace(this),this}insertText(e,t,r){let s=this.doc.type.schema;if(t==null)return e?this.replaceSelectionWith(s.text(e),!0):this.deleteSelection();{if(r==null&&(r=t),!e)return this.deleteRange(t,r);let i=this.storedMarks;if(!i){let o=this.doc.resolve(t);i=r==t?o.marks():o.marksAcross(this.doc.resolve(r))}return this.replaceRangeWith(t,r,s.text(e,i)),!this.selection.empty&&this.selection.to==t+e.length&&this.setSelection(G.near(this.selection.$to)),this}}setMeta(e,t){return this.meta[typeof e=="string"?e:e.key]=t,this}getMeta(e){return this.meta[typeof e=="string"?e:e.key]}get isGeneric(){for(let e in this.meta)return!1;return!0}scrollIntoView(){return this.updated|=cu,this}get scrolledIntoView(){return(this.updated&cu)>0}}function du(n,e){return!e||!n?n:n.bind(e)}class Qr{constructor(e,t,r){this.name=e,this.init=du(t.init,r),this.apply=du(t.apply,r)}}const zk=[new Qr("doc",{init(n){return n.doc||n.schema.topNodeType.createAndFill()},apply(n){return n.doc}}),new Qr("selection",{init(n,e){return n.selection||G.atStart(e.doc)},apply(n){return n.selection}}),new Qr("storedMarks",{init(n){return n.storedMarks||null},apply(n,e,t,r){return r.selection.$cursor?n.storedMarks:null}}),new Qr("scrollToSelection",{init(){return 0},apply(n,e){return n.scrolledIntoView?e+1:e}})];class Ba{constructor(e,t){this.schema=e,this.plugins=[],this.pluginsByKey=Object.create(null),this.fields=zk.slice(),t&&t.forEach(r=>{if(this.pluginsByKey[r.key])throw new RangeError("Adding different instances of a keyed plugin ("+r.key+")");this.plugins.push(r),this.pluginsByKey[r.key]=r,r.spec.state&&this.fields.push(new Qr(r.key,r.spec.state,r))})}}class wr{constructor(e){this.config=e}get schema(){return this.config.schema}get plugins(){return this.config.plugins}apply(e){return this.applyTransaction(e).state}filterTransaction(e,t=-1){for(let r=0;r<this.config.plugins.length;r++)if(r!=t){let s=this.config.plugins[r];if(s.spec.filterTransaction&&!s.spec.filterTransaction.call(s,e,this))return!1}return!0}applyTransaction(e){if(!this.filterTransaction(e))return{state:this,transactions:[]};let t=[e],r=this.applyInner(e),s=null;for(;;){let i=!1;for(let o=0;o<this.config.plugins.length;o++){let a=this.config.plugins[o];if(a.spec.appendTransaction){let l=s?s[o].n:0,c=s?s[o].state:this,d=l<t.length&&a.spec.appendTransaction.call(a,l?t.slice(l):t,c,r);if(d&&r.filterTransaction(d,o)){if(d.setMeta("appendedTransaction",e),!s){s=[];for(let h=0;h<this.config.plugins.length;h++)s.push(h<o?{state:r,n:t.length}:{state:this,n:0})}t.push(d),r=r.applyInner(d),i=!0}s&&(s[o]={state:r,n:t.length})}}if(!i)return{state:r,transactions:t}}}applyInner(e){if(!e.before.eq(this.doc))throw new RangeError("Applying a mismatched transaction");let t=new wr(this.config),r=this.config.fields;for(let s=0;s<r.length;s++){let i=r[s];t[i.name]=i.apply(e,this[i.name],this,t)}return t}get tr(){return new Uk(this)}static create(e){let t=new Ba(e.doc?e.doc.type.schema:e.schema,e.plugins),r=new wr(t);for(let s=0;s<t.fields.length;s++)r[t.fields[s].name]=t.fields[s].init(e,r);return r}reconfigure(e){let t=new Ba(this.schema,e.plugins),r=t.fields,s=new wr(t);for(let i=0;i<r.length;i++){let o=r[i].name;s[o]=this.hasOwnProperty(o)?this[o]:r[i].init(e,s)}return s}toJSON(e){let t={doc:this.doc.toJSON(),selection:this.selection.toJSON()};if(this.storedMarks&&(t.storedMarks=this.storedMarks.map(r=>r.toJSON())),e&&typeof e=="object")for(let r in e){if(r=="doc"||r=="selection")throw new RangeError("The JSON fields `doc` and `selection` are reserved");let s=e[r],i=s.spec.state;i&&i.toJSON&&(t[r]=i.toJSON.call(s,this[s.key]))}return t}static fromJSON(e,t,r){if(!t)throw new RangeError("Invalid input for EditorState.fromJSON");if(!e.schema)throw new RangeError("Required config field 'schema' missing");let s=new Ba(e.schema,e.plugins),i=new wr(s);return s.fields.forEach(o=>{if(o.name=="doc")i.doc=pt.fromJSON(e.schema,t.doc);else if(o.name=="selection")i.selection=G.fromJSON(i.doc,t.selection);else if(o.name=="storedMarks")t.storedMarks&&(i.storedMarks=t.storedMarks.map(e.schema.markFromJSON));else{if(r)for(let a in r){let l=r[a],c=l.spec.state;if(l.key==o.name&&c&&c.fromJSON&&Object.prototype.hasOwnProperty.call(t,a)){i[o.name]=c.fromJSON.call(l,e,t[a],i);return}}i[o.name]=o.init(e,i)}}),i}}function Uf(n,e,t){for(let r in n){let s=n[r];s instanceof Function?s=s.bind(e):r=="handleDOMEvents"&&(s=Uf(s,e,{})),t[r]=s}return t}class le{constructor(e){this.spec=e,this.props={},e.props&&Uf(e.props,this,this.props),this.key=e.key?e.key.key:zf("plugin")}getState(e){return e[this.key]}}const Fa=Object.create(null);function zf(n){return n in Fa?n+"$"+ ++Fa[n]:(Fa[n]=0,n+"$")}class Se{constructor(e="key"){this.key=zf(e)}get(e){return e.config.pluginsByKey[this.key]}getState(e){return e[this.key]}}const _c=(n,e)=>n.selection.empty?!1:(e&&e(n.tr.deleteSelection().scrollIntoView()),!0);function Hf(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("backward",n):t.parentOffset>0)?null:t}const Vf=(n,e,t)=>{let r=Hf(n,t);if(!r)return!1;let s=xc(r);if(!s){let o=r.blockRange(),a=o&&jr(o);return a==null?!1:(e&&e(n.tr.lift(o,a).scrollIntoView()),!0)}let i=s.nodeBefore;if(Zf(n,s,e,-1))return!0;if(r.parent.content.size==0&&(Mr(i,"end")||D.isSelectable(i)))for(let o=r.depth;;o--){let a=Go(n.doc,r.before(o),r.after(o),O.empty);if(a&&a.slice.size<a.to-a.from){if(e){let l=n.tr.step(a);l.setSelection(Mr(i,"end")?G.findFrom(l.doc.resolve(l.mapping.map(s.pos,-1)),-1):D.create(l.doc,s.pos-i.nodeSize)),e(l.scrollIntoView())}return!0}if(o==1||r.node(o-1).childCount>1)break}return i.isAtom&&s.depth==r.depth-1?(e&&e(n.tr.delete(s.pos-i.nodeSize,s.pos).scrollIntoView()),!0):!1},Hk=(n,e,t)=>{let r=Hf(n,t);if(!r)return!1;let s=xc(r);return s?qf(n,s,e):!1},Vk=(n,e,t)=>{let r=Kf(n,t);if(!r)return!1;let s=Tc(r);return s?qf(n,s,e):!1};function qf(n,e,t){let r=e.nodeBefore,s=r,i=e.pos-1;for(;!s.isTextblock;i--){if(s.type.spec.isolating)return!1;let d=s.lastChild;if(!d)return!1;s=d}let o=e.nodeAfter,a=o,l=e.pos+1;for(;!a.isTextblock;l++){if(a.type.spec.isolating)return!1;let d=a.firstChild;if(!d)return!1;a=d}let c=Go(n.doc,i,l,O.empty);if(!c||c.from!=i||c instanceof xe&&c.slice.size>=l-i)return!1;if(t){let d=n.tr.step(c);d.setSelection(z.create(d.doc,i)),t(d.scrollIntoView())}return!0}function Mr(n,e,t=!1){for(let r=n;r;r=e=="start"?r.firstChild:r.lastChild){if(r.isTextblock)return!0;if(t&&r.childCount!=1)return!1}return!1}const Wf=(n,e,t)=>{let{$head:r,empty:s}=n.selection,i=r;if(!s)return!1;if(r.parent.isTextblock){if(t?!t.endOfTextblock("backward",n):r.parentOffset>0)return!1;i=xc(r)}let o=i&&i.nodeBefore;return!o||!D.isSelectable(o)?!1:(e&&e(n.tr.setSelection(D.create(n.doc,i.pos-o.nodeSize)).scrollIntoView()),!0)};function xc(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){if(n.index(e)>0)return n.doc.resolve(n.before(e+1));if(n.node(e).type.spec.isolating)break}return null}function Kf(n,e){let{$cursor:t}=n.selection;return!t||(e?!e.endOfTextblock("forward",n):t.parentOffset<t.parent.content.size)?null:t}const Gf=(n,e,t)=>{let r=Kf(n,t);if(!r)return!1;let s=Tc(r);if(!s)return!1;let i=s.nodeAfter;if(Zf(n,s,e,1))return!0;if(r.parent.content.size==0&&(Mr(i,"start")||D.isSelectable(i))){let o=Go(n.doc,r.before(),r.after(),O.empty);if(o&&o.slice.size<o.to-o.from){if(e){let a=n.tr.step(o);a.setSelection(Mr(i,"start")?G.findFrom(a.doc.resolve(a.mapping.map(s.pos)),1):D.create(a.doc,a.mapping.map(s.pos))),e(a.scrollIntoView())}return!0}}return i.isAtom&&s.depth==r.depth-1?(e&&e(n.tr.delete(s.pos,s.pos+i.nodeSize).scrollIntoView()),!0):!1},Jf=(n,e,t)=>{let{$head:r,empty:s}=n.selection,i=r;if(!s)return!1;if(r.parent.isTextblock){if(t?!t.endOfTextblock("forward",n):r.parentOffset<r.parent.content.size)return!1;i=Tc(r)}let o=i&&i.nodeAfter;return!o||!D.isSelectable(o)?!1:(e&&e(n.tr.setSelection(D.create(n.doc,i.pos)).scrollIntoView()),!0)};function Tc(n){if(!n.parent.type.spec.isolating)for(let e=n.depth-1;e>=0;e--){let t=n.node(e);if(n.index(e)+1<t.childCount)return n.doc.resolve(n.after(e+1));if(t.type.spec.isolating)break}return null}const qk=(n,e)=>{let t=n.selection,r=t instanceof D,s;if(r){if(t.node.isTextblock||!bn(n.doc,t.from))return!1;s=t.from}else if(s=Ko(n.doc,t.from,-1),s==null)return!1;if(e){let i=n.tr.join(s);r&&i.setSelection(D.create(i.doc,s-n.doc.resolve(s).nodeBefore.nodeSize)),e(i.scrollIntoView())}return!0},Wk=(n,e)=>{let t=n.selection,r;if(t instanceof D){if(t.node.isTextblock||!bn(n.doc,t.to))return!1;r=t.to}else if(r=Ko(n.doc,t.to,1),r==null)return!1;return e&&e(n.tr.join(r).scrollIntoView()),!0},Kk=(n,e)=>{let{$from:t,$to:r}=n.selection,s=t.blockRange(r),i=s&&jr(s);return i==null?!1:(e&&e(n.tr.lift(s,i).scrollIntoView()),!0)},Yf=(n,e)=>{let{$head:t,$anchor:r}=n.selection;return!t.parent.type.spec.code||!t.sameParent(r)?!1:(e&&e(n.tr.insertText(`
`).scrollIntoView()),!0)};function Ec(n){for(let e=0;e<n.edgeCount;e++){let{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}const Gk=(n,e)=>{let{$head:t,$anchor:r}=n.selection;if(!t.parent.type.spec.code||!t.sameParent(r))return!1;let s=t.node(-1),i=t.indexAfter(-1),o=Ec(s.contentMatchAt(i));if(!o||!s.canReplaceWith(i,i,o))return!1;if(e){let a=t.after(),l=n.tr.replaceWith(a,a,o.createAndFill());l.setSelection(G.near(l.doc.resolve(a),1)),e(l.scrollIntoView())}return!0},Xf=(n,e)=>{let t=n.selection,{$from:r,$to:s}=t;if(t instanceof Je||r.parent.inlineContent||s.parent.inlineContent)return!1;let i=Ec(s.parent.contentMatchAt(s.indexAfter()));if(!i||!i.isTextblock)return!1;if(e){let o=(!r.parentOffset&&s.index()<s.parent.childCount?r:s).pos,a=n.tr.insert(o,i.createAndFill());a.setSelection(z.create(a.doc,o+1)),e(a.scrollIntoView())}return!0},Qf=(n,e)=>{let{$cursor:t}=n.selection;if(!t||t.parent.content.size)return!1;if(t.depth>1&&t.after()!=t.end(-1)){let i=t.before();if(Lt(n.doc,i))return e&&e(n.tr.split(i).scrollIntoView()),!0}let r=t.blockRange(),s=r&&jr(r);return s==null?!1:(e&&e(n.tr.lift(r,s).scrollIntoView()),!0)};function Jk(n){return(e,t)=>{let{$from:r,$to:s}=e.selection;if(e.selection instanceof D&&e.selection.node.isBlock)return!r.parentOffset||!Lt(e.doc,r.pos)?!1:(t&&t(e.tr.split(r.pos).scrollIntoView()),!0);if(!r.depth)return!1;let i=[],o,a,l=!1,c=!1;for(let p=r.depth;;p--)if(r.node(p).isBlock){l=r.end(p)==r.pos+(r.depth-p),c=r.start(p)==r.pos-(r.depth-p),a=Ec(r.node(p-1).contentMatchAt(r.indexAfter(p-1))),i.unshift(l&&a?{type:a}:null),o=p;break}else{if(p==1)return!1;i.unshift(null)}let d=e.tr;(e.selection instanceof z||e.selection instanceof Je)&&d.deleteSelection();let h=d.mapping.map(r.pos),f=Lt(d.doc,h,i.length,i);if(f||(i[0]=a?{type:a}:null,f=Lt(d.doc,h,i.length,i)),!f)return!1;if(d.split(h,i.length,i),!l&&c&&r.node(o).type!=a){let p=d.mapping.map(r.before(o)),m=d.doc.resolve(p);a&&r.node(o-1).canReplaceWith(m.index(),m.index()+1,a)&&d.setNodeMarkup(d.mapping.map(r.before(o)),a)}return t&&t(d.scrollIntoView()),!0}}const Yk=Jk(),Xk=(n,e)=>{let{$from:t,to:r}=n.selection,s,i=t.sharedDepth(r);return i==0?!1:(s=t.before(i),e&&e(n.tr.setSelection(D.create(n.doc,s))),!0)};function Qk(n,e,t){let r=e.nodeBefore,s=e.nodeAfter,i=e.index();return!r||!s||!r.type.compatibleContent(s.type)?!1:!r.content.size&&e.parent.canReplace(i-1,i)?(t&&t(n.tr.delete(e.pos-r.nodeSize,e.pos).scrollIntoView()),!0):!e.parent.canReplace(i,i+1)||!(s.isTextblock||bn(n.doc,e.pos))?!1:(t&&t(n.tr.join(e.pos).scrollIntoView()),!0)}function Zf(n,e,t,r){let s=e.nodeBefore,i=e.nodeAfter,o,a,l=s.type.spec.isolating||i.type.spec.isolating;if(!l&&Qk(n,e,t))return!0;let c=!l&&e.parent.canReplace(e.index(),e.index()+1);if(c&&(o=(a=s.contentMatchAt(s.childCount)).findWrapping(i.type))&&a.matchType(o[0]||i.type).validEnd){if(t){let p=e.pos+i.nodeSize,m=T.empty;for(let w=o.length-1;w>=0;w--)m=T.from(o[w].create(null,m));m=T.from(s.copy(m));let g=n.tr.step(new Ee(e.pos-1,p,e.pos,p,new O(m,1,0),o.length,!0)),y=g.doc.resolve(p+2*o.length);y.nodeAfter&&y.nodeAfter.type==s.type&&bn(g.doc,y.pos)&&g.join(y.pos),t(g.scrollIntoView())}return!0}let d=i.type.spec.isolating||r>0&&l?null:G.findFrom(e,1),h=d&&d.$from.blockRange(d.$to),f=h&&jr(h);if(f!=null&&f>=e.depth)return t&&t(n.tr.lift(h,f).scrollIntoView()),!0;if(c&&Mr(i,"start",!0)&&Mr(s,"end")){let p=s,m=[];for(;m.push(p),!p.isTextblock;)p=p.lastChild;let g=i,y=1;for(;!g.isTextblock;g=g.firstChild)y++;if(p.canReplace(p.childCount,p.childCount,g.content)){if(t){let w=T.empty;for(let b=m.length-1;b>=0;b--)w=T.from(m[b].copy(w));let v=n.tr.step(new Ee(e.pos-m.length,e.pos+i.nodeSize,e.pos+y,e.pos+i.nodeSize-y,new O(w,m.length,0),0,!0));t(v.scrollIntoView())}return!0}}return!1}function ep(n){return function(e,t){let r=e.selection,s=n<0?r.$from:r.$to,i=s.depth;for(;s.node(i).isInline;){if(!i)return!1;i--}return s.node(i).isTextblock?(t&&t(e.tr.setSelection(z.create(e.doc,n<0?s.start(i):s.end(i)))),!0):!1}}const Zk=ep(-1),e0=ep(1);function t0(n,e=null){return function(t,r){let{$from:s,$to:i}=t.selection,o=s.blockRange(i),a=o&&kc(o,n,e);return a?(r&&r(t.tr.wrap(o,a).scrollIntoView()),!0):!1}}function uu(n,e=null){return function(t,r){let s=!1;for(let i=0;i<t.selection.ranges.length&&!s;i++){let{$from:{pos:o},$to:{pos:a}}=t.selection.ranges[i];t.doc.nodesBetween(o,a,(l,c)=>{if(s)return!1;if(!(!l.isTextblock||l.hasMarkup(n,e)))if(l.type==n)s=!0;else{let d=t.doc.resolve(c),h=d.index();s=d.parent.canReplaceWith(h,h+1,n)}})}if(!s)return!1;if(r){let i=t.tr;for(let o=0;o<t.selection.ranges.length;o++){let{$from:{pos:a},$to:{pos:l}}=t.selection.ranges[o];i.setBlockType(a,l,n,e)}r(i.scrollIntoView())}return!0}}function Cc(...n){return function(e,t,r){for(let s=0;s<n.length;s++)if(n[s](e,t,r))return!0;return!1}}Cc(_c,Vf,Wf);Cc(_c,Gf,Jf);Cc(Yf,Xf,Qf,Yk);typeof navigator<"u"?/Mac|iP(hone|[oa]d)/.test(navigator.platform):typeof os<"u"&&os.platform&&os.platform()=="darwin";function n0(n,e=null){return function(t,r){let{$from:s,$to:i}=t.selection,o=s.blockRange(i);if(!o)return!1;let a=r?t.tr:null;return r0(a,o,n,e)?(r&&r(a.scrollIntoView()),!0):!1}}function r0(n,e,t,r=null){let s=!1,i=e,o=e.$from.doc;if(e.depth>=2&&e.$from.node(e.depth-1).type.compatibleContent(t)&&e.startIndex==0){if(e.$from.index(e.depth-1)==0)return!1;let l=o.resolve(e.start-2);i=new Hi(l,l,e.depth),e.endIndex<e.parent.childCount&&(e=new Hi(e.$from,o.resolve(e.$to.end(e.depth)),e.depth)),s=!0}let a=kc(i,t,r,e);return a?(n&&s0(n,e,a,s,t),!0):!1}function s0(n,e,t,r,s){let i=T.empty;for(let d=t.length-1;d>=0;d--)i=T.from(t[d].type.create(t[d].attrs,i));n.step(new Ee(e.start-(r?2:0),e.end,e.start,e.end,new O(i,0,0),t.length,!0));let o=0;for(let d=0;d<t.length;d++)t[d].type==s&&(o=d+1);let a=t.length-o,l=e.start+t.length-(r?2:0),c=e.parent;for(let d=e.startIndex,h=e.endIndex,f=!0;d<h;d++,f=!1)!f&&Lt(n.doc,l,a)&&(n.split(l,a),l+=2*a),l+=c.child(d).nodeSize;return n}function i0(n){return function(e,t){let{$from:r,$to:s}=e.selection,i=r.blockRange(s,o=>o.childCount>0&&o.firstChild.type==n);return i?t?r.node(i.depth-1).type==n?o0(e,t,n,i):a0(e,t,i):!0:!1}}function o0(n,e,t,r){let s=n.tr,i=r.end,o=r.$to.end(r.depth);i<o&&(s.step(new Ee(i-1,o,i,o,new O(T.from(t.create(null,r.parent.copy())),1,0),1,!0)),r=new Hi(s.doc.resolve(r.$from.pos),s.doc.resolve(o),r.depth));const a=jr(r);if(a==null)return!1;s.lift(r,a);let l=s.doc.resolve(s.mapping.map(i,-1)-1);return bn(s.doc,l.pos)&&l.nodeBefore.type==l.nodeAfter.type&&s.join(l.pos),e(s.scrollIntoView()),!0}function a0(n,e,t){let r=n.tr,s=t.parent;for(let p=t.end,m=t.endIndex-1,g=t.startIndex;m>g;m--)p-=s.child(m).nodeSize,r.delete(p-1,p+1);let i=r.doc.resolve(t.start),o=i.nodeAfter;if(r.mapping.map(t.end)!=t.start+i.nodeAfter.nodeSize)return!1;let a=t.startIndex==0,l=t.endIndex==s.childCount,c=i.node(-1),d=i.index(-1);if(!c.canReplace(d+(a?0:1),d+1,o.content.append(l?T.empty:T.from(s))))return!1;let h=i.pos,f=h+o.nodeSize;return r.step(new Ee(h-(a?1:0),f+(l?1:0),h+1,f-1,new O((a?T.empty:T.from(s.copy(T.empty))).append(l?T.empty:T.from(s.copy(T.empty))),a?0:1,l?0:1),a?0:1)),e(r.scrollIntoView()),!0}function l0(n){return function(e,t){let{$from:r,$to:s}=e.selection,i=r.blockRange(s,c=>c.childCount>0&&c.firstChild.type==n);if(!i)return!1;let o=i.startIndex;if(o==0)return!1;let a=i.parent,l=a.child(o-1);if(l.type!=n)return!1;if(t){let c=l.lastChild&&l.lastChild.type==a.type,d=T.from(c?n.create():null),h=new O(T.from(n.create(null,T.from(a.type.create(null,d)))),c?3:1,0),f=i.start,p=i.end;t(e.tr.step(new Ee(f-(c?3:1),p,f,p,h,1,!0)).scrollIntoView())}return!0}}const Oe=function(n){for(var e=0;;e++)if(n=n.previousSibling,!n)return e},Ir=function(n){let e=n.assignedSlot||n.parentNode;return e&&e.nodeType==11?e.host:e};let Nl=null;const Pt=function(n,e,t){let r=Nl||(Nl=document.createRange());return r.setEnd(n,t??n.nodeValue.length),r.setStart(n,e||0),r},c0=function(){Nl=null},Gn=function(n,e,t,r){return t&&(hu(n,e,t,r,-1)||hu(n,e,t,r,1))},d0=/^(img|br|input|textarea|hr)$/i;function hu(n,e,t,r,s){for(var i;;){if(n==t&&e==r)return!0;if(e==(s<0?0:nt(n))){let o=n.parentNode;if(!o||o.nodeType!=1||Us(n)||d0.test(n.nodeName)||n.contentEditable=="false")return!1;e=Oe(n)+(s<0?0:1),n=o}else if(n.nodeType==1){let o=n.childNodes[e+(s<0?-1:0)];if(o.nodeType==1&&o.contentEditable=="false")if(!((i=o.pmViewDesc)===null||i===void 0)&&i.ignoreForSelection)e+=s;else return!1;else n=o,e=s<0?nt(n):0}else return!1}}function nt(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function u0(n,e){for(;;){if(n.nodeType==3&&e)return n;if(n.nodeType==1&&e>0){if(n.contentEditable=="false")return null;n=n.childNodes[e-1],e=nt(n)}else if(n.parentNode&&!Us(n))e=Oe(n),n=n.parentNode;else return null}}function h0(n,e){for(;;){if(n.nodeType==3&&e<n.nodeValue.length)return n;if(n.nodeType==1&&e<n.childNodes.length){if(n.contentEditable=="false")return null;n=n.childNodes[e],e=0}else if(n.parentNode&&!Us(n))e=Oe(n)+1,n=n.parentNode;else return null}}function f0(n,e,t){for(let r=e==0,s=e==nt(n);r||s;){if(n==t)return!0;let i=Oe(n);if(n=n.parentNode,!n)return!1;r=r&&i==0,s=s&&i==nt(n)}}function Us(n){let e;for(let t=n;t&&!(e=t.pmViewDesc);t=t.parentNode);return e&&e.node&&e.node.isBlock&&(e.dom==n||e.contentDOM==n)}const Yo=function(n){return n.focusNode&&Gn(n.focusNode,n.focusOffset,n.anchorNode,n.anchorOffset)};function On(n,e){let t=document.createEvent("Event");return t.initEvent("keydown",!0,!0),t.keyCode=n,t.key=t.code=e,t}function p0(n){let e=n.activeElement;for(;e&&e.shadowRoot;)e=e.shadowRoot.activeElement;return e}function m0(n,e,t){if(n.caretPositionFromPoint)try{let r=n.caretPositionFromPoint(e,t);if(r)return{node:r.offsetNode,offset:Math.min(nt(r.offsetNode),r.offset)}}catch{}if(n.caretRangeFromPoint){let r=n.caretRangeFromPoint(e,t);if(r)return{node:r.startContainer,offset:Math.min(nt(r.startContainer),r.startOffset)}}}const _t=typeof navigator<"u"?navigator:null,fu=typeof document<"u"?document:null,vn=_t&&_t.userAgent||"",$l=/Edge\/(\d+)/.exec(vn),tp=/MSIE \d/.exec(vn),Rl=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(vn),ze=!!(tp||Rl||$l),dn=tp?document.documentMode:Rl?+Rl[1]:$l?+$l[1]:0,rt=!ze&&/gecko\/(\d+)/i.test(vn);rt&&+(/Firefox\/(\d+)/.exec(vn)||[0,0])[1];const Pl=!ze&&/Chrome\/(\d+)/.exec(vn),Te=!!Pl,np=Pl?+Pl[1]:0,De=!ze&&!!_t&&/Apple Computer/.test(_t.vendor),Or=De&&(/Mobile\/\w+/.test(vn)||!!_t&&_t.maxTouchPoints>2),et=Or||(_t?/Mac/.test(_t.platform):!1),rp=_t?/Win/.test(_t.platform):!1,Dt=/Android \d/.test(vn),zs=!!fu&&"webkitFontSmoothing"in fu.documentElement.style,g0=zs?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0;function y0(n){let e=n.defaultView&&n.defaultView.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:n.documentElement.clientWidth,top:0,bottom:n.documentElement.clientHeight}}function It(n,e){return typeof n=="number"?n:n[e]}function w0(n){let e=n.getBoundingClientRect(),t=e.width/n.offsetWidth||1,r=e.height/n.offsetHeight||1;return{left:e.left,right:e.left+n.clientWidth*t,top:e.top,bottom:e.top+n.clientHeight*r}}function pu(n,e,t){let r=n.someProp("scrollThreshold")||0,s=n.someProp("scrollMargin")||5,i=n.dom.ownerDocument;for(let o=t||n.dom;o;){if(o.nodeType!=1){o=Ir(o);continue}let a=o,l=a==i.body,c=l?y0(i):w0(a),d=0,h=0;if(e.top<c.top+It(r,"top")?h=-(c.top-e.top+It(s,"top")):e.bottom>c.bottom-It(r,"bottom")&&(h=e.bottom-e.top>c.bottom-c.top?e.top+It(s,"top")-c.top:e.bottom-c.bottom+It(s,"bottom")),e.left<c.left+It(r,"left")?d=-(c.left-e.left+It(s,"left")):e.right>c.right-It(r,"right")&&(d=e.right-c.right+It(s,"right")),d||h)if(l)i.defaultView.scrollBy(d,h);else{let p=a.scrollLeft,m=a.scrollTop;h&&(a.scrollTop+=h),d&&(a.scrollLeft+=d);let g=a.scrollLeft-p,y=a.scrollTop-m;e={left:e.left-g,top:e.top-y,right:e.right-g,bottom:e.bottom-y}}let f=l?"fixed":getComputedStyle(o).position;if(/^(fixed|sticky)$/.test(f))break;o=f=="absolute"?o.offsetParent:Ir(o)}}function b0(n){let e=n.dom.getBoundingClientRect(),t=Math.max(0,e.top),r,s;for(let i=(e.left+e.right)/2,o=t+1;o<Math.min(innerHeight,e.bottom);o+=5){let a=n.root.elementFromPoint(i,o);if(!a||a==n.dom||!n.dom.contains(a))continue;let l=a.getBoundingClientRect();if(l.top>=t-20){r=a,s=l.top;break}}return{refDOM:r,refTop:s,stack:sp(n.dom)}}function sp(n){let e=[],t=n.ownerDocument;for(let r=n;r&&(e.push({dom:r,top:r.scrollTop,left:r.scrollLeft}),n!=t);r=Ir(r));return e}function v0({refDOM:n,refTop:e,stack:t}){let r=n?n.getBoundingClientRect().top:0;ip(t,r==0?0:r-e)}function ip(n,e){for(let t=0;t<n.length;t++){let{dom:r,top:s,left:i}=n[t];r.scrollTop!=s+e&&(r.scrollTop=s+e),r.scrollLeft!=i&&(r.scrollLeft=i)}}let lr=null;function k0(n){if(n.setActive)return n.setActive();if(lr)return n.focus(lr);let e=sp(n);n.focus(lr==null?{get preventScroll(){return lr={preventScroll:!0},!0}}:void 0),lr||(lr=!1,ip(e,0))}function op(n,e){let t,r=2e8,s,i=0,o=e.top,a=e.top,l,c;for(let d=n.firstChild,h=0;d;d=d.nextSibling,h++){let f;if(d.nodeType==1)f=d.getClientRects();else if(d.nodeType==3)f=Pt(d).getClientRects();else continue;for(let p=0;p<f.length;p++){let m=f[p];if(m.top<=o&&m.bottom>=a){o=Math.max(m.bottom,o),a=Math.min(m.top,a);let g=m.left>e.left?m.left-e.left:m.right<e.left?e.left-m.right:0;if(g<r){t=d,r=g,s=g&&t.nodeType==3?{left:m.right<e.left?m.right:m.left,top:e.top}:e,d.nodeType==1&&g&&(i=h+(e.left>=(m.left+m.right)/2?1:0));continue}}else m.top>e.top&&!l&&m.left<=e.left&&m.right>=e.left&&(l=d,c={left:Math.max(m.left,Math.min(m.right,e.left)),top:m.top});!t&&(e.left>=m.right&&e.top>=m.top||e.left>=m.left&&e.top>=m.bottom)&&(i=h+1)}}return!t&&l&&(t=l,s=c,r=0),t&&t.nodeType==3?S0(t,s):!t||r&&t.nodeType==1?{node:n,offset:i}:op(t,s)}function S0(n,e){let t=n.nodeValue.length,r=document.createRange(),s;for(let i=0;i<t;i++){r.setEnd(n,i+1),r.setStart(n,i);let o=Gt(r,1);if(o.top!=o.bottom&&Ac(e,o)){s={node:n,offset:i+(e.left>=(o.left+o.right)/2?1:0)};break}}return r.detach(),s||{node:n,offset:0}}function Ac(n,e){return n.left>=e.left-1&&n.left<=e.right+1&&n.top>=e.top-1&&n.top<=e.bottom+1}function _0(n,e){let t=n.parentNode;return t&&/^li$/i.test(t.nodeName)&&e.left<n.getBoundingClientRect().left?t:n}function x0(n,e,t){let{node:r,offset:s}=op(e,t),i=-1;if(r.nodeType==1&&!r.firstChild){let o=r.getBoundingClientRect();i=o.left!=o.right&&t.left>(o.left+o.right)/2?1:-1}return n.docView.posFromDOM(r,s,i)}function T0(n,e,t,r){let s=-1;for(let i=e,o=!1;i!=n.dom;){let a=n.docView.nearestDesc(i,!0),l;if(!a)return null;if(a.dom.nodeType==1&&(a.node.isBlock&&a.parent||!a.contentDOM)&&((l=a.dom.getBoundingClientRect()).width||l.height)&&(a.node.isBlock&&a.parent&&!/^T(R|BODY|HEAD|FOOT)$/.test(a.dom.nodeName)&&(!o&&l.left>r.left||l.top>r.top?s=a.posBefore:(!o&&l.right<r.left||l.bottom<r.top)&&(s=a.posAfter),o=!0),!a.contentDOM&&s<0&&!a.node.isText))return(a.node.isBlock?r.top<(l.top+l.bottom)/2:r.left<(l.left+l.right)/2)?a.posBefore:a.posAfter;i=a.dom.parentNode}return s>-1?s:n.docView.posFromDOM(e,t,-1)}function ap(n,e,t){let r=n.childNodes.length;if(r&&t.top<t.bottom)for(let s=Math.max(0,Math.min(r-1,Math.floor(r*(e.top-t.top)/(t.bottom-t.top))-2)),i=s;;){let o=n.childNodes[i];if(o.nodeType==1){let a=o.getClientRects();for(let l=0;l<a.length;l++){let c=a[l];if(Ac(e,c))return ap(o,e,c)}}if((i=(i+1)%r)==s)break}return n}function E0(n,e){let t=n.dom.ownerDocument,r,s=0,i=m0(t,e.left,e.top);i&&({node:r,offset:s}=i);let o=(n.root.elementFromPoint?n.root:t).elementFromPoint(e.left,e.top),a;if(!o||!n.dom.contains(o.nodeType!=1?o.parentNode:o)){let c=n.dom.getBoundingClientRect();if(!Ac(e,c)||(o=ap(n.dom,e,c),!o))return null}if(De)for(let c=o;r&&c;c=Ir(c))c.draggable&&(r=void 0);if(o=_0(o,e),r){if(rt&&r.nodeType==1&&(s=Math.min(s,r.childNodes.length),s<r.childNodes.length)){let d=r.childNodes[s],h;d.nodeName=="IMG"&&(h=d.getBoundingClientRect()).right<=e.left&&h.bottom>e.top&&s++}let c;zs&&s&&r.nodeType==1&&(c=r.childNodes[s-1]).nodeType==1&&c.contentEditable=="false"&&c.getBoundingClientRect().top>=e.top&&s--,r==n.dom&&s==r.childNodes.length-1&&r.lastChild.nodeType==1&&e.top>r.lastChild.getBoundingClientRect().bottom?a=n.state.doc.content.size:(s==0||r.nodeType!=1||r.childNodes[s-1].nodeName!="BR")&&(a=T0(n,r,s,e))}a==null&&(a=x0(n,o,e));let l=n.docView.nearestDesc(o,!0);return{pos:a,inside:l?l.posAtStart-l.border:-1}}function mu(n){return n.top<n.bottom||n.left<n.right}function Gt(n,e){let t=n.getClientRects();if(t.length){let r=t[e<0?0:t.length-1];if(mu(r))return r}return Array.prototype.find.call(t,mu)||n.getBoundingClientRect()}const C0=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function lp(n,e,t){let{node:r,offset:s,atom:i}=n.docView.domFromPos(e,t<0?-1:1),o=zs||rt;if(r.nodeType==3)if(o&&(C0.test(r.nodeValue)||(t<0?!s:s==r.nodeValue.length))){let l=Gt(Pt(r,s,s),t);if(rt&&s&&/\s/.test(r.nodeValue[s-1])&&s<r.nodeValue.length){let c=Gt(Pt(r,s-1,s-1),-1);if(c.top==l.top){let d=Gt(Pt(r,s,s+1),-1);if(d.top!=l.top)return Kr(d,d.left<c.left)}}return l}else{let l=s,c=s,d=t<0?1:-1;return t<0&&!s?(c++,d=-1):t>=0&&s==r.nodeValue.length?(l--,d=1):t<0?l--:c++,Kr(Gt(Pt(r,l,c),d),d<0)}if(!n.state.doc.resolve(e-(i||0)).parent.inlineContent){if(i==null&&s&&(t<0||s==nt(r))){let l=r.childNodes[s-1];if(l.nodeType==1)return Ua(l.getBoundingClientRect(),!1)}if(i==null&&s<nt(r)){let l=r.childNodes[s];if(l.nodeType==1)return Ua(l.getBoundingClientRect(),!0)}return Ua(r.getBoundingClientRect(),t>=0)}if(i==null&&s&&(t<0||s==nt(r))){let l=r.childNodes[s-1],c=l.nodeType==3?Pt(l,nt(l)-(o?0:1)):l.nodeType==1&&(l.nodeName!="BR"||!l.nextSibling)?l:null;if(c)return Kr(Gt(c,1),!1)}if(i==null&&s<nt(r)){let l=r.childNodes[s];for(;l.pmViewDesc&&l.pmViewDesc.ignoreForCoords;)l=l.nextSibling;let c=l?l.nodeType==3?Pt(l,0,o?0:1):l.nodeType==1?l:null:null;if(c)return Kr(Gt(c,-1),!0)}return Kr(Gt(r.nodeType==3?Pt(r):r,-t),t>=0)}function Kr(n,e){if(n.width==0)return n;let t=e?n.left:n.right;return{top:n.top,bottom:n.bottom,left:t,right:t}}function Ua(n,e){if(n.height==0)return n;let t=e?n.top:n.bottom;return{top:t,bottom:t,left:n.left,right:n.right}}function cp(n,e,t){let r=n.state,s=n.root.activeElement;r!=e&&n.updateState(e),s!=n.dom&&n.focus();try{return t()}finally{r!=e&&n.updateState(r),s!=n.dom&&s&&s.focus()}}function A0(n,e,t){let r=e.selection,s=t=="up"?r.$from:r.$to;return cp(n,e,()=>{let{node:i}=n.docView.domFromPos(s.pos,t=="up"?-1:1);for(;;){let a=n.docView.nearestDesc(i,!0);if(!a)break;if(a.node.isBlock){i=a.contentDOM||a.dom;break}i=a.dom.parentNode}let o=lp(n,s.pos,1);for(let a=i.firstChild;a;a=a.nextSibling){let l;if(a.nodeType==1)l=a.getClientRects();else if(a.nodeType==3)l=Pt(a,0,a.nodeValue.length).getClientRects();else continue;for(let c=0;c<l.length;c++){let d=l[c];if(d.bottom>d.top+1&&(t=="up"?o.top-d.top>(d.bottom-o.top)*2:d.bottom-o.bottom>(o.bottom-d.top)*2))return!1}}return!0})}const M0=/[\u0590-\u08ac]/;function I0(n,e,t){let{$head:r}=e.selection;if(!r.parent.isTextblock)return!1;let s=r.parentOffset,i=!s,o=s==r.parent.content.size,a=n.domSelection();return a?!M0.test(r.parent.textContent)||!a.modify?t=="left"||t=="backward"?i:o:cp(n,e,()=>{let{focusNode:l,focusOffset:c,anchorNode:d,anchorOffset:h}=n.domSelectionRange(),f=a.caretBidiLevel;a.modify("move",t,"character");let p=r.depth?n.docView.domAfterPos(r.before()):n.dom,{focusNode:m,focusOffset:g}=n.domSelectionRange(),y=m&&!p.contains(m.nodeType==1?m:m.parentNode)||l==m&&c==g;try{a.collapse(d,h),l&&(l!=d||c!=h)&&a.extend&&a.extend(l,c)}catch{}return f!=null&&(a.caretBidiLevel=f),y}):r.pos==r.start()||r.pos==r.end()}let gu=null,yu=null,wu=!1;function O0(n,e,t){return gu==e&&yu==t?wu:(gu=e,yu=t,wu=t=="up"||t=="down"?A0(n,e,t):I0(n,e,t))}const st=0,bu=1,$n=2,xt=3;class Hs{constructor(e,t,r,s){this.parent=e,this.children=t,this.dom=r,this.contentDOM=s,this.dirty=st,r.pmViewDesc=this}matchesWidget(e){return!1}matchesMark(e){return!1}matchesNode(e,t,r){return!1}matchesHack(e){return!1}parseRule(){return null}stopEvent(e){return!1}get size(){let e=0;for(let t=0;t<this.children.length;t++)e+=this.children[t].size;return e}get border(){return 0}destroy(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(let e=0;e<this.children.length;e++)this.children[e].destroy()}posBeforeChild(e){for(let t=0,r=this.posAtStart;;t++){let s=this.children[t];if(s==e)return r;r+=s.size}}get posBefore(){return this.parent.posBeforeChild(this)}get posAtStart(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}get posAfter(){return this.posBefore+this.size}get posAtEnd(){return this.posAtStart+this.size-2*this.border}localPosFromDOM(e,t,r){if(this.contentDOM&&this.contentDOM.contains(e.nodeType==1?e:e.parentNode))if(r<0){let i,o;if(e==this.contentDOM)i=e.childNodes[t-1];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;i=e.previousSibling}for(;i&&!((o=i.pmViewDesc)&&o.parent==this);)i=i.previousSibling;return i?this.posBeforeChild(o)+o.size:this.posAtStart}else{let i,o;if(e==this.contentDOM)i=e.childNodes[t];else{for(;e.parentNode!=this.contentDOM;)e=e.parentNode;i=e.nextSibling}for(;i&&!((o=i.pmViewDesc)&&o.parent==this);)i=i.nextSibling;return i?this.posBeforeChild(o):this.posAtEnd}let s;if(e==this.dom&&this.contentDOM)s=t>Oe(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))s=e.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(t==0)for(let i=e;;i=i.parentNode){if(i==this.dom){s=!1;break}if(i.previousSibling)break}if(s==null&&t==e.childNodes.length)for(let i=e;;i=i.parentNode){if(i==this.dom){s=!0;break}if(i.nextSibling)break}}return s??r>0?this.posAtEnd:this.posAtStart}nearestDesc(e,t=!1){for(let r=!0,s=e;s;s=s.parentNode){let i=this.getDesc(s),o;if(i&&(!t||i.node))if(r&&(o=i.nodeDOM)&&!(o.nodeType==1?o.contains(e.nodeType==1?e:e.parentNode):o==e))r=!1;else return i}}getDesc(e){let t=e.pmViewDesc;for(let r=t;r;r=r.parent)if(r==this)return t}posFromDOM(e,t,r){for(let s=e;s;s=s.parentNode){let i=this.getDesc(s);if(i)return i.localPosFromDOM(e,t,r)}return-1}descAt(e){for(let t=0,r=0;t<this.children.length;t++){let s=this.children[t],i=r+s.size;if(r==e&&i!=r){for(;!s.border&&s.children.length;)for(let o=0;o<s.children.length;o++){let a=s.children[o];if(a.size){s=a;break}}return s}if(e<i)return s.descAt(e-r-s.border);r=i}}domFromPos(e,t){if(!this.contentDOM)return{node:this.dom,offset:0,atom:e+1};let r=0,s=0;for(let i=0;r<this.children.length;r++){let o=this.children[r],a=i+o.size;if(a>e||o instanceof up){s=e-i;break}i=a}if(s)return this.children[r].domFromPos(s-this.children[r].border,t);for(let i;r&&!(i=this.children[r-1]).size&&i instanceof dp&&i.side>=0;r--);if(t<=0){let i,o=!0;for(;i=r?this.children[r-1]:null,!(!i||i.dom.parentNode==this.contentDOM);r--,o=!1);return i&&t&&o&&!i.border&&!i.domAtom?i.domFromPos(i.size,t):{node:this.contentDOM,offset:i?Oe(i.dom)+1:0}}else{let i,o=!0;for(;i=r<this.children.length?this.children[r]:null,!(!i||i.dom.parentNode==this.contentDOM);r++,o=!1);return i&&o&&!i.border&&!i.domAtom?i.domFromPos(0,t):{node:this.contentDOM,offset:i?Oe(i.dom):this.contentDOM.childNodes.length}}}parseRange(e,t,r=0){if(this.children.length==0)return{node:this.contentDOM,from:e,to:t,fromOffset:0,toOffset:this.contentDOM.childNodes.length};let s=-1,i=-1;for(let o=r,a=0;;a++){let l=this.children[a],c=o+l.size;if(s==-1&&e<=c){let d=o+l.border;if(e>=d&&t<=c-l.border&&l.node&&l.contentDOM&&this.contentDOM.contains(l.contentDOM))return l.parseRange(e,t,d);e=o;for(let h=a;h>0;h--){let f=this.children[h-1];if(f.size&&f.dom.parentNode==this.contentDOM&&!f.emptyChildAt(1)){s=Oe(f.dom)+1;break}e-=f.size}s==-1&&(s=0)}if(s>-1&&(c>t||a==this.children.length-1)){t=c;for(let d=a+1;d<this.children.length;d++){let h=this.children[d];if(h.size&&h.dom.parentNode==this.contentDOM&&!h.emptyChildAt(-1)){i=Oe(h.dom);break}t+=h.size}i==-1&&(i=this.contentDOM.childNodes.length);break}o=c}return{node:this.contentDOM,from:e,to:t,fromOffset:s,toOffset:i}}emptyChildAt(e){if(this.border||!this.contentDOM||!this.children.length)return!1;let t=this.children[e<0?0:this.children.length-1];return t.size==0||t.emptyChildAt(e)}domAfterPos(e){let{node:t,offset:r}=this.domFromPos(e,0);if(t.nodeType!=1||r==t.childNodes.length)throw new RangeError("No node after pos "+e);return t.childNodes[r]}setSelection(e,t,r,s=!1){let i=Math.min(e,t),o=Math.max(e,t);for(let p=0,m=0;p<this.children.length;p++){let g=this.children[p],y=m+g.size;if(i>m&&o<y)return g.setSelection(e-m-g.border,t-m-g.border,r,s);m=y}let a=this.domFromPos(e,e?-1:1),l=t==e?a:this.domFromPos(t,t?-1:1),c=r.root.getSelection(),d=r.domSelectionRange(),h=!1;if((rt||De)&&e==t){let{node:p,offset:m}=a;if(p.nodeType==3){if(h=!!(m&&p.nodeValue[m-1]==`
`),h&&m==p.nodeValue.length)for(let g=p,y;g;g=g.parentNode){if(y=g.nextSibling){y.nodeName=="BR"&&(a=l={node:y.parentNode,offset:Oe(y)+1});break}let w=g.pmViewDesc;if(w&&w.node&&w.node.isBlock)break}}else{let g=p.childNodes[m-1];h=g&&(g.nodeName=="BR"||g.contentEditable=="false")}}if(rt&&d.focusNode&&d.focusNode!=l.node&&d.focusNode.nodeType==1){let p=d.focusNode.childNodes[d.focusOffset];p&&p.contentEditable=="false"&&(s=!0)}if(!(s||h&&De)&&Gn(a.node,a.offset,d.anchorNode,d.anchorOffset)&&Gn(l.node,l.offset,d.focusNode,d.focusOffset))return;let f=!1;if((c.extend||e==t)&&!(h&&rt)){c.collapse(a.node,a.offset);try{e!=t&&c.extend(l.node,l.offset),f=!0}catch{}}if(!f){if(e>t){let m=a;a=l,l=m}let p=document.createRange();p.setEnd(l.node,l.offset),p.setStart(a.node,a.offset),c.removeAllRanges(),c.addRange(p)}}ignoreMutation(e){return!this.contentDOM&&e.type!="selection"}get contentLost(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}markDirty(e,t){for(let r=0,s=0;s<this.children.length;s++){let i=this.children[s],o=r+i.size;if(r==o?e<=o&&t>=r:e<o&&t>r){let a=r+i.border,l=o-i.border;if(e>=a&&t<=l){this.dirty=e==r||t==o?$n:bu,e==a&&t==l&&(i.contentLost||i.dom.parentNode!=this.contentDOM)?i.dirty=xt:i.markDirty(e-a,t-a);return}else i.dirty=i.dom==i.contentDOM&&i.dom.parentNode==this.contentDOM&&!i.children.length?$n:xt}r=o}this.dirty=$n}markParentsDirty(){let e=1;for(let t=this.parent;t;t=t.parent,e++){let r=e==1?$n:bu;t.dirty<r&&(t.dirty=r)}}get domAtom(){return!1}get ignoreForCoords(){return!1}get ignoreForSelection(){return!1}isText(e){return!1}}class dp extends Hs{constructor(e,t,r,s){let i,o=t.type.toDOM;if(typeof o=="function"&&(o=o(r,()=>{if(!i)return s;if(i.parent)return i.parent.posBeforeChild(i)})),!t.type.spec.raw){if(o.nodeType!=1){let a=document.createElement("span");a.appendChild(o),o=a}o.contentEditable="false",o.classList.add("ProseMirror-widget")}super(e,[],o,null),this.widget=t,this.widget=t,i=this}matchesWidget(e){return this.dirty==st&&e.type.eq(this.widget.type)}parseRule(){return{ignore:!0}}stopEvent(e){let t=this.widget.spec.stopEvent;return t?t(e):!1}ignoreMutation(e){return e.type!="selection"||this.widget.spec.ignoreSelection}destroy(){this.widget.type.destroy(this.dom),super.destroy()}get domAtom(){return!0}get ignoreForSelection(){return!!this.widget.type.spec.relaxedSide}get side(){return this.widget.type.side}}class N0 extends Hs{constructor(e,t,r,s){super(e,[],t,null),this.textDOM=r,this.text=s}get size(){return this.text.length}localPosFromDOM(e,t){return e!=this.textDOM?this.posAtStart+(t?this.size:0):this.posAtStart+t}domFromPos(e){return{node:this.textDOM,offset:e}}ignoreMutation(e){return e.type==="characterData"&&e.target.nodeValue==e.oldValue}}class Jn extends Hs{constructor(e,t,r,s,i){super(e,[],r,s),this.mark=t,this.spec=i}static create(e,t,r,s){let i=s.nodeViews[t.type.name],o=i&&i(t,s,r);return(!o||!o.dom)&&(o=er.renderSpec(document,t.type.spec.toDOM(t,r),null,t.attrs)),new Jn(e,t,o.dom,o.contentDOM||o.dom,o)}parseRule(){return this.dirty&xt||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM}}matchesMark(e){return this.dirty!=xt&&this.mark.eq(e)}markDirty(e,t){if(super.markDirty(e,t),this.dirty!=st){let r=this.parent;for(;!r.node;)r=r.parent;r.dirty<this.dirty&&(r.dirty=this.dirty),this.dirty=st}}slice(e,t,r){let s=Jn.create(this.parent,this.mark,!0,r),i=this.children,o=this.size;t<o&&(i=Ll(i,t,o,r)),e>0&&(i=Ll(i,0,e,r));for(let a=0;a<i.length;a++)i[a].parent=s;return s.children=i,s}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}}class un extends Hs{constructor(e,t,r,s,i,o,a,l,c){super(e,[],i,o),this.node=t,this.outerDeco=r,this.innerDeco=s,this.nodeDOM=a}static create(e,t,r,s,i,o){let a=i.nodeViews[t.type.name],l,c=a&&a(t,i,()=>{if(!l)return o;if(l.parent)return l.parent.posBeforeChild(l)},r,s),d=c&&c.dom,h=c&&c.contentDOM;if(t.isText){if(!d)d=document.createTextNode(t.text);else if(d.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else d||({dom:d,contentDOM:h}=er.renderSpec(document,t.type.spec.toDOM(t),null,t.attrs));!h&&!t.isText&&d.nodeName!="BR"&&(d.hasAttribute("contenteditable")||(d.contentEditable="false"),t.type.spec.draggable&&(d.draggable=!0));let f=d;return d=pp(d,r,t),c?l=new $0(e,t,r,s,d,h||null,f,c,i,o+1):t.isText?new Xo(e,t,r,s,d,f,i):new un(e,t,r,s,d,h||null,f,i,o+1)}parseRule(){if(this.node.type.spec.reparseInView)return null;let e={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(e.preserveWhitespace="full"),!this.contentDOM)e.getContent=()=>this.node.content;else if(!this.contentLost)e.contentElement=this.contentDOM;else{for(let t=this.children.length-1;t>=0;t--){let r=this.children[t];if(this.dom.contains(r.dom.parentNode)){e.contentElement=r.dom.parentNode;break}}e.contentElement||(e.getContent=()=>T.empty)}return e}matchesNode(e,t,r){return this.dirty==st&&e.eq(this.node)&&qi(t,this.outerDeco)&&r.eq(this.innerDeco)}get size(){return this.node.nodeSize}get border(){return this.node.isLeaf?0:1}updateChildren(e,t){let r=this.node.inlineContent,s=t,i=e.composing?this.localCompositionInfo(e,t):null,o=i&&i.pos>-1?i:null,a=i&&i.pos<0,l=new P0(this,o&&o.node,e);j0(this.node,this.innerDeco,(c,d,h)=>{c.spec.marks?l.syncToMarks(c.spec.marks,r,e):c.type.side>=0&&!h&&l.syncToMarks(d==this.node.childCount?ne.none:this.node.child(d).marks,r,e),l.placeWidget(c,e,s)},(c,d,h,f)=>{l.syncToMarks(c.marks,r,e);let p;l.findNodeMatch(c,d,h,f)||a&&e.state.selection.from>s&&e.state.selection.to<s+c.nodeSize&&(p=l.findIndexWithChild(i.node))>-1&&l.updateNodeAt(c,d,h,p,e)||l.updateNextNode(c,d,h,e,f,s)||l.addNode(c,d,h,e,s),s+=c.nodeSize}),l.syncToMarks([],r,e),this.node.isTextblock&&l.addTextblockHacks(),l.destroyRest(),(l.changed||this.dirty==$n)&&(o&&this.protectLocalComposition(e,o),hp(this.contentDOM,this.children,e),Or&&B0(this.dom))}localCompositionInfo(e,t){let{from:r,to:s}=e.state.selection;if(!(e.state.selection instanceof z)||r<t||s>t+this.node.content.size)return null;let i=e.input.compositionNode;if(!i||!this.dom.contains(i.parentNode))return null;if(this.node.inlineContent){let o=i.nodeValue,a=F0(this.node.content,o,r-t,s-t);return a<0?null:{node:i,pos:a,text:o}}else return{node:i,pos:-1,text:""}}protectLocalComposition(e,{node:t,pos:r,text:s}){if(this.getDesc(t))return;let i=t;for(;i.parentNode!=this.contentDOM;i=i.parentNode){for(;i.previousSibling;)i.parentNode.removeChild(i.previousSibling);for(;i.nextSibling;)i.parentNode.removeChild(i.nextSibling);i.pmViewDesc&&(i.pmViewDesc=void 0)}let o=new N0(this,i,t,s);e.input.compositionNodes.push(o),this.children=Ll(this.children,r,r+s.length,e,o)}update(e,t,r,s){return this.dirty==xt||!e.sameMarkup(this.node)?!1:(this.updateInner(e,t,r,s),!0)}updateInner(e,t,r,s){this.updateOuterDeco(t),this.node=e,this.innerDeco=r,this.contentDOM&&this.updateChildren(s,this.posAtStart),this.dirty=st}updateOuterDeco(e){if(qi(e,this.outerDeco))return;let t=this.nodeDOM.nodeType!=1,r=this.dom;this.dom=fp(this.dom,this.nodeDOM,Dl(this.outerDeco,this.node,t),Dl(e,this.node,t)),this.dom!=r&&(r.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=e}selectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.nodeDOM.draggable=!0))}deselectNode(){this.nodeDOM.nodeType==1&&(this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.nodeDOM.removeAttribute("draggable"))}get domAtom(){return this.node.isAtom}}function vu(n,e,t,r,s){pp(r,e,n);let i=new un(void 0,n,e,t,r,r,r,s,0);return i.contentDOM&&i.updateChildren(s,0),i}class Xo extends un{constructor(e,t,r,s,i,o,a){super(e,t,r,s,i,null,o,a,0)}parseRule(){let e=this.nodeDOM.parentNode;for(;e&&e!=this.dom&&!e.pmIsDeco;)e=e.parentNode;return{skip:e||!0}}update(e,t,r,s){return this.dirty==xt||this.dirty!=st&&!this.inParent()||!e.sameMarkup(this.node)?!1:(this.updateOuterDeco(t),(this.dirty!=st||e.text!=this.node.text)&&e.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=e.text,s.trackWrites==this.nodeDOM&&(s.trackWrites=null)),this.node=e,this.dirty=st,!0)}inParent(){let e=this.parent.contentDOM;for(let t=this.nodeDOM;t;t=t.parentNode)if(t==e)return!0;return!1}domFromPos(e){return{node:this.nodeDOM,offset:e}}localPosFromDOM(e,t,r){return e==this.nodeDOM?this.posAtStart+Math.min(t,this.node.text.length):super.localPosFromDOM(e,t,r)}ignoreMutation(e){return e.type!="characterData"&&e.type!="selection"}slice(e,t,r){let s=this.node.cut(e,t),i=document.createTextNode(s.text);return new Xo(this.parent,s,this.outerDeco,this.innerDeco,i,i,r)}markDirty(e,t){super.markDirty(e,t),this.dom!=this.nodeDOM&&(e==0||t==this.nodeDOM.nodeValue.length)&&(this.dirty=xt)}get domAtom(){return!1}isText(e){return this.node.text==e}}class up extends Hs{parseRule(){return{ignore:!0}}matchesHack(e){return this.dirty==st&&this.dom.nodeName==e}get domAtom(){return!0}get ignoreForCoords(){return this.dom.nodeName=="IMG"}}class $0 extends un{constructor(e,t,r,s,i,o,a,l,c,d){super(e,t,r,s,i,o,a,c,d),this.spec=l}update(e,t,r,s){if(this.dirty==xt)return!1;if(this.spec.update&&(this.node.type==e.type||this.spec.multiType)){let i=this.spec.update(e,t,r);return i&&this.updateInner(e,t,r,s),i}else return!this.contentDOM&&!e.isLeaf?!1:super.update(e,t,r,s)}selectNode(){this.spec.selectNode?this.spec.selectNode():super.selectNode()}deselectNode(){this.spec.deselectNode?this.spec.deselectNode():super.deselectNode()}setSelection(e,t,r,s){this.spec.setSelection?this.spec.setSelection(e,t,r.root):super.setSelection(e,t,r,s)}destroy(){this.spec.destroy&&this.spec.destroy(),super.destroy()}stopEvent(e){return this.spec.stopEvent?this.spec.stopEvent(e):!1}ignoreMutation(e){return this.spec.ignoreMutation?this.spec.ignoreMutation(e):super.ignoreMutation(e)}}function hp(n,e,t){let r=n.firstChild,s=!1;for(let i=0;i<e.length;i++){let o=e[i],a=o.dom;if(a.parentNode==n){for(;a!=r;)r=ku(r),s=!0;r=r.nextSibling}else s=!0,n.insertBefore(a,r);if(o instanceof Jn){let l=r?r.previousSibling:n.lastChild;hp(o.contentDOM,o.children,t),r=l?l.nextSibling:n.firstChild}}for(;r;)r=ku(r),s=!0;s&&t.trackWrites==n&&(t.trackWrites=null)}const ss=function(n){n&&(this.nodeName=n)};ss.prototype=Object.create(null);const Rn=[new ss];function Dl(n,e,t){if(n.length==0)return Rn;let r=t?Rn[0]:new ss,s=[r];for(let i=0;i<n.length;i++){let o=n[i].type.attrs;if(o){o.nodeName&&s.push(r=new ss(o.nodeName));for(let a in o){let l=o[a];l!=null&&(t&&s.length==1&&s.push(r=new ss(e.isInline?"span":"div")),a=="class"?r.class=(r.class?r.class+" ":"")+l:a=="style"?r.style=(r.style?r.style+";":"")+l:a!="nodeName"&&(r[a]=l))}}}return s}function fp(n,e,t,r){if(t==Rn&&r==Rn)return e;let s=e;for(let i=0;i<r.length;i++){let o=r[i],a=t[i];if(i){let l;a&&a.nodeName==o.nodeName&&s!=n&&(l=s.parentNode)&&l.nodeName.toLowerCase()==o.nodeName||(l=document.createElement(o.nodeName),l.pmIsDeco=!0,l.appendChild(s),a=Rn[0]),s=l}R0(s,a||Rn[0],o)}return s}function R0(n,e,t){for(let r in e)r!="class"&&r!="style"&&r!="nodeName"&&!(r in t)&&n.removeAttribute(r);for(let r in t)r!="class"&&r!="style"&&r!="nodeName"&&t[r]!=e[r]&&n.setAttribute(r,t[r]);if(e.class!=t.class){let r=e.class?e.class.split(" ").filter(Boolean):[],s=t.class?t.class.split(" ").filter(Boolean):[];for(let i=0;i<r.length;i++)s.indexOf(r[i])==-1&&n.classList.remove(r[i]);for(let i=0;i<s.length;i++)r.indexOf(s[i])==-1&&n.classList.add(s[i]);n.classList.length==0&&n.removeAttribute("class")}if(e.style!=t.style){if(e.style){let r=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,s;for(;s=r.exec(e.style);)n.style.removeProperty(s[1])}t.style&&(n.style.cssText+=t.style)}}function pp(n,e,t){return fp(n,n,Rn,Dl(e,t,n.nodeType!=1))}function qi(n,e){if(n.length!=e.length)return!1;for(let t=0;t<n.length;t++)if(!n[t].type.eq(e[t].type))return!1;return!0}function ku(n){let e=n.nextSibling;return n.parentNode.removeChild(n),e}class P0{constructor(e,t,r){this.lock=t,this.view=r,this.index=0,this.stack=[],this.changed=!1,this.top=e,this.preMatch=D0(e.node.content,e)}destroyBetween(e,t){if(e!=t){for(let r=e;r<t;r++)this.top.children[r].destroy();this.top.children.splice(e,t-e),this.changed=!0}}destroyRest(){this.destroyBetween(this.index,this.top.children.length)}syncToMarks(e,t,r){let s=0,i=this.stack.length>>1,o=Math.min(i,e.length);for(;s<o&&(s==i-1?this.top:this.stack[s+1<<1]).matchesMark(e[s])&&e[s].type.spec.spanning!==!1;)s++;for(;s<i;)this.destroyRest(),this.top.dirty=st,this.index=this.stack.pop(),this.top=this.stack.pop(),i--;for(;i<e.length;){this.stack.push(this.top,this.index+1);let a=-1;for(let l=this.index;l<Math.min(this.index+3,this.top.children.length);l++){let c=this.top.children[l];if(c.matchesMark(e[i])&&!this.isLocked(c.dom)){a=l;break}}if(a>-1)a>this.index&&(this.changed=!0,this.destroyBetween(this.index,a)),this.top=this.top.children[this.index];else{let l=Jn.create(this.top,e[i],t,r);this.top.children.splice(this.index,0,l),this.top=l,this.changed=!0}this.index=0,i++}}findNodeMatch(e,t,r,s){let i=-1,o;if(s>=this.preMatch.index&&(o=this.preMatch.matches[s-this.preMatch.index]).parent==this.top&&o.matchesNode(e,t,r))i=this.top.children.indexOf(o,this.index);else for(let a=this.index,l=Math.min(this.top.children.length,a+5);a<l;a++){let c=this.top.children[a];if(c.matchesNode(e,t,r)&&!this.preMatch.matched.has(c)){i=a;break}}return i<0?!1:(this.destroyBetween(this.index,i),this.index++,!0)}updateNodeAt(e,t,r,s,i){let o=this.top.children[s];return o.dirty==xt&&o.dom==o.contentDOM&&(o.dirty=$n),o.update(e,t,r,i)?(this.destroyBetween(this.index,s),this.index++,!0):!1}findIndexWithChild(e){for(;;){let t=e.parentNode;if(!t)return-1;if(t==this.top.contentDOM){let r=e.pmViewDesc;if(r){for(let s=this.index;s<this.top.children.length;s++)if(this.top.children[s]==r)return s}return-1}e=t}}updateNextNode(e,t,r,s,i,o){for(let a=this.index;a<this.top.children.length;a++){let l=this.top.children[a];if(l instanceof un){let c=this.preMatch.matched.get(l);if(c!=null&&c!=i)return!1;let d=l.dom,h,f=this.isLocked(d)&&!(e.isText&&l.node&&l.node.isText&&l.nodeDOM.nodeValue==e.text&&l.dirty!=xt&&qi(t,l.outerDeco));if(!f&&l.update(e,t,r,s))return this.destroyBetween(this.index,a),l.dom!=d&&(this.changed=!0),this.index++,!0;if(!f&&(h=this.recreateWrapper(l,e,t,r,s,o)))return this.destroyBetween(this.index,a),this.top.children[this.index]=h,h.contentDOM&&(h.dirty=$n,h.updateChildren(s,o+1),h.dirty=st),this.changed=!0,this.index++,!0;break}}return!1}recreateWrapper(e,t,r,s,i,o){if(e.dirty||t.isAtom||!e.children.length||!e.node.content.eq(t.content)||!qi(r,e.outerDeco)||!s.eq(e.innerDeco))return null;let a=un.create(this.top,t,r,s,i,o);if(a.contentDOM){a.children=e.children,e.children=[];for(let l of a.children)l.parent=a}return e.destroy(),a}addNode(e,t,r,s,i){let o=un.create(this.top,e,t,r,s,i);o.contentDOM&&o.updateChildren(s,i+1),this.top.children.splice(this.index++,0,o),this.changed=!0}placeWidget(e,t,r){let s=this.index<this.top.children.length?this.top.children[this.index]:null;if(s&&s.matchesWidget(e)&&(e==s.widget||!s.widget.type.toDOM.parentNode))this.index++;else{let i=new dp(this.top,e,t,r);this.top.children.splice(this.index++,0,i),this.changed=!0}}addTextblockHacks(){let e=this.top.children[this.index-1],t=this.top;for(;e instanceof Jn;)t=e,e=t.children[t.children.length-1];(!e||!(e instanceof Xo)||/\n$/.test(e.node.text)||this.view.requiresGeckoHackNode&&/\s$/.test(e.node.text))&&((De||Te)&&e&&e.dom.contentEditable=="false"&&this.addHackNode("IMG",t),this.addHackNode("BR",this.top))}addHackNode(e,t){if(t==this.top&&this.index<t.children.length&&t.children[this.index].matchesHack(e))this.index++;else{let r=document.createElement(e);e=="IMG"&&(r.className="ProseMirror-separator",r.alt=""),e=="BR"&&(r.className="ProseMirror-trailingBreak");let s=new up(this.top,[],r,null);t!=this.top?t.children.push(s):t.children.splice(this.index++,0,s),this.changed=!0}}isLocked(e){return this.lock&&(e==this.lock||e.nodeType==1&&e.contains(this.lock.parentNode))}}function D0(n,e){let t=e,r=t.children.length,s=n.childCount,i=new Map,o=[];e:for(;s>0;){let a;for(;;)if(r){let c=t.children[r-1];if(c instanceof Jn)t=c,r=c.children.length;else{a=c,r--;break}}else{if(t==e)break e;r=t.parent.children.indexOf(t),t=t.parent}let l=a.node;if(l){if(l!=n.child(s-1))break;--s,i.set(a,s),o.push(a)}}return{index:s,matched:i,matches:o.reverse()}}function L0(n,e){return n.type.side-e.type.side}function j0(n,e,t,r){let s=e.locals(n),i=0;if(s.length==0){for(let c=0;c<n.childCount;c++){let d=n.child(c);r(d,s,e.forChild(i,d),c),i+=d.nodeSize}return}let o=0,a=[],l=null;for(let c=0;;){let d,h;for(;o<s.length&&s[o].to==i;){let y=s[o++];y.widget&&(d?(h||(h=[d])).push(y):d=y)}if(d)if(h){h.sort(L0);for(let y=0;y<h.length;y++)t(h[y],c,!!l)}else t(d,c,!!l);let f,p;if(l)p=-1,f=l,l=null;else if(c<n.childCount)p=c,f=n.child(c++);else break;for(let y=0;y<a.length;y++)a[y].to<=i&&a.splice(y--,1);for(;o<s.length&&s[o].from<=i&&s[o].to>i;)a.push(s[o++]);let m=i+f.nodeSize;if(f.isText){let y=m;o<s.length&&s[o].from<y&&(y=s[o].from);for(let w=0;w<a.length;w++)a[w].to<y&&(y=a[w].to);y<m&&(l=f.cut(y-i),f=f.cut(0,y-i),m=y,p=-1)}else for(;o<s.length&&s[o].to<m;)o++;let g=f.isInline&&!f.isLeaf?a.filter(y=>!y.inline):a.slice();r(f,g,e.forChild(i,f),p),i=m}}function B0(n){if(n.nodeName=="UL"||n.nodeName=="OL"){let e=n.style.cssText;n.style.cssText=e+"; list-style: square !important",window.getComputedStyle(n).listStyle,n.style.cssText=e}}function F0(n,e,t,r){for(let s=0,i=0;s<n.childCount&&i<=r;){let o=n.child(s++),a=i;if(i+=o.nodeSize,!o.isText)continue;let l=o.text;for(;s<n.childCount;){let c=n.child(s++);if(i+=c.nodeSize,!c.isText)break;l+=c.text}if(i>=t){if(i>=r&&l.slice(r-e.length-a,r-a)==e)return r-e.length;let c=a<r?l.lastIndexOf(e,r-a-1):-1;if(c>=0&&c+e.length+a>=t)return a+c;if(t==r&&l.length>=r+e.length-a&&l.slice(r-a,r-a+e.length)==e)return r}}return-1}function Ll(n,e,t,r,s){let i=[];for(let o=0,a=0;o<n.length;o++){let l=n[o],c=a,d=a+=l.size;c>=t||d<=e?i.push(l):(c<e&&i.push(l.slice(0,e-c,r)),s&&(i.push(s),s=void 0),d>t&&i.push(l.slice(t-c,l.size,r)))}return i}function Mc(n,e=null){let t=n.domSelectionRange(),r=n.state.doc;if(!t.focusNode)return null;let s=n.docView.nearestDesc(t.focusNode),i=s&&s.size==0,o=n.docView.posFromDOM(t.focusNode,t.focusOffset,1);if(o<0)return null;let a=r.resolve(o),l,c;if(Yo(t)){for(l=o;s&&!s.node;)s=s.parent;let h=s.node;if(s&&h.isAtom&&D.isSelectable(h)&&s.parent&&!(h.isInline&&f0(t.focusNode,t.focusOffset,s.dom))){let f=s.posBefore;c=new D(o==f?a:r.resolve(f))}}else{if(t instanceof n.dom.ownerDocument.defaultView.Selection&&t.rangeCount>1){let h=o,f=o;for(let p=0;p<t.rangeCount;p++){let m=t.getRangeAt(p);h=Math.min(h,n.docView.posFromDOM(m.startContainer,m.startOffset,1)),f=Math.max(f,n.docView.posFromDOM(m.endContainer,m.endOffset,-1))}if(h<0)return null;[l,o]=f==n.state.selection.anchor?[f,h]:[h,f],a=r.resolve(o)}else l=n.docView.posFromDOM(t.anchorNode,t.anchorOffset,1);if(l<0)return null}let d=r.resolve(l);if(!c){let h=e=="pointer"||n.state.selection.head<a.pos&&!i?1:-1;c=Ic(n,d,a,h)}return c}function mp(n){return n.editable?n.hasFocus():yp(n)&&document.activeElement&&document.activeElement.contains(n.dom)}function jt(n,e=!1){let t=n.state.selection;if(gp(n,t),!!mp(n)){if(!e&&n.input.mouseDown&&n.input.mouseDown.allowDefault&&Te){let r=n.domSelectionRange(),s=n.domObserver.currentSelection;if(r.anchorNode&&s.anchorNode&&Gn(r.anchorNode,r.anchorOffset,s.anchorNode,s.anchorOffset)){n.input.mouseDown.delayedSelectionSync=!0,n.domObserver.setCurSelection();return}}if(n.domObserver.disconnectSelection(),n.cursorWrapper)z0(n);else{let{anchor:r,head:s}=t,i,o;Su&&!(t instanceof z)&&(t.$from.parent.inlineContent||(i=_u(n,t.from)),!t.empty&&!t.$from.parent.inlineContent&&(o=_u(n,t.to))),n.docView.setSelection(r,s,n,e),Su&&(i&&xu(i),o&&xu(o)),t.visible?n.dom.classList.remove("ProseMirror-hideselection"):(n.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&U0(n))}n.domObserver.setCurSelection(),n.domObserver.connectSelection()}}const Su=De||Te&&np<63;function _u(n,e){let{node:t,offset:r}=n.docView.domFromPos(e,0),s=r<t.childNodes.length?t.childNodes[r]:null,i=r?t.childNodes[r-1]:null;if(De&&s&&s.contentEditable=="false")return za(s);if((!s||s.contentEditable=="false")&&(!i||i.contentEditable=="false")){if(s)return za(s);if(i)return za(i)}}function za(n){return n.contentEditable="true",De&&n.draggable&&(n.draggable=!1,n.wasDraggable=!0),n}function xu(n){n.contentEditable="false",n.wasDraggable&&(n.draggable=!0,n.wasDraggable=null)}function U0(n){let e=n.dom.ownerDocument;e.removeEventListener("selectionchange",n.input.hideSelectionGuard);let t=n.domSelectionRange(),r=t.anchorNode,s=t.anchorOffset;e.addEventListener("selectionchange",n.input.hideSelectionGuard=()=>{(t.anchorNode!=r||t.anchorOffset!=s)&&(e.removeEventListener("selectionchange",n.input.hideSelectionGuard),setTimeout(()=>{(!mp(n)||n.state.selection.visible)&&n.dom.classList.remove("ProseMirror-hideselection")},20))})}function z0(n){let e=n.domSelection();if(!e)return;let t=n.cursorWrapper.dom,r=t.nodeName=="IMG";r?e.collapse(t.parentNode,Oe(t)+1):e.collapse(t,0),!r&&!n.state.selection.visible&&ze&&dn<=11&&(t.disabled=!0,t.disabled=!1)}function gp(n,e){if(e instanceof D){let t=n.docView.descAt(e.from);t!=n.lastSelectedViewDesc&&(Tu(n),t&&t.selectNode(),n.lastSelectedViewDesc=t)}else Tu(n)}function Tu(n){n.lastSelectedViewDesc&&(n.lastSelectedViewDesc.parent&&n.lastSelectedViewDesc.deselectNode(),n.lastSelectedViewDesc=void 0)}function Ic(n,e,t,r){return n.someProp("createSelectionBetween",s=>s(n,e,t))||z.between(e,t,r)}function Eu(n){return n.editable&&!n.hasFocus()?!1:yp(n)}function yp(n){let e=n.domSelectionRange();if(!e.anchorNode)return!1;try{return n.dom.contains(e.anchorNode.nodeType==3?e.anchorNode.parentNode:e.anchorNode)&&(n.editable||n.dom.contains(e.focusNode.nodeType==3?e.focusNode.parentNode:e.focusNode))}catch{return!1}}function H0(n){let e=n.docView.domFromPos(n.state.selection.anchor,0),t=n.domSelectionRange();return Gn(e.node,e.offset,t.anchorNode,t.anchorOffset)}function jl(n,e){let{$anchor:t,$head:r}=n.selection,s=e>0?t.max(r):t.min(r),i=s.parent.inlineContent?s.depth?n.doc.resolve(e>0?s.after():s.before()):null:s;return i&&G.findFrom(i,e)}function Yt(n,e){return n.dispatch(n.state.tr.setSelection(e).scrollIntoView()),!0}function Cu(n,e,t){let r=n.state.selection;if(r instanceof z)if(t.indexOf("s")>-1){let{$head:s}=r,i=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter;if(!i||i.isText||!i.isLeaf)return!1;let o=n.state.doc.resolve(s.pos+i.nodeSize*(e<0?-1:1));return Yt(n,new z(r.$anchor,o))}else if(r.empty){if(n.endOfTextblock(e>0?"forward":"backward")){let s=jl(n.state,e);return s&&s instanceof D?Yt(n,s):!1}else if(!(et&&t.indexOf("m")>-1)){let s=r.$head,i=s.textOffset?null:e<0?s.nodeBefore:s.nodeAfter,o;if(!i||i.isText)return!1;let a=e<0?s.pos-i.nodeSize:s.pos;return i.isAtom||(o=n.docView.descAt(a))&&!o.contentDOM?D.isSelectable(i)?Yt(n,new D(e<0?n.state.doc.resolve(s.pos-i.nodeSize):s)):zs?Yt(n,new z(n.state.doc.resolve(e<0?a:a+i.nodeSize))):!1:!1}}else return!1;else{if(r instanceof D&&r.node.isInline)return Yt(n,new z(e>0?r.$to:r.$from));{let s=jl(n.state,e);return s?Yt(n,s):!1}}}function Wi(n){return n.nodeType==3?n.nodeValue.length:n.childNodes.length}function is(n,e){let t=n.pmViewDesc;return t&&t.size==0&&(e<0||n.nextSibling||n.nodeName!="BR")}function cr(n,e){return e<0?V0(n):q0(n)}function V0(n){let e=n.domSelectionRange(),t=e.focusNode,r=e.focusOffset;if(!t)return;let s,i,o=!1;for(rt&&t.nodeType==1&&r<Wi(t)&&is(t.childNodes[r],-1)&&(o=!0);;)if(r>0){if(t.nodeType!=1)break;{let a=t.childNodes[r-1];if(is(a,-1))s=t,i=--r;else if(a.nodeType==3)t=a,r=t.nodeValue.length;else break}}else{if(wp(t))break;{let a=t.previousSibling;for(;a&&is(a,-1);)s=t.parentNode,i=Oe(a),a=a.previousSibling;if(a)t=a,r=Wi(t);else{if(t=t.parentNode,t==n.dom)break;r=0}}}o?Bl(n,t,r):s&&Bl(n,s,i)}function q0(n){let e=n.domSelectionRange(),t=e.focusNode,r=e.focusOffset;if(!t)return;let s=Wi(t),i,o;for(;;)if(r<s){if(t.nodeType!=1)break;let a=t.childNodes[r];if(is(a,1))i=t,o=++r;else break}else{if(wp(t))break;{let a=t.nextSibling;for(;a&&is(a,1);)i=a.parentNode,o=Oe(a)+1,a=a.nextSibling;if(a)t=a,r=0,s=Wi(t);else{if(t=t.parentNode,t==n.dom)break;r=s=0}}}i&&Bl(n,i,o)}function wp(n){let e=n.pmViewDesc;return e&&e.node&&e.node.isBlock}function W0(n,e){for(;n&&e==n.childNodes.length&&!Us(n);)e=Oe(n)+1,n=n.parentNode;for(;n&&e<n.childNodes.length;){let t=n.childNodes[e];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=0}}function K0(n,e){for(;n&&!e&&!Us(n);)e=Oe(n),n=n.parentNode;for(;n&&e;){let t=n.childNodes[e-1];if(t.nodeType==3)return t;if(t.nodeType==1&&t.contentEditable=="false")break;n=t,e=n.childNodes.length}}function Bl(n,e,t){if(e.nodeType!=3){let i,o;(o=W0(e,t))?(e=o,t=0):(i=K0(e,t))&&(e=i,t=i.nodeValue.length)}let r=n.domSelection();if(!r)return;if(Yo(r)){let i=document.createRange();i.setEnd(e,t),i.setStart(e,t),r.removeAllRanges(),r.addRange(i)}else r.extend&&r.extend(e,t);n.domObserver.setCurSelection();let{state:s}=n;setTimeout(()=>{n.state==s&&jt(n)},50)}function Au(n,e){let t=n.state.doc.resolve(e);if(!(Te||rp)&&t.parent.inlineContent){let s=n.coordsAtPos(e);if(e>t.start()){let i=n.coordsAtPos(e-1),o=(i.top+i.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(i.left-s.left)>1)return i.left<s.left?"ltr":"rtl"}if(e<t.end()){let i=n.coordsAtPos(e+1),o=(i.top+i.bottom)/2;if(o>s.top&&o<s.bottom&&Math.abs(i.left-s.left)>1)return i.left>s.left?"ltr":"rtl"}}return getComputedStyle(n.dom).direction=="rtl"?"rtl":"ltr"}function Mu(n,e,t){let r=n.state.selection;if(r instanceof z&&!r.empty||t.indexOf("s")>-1||et&&t.indexOf("m")>-1)return!1;let{$from:s,$to:i}=r;if(!s.parent.inlineContent||n.endOfTextblock(e<0?"up":"down")){let o=jl(n.state,e);if(o&&o instanceof D)return Yt(n,o)}if(!s.parent.inlineContent){let o=e<0?s:i,a=r instanceof Je?G.near(o,e):G.findFrom(o,e);return a?Yt(n,a):!1}return!1}function Iu(n,e){if(!(n.state.selection instanceof z))return!0;let{$head:t,$anchor:r,empty:s}=n.state.selection;if(!t.sameParent(r))return!0;if(!s)return!1;if(n.endOfTextblock(e>0?"forward":"backward"))return!0;let i=!t.textOffset&&(e<0?t.nodeBefore:t.nodeAfter);if(i&&!i.isText){let o=n.state.tr;return e<0?o.delete(t.pos-i.nodeSize,t.pos):o.delete(t.pos,t.pos+i.nodeSize),n.dispatch(o),!0}return!1}function Ou(n,e,t){n.domObserver.stop(),e.contentEditable=t,n.domObserver.start()}function G0(n){if(!De||n.state.selection.$head.parentOffset>0)return!1;let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(e&&e.nodeType==1&&t==0&&e.firstChild&&e.firstChild.contentEditable=="false"){let r=e.firstChild;Ou(n,r,"true"),setTimeout(()=>Ou(n,r,"false"),20)}return!1}function J0(n){let e="";return n.ctrlKey&&(e+="c"),n.metaKey&&(e+="m"),n.altKey&&(e+="a"),n.shiftKey&&(e+="s"),e}function Y0(n,e){let t=e.keyCode,r=J0(e);if(t==8||et&&t==72&&r=="c")return Iu(n,-1)||cr(n,-1);if(t==46&&!e.shiftKey||et&&t==68&&r=="c")return Iu(n,1)||cr(n,1);if(t==13||t==27)return!0;if(t==37||et&&t==66&&r=="c"){let s=t==37?Au(n,n.state.selection.from)=="ltr"?-1:1:-1;return Cu(n,s,r)||cr(n,s)}else if(t==39||et&&t==70&&r=="c"){let s=t==39?Au(n,n.state.selection.from)=="ltr"?1:-1:1;return Cu(n,s,r)||cr(n,s)}else{if(t==38||et&&t==80&&r=="c")return Mu(n,-1,r)||cr(n,-1);if(t==40||et&&t==78&&r=="c")return G0(n)||Mu(n,1,r)||cr(n,1);if(r==(et?"m":"c")&&(t==66||t==73||t==89||t==90))return!0}return!1}function Oc(n,e){n.someProp("transformCopied",p=>{e=p(e,n)});let t=[],{content:r,openStart:s,openEnd:i}=e;for(;s>1&&i>1&&r.childCount==1&&r.firstChild.childCount==1;){s--,i--;let p=r.firstChild;t.push(p.type.name,p.attrs!=p.type.defaultAttrs?p.attrs:null),r=p.content}let o=n.someProp("clipboardSerializer")||er.fromSchema(n.state.schema),a=xp(),l=a.createElement("div");l.appendChild(o.serializeFragment(r,{document:a}));let c=l.firstChild,d,h=0;for(;c&&c.nodeType==1&&(d=_p[c.nodeName.toLowerCase()]);){for(let p=d.length-1;p>=0;p--){let m=a.createElement(d[p]);for(;l.firstChild;)m.appendChild(l.firstChild);l.appendChild(m),h++}c=l.firstChild}c&&c.nodeType==1&&c.setAttribute("data-pm-slice",`${s} ${i}${h?` -${h}`:""} ${JSON.stringify(t)}`);let f=n.someProp("clipboardTextSerializer",p=>p(e,n))||e.content.textBetween(0,e.content.size,`

`);return{dom:l,text:f,slice:e}}function bp(n,e,t,r,s){let i=s.parent.type.spec.code,o,a;if(!t&&!e)return null;let l=!!e&&(r||i||!t);if(l){if(n.someProp("transformPastedText",f=>{e=f(e,i||r,n)}),i)return a=new O(T.from(n.state.schema.text(e.replace(/\r\n?/g,`
`))),0,0),n.someProp("transformPasted",f=>{a=f(a,n,!0)}),a;let h=n.someProp("clipboardTextParser",f=>f(e,s,r,n));if(h)a=h;else{let f=s.marks(),{schema:p}=n.state,m=er.fromSchema(p);o=document.createElement("div"),e.split(/(?:\r\n?|\n)+/).forEach(g=>{let y=o.appendChild(document.createElement("p"));g&&y.appendChild(m.serializeNode(p.text(g,f)))})}}else n.someProp("transformPastedHTML",h=>{t=h(t,n)}),o=eS(t),zs&&tS(o);let c=o&&o.querySelector("[data-pm-slice]"),d=c&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(c.getAttribute("data-pm-slice")||"");if(d&&d[3])for(let h=+d[3];h>0;h--){let f=o.firstChild;for(;f&&f.nodeType!=1;)f=f.nextSibling;if(!f)break;o=f}if(a||(a=(n.someProp("clipboardParser")||n.someProp("domParser")||cn.fromSchema(n.state.schema)).parseSlice(o,{preserveWhitespace:!!(l||d),context:s,ruleFromNode(f){return f.nodeName=="BR"&&!f.nextSibling&&f.parentNode&&!X0.test(f.parentNode.nodeName)?{ignore:!0}:null}})),d)a=nS(Nu(a,+d[1],+d[2]),d[4]);else if(a=O.maxOpen(Q0(a.content,s),!0),a.openStart||a.openEnd){let h=0,f=0;for(let p=a.content.firstChild;h<a.openStart&&!p.type.spec.isolating;h++,p=p.firstChild);for(let p=a.content.lastChild;f<a.openEnd&&!p.type.spec.isolating;f++,p=p.lastChild);a=Nu(a,h,f)}return n.someProp("transformPasted",h=>{a=h(a,n,l)}),a}const X0=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function Q0(n,e){if(n.childCount<2)return n;for(let t=e.depth;t>=0;t--){let s=e.node(t).contentMatchAt(e.index(t)),i,o=[];if(n.forEach(a=>{if(!o)return;let l=s.findWrapping(a.type),c;if(!l)return o=null;if(c=o.length&&i.length&&kp(l,i,a,o[o.length-1],0))o[o.length-1]=c;else{o.length&&(o[o.length-1]=Sp(o[o.length-1],i.length));let d=vp(a,l);o.push(d),s=s.matchType(d.type),i=l}}),o)return T.from(o)}return n}function vp(n,e,t=0){for(let r=e.length-1;r>=t;r--)n=e[r].create(null,T.from(n));return n}function kp(n,e,t,r,s){if(s<n.length&&s<e.length&&n[s]==e[s]){let i=kp(n,e,t,r.lastChild,s+1);if(i)return r.copy(r.content.replaceChild(r.childCount-1,i));if(r.contentMatchAt(r.childCount).matchType(s==n.length-1?t.type:n[s+1]))return r.copy(r.content.append(T.from(vp(t,n,s+1))))}}function Sp(n,e){if(e==0)return n;let t=n.content.replaceChild(n.childCount-1,Sp(n.lastChild,e-1)),r=n.contentMatchAt(n.childCount).fillBefore(T.empty,!0);return n.copy(t.append(r))}function Fl(n,e,t,r,s,i){let o=e<0?n.firstChild:n.lastChild,a=o.content;return n.childCount>1&&(i=0),s<r-1&&(a=Fl(a,e,t,r,s+1,i)),s>=t&&(a=e<0?o.contentMatchAt(0).fillBefore(a,i<=s).append(a):a.append(o.contentMatchAt(o.childCount).fillBefore(T.empty,!0))),n.replaceChild(e<0?0:n.childCount-1,o.copy(a))}function Nu(n,e,t){return e<n.openStart&&(n=new O(Fl(n.content,-1,e,n.openStart,0,n.openEnd),e,n.openEnd)),t<n.openEnd&&(n=new O(Fl(n.content,1,t,n.openEnd,0,0),n.openStart,t)),n}const _p={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]};let $u=null;function xp(){return $u||($u=document.implementation.createHTMLDocument("title"))}let Ha=null;function Z0(n){let e=window.trustedTypes;return e?(Ha||(Ha=e.defaultPolicy||e.createPolicy("ProseMirrorClipboard",{createHTML:t=>t})),Ha.createHTML(n)):n}function eS(n){let e=/^(\s*<meta [^>]*>)*/.exec(n);e&&(n=n.slice(e[0].length));let t=xp().createElement("div"),r=/<([a-z][^>\s]+)/i.exec(n),s;if((s=r&&_p[r[1].toLowerCase()])&&(n=s.map(i=>"<"+i+">").join("")+n+s.map(i=>"</"+i+">").reverse().join("")),t.innerHTML=Z0(n),s)for(let i=0;i<s.length;i++)t=t.querySelector(s[i])||t;return t}function tS(n){let e=n.querySelectorAll(Te?"span:not([class]):not([style])":"span.Apple-converted-space");for(let t=0;t<e.length;t++){let r=e[t];r.childNodes.length==1&&r.textContent==""&&r.parentNode&&r.parentNode.replaceChild(n.ownerDocument.createTextNode(" "),r)}}function nS(n,e){if(!n.size)return n;let t=n.content.firstChild.type.schema,r;try{r=JSON.parse(e)}catch{return n}let{content:s,openStart:i,openEnd:o}=n;for(let a=r.length-2;a>=0;a-=2){let l=t.nodes[r[a]];if(!l||l.hasRequiredAttrs())break;s=T.from(l.create(r[a+1],s)),i++,o++}return new O(s,i,o)}const je={},Be={},rS={touchstart:!0,touchmove:!0};class sS{constructor(){this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:"",button:0},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastFocus=0,this.lastTouch=0,this.lastChromeDelete=0,this.composing=!1,this.compositionNode=null,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.compositionID=1,this.compositionPendingChanges=0,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null}}function iS(n){for(let e in je){let t=je[e];n.dom.addEventListener(e,n.input.eventHandlers[e]=r=>{aS(n,r)&&!Nc(n,r)&&(n.editable||!(r.type in Be))&&t(n,r)},rS[e]?{passive:!0}:void 0)}De&&n.dom.addEventListener("input",()=>null),Ul(n)}function an(n,e){n.input.lastSelectionOrigin=e,n.input.lastSelectionTime=Date.now()}function oS(n){n.domObserver.stop();for(let e in n.input.eventHandlers)n.dom.removeEventListener(e,n.input.eventHandlers[e]);clearTimeout(n.input.composingTimeout),clearTimeout(n.input.lastIOSEnterFallbackTimeout)}function Ul(n){n.someProp("handleDOMEvents",e=>{for(let t in e)n.input.eventHandlers[t]||n.dom.addEventListener(t,n.input.eventHandlers[t]=r=>Nc(n,r))})}function Nc(n,e){return n.someProp("handleDOMEvents",t=>{let r=t[e.type];return r?r(n,e)||e.defaultPrevented:!1})}function aS(n,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target;t!=n.dom;t=t.parentNode)if(!t||t.nodeType==11||t.pmViewDesc&&t.pmViewDesc.stopEvent(e))return!1;return!0}function lS(n,e){!Nc(n,e)&&je[e.type]&&(n.editable||!(e.type in Be))&&je[e.type](n,e)}Be.keydown=(n,e)=>{let t=e;if(n.input.shiftKey=t.keyCode==16||t.shiftKey,!Ep(n,t)&&(n.input.lastKeyCode=t.keyCode,n.input.lastKeyCodeTime=Date.now(),!(Dt&&Te&&t.keyCode==13)))if(t.keyCode!=229&&n.domObserver.forceFlush(),Or&&t.keyCode==13&&!t.ctrlKey&&!t.altKey&&!t.metaKey){let r=Date.now();n.input.lastIOSEnter=r,n.input.lastIOSEnterFallbackTimeout=setTimeout(()=>{n.input.lastIOSEnter==r&&(n.someProp("handleKeyDown",s=>s(n,On(13,"Enter"))),n.input.lastIOSEnter=0)},200)}else n.someProp("handleKeyDown",r=>r(n,t))||Y0(n,t)?t.preventDefault():an(n,"key")};Be.keyup=(n,e)=>{e.keyCode==16&&(n.input.shiftKey=!1)};Be.keypress=(n,e)=>{let t=e;if(Ep(n,t)||!t.charCode||t.ctrlKey&&!t.altKey||et&&t.metaKey)return;if(n.someProp("handleKeyPress",s=>s(n,t))){t.preventDefault();return}let r=n.state.selection;if(!(r instanceof z)||!r.$from.sameParent(r.$to)){let s=String.fromCharCode(t.charCode),i=()=>n.state.tr.insertText(s).scrollIntoView();!/[\r\n]/.test(s)&&!n.someProp("handleTextInput",o=>o(n,r.$from.pos,r.$to.pos,s,i))&&n.dispatch(i()),t.preventDefault()}};function Qo(n){return{left:n.clientX,top:n.clientY}}function cS(n,e){let t=e.x-n.clientX,r=e.y-n.clientY;return t*t+r*r<100}function $c(n,e,t,r,s){if(r==-1)return!1;let i=n.state.doc.resolve(r);for(let o=i.depth+1;o>0;o--)if(n.someProp(e,a=>o>i.depth?a(n,t,i.nodeAfter,i.before(o),s,!0):a(n,t,i.node(o),i.before(o),s,!1)))return!0;return!1}function Sr(n,e,t){if(n.focused||n.focus(),n.state.selection.eq(e))return;let r=n.state.tr.setSelection(e);r.setMeta("pointer",!0),n.dispatch(r)}function dS(n,e){if(e==-1)return!1;let t=n.state.doc.resolve(e),r=t.nodeAfter;return r&&r.isAtom&&D.isSelectable(r)?(Sr(n,new D(t)),!0):!1}function uS(n,e){if(e==-1)return!1;let t=n.state.selection,r,s;t instanceof D&&(r=t.node);let i=n.state.doc.resolve(e);for(let o=i.depth+1;o>0;o--){let a=o>i.depth?i.nodeAfter:i.node(o);if(D.isSelectable(a)){r&&t.$from.depth>0&&o>=t.$from.depth&&i.before(t.$from.depth+1)==t.$from.pos?s=i.before(t.$from.depth):s=i.before(o);break}}return s!=null?(Sr(n,D.create(n.state.doc,s)),!0):!1}function hS(n,e,t,r,s){return $c(n,"handleClickOn",e,t,r)||n.someProp("handleClick",i=>i(n,e,r))||(s?uS(n,t):dS(n,t))}function fS(n,e,t,r){return $c(n,"handleDoubleClickOn",e,t,r)||n.someProp("handleDoubleClick",s=>s(n,e,r))}function pS(n,e,t,r){return $c(n,"handleTripleClickOn",e,t,r)||n.someProp("handleTripleClick",s=>s(n,e,r))||mS(n,t,r)}function mS(n,e,t){if(t.button!=0)return!1;let r=n.state.doc;if(e==-1)return r.inlineContent?(Sr(n,z.create(r,0,r.content.size)),!0):!1;let s=r.resolve(e);for(let i=s.depth+1;i>0;i--){let o=i>s.depth?s.nodeAfter:s.node(i),a=s.before(i);if(o.inlineContent)Sr(n,z.create(r,a+1,a+1+o.content.size));else if(D.isSelectable(o))Sr(n,D.create(r,a));else continue;return!0}}function Rc(n){return Ki(n)}const Tp=et?"metaKey":"ctrlKey";je.mousedown=(n,e)=>{let t=e;n.input.shiftKey=t.shiftKey;let r=Rc(n),s=Date.now(),i="singleClick";s-n.input.lastClick.time<500&&cS(t,n.input.lastClick)&&!t[Tp]&&n.input.lastClick.button==t.button&&(n.input.lastClick.type=="singleClick"?i="doubleClick":n.input.lastClick.type=="doubleClick"&&(i="tripleClick")),n.input.lastClick={time:s,x:t.clientX,y:t.clientY,type:i,button:t.button};let o=n.posAtCoords(Qo(t));o&&(i=="singleClick"?(n.input.mouseDown&&n.input.mouseDown.done(),n.input.mouseDown=new gS(n,o,t,!!r)):(i=="doubleClick"?fS:pS)(n,o.pos,o.inside,t)?t.preventDefault():an(n,"pointer"))};class gS{constructor(e,t,r,s){this.view=e,this.pos=t,this.event=r,this.flushed=s,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=e.state.doc,this.selectNode=!!r[Tp],this.allowDefault=r.shiftKey;let i,o;if(t.inside>-1)i=e.state.doc.nodeAt(t.inside),o=t.inside;else{let d=e.state.doc.resolve(t.pos);i=d.parent,o=d.depth?d.before():0}const a=s?null:r.target,l=a?e.docView.nearestDesc(a,!0):null;this.target=l&&l.nodeDOM.nodeType==1?l.nodeDOM:null;let{selection:c}=e.state;(r.button==0&&i.type.spec.draggable&&i.type.spec.selectable!==!1||c instanceof D&&c.from<=o&&c.to>o)&&(this.mightDrag={node:i,pos:o,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&rt&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(()=>{this.view.input.mouseDown==this&&this.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),e.root.addEventListener("mouseup",this.up=this.up.bind(this)),e.root.addEventListener("mousemove",this.move=this.move.bind(this)),an(e,"pointer")}done(){this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(()=>jt(this.view)),this.view.input.mouseDown=null}up(e){if(this.done(),!this.view.dom.contains(e.target))return;let t=this.pos;this.view.state.doc!=this.startDoc&&(t=this.view.posAtCoords(Qo(e))),this.updateAllowDefault(e),this.allowDefault||!t?an(this.view,"pointer"):hS(this.view,t.pos,t.inside,e,this.selectNode)?e.preventDefault():e.button==0&&(this.flushed||De&&this.mightDrag&&!this.mightDrag.node.isAtom||Te&&!this.view.state.selection.visible&&Math.min(Math.abs(t.pos-this.view.state.selection.from),Math.abs(t.pos-this.view.state.selection.to))<=2)?(Sr(this.view,G.near(this.view.state.doc.resolve(t.pos))),e.preventDefault()):an(this.view,"pointer")}move(e){this.updateAllowDefault(e),an(this.view,"pointer"),e.buttons==0&&this.done()}updateAllowDefault(e){!this.allowDefault&&(Math.abs(this.event.x-e.clientX)>4||Math.abs(this.event.y-e.clientY)>4)&&(this.allowDefault=!0)}}je.touchstart=n=>{n.input.lastTouch=Date.now(),Rc(n),an(n,"pointer")};je.touchmove=n=>{n.input.lastTouch=Date.now(),an(n,"pointer")};je.contextmenu=n=>Rc(n);function Ep(n,e){return n.composing?!0:De&&Math.abs(e.timeStamp-n.input.compositionEndedAt)<500?(n.input.compositionEndedAt=-2e8,!0):!1}const yS=Dt?5e3:-1;Be.compositionstart=Be.compositionupdate=n=>{if(!n.composing){n.domObserver.flush();let{state:e}=n,t=e.selection.$to;if(e.selection instanceof z&&(e.storedMarks||!t.textOffset&&t.parentOffset&&t.nodeBefore.marks.some(r=>r.type.spec.inclusive===!1)||Te&&rp&&wS(n)))n.markCursor=n.state.storedMarks||t.marks(),Ki(n,!0),n.markCursor=null;else if(Ki(n,!e.selection.empty),rt&&e.selection.empty&&t.parentOffset&&!t.textOffset&&t.nodeBefore.marks.length){let r=n.domSelectionRange();for(let s=r.focusNode,i=r.focusOffset;s&&s.nodeType==1&&i!=0;){let o=i<0?s.lastChild:s.childNodes[i-1];if(!o)break;if(o.nodeType==3){let a=n.domSelection();a&&a.collapse(o,o.nodeValue.length);break}else s=o,i=-1}}n.input.composing=!0}Cp(n,yS)};function wS(n){let{focusNode:e,focusOffset:t}=n.domSelectionRange();if(!e||e.nodeType!=1||t>=e.childNodes.length)return!1;let r=e.childNodes[t];return r.nodeType==1&&r.contentEditable=="false"}Be.compositionend=(n,e)=>{n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=e.timeStamp,n.input.compositionPendingChanges=n.domObserver.pendingRecords().length?n.input.compositionID:0,n.input.compositionNode=null,n.input.compositionPendingChanges&&Promise.resolve().then(()=>n.domObserver.flush()),n.input.compositionID++,Cp(n,20))};function Cp(n,e){clearTimeout(n.input.composingTimeout),e>-1&&(n.input.composingTimeout=setTimeout(()=>Ki(n),e))}function Ap(n){for(n.composing&&(n.input.composing=!1,n.input.compositionEndedAt=vS());n.input.compositionNodes.length>0;)n.input.compositionNodes.pop().markParentsDirty()}function bS(n){let e=n.domSelectionRange();if(!e.focusNode)return null;let t=u0(e.focusNode,e.focusOffset),r=h0(e.focusNode,e.focusOffset);if(t&&r&&t!=r){let s=r.pmViewDesc,i=n.domObserver.lastChangedTextNode;if(t==i||r==i)return i;if(!s||!s.isText(r.nodeValue))return r;if(n.input.compositionNode==r){let o=t.pmViewDesc;if(!(!o||!o.isText(t.nodeValue)))return r}}return t||r}function vS(){let n=document.createEvent("Event");return n.initEvent("event",!0,!0),n.timeStamp}function Ki(n,e=!1){if(!(Dt&&n.domObserver.flushingSoon>=0)){if(n.domObserver.forceFlush(),Ap(n),e||n.docView&&n.docView.dirty){let t=Mc(n),r=n.state.selection;return t&&!t.eq(r)?n.dispatch(n.state.tr.setSelection(t)):(n.markCursor||e)&&!r.$from.node(r.$from.sharedDepth(r.to)).inlineContent?n.dispatch(n.state.tr.deleteSelection()):n.updateState(n.state),!0}return!1}}function kS(n,e){if(!n.dom.parentNode)return;let t=n.dom.parentNode.appendChild(document.createElement("div"));t.appendChild(e),t.style.cssText="position: fixed; left: -10000px; top: 10px";let r=getSelection(),s=document.createRange();s.selectNodeContents(e),n.dom.blur(),r.removeAllRanges(),r.addRange(s),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),n.focus()},50)}const As=ze&&dn<15||Or&&g0<604;je.copy=Be.cut=(n,e)=>{let t=e,r=n.state.selection,s=t.type=="cut";if(r.empty)return;let i=As?null:t.clipboardData,o=r.content(),{dom:a,text:l}=Oc(n,o);i?(t.preventDefault(),i.clearData(),i.setData("text/html",a.innerHTML),i.setData("text/plain",l)):kS(n,a),s&&n.dispatch(n.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))};function SS(n){return n.openStart==0&&n.openEnd==0&&n.content.childCount==1?n.content.firstChild:null}function _S(n,e){if(!n.dom.parentNode)return;let t=n.input.shiftKey||n.state.selection.$from.parent.type.spec.code,r=n.dom.parentNode.appendChild(document.createElement(t?"textarea":"div"));t||(r.contentEditable="true"),r.style.cssText="position: fixed; left: -10000px; top: 10px",r.focus();let s=n.input.shiftKey&&n.input.lastKeyCode!=45;setTimeout(()=>{n.focus(),r.parentNode&&r.parentNode.removeChild(r),t?Ms(n,r.value,null,s,e):Ms(n,r.textContent,r.innerHTML,s,e)},50)}function Ms(n,e,t,r,s){let i=bp(n,e,t,r,n.state.selection.$from);if(n.someProp("handlePaste",l=>l(n,s,i||O.empty)))return!0;if(!i)return!1;let o=SS(i),a=o?n.state.tr.replaceSelectionWith(o,r):n.state.tr.replaceSelection(i);return n.dispatch(a.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}function Mp(n){let e=n.getData("text/plain")||n.getData("Text");if(e)return e;let t=n.getData("text/uri-list");return t?t.replace(/\r?\n/g," "):""}Be.paste=(n,e)=>{let t=e;if(n.composing&&!Dt)return;let r=As?null:t.clipboardData,s=n.input.shiftKey&&n.input.lastKeyCode!=45;r&&Ms(n,Mp(r),r.getData("text/html"),s,t)?t.preventDefault():_S(n,t)};class Ip{constructor(e,t,r){this.slice=e,this.move=t,this.node=r}}const xS=et?"altKey":"ctrlKey";function Op(n,e){let t=n.someProp("dragCopies",r=>!r(e));return t??!e[xS]}je.dragstart=(n,e)=>{let t=e,r=n.input.mouseDown;if(r&&r.done(),!t.dataTransfer)return;let s=n.state.selection,i=s.empty?null:n.posAtCoords(Qo(t)),o;if(!(i&&i.pos>=s.from&&i.pos<=(s instanceof D?s.to-1:s.to))){if(r&&r.mightDrag)o=D.create(n.state.doc,r.mightDrag.pos);else if(t.target&&t.target.nodeType==1){let h=n.docView.nearestDesc(t.target,!0);h&&h.node.type.spec.draggable&&h!=n.docView&&(o=D.create(n.state.doc,h.posBefore))}}let a=(o||n.state.selection).content(),{dom:l,text:c,slice:d}=Oc(n,a);(!t.dataTransfer.files.length||!Te||np>120)&&t.dataTransfer.clearData(),t.dataTransfer.setData(As?"Text":"text/html",l.innerHTML),t.dataTransfer.effectAllowed="copyMove",As||t.dataTransfer.setData("text/plain",c),n.dragging=new Ip(d,Op(n,t),o)};je.dragend=n=>{let e=n.dragging;window.setTimeout(()=>{n.dragging==e&&(n.dragging=null)},50)};Be.dragover=Be.dragenter=(n,e)=>e.preventDefault();Be.drop=(n,e)=>{try{TS(n,e,n.dragging)}finally{n.dragging=null}};function TS(n,e,t){if(!e.dataTransfer)return;let r=n.posAtCoords(Qo(e));if(!r)return;let s=n.state.doc.resolve(r.pos),i=t&&t.slice;i?n.someProp("transformPasted",p=>{i=p(i,n,!1)}):i=bp(n,Mp(e.dataTransfer),As?null:e.dataTransfer.getData("text/html"),!1,s);let o=!!(t&&Op(n,e));if(n.someProp("handleDrop",p=>p(n,e,i||O.empty,o))){e.preventDefault();return}if(!i)return;e.preventDefault();let a=i?Pf(n.state.doc,s.pos,i):s.pos;a==null&&(a=s.pos);let l=n.state.tr;if(o){let{node:p}=t;p?p.replace(l):l.deleteSelection()}let c=l.mapping.map(a),d=i.openStart==0&&i.openEnd==0&&i.content.childCount==1,h=l.doc;if(d?l.replaceRangeWith(c,c,i.content.firstChild):l.replaceRange(c,c,i),l.doc.eq(h))return;let f=l.doc.resolve(c);if(d&&D.isSelectable(i.content.firstChild)&&f.nodeAfter&&f.nodeAfter.sameMarkup(i.content.firstChild))l.setSelection(new D(f));else{let p=l.mapping.map(a);l.mapping.maps[l.mapping.maps.length-1].forEach((m,g,y,w)=>p=w),l.setSelection(Ic(n,f,l.doc.resolve(p)))}n.focus(),n.dispatch(l.setMeta("uiEvent","drop"))}je.focus=n=>{n.input.lastFocus=Date.now(),n.focused||(n.domObserver.stop(),n.dom.classList.add("ProseMirror-focused"),n.domObserver.start(),n.focused=!0,setTimeout(()=>{n.docView&&n.hasFocus()&&!n.domObserver.currentSelection.eq(n.domSelectionRange())&&jt(n)},20))};je.blur=(n,e)=>{let t=e;n.focused&&(n.domObserver.stop(),n.dom.classList.remove("ProseMirror-focused"),n.domObserver.start(),t.relatedTarget&&n.dom.contains(t.relatedTarget)&&n.domObserver.currentSelection.clear(),n.focused=!1)};je.beforeinput=(n,e)=>{if(Te&&Dt&&e.inputType=="deleteContentBackward"){n.domObserver.flushSoon();let{domChangeCount:r}=n.input;setTimeout(()=>{if(n.input.domChangeCount!=r||(n.dom.blur(),n.focus(),n.someProp("handleKeyDown",i=>i(n,On(8,"Backspace")))))return;let{$cursor:s}=n.state.selection;s&&s.pos>0&&n.dispatch(n.state.tr.delete(s.pos-1,s.pos).scrollIntoView())},50)}};for(let n in Be)je[n]=Be[n];function Is(n,e){if(n==e)return!0;for(let t in n)if(n[t]!==e[t])return!1;for(let t in e)if(!(t in n))return!1;return!0}class Gi{constructor(e,t){this.toDOM=e,this.spec=t||zn,this.side=this.spec.side||0}map(e,t,r,s){let{pos:i,deleted:o}=e.mapResult(t.from+s,this.side<0?-1:1);return o?null:new Pe(i-r,i-r,this)}valid(){return!0}eq(e){return this==e||e instanceof Gi&&(this.spec.key&&this.spec.key==e.spec.key||this.toDOM==e.toDOM&&Is(this.spec,e.spec))}destroy(e){this.spec.destroy&&this.spec.destroy(e)}}class hn{constructor(e,t){this.attrs=e,this.spec=t||zn}map(e,t,r,s){let i=e.map(t.from+s,this.spec.inclusiveStart?-1:1)-r,o=e.map(t.to+s,this.spec.inclusiveEnd?1:-1)-r;return i>=o?null:new Pe(i,o,this)}valid(e,t){return t.from<t.to}eq(e){return this==e||e instanceof hn&&Is(this.attrs,e.attrs)&&Is(this.spec,e.spec)}static is(e){return e.type instanceof hn}destroy(){}}class Pc{constructor(e,t){this.attrs=e,this.spec=t||zn}map(e,t,r,s){let i=e.mapResult(t.from+s,1);if(i.deleted)return null;let o=e.mapResult(t.to+s,-1);return o.deleted||o.pos<=i.pos?null:new Pe(i.pos-r,o.pos-r,this)}valid(e,t){let{index:r,offset:s}=e.content.findIndex(t.from),i;return s==t.from&&!(i=e.child(r)).isText&&s+i.nodeSize==t.to}eq(e){return this==e||e instanceof Pc&&Is(this.attrs,e.attrs)&&Is(this.spec,e.spec)}destroy(){}}class Pe{constructor(e,t,r){this.from=e,this.to=t,this.type=r}copy(e,t){return new Pe(e,t,this.type)}eq(e,t=0){return this.type.eq(e.type)&&this.from+t==e.from&&this.to+t==e.to}map(e,t,r){return this.type.map(e,this,t,r)}static widget(e,t,r){return new Pe(e,e,new Gi(t,r))}static inline(e,t,r,s){return new Pe(e,t,new hn(r,s))}static node(e,t,r,s){return new Pe(e,t,new Pc(r,s))}get spec(){return this.type.spec}get inline(){return this.type instanceof hn}get widget(){return this.type instanceof Gi}}const pr=[],zn={};class ae{constructor(e,t){this.local=e.length?e:pr,this.children=t.length?t:pr}static create(e,t){return t.length?Ji(t,e,0,zn):Re}find(e,t,r){let s=[];return this.findInner(e??0,t??1e9,s,0,r),s}findInner(e,t,r,s,i){for(let o=0;o<this.local.length;o++){let a=this.local[o];a.from<=t&&a.to>=e&&(!i||i(a.spec))&&r.push(a.copy(a.from+s,a.to+s))}for(let o=0;o<this.children.length;o+=3)if(this.children[o]<t&&this.children[o+1]>e){let a=this.children[o]+1;this.children[o+2].findInner(e-a,t-a,r,s+a,i)}}map(e,t,r){return this==Re||e.maps.length==0?this:this.mapInner(e,t,0,0,r||zn)}mapInner(e,t,r,s,i){let o;for(let a=0;a<this.local.length;a++){let l=this.local[a].map(e,r,s);l&&l.type.valid(t,l)?(o||(o=[])).push(l):i.onRemove&&i.onRemove(this.local[a].spec)}return this.children.length?ES(this.children,o||[],e,t,r,s,i):o?new ae(o.sort(Hn),pr):Re}add(e,t){return t.length?this==Re?ae.create(e,t):this.addInner(e,t,0):this}addInner(e,t,r){let s,i=0;e.forEach((a,l)=>{let c=l+r,d;if(d=$p(t,a,c)){for(s||(s=this.children.slice());i<s.length&&s[i]<l;)i+=3;s[i]==l?s[i+2]=s[i+2].addInner(a,d,c+1):s.splice(i,0,l,l+a.nodeSize,Ji(d,a,c+1,zn)),i+=3}});let o=Np(i?Rp(t):t,-r);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||o.splice(a--,1);return new ae(o.length?this.local.concat(o).sort(Hn):this.local,s||this.children)}remove(e){return e.length==0||this==Re?this:this.removeInner(e,0)}removeInner(e,t){let r=this.children,s=this.local;for(let i=0;i<r.length;i+=3){let o,a=r[i]+t,l=r[i+1]+t;for(let d=0,h;d<e.length;d++)(h=e[d])&&h.from>a&&h.to<l&&(e[d]=null,(o||(o=[])).push(h));if(!o)continue;r==this.children&&(r=this.children.slice());let c=r[i+2].removeInner(o,a+1);c!=Re?r[i+2]=c:(r.splice(i,3),i-=3)}if(s.length){for(let i=0,o;i<e.length;i++)if(o=e[i])for(let a=0;a<s.length;a++)s[a].eq(o,t)&&(s==this.local&&(s=this.local.slice()),s.splice(a--,1))}return r==this.children&&s==this.local?this:s.length||r.length?new ae(s,r):Re}forChild(e,t){if(this==Re)return this;if(t.isLeaf)return ae.empty;let r,s;for(let a=0;a<this.children.length;a+=3)if(this.children[a]>=e){this.children[a]==e&&(r=this.children[a+2]);break}let i=e+1,o=i+t.content.size;for(let a=0;a<this.local.length;a++){let l=this.local[a];if(l.from<o&&l.to>i&&l.type instanceof hn){let c=Math.max(i,l.from)-i,d=Math.min(o,l.to)-i;c<d&&(s||(s=[])).push(l.copy(c,d))}}if(s){let a=new ae(s.sort(Hn),pr);return r?new tn([a,r]):a}return r||Re}eq(e){if(this==e)return!0;if(!(e instanceof ae)||this.local.length!=e.local.length||this.children.length!=e.children.length)return!1;for(let t=0;t<this.local.length;t++)if(!this.local[t].eq(e.local[t]))return!1;for(let t=0;t<this.children.length;t+=3)if(this.children[t]!=e.children[t]||this.children[t+1]!=e.children[t+1]||!this.children[t+2].eq(e.children[t+2]))return!1;return!0}locals(e){return Dc(this.localsInner(e))}localsInner(e){if(this==Re)return pr;if(e.inlineContent||!this.local.some(hn.is))return this.local;let t=[];for(let r=0;r<this.local.length;r++)this.local[r].type instanceof hn||t.push(this.local[r]);return t}forEachSet(e){e(this)}}ae.empty=new ae([],[]);ae.removeOverlap=Dc;const Re=ae.empty;class tn{constructor(e){this.members=e}map(e,t){const r=this.members.map(s=>s.map(e,t,zn));return tn.from(r)}forChild(e,t){if(t.isLeaf)return ae.empty;let r=[];for(let s=0;s<this.members.length;s++){let i=this.members[s].forChild(e,t);i!=Re&&(i instanceof tn?r=r.concat(i.members):r.push(i))}return tn.from(r)}eq(e){if(!(e instanceof tn)||e.members.length!=this.members.length)return!1;for(let t=0;t<this.members.length;t++)if(!this.members[t].eq(e.members[t]))return!1;return!0}locals(e){let t,r=!0;for(let s=0;s<this.members.length;s++){let i=this.members[s].localsInner(e);if(i.length)if(!t)t=i;else{r&&(t=t.slice(),r=!1);for(let o=0;o<i.length;o++)t.push(i[o])}}return t?Dc(r?t:t.sort(Hn)):pr}static from(e){switch(e.length){case 0:return Re;case 1:return e[0];default:return new tn(e.every(t=>t instanceof ae)?e:e.reduce((t,r)=>t.concat(r instanceof ae?r:r.members),[]))}}forEachSet(e){for(let t=0;t<this.members.length;t++)this.members[t].forEachSet(e)}}function ES(n,e,t,r,s,i,o){let a=n.slice();for(let c=0,d=i;c<t.maps.length;c++){let h=0;t.maps[c].forEach((f,p,m,g)=>{let y=g-m-(p-f);for(let w=0;w<a.length;w+=3){let v=a[w+1];if(v<0||f>v+d-h)continue;let b=a[w]+d-h;p>=b?a[w+1]=f<=b?-2:-1:f>=d&&y&&(a[w]+=y,a[w+1]+=y)}h+=y}),d=t.maps[c].map(d,-1)}let l=!1;for(let c=0;c<a.length;c+=3)if(a[c+1]<0){if(a[c+1]==-2){l=!0,a[c+1]=-1;continue}let d=t.map(n[c]+i),h=d-s;if(h<0||h>=r.content.size){l=!0;continue}let f=t.map(n[c+1]+i,-1),p=f-s,{index:m,offset:g}=r.content.findIndex(h),y=r.maybeChild(m);if(y&&g==h&&g+y.nodeSize==p){let w=a[c+2].mapInner(t,y,d+1,n[c]+i+1,o);w!=Re?(a[c]=h,a[c+1]=p,a[c+2]=w):(a[c+1]=-2,l=!0)}else l=!0}if(l){let c=CS(a,n,e,t,s,i,o),d=Ji(c,r,0,o);e=d.local;for(let h=0;h<a.length;h+=3)a[h+1]<0&&(a.splice(h,3),h-=3);for(let h=0,f=0;h<d.children.length;h+=3){let p=d.children[h];for(;f<a.length&&a[f]<p;)f+=3;a.splice(f,0,d.children[h],d.children[h+1],d.children[h+2])}}return new ae(e.sort(Hn),a)}function Np(n,e){if(!e||!n.length)return n;let t=[];for(let r=0;r<n.length;r++){let s=n[r];t.push(new Pe(s.from+e,s.to+e,s.type))}return t}function CS(n,e,t,r,s,i,o){function a(l,c){for(let d=0;d<l.local.length;d++){let h=l.local[d].map(r,s,c);h?t.push(h):o.onRemove&&o.onRemove(l.local[d].spec)}for(let d=0;d<l.children.length;d+=3)a(l.children[d+2],l.children[d]+c+1)}for(let l=0;l<n.length;l+=3)n[l+1]==-1&&a(n[l+2],e[l]+i+1);return t}function $p(n,e,t){if(e.isLeaf)return null;let r=t+e.nodeSize,s=null;for(let i=0,o;i<n.length;i++)(o=n[i])&&o.from>t&&o.to<r&&((s||(s=[])).push(o),n[i]=null);return s}function Rp(n){let e=[];for(let t=0;t<n.length;t++)n[t]!=null&&e.push(n[t]);return e}function Ji(n,e,t,r){let s=[],i=!1;e.forEach((a,l)=>{let c=$p(n,a,l+t);if(c){i=!0;let d=Ji(c,a,t+l+1,r);d!=Re&&s.push(l,l+a.nodeSize,d)}});let o=Np(i?Rp(n):n,-t).sort(Hn);for(let a=0;a<o.length;a++)o[a].type.valid(e,o[a])||(r.onRemove&&r.onRemove(o[a].spec),o.splice(a--,1));return o.length||s.length?new ae(o,s):Re}function Hn(n,e){return n.from-e.from||n.to-e.to}function Dc(n){let e=n;for(let t=0;t<e.length-1;t++){let r=e[t];if(r.from!=r.to)for(let s=t+1;s<e.length;s++){let i=e[s];if(i.from==r.from){i.to!=r.to&&(e==n&&(e=n.slice()),e[s]=i.copy(i.from,r.to),Ru(e,s+1,i.copy(r.to,i.to)));continue}else{i.from<r.to&&(e==n&&(e=n.slice()),e[t]=r.copy(r.from,i.from),Ru(e,s,r.copy(i.from,r.to)));break}}}return e}function Ru(n,e,t){for(;e<n.length&&Hn(t,n[e])>0;)e++;n.splice(e,0,t)}function Va(n){let e=[];return n.someProp("decorations",t=>{let r=t(n.state);r&&r!=Re&&e.push(r)}),n.cursorWrapper&&e.push(ae.create(n.state.doc,[n.cursorWrapper.deco])),tn.from(e)}const AS={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},MS=ze&&dn<=11;class IS{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}set(e){this.anchorNode=e.anchorNode,this.anchorOffset=e.anchorOffset,this.focusNode=e.focusNode,this.focusOffset=e.focusOffset}clear(){this.anchorNode=this.focusNode=null}eq(e){return e.anchorNode==this.anchorNode&&e.anchorOffset==this.anchorOffset&&e.focusNode==this.focusNode&&e.focusOffset==this.focusOffset}}class OS{constructor(e,t){this.view=e,this.handleDOMChange=t,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new IS,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.lastChangedTextNode=null,this.observer=window.MutationObserver&&new window.MutationObserver(r=>{for(let s=0;s<r.length;s++)this.queue.push(r[s]);ze&&dn<=11&&r.some(s=>s.type=="childList"&&s.removedNodes.length||s.type=="characterData"&&s.oldValue.length>s.target.nodeValue.length)?this.flushSoon():this.flush()}),MS&&(this.onCharData=r=>{this.queue.push({target:r.target,type:"characterData",oldValue:r.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}flushSoon(){this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(()=>{this.flushingSoon=-1,this.flush()},20))}forceFlush(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}start(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,AS)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}stop(){if(this.observer){let e=this.observer.takeRecords();if(e.length){for(let t=0;t<e.length;t++)this.queue.push(e[t]);window.setTimeout(()=>this.flush(),20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}connectSelection(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}disconnectSelection(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}suppressSelectionUpdates(){this.suppressingSelectionUpdates=!0,setTimeout(()=>this.suppressingSelectionUpdates=!1,50)}onSelectionChange(){if(Eu(this.view)){if(this.suppressingSelectionUpdates)return jt(this.view);if(ze&&dn<=11&&!this.view.state.selection.empty){let e=this.view.domSelectionRange();if(e.focusNode&&Gn(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset))return this.flushSoon()}this.flush()}}setCurSelection(){this.currentSelection.set(this.view.domSelectionRange())}ignoreSelectionChange(e){if(!e.focusNode)return!0;let t=new Set,r;for(let i=e.focusNode;i;i=Ir(i))t.add(i);for(let i=e.anchorNode;i;i=Ir(i))if(t.has(i)){r=i;break}let s=r&&this.view.docView.nearestDesc(r);if(s&&s.ignoreMutation({type:"selection",target:r.nodeType==3?r.parentNode:r}))return this.setCurSelection(),!0}pendingRecords(){if(this.observer)for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}flush(){let{view:e}=this;if(!e.docView||this.flushingSoon>-1)return;let t=this.pendingRecords();t.length&&(this.queue=[]);let r=e.domSelectionRange(),s=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(r)&&Eu(e)&&!this.ignoreSelectionChange(r),i=-1,o=-1,a=!1,l=[];if(e.editable)for(let d=0;d<t.length;d++){let h=this.registerMutation(t[d],l);h&&(i=i<0?h.from:Math.min(h.from,i),o=o<0?h.to:Math.max(h.to,o),h.typeOver&&(a=!0))}if(rt&&l.length){let d=l.filter(h=>h.nodeName=="BR");if(d.length==2){let[h,f]=d;h.parentNode&&h.parentNode.parentNode==f.parentNode?f.remove():h.remove()}else{let{focusNode:h}=this.currentSelection;for(let f of d){let p=f.parentNode;p&&p.nodeName=="LI"&&(!h||RS(e,h)!=p)&&f.remove()}}}else if((Te||De)&&l.some(d=>d.nodeName=="BR")&&(e.input.lastKeyCode==8||e.input.lastKeyCode==46)){for(let d of l)if(d.nodeName=="BR"&&d.parentNode){let h=d.nextSibling;h&&h.nodeType==1&&h.contentEditable=="false"&&d.parentNode.removeChild(d)}}let c=null;i<0&&s&&e.input.lastFocus>Date.now()-200&&Math.max(e.input.lastTouch,e.input.lastClick.time)<Date.now()-300&&Yo(r)&&(c=Mc(e))&&c.eq(G.near(e.state.doc.resolve(0),1))?(e.input.lastFocus=0,jt(e),this.currentSelection.set(r),e.scrollToSelection()):(i>-1||s)&&(i>-1&&(e.docView.markDirty(i,o),NS(e)),this.handleDOMChange(i,o,a,l),e.docView&&e.docView.dirty?e.updateState(e.state):this.currentSelection.eq(r)||jt(e),this.currentSelection.set(r))}registerMutation(e,t){if(t.indexOf(e.target)>-1)return null;let r=this.view.docView.nearestDesc(e.target);if(e.type=="attributes"&&(r==this.view.docView||e.attributeName=="contenteditable"||e.attributeName=="style"&&!e.oldValue&&!e.target.getAttribute("style"))||!r||r.ignoreMutation(e))return null;if(e.type=="childList"){for(let d=0;d<e.addedNodes.length;d++){let h=e.addedNodes[d];t.push(h),h.nodeType==3&&(this.lastChangedTextNode=h)}if(r.contentDOM&&r.contentDOM!=r.dom&&!r.contentDOM.contains(e.target))return{from:r.posBefore,to:r.posAfter};let s=e.previousSibling,i=e.nextSibling;if(ze&&dn<=11&&e.addedNodes.length)for(let d=0;d<e.addedNodes.length;d++){let{previousSibling:h,nextSibling:f}=e.addedNodes[d];(!h||Array.prototype.indexOf.call(e.addedNodes,h)<0)&&(s=h),(!f||Array.prototype.indexOf.call(e.addedNodes,f)<0)&&(i=f)}let o=s&&s.parentNode==e.target?Oe(s)+1:0,a=r.localPosFromDOM(e.target,o,-1),l=i&&i.parentNode==e.target?Oe(i):e.target.childNodes.length,c=r.localPosFromDOM(e.target,l,1);return{from:a,to:c}}else return e.type=="attributes"?{from:r.posAtStart-r.border,to:r.posAtEnd+r.border}:(this.lastChangedTextNode=e.target,{from:r.posAtStart,to:r.posAtEnd,typeOver:e.target.nodeValue==e.oldValue})}}let Pu=new WeakMap,Du=!1;function NS(n){if(!Pu.has(n)&&(Pu.set(n,null),["normal","nowrap","pre-line"].indexOf(getComputedStyle(n.dom).whiteSpace)!==-1)){if(n.requiresGeckoHackNode=rt,Du)return;console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."),Du=!0}}function Lu(n,e){let t=e.startContainer,r=e.startOffset,s=e.endContainer,i=e.endOffset,o=n.domAtPos(n.state.selection.anchor);return Gn(o.node,o.offset,s,i)&&([t,r,s,i]=[s,i,t,r]),{anchorNode:t,anchorOffset:r,focusNode:s,focusOffset:i}}function $S(n,e){if(e.getComposedRanges){let s=e.getComposedRanges(n.root)[0];if(s)return Lu(n,s)}let t;function r(s){s.preventDefault(),s.stopImmediatePropagation(),t=s.getTargetRanges()[0]}return n.dom.addEventListener("beforeinput",r,!0),document.execCommand("indent"),n.dom.removeEventListener("beforeinput",r,!0),t?Lu(n,t):null}function RS(n,e){for(let t=e.parentNode;t&&t!=n.dom;t=t.parentNode){let r=n.docView.nearestDesc(t,!0);if(r&&r.node.isBlock)return t}return null}function PS(n,e,t){let{node:r,fromOffset:s,toOffset:i,from:o,to:a}=n.docView.parseRange(e,t),l=n.domSelectionRange(),c,d=l.anchorNode;if(d&&n.dom.contains(d.nodeType==1?d:d.parentNode)&&(c=[{node:d,offset:l.anchorOffset}],Yo(l)||c.push({node:l.focusNode,offset:l.focusOffset})),Te&&n.input.lastKeyCode===8)for(let y=i;y>s;y--){let w=r.childNodes[y-1],v=w.pmViewDesc;if(w.nodeName=="BR"&&!v){i=y;break}if(!v||v.size)break}let h=n.state.doc,f=n.someProp("domParser")||cn.fromSchema(n.state.schema),p=h.resolve(o),m=null,g=f.parse(r,{topNode:p.parent,topMatch:p.parent.contentMatchAt(p.index()),topOpen:!0,from:s,to:i,preserveWhitespace:p.parent.type.whitespace=="pre"?"full":!0,findPositions:c,ruleFromNode:DS,context:p});if(c&&c[0].pos!=null){let y=c[0].pos,w=c[1]&&c[1].pos;w==null&&(w=y),m={anchor:y+o,head:w+o}}return{doc:g,sel:m,from:o,to:a}}function DS(n){let e=n.pmViewDesc;if(e)return e.parseRule();if(n.nodeName=="BR"&&n.parentNode){if(De&&/^(ul|ol)$/i.test(n.parentNode.nodeName)){let t=document.createElement("div");return t.appendChild(document.createElement("li")),{skip:t}}else if(n.parentNode.lastChild==n||De&&/^(tr|table)$/i.test(n.parentNode.nodeName))return{ignore:!0}}else if(n.nodeName=="IMG"&&n.getAttribute("mark-placeholder"))return{ignore:!0};return null}const LS=/^(a|abbr|acronym|b|bd[io]|big|br|button|cite|code|data(list)?|del|dfn|em|i|img|ins|kbd|label|map|mark|meter|output|q|ruby|s|samp|small|span|strong|su[bp]|time|u|tt|var)$/i;function jS(n,e,t,r,s){let i=n.input.compositionPendingChanges||(n.composing?n.input.compositionID:0);if(n.input.compositionPendingChanges=0,e<0){let x=n.input.lastSelectionTime>Date.now()-50?n.input.lastSelectionOrigin:null,E=Mc(n,x);if(E&&!n.state.selection.eq(E)){if(Te&&Dt&&n.input.lastKeyCode===13&&Date.now()-100<n.input.lastKeyCodeTime&&n.someProp("handleKeyDown",H=>H(n,On(13,"Enter"))))return;let N=n.state.tr.setSelection(E);x=="pointer"?N.setMeta("pointer",!0):x=="key"&&N.scrollIntoView(),i&&N.setMeta("composition",i),n.dispatch(N)}return}let o=n.state.doc.resolve(e),a=o.sharedDepth(t);e=o.before(a+1),t=n.state.doc.resolve(t).after(a+1);let l=n.state.selection,c=PS(n,e,t),d=n.state.doc,h=d.slice(c.from,c.to),f,p;n.input.lastKeyCode===8&&Date.now()-100<n.input.lastKeyCodeTime?(f=n.state.selection.to,p="end"):(f=n.state.selection.from,p="start"),n.input.lastKeyCode=null;let m=US(h.content,c.doc.content,c.from,f,p);if(m&&n.input.domChangeCount++,(Or&&n.input.lastIOSEnter>Date.now()-225||Dt)&&s.some(x=>x.nodeType==1&&!LS.test(x.nodeName))&&(!m||m.endA>=m.endB)&&n.someProp("handleKeyDown",x=>x(n,On(13,"Enter")))){n.input.lastIOSEnter=0;return}if(!m)if(r&&l instanceof z&&!l.empty&&l.$head.sameParent(l.$anchor)&&!n.composing&&!(c.sel&&c.sel.anchor!=c.sel.head))m={start:l.from,endA:l.to,endB:l.to};else{if(c.sel){let x=ju(n,n.state.doc,c.sel);if(x&&!x.eq(n.state.selection)){let E=n.state.tr.setSelection(x);i&&E.setMeta("composition",i),n.dispatch(E)}}return}n.state.selection.from<n.state.selection.to&&m.start==m.endB&&n.state.selection instanceof z&&(m.start>n.state.selection.from&&m.start<=n.state.selection.from+2&&n.state.selection.from>=c.from?m.start=n.state.selection.from:m.endA<n.state.selection.to&&m.endA>=n.state.selection.to-2&&n.state.selection.to<=c.to&&(m.endB+=n.state.selection.to-m.endA,m.endA=n.state.selection.to)),ze&&dn<=11&&m.endB==m.start+1&&m.endA==m.start&&m.start>c.from&&c.doc.textBetween(m.start-c.from-1,m.start-c.from+1)==" "&&(m.start--,m.endA--,m.endB--);let g=c.doc.resolveNoCache(m.start-c.from),y=c.doc.resolveNoCache(m.endB-c.from),w=d.resolve(m.start),v=g.sameParent(y)&&g.parent.inlineContent&&w.end()>=m.endA;if((Or&&n.input.lastIOSEnter>Date.now()-225&&(!v||s.some(x=>x.nodeName=="DIV"||x.nodeName=="P"))||!v&&g.pos<c.doc.content.size&&(!g.sameParent(y)||!g.parent.inlineContent)&&g.pos<y.pos&&!/\S/.test(c.doc.textBetween(g.pos,y.pos,"","")))&&n.someProp("handleKeyDown",x=>x(n,On(13,"Enter")))){n.input.lastIOSEnter=0;return}if(n.state.selection.anchor>m.start&&FS(d,m.start,m.endA,g,y)&&n.someProp("handleKeyDown",x=>x(n,On(8,"Backspace")))){Dt&&Te&&n.domObserver.suppressSelectionUpdates();return}Te&&m.endB==m.start&&(n.input.lastChromeDelete=Date.now()),Dt&&!v&&g.start()!=y.start()&&y.parentOffset==0&&g.depth==y.depth&&c.sel&&c.sel.anchor==c.sel.head&&c.sel.head==m.endA&&(m.endB-=2,y=c.doc.resolveNoCache(m.endB-c.from),setTimeout(()=>{n.someProp("handleKeyDown",function(x){return x(n,On(13,"Enter"))})},20));let b=m.start,S=m.endA,k=x=>{let E=x||n.state.tr.replace(b,S,c.doc.slice(m.start-c.from,m.endB-c.from));if(c.sel){let N=ju(n,E.doc,c.sel);N&&!(Te&&n.composing&&N.empty&&(m.start!=m.endB||n.input.lastChromeDelete<Date.now()-100)&&(N.head==b||N.head==E.mapping.map(S)-1)||ze&&N.empty&&N.head==b)&&E.setSelection(N)}return i&&E.setMeta("composition",i),E.scrollIntoView()},_;if(v)if(g.pos==y.pos){ze&&dn<=11&&g.parentOffset==0&&(n.domObserver.suppressSelectionUpdates(),setTimeout(()=>jt(n),20));let x=k(n.state.tr.delete(b,S)),E=d.resolve(m.start).marksAcross(d.resolve(m.endA));E&&x.ensureMarks(E),n.dispatch(x)}else if(m.endA==m.endB&&(_=BS(g.parent.content.cut(g.parentOffset,y.parentOffset),w.parent.content.cut(w.parentOffset,m.endA-w.start())))){let x=k(n.state.tr);_.type=="add"?x.addMark(b,S,_.mark):x.removeMark(b,S,_.mark),n.dispatch(x)}else if(g.parent.child(g.index()).isText&&g.index()==y.index()-(y.textOffset?0:1)){let x=g.parent.textBetween(g.parentOffset,y.parentOffset),E=()=>k(n.state.tr.insertText(x,b,S));n.someProp("handleTextInput",N=>N(n,b,S,x,E))||n.dispatch(E())}else n.dispatch(k());else n.dispatch(k())}function ju(n,e,t){return Math.max(t.anchor,t.head)>e.content.size?null:Ic(n,e.resolve(t.anchor),e.resolve(t.head))}function BS(n,e){let t=n.firstChild.marks,r=e.firstChild.marks,s=t,i=r,o,a,l;for(let d=0;d<r.length;d++)s=r[d].removeFromSet(s);for(let d=0;d<t.length;d++)i=t[d].removeFromSet(i);if(s.length==1&&i.length==0)a=s[0],o="add",l=d=>d.mark(a.addToSet(d.marks));else if(s.length==0&&i.length==1)a=i[0],o="remove",l=d=>d.mark(a.removeFromSet(d.marks));else return null;let c=[];for(let d=0;d<e.childCount;d++)c.push(l(e.child(d)));if(T.from(c).eq(n))return{mark:a,type:o}}function FS(n,e,t,r,s){if(t-e<=s.pos-r.pos||qa(r,!0,!1)<s.pos)return!1;let i=n.resolve(e);if(!r.parent.isTextblock){let a=i.nodeAfter;return a!=null&&t==e+a.nodeSize}if(i.parentOffset<i.parent.content.size||!i.parent.isTextblock)return!1;let o=n.resolve(qa(i,!0,!0));return!o.parent.isTextblock||o.pos>t||qa(o,!0,!1)<t?!1:r.parent.content.cut(r.parentOffset).eq(o.parent.content)}function qa(n,e,t){let r=n.depth,s=e?n.end():n.pos;for(;r>0&&(e||n.indexAfter(r)==n.node(r).childCount);)r--,s++,e=!1;if(t){let i=n.node(r).maybeChild(n.indexAfter(r));for(;i&&!i.isLeaf;)i=i.firstChild,s++}return s}function US(n,e,t,r,s){let i=n.findDiffStart(e,t);if(i==null)return null;let{a:o,b:a}=n.findDiffEnd(e,t+n.size,t+e.size);if(s=="end"){let l=Math.max(0,i-Math.min(o,a));r-=o+l-i}if(o<i&&n.size<e.size){let l=r<=i&&r>=o?i-r:0;i-=l,i&&i<e.size&&Bu(e.textBetween(i-1,i+1))&&(i+=l?1:-1),a=i+(a-o),o=i}else if(a<i){let l=r<=i&&r>=a?i-r:0;i-=l,i&&i<n.size&&Bu(n.textBetween(i-1,i+1))&&(i+=l?1:-1),o=i+(o-a),a=i}return{start:i,endA:o,endB:a}}function Bu(n){if(n.length!=2)return!1;let e=n.charCodeAt(0),t=n.charCodeAt(1);return e>=56320&&e<=57343&&t>=55296&&t<=56319}class Pp{constructor(e,t){this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new sS,this.prevDirectPlugins=[],this.pluginViews=[],this.requiresGeckoHackNode=!1,this.dragging=null,this._props=t,this.state=t.state,this.directPlugins=t.plugins||[],this.directPlugins.forEach(Vu),this.dispatch=this.dispatch.bind(this),this.dom=e&&e.mount||document.createElement("div"),e&&(e.appendChild?e.appendChild(this.dom):typeof e=="function"?e(this.dom):e.mount&&(this.mounted=!0)),this.editable=zu(this),Uu(this),this.nodeViews=Hu(this),this.docView=vu(this.state.doc,Fu(this),Va(this),this.dom,this),this.domObserver=new OS(this,(r,s,i,o)=>jS(this,r,s,i,o)),this.domObserver.start(),iS(this),this.updatePluginViews()}get composing(){return this.input.composing}get props(){if(this._props.state!=this.state){let e=this._props;this._props={};for(let t in e)this._props[t]=e[t];this._props.state=this.state}return this._props}update(e){e.handleDOMEvents!=this._props.handleDOMEvents&&Ul(this);let t=this._props;this._props=e,e.plugins&&(e.plugins.forEach(Vu),this.directPlugins=e.plugins),this.updateStateInner(e.state,t)}setProps(e){let t={};for(let r in this._props)t[r]=this._props[r];t.state=this.state;for(let r in e)t[r]=e[r];this.update(t)}updateState(e){this.updateStateInner(e,this._props)}updateStateInner(e,t){var r;let s=this.state,i=!1,o=!1;e.storedMarks&&this.composing&&(Ap(this),o=!0),this.state=e;let a=s.plugins!=e.plugins||this._props.plugins!=t.plugins;if(a||this._props.plugins!=t.plugins||this._props.nodeViews!=t.nodeViews){let p=Hu(this);HS(p,this.nodeViews)&&(this.nodeViews=p,i=!0)}(a||t.handleDOMEvents!=this._props.handleDOMEvents)&&Ul(this),this.editable=zu(this),Uu(this);let l=Va(this),c=Fu(this),d=s.plugins!=e.plugins&&!s.doc.eq(e.doc)?"reset":e.scrollToSelection>s.scrollToSelection?"to selection":"preserve",h=i||!this.docView.matchesNode(e.doc,c,l);(h||!e.selection.eq(s.selection))&&(o=!0);let f=d=="preserve"&&o&&this.dom.style.overflowAnchor==null&&b0(this);if(o){this.domObserver.stop();let p=h&&(ze||Te)&&!this.composing&&!s.selection.empty&&!e.selection.empty&&zS(s.selection,e.selection);if(h){let m=Te?this.trackWrites=this.domSelectionRange().focusNode:null;this.composing&&(this.input.compositionNode=bS(this)),(i||!this.docView.update(e.doc,c,l,this))&&(this.docView.updateOuterDeco(c),this.docView.destroy(),this.docView=vu(e.doc,c,l,this.dom,this)),m&&!this.trackWrites&&(p=!0)}p||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelectionRange())&&H0(this))?jt(this,p):(gp(this,e.selection),this.domObserver.setCurSelection()),this.domObserver.start()}this.updatePluginViews(s),!((r=this.dragging)===null||r===void 0)&&r.node&&!s.doc.eq(e.doc)&&this.updateDraggedNode(this.dragging,s),d=="reset"?this.dom.scrollTop=0:d=="to selection"?this.scrollToSelection():f&&v0(f)}scrollToSelection(){let e=this.domSelectionRange().focusNode;if(!(!e||!this.dom.contains(e.nodeType==1?e:e.parentNode))){if(!this.someProp("handleScrollToSelection",t=>t(this)))if(this.state.selection instanceof D){let t=this.docView.domAfterPos(this.state.selection.from);t.nodeType==1&&pu(this,t.getBoundingClientRect(),e)}else pu(this,this.coordsAtPos(this.state.selection.head,1),e)}}destroyPluginViews(){let e;for(;e=this.pluginViews.pop();)e.destroy&&e.destroy()}updatePluginViews(e){if(!e||e.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(let t=0;t<this.directPlugins.length;t++){let r=this.directPlugins[t];r.spec.view&&this.pluginViews.push(r.spec.view(this))}for(let t=0;t<this.state.plugins.length;t++){let r=this.state.plugins[t];r.spec.view&&this.pluginViews.push(r.spec.view(this))}}else for(let t=0;t<this.pluginViews.length;t++){let r=this.pluginViews[t];r.update&&r.update(this,e)}}updateDraggedNode(e,t){let r=e.node,s=-1;if(this.state.doc.nodeAt(r.from)==r.node)s=r.from;else{let i=r.from+(this.state.doc.content.size-t.doc.content.size);(i>0&&this.state.doc.nodeAt(i))==r.node&&(s=i)}this.dragging=new Ip(e.slice,e.move,s<0?void 0:D.create(this.state.doc,s))}someProp(e,t){let r=this._props&&this._props[e],s;if(r!=null&&(s=t?t(r):r))return s;for(let o=0;o<this.directPlugins.length;o++){let a=this.directPlugins[o].props[e];if(a!=null&&(s=t?t(a):a))return s}let i=this.state.plugins;if(i)for(let o=0;o<i.length;o++){let a=i[o].props[e];if(a!=null&&(s=t?t(a):a))return s}}hasFocus(){if(ze){let e=this.root.activeElement;if(e==this.dom)return!0;if(!e||!this.dom.contains(e))return!1;for(;e&&this.dom!=e&&this.dom.contains(e);){if(e.contentEditable=="false")return!1;e=e.parentElement}return!0}return this.root.activeElement==this.dom}focus(){this.domObserver.stop(),this.editable&&k0(this.dom),jt(this),this.domObserver.start()}get root(){let e=this._root;if(e==null){for(let t=this.dom.parentNode;t;t=t.parentNode)if(t.nodeType==9||t.nodeType==11&&t.host)return t.getSelection||(Object.getPrototypeOf(t).getSelection=()=>t.ownerDocument.getSelection()),this._root=t}return e||document}updateRoot(){this._root=null}posAtCoords(e){return E0(this,e)}coordsAtPos(e,t=1){return lp(this,e,t)}domAtPos(e,t=0){return this.docView.domFromPos(e,t)}nodeDOM(e){let t=this.docView.descAt(e);return t?t.nodeDOM:null}posAtDOM(e,t,r=-1){let s=this.docView.posFromDOM(e,t,r);if(s==null)throw new RangeError("DOM position not inside the editor");return s}endOfTextblock(e,t){return O0(this,t||this.state,e)}pasteHTML(e,t){return Ms(this,"",e,!1,t||new ClipboardEvent("paste"))}pasteText(e,t){return Ms(this,e,null,!0,t||new ClipboardEvent("paste"))}serializeForClipboard(e){return Oc(this,e)}destroy(){this.docView&&(oS(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],Va(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null,c0())}get isDestroyed(){return this.docView==null}dispatchEvent(e){return lS(this,e)}domSelectionRange(){let e=this.domSelection();return e?De&&this.root.nodeType===11&&p0(this.dom.ownerDocument)==this.dom&&$S(this,e)||e:{focusNode:null,focusOffset:0,anchorNode:null,anchorOffset:0}}domSelection(){return this.root.getSelection()}}Pp.prototype.dispatch=function(n){let e=this._props.dispatchTransaction;e?e.call(this,n):this.updateState(this.state.apply(n))};function Fu(n){let e=Object.create(null);return e.class="ProseMirror",e.contenteditable=String(n.editable),n.someProp("attributes",t=>{if(typeof t=="function"&&(t=t(n.state)),t)for(let r in t)r=="class"?e.class+=" "+t[r]:r=="style"?e.style=(e.style?e.style+";":"")+t[r]:!e[r]&&r!="contenteditable"&&r!="nodeName"&&(e[r]=String(t[r]))}),e.translate||(e.translate="no"),[Pe.node(0,n.state.doc.content.size,e)]}function Uu(n){if(n.markCursor){let e=document.createElement("img");e.className="ProseMirror-separator",e.setAttribute("mark-placeholder","true"),e.setAttribute("alt",""),n.cursorWrapper={dom:e,deco:Pe.widget(n.state.selection.from,e,{raw:!0,marks:n.markCursor})}}else n.cursorWrapper=null}function zu(n){return!n.someProp("editable",e=>e(n.state)===!1)}function zS(n,e){let t=Math.min(n.$anchor.sharedDepth(n.head),e.$anchor.sharedDepth(e.head));return n.$anchor.start(t)!=e.$anchor.start(t)}function Hu(n){let e=Object.create(null);function t(r){for(let s in r)Object.prototype.hasOwnProperty.call(e,s)||(e[s]=r[s])}return n.someProp("nodeViews",t),n.someProp("markViews",t),e}function HS(n,e){let t=0,r=0;for(let s in n){if(n[s]!=e[s])return!0;t++}for(let s in e)r++;return t!=r}function Vu(n){if(n.spec.state||n.spec.filterTransaction||n.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}var pn={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Yi={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},VS=typeof navigator<"u"&&/Mac/.test(navigator.platform),qS=typeof navigator<"u"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);for(var Ne=0;Ne<10;Ne++)pn[48+Ne]=pn[96+Ne]=String(Ne);for(var Ne=1;Ne<=24;Ne++)pn[Ne+111]="F"+Ne;for(var Ne=65;Ne<=90;Ne++)pn[Ne]=String.fromCharCode(Ne+32),Yi[Ne]=String.fromCharCode(Ne);for(var Wa in pn)Yi.hasOwnProperty(Wa)||(Yi[Wa]=pn[Wa]);function WS(n){var e=VS&&n.metaKey&&n.shiftKey&&!n.ctrlKey&&!n.altKey||qS&&n.shiftKey&&n.key&&n.key.length==1||n.key=="Unidentified",t=!e&&n.key||(n.shiftKey?Yi:pn)[n.keyCode]||n.key||"Unidentified";return t=="Esc"&&(t="Escape"),t=="Del"&&(t="Delete"),t=="Left"&&(t="ArrowLeft"),t=="Up"&&(t="ArrowUp"),t=="Right"&&(t="ArrowRight"),t=="Down"&&(t="ArrowDown"),t}const KS=typeof navigator<"u"&&/Mac|iP(hone|[oa]d)/.test(navigator.platform),GS=typeof navigator<"u"&&/Win/.test(navigator.platform);function JS(n){let e=n.split(/-(?!$)/),t=e[e.length-1];t=="Space"&&(t=" ");let r,s,i,o;for(let a=0;a<e.length-1;a++){let l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))r=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))i=!0;else if(/^mod$/i.test(l))KS?o=!0:s=!0;else throw new Error("Unrecognized modifier name: "+l)}return r&&(t="Alt-"+t),s&&(t="Ctrl-"+t),o&&(t="Meta-"+t),i&&(t="Shift-"+t),t}function YS(n){let e=Object.create(null);for(let t in n)e[JS(t)]=n[t];return e}function Ka(n,e,t=!0){return e.altKey&&(n="Alt-"+n),e.ctrlKey&&(n="Ctrl-"+n),e.metaKey&&(n="Meta-"+n),t&&e.shiftKey&&(n="Shift-"+n),n}function XS(n){return new le({props:{handleKeyDown:Dp(n)}})}function Dp(n){let e=YS(n);return function(t,r){let s=WS(r),i,o=e[Ka(s,r)];if(o&&o(t.state,t.dispatch,t))return!0;if(s.length==1&&s!=" "){if(r.shiftKey){let a=e[Ka(s,r,!1)];if(a&&a(t.state,t.dispatch,t))return!0}if((r.altKey||r.metaKey||r.ctrlKey)&&!(GS&&r.ctrlKey&&r.altKey)&&(i=pn[r.keyCode])&&i!=s){let a=e[Ka(i,r)];if(a&&a(t.state,t.dispatch,t))return!0}}return!1}}var QS=Object.defineProperty,Lc=(n,e)=>{for(var t in e)QS(n,t,{get:e[t],enumerable:!0})};function Zo(n){const{state:e,transaction:t}=n;let{selection:r}=t,{doc:s}=t,{storedMarks:i}=t;return{...e,apply:e.apply.bind(e),applyTransaction:e.applyTransaction.bind(e),plugins:e.plugins,schema:e.schema,reconfigure:e.reconfigure.bind(e),toJSON:e.toJSON.bind(e),get storedMarks(){return i},get selection(){return r},get doc(){return s},get tr(){return r=t.selection,s=t.doc,i=t.storedMarks,t}}}var ea=class{constructor(n){this.editor=n.editor,this.rawCommands=this.editor.extensionManager.commands,this.customState=n.state}get hasCustomState(){return!!this.customState}get state(){return this.customState||this.editor.state}get commands(){const{rawCommands:n,editor:e,state:t}=this,{view:r}=e,{tr:s}=t,i=this.buildProps(s);return Object.fromEntries(Object.entries(n).map(([o,a])=>[o,(...c)=>{const d=a(...c)(i);return!s.getMeta("preventDispatch")&&!this.hasCustomState&&r.dispatch(s),d}]))}get chain(){return()=>this.createChain()}get can(){return()=>this.createCan()}createChain(n,e=!0){const{rawCommands:t,editor:r,state:s}=this,{view:i}=r,o=[],a=!!n,l=n||s.tr,c=()=>(!a&&e&&!l.getMeta("preventDispatch")&&!this.hasCustomState&&i.dispatch(l),o.every(h=>h===!0)),d={...Object.fromEntries(Object.entries(t).map(([h,f])=>[h,(...m)=>{const g=this.buildProps(l,e),y=f(...m)(g);return o.push(y),d}])),run:c};return d}createCan(n){const{rawCommands:e,state:t}=this,r=!1,s=n||t.tr,i=this.buildProps(s,r);return{...Object.fromEntries(Object.entries(e).map(([a,l])=>[a,(...c)=>l(...c)({...i,dispatch:void 0})])),chain:()=>this.createChain(s,r)}}buildProps(n,e=!0){const{rawCommands:t,editor:r,state:s}=this,{view:i}=r,o={tr:n,editor:r,view:i,state:Zo({state:s,transaction:n}),dispatch:e?()=>{}:void 0,chain:()=>this.createChain(n,e),can:()=>this.createCan(n),get commands(){return Object.fromEntries(Object.entries(t).map(([a,l])=>[a,(...c)=>l(...c)(o)]))}};return o}},Lp={};Lc(Lp,{blur:()=>ZS,clearContent:()=>e_,clearNodes:()=>t_,command:()=>n_,createParagraphNear:()=>r_,cut:()=>s_,deleteCurrentNode:()=>i_,deleteNode:()=>o_,deleteRange:()=>a_,deleteSelection:()=>l_,enter:()=>c_,exitCode:()=>d_,extendMarkRange:()=>u_,first:()=>h_,focus:()=>p_,forEach:()=>m_,insertContent:()=>g_,insertContentAt:()=>b_,joinBackward:()=>S_,joinDown:()=>k_,joinForward:()=>__,joinItemBackward:()=>x_,joinItemForward:()=>T_,joinTextblockBackward:()=>E_,joinTextblockForward:()=>C_,joinUp:()=>v_,keyboardShortcut:()=>M_,lift:()=>I_,liftEmptyBlock:()=>O_,liftListItem:()=>N_,newlineInCode:()=>$_,resetAttributes:()=>R_,scrollIntoView:()=>P_,selectAll:()=>D_,selectNodeBackward:()=>L_,selectNodeForward:()=>j_,selectParentNode:()=>B_,selectTextblockEnd:()=>F_,selectTextblockStart:()=>U_,setContent:()=>z_,setMark:()=>lx,setMeta:()=>cx,setNode:()=>dx,setNodeSelection:()=>ux,setTextDirection:()=>hx,setTextSelection:()=>fx,sinkListItem:()=>px,splitBlock:()=>mx,splitListItem:()=>gx,toggleList:()=>yx,toggleMark:()=>wx,toggleNode:()=>bx,toggleWrap:()=>vx,undoInputRule:()=>kx,unsetAllMarks:()=>Sx,unsetMark:()=>_x,unsetTextDirection:()=>xx,updateAttributes:()=>Tx,wrapIn:()=>Ex,wrapInList:()=>Cx});var ZS=()=>({editor:n,view:e})=>(requestAnimationFrame(()=>{var t;n.isDestroyed||(e.dom.blur(),(t=window?.getSelection())==null||t.removeAllRanges())}),!0),e_=(n=!0)=>({commands:e})=>e.setContent("",{emitUpdate:n}),t_=()=>({state:n,tr:e,dispatch:t})=>{const{selection:r}=e,{ranges:s}=r;return t&&s.forEach(({$from:i,$to:o})=>{n.doc.nodesBetween(i.pos,o.pos,(a,l)=>{if(a.type.isText)return;const{doc:c,mapping:d}=e,h=c.resolve(d.map(l)),f=c.resolve(d.map(l+a.nodeSize)),p=h.blockRange(f);if(!p)return;const m=jr(p);if(a.type.isTextblock){const{defaultType:g}=h.parent.contentMatchAt(h.index());e.setNodeMarkup(p.start,g)}(m||m===0)&&e.lift(p,m)})}),!0},n_=n=>e=>n(e),r_=()=>({state:n,dispatch:e})=>Xf(n,e),s_=(n,e)=>({editor:t,tr:r})=>{const{state:s}=t,i=s.doc.slice(n.from,n.to);r.deleteRange(n.from,n.to);const o=r.mapping.map(e);return r.insert(o,i.content),r.setSelection(new z(r.doc.resolve(Math.max(o-1,0)))),!0},i_=()=>({tr:n,dispatch:e})=>{const{selection:t}=n,r=t.$anchor.node();if(r.content.size>0)return!1;const s=n.selection.$anchor;for(let i=s.depth;i>0;i-=1)if(s.node(i).type===r.type){if(e){const a=s.before(i),l=s.after(i);n.delete(a,l).scrollIntoView()}return!0}return!1};function ve(n,e){if(typeof n=="string"){if(!e.nodes[n])throw Error(`There is no node type named '${n}'. Maybe you forgot to add the extension?`);return e.nodes[n]}return n}var o_=n=>({tr:e,state:t,dispatch:r})=>{const s=ve(n,t.schema),i=e.selection.$anchor;for(let o=i.depth;o>0;o-=1)if(i.node(o).type===s){if(r){const l=i.before(o),c=i.after(o);e.delete(l,c).scrollIntoView()}return!0}return!1},a_=n=>({tr:e,dispatch:t})=>{const{from:r,to:s}=n;return t&&e.delete(r,s),!0},l_=()=>({state:n,dispatch:e})=>_c(n,e),c_=()=>({commands:n})=>n.keyboardShortcut("Enter"),d_=()=>({state:n,dispatch:e})=>Gk(n,e);function jc(n){return Object.prototype.toString.call(n)==="[object RegExp]"}function Xi(n,e,t={strict:!0}){const r=Object.keys(e);return r.length?r.every(s=>t.strict?e[s]===n[s]:jc(e[s])?e[s].test(n[s]):e[s]===n[s]):!0}function jp(n,e,t={}){return n.find(r=>r.type===e&&Xi(Object.fromEntries(Object.keys(t).map(s=>[s,r.attrs[s]])),t))}function qu(n,e,t={}){return!!jp(n,e,t)}function Bc(n,e,t){var r;if(!n||!e)return;let s=n.parent.childAfter(n.parentOffset);if((!s.node||!s.node.marks.some(d=>d.type===e))&&(s=n.parent.childBefore(n.parentOffset)),!s.node||!s.node.marks.some(d=>d.type===e)||(t=t||((r=s.node.marks[0])==null?void 0:r.attrs),!jp([...s.node.marks],e,t)))return;let o=s.index,a=n.start()+s.offset,l=o+1,c=a+s.node.nodeSize;for(;o>0&&qu([...n.parent.child(o-1).marks],e,t);)o-=1,a-=n.parent.child(o).nodeSize;for(;l<n.parent.childCount&&qu([...n.parent.child(l).marks],e,t);)c+=n.parent.child(l).nodeSize,l+=1;return{from:a,to:c}}function qt(n,e){if(typeof n=="string"){if(!e.marks[n])throw Error(`There is no mark type named '${n}'. Maybe you forgot to add the extension?`);return e.marks[n]}return n}var u_=(n,e={})=>({tr:t,state:r,dispatch:s})=>{const i=qt(n,r.schema),{doc:o,selection:a}=t,{$from:l,from:c,to:d}=a;if(s){const h=Bc(l,i,e);if(h&&h.from<=c&&h.to>=d){const f=z.create(o,h.from,h.to);t.setSelection(f)}}return!0},h_=n=>e=>{const t=typeof n=="function"?n(e):n;for(let r=0;r<t.length;r+=1)if(t[r](e))return!0;return!1};function Bp(n){return n instanceof z}function Pn(n=0,e=0,t=0){return Math.min(Math.max(n,e),t)}function Fp(n,e=null){if(!e)return null;const t=G.atStart(n),r=G.atEnd(n);if(e==="start"||e===!0)return t;if(e==="end")return r;const s=t.from,i=r.to;return e==="all"?z.create(n,Pn(0,s,i),Pn(n.content.size,s,i)):z.create(n,Pn(e,s,i),Pn(e,s,i))}function Wu(){return navigator.platform==="Android"||/android/i.test(navigator.userAgent)}function Qi(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function f_(){return typeof navigator<"u"?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}var p_=(n=null,e={})=>({editor:t,view:r,tr:s,dispatch:i})=>{e={scrollIntoView:!0,...e};const o=()=>{(Qi()||Wu())&&r.dom.focus(),f_()&&!Qi()&&!Wu()&&r.dom.focus({preventScroll:!0}),requestAnimationFrame(()=>{t.isDestroyed||(r.focus(),e?.scrollIntoView&&t.commands.scrollIntoView())})};if(r.hasFocus()&&n===null||n===!1)return!0;if(i&&n===null&&!Bp(t.state.selection))return o(),!0;const a=Fp(s.doc,n)||t.state.selection,l=t.state.selection.eq(a);return i&&(l||s.setSelection(a),l&&s.storedMarks&&s.setStoredMarks(s.storedMarks),o()),!0},m_=(n,e)=>t=>n.every((r,s)=>e(r,{...t,index:s})),g_=(n,e)=>({tr:t,commands:r})=>r.insertContentAt({from:t.selection.from,to:t.selection.to},n,e),Up=n=>{const e=n.childNodes;for(let t=e.length-1;t>=0;t-=1){const r=e[t];r.nodeType===3&&r.nodeValue&&/^(\n\s\s|\n)$/.test(r.nodeValue)?n.removeChild(r):r.nodeType===1&&Up(r)}return n};function pi(n){if(typeof window>"u")throw new Error("[tiptap error]: there is no window object available, so this function cannot be used");const e=`<body>${n}</body>`,t=new window.DOMParser().parseFromString(e,"text/html").body;return Up(t)}function Os(n,e,t){if(n instanceof pt||n instanceof T)return n;t={slice:!0,parseOptions:{},...t};const r=typeof n=="object"&&n!==null,s=typeof n=="string";if(r)try{if(Array.isArray(n)&&n.length>0)return T.fromArray(n.map(a=>e.nodeFromJSON(a)));const o=e.nodeFromJSON(n);return t.errorOnInvalidContent&&o.check(),o}catch(i){if(t.errorOnInvalidContent)throw new Error("[tiptap error]: Invalid JSON content",{cause:i});return console.warn("[tiptap warn]: Invalid content.","Passed value:",n,"Error:",i),Os("",e,t)}if(s){if(t.errorOnInvalidContent){let o=!1,a="";const l=new xf({topNode:e.spec.topNode,marks:e.spec.marks,nodes:e.spec.nodes.append({__tiptap__private__unknown__catch__all__node:{content:"inline*",group:"block",parseDOM:[{tag:"*",getAttrs:c=>(o=!0,a=typeof c=="string"?c:c.outerHTML,null)}]}})});if(t.slice?cn.fromSchema(l).parseSlice(pi(n),t.parseOptions):cn.fromSchema(l).parse(pi(n),t.parseOptions),t.errorOnInvalidContent&&o)throw new Error("[tiptap error]: Invalid HTML content",{cause:new Error(`Invalid element found: ${a}`)})}const i=cn.fromSchema(e);return t.slice?i.parseSlice(pi(n),t.parseOptions).content:i.parse(pi(n),t.parseOptions)}return Os("",e,t)}function y_(n,e,t){const r=n.steps.length-1;if(r<e)return;const s=n.steps[r];if(!(s instanceof xe||s instanceof Ee))return;const i=n.mapping.maps[r];let o=0;i.forEach((a,l,c,d)=>{o===0&&(o=d)}),n.setSelection(G.near(n.doc.resolve(o),t))}var w_=n=>!("type"in n),b_=(n,e,t)=>({tr:r,dispatch:s,editor:i})=>{var o;if(s){t={parseOptions:i.options.parseOptions,updateSelection:!0,applyInputRules:!1,applyPasteRules:!1,...t};let a;const l=y=>{i.emit("contentError",{editor:i,error:y,disableCollaboration:()=>{"collaboration"in i.storage&&typeof i.storage.collaboration=="object"&&i.storage.collaboration&&(i.storage.collaboration.isDisabled=!0)}})},c={preserveWhitespace:"full",...t.parseOptions};if(!t.errorOnInvalidContent&&!i.options.enableContentCheck&&i.options.emitContentError)try{Os(e,i.schema,{parseOptions:c,errorOnInvalidContent:!0})}catch(y){l(y)}try{a=Os(e,i.schema,{parseOptions:c,errorOnInvalidContent:(o=t.errorOnInvalidContent)!=null?o:i.options.enableContentCheck})}catch(y){return l(y),!1}let{from:d,to:h}=typeof n=="number"?{from:n,to:n}:{from:n.from,to:n.to},f=!0,p=!0;if((w_(a)?a:[a]).forEach(y=>{y.check(),f=f?y.isText&&y.marks.length===0:!1,p=p?y.isBlock:!1}),d===h&&p){const{parent:y}=r.doc.resolve(d);y.isTextblock&&!y.type.spec.code&&!y.childCount&&(d-=1,h+=1)}let g;if(f){if(Array.isArray(e))g=e.map(y=>y.text||"").join("");else if(e instanceof T){let y="";e.forEach(w=>{w.text&&(y+=w.text)}),g=y}else typeof e=="object"&&e&&e.text?g=e.text:g=e;r.insertText(g,d,h)}else{g=a;const y=r.doc.resolve(d),w=y.node(),v=y.parentOffset===0,b=w.isText||w.isTextblock,S=w.content.size>0;v&&b&&S&&(d=Math.max(0,d-1)),r.replaceWith(d,h,g)}t.updateSelection&&y_(r,r.steps.length-1,-1),t.applyInputRules&&r.setMeta("applyInputRules",{from:d,text:g}),t.applyPasteRules&&r.setMeta("applyPasteRules",{from:d,text:g})}return!0},v_=()=>({state:n,dispatch:e})=>qk(n,e),k_=()=>({state:n,dispatch:e})=>Wk(n,e),S_=()=>({state:n,dispatch:e})=>Vf(n,e),__=()=>({state:n,dispatch:e})=>Gf(n,e),x_=()=>({state:n,dispatch:e,tr:t})=>{try{const r=Ko(n.doc,n.selection.$from.pos,-1);return r==null?!1:(t.join(r,2),e&&e(t),!0)}catch{return!1}},T_=()=>({state:n,dispatch:e,tr:t})=>{try{const r=Ko(n.doc,n.selection.$from.pos,1);return r==null?!1:(t.join(r,2),e&&e(t),!0)}catch{return!1}},E_=()=>({state:n,dispatch:e})=>Hk(n,e),C_=()=>({state:n,dispatch:e})=>Vk(n,e);function zp(){return typeof navigator<"u"?/Mac/.test(navigator.platform):!1}function A_(n){const e=n.split(/-(?!$)/);let t=e[e.length-1];t==="Space"&&(t=" ");let r,s,i,o;for(let a=0;a<e.length-1;a+=1){const l=e[a];if(/^(cmd|meta|m)$/i.test(l))o=!0;else if(/^a(lt)?$/i.test(l))r=!0;else if(/^(c|ctrl|control)$/i.test(l))s=!0;else if(/^s(hift)?$/i.test(l))i=!0;else if(/^mod$/i.test(l))Qi()||zp()?o=!0:s=!0;else throw new Error(`Unrecognized modifier name: ${l}`)}return r&&(t=`Alt-${t}`),s&&(t=`Ctrl-${t}`),o&&(t=`Meta-${t}`),i&&(t=`Shift-${t}`),t}var M_=n=>({editor:e,view:t,tr:r,dispatch:s})=>{const i=A_(n).split(/-(?!$)/),o=i.find(c=>!["Alt","Ctrl","Meta","Shift"].includes(c)),a=new KeyboardEvent("keydown",{key:o==="Space"?" ":o,altKey:i.includes("Alt"),ctrlKey:i.includes("Ctrl"),metaKey:i.includes("Meta"),shiftKey:i.includes("Shift"),bubbles:!0,cancelable:!0}),l=e.captureTransaction(()=>{t.someProp("handleKeyDown",c=>c(t,a))});return l?.steps.forEach(c=>{const d=c.map(r.mapping);d&&s&&r.maybeStep(d)}),!0};function mn(n,e,t={}){const{from:r,to:s,empty:i}=n.selection,o=e?ve(e,n.schema):null,a=[];n.doc.nodesBetween(r,s,(h,f)=>{if(h.isText)return;const p=Math.max(r,f),m=Math.min(s,f+h.nodeSize);a.push({node:h,from:p,to:m})});const l=s-r,c=a.filter(h=>o?o.name===h.node.type.name:!0).filter(h=>Xi(h.node.attrs,t,{strict:!1}));return i?!!c.length:c.reduce((h,f)=>h+f.to-f.from,0)>=l}var I_=(n,e={})=>({state:t,dispatch:r})=>{const s=ve(n,t.schema);return mn(t,s,e)?Kk(t,r):!1},O_=()=>({state:n,dispatch:e})=>Qf(n,e),N_=n=>({state:e,dispatch:t})=>{const r=ve(n,e.schema);return i0(r)(e,t)},$_=()=>({state:n,dispatch:e})=>Yf(n,e);function ta(n,e){return e.nodes[n]?"node":e.marks[n]?"mark":null}function Ku(n,e){const t=typeof e=="string"?[e]:e;return Object.keys(n).reduce((r,s)=>(t.includes(s)||(r[s]=n[s]),r),{})}var R_=(n,e)=>({tr:t,state:r,dispatch:s})=>{let i=null,o=null;const a=ta(typeof n=="string"?n:n.name,r.schema);if(!a)return!1;a==="node"&&(i=ve(n,r.schema)),a==="mark"&&(o=qt(n,r.schema));let l=!1;return t.selection.ranges.forEach(c=>{r.doc.nodesBetween(c.$from.pos,c.$to.pos,(d,h)=>{i&&i===d.type&&(l=!0,s&&t.setNodeMarkup(h,void 0,Ku(d.attrs,e))),o&&d.marks.length&&d.marks.forEach(f=>{o===f.type&&(l=!0,s&&t.addMark(h,h+d.nodeSize,o.create(Ku(f.attrs,e))))})})}),l},P_=()=>({tr:n,dispatch:e})=>(e&&n.scrollIntoView(),!0),D_=()=>({tr:n,dispatch:e})=>{if(e){const t=new Je(n.doc);n.setSelection(t)}return!0},L_=()=>({state:n,dispatch:e})=>Wf(n,e),j_=()=>({state:n,dispatch:e})=>Jf(n,e),B_=()=>({state:n,dispatch:e})=>Xk(n,e),F_=()=>({state:n,dispatch:e})=>e0(n,e),U_=()=>({state:n,dispatch:e})=>Zk(n,e);function zl(n,e,t={},r={}){return Os(n,e,{slice:!1,parseOptions:t,errorOnInvalidContent:r.errorOnInvalidContent})}var z_=(n,{errorOnInvalidContent:e,emitUpdate:t=!0,parseOptions:r={}}={})=>({editor:s,tr:i,dispatch:o,commands:a})=>{const{doc:l}=i;if(r.preserveWhitespace!=="full"){const c=zl(n,s.schema,r,{errorOnInvalidContent:e??s.options.enableContentCheck});return o&&i.replaceWith(0,l.content.size,c).setMeta("preventUpdate",!t),!0}return o&&i.setMeta("preventUpdate",!t),a.insertContentAt({from:0,to:l.content.size},n,{parseOptions:r,errorOnInvalidContent:e??s.options.enableContentCheck})};function Hp(n,e){const t=qt(e,n.schema),{from:r,to:s,empty:i}=n.selection,o=[];i?(n.storedMarks&&o.push(...n.storedMarks),o.push(...n.selection.$head.marks())):n.doc.nodesBetween(r,s,l=>{o.push(...l.marks)});const a=o.find(l=>l.type.name===t.name);return a?{...a.attrs}:{}}function Vp(n,e){const t=new Ff(n);return e.forEach(r=>{r.steps.forEach(s=>{t.step(s)})}),t}function H_(n){for(let e=0;e<n.edgeCount;e+=1){const{type:t}=n.edge(e);if(t.isTextblock&&!t.hasRequiredAttrs())return t}return null}function V_(n,e,t){const r=[];return n.nodesBetween(e.from,e.to,(s,i)=>{t(s)&&r.push({node:s,pos:i})}),r}function q_(n,e){for(let t=n.depth;t>0;t-=1){const r=n.node(t);if(e(r))return{pos:t>0?n.before(t):0,start:n.start(t),depth:t,node:r}}}function na(n){return e=>q_(e.$from,n)}function R(n,e,t){return n.config[e]===void 0&&n.parent?R(n.parent,e,t):typeof n.config[e]=="function"?n.config[e].bind({...t,parent:n.parent?R(n.parent,e,t):null}):n.config[e]}function Fc(n){return n.map(e=>{const t={name:e.name,options:e.options,storage:e.storage},r=R(e,"addExtensions",t);return r?[e,...Fc(r())]:e}).flat(10)}function Uc(n,e){const t=er.fromSchema(e).serializeFragment(n),s=document.implementation.createHTMLDocument().createElement("div");return s.appendChild(t),s.innerHTML}function qp(n){return typeof n=="function"}function Z(n,e=void 0,...t){return qp(n)?e?n.bind(e)(...t):n(...t):n}function W_(n={}){return Object.keys(n).length===0&&n.constructor===Object}function Nr(n){const e=n.filter(s=>s.type==="extension"),t=n.filter(s=>s.type==="node"),r=n.filter(s=>s.type==="mark");return{baseExtensions:e,nodeExtensions:t,markExtensions:r}}function Wp(n){const e=[],{nodeExtensions:t,markExtensions:r}=Nr(n),s=[...t,...r],i={default:null,validate:void 0,rendered:!0,renderHTML:null,parseHTML:null,keepOnSplit:!0,isRequired:!1};return n.forEach(o=>{const a={name:o.name,options:o.options,storage:o.storage,extensions:s},l=R(o,"addGlobalAttributes",a);if(!l)return;l().forEach(d=>{d.types.forEach(h=>{Object.entries(d.attributes).forEach(([f,p])=>{e.push({type:h,name:f,attribute:{...i,...p}})})})})}),s.forEach(o=>{const a={name:o.name,options:o.options,storage:o.storage},l=R(o,"addAttributes",a);if(!l)return;const c=l();Object.entries(c).forEach(([d,h])=>{const f={...i,...h};typeof f?.default=="function"&&(f.default=f.default()),f?.isRequired&&f?.default===void 0&&delete f.default,e.push({type:o.name,name:d,attribute:f})})}),e}function me(...n){return n.filter(e=>!!e).reduce((e,t)=>{const r={...e};return Object.entries(t).forEach(([s,i])=>{if(!r[s]){r[s]=i;return}if(s==="class"){const a=i?String(i).split(" "):[],l=r[s]?r[s].split(" "):[],c=a.filter(d=>!l.includes(d));r[s]=[...l,...c].join(" ")}else if(s==="style"){const a=i?i.split(";").map(d=>d.trim()).filter(Boolean):[],l=r[s]?r[s].split(";").map(d=>d.trim()).filter(Boolean):[],c=new Map;l.forEach(d=>{const[h,f]=d.split(":").map(p=>p.trim());c.set(h,f)}),a.forEach(d=>{const[h,f]=d.split(":").map(p=>p.trim());c.set(h,f)}),r[s]=Array.from(c.entries()).map(([d,h])=>`${d}: ${h}`).join("; ")}else r[s]=i}),r},{})}function Ns(n,e){return e.filter(t=>t.type===n.type.name).filter(t=>t.attribute.rendered).map(t=>t.attribute.renderHTML?t.attribute.renderHTML(n.attrs)||{}:{[t.name]:n.attrs[t.name]}).reduce((t,r)=>me(t,r),{})}function K_(n){return typeof n!="string"?n:n.match(/^[+-]?(?:\d*\.)?\d+$/)?Number(n):n==="true"?!0:n==="false"?!1:n}function Gu(n,e){return"style"in n?n:{...n,getAttrs:t=>{const r=n.getAttrs?n.getAttrs(t):n.attrs;if(r===!1)return!1;const s=e.reduce((i,o)=>{const a=o.attribute.parseHTML?o.attribute.parseHTML(t):K_(t.getAttribute(o.name));return a==null?i:{...i,[o.name]:a}},{});return{...r,...s}}}}function Ju(n){return Object.fromEntries(Object.entries(n).filter(([e,t])=>e==="attrs"&&W_(t)?!1:t!=null))}function Yu(n){var e,t;const r={};return!((e=n?.attribute)!=null&&e.isRequired)&&"default"in(n?.attribute||{})&&(r.default=n.attribute.default),((t=n?.attribute)==null?void 0:t.validate)!==void 0&&(r.validate=n.attribute.validate),[n.name,r]}function G_(n,e){var t;const r=Wp(n),{nodeExtensions:s,markExtensions:i}=Nr(n),o=(t=s.find(c=>R(c,"topNode")))==null?void 0:t.name,a=Object.fromEntries(s.map(c=>{const d=r.filter(w=>w.type===c.name),h={name:c.name,options:c.options,storage:c.storage,editor:e},f=n.reduce((w,v)=>{const b=R(v,"extendNodeSchema",h);return{...w,...b?b(c):{}}},{}),p=Ju({...f,content:Z(R(c,"content",h)),marks:Z(R(c,"marks",h)),group:Z(R(c,"group",h)),inline:Z(R(c,"inline",h)),atom:Z(R(c,"atom",h)),selectable:Z(R(c,"selectable",h)),draggable:Z(R(c,"draggable",h)),code:Z(R(c,"code",h)),whitespace:Z(R(c,"whitespace",h)),linebreakReplacement:Z(R(c,"linebreakReplacement",h)),defining:Z(R(c,"defining",h)),isolating:Z(R(c,"isolating",h)),attrs:Object.fromEntries(d.map(Yu))}),m=Z(R(c,"parseHTML",h));m&&(p.parseDOM=m.map(w=>Gu(w,d)));const g=R(c,"renderHTML",h);g&&(p.toDOM=w=>g({node:w,HTMLAttributes:Ns(w,d)}));const y=R(c,"renderText",h);return y&&(p.toText=y),[c.name,p]})),l=Object.fromEntries(i.map(c=>{const d=r.filter(y=>y.type===c.name),h={name:c.name,options:c.options,storage:c.storage,editor:e},f=n.reduce((y,w)=>{const v=R(w,"extendMarkSchema",h);return{...y,...v?v(c):{}}},{}),p=Ju({...f,inclusive:Z(R(c,"inclusive",h)),excludes:Z(R(c,"excludes",h)),group:Z(R(c,"group",h)),spanning:Z(R(c,"spanning",h)),code:Z(R(c,"code",h)),attrs:Object.fromEntries(d.map(Yu))}),m=Z(R(c,"parseHTML",h));m&&(p.parseDOM=m.map(y=>Gu(y,d)));const g=R(c,"renderHTML",h);return g&&(p.toDOM=y=>g({mark:y,HTMLAttributes:Ns(y,d)})),[c.name,p]}));return new xf({topNode:o,nodes:a,marks:l})}function J_(n){const e=n.filter((t,r)=>n.indexOf(t)!==r);return Array.from(new Set(e))}function Zi(n){return n.sort((t,r)=>{const s=R(t,"priority")||100,i=R(r,"priority")||100;return s>i?-1:s<i?1:0})}function Kp(n){const e=Zi(Fc(n)),t=J_(e.map(r=>r.name));return t.length&&console.warn(`[tiptap warn]: Duplicate extension names found: [${t.map(r=>`'${r}'`).join(", ")}]. This can lead to issues.`),e}function Gp(n,e,t){const{from:r,to:s}=e,{blockSeparator:i=`

`,textSerializers:o={}}=t||{};let a="";return n.nodesBetween(r,s,(l,c,d,h)=>{var f;l.isBlock&&c>r&&(a+=i);const p=o?.[l.type.name];if(p)return d&&(a+=p({node:l,pos:c,parent:d,index:h,range:e})),!1;l.isText&&(a+=(f=l?.text)==null?void 0:f.slice(Math.max(r,c)-c,s-c))}),a}function Y_(n,e){const t={from:0,to:n.content.size};return Gp(n,t,e)}function Jp(n){return Object.fromEntries(Object.entries(n.nodes).filter(([,e])=>e.spec.toText).map(([e,t])=>[e,t.spec.toText]))}function X_(n,e){const t=ve(e,n.schema),{from:r,to:s}=n.selection,i=[];n.doc.nodesBetween(r,s,a=>{i.push(a)});const o=i.reverse().find(a=>a.type.name===t.name);return o?{...o.attrs}:{}}function Yp(n,e){const t=ta(typeof e=="string"?e:e.name,n.schema);return t==="node"?X_(n,e):t==="mark"?Hp(n,e):{}}function Q_(n,e=JSON.stringify){const t={};return n.filter(r=>{const s=e(r);return Object.prototype.hasOwnProperty.call(t,s)?!1:t[s]=!0})}function Z_(n){const e=Q_(n);return e.length===1?e:e.filter((t,r)=>!e.filter((i,o)=>o!==r).some(i=>t.oldRange.from>=i.oldRange.from&&t.oldRange.to<=i.oldRange.to&&t.newRange.from>=i.newRange.from&&t.newRange.to<=i.newRange.to))}function Xp(n){const{mapping:e,steps:t}=n,r=[];return e.maps.forEach((s,i)=>{const o=[];if(s.ranges.length)s.forEach((a,l)=>{o.push({from:a,to:l})});else{const{from:a,to:l}=t[i];if(a===void 0||l===void 0)return;o.push({from:a,to:l})}o.forEach(({from:a,to:l})=>{const c=e.slice(i).map(a,-1),d=e.slice(i).map(l),h=e.invert().map(c,-1),f=e.invert().map(d);r.push({oldRange:{from:h,to:f},newRange:{from:c,to:d}})})}),Z_(r)}function zc(n,e,t){const r=[];return n===e?t.resolve(n).marks().forEach(s=>{const i=t.resolve(n),o=Bc(i,s.type);o&&r.push({mark:s,...o})}):t.nodesBetween(n,e,(s,i)=>{!s||s?.nodeSize===void 0||r.push(...s.marks.map(o=>({from:i,to:i+s.nodeSize,mark:o})))}),r}var ex=(n,e,t,r=20)=>{const s=n.doc.resolve(t);let i=r,o=null;for(;i>0&&o===null;){const a=s.node(i);a?.type.name===e?o=a:i-=1}return[o,i]};function mi(n,e){return e.nodes[n]||e.marks[n]||null}function Ai(n,e,t){return Object.fromEntries(Object.entries(t).filter(([r])=>{const s=n.find(i=>i.type===e&&i.name===r);return s?s.attribute.keepOnSplit:!1}))}var tx=(n,e=500)=>{let t="";const r=n.parentOffset;return n.parent.nodesBetween(Math.max(0,r-e),r,(s,i,o,a)=>{var l,c;const d=((c=(l=s.type.spec).toText)==null?void 0:c.call(l,{node:s,pos:i,parent:o,index:a}))||s.textContent||"%leaf%";t+=s.isAtom&&!s.isText?d:d.slice(0,Math.max(0,r-i))}),t};function Hl(n,e,t={}){const{empty:r,ranges:s}=n.selection,i=e?qt(e,n.schema):null;if(r)return!!(n.storedMarks||n.selection.$from.marks()).filter(h=>i?i.name===h.type.name:!0).find(h=>Xi(h.attrs,t,{strict:!1}));let o=0;const a=[];if(s.forEach(({$from:h,$to:f})=>{const p=h.pos,m=f.pos;n.doc.nodesBetween(p,m,(g,y)=>{if(!g.isText&&!g.marks.length)return;const w=Math.max(p,y),v=Math.min(m,y+g.nodeSize),b=v-w;o+=b,a.push(...g.marks.map(S=>({mark:S,from:w,to:v})))})}),o===0)return!1;const l=a.filter(h=>i?i.name===h.mark.type.name:!0).filter(h=>Xi(h.mark.attrs,t,{strict:!1})).reduce((h,f)=>h+f.to-f.from,0),c=a.filter(h=>i?h.mark.type!==i&&h.mark.type.excludes(i):!0).reduce((h,f)=>h+f.to-f.from,0);return(l>0?l+c:l)>=o}function nx(n,e,t={}){if(!e)return mn(n,null,t)||Hl(n,null,t);const r=ta(e,n.schema);return r==="node"?mn(n,e,t):r==="mark"?Hl(n,e,t):!1}var rx=(n,e)=>{const{$from:t,$to:r,$anchor:s}=n.selection;if(e){const i=na(a=>a.type.name===e)(n.selection);if(!i)return!1;const o=n.doc.resolve(i.pos+1);return s.pos+1===o.end()}return!(r.parentOffset<r.parent.nodeSize-2||t.pos!==r.pos)},sx=n=>{const{$from:e,$to:t}=n.selection;return!(e.parentOffset>0||e.pos!==t.pos)};function Xu(n,e){return Array.isArray(e)?e.some(t=>(typeof t=="string"?t:t.name)===n.name):e}function Qu(n,e){const{nodeExtensions:t}=Nr(e),r=t.find(o=>o.name===n);if(!r)return!1;const s={name:r.name,options:r.options,storage:r.storage},i=Z(R(r,"group",s));return typeof i!="string"?!1:i.split(" ").includes("list")}function ra(n,{checkChildren:e=!0,ignoreWhitespace:t=!1}={}){var r;if(t){if(n.type.name==="hardBreak")return!0;if(n.isText)return/^\s*$/m.test((r=n.text)!=null?r:"")}if(n.isText)return!n.text;if(n.isAtom||n.isLeaf)return!1;if(n.content.childCount===0)return!0;if(e){let s=!0;return n.content.forEach(i=>{s!==!1&&(ra(i,{ignoreWhitespace:t,checkChildren:e})||(s=!1))}),s}return!1}function Qp(n){return n instanceof D}var Zp=class em{constructor(e){this.position=e}static fromJSON(e){return new em(e.position)}toJSON(){return{position:this.position}}};function ix(n,e){const t=e.mapping.mapResult(n.position);return{position:new Zp(t.pos),mapResult:t}}function ox(n){return new Zp(n)}function ax(n,e,t){var r;const{selection:s}=e;let i=null;if(Bp(s)&&(i=s.$cursor),i){const a=(r=n.storedMarks)!=null?r:i.marks();return i.parent.type.allowsMarkType(t)&&(!!t.isInSet(a)||!a.some(c=>c.type.excludes(t)))}const{ranges:o}=s;return o.some(({$from:a,$to:l})=>{let c=a.depth===0?n.doc.inlineContent&&n.doc.type.allowsMarkType(t):!1;return n.doc.nodesBetween(a.pos,l.pos,(d,h,f)=>{if(c)return!1;if(d.isInline){const p=!f||f.type.allowsMarkType(t),m=!!t.isInSet(d.marks)||!d.marks.some(g=>g.type.excludes(t));c=p&&m}return!c}),c})}var lx=(n,e={})=>({tr:t,state:r,dispatch:s})=>{const{selection:i}=t,{empty:o,ranges:a}=i,l=qt(n,r.schema);if(s)if(o){const c=Hp(r,l);t.addStoredMark(l.create({...c,...e}))}else a.forEach(c=>{const d=c.$from.pos,h=c.$to.pos;r.doc.nodesBetween(d,h,(f,p)=>{const m=Math.max(p,d),g=Math.min(p+f.nodeSize,h);f.marks.find(w=>w.type===l)?f.marks.forEach(w=>{l===w.type&&t.addMark(m,g,l.create({...w.attrs,...e}))}):t.addMark(m,g,l.create(e))})});return ax(r,t,l)},cx=(n,e)=>({tr:t})=>(t.setMeta(n,e),!0),dx=(n,e={})=>({state:t,dispatch:r,chain:s})=>{const i=ve(n,t.schema);let o;return t.selection.$anchor.sameParent(t.selection.$head)&&(o=t.selection.$anchor.parent.attrs),i.isTextblock?s().command(({commands:a})=>uu(i,{...o,...e})(t)?!0:a.clearNodes()).command(({state:a})=>uu(i,{...o,...e})(a,r)).run():(console.warn('[tiptap warn]: Currently "setNode()" only supports text block nodes.'),!1)},ux=n=>({tr:e,dispatch:t})=>{if(t){const{doc:r}=e,s=Pn(n,0,r.content.size),i=D.create(r,s);e.setSelection(i)}return!0},hx=(n,e)=>({tr:t,state:r,dispatch:s})=>{const{selection:i}=r;let o,a;return typeof e=="number"?(o=e,a=e):e&&"from"in e&&"to"in e?(o=e.from,a=e.to):(o=i.from,a=i.to),s&&t.doc.nodesBetween(o,a,(l,c)=>{l.isText||t.setNodeMarkup(c,void 0,{...l.attrs,dir:n})}),!0},fx=n=>({tr:e,dispatch:t})=>{if(t){const{doc:r}=e,{from:s,to:i}=typeof n=="number"?{from:n,to:n}:n,o=z.atStart(r).from,a=z.atEnd(r).to,l=Pn(s,o,a),c=Pn(i,o,a),d=z.create(r,l,c);e.setSelection(d)}return!0},px=n=>({state:e,dispatch:t})=>{const r=ve(n,e.schema);return l0(r)(e,t)};function Zu(n,e){const t=n.storedMarks||n.selection.$to.parentOffset&&n.selection.$from.marks();if(t){const r=t.filter(s=>e?.includes(s.type.name));n.tr.ensureMarks(r)}}var mx=({keepMarks:n=!0}={})=>({tr:e,state:t,dispatch:r,editor:s})=>{const{selection:i,doc:o}=e,{$from:a,$to:l}=i,c=s.extensionManager.attributes,d=Ai(c,a.node().type.name,a.node().attrs);if(i instanceof D&&i.node.isBlock)return!a.parentOffset||!Lt(o,a.pos)?!1:(r&&(n&&Zu(t,s.extensionManager.splittableMarks),e.split(a.pos).scrollIntoView()),!0);if(!a.parent.isBlock)return!1;const h=l.parentOffset===l.parent.content.size,f=a.depth===0?void 0:H_(a.node(-1).contentMatchAt(a.indexAfter(-1)));let p=h&&f?[{type:f,attrs:d}]:void 0,m=Lt(e.doc,e.mapping.map(a.pos),1,p);if(!p&&!m&&Lt(e.doc,e.mapping.map(a.pos),1,f?[{type:f}]:void 0)&&(m=!0,p=f?[{type:f,attrs:d}]:void 0),r){if(m&&(i instanceof z&&e.deleteSelection(),e.split(e.mapping.map(a.pos),1,p),f&&!h&&!a.parentOffset&&a.parent.type!==f)){const g=e.mapping.map(a.before()),y=e.doc.resolve(g);a.node(-1).canReplaceWith(y.index(),y.index()+1,f)&&e.setNodeMarkup(e.mapping.map(a.before()),f)}n&&Zu(t,s.extensionManager.splittableMarks),e.scrollIntoView()}return m},gx=(n,e={})=>({tr:t,state:r,dispatch:s,editor:i})=>{var o;const a=ve(n,r.schema),{$from:l,$to:c}=r.selection,d=r.selection.node;if(d&&d.isBlock||l.depth<2||!l.sameParent(c))return!1;const h=l.node(-1);if(h.type!==a)return!1;const f=i.extensionManager.attributes;if(l.parent.content.size===0&&l.node(-1).childCount===l.indexAfter(-1)){if(l.depth===2||l.node(-3).type!==a||l.index(-2)!==l.node(-2).childCount-1)return!1;if(s){let w=T.empty;const v=l.index(-1)?1:l.index(-2)?2:3;for(let E=l.depth-v;E>=l.depth-3;E-=1)w=T.from(l.node(E).copy(w));const b=l.indexAfter(-1)<l.node(-2).childCount?1:l.indexAfter(-2)<l.node(-3).childCount?2:3,S={...Ai(f,l.node().type.name,l.node().attrs),...e},k=((o=a.contentMatch.defaultType)==null?void 0:o.createAndFill(S))||void 0;w=w.append(T.from(a.createAndFill(null,k)||void 0));const _=l.before(l.depth-(v-1));t.replace(_,l.after(-b),new O(w,4-v,0));let x=-1;t.doc.nodesBetween(_,t.doc.content.size,(E,N)=>{if(x>-1)return!1;E.isTextblock&&E.content.size===0&&(x=N+1)}),x>-1&&t.setSelection(z.near(t.doc.resolve(x))),t.scrollIntoView()}return!0}const p=c.pos===l.end()?h.contentMatchAt(0).defaultType:null,m={...Ai(f,h.type.name,h.attrs),...e},g={...Ai(f,l.node().type.name,l.node().attrs),...e};t.delete(l.pos,c.pos);const y=p?[{type:a,attrs:m},{type:p,attrs:g}]:[{type:a,attrs:m}];if(!Lt(t.doc,l.pos,2))return!1;if(s){const{selection:w,storedMarks:v}=r,{splittableMarks:b}=i.extensionManager,S=v||w.$to.parentOffset&&w.$from.marks();if(t.split(l.pos,2,y).scrollIntoView(),!S||!s)return!0;const k=S.filter(_=>b.includes(_.type.name));t.ensureMarks(k)}return!0},Ga=(n,e)=>{const t=na(o=>o.type===e)(n.selection);if(!t)return!0;const r=n.doc.resolve(Math.max(0,t.pos-1)).before(t.depth);if(r===void 0)return!0;const s=n.doc.nodeAt(r);return t.node.type===s?.type&&bn(n.doc,t.pos)&&n.join(t.pos),!0},Ja=(n,e)=>{const t=na(o=>o.type===e)(n.selection);if(!t)return!0;const r=n.doc.resolve(t.start).after(t.depth);if(r===void 0)return!0;const s=n.doc.nodeAt(r);return t.node.type===s?.type&&bn(n.doc,r)&&n.join(r),!0},yx=(n,e,t,r={})=>({editor:s,tr:i,state:o,dispatch:a,chain:l,commands:c,can:d})=>{const{extensions:h,splittableMarks:f}=s.extensionManager,p=ve(n,o.schema),m=ve(e,o.schema),{selection:g,storedMarks:y}=o,{$from:w,$to:v}=g,b=w.blockRange(v),S=y||g.$to.parentOffset&&g.$from.marks();if(!b)return!1;const k=na(_=>Qu(_.type.name,h))(g);if(b.depth>=1&&k&&b.depth-k.depth<=1){if(k.node.type===p)return c.liftListItem(m);if(Qu(k.node.type.name,h)&&p.validContent(k.node.content)&&a)return l().command(()=>(i.setNodeMarkup(k.pos,p),!0)).command(()=>Ga(i,p)).command(()=>Ja(i,p)).run()}return!t||!S||!a?l().command(()=>d().wrapInList(p,r)?!0:c.clearNodes()).wrapInList(p,r).command(()=>Ga(i,p)).command(()=>Ja(i,p)).run():l().command(()=>{const _=d().wrapInList(p,r),x=S.filter(E=>f.includes(E.type.name));return i.ensureMarks(x),_?!0:c.clearNodes()}).wrapInList(p,r).command(()=>Ga(i,p)).command(()=>Ja(i,p)).run()},wx=(n,e={},t={})=>({state:r,commands:s})=>{const{extendEmptyMarkRange:i=!1}=t,o=qt(n,r.schema);return Hl(r,o,e)?s.unsetMark(o,{extendEmptyMarkRange:i}):s.setMark(o,e)},bx=(n,e,t={})=>({state:r,commands:s})=>{const i=ve(n,r.schema),o=ve(e,r.schema),a=mn(r,i,t);let l;return r.selection.$anchor.sameParent(r.selection.$head)&&(l=r.selection.$anchor.parent.attrs),a?s.setNode(o,l):s.setNode(i,{...l,...t})},vx=(n,e={})=>({state:t,commands:r})=>{const s=ve(n,t.schema);return mn(t,s,e)?r.lift(s):r.wrapIn(s,e)},kx=()=>({state:n,dispatch:e})=>{const t=n.plugins;for(let r=0;r<t.length;r+=1){const s=t[r];let i;if(s.spec.isInputRules&&(i=s.getState(n))){if(e){const o=n.tr,a=i.transform;for(let l=a.steps.length-1;l>=0;l-=1)o.step(a.steps[l].invert(a.docs[l]));if(i.text){const l=o.doc.resolve(i.from).marks();o.replaceWith(i.from,i.to,n.schema.text(i.text,l))}else o.delete(i.from,i.to)}return!0}}return!1},Sx=()=>({tr:n,dispatch:e})=>{const{selection:t}=n,{empty:r,ranges:s}=t;return r||e&&s.forEach(i=>{n.removeMark(i.$from.pos,i.$to.pos)}),!0},_x=(n,e={})=>({tr:t,state:r,dispatch:s})=>{var i;const{extendEmptyMarkRange:o=!1}=e,{selection:a}=t,l=qt(n,r.schema),{$from:c,empty:d,ranges:h}=a;if(!s)return!0;if(d&&o){let{from:f,to:p}=a;const m=(i=c.marks().find(y=>y.type===l))==null?void 0:i.attrs,g=Bc(c,l,m);g&&(f=g.from,p=g.to),t.removeMark(f,p,l)}else h.forEach(f=>{t.removeMark(f.$from.pos,f.$to.pos,l)});return t.removeStoredMark(l),!0},xx=n=>({tr:e,state:t,dispatch:r})=>{const{selection:s}=t;let i,o;return typeof n=="number"?(i=n,o=n):n&&"from"in n&&"to"in n?(i=n.from,o=n.to):(i=s.from,o=s.to),r&&e.doc.nodesBetween(i,o,(a,l)=>{if(a.isText)return;const c={...a.attrs};delete c.dir,e.setNodeMarkup(l,void 0,c)}),!0},Tx=(n,e={})=>({tr:t,state:r,dispatch:s})=>{let i=null,o=null;const a=ta(typeof n=="string"?n:n.name,r.schema);if(!a)return!1;a==="node"&&(i=ve(n,r.schema)),a==="mark"&&(o=qt(n,r.schema));let l=!1;return t.selection.ranges.forEach(c=>{const d=c.$from.pos,h=c.$to.pos;let f,p,m,g;t.selection.empty?r.doc.nodesBetween(d,h,(y,w)=>{i&&i===y.type&&(l=!0,m=Math.max(w,d),g=Math.min(w+y.nodeSize,h),f=w,p=y)}):r.doc.nodesBetween(d,h,(y,w)=>{w<d&&i&&i===y.type&&(l=!0,m=Math.max(w,d),g=Math.min(w+y.nodeSize,h),f=w,p=y),w>=d&&w<=h&&(i&&i===y.type&&(l=!0,s&&t.setNodeMarkup(w,void 0,{...y.attrs,...e})),o&&y.marks.length&&y.marks.forEach(v=>{if(o===v.type&&(l=!0,s)){const b=Math.max(w,d),S=Math.min(w+y.nodeSize,h);t.addMark(b,S,o.create({...v.attrs,...e}))}}))}),p&&(f!==void 0&&s&&t.setNodeMarkup(f,void 0,{...p.attrs,...e}),o&&p.marks.length&&p.marks.forEach(y=>{o===y.type&&s&&t.addMark(m,g,o.create({...y.attrs,...e}))}))}),l},Ex=(n,e={})=>({state:t,dispatch:r})=>{const s=ve(n,t.schema);return t0(s,e)(t,r)},Cx=(n,e={})=>({state:t,dispatch:r})=>{const s=ve(n,t.schema);return n0(s,e)(t,r)},Ax=class{constructor(){this.callbacks={}}on(n,e){return this.callbacks[n]||(this.callbacks[n]=[]),this.callbacks[n].push(e),this}emit(n,...e){const t=this.callbacks[n];return t&&t.forEach(r=>r.apply(this,e)),this}off(n,e){const t=this.callbacks[n];return t&&(e?this.callbacks[n]=t.filter(r=>r!==e):delete this.callbacks[n]),this}once(n,e){const t=(...r)=>{this.off(n,t),e.apply(this,r)};return this.on(n,t)}removeAllListeners(){this.callbacks={}}},Vs=class{constructor(n){var e;this.find=n.find,this.handler=n.handler,this.undoable=(e=n.undoable)!=null?e:!0}},Mx=(n,e)=>{if(jc(e))return e.exec(n);const t=e(n);if(!t)return null;const r=[t.text];return r.index=t.index,r.input=n,r.data=t.data,t.replaceWith&&(t.text.includes(t.replaceWith)||console.warn('[tiptap warn]: "inputRuleMatch.replaceWith" must be part of "inputRuleMatch.text".'),r.push(t.replaceWith)),r};function gi(n){var e;const{editor:t,from:r,to:s,text:i,rules:o,plugin:a}=n,{view:l}=t;if(l.composing)return!1;const c=l.state.doc.resolve(r);if(c.parent.type.spec.code||(e=c.nodeBefore||c.nodeAfter)!=null&&e.marks.find(f=>f.type.spec.code))return!1;let d=!1;const h=tx(c)+i;return o.forEach(f=>{if(d)return;const p=Mx(h,f.find);if(!p)return;const m=l.state.tr,g=Zo({state:l.state,transaction:m}),y={from:r-(p[0].length-i.length),to:s},{commands:w,chain:v,can:b}=new ea({editor:t,state:g});f.handler({state:g,range:y,match:p,commands:w,chain:v,can:b})===null||!m.steps.length||(f.undoable&&m.setMeta(a,{transform:m,from:r,to:s,text:i}),l.dispatch(m),d=!0)}),d}function Ix(n){const{editor:e,rules:t}=n,r=new le({state:{init(){return null},apply(s,i,o){const a=s.getMeta(r);if(a)return a;const l=s.getMeta("applyInputRules");return l&&setTimeout(()=>{let{text:d}=l;typeof d=="string"?d=d:d=Uc(T.from(d),o.schema);const{from:h}=l,f=h+d.length;gi({editor:e,from:h,to:f,text:d,rules:t,plugin:r})}),s.selectionSet||s.docChanged?null:i}},props:{handleTextInput(s,i,o,a){return gi({editor:e,from:i,to:o,text:a,rules:t,plugin:r})},handleDOMEvents:{compositionend:s=>(setTimeout(()=>{const{$cursor:i}=s.state.selection;i&&gi({editor:e,from:i.pos,to:i.pos,text:"",rules:t,plugin:r})}),!1)},handleKeyDown(s,i){if(i.key!=="Enter")return!1;const{$cursor:o}=s.state.selection;return o?gi({editor:e,from:o.pos,to:o.pos,text:`
`,rules:t,plugin:r}):!1}},isInputRules:!0});return r}function Ox(n){return Object.prototype.toString.call(n).slice(8,-1)}function yi(n){return Ox(n)!=="Object"?!1:n.constructor===Object&&Object.getPrototypeOf(n)===Object.prototype}function tm(n,e){const t={...n};return yi(n)&&yi(e)&&Object.keys(e).forEach(r=>{yi(e[r])&&yi(n[r])?t[r]=tm(n[r],e[r]):t[r]=e[r]}),t}var Hc=class{constructor(n={}){this.type="extendable",this.parent=null,this.child=null,this.name="",this.config={name:this.name},this.config={...this.config,...n},this.name=this.config.name}get options(){return{...Z(R(this,"addOptions",{name:this.name}))||{}}}get storage(){return{...Z(R(this,"addStorage",{name:this.name,options:this.options}))||{}}}configure(n={}){const e=this.extend({...this.config,addOptions:()=>tm(this.options,n)});return e.name=this.name,e.parent=this.parent,e}extend(n={}){const e=new this.constructor({...this.config,...n});return e.parent=this,this.child=e,e.name="name"in n?n.name:e.parent.name,e}},Wt=class nm extends Hc{constructor(){super(...arguments),this.type="mark"}static create(e={}){const t=typeof e=="function"?e():e;return new nm(t)}static handleExit({editor:e,mark:t}){const{tr:r}=e.state,s=e.state.selection.$from;if(s.pos===s.end()){const o=s.marks();if(!!!o.find(c=>c?.type.name===t.name))return!1;const l=o.find(c=>c?.type.name===t.name);return l&&r.removeStoredMark(l),r.insertText(" ",s.pos),e.view.dispatch(r),!0}return!1}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}};function Nx(n){return typeof n=="number"}var $x=class{constructor(n){this.find=n.find,this.handler=n.handler}},Rx=(n,e,t)=>{if(jc(e))return[...n.matchAll(e)];const r=e(n,t);return r?r.map(s=>{const i=[s.text];return i.index=s.index,i.input=n,i.data=s.data,s.replaceWith&&(s.text.includes(s.replaceWith)||console.warn('[tiptap warn]: "pasteRuleMatch.replaceWith" must be part of "pasteRuleMatch.text".'),i.push(s.replaceWith)),i}):[]};function Px(n){const{editor:e,state:t,from:r,to:s,rule:i,pasteEvent:o,dropEvent:a}=n,{commands:l,chain:c,can:d}=new ea({editor:e,state:t}),h=[];return t.doc.nodesBetween(r,s,(p,m)=>{var g,y,w,v,b;if((y=(g=p.type)==null?void 0:g.spec)!=null&&y.code||!(p.isText||p.isTextblock||p.isInline))return;const S=(b=(v=(w=p.content)==null?void 0:w.size)!=null?v:p.nodeSize)!=null?b:0,k=Math.max(r,m),_=Math.min(s,m+S);if(k>=_)return;const x=p.isText?p.text||"":p.textBetween(k-m,_-m,void 0,"");Rx(x,i.find,o).forEach(N=>{if(N.index===void 0)return;const H=k+N.index+1,A=H+N[0].length,J={from:t.tr.mapping.map(H),to:t.tr.mapping.map(A)},ee=i.handler({state:t,range:J,match:N,commands:l,chain:c,can:d,pasteEvent:o,dropEvent:a});h.push(ee)})}),h.every(p=>p!==null)}var wi=null,Dx=n=>{var e;const t=new ClipboardEvent("paste",{clipboardData:new DataTransfer});return(e=t.clipboardData)==null||e.setData("text/html",n),t};function Lx(n){const{editor:e,rules:t}=n;let r=null,s=!1,i=!1,o=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,a;try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}const l=({state:d,from:h,to:f,rule:p,pasteEvt:m})=>{const g=d.tr,y=Zo({state:d,transaction:g});if(!(!Px({editor:e,state:y,from:Math.max(h-1,0),to:f.b-1,rule:p,pasteEvent:m,dropEvent:a})||!g.steps.length)){try{a=typeof DragEvent<"u"?new DragEvent("drop"):null}catch{a=null}return o=typeof ClipboardEvent<"u"?new ClipboardEvent("paste"):null,g}};return t.map(d=>new le({view(h){const f=m=>{var g;r=(g=h.dom.parentElement)!=null&&g.contains(m.target)?h.dom.parentElement:null,r&&(wi=e)},p=()=>{wi&&(wi=null)};return window.addEventListener("dragstart",f),window.addEventListener("dragend",p),{destroy(){window.removeEventListener("dragstart",f),window.removeEventListener("dragend",p)}}},props:{handleDOMEvents:{drop:(h,f)=>{if(i=r===h.dom.parentElement,a=f,!i){const p=wi;p?.isEditable&&setTimeout(()=>{const m=p.state.selection;m&&p.commands.deleteRange({from:m.from,to:m.to})},10)}return!1},paste:(h,f)=>{var p;const m=(p=f.clipboardData)==null?void 0:p.getData("text/html");return o=f,s=!!m?.includes("data-pm-slice"),!1}}},appendTransaction:(h,f,p)=>{const m=h[0],g=m.getMeta("uiEvent")==="paste"&&!s,y=m.getMeta("uiEvent")==="drop"&&!i,w=m.getMeta("applyPasteRules"),v=!!w;if(!g&&!y&&!v)return;if(v){let{text:k}=w;typeof k=="string"?k=k:k=Uc(T.from(k),p.schema);const{from:_}=w,x=_+k.length,E=Dx(k);return l({rule:d,state:p,from:_,to:{b:x},pasteEvt:E})}const b=f.doc.content.findDiffStart(p.doc.content),S=f.doc.content.findDiffEnd(p.doc.content);if(!(!Nx(b)||!S||b===S.b))return l({rule:d,state:p,from:b,to:S,pasteEvt:o})}}))}var sa=class{constructor(n,e){this.splittableMarks=[],this.editor=e,this.baseExtensions=n,this.extensions=Kp(n),this.schema=G_(this.extensions,e),this.setupExtensions()}get commands(){return this.extensions.reduce((n,e)=>{const t={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:mi(e.name,this.schema)},r=R(e,"addCommands",t);return r?{...n,...r()}:n},{})}get plugins(){const{editor:n}=this;return Zi([...this.extensions].reverse()).flatMap(r=>{const s={name:r.name,options:r.options,storage:this.editor.extensionStorage[r.name],editor:n,type:mi(r.name,this.schema)},i=[],o=R(r,"addKeyboardShortcuts",s);let a={};if(r.type==="mark"&&R(r,"exitable",s)&&(a.ArrowRight=()=>Wt.handleExit({editor:n,mark:r})),o){const f=Object.fromEntries(Object.entries(o()).map(([p,m])=>[p,()=>m({editor:n})]));a={...a,...f}}const l=XS(a);i.push(l);const c=R(r,"addInputRules",s);if(Xu(r,n.options.enableInputRules)&&c){const f=c();if(f&&f.length){const p=Ix({editor:n,rules:f}),m=Array.isArray(p)?p:[p];i.push(...m)}}const d=R(r,"addPasteRules",s);if(Xu(r,n.options.enablePasteRules)&&d){const f=d();if(f&&f.length){const p=Lx({editor:n,rules:f});i.push(...p)}}const h=R(r,"addProseMirrorPlugins",s);if(h){const f=h();i.push(...f)}return i})}get attributes(){return Wp(this.extensions)}get nodeViews(){const{editor:n}=this,{nodeExtensions:e}=Nr(this.extensions);return Object.fromEntries(e.filter(t=>!!R(t,"addNodeView")).map(t=>{const r=this.attributes.filter(l=>l.type===t.name),s={name:t.name,options:t.options,storage:this.editor.extensionStorage[t.name],editor:n,type:ve(t.name,this.schema)},i=R(t,"addNodeView",s);if(!i)return[];const o=i();if(!o)return[];const a=(l,c,d,h,f)=>{const p=Ns(l,r);return o({node:l,view:c,getPos:d,decorations:h,innerDecorations:f,editor:n,extension:t,HTMLAttributes:p})};return[t.name,a]}))}dispatchTransaction(n){const{editor:e}=this;return Zi([...this.extensions].reverse()).reduceRight((r,s)=>{const i={name:s.name,options:s.options,storage:this.editor.extensionStorage[s.name],editor:e,type:mi(s.name,this.schema)},o=R(s,"dispatchTransaction",i);return o?a=>{o.call(i,{transaction:a,next:r})}:r},n)}get markViews(){const{editor:n}=this,{markExtensions:e}=Nr(this.extensions);return Object.fromEntries(e.filter(t=>!!R(t,"addMarkView")).map(t=>{const r=this.attributes.filter(a=>a.type===t.name),s={name:t.name,options:t.options,storage:this.editor.extensionStorage[t.name],editor:n,type:qt(t.name,this.schema)},i=R(t,"addMarkView",s);if(!i)return[];const o=(a,l,c)=>{const d=Ns(a,r);return i()({mark:a,view:l,inline:c,editor:n,extension:t,HTMLAttributes:d,updateAttributes:h=>{Xx(a,n,h)}})};return[t.name,o]}))}setupExtensions(){const n=this.extensions;this.editor.extensionStorage=Object.fromEntries(n.map(e=>[e.name,e.storage])),n.forEach(e=>{var t;const r={name:e.name,options:e.options,storage:this.editor.extensionStorage[e.name],editor:this.editor,type:mi(e.name,this.schema)};e.type==="mark"&&((t=Z(R(e,"keepOnSplit",r)))==null||t)&&this.splittableMarks.push(e.name);const s=R(e,"onBeforeCreate",r),i=R(e,"onCreate",r),o=R(e,"onUpdate",r),a=R(e,"onSelectionUpdate",r),l=R(e,"onTransaction",r),c=R(e,"onFocus",r),d=R(e,"onBlur",r),h=R(e,"onDestroy",r);s&&this.editor.on("beforeCreate",s),i&&this.editor.on("create",i),o&&this.editor.on("update",o),a&&this.editor.on("selectionUpdate",a),l&&this.editor.on("transaction",l),c&&this.editor.on("focus",c),d&&this.editor.on("blur",d),h&&this.editor.on("destroy",h)})}};sa.resolve=Kp;sa.sort=Zi;sa.flatten=Fc;var jx={};Lc(jx,{ClipboardTextSerializer:()=>sm,Commands:()=>im,Delete:()=>om,Drop:()=>am,Editable:()=>lm,FocusEvents:()=>dm,Keymap:()=>um,Paste:()=>hm,Tabindex:()=>fm,TextDirection:()=>pm,focusEventsPluginKey:()=>cm});var Q=class rm extends Hc{constructor(){super(...arguments),this.type="extension"}static create(e={}){const t=typeof e=="function"?e():e;return new rm(t)}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}},sm=Q.create({name:"clipboardTextSerializer",addOptions(){return{blockSeparator:void 0}},addProseMirrorPlugins(){return[new le({key:new Se("clipboardTextSerializer"),props:{clipboardTextSerializer:()=>{const{editor:n}=this,{state:e,schema:t}=n,{doc:r,selection:s}=e,{ranges:i}=s,o=Math.min(...i.map(d=>d.$from.pos)),a=Math.max(...i.map(d=>d.$to.pos)),l=Jp(t);return Gp(r,{from:o,to:a},{...this.options.blockSeparator!==void 0?{blockSeparator:this.options.blockSeparator}:{},textSerializers:l})}}})]}}),im=Q.create({name:"commands",addCommands(){return{...Lp}}}),om=Q.create({name:"delete",onUpdate({transaction:n,appendedTransactions:e}){var t,r,s;const i=()=>{var o,a,l,c;if((c=(l=(a=(o=this.editor.options.coreExtensionOptions)==null?void 0:o.delete)==null?void 0:a.filterTransaction)==null?void 0:l.call(a,n))!=null?c:n.getMeta("y-sync$"))return;const d=Vp(n.before,[n,...e]);Xp(d).forEach(p=>{d.mapping.mapResult(p.oldRange.from).deletedAfter&&d.mapping.mapResult(p.oldRange.to).deletedBefore&&d.before.nodesBetween(p.oldRange.from,p.oldRange.to,(m,g)=>{const y=g+m.nodeSize-2,w=p.oldRange.from<=g&&y<=p.oldRange.to;this.editor.emit("delete",{type:"node",node:m,from:g,to:y,newFrom:d.mapping.map(g),newTo:d.mapping.map(y),deletedRange:p.oldRange,newRange:p.newRange,partial:!w,editor:this.editor,transaction:n,combinedTransform:d})})});const f=d.mapping;d.steps.forEach((p,m)=>{var g,y;if(p instanceof ft){const w=f.slice(m).map(p.from,-1),v=f.slice(m).map(p.to),b=f.invert().map(w,-1),S=f.invert().map(v),k=(g=d.doc.nodeAt(w-1))==null?void 0:g.marks.some(x=>x.eq(p.mark)),_=(y=d.doc.nodeAt(v))==null?void 0:y.marks.some(x=>x.eq(p.mark));this.editor.emit("delete",{type:"mark",mark:p.mark,from:p.from,to:p.to,deletedRange:{from:b,to:S},newRange:{from:w,to:v},partial:!!(_||k),editor:this.editor,transaction:n,combinedTransform:d})}})};(s=(r=(t=this.editor.options.coreExtensionOptions)==null?void 0:t.delete)==null?void 0:r.async)==null||s?setTimeout(i,0):i()}}),am=Q.create({name:"drop",addProseMirrorPlugins(){return[new le({key:new Se("tiptapDrop"),props:{handleDrop:(n,e,t,r)=>{this.editor.emit("drop",{editor:this.editor,event:e,slice:t,moved:r})}}})]}}),lm=Q.create({name:"editable",addProseMirrorPlugins(){return[new le({key:new Se("editable"),props:{editable:()=>this.editor.options.editable}})]}}),cm=new Se("focusEvents"),dm=Q.create({name:"focusEvents",addProseMirrorPlugins(){const{editor:n}=this;return[new le({key:cm,props:{handleDOMEvents:{focus:(e,t)=>{n.isFocused=!0;const r=n.state.tr.setMeta("focus",{event:t}).setMeta("addToHistory",!1);return e.dispatch(r),!1},blur:(e,t)=>{n.isFocused=!1;const r=n.state.tr.setMeta("blur",{event:t}).setMeta("addToHistory",!1);return e.dispatch(r),!1}}}})]}}),um=Q.create({name:"keymap",addKeyboardShortcuts(){const n=()=>this.editor.commands.first(({commands:o})=>[()=>o.undoInputRule(),()=>o.command(({tr:a})=>{const{selection:l,doc:c}=a,{empty:d,$anchor:h}=l,{pos:f,parent:p}=h,m=h.parent.isTextblock&&f>0?a.doc.resolve(f-1):h,g=m.parent.type.spec.isolating,y=h.pos-h.parentOffset,w=g&&m.parent.childCount===1?y===h.pos:G.atStart(c).from===f;return!d||!p.type.isTextblock||p.textContent.length||!w||w&&h.parent.type.name==="paragraph"?!1:o.clearNodes()}),()=>o.deleteSelection(),()=>o.joinBackward(),()=>o.selectNodeBackward()]),e=()=>this.editor.commands.first(({commands:o})=>[()=>o.deleteSelection(),()=>o.deleteCurrentNode(),()=>o.joinForward(),()=>o.selectNodeForward()]),r={Enter:()=>this.editor.commands.first(({commands:o})=>[()=>o.newlineInCode(),()=>o.createParagraphNear(),()=>o.liftEmptyBlock(),()=>o.splitBlock()]),"Mod-Enter":()=>this.editor.commands.exitCode(),Backspace:n,"Mod-Backspace":n,"Shift-Backspace":n,Delete:e,"Mod-Delete":e,"Mod-a":()=>this.editor.commands.selectAll()},s={...r},i={...r,"Ctrl-h":n,"Alt-Backspace":n,"Ctrl-d":e,"Ctrl-Alt-Backspace":e,"Alt-Delete":e,"Alt-d":e,"Ctrl-a":()=>this.editor.commands.selectTextblockStart(),"Ctrl-e":()=>this.editor.commands.selectTextblockEnd()};return Qi()||zp()?i:s},addProseMirrorPlugins(){return[new le({key:new Se("clearDocument"),appendTransaction:(n,e,t)=>{if(n.some(g=>g.getMeta("composition")))return;const r=n.some(g=>g.docChanged)&&!e.doc.eq(t.doc),s=n.some(g=>g.getMeta("preventClearDocument"));if(!r||s)return;const{empty:i,from:o,to:a}=e.selection,l=G.atStart(e.doc).from,c=G.atEnd(e.doc).to;if(i||!(o===l&&a===c)||!ra(t.doc))return;const f=t.tr,p=Zo({state:t,transaction:f}),{commands:m}=new ea({editor:this.editor,state:p});if(m.clearNodes(),!!f.steps.length)return f}})]}}),hm=Q.create({name:"paste",addProseMirrorPlugins(){return[new le({key:new Se("tiptapPaste"),props:{handlePaste:(n,e,t)=>{this.editor.emit("paste",{editor:this.editor,event:e,slice:t})}}})]}}),fm=Q.create({name:"tabindex",addProseMirrorPlugins(){return[new le({key:new Se("tabindex"),props:{attributes:()=>this.editor.isEditable?{tabindex:"0"}:{}}})]}}),pm=Q.create({name:"textDirection",addOptions(){return{direction:void 0}},addGlobalAttributes(){if(!this.options.direction)return[];const{nodeExtensions:n}=Nr(this.extensions);return[{types:n.filter(e=>e.name!=="text").map(e=>e.name),attributes:{dir:{default:this.options.direction,parseHTML:e=>{const t=e.getAttribute("dir");return t&&(t==="ltr"||t==="rtl"||t==="auto")?t:this.options.direction},renderHTML:e=>e.dir?{dir:e.dir}:{}}}}]},addProseMirrorPlugins(){return[new le({key:new Se("textDirection"),props:{attributes:()=>{const n=this.options.direction;return n?{dir:n}:{}}}})]}}),Bx=class mr{constructor(e,t,r=!1,s=null){this.currentNode=null,this.actualDepth=null,this.isBlock=r,this.resolvedPos=e,this.editor=t,this.currentNode=s}get name(){return this.node.type.name}get node(){return this.currentNode||this.resolvedPos.node()}get element(){return this.editor.view.domAtPos(this.pos).node}get depth(){var e;return(e=this.actualDepth)!=null?e:this.resolvedPos.depth}get pos(){return this.resolvedPos.pos}get content(){return this.node.content}set content(e){let t=this.from,r=this.to;if(this.isBlock){if(this.content.size===0){console.error(`You cant set content on a block node. Tried to set content on ${this.name} at ${this.pos}`);return}t=this.from+1,r=this.to-1}this.editor.commands.insertContentAt({from:t,to:r},e)}get attributes(){return this.node.attrs}get textContent(){return this.node.textContent}get size(){return this.node.nodeSize}get from(){return this.isBlock?this.pos:this.resolvedPos.start(this.resolvedPos.depth)}get range(){return{from:this.from,to:this.to}}get to(){return this.isBlock?this.pos+this.size:this.resolvedPos.end(this.resolvedPos.depth)+(this.node.isText?0:1)}get parent(){if(this.depth===0)return null;const e=this.resolvedPos.start(this.resolvedPos.depth-1),t=this.resolvedPos.doc.resolve(e);return new mr(t,this.editor)}get before(){let e=this.resolvedPos.doc.resolve(this.from-(this.isBlock?1:2));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.from-3)),new mr(e,this.editor)}get after(){let e=this.resolvedPos.doc.resolve(this.to+(this.isBlock?2:1));return e.depth!==this.depth&&(e=this.resolvedPos.doc.resolve(this.to+3)),new mr(e,this.editor)}get children(){const e=[];return this.node.content.forEach((t,r)=>{const s=t.isBlock&&!t.isTextblock,i=t.isAtom&&!t.isText,o=this.pos+r+(i?0:1);if(o<0||o>this.resolvedPos.doc.nodeSize-2)return;const a=this.resolvedPos.doc.resolve(o);if(!s&&a.depth<=this.depth)return;const l=new mr(a,this.editor,s,s?t:null);s&&(l.actualDepth=this.depth+1),e.push(new mr(a,this.editor,s,s?t:null))}),e}get firstChild(){return this.children[0]||null}get lastChild(){const e=this.children;return e[e.length-1]||null}closest(e,t={}){let r=null,s=this.parent;for(;s&&!r;){if(s.node.type.name===e)if(Object.keys(t).length>0){const i=s.node.attrs,o=Object.keys(t);for(let a=0;a<o.length;a+=1){const l=o[a];if(i[l]!==t[l])break}}else r=s;s=s.parent}return r}querySelector(e,t={}){return this.querySelectorAll(e,t,!0)[0]||null}querySelectorAll(e,t={},r=!1){let s=[];if(!this.children||this.children.length===0)return s;const i=Object.keys(t);return this.children.forEach(o=>{r&&s.length>0||(o.node.type.name===e&&i.every(l=>t[l]===o.node.attrs[l])&&s.push(o),!(r&&s.length>0)&&(s=s.concat(o.querySelectorAll(e,t,r))))}),s}setAttribute(e){const{tr:t}=this.editor.state;t.setNodeMarkup(this.from,void 0,{...this.node.attrs,...e}),this.editor.view.dispatch(t)}},Fx=`.ProseMirror {
  position: relative;
}

.ProseMirror {
  word-wrap: break-word;
  white-space: pre-wrap;
  white-space: break-spaces;
  -webkit-font-variant-ligatures: none;
  font-variant-ligatures: none;
  font-feature-settings: "liga" 0; /* the above doesn't seem to work in Edge */
}

.ProseMirror [contenteditable="false"] {
  white-space: normal;
}

.ProseMirror [contenteditable="false"] [contenteditable="true"] {
  white-space: pre-wrap;
}

.ProseMirror pre {
  white-space: pre-wrap;
}

img.ProseMirror-separator {
  display: inline !important;
  border: none !important;
  margin: 0 !important;
  width: 0 !important;
  height: 0 !important;
}

.ProseMirror-gapcursor {
  display: none;
  pointer-events: none;
  position: absolute;
  margin: 0;
}

.ProseMirror-gapcursor:after {
  content: "";
  display: block;
  position: absolute;
  top: -2px;
  width: 20px;
  border-top: 1px solid black;
  animation: ProseMirror-cursor-blink 1.1s steps(2, start) infinite;
}

@keyframes ProseMirror-cursor-blink {
  to {
    visibility: hidden;
  }
}

.ProseMirror-hideselection *::selection {
  background: transparent;
}

.ProseMirror-hideselection *::-moz-selection {
  background: transparent;
}

.ProseMirror-hideselection * {
  caret-color: transparent;
}

.ProseMirror-focused .ProseMirror-gapcursor {
  display: block;
}`;function Ux(n,e,t){const r=document.querySelector("style[data-tiptap-style]");if(r!==null)return r;const s=document.createElement("style");return e&&s.setAttribute("nonce",e),s.setAttribute("data-tiptap-style",""),s.innerHTML=n,document.getElementsByTagName("head")[0].appendChild(s),s}var zx=class extends Ax{constructor(n={}){super(),this.css=null,this.className="tiptap",this.editorView=null,this.isFocused=!1,this.isInitialized=!1,this.extensionStorage={},this.instanceId=Math.random().toString(36).slice(2,9),this.options={element:typeof document<"u"?document.createElement("div"):null,content:"",injectCSS:!0,injectNonce:void 0,extensions:[],autofocus:!1,editable:!0,textDirection:void 0,editorProps:{},parseOptions:{},coreExtensionOptions:{},enableInputRules:!0,enablePasteRules:!0,enableCoreExtensions:!0,enableContentCheck:!1,emitContentError:!1,onBeforeCreate:()=>null,onCreate:()=>null,onMount:()=>null,onUnmount:()=>null,onUpdate:()=>null,onSelectionUpdate:()=>null,onTransaction:()=>null,onFocus:()=>null,onBlur:()=>null,onDestroy:()=>null,onContentError:({error:r})=>{throw r},onPaste:()=>null,onDrop:()=>null,onDelete:()=>null,enableExtensionDispatchTransaction:!0},this.isCapturingTransaction=!1,this.capturedTransaction=null,this.utils={getUpdatedPosition:ix,createMappablePosition:ox},this.setOptions(n),this.createExtensionManager(),this.createCommandManager(),this.createSchema(),this.on("beforeCreate",this.options.onBeforeCreate),this.emit("beforeCreate",{editor:this}),this.on("mount",this.options.onMount),this.on("unmount",this.options.onUnmount),this.on("contentError",this.options.onContentError),this.on("create",this.options.onCreate),this.on("update",this.options.onUpdate),this.on("selectionUpdate",this.options.onSelectionUpdate),this.on("transaction",this.options.onTransaction),this.on("focus",this.options.onFocus),this.on("blur",this.options.onBlur),this.on("destroy",this.options.onDestroy),this.on("drop",({event:r,slice:s,moved:i})=>this.options.onDrop(r,s,i)),this.on("paste",({event:r,slice:s})=>this.options.onPaste(r,s)),this.on("delete",this.options.onDelete);const e=this.createDoc(),t=Fp(e,this.options.autofocus);this.editorState=wr.create({doc:e,schema:this.schema,selection:t||void 0}),this.options.element&&this.mount(this.options.element)}mount(n){if(typeof document>"u")throw new Error("[tiptap error]: The editor cannot be mounted because there is no 'document' defined in this environment.");this.createView(n),this.emit("mount",{editor:this}),this.css&&!document.head.contains(this.css)&&document.head.appendChild(this.css),window.setTimeout(()=>{this.isDestroyed||(this.options.autofocus!==!1&&this.options.autofocus!==null&&this.commands.focus(this.options.autofocus),this.emit("create",{editor:this}),this.isInitialized=!0)},0)}unmount(){if(this.editorView){const n=this.editorView.dom;n?.editor&&delete n.editor,this.editorView.destroy()}if(this.editorView=null,this.isInitialized=!1,this.css&&!document.querySelectorAll(`.${this.className}`).length)try{typeof this.css.remove=="function"?this.css.remove():this.css.parentNode&&this.css.parentNode.removeChild(this.css)}catch(n){console.warn("Failed to remove CSS element:",n)}this.css=null,this.emit("unmount",{editor:this})}get storage(){return this.extensionStorage}get commands(){return this.commandManager.commands}chain(){return this.commandManager.chain()}can(){return this.commandManager.can()}injectCSS(){this.options.injectCSS&&typeof document<"u"&&(this.css=Ux(Fx,this.options.injectNonce))}setOptions(n={}){this.options={...this.options,...n},!(!this.editorView||!this.state||this.isDestroyed)&&(this.options.editorProps&&this.view.setProps(this.options.editorProps),this.view.updateState(this.state))}setEditable(n,e=!0){this.setOptions({editable:n}),e&&this.emit("update",{editor:this,transaction:this.state.tr,appendedTransactions:[]})}get isEditable(){return this.options.editable&&this.view&&this.view.editable}get view(){return this.editorView?this.editorView:new Proxy({state:this.editorState,updateState:n=>{this.editorState=n},dispatch:n=>{this.dispatchTransaction(n)},composing:!1,dragging:null,editable:!0,isDestroyed:!1},{get:(n,e)=>{if(this.editorView)return this.editorView[e];if(e==="state")return this.editorState;if(e in n)return Reflect.get(n,e);throw new Error(`[tiptap error]: The editor view is not available. Cannot access view['${e}']. The editor may not be mounted yet.`)}})}get state(){return this.editorView&&(this.editorState=this.view.state),this.editorState}registerPlugin(n,e){const t=qp(e)?e(n,[...this.state.plugins]):[...this.state.plugins,n],r=this.state.reconfigure({plugins:t});return this.view.updateState(r),r}unregisterPlugin(n){if(this.isDestroyed)return;const e=this.state.plugins;let t=e;if([].concat(n).forEach(s=>{const i=typeof s=="string"?`${s}$`:s.key;t=t.filter(o=>!o.key.startsWith(i))}),e.length===t.length)return;const r=this.state.reconfigure({plugins:t});return this.view.updateState(r),r}createExtensionManager(){var n,e;const r=[...this.options.enableCoreExtensions?[lm,sm.configure({blockSeparator:(e=(n=this.options.coreExtensionOptions)==null?void 0:n.clipboardTextSerializer)==null?void 0:e.blockSeparator}),im,dm,um,fm,am,hm,om,pm.configure({direction:this.options.textDirection})].filter(s=>typeof this.options.enableCoreExtensions=="object"?this.options.enableCoreExtensions[s.name]!==!1:!0):[],...this.options.extensions].filter(s=>["extension","node","mark"].includes(s?.type));this.extensionManager=new sa(r,this)}createCommandManager(){this.commandManager=new ea({editor:this})}createSchema(){this.schema=this.extensionManager.schema}createDoc(){let n;try{n=zl(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:this.options.enableContentCheck})}catch(e){if(!(e instanceof Error)||!["[tiptap error]: Invalid JSON content","[tiptap error]: Invalid HTML content"].includes(e.message))throw e;this.emit("contentError",{editor:this,error:e,disableCollaboration:()=>{"collaboration"in this.storage&&typeof this.storage.collaboration=="object"&&this.storage.collaboration&&(this.storage.collaboration.isDisabled=!0),this.options.extensions=this.options.extensions.filter(t=>t.name!=="collaboration"),this.createExtensionManager()}}),n=zl(this.options.content,this.schema,this.options.parseOptions,{errorOnInvalidContent:!1})}return n}createView(n){const{editorProps:e,enableExtensionDispatchTransaction:t}=this.options,r=e.dispatchTransaction||this.dispatchTransaction.bind(this),s=t?this.extensionManager.dispatchTransaction(r):r;this.editorView=new Pp(n,{...e,attributes:{role:"textbox",...e?.attributes},dispatchTransaction:s,state:this.editorState,markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews});const i=this.state.reconfigure({plugins:this.extensionManager.plugins});this.view.updateState(i),this.prependClass(),this.injectCSS();const o=this.view.dom;o.editor=this}createNodeViews(){this.view.isDestroyed||this.view.setProps({markViews:this.extensionManager.markViews,nodeViews:this.extensionManager.nodeViews})}prependClass(){this.view.dom.className=`${this.className} ${this.view.dom.className}`}captureTransaction(n){this.isCapturingTransaction=!0,n(),this.isCapturingTransaction=!1;const e=this.capturedTransaction;return this.capturedTransaction=null,e}dispatchTransaction(n){if(this.view.isDestroyed)return;if(this.isCapturingTransaction){if(!this.capturedTransaction){this.capturedTransaction=n;return}n.steps.forEach(c=>{var d;return(d=this.capturedTransaction)==null?void 0:d.step(c)});return}const{state:e,transactions:t}=this.state.applyTransaction(n),r=!this.state.selection.eq(e.selection),s=t.includes(n),i=this.state;if(this.emit("beforeTransaction",{editor:this,transaction:n,nextState:e}),!s)return;this.view.updateState(e),this.emit("transaction",{editor:this,transaction:n,appendedTransactions:t.slice(1)}),r&&this.emit("selectionUpdate",{editor:this,transaction:n});const o=t.findLast(c=>c.getMeta("focus")||c.getMeta("blur")),a=o?.getMeta("focus"),l=o?.getMeta("blur");a&&this.emit("focus",{editor:this,event:a.event,transaction:o}),l&&this.emit("blur",{editor:this,event:l.event,transaction:o}),!(n.getMeta("preventUpdate")||!t.some(c=>c.docChanged)||i.doc.eq(e.doc))&&this.emit("update",{editor:this,transaction:n,appendedTransactions:t.slice(1)})}getAttributes(n){return Yp(this.state,n)}isActive(n,e){const t=typeof n=="string"?n:null,r=typeof n=="string"?e:n;return nx(this.state,t,r)}getJSON(){return this.state.doc.toJSON()}getHTML(){return Uc(this.state.doc.content,this.schema)}getText(n){const{blockSeparator:e=`

`,textSerializers:t={}}=n||{};return Y_(this.state.doc,{blockSeparator:e,textSerializers:{...Jp(this.schema),...t}})}get isEmpty(){return ra(this.state.doc)}destroy(){this.emit("destroy"),this.unmount(),this.removeAllListeners()}get isDestroyed(){var n,e;return(e=(n=this.editorView)==null?void 0:n.isDestroyed)!=null?e:!0}$node(n,e){var t;return((t=this.$doc)==null?void 0:t.querySelector(n,e))||null}$nodes(n,e){var t;return((t=this.$doc)==null?void 0:t.querySelectorAll(n,e))||null}$pos(n){const e=this.state.doc.resolve(n);return new Bx(e,this)}get $doc(){return this.$pos(0)}};function Yn(n){return new Vs({find:n.find,handler:({state:e,range:t,match:r})=>{const s=Z(n.getAttributes,void 0,r);if(s===!1||s===null)return null;const{tr:i}=e,o=r[r.length-1],a=r[0];if(o){const l=a.search(/\S/),c=t.from+a.indexOf(o),d=c+o.length;if(zc(t.from,t.to,e.doc).filter(p=>p.mark.type.excluded.find(g=>g===n.type&&g!==p.mark.type)).filter(p=>p.to>c).length)return null;d<t.to&&i.delete(d,t.to),c>t.from&&i.delete(t.from+l,c);const f=t.from+l+o.length;i.addMark(t.from+l,f,n.type.create(s||{})),i.removeStoredMark(n.type)}},undoable:n.undoable})}function Hx(n){return new Vs({find:n.find,handler:({state:e,range:t,match:r})=>{const s=Z(n.getAttributes,void 0,r)||{},{tr:i}=e,o=t.from;let a=t.to;const l=n.type.create(s);if(r[1]){const c=r[0].lastIndexOf(r[1]);let d=o+c;d>a?d=a:a=d+r[1].length;const h=r[0][r[0].length-1];i.insertText(h,o+r[0].length-1),i.replaceWith(d,a,l)}else if(r[0]){const c=n.type.isInline?o:o-1;i.insert(c,n.type.create(s)).delete(i.mapping.map(o),i.mapping.map(a))}i.scrollIntoView()},undoable:n.undoable})}function Vl(n){return new Vs({find:n.find,handler:({state:e,range:t,match:r})=>{const s=e.doc.resolve(t.from),i=Z(n.getAttributes,void 0,r)||{};if(!s.node(-1).canReplaceWith(s.index(-1),s.indexAfter(-1),n.type))return null;e.tr.delete(t.from,t.to).setBlockType(t.from,t.from,n.type,i)},undoable:n.undoable})}function $r(n){return new Vs({find:n.find,handler:({state:e,range:t,match:r,chain:s})=>{const i=Z(n.getAttributes,void 0,r)||{},o=e.tr.delete(t.from,t.to),l=o.doc.resolve(t.from).blockRange(),c=l&&kc(l,n.type,i);if(!c)return null;if(o.wrap(l,c),n.keepMarks&&n.editor){const{selection:h,storedMarks:f}=e,{splittableMarks:p}=n.editor.extensionManager,m=f||h.$to.parentOffset&&h.$from.marks();if(m){const g=m.filter(y=>p.includes(y.type.name));o.ensureMarks(g)}}if(n.keepAttributes){const h=n.type.name==="bulletList"||n.type.name==="orderedList"?"listItem":"taskList";s().updateAttributes(h,i).run()}const d=o.doc.resolve(t.from-1).nodeBefore;d&&d.type===n.type&&bn(o.doc,t.from-1)&&(!n.joinPredicate||n.joinPredicate(r,d))&&o.join(t.from-1)},undoable:n.undoable})}function Vx(n,e){const{selection:t}=n,{$from:r}=t;if(t instanceof D){const i=r.index();return r.parent.canReplaceWith(i,i+1,e)}let s=r.depth;for(;s>=0;){const i=r.index(s);if(r.node(s).contentMatchAt(i).matchType(e))return!0;s-=1}return!1}var qx={};Lc(qx,{createAtomBlockMarkdownSpec:()=>Wx,createBlockMarkdownSpec:()=>Kx,createInlineMarkdownSpec:()=>Yx,parseAttributes:()=>Vc,parseIndentedBlocks:()=>ql,renderNestedMarkdownContent:()=>Wc,serializeAttributes:()=>qc});function Vc(n){if(!n?.trim())return{};const e={},t=[],r=n.replace(/["']([^"']*)["']/g,c=>(t.push(c),`__QUOTED_${t.length-1}__`)),s=r.match(/(?:^|\s)\.([a-zA-Z][\w-]*)/g);if(s){const c=s.map(d=>d.trim().slice(1));e.class=c.join(" ")}const i=r.match(/(?:^|\s)#([a-zA-Z][\w-]*)/);i&&(e.id=i[1]);const o=/([a-zA-Z][\w-]*)\s*=\s*(__QUOTED_\d+__)/g;Array.from(r.matchAll(o)).forEach(([,c,d])=>{var h;const f=parseInt(((h=d.match(/__QUOTED_(\d+)__/))==null?void 0:h[1])||"0",10),p=t[f];p&&(e[c]=p.slice(1,-1))});const l=r.replace(/(?:^|\s)\.([a-zA-Z][\w-]*)/g,"").replace(/(?:^|\s)#([a-zA-Z][\w-]*)/g,"").replace(/([a-zA-Z][\w-]*)\s*=\s*__QUOTED_\d+__/g,"").trim();return l&&l.split(/\s+/).filter(Boolean).forEach(d=>{d.match(/^[a-zA-Z][\w-]*$/)&&(e[d]=!0)}),e}function qc(n){if(!n||Object.keys(n).length===0)return"";const e=[];return n.class&&String(n.class).split(/\s+/).filter(Boolean).forEach(r=>e.push(`.${r}`)),n.id&&e.push(`#${n.id}`),Object.entries(n).forEach(([t,r])=>{t==="class"||t==="id"||(r===!0?e.push(t):r!==!1&&r!=null&&e.push(`${t}="${String(r)}"`))}),e.join(" ")}function Wx(n){const{nodeName:e,name:t,parseAttributes:r=Vc,serializeAttributes:s=qc,defaultAttributes:i={},requiredAttributes:o=[],allowedAttributes:a}=n,l=t||e,c=d=>{if(!a)return d;const h={};return a.forEach(f=>{f in d&&(h[f]=d[f])}),h};return{parseMarkdown:(d,h)=>{const f={...i,...d.attributes};return h.createNode(e,f,[])},markdownTokenizer:{name:e,level:"block",start(d){var h;const f=new RegExp(`^:::${l}(?:\\s|$)`,"m"),p=(h=d.match(f))==null?void 0:h.index;return p!==void 0?p:-1},tokenize(d,h,f){const p=new RegExp(`^:::${l}(?:\\s+\\{([^}]*)\\})?\\s*:::(?:\\n|$)`),m=d.match(p);if(!m)return;const g=m[1]||"",y=r(g);if(!o.find(v=>!(v in y)))return{type:e,raw:m[0],attributes:y}}},renderMarkdown:d=>{const h=c(d.attrs||{}),f=s(h),p=f?` {${f}}`:"";return`:::${l}${p} :::`}}}function Kx(n){const{nodeName:e,name:t,getContent:r,parseAttributes:s=Vc,serializeAttributes:i=qc,defaultAttributes:o={},content:a="block",allowedAttributes:l}=n,c=t||e,d=h=>{if(!l)return h;const f={};return l.forEach(p=>{p in h&&(f[p]=h[p])}),f};return{parseMarkdown:(h,f)=>{let p;if(r){const g=r(h);p=typeof g=="string"?[{type:"text",text:g}]:g}else a==="block"?p=f.parseChildren(h.tokens||[]):p=f.parseInline(h.tokens||[]);const m={...o,...h.attributes};return f.createNode(e,m,p)},markdownTokenizer:{name:e,level:"block",start(h){var f;const p=new RegExp(`^:::${c}`,"m"),m=(f=h.match(p))==null?void 0:f.index;return m!==void 0?m:-1},tokenize(h,f,p){var m;const g=new RegExp(`^:::${c}(?:\\s+\\{([^}]*)\\})?\\s*\\n`),y=h.match(g);if(!y)return;const[w,v=""]=y,b=s(v);let S=1;const k=w.length;let _="";const x=/^:::([\w-]*)(\s.*)?/gm,E=h.slice(k);for(x.lastIndex=0;;){const N=x.exec(E);if(N===null)break;const H=N.index,A=N[1];if(!((m=N[2])!=null&&m.endsWith(":::"))){if(A)S+=1;else if(S-=1,S===0){const J=E.slice(0,H);_=J.trim();const ee=h.slice(0,k+H+N[0].length);let P=[];if(_)if(a==="block")for(P=p.blockTokens(J),P.forEach(Y=>{Y.text&&(!Y.tokens||Y.tokens.length===0)&&(Y.tokens=p.inlineTokens(Y.text))});P.length>0;){const Y=P[P.length-1];if(Y.type==="paragraph"&&(!Y.text||Y.text.trim()===""))P.pop();else break}else P=p.inlineTokens(_);return{type:e,raw:ee,attributes:b,content:_,tokens:P}}}}}},renderMarkdown:(h,f)=>{const p=d(h.attrs||{}),m=i(p),g=m?` {${m}}`:"",y=f.renderChildren(h.content||[],`

`);return`:::${c}${g}

${y}

:::`}}}function Gx(n){if(!n.trim())return{};const e={},t=/(\w+)=(?:"([^"]*)"|'([^']*)')/g;let r=t.exec(n);for(;r!==null;){const[,s,i,o]=r;e[s]=i||o,r=t.exec(n)}return e}function Jx(n){return Object.entries(n).filter(([,e])=>e!=null).map(([e,t])=>`${e}="${t}"`).join(" ")}function Yx(n){const{nodeName:e,name:t,getContent:r,parseAttributes:s=Gx,serializeAttributes:i=Jx,defaultAttributes:o={},selfClosing:a=!1,allowedAttributes:l}=n,c=t||e,d=f=>{if(!l)return f;const p={};return l.forEach(m=>{const g=typeof m=="string"?m:m.name,y=typeof m=="string"?void 0:m.skipIfDefault;if(g in f){const w=f[g];if(y!==void 0&&w===y)return;p[g]=w}}),p},h=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return{parseMarkdown:(f,p)=>{const m={...o,...f.attributes};if(a)return p.createNode(e,m);const g=r?r(f):f.content||"";return g?p.createNode(e,m,[p.createTextNode(g)]):p.createNode(e,m,[])},markdownTokenizer:{name:e,level:"inline",start(f){const p=a?new RegExp(`\\[${h}\\s*[^\\]]*\\]`):new RegExp(`\\[${h}\\s*[^\\]]*\\][\\s\\S]*?\\[\\/${h}\\]`),m=f.match(p),g=m?.index;return g!==void 0?g:-1},tokenize(f,p,m){const g=a?new RegExp(`^\\[${h}\\s*([^\\]]*)\\]`):new RegExp(`^\\[${h}\\s*([^\\]]*)\\]([\\s\\S]*?)\\[\\/${h}\\]`),y=f.match(g);if(!y)return;let w="",v="";if(a){const[,S]=y;v=S}else{const[,S,k]=y;v=S,w=k||""}const b=s(v.trim());return{type:e,raw:y[0],content:w.trim(),attributes:b}}},renderMarkdown:f=>{let p="";r?p=r(f):f.content&&f.content.length>0&&(p=f.content.filter(w=>w.type==="text").map(w=>w.text).join(""));const m=d(f.attrs||{}),g=i(m),y=g?` ${g}`:"";return a?`[${c}${y}]`:`[${c}${y}]${p}[/${c}]`}}}function ql(n,e,t){var r,s,i,o;const a=n.split(`
`),l=[];let c="",d=0;const h=e.baseIndentSize||2;for(;d<a.length;){const f=a[d],p=f.match(e.itemPattern);if(!p){if(l.length>0)break;if(f.trim()===""){d+=1,c=`${c}${f}
`;continue}else return}const m=e.extractItemData(p),{indentLevel:g,mainContent:y}=m;c=`${c}${f}
`;const w=[y];for(d+=1;d<a.length;){const k=a[d];if(k.trim()===""){const x=a.slice(d+1).findIndex(H=>H.trim()!=="");if(x===-1)break;if((((s=(r=a[d+1+x].match(/^(\s*)/))==null?void 0:r[1])==null?void 0:s.length)||0)>g){w.push(k),c=`${c}${k}
`,d+=1;continue}else break}if((((o=(i=k.match(/^(\s*)/))==null?void 0:i[1])==null?void 0:o.length)||0)>g)w.push(k),c=`${c}${k}
`,d+=1;else break}let v;const b=w.slice(1);if(b.length>0){const k=b.map(_=>_.slice(g+h)).join(`
`);k.trim()&&(e.customNestedParser?v=e.customNestedParser(k):v=t.blockTokens(k))}const S=e.createToken(m,v);l.push(S)}if(l.length!==0)return{items:l,raw:c}}function Wc(n,e,t,r){if(!n||!Array.isArray(n.content))return"";const s=typeof t=="function"?t(r):t,[i,...o]=n.content,a=e.renderChildren([i]),l=[`${s}${a}`];return o&&o.length>0&&o.forEach(c=>{const d=e.renderChildren([c]);if(d){const h=d.split(`
`).map(f=>f?e.indent(f):"").join(`
`);l.push(h)}}),l.join(`
`)}function Xx(n,e,t={}){const{state:r}=e,{doc:s,tr:i}=r,o=n;s.descendants((a,l)=>{const c=i.mapping.map(l),d=i.mapping.map(l)+a.nodeSize;let h=null;if(a.marks.forEach(p=>{if(p!==o)return!1;h=p}),!h)return;let f=!1;if(Object.keys(t).forEach(p=>{t[p]!==h.attrs[p]&&(f=!0)}),f){const p=n.type.create({...n.attrs,...t});i.removeMark(c,d,n.type),i.addMark(c,d,p)}}),i.docChanged&&e.view.dispatch(i)}var Ye=class mm extends Hc{constructor(){super(...arguments),this.type="node"}static create(e={}){const t=typeof e=="function"?e():e;return new mm(t)}configure(e){return super.configure(e)}extend(e){const t=typeof e=="function"?e():e;return super.extend(t)}};function gn(n){return new $x({find:n.find,handler:({state:e,range:t,match:r,pasteEvent:s})=>{const i=Z(n.getAttributes,void 0,r,s);if(i===!1||i===null)return null;const{tr:o}=e,a=r[r.length-1],l=r[0];let c=t.to;if(a){const d=l.search(/\S/),h=t.from+l.indexOf(a),f=h+a.length;if(zc(t.from,t.to,e.doc).filter(m=>m.mark.type.excluded.find(y=>y===n.type&&y!==m.mark.type)).filter(m=>m.to>h).length)return null;f<t.to&&o.delete(f,t.to),h>t.from&&o.delete(t.from+d,h),c=t.from+d+a.length,o.addMark(t.from+d,c,n.type.create(i||{})),o.removeStoredMark(n.type)}}})}var eo=(n,e)=>{if(n==="slot")return 0;if(n instanceof Function)return n(e);const{children:t,...r}=e??{};if(n==="svg")throw new Error("SVG elements are not supported in the JSX syntax, use the array syntax instead");return[n,r,t]},Qx=/^\s*>\s$/,Zx=Ye.create({name:"blockquote",addOptions(){return{HTMLAttributes:{}}},content:"block+",group:"block",defining:!0,parseHTML(){return[{tag:"blockquote"}]},renderHTML({HTMLAttributes:n}){return eo("blockquote",{...me(this.options.HTMLAttributes,n),children:eo("slot",{})})},parseMarkdown:(n,e)=>e.createNode("blockquote",void 0,e.parseChildren(n.tokens||[])),renderMarkdown:(n,e)=>{if(!n.content)return"";const t=">",r=[];return n.content.forEach(s=>{const a=e.renderChildren([s]).split(`
`).map(l=>l.trim()===""?t:`${t} ${l}`);r.push(a.join(`
`))}),r.join(`
${t}
`)},addCommands(){return{setBlockquote:()=>({commands:n})=>n.wrapIn(this.name),toggleBlockquote:()=>({commands:n})=>n.toggleWrap(this.name),unsetBlockquote:()=>({commands:n})=>n.lift(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-b":()=>this.editor.commands.toggleBlockquote()}},addInputRules(){return[$r({find:Qx,type:this.type})]}}),eT=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))$/,tT=/(?:^|\s)(\*\*(?!\s+\*\*)((?:[^*]+))\*\*(?!\s+\*\*))/g,nT=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))$/,rT=/(?:^|\s)(__(?!\s+__)((?:[^_]+))__(?!\s+__))/g,sT=Wt.create({name:"bold",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"strong"},{tag:"b",getAttrs:n=>n.style.fontWeight!=="normal"&&null},{style:"font-weight=400",clearMark:n=>n.type.name===this.name},{style:"font-weight",getAttrs:n=>/^(bold(er)?|[5-9]\d{2,})$/.test(n)&&null}]},renderHTML({HTMLAttributes:n}){return eo("strong",{...me(this.options.HTMLAttributes,n),children:eo("slot",{})})},markdownTokenName:"strong",parseMarkdown:(n,e)=>e.applyMark("bold",e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>`**${e.renderChildren(n)}**`,addCommands(){return{setBold:()=>({commands:n})=>n.setMark(this.name),toggleBold:()=>({commands:n})=>n.toggleMark(this.name),unsetBold:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-b":()=>this.editor.commands.toggleBold(),"Mod-B":()=>this.editor.commands.toggleBold()}},addInputRules(){return[Yn({find:eT,type:this.type}),Yn({find:nT,type:this.type})]},addPasteRules(){return[gn({find:tT,type:this.type}),gn({find:rT,type:this.type})]}}),iT=/(^|[^`])`([^`]+)`(?!`)$/,oT=/(^|[^`])`([^`]+)`(?!`)/g,aT=Wt.create({name:"code",addOptions(){return{HTMLAttributes:{}}},excludes:"_",code:!0,exitable:!0,parseHTML(){return[{tag:"code"}]},renderHTML({HTMLAttributes:n}){return["code",me(this.options.HTMLAttributes,n),0]},markdownTokenName:"codespan",parseMarkdown:(n,e)=>e.applyMark("code",[{type:"text",text:n.text||""}]),renderMarkdown:(n,e)=>n.content?`\`${e.renderChildren(n.content)}\``:"",addCommands(){return{setCode:()=>({commands:n})=>n.setMark(this.name),toggleCode:()=>({commands:n})=>n.toggleMark(this.name),unsetCode:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-e":()=>this.editor.commands.toggleCode()}},addInputRules(){return[Yn({find:iT,type:this.type})]},addPasteRules(){return[gn({find:oT,type:this.type})]}}),Ya=4,lT=/^```([a-z]+)?[\s\n]$/,cT=/^~~~([a-z]+)?[\s\n]$/,dT=Ye.create({name:"codeBlock",addOptions(){return{languageClassPrefix:"language-",exitOnTripleEnter:!0,exitOnArrowDown:!0,defaultLanguage:null,enableTabIndentation:!1,tabSize:Ya,HTMLAttributes:{}}},content:"text*",marks:"",group:"block",code:!0,defining:!0,addAttributes(){return{language:{default:this.options.defaultLanguage,parseHTML:n=>{var e;const{languageClassPrefix:t}=this.options;if(!t)return null;const i=[...((e=n.firstElementChild)==null?void 0:e.classList)||[]].filter(o=>o.startsWith(t)).map(o=>o.replace(t,""))[0];return i||null},rendered:!1}}},parseHTML(){return[{tag:"pre",preserveWhitespace:"full"}]},renderHTML({node:n,HTMLAttributes:e}){return["pre",me(this.options.HTMLAttributes,e),["code",{class:n.attrs.language?this.options.languageClassPrefix+n.attrs.language:null},0]]},markdownTokenName:"code",parseMarkdown:(n,e)=>{var t;return((t=n.raw)==null?void 0:t.startsWith("```"))===!1&&n.codeBlockStyle!=="indented"?[]:e.createNode("codeBlock",{language:n.lang||null},n.text?[e.createTextNode(n.text)]:[])},renderMarkdown:(n,e)=>{var t;let r="";const s=((t=n.attrs)==null?void 0:t.language)||"";return n.content?r=[`\`\`\`${s}`,e.renderChildren(n.content),"```"].join(`
`):r=`\`\`\`${s}

\`\`\``,r},addCommands(){return{setCodeBlock:n=>({commands:e})=>e.setNode(this.name,n),toggleCodeBlock:n=>({commands:e})=>e.toggleNode(this.name,"paragraph",n)}},addKeyboardShortcuts(){return{"Mod-Alt-c":()=>this.editor.commands.toggleCodeBlock(),Backspace:()=>{const{empty:n,$anchor:e}=this.editor.state.selection,t=e.pos===1;return!n||e.parent.type.name!==this.name?!1:t||!e.parent.textContent.length?this.editor.commands.clearNodes():!1},Tab:({editor:n})=>{var e;if(!this.options.enableTabIndentation)return!1;const t=(e=this.options.tabSize)!=null?e:Ya,{state:r}=n,{selection:s}=r,{$from:i,empty:o}=s;if(i.parent.type!==this.type)return!1;const a=" ".repeat(t);return o?n.commands.insertContent(a):n.commands.command(({tr:l})=>{const{from:c,to:d}=s,p=r.doc.textBetween(c,d,`
`,`
`).split(`
`).map(m=>a+m).join(`
`);return l.replaceWith(c,d,r.schema.text(p)),!0})},"Shift-Tab":({editor:n})=>{var e;if(!this.options.enableTabIndentation)return!1;const t=(e=this.options.tabSize)!=null?e:Ya,{state:r}=n,{selection:s}=r,{$from:i,empty:o}=s;return i.parent.type!==this.type?!1:o?n.commands.command(({tr:a})=>{var l;const{pos:c}=i,d=i.start(),h=i.end(),p=r.doc.textBetween(d,h,`
`,`
`).split(`
`);let m=0,g=0;const y=c-d;for(let _=0;_<p.length;_+=1){if(g+p[_].length>=y){m=_;break}g+=p[_].length+1}const v=((l=p[m].match(/^ */))==null?void 0:l[0])||"",b=Math.min(v.length,t);if(b===0)return!0;let S=d;for(let _=0;_<m;_+=1)S+=p[_].length+1;return a.delete(S,S+b),c-S<=b&&a.setSelection(z.create(a.doc,S)),!0}):n.commands.command(({tr:a})=>{const{from:l,to:c}=s,f=r.doc.textBetween(l,c,`
`,`
`).split(`
`).map(p=>{var m;const g=((m=p.match(/^ */))==null?void 0:m[0])||"",y=Math.min(g.length,t);return p.slice(y)}).join(`
`);return a.replaceWith(l,c,r.schema.text(f)),!0})},Enter:({editor:n})=>{if(!this.options.exitOnTripleEnter)return!1;const{state:e}=n,{selection:t}=e,{$from:r,empty:s}=t;if(!s||r.parent.type!==this.type)return!1;const i=r.parentOffset===r.parent.nodeSize-2,o=r.parent.textContent.endsWith(`

`);return!i||!o?!1:n.chain().command(({tr:a})=>(a.delete(r.pos-2,r.pos),!0)).exitCode().run()},ArrowDown:({editor:n})=>{if(!this.options.exitOnArrowDown)return!1;const{state:e}=n,{selection:t,doc:r}=e,{$from:s,empty:i}=t;if(!i||s.parent.type!==this.type||!(s.parentOffset===s.parent.nodeSize-2))return!1;const a=s.after();return a===void 0?!1:r.nodeAt(a)?n.commands.command(({tr:c})=>(c.setSelection(G.near(r.resolve(a))),!0)):n.commands.exitCode()}}},addInputRules(){return[Vl({find:lT,type:this.type,getAttributes:n=>({language:n[1]})}),Vl({find:cT,type:this.type,getAttributes:n=>({language:n[1]})})]},addProseMirrorPlugins(){return[new le({key:new Se("codeBlockVSCodeHandler"),props:{handlePaste:(n,e)=>{if(!e.clipboardData||this.editor.isActive(this.type.name))return!1;const t=e.clipboardData.getData("text/plain"),r=e.clipboardData.getData("vscode-editor-data"),s=r?JSON.parse(r):void 0,i=s?.mode;if(!t||!i)return!1;const{tr:o,schema:a}=n.state,l=a.text(t.replace(/\r\n?/g,`
`));return o.replaceSelectionWith(this.type.create({language:i},l)),o.selection.$from.parent.type!==this.type&&o.setSelection(z.near(o.doc.resolve(Math.max(0,o.selection.from-2)))),o.setMeta("paste",!0),n.dispatch(o),!0}}})]}}),uT=Ye.create({name:"doc",topNode:!0,content:"block+",renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`

`):""}),hT=Ye.create({name:"hardBreak",markdownTokenName:"br",addOptions(){return{keepMarks:!0,HTMLAttributes:{}}},inline:!0,group:"inline",selectable:!1,linebreakReplacement:!0,parseHTML(){return[{tag:"br"}]},renderHTML({HTMLAttributes:n}){return["br",me(this.options.HTMLAttributes,n)]},renderText(){return`
`},renderMarkdown:()=>`  
`,parseMarkdown:()=>({type:"hardBreak"}),addCommands(){return{setHardBreak:()=>({commands:n,chain:e,state:t,editor:r})=>n.first([()=>n.exitCode(),()=>n.command(()=>{const{selection:s,storedMarks:i}=t;if(s.$from.parent.type.spec.isolating)return!1;const{keepMarks:o}=this.options,{splittableMarks:a}=r.extensionManager,l=i||s.$to.parentOffset&&s.$from.marks();return e().insertContent({type:this.name}).command(({tr:c,dispatch:d})=>{if(d&&l&&o){const h=l.filter(f=>a.includes(f.type.name));c.ensureMarks(h)}return!0}).run()})])}},addKeyboardShortcuts(){return{"Mod-Enter":()=>this.editor.commands.setHardBreak(),"Shift-Enter":()=>this.editor.commands.setHardBreak()}}}),fT=Ye.create({name:"heading",addOptions(){return{levels:[1,2,3,4,5,6],HTMLAttributes:{}}},content:"inline*",group:"block",defining:!0,addAttributes(){return{level:{default:1,rendered:!1}}},parseHTML(){return this.options.levels.map(n=>({tag:`h${n}`,attrs:{level:n}}))},renderHTML({node:n,HTMLAttributes:e}){return[`h${this.options.levels.includes(n.attrs.level)?n.attrs.level:this.options.levels[0]}`,me(this.options.HTMLAttributes,e),0]},parseMarkdown:(n,e)=>e.createNode("heading",{level:n.depth||1},e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>{var t;const r=(t=n.attrs)!=null&&t.level?parseInt(n.attrs.level,10):1,s="#".repeat(r);return n.content?`${s} ${e.renderChildren(n.content)}`:""},addCommands(){return{setHeading:n=>({commands:e})=>this.options.levels.includes(n.level)?e.setNode(this.name,n):!1,toggleHeading:n=>({commands:e})=>this.options.levels.includes(n.level)?e.toggleNode(this.name,"paragraph",n):!1}},addKeyboardShortcuts(){return this.options.levels.reduce((n,e)=>({...n,[`Mod-Alt-${e}`]:()=>this.editor.commands.toggleHeading({level:e})}),{})},addInputRules(){return this.options.levels.map(n=>Vl({find:new RegExp(`^(#{${Math.min(...this.options.levels)},${n}})\\s$`),type:this.type,getAttributes:{level:n}}))}}),pT=Ye.create({name:"horizontalRule",addOptions(){return{HTMLAttributes:{},nextNodeType:"paragraph"}},group:"block",parseHTML(){return[{tag:"hr"}]},renderHTML({HTMLAttributes:n}){return["hr",me(this.options.HTMLAttributes,n)]},markdownTokenName:"hr",parseMarkdown:(n,e)=>e.createNode("horizontalRule"),renderMarkdown:()=>"---",addCommands(){return{setHorizontalRule:()=>({chain:n,state:e})=>{if(!Vx(e,e.schema.nodes[this.name]))return!1;const{selection:t}=e,{$to:r}=t,s=n();return Qp(t)?s.insertContentAt(r.pos,{type:this.name}):s.insertContent({type:this.name}),s.command(({state:i,tr:o,dispatch:a})=>{if(a){const{$to:l}=o.selection,c=l.end();if(l.nodeAfter)l.nodeAfter.isTextblock?o.setSelection(z.create(o.doc,l.pos+1)):l.nodeAfter.isBlock?o.setSelection(D.create(o.doc,l.pos)):o.setSelection(z.create(o.doc,l.pos));else{const d=i.schema.nodes[this.options.nextNodeType]||l.parent.type.contentMatch.defaultType,h=d?.create();h&&(o.insert(c,h),o.setSelection(z.create(o.doc,c+1)))}o.scrollIntoView()}return!0}).run()}}},addInputRules(){return[Hx({find:/^(?:---|-|___\s|\*\*\*\s)$/,type:this.type})]}}),mT=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))$/,gT=/(?:^|\s)(\*(?!\s+\*)((?:[^*]+))\*(?!\s+\*))/g,yT=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))$/,wT=/(?:^|\s)(_(?!\s+_)((?:[^_]+))_(?!\s+_))/g,bT=Wt.create({name:"italic",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"em"},{tag:"i",getAttrs:n=>n.style.fontStyle!=="normal"&&null},{style:"font-style=normal",clearMark:n=>n.type.name===this.name},{style:"font-style=italic"}]},renderHTML({HTMLAttributes:n}){return["em",me(this.options.HTMLAttributes,n),0]},addCommands(){return{setItalic:()=>({commands:n})=>n.setMark(this.name),toggleItalic:()=>({commands:n})=>n.toggleMark(this.name),unsetItalic:()=>({commands:n})=>n.unsetMark(this.name)}},markdownTokenName:"em",parseMarkdown:(n,e)=>e.applyMark("italic",e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>`*${e.renderChildren(n)}*`,addKeyboardShortcuts(){return{"Mod-i":()=>this.editor.commands.toggleItalic(),"Mod-I":()=>this.editor.commands.toggleItalic()}},addInputRules(){return[Yn({find:mT,type:this.type}),Yn({find:yT,type:this.type})]},addPasteRules(){return[gn({find:gT,type:this.type}),gn({find:wT,type:this.type})]}});const vT="aaa1rp3bb0ott3vie4c1le2ogado5udhabi7c0ademy5centure6ountant0s9o1tor4d0s1ult4e0g1ro2tna4f0l1rica5g0akhan5ency5i0g1rbus3force5tel5kdn3l0ibaba4pay4lfinanz6state5y2sace3tom5m0azon4ericanexpress7family11x2fam3ica3sterdam8nalytics7droid5quan4z2o0l2partments8p0le4q0uarelle8r0ab1mco4chi3my2pa2t0e3s0da2ia2sociates9t0hleta5torney7u0ction5di0ble3o3spost5thor3o0s4w0s2x0a2z0ure5ba0by2idu3namex4d1k2r0celona5laycard4s5efoot5gains6seball5ketball8uhaus5yern5b0c1t1va3cg1n2d1e0ats2uty4er2rlin4st0buy5t2f1g1h0arti5i0ble3d1ke2ng0o3o1z2j1lack0friday9ockbuster8g1omberg7ue3m0s1w2n0pparibas9o0ats3ehringer8fa2m1nd2o0k0ing5sch2tik2on4t1utique6x2r0adesco6idgestone9oadway5ker3ther5ussels7s1t1uild0ers6siness6y1zz3v1w1y1z0h3ca0b1fe2l0l1vinklein9m0era3p2non3petown5ital0one8r0avan4ds2e0er0s4s2sa1e1h1ino4t0ering5holic7ba1n1re3c1d1enter4o1rn3f0a1d2g1h0anel2nel4rity4se2t2eap3intai5ristmas6ome4urch5i0priani6rcle4sco3tadel4i0c2y3k1l0aims4eaning6ick2nic1que6othing5ud3ub0med6m1n1o0ach3des3ffee4llege4ogne5m0mbank4unity6pany2re3uter5sec4ndos3struction8ulting7tact3ractors9oking4l1p2rsica5untry4pon0s4rses6pa2r0edit0card4union9icket5own3s1uise0s6u0isinella9v1w1x1y0mru3ou3z2dad1nce3ta1e1ing3sun4y2clk3ds2e0al0er2s3gree4livery5l1oitte5ta3mocrat6ntal2ist5si0gn4v2hl2iamonds6et2gital5rect0ory7scount3ver5h2y2j1k1m1np2o0cs1tor4g1mains5t1wnload7rive4tv2ubai3nlop4pont4rban5vag2r2z2earth3t2c0o2deka3u0cation8e1g1mail3erck5nergy4gineer0ing9terprises10pson4quipment8r0icsson6ni3s0q1tate5t1u0rovision8s2vents5xchange6pert3osed4ress5traspace10fage2il1rwinds6th3mily4n0s2rm0ers5shion4t3edex3edback6rrari3ero6i0delity5o2lm2nal1nce1ial7re0stone6mdale6sh0ing5t0ness6j1k1lickr3ghts4r2orist4wers5y2m1o0o0d1tball6rd1ex2sale4um3undation8x2r0ee1senius7l1ogans4ntier7tr2ujitsu5n0d2rniture7tbol5yi3ga0l0lery3o1up4me0s3p1rden4y2b0iz3d0n2e0a1nt0ing5orge5f1g0ee3h1i0ft0s3ves2ing5l0ass3e1obal2o4m0ail3bh2o1x2n1odaddy5ld0point6f2o0dyear5g0le4p1t1v2p1q1r0ainger5phics5tis4een3ipe3ocery4up4s1t1u0cci3ge2ide2tars5ru3w1y2hair2mburg5ngout5us3bo2dfc0bank7ealth0care8lp1sinki6re1mes5iphop4samitsu7tachi5v2k0t2m1n1ockey4ldings5iday5medepot5goods5s0ense7nda3rse3spital5t0ing5t0els3mail5use3w2r1sbc3t1u0ghes5yatt3undai7ibm2cbc2e1u2d1e0ee3fm2kano4l1m0amat4db2mo0bilien9n0c1dustries8finiti5o2g1k1stitute6urance4e4t0ernational10uit4vestments10o1piranga7q1r0ish4s0maili5t0anbul7t0au2v3jaguar4va3cb2e0ep2tzt3welry6io2ll2m0p2nj2o0bs1urg4t1y2p0morgan6rs3uegos4niper7kaufen5ddi3e0rryhotels6properties14fh2g1h1i0a1ds2m1ndle4tchen5wi3m1n1oeln3matsu5sher5p0mg2n2r0d1ed3uokgroup8w1y0oto4z2la0caixa5mborghini8er3nd0rover6xess5salle5t0ino3robe5w0yer5b1c1ds2ease3clerc5frak4gal2o2xus4gbt3i0dl2fe0insurance9style7ghting6ke2lly3mited4o2ncoln4k2ve1ing5k1lc1p2oan0s3cker3us3l1ndon4tte1o3ve3pl0financial11r1s1t0d0a3u0ndbeck6xe1ury5v1y2ma0drid4if1son4keup4n0agement7go3p1rket0ing3s4riott5shalls7ttel5ba2c0kinsey7d1e0d0ia3et2lbourne7me1orial6n0u2rckmsd7g1h1iami3crosoft7l1ni1t2t0subishi9k1l0b1s2m0a2n1o0bi0le4da2e1i1m1nash3ey2ster5rmon3tgage6scow4to0rcycles9v0ie4p1q1r1s0d2t0n1r2u0seum3ic4v1w1x1y1z2na0b1goya4me2vy3ba2c1e0c1t0bank4flix4work5ustar5w0s2xt0direct7us4f0l2g0o2hk2i0co2ke1on3nja3ssan1y5l1o0kia3rton4w0ruz3tv4p1r0a1w2tt2u1yc2z2obi1server7ffice5kinawa6layan0group9lo3m0ega4ne1g1l0ine5oo2pen3racle3nge4g0anic5igins6saka4tsuka4t2vh3pa0ge2nasonic7ris2s1tners4s1y3y2ccw3e0t2f0izer5g1h0armacy6d1ilips5one2to0graphy6s4ysio5ics1tet2ures6d1n0g1k2oneer5zza4k1l0ace2y0station9umbing5s3m1n0c2ohl2ker3litie5rn2st3r0axi3ess3ime3o0d0uctions8f1gressive8mo2perties3y5tection8u0dential9s1t1ub2w0c2y2qa1pon3uebec3st5racing4dio4e0ad1lestate6tor2y4cipes5d0stone5umbrella9hab3ise0n3t2liance6n0t0als5pair3ort3ublican8st0aurant8view0s5xroth6ich0ardli6oh3l1o1p2o0cks3deo3gers4om3s0vp3u0gby3hr2n2w0e2yukyu6sa0arland6fe0ty4kura4le1on3msclub4ung5ndvik0coromant12ofi4p1rl2s1ve2xo3b0i1s2c0b1haeffler7midt4olarships8ol3ule3warz5ience5ot3d1e0arch3t2cure1ity6ek2lect4ner3rvices6ven3w1x0y3fr2g1h0angrila6rp3ell3ia1ksha5oes2p0ping5uji3w3i0lk2na1gles5te3j1k0i0n2y0pe4l0ing4m0art3ile4n0cf3o0ccer3ial4ftbank4ware6hu2lar2utions7ng1y2y2pa0ce3ort2t3r0l2s1t0ada2ples4r1tebank4farm7c0group6ockholm6rage3e3ream4udio2y3yle4u0cks3pplies3y2ort5rf1gery5zuki5v1watch4iss4x1y0dney4stems6z2tab1ipei4lk2obao4rget4tamotors6r2too4x0i3c0i2d0k2eam2ch0nology8l1masek5nnis4va3f1g1h0d1eater2re6iaa2ckets5enda4ps2res2ol4j0maxx4x2k0maxx5l1m0all4n1o0day3kyo3ols3p1ray3shiba5tal3urs3wn2yota3s3r0ade1ing4ining5vel0ers0insurance16ust3v2t1ube2i1nes3shu4v0s2w1z2ua1bank3s2g1k1nicom3versity8o2ol2ps2s1y1z2va0cations7na1guard7c1e0gas3ntures6risign5mgensberater2ung14sicherung10t2g1i0ajes4deo3g1king4llas4n1p1rgin4sa1ion4va1o3laanderen9n1odka3lvo3te1ing3o2yage5u2wales2mart4ter4ng0gou5tch0es6eather0channel12bcam3er2site5d0ding5ibo2r3f1hoswho6ien2ki2lliamhill9n0dows4e1ners6me2olterskluwer11odside6rk0s2ld3w2s1tc1f3xbox3erox4ihuan4n2xx2yz3yachts4hoo3maxun5ndex5e1odobashi7ga2kohama6u0tube6t1un3za0ppos4ra3ero3ip2m1one3uerich6w2",kT="121342632165322333335355455655552435435422463632574574330355524444661154543332344423364211133222221212112052232222232212222223222241112222224322321222",Wl="numeric",Kl="ascii",Gl="alpha",as="asciinumeric",Zr="alphanumeric",Jl="domain",gm="emoji",ST="scheme",_T="slashscheme",Xa="whitespace";function xT(n,e){return n in e||(e[n]=[]),e[n]}function Dn(n,e,t){e[Wl]&&(e[as]=!0,e[Zr]=!0),e[Kl]&&(e[as]=!0,e[Gl]=!0),e[as]&&(e[Zr]=!0),e[Gl]&&(e[Zr]=!0),e[Zr]&&(e[Jl]=!0),e[gm]&&(e[Jl]=!0);for(const r in e){const s=xT(r,t);s.indexOf(n)<0&&s.push(n)}}function TT(n,e){const t={};for(const r in e)e[r].indexOf(n)>=0&&(t[r]=!0);return t}function Ue(n=null){this.j={},this.jr=[],this.jd=null,this.t=n}Ue.groups={};Ue.prototype={accepts(){return!!this.t},go(n){const e=this,t=e.j[n];if(t)return t;for(let r=0;r<e.jr.length;r++){const s=e.jr[r][0],i=e.jr[r][1];if(i&&s.test(n))return i}return e.jd},has(n,e=!1){return e?n in this.j:!!this.go(n)},ta(n,e,t,r){for(let s=0;s<n.length;s++)this.tt(n[s],e,t,r)},tr(n,e,t,r){r=r||Ue.groups;let s;return e&&e.j?s=e:(s=new Ue(e),t&&r&&Dn(e,t,r)),this.jr.push([n,s]),s},ts(n,e,t,r){let s=this;const i=n.length;if(!i)return s;for(let o=0;o<i-1;o++)s=s.tt(n[o]);return s.tt(n[i-1],e,t,r)},tt(n,e,t,r){r=r||Ue.groups;const s=this;if(e&&e.j)return s.j[n]=e,e;const i=e;let o,a=s.go(n);if(a?(o=new Ue,Object.assign(o.j,a.j),o.jr.push.apply(o.jr,a.jr),o.jd=a.jd,o.t=a.t):o=new Ue,i){if(r)if(o.t&&typeof o.t=="string"){const l=Object.assign(TT(o.t,r),t);Dn(i,l,r)}else t&&Dn(i,t,r);o.t=i}return s.j[n]=o,o}};const K=(n,e,t,r,s)=>n.ta(e,t,r,s),de=(n,e,t,r,s)=>n.tr(e,t,r,s),eh=(n,e,t,r,s)=>n.ts(e,t,r,s),C=(n,e,t,r,s)=>n.tt(e,t,r,s),$t="WORD",Yl="UWORD",ym="ASCIINUMERICAL",wm="ALPHANUMERICAL",$s="LOCALHOST",Xl="TLD",Ql="UTLD",Mi="SCHEME",gr="SLASH_SCHEME",Kc="NUM",Zl="WS",Gc="NL",ls="OPENBRACE",cs="CLOSEBRACE",to="OPENBRACKET",no="CLOSEBRACKET",ro="OPENPAREN",so="CLOSEPAREN",io="OPENANGLEBRACKET",oo="CLOSEANGLEBRACKET",ao="FULLWIDTHLEFTPAREN",lo="FULLWIDTHRIGHTPAREN",co="LEFTCORNERBRACKET",uo="RIGHTCORNERBRACKET",ho="LEFTWHITECORNERBRACKET",fo="RIGHTWHITECORNERBRACKET",po="FULLWIDTHLESSTHAN",mo="FULLWIDTHGREATERTHAN",go="AMPERSAND",yo="APOSTROPHE",wo="ASTERISK",Xt="AT",bo="BACKSLASH",vo="BACKTICK",ko="CARET",nn="COLON",Jc="COMMA",So="DOLLAR",yt="DOT",_o="EQUALS",Yc="EXCLAMATION",Ze="HYPHEN",ds="PERCENT",xo="PIPE",To="PLUS",Eo="POUND",us="QUERY",Xc="QUOTE",bm="FULLWIDTHMIDDLEDOT",Qc="SEMI",wt="SLASH",hs="TILDE",Co="UNDERSCORE",vm="EMOJI",Ao="SYM";var km=Object.freeze({__proto__:null,ALPHANUMERICAL:wm,AMPERSAND:go,APOSTROPHE:yo,ASCIINUMERICAL:ym,ASTERISK:wo,AT:Xt,BACKSLASH:bo,BACKTICK:vo,CARET:ko,CLOSEANGLEBRACKET:oo,CLOSEBRACE:cs,CLOSEBRACKET:no,CLOSEPAREN:so,COLON:nn,COMMA:Jc,DOLLAR:So,DOT:yt,EMOJI:vm,EQUALS:_o,EXCLAMATION:Yc,FULLWIDTHGREATERTHAN:mo,FULLWIDTHLEFTPAREN:ao,FULLWIDTHLESSTHAN:po,FULLWIDTHMIDDLEDOT:bm,FULLWIDTHRIGHTPAREN:lo,HYPHEN:Ze,LEFTCORNERBRACKET:co,LEFTWHITECORNERBRACKET:ho,LOCALHOST:$s,NL:Gc,NUM:Kc,OPENANGLEBRACKET:io,OPENBRACE:ls,OPENBRACKET:to,OPENPAREN:ro,PERCENT:ds,PIPE:xo,PLUS:To,POUND:Eo,QUERY:us,QUOTE:Xc,RIGHTCORNERBRACKET:uo,RIGHTWHITECORNERBRACKET:fo,SCHEME:Mi,SEMI:Qc,SLASH:wt,SLASH_SCHEME:gr,SYM:Ao,TILDE:hs,TLD:Xl,UNDERSCORE:Co,UTLD:Ql,UWORD:Yl,WORD:$t,WS:Zl});const Ot=/[a-z]/,Gr=new RegExp("\\p{L}","u"),Qa=new RegExp("\\p{Emoji}","u"),Nt=/\d/,Za=/\s/,th="\r",el=`
`,ET="",CT="",tl="";let bi=null,vi=null;function AT(n=[]){const e={};Ue.groups=e;const t=new Ue;bi==null&&(bi=nh(vT)),vi==null&&(vi=nh(kT)),C(t,"'",yo),C(t,"{",ls),C(t,"}",cs),C(t,"[",to),C(t,"]",no),C(t,"(",ro),C(t,")",so),C(t,"<",io),C(t,">",oo),C(t,"",ao),C(t,"",lo),C(t,"",co),C(t,"",uo),C(t,"",ho),C(t,"",fo),C(t,"",po),C(t,"",mo),C(t,"&",go),C(t,"*",wo),C(t,"@",Xt),C(t,"`",vo),C(t,"^",ko),C(t,":",nn),C(t,",",Jc),C(t,"$",So),C(t,".",yt),C(t,"=",_o),C(t,"!",Yc),C(t,"-",Ze),C(t,"%",ds),C(t,"|",xo),C(t,"+",To),C(t,"#",Eo),C(t,"?",us),C(t,'"',Xc),C(t,"/",wt),C(t,";",Qc),C(t,"~",hs),C(t,"_",Co),C(t,"\\",bo),C(t,"",bm);const r=de(t,Nt,Kc,{[Wl]:!0});de(r,Nt,r);const s=de(r,Ot,ym,{[as]:!0}),i=de(r,Gr,wm,{[Zr]:!0}),o=de(t,Ot,$t,{[Kl]:!0});de(o,Nt,s),de(o,Ot,o),de(s,Nt,s),de(s,Ot,s);const a=de(t,Gr,Yl,{[Gl]:!0});de(a,Ot),de(a,Nt,i),de(a,Gr,a),de(i,Nt,i),de(i,Ot),de(i,Gr,i);const l=C(t,el,Gc,{[Xa]:!0}),c=C(t,th,Zl,{[Xa]:!0}),d=de(t,Za,Zl,{[Xa]:!0});C(t,tl,d),C(c,el,l),C(c,tl,d),de(c,Za,d),C(d,th),C(d,el),de(d,Za,d),C(d,tl,d);const h=de(t,Qa,vm,{[gm]:!0});C(h,"#"),de(h,Qa,h),C(h,ET,h);const f=C(h,CT);C(f,"#"),de(f,Qa,h);const p=[[Ot,o],[Nt,s]],m=[[Ot,null],[Gr,a],[Nt,i]];for(let g=0;g<bi.length;g++)Kt(t,bi[g],Xl,$t,p);for(let g=0;g<vi.length;g++)Kt(t,vi[g],Ql,Yl,m);Dn(Xl,{tld:!0,ascii:!0},e),Dn(Ql,{utld:!0,alpha:!0},e),Kt(t,"file",Mi,$t,p),Kt(t,"mailto",Mi,$t,p),Kt(t,"http",gr,$t,p),Kt(t,"https",gr,$t,p),Kt(t,"ftp",gr,$t,p),Kt(t,"ftps",gr,$t,p),Dn(Mi,{scheme:!0,ascii:!0},e),Dn(gr,{slashscheme:!0,ascii:!0},e),n=n.sort((g,y)=>g[0]>y[0]?1:-1);for(let g=0;g<n.length;g++){const y=n[g][0],v=n[g][1]?{[ST]:!0}:{[_T]:!0};y.indexOf("-")>=0?v[Jl]=!0:Ot.test(y)?Nt.test(y)?v[as]=!0:v[Kl]=!0:v[Wl]=!0,eh(t,y,y,v)}return eh(t,"localhost",$s,{ascii:!0}),t.jd=new Ue(Ao),{start:t,tokens:Object.assign({groups:e},km)}}function Sm(n,e){const t=MT(e.replace(/[A-Z]/g,a=>a.toLowerCase())),r=t.length,s=[];let i=0,o=0;for(;o<r;){let a=n,l=null,c=0,d=null,h=-1,f=-1;for(;o<r&&(l=a.go(t[o]));)a=l,a.accepts()?(h=0,f=0,d=a):h>=0&&(h+=t[o].length,f++),c+=t[o].length,i+=t[o].length,o++;i-=h,o-=f,c-=h,s.push({t:d.t,v:e.slice(i-c,i),s:i-c,e:i})}return s}function MT(n){const e=[],t=n.length;let r=0;for(;r<t;){let s=n.charCodeAt(r),i,o=s<55296||s>56319||r+1===t||(i=n.charCodeAt(r+1))<56320||i>57343?n[r]:n.slice(r,r+2);e.push(o),r+=o.length}return e}function Kt(n,e,t,r,s){let i;const o=e.length;for(let a=0;a<o-1;a++){const l=e[a];n.j[l]?i=n.j[l]:(i=new Ue(r),i.jr=s.slice(),n.j[l]=i),n=i}return i=new Ue(t),i.jr=s.slice(),n.j[e[o-1]]=i,i}function nh(n){const e=[],t=[];let r=0,s="0123456789";for(;r<n.length;){let i=0;for(;s.indexOf(n[r+i])>=0;)i++;if(i>0){e.push(t.join(""));for(let o=parseInt(n.substring(r,r+i),10);o>0;o--)t.pop();r+=i}else t.push(n[r]),r++}return e}const Rs={defaultProtocol:"http",events:null,format:rh,formatHref:rh,nl2br:!1,tagName:"a",target:null,rel:null,validate:!0,truncate:1/0,className:null,attributes:null,ignoreTags:[],render:null};function Zc(n,e=null){let t=Object.assign({},Rs);n&&(t=Object.assign(t,n instanceof Zc?n.o:n));const r=t.ignoreTags,s=[];for(let i=0;i<r.length;i++)s.push(r[i].toUpperCase());this.o=t,e&&(this.defaultRender=e),this.ignoreTags=s}Zc.prototype={o:Rs,ignoreTags:[],defaultRender(n){return n},check(n){return this.get("validate",n.toString(),n)},get(n,e,t){const r=e!=null;let s=this.o[n];return s&&(typeof s=="object"?(s=t.t in s?s[t.t]:Rs[n],typeof s=="function"&&r&&(s=s(e,t))):typeof s=="function"&&r&&(s=s(e,t.t,t)),s)},getObj(n,e,t){let r=this.o[n];return typeof r=="function"&&e!=null&&(r=r(e,t.t,t)),r},render(n){const e=n.render(this);return(this.get("render",null,n)||this.defaultRender)(e,n.t,n)}};function rh(n){return n}function _m(n,e){this.t="token",this.v=n,this.tk=e}_m.prototype={isLink:!1,toString(){return this.v},toHref(n){return this.toString()},toFormattedString(n){const e=this.toString(),t=n.get("truncate",e,this),r=n.get("format",e,this);return t&&r.length>t?r.substring(0,t)+"":r},toFormattedHref(n){return n.get("formatHref",this.toHref(n.get("defaultProtocol")),this)},startIndex(){return this.tk[0].s},endIndex(){return this.tk[this.tk.length-1].e},toObject(n=Rs.defaultProtocol){return{type:this.t,value:this.toString(),isLink:this.isLink,href:this.toHref(n),start:this.startIndex(),end:this.endIndex()}},toFormattedObject(n){return{type:this.t,value:this.toFormattedString(n),isLink:this.isLink,href:this.toFormattedHref(n),start:this.startIndex(),end:this.endIndex()}},validate(n){return n.get("validate",this.toString(),this)},render(n){const e=this,t=this.toHref(n.get("defaultProtocol")),r=n.get("formatHref",t,this),s=n.get("tagName",t,e),i=this.toFormattedString(n),o={},a=n.get("className",t,e),l=n.get("target",t,e),c=n.get("rel",t,e),d=n.getObj("attributes",t,e),h=n.getObj("events",t,e);return o.href=r,a&&(o.class=a),l&&(o.target=l),c&&(o.rel=c),d&&Object.assign(o,d),{tagName:s,attributes:o,content:i,eventListeners:h}}};function ia(n,e){class t extends _m{constructor(s,i){super(s,i),this.t=n}}for(const r in e)t.prototype[r]=e[r];return t.t=n,t}const sh=ia("email",{isLink:!0,toHref(){return"mailto:"+this.toString()}}),ih=ia("text"),IT=ia("nl"),ki=ia("url",{isLink:!0,toHref(n=Rs.defaultProtocol){return this.hasProtocol()?this.v:`${n}://${this.v}`},hasProtocol(){const n=this.tk;return n.length>=2&&n[0].t!==$s&&n[1].t===nn}}),Qe=n=>new Ue(n);function OT({groups:n}){const e=n.domain.concat([go,wo,Xt,bo,vo,ko,So,_o,Ze,Kc,ds,xo,To,Eo,wt,Ao,hs,Co]),t=[yo,nn,Jc,yt,Yc,ds,us,Xc,Qc,io,oo,ls,cs,no,to,ro,so,ao,lo,co,uo,ho,fo,po,mo],r=[go,yo,wo,bo,vo,ko,So,_o,Ze,ls,cs,ds,xo,To,Eo,us,wt,Ao,hs,Co],s=Qe(),i=C(s,hs);K(i,r,i),K(i,n.domain,i);const o=Qe(),a=Qe(),l=Qe();K(s,n.domain,o),K(s,n.scheme,a),K(s,n.slashscheme,l),K(o,r,i),K(o,n.domain,o);const c=C(o,Xt);C(i,Xt,c),C(a,Xt,c),C(l,Xt,c);const d=C(i,yt);K(d,r,i),K(d,n.domain,i);const h=Qe();K(c,n.domain,h),K(h,n.domain,h);const f=C(h,yt);K(f,n.domain,h);const p=Qe(sh);K(f,n.tld,p),K(f,n.utld,p),C(c,$s,p);const m=C(h,Ze);C(m,Ze,m),K(m,n.domain,h),K(p,n.domain,h),C(p,yt,f),C(p,Ze,m);const g=C(p,nn);K(g,n.numeric,sh);const y=C(o,Ze),w=C(o,yt);C(y,Ze,y),K(y,n.domain,o),K(w,r,i),K(w,n.domain,o);const v=Qe(ki);K(w,n.tld,v),K(w,n.utld,v),K(v,n.domain,o),K(v,r,i),C(v,yt,w),C(v,Ze,y),C(v,Xt,c);const b=C(v,nn),S=Qe(ki);K(b,n.numeric,S);const k=Qe(ki),_=Qe();K(k,e,k),K(k,t,_),K(_,e,k),K(_,t,_),C(v,wt,k),C(S,wt,k);const x=C(a,nn),E=C(l,nn),N=C(E,wt),H=C(N,wt);K(a,n.domain,o),C(a,yt,w),C(a,Ze,y),K(l,n.domain,o),C(l,yt,w),C(l,Ze,y),K(x,n.domain,k),C(x,wt,k),C(x,us,k),K(H,n.domain,k),K(H,e,k),C(H,wt,k);const A=[[ls,cs],[to,no],[ro,so],[io,oo],[ao,lo],[co,uo],[ho,fo],[po,mo]];for(let J=0;J<A.length;J++){const[ee,P]=A[J],Y=C(k,ee);C(_,ee,Y),C(Y,P,k);const I=Qe(ki);K(Y,e,I);const q=Qe();K(Y,t),K(I,e,I),K(I,t,q),K(q,e,I),K(q,t,q),C(I,P,k),C(q,P,k)}return C(s,$s,v),C(s,Gc,IT),{start:s,tokens:km}}function NT(n,e,t){let r=t.length,s=0,i=[],o=[];for(;s<r;){let a=n,l=null,c=null,d=0,h=null,f=-1;for(;s<r&&!(l=a.go(t[s].t));)o.push(t[s++]);for(;s<r&&(c=l||a.go(t[s].t));)l=null,a=c,a.accepts()?(f=0,h=a):f>=0&&f++,s++,d++;if(f<0)s-=d,s<r&&(o.push(t[s]),s++);else{o.length>0&&(i.push(nl(ih,e,o)),o=[]),s-=f,d-=f;const p=h.t,m=t.slice(s-d,s);i.push(nl(p,e,m))}}return o.length>0&&i.push(nl(ih,e,o)),i}function nl(n,e,t){const r=t[0].s,s=t[t.length-1].e,i=e.slice(r,s);return new n(i,t)}const $T=typeof console<"u"&&console&&console.warn||(()=>{}),RT="until manual call of linkify.init(). Register all schemes and plugins before invoking linkify the first time.",oe={scanner:null,parser:null,tokenQueue:[],pluginQueue:[],customSchemes:[],initialized:!1};function PT(){return Ue.groups={},oe.scanner=null,oe.parser=null,oe.tokenQueue=[],oe.pluginQueue=[],oe.customSchemes=[],oe.initialized=!1,oe}function oh(n,e=!1){if(oe.initialized&&$T(`linkifyjs: already initialized - will not register custom scheme "${n}" ${RT}`),!/^[0-9a-z]+(-[0-9a-z]+)*$/.test(n))throw new Error(`linkifyjs: incorrect scheme format.
1. Must only contain digits, lowercase ASCII letters or "-"
2. Cannot start or end with "-"
3. "-" cannot repeat`);oe.customSchemes.push([n,e])}function DT(){oe.scanner=AT(oe.customSchemes);for(let n=0;n<oe.tokenQueue.length;n++)oe.tokenQueue[n][1]({scanner:oe.scanner});oe.parser=OT(oe.scanner.tokens);for(let n=0;n<oe.pluginQueue.length;n++)oe.pluginQueue[n][1]({scanner:oe.scanner,parser:oe.parser});return oe.initialized=!0,oe}function ed(n){return oe.initialized||DT(),NT(oe.parser.start,n,Sm(oe.scanner.start,n))}ed.scan=Sm;function xm(n,e=null,t=null){if(e&&typeof e=="object"){if(t)throw Error(`linkifyjs: Invalid link type ${e}; must be a string`);t=e,e=null}const r=new Zc(t),s=ed(n),i=[];for(let o=0;o<s.length;o++){const a=s[o];a.isLink&&(!e||a.t===e)&&r.check(a)&&i.push(a.toFormattedObject(r))}return i}var td="[\0- -\u2029]",LT=new RegExp(td),jT=new RegExp(`${td}$`),BT=new RegExp(td,"g");function FT(n){return n.length===1?n[0].isLink:n.length===3&&n[1].isLink?["()","[]"].includes(n[0].value+n[2].value):!1}function UT(n){return new le({key:new Se("autolink"),appendTransaction:(e,t,r)=>{const s=e.some(c=>c.docChanged)&&!t.doc.eq(r.doc),i=e.some(c=>c.getMeta("preventAutolink"));if(!s||i)return;const{tr:o}=r,a=Vp(t.doc,[...e]);if(Xp(a).forEach(({newRange:c})=>{const d=V_(r.doc,c,p=>p.isTextblock);let h,f;if(d.length>1)h=d[0],f=r.doc.textBetween(h.pos,h.pos+h.node.nodeSize,void 0," ");else if(d.length){const p=r.doc.textBetween(c.from,c.to," "," ");if(!jT.test(p))return;h=d[0],f=r.doc.textBetween(h.pos,c.to,void 0," ")}if(h&&f){const p=f.split(LT).filter(Boolean);if(p.length<=0)return!1;const m=p[p.length-1],g=h.pos+f.lastIndexOf(m);if(!m)return!1;const y=ed(m).map(w=>w.toObject(n.defaultProtocol));if(!FT(y))return!1;y.filter(w=>w.isLink).map(w=>({...w,from:g+w.start+1,to:g+w.end+1})).filter(w=>r.schema.marks.code?!r.doc.rangeHasMark(w.from,w.to,r.schema.marks.code):!0).filter(w=>n.validate(w.value)).filter(w=>n.shouldAutoLink(w.value)).forEach(w=>{zc(w.from,w.to,r.doc).some(v=>v.mark.type===n.type)||o.addMark(w.from,w.to,n.type.create({href:w.href}))})}}),!!o.steps.length)return o}})}function zT(n){return new le({key:new Se("handleClickLink"),props:{handleClick:(e,t,r)=>{var s,i;if(r.button!==0||!e.editable)return!1;let o=!1;if(n.enableClickSelection&&(o=n.editor.commands.extendMarkRange(n.type.name)),n.openOnClick){let a=null;if(r.target instanceof HTMLAnchorElement)a=r.target;else{let h=r.target;const f=[];for(;h.nodeName!=="DIV";)f.push(h),h=h.parentNode;a=f.find(p=>p.nodeName==="A")}if(!a)return o;const l=Yp(e.state,n.type.name),c=(s=a?.href)!=null?s:l.href,d=(i=a?.target)!=null?i:l.target;a&&c&&(window.open(c,d),o=!0)}return o}}})}function HT(n){return new le({key:new Se("handlePasteLink"),props:{handlePaste:(e,t,r)=>{const{shouldAutoLink:s}=n,{state:i}=e,{selection:o}=i,{empty:a}=o;if(a)return!1;let l="";r.content.forEach(d=>{l+=d.textContent});const c=xm(l,{defaultProtocol:n.defaultProtocol}).find(d=>d.isLink&&d.value===l);return!l||!c||s!==void 0&&!s(c.value)?!1:n.editor.commands.setMark(n.type,{href:c.href})}}})}function En(n,e){const t=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];return e&&e.forEach(r=>{const s=typeof r=="string"?r:r.scheme;s&&t.push(s)}),!n||n.replace(BT,"").match(new RegExp(`^(?:(?:${t.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var VT=Wt.create({name:"link",priority:1e3,keepOnSplit:!1,exitable:!0,onCreate(){this.options.validate&&!this.options.shouldAutoLink&&(this.options.shouldAutoLink=this.options.validate,console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")),this.options.protocols.forEach(n=>{if(typeof n=="string"){oh(n);return}oh(n.scheme,n.optionalSlashes)})},onDestroy(){PT()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:!0,enableClickSelection:!1,linkOnPaste:!0,autolink:!0,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(n,e)=>!!En(n,e.protocols),validate:n=>!!n,shouldAutoLink:n=>{const e=/^[a-z][a-z0-9+.-]*:\/\//i.test(n),t=/^[a-z][a-z0-9+.-]*:/i.test(n);if(e||t&&!n.includes("@"))return!0;const s=(n.includes("@")?n.split("@").pop():n).split(/[/?#:]/)[0];return!(/^\d{1,3}(\.\d{1,3}){3}$/.test(s)||!/\./.test(s))}}},addAttributes(){return{href:{default:null,parseHTML(n){return n.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:n=>{const e=n.getAttribute("href");return!e||!this.options.isAllowedUri(e,{defaultValidate:t=>!!En(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:null}}]},renderHTML({HTMLAttributes:n}){return this.options.isAllowedUri(n.href,{defaultValidate:e=>!!En(e,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",me(this.options.HTMLAttributes,n),0]:["a",me(this.options.HTMLAttributes,{...n,href:""}),0]},markdownTokenName:"link",parseMarkdown:(n,e)=>e.applyMark("link",e.parseInline(n.tokens||[]),{href:n.href,title:n.title||null}),renderMarkdown:(n,e)=>{var t;const r=((t=n.attrs)==null?void 0:t.href)||"";return`[${e.renderChildren(n)}](${r})`},addCommands(){return{setLink:n=>({chain:e})=>{const{href:t}=n;return this.options.isAllowedUri(t,{defaultValidate:r=>!!En(r,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?e().setMark(this.name,n).setMeta("preventAutolink",!0).run():!1},toggleLink:n=>({chain:e})=>{const{href:t}=n||{};return t&&!this.options.isAllowedUri(t,{defaultValidate:r=>!!En(r,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?!1:e().toggleMark(this.name,n,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()},unsetLink:()=>({chain:n})=>n().unsetMark(this.name,{extendEmptyMarkRange:!0}).setMeta("preventAutolink",!0).run()}},addPasteRules(){return[gn({find:n=>{const e=[];if(n){const{protocols:t,defaultProtocol:r}=this.options,s=xm(n).filter(i=>i.isLink&&this.options.isAllowedUri(i.value,{defaultValidate:o=>!!En(o,t),protocols:t,defaultProtocol:r}));s.length&&s.forEach(i=>{this.options.shouldAutoLink(i.value)&&e.push({text:i.value,data:{href:i.href},index:i.start})})}return e},type:this.type,getAttributes:n=>{var e;return{href:(e=n.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const n=[],{protocols:e,defaultProtocol:t}=this.options;return this.options.autolink&&n.push(UT({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:r=>this.options.isAllowedUri(r,{defaultValidate:s=>!!En(s,e),protocols:e,defaultProtocol:t}),shouldAutoLink:this.options.shouldAutoLink})),n.push(zT({type:this.type,editor:this.editor,openOnClick:this.options.openOnClick==="whenNotEditable"?!0:this.options.openOnClick,enableClickSelection:this.options.enableClickSelection})),this.options.linkOnPaste&&n.push(HT({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type,shouldAutoLink:this.options.shouldAutoLink})),n}}),qT=Object.defineProperty,WT=(n,e)=>{for(var t in e)qT(n,t,{get:e[t],enumerable:!0})},KT="listItem",ah="textStyle",lh=/^\s*([-+*])\s$/,Tm=Ye.create({name:"bulletList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:"ul"}]},renderHTML({HTMLAttributes:n}){return["ul",me(this.options.HTMLAttributes,n),0]},markdownTokenName:"list",parseMarkdown:(n,e)=>n.type!=="list"||n.ordered?[]:{type:"bulletList",content:n.items?e.parseChildren(n.items):[]},renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`
`):"",markdownOptions:{indentsContent:!0},addCommands(){return{toggleBulletList:()=>({commands:n,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(KT,this.editor.getAttributes(ah)).run():n.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-8":()=>this.editor.commands.toggleBulletList()}},addInputRules(){let n=$r({find:lh,type:this.type});return(this.options.keepMarks||this.options.keepAttributes)&&(n=$r({find:lh,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:()=>this.editor.getAttributes(ah),editor:this.editor})),[n]}}),Em=Ye.create({name:"listItem",addOptions(){return{HTMLAttributes:{},bulletListTypeName:"bulletList",orderedListTypeName:"orderedList"}},content:"paragraph block*",defining:!0,parseHTML(){return[{tag:"li"}]},renderHTML({HTMLAttributes:n}){return["li",me(this.options.HTMLAttributes,n),0]},markdownTokenName:"list_item",parseMarkdown:(n,e)=>{if(n.type!=="list_item")return[];let t=[];if(n.tokens&&n.tokens.length>0)if(n.tokens.some(s=>s.type==="paragraph"))t=e.parseChildren(n.tokens);else{const s=n.tokens[0];if(s&&s.type==="text"&&s.tokens&&s.tokens.length>0){if(t=[{type:"paragraph",content:e.parseInline(s.tokens)}],n.tokens.length>1){const o=n.tokens.slice(1),a=e.parseChildren(o);t.push(...a)}}else t=e.parseChildren(n.tokens)}return t.length===0&&(t=[{type:"paragraph",content:[]}]),{type:"listItem",content:t}},renderMarkdown:(n,e,t)=>Wc(n,e,r=>r.parentType==="bulletList"?"- ":r.parentType==="orderedList"?`${r.index+1}. `:"- ",t),addKeyboardShortcuts(){return{Enter:()=>this.editor.commands.splitListItem(this.name),Tab:()=>this.editor.commands.sinkListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)}}}),GT={};WT(GT,{findListItemPos:()=>qs,getNextListDepth:()=>nd,handleBackspace:()=>ec,handleDelete:()=>tc,hasListBefore:()=>Cm,hasListItemAfter:()=>JT,hasListItemBefore:()=>Am,listItemHasSubList:()=>Mm,nextListIsDeeper:()=>Im,nextListIsHigher:()=>Om});var qs=(n,e)=>{const{$from:t}=e.selection,r=ve(n,e.schema);let s=null,i=t.depth,o=t.pos,a=null;for(;i>0&&a===null;)s=t.node(i),s.type===r?a=i:(i-=1,o-=1);return a===null?null:{$pos:e.doc.resolve(o),depth:a}},nd=(n,e)=>{const t=qs(n,e);if(!t)return!1;const[,r]=ex(e,n,t.$pos.pos+4);return r},Cm=(n,e,t)=>{const{$anchor:r}=n.selection,s=Math.max(0,r.pos-2),i=n.doc.resolve(s).node();return!(!i||!t.includes(i.type.name))},Am=(n,e)=>{var t;const{$anchor:r}=e.selection,s=e.doc.resolve(r.pos-2);return!(s.index()===0||((t=s.nodeBefore)==null?void 0:t.type.name)!==n)},Mm=(n,e,t)=>{if(!t)return!1;const r=ve(n,e.schema);let s=!1;return t.descendants(i=>{i.type===r&&(s=!0)}),s},ec=(n,e,t)=>{if(n.commands.undoInputRule())return!0;if(n.state.selection.from!==n.state.selection.to)return!1;if(!mn(n.state,e)&&Cm(n.state,e,t)){const{$anchor:a}=n.state.selection,l=n.state.doc.resolve(a.before()-1),c=[];l.node().descendants((f,p)=>{f.type.name===e&&c.push({node:f,pos:p})});const d=c.at(-1);if(!d)return!1;const h=n.state.doc.resolve(l.start()+d.pos+1);return n.chain().cut({from:a.start()-1,to:a.end()+1},h.end()).joinForward().run()}if(!mn(n.state,e)||!sx(n.state))return!1;const r=qs(e,n.state);if(!r)return!1;const i=n.state.doc.resolve(r.$pos.pos-2).node(r.depth),o=Mm(e,n.state,i);return Am(e,n.state)&&!o?n.commands.joinItemBackward():n.chain().liftListItem(e).run()},Im=(n,e)=>{const t=nd(n,e),r=qs(n,e);return!r||!t?!1:t>r.depth},Om=(n,e)=>{const t=nd(n,e),r=qs(n,e);return!r||!t?!1:t<r.depth},tc=(n,e)=>{if(!mn(n.state,e)||!rx(n.state,e))return!1;const{selection:t}=n.state,{$from:r,$to:s}=t;return!t.empty&&r.sameParent(s)?!1:Im(e,n.state)?n.chain().focus(n.state.selection.from+4).lift(e).joinBackward().run():Om(e,n.state)?n.chain().joinForward().joinBackward().run():n.commands.joinItemForward()},JT=(n,e)=>{var t;const{$anchor:r}=e.selection,s=e.doc.resolve(r.pos-r.parentOffset-2);return!(s.index()===s.parent.childCount-1||((t=s.nodeAfter)==null?void 0:t.type.name)!==n)},Nm=Q.create({name:"listKeymap",addOptions(){return{listTypes:[{itemName:"listItem",wrapperNames:["bulletList","orderedList"]},{itemName:"taskItem",wrapperNames:["taskList"]}]}},addKeyboardShortcuts(){return{Delete:({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t})=>{n.state.schema.nodes[t]!==void 0&&tc(n,t)&&(e=!0)}),e},"Mod-Delete":({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t})=>{n.state.schema.nodes[t]!==void 0&&tc(n,t)&&(e=!0)}),e},Backspace:({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t,wrapperNames:r})=>{n.state.schema.nodes[t]!==void 0&&ec(n,t,r)&&(e=!0)}),e},"Mod-Backspace":({editor:n})=>{let e=!1;return this.options.listTypes.forEach(({itemName:t,wrapperNames:r})=>{n.state.schema.nodes[t]!==void 0&&ec(n,t,r)&&(e=!0)}),e}}}}),ch=/^(\s*)(\d+)\.\s+(.*)$/,YT=/^\s/;function XT(n){const e=[];let t=0,r=0;for(;t<n.length;){const s=n[t],i=s.match(ch);if(!i)break;const[,o,a,l]=i,c=o.length;let d=l,h=t+1;const f=[s];for(;h<n.length;){const p=n[h];if(p.match(ch))break;if(p.trim()==="")f.push(p),d+=`
`,h+=1;else if(p.match(YT))f.push(p),d+=`
${p.slice(c+2)}`,h+=1;else break}e.push({indent:c,number:parseInt(a,10),content:d.trim(),raw:f.join(`
`)}),r=h,t=h}return[e,r]}function $m(n,e,t){var r;const s=[];let i=0;for(;i<n.length;){const o=n[i];if(o.indent===e){const a=o.content.split(`
`),l=((r=a[0])==null?void 0:r.trim())||"",c=[];l&&c.push({type:"paragraph",raw:l,tokens:t.inlineTokens(l)});const d=a.slice(1).join(`
`).trim();if(d){const p=t.blockTokens(d);c.push(...p)}let h=i+1;const f=[];for(;h<n.length&&n[h].indent>e;)f.push(n[h]),h+=1;if(f.length>0){const p=Math.min(...f.map(g=>g.indent)),m=$m(f,p,t);c.push({type:"list",ordered:!0,start:f[0].number,items:m,raw:f.map(g=>g.raw).join(`
`)})}s.push({type:"list_item",raw:o.raw,tokens:c}),i=h}else i+=1}return s}function QT(n,e){return n.map(t=>{if(t.type!=="list_item")return e.parseChildren([t])[0];const r=[];return t.tokens&&t.tokens.length>0&&t.tokens.forEach(s=>{if(s.type==="paragraph"||s.type==="list"||s.type==="blockquote"||s.type==="code")r.push(...e.parseChildren([s]));else if(s.type==="text"&&s.tokens){const i=e.parseChildren([s]);r.push({type:"paragraph",content:i})}else{const i=e.parseChildren([s]);i.length>0&&r.push(...i)}}),{type:"listItem",content:r}})}var ZT="listItem",dh="textStyle",uh=/^(\d+)\.\s$/,Rm=Ye.create({name:"orderedList",addOptions(){return{itemTypeName:"listItem",HTMLAttributes:{},keepMarks:!1,keepAttributes:!1}},group:"block list",content(){return`${this.options.itemTypeName}+`},addAttributes(){return{start:{default:1,parseHTML:n=>n.hasAttribute("start")?parseInt(n.getAttribute("start")||"",10):1},type:{default:null,parseHTML:n=>n.getAttribute("type")}}},parseHTML(){return[{tag:"ol"}]},renderHTML({HTMLAttributes:n}){const{start:e,...t}=n;return e===1?["ol",me(this.options.HTMLAttributes,t),0]:["ol",me(this.options.HTMLAttributes,n),0]},markdownTokenName:"list",parseMarkdown:(n,e)=>{if(n.type!=="list"||!n.ordered)return[];const t=n.start||1,r=n.items?QT(n.items,e):[];return t!==1?{type:"orderedList",attrs:{start:t},content:r}:{type:"orderedList",content:r}},renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`
`):"",markdownTokenizer:{name:"orderedList",level:"block",start:n=>{const e=n.match(/^(\s*)(\d+)\.\s+/),t=e?.index;return t!==void 0?t:-1},tokenize:(n,e,t)=>{var r;const s=n.split(`
`),[i,o]=XT(s);if(i.length===0)return;const a=$m(i,0,t);return a.length===0?void 0:{type:"list",ordered:!0,start:((r=i[0])==null?void 0:r.number)||1,items:a,raw:s.slice(0,o).join(`
`)}}},markdownOptions:{indentsContent:!0},addCommands(){return{toggleOrderedList:()=>({commands:n,chain:e})=>this.options.keepAttributes?e().toggleList(this.name,this.options.itemTypeName,this.options.keepMarks).updateAttributes(ZT,this.editor.getAttributes(dh)).run():n.toggleList(this.name,this.options.itemTypeName,this.options.keepMarks)}},addKeyboardShortcuts(){return{"Mod-Shift-7":()=>this.editor.commands.toggleOrderedList()}},addInputRules(){let n=$r({find:uh,type:this.type,getAttributes:e=>({start:+e[1]}),joinPredicate:(e,t)=>t.childCount+t.attrs.start===+e[1]});return(this.options.keepMarks||this.options.keepAttributes)&&(n=$r({find:uh,type:this.type,keepMarks:this.options.keepMarks,keepAttributes:this.options.keepAttributes,getAttributes:e=>({start:+e[1],...this.editor.getAttributes(dh)}),joinPredicate:(e,t)=>t.childCount+t.attrs.start===+e[1],editor:this.editor})),[n]}}),eE=/^\s*(\[([( |x])?\])\s$/,tE=Ye.create({name:"taskItem",addOptions(){return{nested:!1,HTMLAttributes:{},taskListTypeName:"taskList",a11y:void 0}},content(){return this.options.nested?"paragraph block*":"paragraph+"},defining:!0,addAttributes(){return{checked:{default:!1,keepOnSplit:!1,parseHTML:n=>{const e=n.getAttribute("data-checked");return e===""||e==="true"},renderHTML:n=>({"data-checked":n.checked})}}},parseHTML(){return[{tag:`li[data-type="${this.name}"]`,priority:51}]},renderHTML({node:n,HTMLAttributes:e}){return["li",me(this.options.HTMLAttributes,e,{"data-type":this.name}),["label",["input",{type:"checkbox",checked:n.attrs.checked?"checked":null}],["span"]],["div",0]]},parseMarkdown:(n,e)=>{const t=[];if(n.tokens&&n.tokens.length>0?t.push(e.createNode("paragraph",{},e.parseInline(n.tokens))):n.text?t.push(e.createNode("paragraph",{},[e.createNode("text",{text:n.text})])):t.push(e.createNode("paragraph",{},[])),n.nestedTokens&&n.nestedTokens.length>0){const r=e.parseChildren(n.nestedTokens);t.push(...r)}return e.createNode("taskItem",{checked:n.checked||!1},t)},renderMarkdown:(n,e)=>{var t;const s=`- [${(t=n.attrs)!=null&&t.checked?"x":" "}] `;return Wc(n,e,s)},addKeyboardShortcuts(){const n={Enter:()=>this.editor.commands.splitListItem(this.name),"Shift-Tab":()=>this.editor.commands.liftListItem(this.name)};return this.options.nested?{...n,Tab:()=>this.editor.commands.sinkListItem(this.name)}:n},addNodeView(){return({node:n,HTMLAttributes:e,getPos:t,editor:r})=>{const s=document.createElement("li"),i=document.createElement("label"),o=document.createElement("span"),a=document.createElement("input"),l=document.createElement("div"),c=h=>{var f,p;a.ariaLabel=((p=(f=this.options.a11y)==null?void 0:f.checkboxLabel)==null?void 0:p.call(f,h,a.checked))||`Task item checkbox for ${h.textContent||"empty task item"}`};c(n),i.contentEditable="false",a.type="checkbox",a.addEventListener("mousedown",h=>h.preventDefault()),a.addEventListener("change",h=>{if(!r.isEditable&&!this.options.onReadOnlyChecked){a.checked=!a.checked;return}const{checked:f}=h.target;r.isEditable&&typeof t=="function"&&r.chain().focus(void 0,{scrollIntoView:!1}).command(({tr:p})=>{const m=t();if(typeof m!="number")return!1;const g=p.doc.nodeAt(m);return p.setNodeMarkup(m,void 0,{...g?.attrs,checked:f}),!0}).run(),!r.isEditable&&this.options.onReadOnlyChecked&&(this.options.onReadOnlyChecked(n,f)||(a.checked=!a.checked))}),Object.entries(this.options.HTMLAttributes).forEach(([h,f])=>{s.setAttribute(h,f)}),s.dataset.checked=n.attrs.checked,a.checked=n.attrs.checked,i.append(a,o),s.append(i,l),Object.entries(e).forEach(([h,f])=>{s.setAttribute(h,f)});let d=new Set(Object.keys(e));return{dom:s,contentDOM:l,update:h=>{if(h.type!==this.type)return!1;s.dataset.checked=h.attrs.checked,a.checked=h.attrs.checked,c(h);const f=r.extensionManager.attributes,p=Ns(h,f),m=new Set(Object.keys(p)),g=this.options.HTMLAttributes;return d.forEach(y=>{m.has(y)||(y in g?s.setAttribute(y,g[y]):s.removeAttribute(y))}),Object.entries(p).forEach(([y,w])=>{w==null?y in g?s.setAttribute(y,g[y]):s.removeAttribute(y):s.setAttribute(y,w)}),d=m,!0}}}},addInputRules(){return[$r({find:eE,type:this.type,getAttributes:n=>({checked:n[n.length-1]==="x"})})]}}),nE=Ye.create({name:"taskList",addOptions(){return{itemTypeName:"taskItem",HTMLAttributes:{}}},group:"block list",content(){return`${this.options.itemTypeName}+`},parseHTML(){return[{tag:`ul[data-type="${this.name}"]`,priority:51}]},renderHTML({HTMLAttributes:n}){return["ul",me(this.options.HTMLAttributes,n,{"data-type":this.name}),0]},parseMarkdown:(n,e)=>e.createNode("taskList",{},e.parseChildren(n.items||[])),renderMarkdown:(n,e)=>n.content?e.renderChildren(n.content,`
`):"",markdownTokenizer:{name:"taskList",level:"block",start(n){var e;const t=(e=n.match(/^\s*[-+*]\s+\[([ xX])\]\s+/))==null?void 0:e.index;return t!==void 0?t:-1},tokenize(n,e,t){const r=i=>{const o=ql(i,{itemPattern:/^(\s*)([-+*])\s+\[([ xX])\]\s+(.*)$/,extractItemData:a=>({indentLevel:a[1].length,mainContent:a[4],checked:a[3].toLowerCase()==="x"}),createToken:(a,l)=>({type:"taskItem",raw:"",mainContent:a.mainContent,indentLevel:a.indentLevel,checked:a.checked,text:a.mainContent,tokens:t.inlineTokens(a.mainContent),nestedTokens:l}),customNestedParser:r},t);return o?[{type:"taskList",raw:o.raw,items:o.items}]:t.blockTokens(i)},s=ql(n,{itemPattern:/^(\s*)([-+*])\s+\[([ xX])\]\s+(.*)$/,extractItemData:i=>({indentLevel:i[1].length,mainContent:i[4],checked:i[3].toLowerCase()==="x"}),createToken:(i,o)=>({type:"taskItem",raw:"",mainContent:i.mainContent,indentLevel:i.indentLevel,checked:i.checked,text:i.mainContent,tokens:t.inlineTokens(i.mainContent),nestedTokens:o}),customNestedParser:r},t);if(s)return{type:"taskList",raw:s.raw,items:s.items}}},markdownOptions:{indentsContent:!0},addCommands(){return{toggleTaskList:()=>({commands:n})=>n.toggleList(this.name,this.options.itemTypeName)}},addKeyboardShortcuts(){return{"Mod-Shift-9":()=>this.editor.commands.toggleTaskList()}}});Q.create({name:"listKit",addExtensions(){const n=[];return this.options.bulletList!==!1&&n.push(Tm.configure(this.options.bulletList)),this.options.listItem!==!1&&n.push(Em.configure(this.options.listItem)),this.options.listKeymap!==!1&&n.push(Nm.configure(this.options.listKeymap)),this.options.orderedList!==!1&&n.push(Rm.configure(this.options.orderedList)),this.options.taskItem!==!1&&n.push(tE.configure(this.options.taskItem)),this.options.taskList!==!1&&n.push(nE.configure(this.options.taskList)),n}});var rE=Ye.create({name:"paragraph",priority:1e3,addOptions(){return{HTMLAttributes:{}}},group:"block",content:"inline*",parseHTML(){return[{tag:"p"}]},renderHTML({HTMLAttributes:n}){return["p",me(this.options.HTMLAttributes,n),0]},parseMarkdown:(n,e)=>{const t=n.tokens||[];return t.length===1&&t[0].type==="image"?e.parseChildren([t[0]]):e.createNode("paragraph",void 0,e.parseInline(t))},renderMarkdown:(n,e)=>!n||!Array.isArray(n.content)?"":e.renderChildren(n.content),addCommands(){return{setParagraph:()=>({commands:n})=>n.setNode(this.name)}},addKeyboardShortcuts(){return{"Mod-Alt-0":()=>this.editor.commands.setParagraph()}}}),sE=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))$/,iE=/(?:^|\s)(~~(?!\s+~~)((?:[^~]+))~~(?!\s+~~))/g,oE=Wt.create({name:"strike",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"s"},{tag:"del"},{tag:"strike"},{style:"text-decoration",consuming:!1,getAttrs:n=>n.includes("line-through")?{}:!1}]},renderHTML({HTMLAttributes:n}){return["s",me(this.options.HTMLAttributes,n),0]},markdownTokenName:"del",parseMarkdown:(n,e)=>e.applyMark("strike",e.parseInline(n.tokens||[])),renderMarkdown:(n,e)=>`~~${e.renderChildren(n)}~~`,addCommands(){return{setStrike:()=>({commands:n})=>n.setMark(this.name),toggleStrike:()=>({commands:n})=>n.toggleMark(this.name),unsetStrike:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-s":()=>this.editor.commands.toggleStrike()}},addInputRules(){return[Yn({find:sE,type:this.type})]},addPasteRules(){return[gn({find:iE,type:this.type})]}}),aE=Ye.create({name:"text",group:"inline",parseMarkdown:n=>({type:"text",text:n.text||""}),renderMarkdown:n=>n.text||""}),lE=Wt.create({name:"underline",addOptions(){return{HTMLAttributes:{}}},parseHTML(){return[{tag:"u"},{style:"text-decoration",consuming:!1,getAttrs:n=>n.includes("underline")?{}:!1}]},renderHTML({HTMLAttributes:n}){return["u",me(this.options.HTMLAttributes,n),0]},parseMarkdown(n,e){return e.applyMark(this.name||"underline",e.parseInline(n.tokens||[]))},renderMarkdown(n,e){return`++${e.renderChildren(n)}++`},markdownTokenizer:{name:"underline",level:"inline",start(n){return n.indexOf("++")},tokenize(n,e,t){const s=/^(\+\+)([\s\S]+?)(\+\+)/.exec(n);if(!s)return;const i=s[2].trim();return{type:"underline",raw:s[0],text:i,tokens:t.inlineTokens(i)}}},addCommands(){return{setUnderline:()=>({commands:n})=>n.setMark(this.name),toggleUnderline:()=>({commands:n})=>n.toggleMark(this.name),unsetUnderline:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-u":()=>this.editor.commands.toggleUnderline(),"Mod-U":()=>this.editor.commands.toggleUnderline()}}});function cE(n={}){return new le({view(e){return new dE(e,n)}})}class dE{constructor(e,t){var r;this.editorView=e,this.cursorPos=null,this.element=null,this.timeout=-1,this.width=(r=t.width)!==null&&r!==void 0?r:1,this.color=t.color===!1?void 0:t.color||"black",this.class=t.class,this.handlers=["dragover","dragend","drop","dragleave"].map(s=>{let i=o=>{this[s](o)};return e.dom.addEventListener(s,i),{name:s,handler:i}})}destroy(){this.handlers.forEach(({name:e,handler:t})=>this.editorView.dom.removeEventListener(e,t))}update(e,t){this.cursorPos!=null&&t.doc!=e.state.doc&&(this.cursorPos>e.state.doc.content.size?this.setCursor(null):this.updateOverlay())}setCursor(e){e!=this.cursorPos&&(this.cursorPos=e,e==null?(this.element.parentNode.removeChild(this.element),this.element=null):this.updateOverlay())}updateOverlay(){let e=this.editorView.state.doc.resolve(this.cursorPos),t=!e.parent.inlineContent,r,s=this.editorView.dom,i=s.getBoundingClientRect(),o=i.width/s.offsetWidth,a=i.height/s.offsetHeight;if(t){let h=e.nodeBefore,f=e.nodeAfter;if(h||f){let p=this.editorView.nodeDOM(this.cursorPos-(h?h.nodeSize:0));if(p){let m=p.getBoundingClientRect(),g=h?m.bottom:m.top;h&&f&&(g=(g+this.editorView.nodeDOM(this.cursorPos).getBoundingClientRect().top)/2);let y=this.width/2*a;r={left:m.left,right:m.right,top:g-y,bottom:g+y}}}}if(!r){let h=this.editorView.coordsAtPos(this.cursorPos),f=this.width/2*o;r={left:h.left-f,right:h.left+f,top:h.top,bottom:h.bottom}}let l=this.editorView.dom.offsetParent;this.element||(this.element=l.appendChild(document.createElement("div")),this.class&&(this.element.className=this.class),this.element.style.cssText="position: absolute; z-index: 50; pointer-events: none;",this.color&&(this.element.style.backgroundColor=this.color)),this.element.classList.toggle("prosemirror-dropcursor-block",t),this.element.classList.toggle("prosemirror-dropcursor-inline",!t);let c,d;if(!l||l==document.body&&getComputedStyle(l).position=="static")c=-pageXOffset,d=-pageYOffset;else{let h=l.getBoundingClientRect(),f=h.width/l.offsetWidth,p=h.height/l.offsetHeight;c=h.left-l.scrollLeft*f,d=h.top-l.scrollTop*p}this.element.style.left=(r.left-c)/o+"px",this.element.style.top=(r.top-d)/a+"px",this.element.style.width=(r.right-r.left)/o+"px",this.element.style.height=(r.bottom-r.top)/a+"px"}scheduleRemoval(e){clearTimeout(this.timeout),this.timeout=setTimeout(()=>this.setCursor(null),e)}dragover(e){if(!this.editorView.editable)return;let t=this.editorView.posAtCoords({left:e.clientX,top:e.clientY}),r=t&&t.inside>=0&&this.editorView.state.doc.nodeAt(t.inside),s=r&&r.type.spec.disableDropCursor,i=typeof s=="function"?s(this.editorView,t,e):s;if(t&&!i){let o=t.pos;if(this.editorView.dragging&&this.editorView.dragging.slice){let a=Pf(this.editorView.state.doc,o,this.editorView.dragging.slice);a!=null&&(o=a)}this.setCursor(o),this.scheduleRemoval(5e3)}}dragend(){this.scheduleRemoval(20)}drop(){this.scheduleRemoval(20)}dragleave(e){this.editorView.dom.contains(e.relatedTarget)||this.setCursor(null)}}class fe extends G{constructor(e){super(e,e)}map(e,t){let r=e.resolve(t.map(this.head));return fe.valid(r)?new fe(r):G.near(r)}content(){return O.empty}eq(e){return e instanceof fe&&e.head==this.head}toJSON(){return{type:"gapcursor",pos:this.head}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for GapCursor.fromJSON");return new fe(e.resolve(t.pos))}getBookmark(){return new rd(this.anchor)}static valid(e){let t=e.parent;if(t.isTextblock||!uE(e)||!hE(e))return!1;let r=t.type.spec.allowGapCursor;if(r!=null)return r;let s=t.contentMatchAt(e.index()).defaultType;return s&&s.isTextblock}static findGapCursorFrom(e,t,r=!1){e:for(;;){if(!r&&fe.valid(e))return e;let s=e.pos,i=null;for(let o=e.depth;;o--){let a=e.node(o);if(t>0?e.indexAfter(o)<a.childCount:e.index(o)>0){i=a.child(t>0?e.indexAfter(o):e.index(o)-1);break}else if(o==0)return null;s+=t;let l=e.doc.resolve(s);if(fe.valid(l))return l}for(;;){let o=t>0?i.firstChild:i.lastChild;if(!o){if(i.isAtom&&!i.isText&&!D.isSelectable(i)){e=e.doc.resolve(s+i.nodeSize*t),r=!1;continue e}break}i=o,s+=t;let a=e.doc.resolve(s);if(fe.valid(a))return a}return null}}}fe.prototype.visible=!1;fe.findFrom=fe.findGapCursorFrom;G.jsonID("gapcursor",fe);class rd{constructor(e){this.pos=e}map(e){return new rd(e.map(this.pos))}resolve(e){let t=e.resolve(this.pos);return fe.valid(t)?new fe(t):G.near(t)}}function Pm(n){return n.isAtom||n.spec.isolating||n.spec.createGapCursor}function uE(n){for(let e=n.depth;e>=0;e--){let t=n.index(e),r=n.node(e);if(t==0){if(r.type.spec.isolating)return!0;continue}for(let s=r.child(t-1);;s=s.lastChild){if(s.childCount==0&&!s.inlineContent||Pm(s.type))return!0;if(s.inlineContent)return!1}}return!0}function hE(n){for(let e=n.depth;e>=0;e--){let t=n.indexAfter(e),r=n.node(e);if(t==r.childCount){if(r.type.spec.isolating)return!0;continue}for(let s=r.child(t);;s=s.firstChild){if(s.childCount==0&&!s.inlineContent||Pm(s.type))return!0;if(s.inlineContent)return!1}}return!0}function fE(){return new le({props:{decorations:yE,createSelectionBetween(n,e,t){return e.pos==t.pos&&fe.valid(t)?new fe(t):null},handleClick:mE,handleKeyDown:pE,handleDOMEvents:{beforeinput:gE}}})}const pE=Dp({ArrowLeft:Si("horiz",-1),ArrowRight:Si("horiz",1),ArrowUp:Si("vert",-1),ArrowDown:Si("vert",1)});function Si(n,e){const t=n=="vert"?e>0?"down":"up":e>0?"right":"left";return function(r,s,i){let o=r.selection,a=e>0?o.$to:o.$from,l=o.empty;if(o instanceof z){if(!i.endOfTextblock(t)||a.depth==0)return!1;l=!1,a=r.doc.resolve(e>0?a.after():a.before())}let c=fe.findGapCursorFrom(a,e,l);return c?(s&&s(r.tr.setSelection(new fe(c))),!0):!1}}function mE(n,e,t){if(!n||!n.editable)return!1;let r=n.state.doc.resolve(e);if(!fe.valid(r))return!1;let s=n.posAtCoords({left:t.clientX,top:t.clientY});return s&&s.inside>-1&&D.isSelectable(n.state.doc.nodeAt(s.inside))?!1:(n.dispatch(n.state.tr.setSelection(new fe(r))),!0)}function gE(n,e){if(e.inputType!="insertCompositionText"||!(n.state.selection instanceof fe))return!1;let{$from:t}=n.state.selection,r=t.parent.contentMatchAt(t.index()).findWrapping(n.state.schema.nodes.text);if(!r)return!1;let s=T.empty;for(let o=r.length-1;o>=0;o--)s=T.from(r[o].createAndFill(null,s));let i=n.state.tr.replace(t.pos,t.pos,new O(s,0,0));return i.setSelection(z.near(i.doc.resolve(t.pos+1))),n.dispatch(i),!1}function yE(n){if(!(n.selection instanceof fe))return null;let e=document.createElement("div");return e.className="ProseMirror-gapcursor",ae.create(n.doc,[Pe.widget(n.selection.head,e,{key:"gapcursor"})])}var Mo=200,Ce=function(){};Ce.prototype.append=function(e){return e.length?(e=Ce.from(e),!this.length&&e||e.length<Mo&&this.leafAppend(e)||this.length<Mo&&e.leafPrepend(this)||this.appendInner(e)):this};Ce.prototype.prepend=function(e){return e.length?Ce.from(e).append(this):this};Ce.prototype.appendInner=function(e){return new wE(this,e)};Ce.prototype.slice=function(e,t){return e===void 0&&(e=0),t===void 0&&(t=this.length),e>=t?Ce.empty:this.sliceInner(Math.max(0,e),Math.min(this.length,t))};Ce.prototype.get=function(e){if(!(e<0||e>=this.length))return this.getInner(e)};Ce.prototype.forEach=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=this.length),t<=r?this.forEachInner(e,t,r,0):this.forEachInvertedInner(e,t,r,0)};Ce.prototype.map=function(e,t,r){t===void 0&&(t=0),r===void 0&&(r=this.length);var s=[];return this.forEach(function(i,o){return s.push(e(i,o))},t,r),s};Ce.from=function(e){return e instanceof Ce?e:e&&e.length?new Dm(e):Ce.empty};var Dm=(function(n){function e(r){n.call(this),this.values=r}n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e;var t={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(s,i){return s==0&&i==this.length?this:new e(this.values.slice(s,i))},e.prototype.getInner=function(s){return this.values[s]},e.prototype.forEachInner=function(s,i,o,a){for(var l=i;l<o;l++)if(s(this.values[l],a+l)===!1)return!1},e.prototype.forEachInvertedInner=function(s,i,o,a){for(var l=i-1;l>=o;l--)if(s(this.values[l],a+l)===!1)return!1},e.prototype.leafAppend=function(s){if(this.length+s.length<=Mo)return new e(this.values.concat(s.flatten()))},e.prototype.leafPrepend=function(s){if(this.length+s.length<=Mo)return new e(s.flatten().concat(this.values))},t.length.get=function(){return this.values.length},t.depth.get=function(){return 0},Object.defineProperties(e.prototype,t),e})(Ce);Ce.empty=new Dm([]);var wE=(function(n){function e(t,r){n.call(this),this.left=t,this.right=r,this.length=t.length+r.length,this.depth=Math.max(t.depth,r.depth)+1}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(r){return r<this.left.length?this.left.get(r):this.right.get(r-this.left.length)},e.prototype.forEachInner=function(r,s,i,o){var a=this.left.length;if(s<a&&this.left.forEachInner(r,s,Math.min(i,a),o)===!1||i>a&&this.right.forEachInner(r,Math.max(s-a,0),Math.min(this.length,i)-a,o+a)===!1)return!1},e.prototype.forEachInvertedInner=function(r,s,i,o){var a=this.left.length;if(s>a&&this.right.forEachInvertedInner(r,s-a,Math.max(i,a)-a,o+a)===!1||i<a&&this.left.forEachInvertedInner(r,Math.min(s,a),i,o)===!1)return!1},e.prototype.sliceInner=function(r,s){if(r==0&&s==this.length)return this;var i=this.left.length;return s<=i?this.left.slice(r,s):r>=i?this.right.slice(r-i,s-i):this.left.slice(r,i).append(this.right.slice(0,s-i))},e.prototype.leafAppend=function(r){var s=this.right.leafAppend(r);if(s)return new e(this.left,s)},e.prototype.leafPrepend=function(r){var s=this.left.leafPrepend(r);if(s)return new e(s,this.right)},e.prototype.appendInner=function(r){return this.left.depth>=Math.max(this.right.depth,r.depth)+1?new e(this.left,new e(this.right,r)):new e(this,r)},e})(Ce);const bE=500;class ht{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let r=this.items.length;for(;;r--)if(this.items.get(r-1).selection){--r;break}let s,i;t&&(s=this.remapping(r,this.items.length),i=s.maps.length);let o=e.tr,a,l,c=[],d=[];return this.items.forEach((h,f)=>{if(!h.step){s||(s=this.remapping(r,f+1),i=s.maps.length),i--,d.push(h);return}if(s){d.push(new bt(h.map));let p=h.step.map(s.slice(i)),m;p&&o.maybeStep(p).doc&&(m=o.mapping.maps[o.mapping.maps.length-1],c.push(new bt(m,void 0,void 0,c.length+d.length))),i--,m&&s.appendMap(m,i)}else o.maybeStep(h.step);if(h.selection)return a=s?h.selection.map(s.slice(i)):h.selection,l=new ht(this.items.slice(0,r).append(d.reverse().concat(c)),this.eventCount-1),!1},this.items.length,0),{remaining:l,transform:o,selection:a}}addTransform(e,t,r,s){let i=[],o=this.eventCount,a=this.items,l=!s&&a.length?a.get(a.length-1):null;for(let d=0;d<e.steps.length;d++){let h=e.steps[d].invert(e.docs[d]),f=new bt(e.mapping.maps[d],h,t),p;(p=l&&l.merge(f))&&(f=p,d?i.pop():a=a.slice(0,a.length-1)),i.push(f),t&&(o++,t=void 0),s||(l=f)}let c=o-r.depth;return c>kE&&(a=vE(a,c),o-=c),new ht(a.append(i),o)}remapping(e,t){let r=new Es;return this.items.forEach((s,i)=>{let o=s.mirrorOffset!=null&&i-s.mirrorOffset>=e?r.maps.length-s.mirrorOffset:void 0;r.appendMap(s.map,o)},e,t),r}addMaps(e){return this.eventCount==0?this:new ht(this.items.append(e.map(t=>new bt(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let r=[],s=Math.max(0,this.items.length-t),i=e.mapping,o=e.steps.length,a=this.eventCount;this.items.forEach(f=>{f.selection&&a--},s);let l=t;this.items.forEach(f=>{let p=i.getMirror(--l);if(p==null)return;o=Math.min(o,p);let m=i.maps[p];if(f.step){let g=e.steps[p].invert(e.docs[p]),y=f.selection&&f.selection.map(i.slice(l+1,p));y&&a++,r.push(new bt(m,g,y))}else r.push(new bt(m))},s);let c=[];for(let f=t;f<o;f++)c.push(new bt(i.maps[f]));let d=this.items.slice(0,s).append(c).append(r),h=new ht(d,a);return h.emptyItemCount()>bE&&(h=h.compress(this.items.length-r.length)),h}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),r=t.maps.length,s=[],i=0;return this.items.forEach((o,a)=>{if(a>=e)s.push(o),o.selection&&i++;else if(o.step){let l=o.step.map(t.slice(r)),c=l&&l.getMap();if(r--,c&&t.appendMap(c,r),l){let d=o.selection&&o.selection.map(t.slice(r));d&&i++;let h=new bt(c.invert(),l,d),f,p=s.length-1;(f=s.length&&s[p].merge(h))?s[p]=f:s.push(h)}}else o.map&&r--},this.items.length,0),new ht(Ce.from(s.reverse()),i)}}ht.empty=new ht(Ce.empty,0);function vE(n,e){let t;return n.forEach((r,s)=>{if(r.selection&&e--==0)return t=s,!1}),n.slice(t)}class bt{constructor(e,t,r,s){this.map=e,this.step=t,this.selection=r,this.mirrorOffset=s}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new bt(t.getMap().invert(),t,this.selection)}}}class Qt{constructor(e,t,r,s,i){this.done=e,this.undone=t,this.prevRanges=r,this.prevTime=s,this.prevComposition=i}}const kE=20;function SE(n,e,t,r){let s=t.getMeta(Vn),i;if(s)return s.historyState;t.getMeta(TE)&&(n=new Qt(n.done,n.undone,null,0,-1));let o=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(o&&o.getMeta(Vn))return o.getMeta(Vn).redo?new Qt(n.done.addTransform(t,void 0,r,Ii(e)),n.undone,hh(t.mapping.maps),n.prevTime,n.prevComposition):new Qt(n.done,n.undone.addTransform(t,void 0,r,Ii(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(o&&o.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),l=n.prevTime==0||!o&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-r.newGroupDelay||!_E(t,n.prevRanges)),c=o?rl(n.prevRanges,t.mapping):hh(t.mapping.maps);return new Qt(n.done.addTransform(t,l?e.selection.getBookmark():void 0,r,Ii(e)),ht.empty,c,t.time,a??n.prevComposition)}else return(i=t.getMeta("rebased"))?new Qt(n.done.rebased(t,i),n.undone.rebased(t,i),rl(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new Qt(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),rl(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function _E(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((r,s)=>{for(let i=0;i<e.length;i+=2)r<=e[i+1]&&s>=e[i]&&(t=!0)}),t}function hh(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((r,s,i,o)=>e.push(i,o));return e}function rl(n,e){if(!n)return null;let t=[];for(let r=0;r<n.length;r+=2){let s=e.map(n[r],1),i=e.map(n[r+1],-1);s<=i&&t.push(s,i)}return t}function xE(n,e,t){let r=Ii(e),s=Vn.get(e).spec.config,i=(t?n.undone:n.done).popEvent(e,r);if(!i)return null;let o=i.selection.resolve(i.transform.doc),a=(t?n.done:n.undone).addTransform(i.transform,e.selection.getBookmark(),s,r),l=new Qt(t?a:i.remaining,t?i.remaining:a,null,0,-1);return i.transform.setSelection(o).setMeta(Vn,{redo:t,historyState:l})}let sl=!1,fh=null;function Ii(n){let e=n.plugins;if(fh!=e){sl=!1,fh=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){sl=!0;break}}return sl}const Vn=new Se("history"),TE=new Se("closeHistory");function EE(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new le({key:Vn,state:{init(){return new Qt(ht.empty,ht.empty,null,0,-1)},apply(e,t,r){return SE(t,r,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let r=t.inputType,s=r=="historyUndo"?jm:r=="historyRedo"?Bm:null;return!s||!e.editable?!1:(t.preventDefault(),s(e.state,e.dispatch))}}}})}function Lm(n,e){return(t,r)=>{let s=Vn.getState(t);if(!s||(n?s.undone:s.done).eventCount==0)return!1;if(r){let i=xE(s,t,n);i&&r(e?i.scrollIntoView():i)}return!0}}const jm=Lm(!1,!0),Bm=Lm(!0,!0);Q.create({name:"characterCount",addOptions(){return{limit:null,mode:"textSize",textCounter:n=>n.length,wordCounter:n=>n.split(" ").filter(e=>e!=="").length}},addStorage(){return{characters:()=>0,words:()=>0}},onBeforeCreate(){this.storage.characters=n=>{const e=n?.node||this.editor.state.doc;if((n?.mode||this.options.mode)==="textSize"){const r=e.textBetween(0,e.content.size,void 0," ");return this.options.textCounter(r)}return e.nodeSize},this.storage.words=n=>{const e=n?.node||this.editor.state.doc,t=e.textBetween(0,e.content.size," "," ");return this.options.wordCounter(t)}},addProseMirrorPlugins(){let n=!1;return[new le({key:new Se("characterCount"),appendTransaction:(e,t,r)=>{if(n)return;const s=this.options.limit;if(s==null||s===0){n=!0;return}const i=this.storage.characters({node:r.doc});if(i>s){const o=i-s,a=0,l=o;console.warn(`[CharacterCount] Initial content exceeded limit of ${s} characters. Content was automatically trimmed.`);const c=r.tr.deleteRange(a,l);return n=!0,c}n=!0},filterTransaction:(e,t)=>{const r=this.options.limit;if(!e.docChanged||r===0||r===null||r===void 0)return!0;const s=this.storage.characters({node:t.doc}),i=this.storage.characters({node:e.doc});if(i<=r||s>r&&i>r&&i<=s)return!0;if(s>r&&i>r&&i>s||!e.getMeta("paste"))return!1;const a=e.selection.$head.pos,l=i-r,c=a-l,d=a;return e.deleteRange(c,d),!(this.storage.characters({node:e.doc})>r)}})]}});var CE=Q.create({name:"dropCursor",addOptions(){return{color:"currentColor",width:1,class:void 0}},addProseMirrorPlugins(){return[cE(this.options)]}});Q.create({name:"focus",addOptions(){return{className:"has-focus",mode:"all"}},addProseMirrorPlugins(){return[new le({key:new Se("focus"),props:{decorations:({doc:n,selection:e})=>{const{isEditable:t,isFocused:r}=this.editor,{anchor:s}=e,i=[];if(!t||!r)return ae.create(n,[]);let o=0;this.options.mode==="deepest"&&n.descendants((l,c)=>{if(l.isText)return;if(!(s>=c&&s<=c+l.nodeSize-1))return!1;o+=1});let a=0;return n.descendants((l,c)=>{if(l.isText||!(s>=c&&s<=c+l.nodeSize-1))return!1;if(a+=1,this.options.mode==="deepest"&&o-a>0||this.options.mode==="shallowest"&&a>1)return this.options.mode==="deepest";i.push(Pe.node(c,c+l.nodeSize,{class:this.options.className}))}),ae.create(n,i)}}})]}});var AE=Q.create({name:"gapCursor",addProseMirrorPlugins(){return[fE()]},extendNodeSchema(n){var e;const t={name:n.name,options:n.options,storage:n.storage};return{allowGapCursor:(e=Z(R(n,"allowGapCursor",t)))!=null?e:null}}});Q.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something ",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new le({key:new Se("placeholder"),props:{decorations:({doc:n,selection:e})=>{const t=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:r}=e,s=[];if(!t)return null;const i=this.editor.isEmpty;return n.descendants((o,a)=>{const l=r>=a&&r<=a+o.nodeSize,c=!o.isLeaf&&ra(o);if((l||!this.options.showOnlyCurrent)&&c){const d=[this.options.emptyNodeClass];i&&d.push(this.options.emptyEditorClass);const h=Pe.node(a,a+o.nodeSize,{class:d.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:o,pos:a,hasAnchor:l}):this.options.placeholder});s.push(h)}return this.options.includeChildren}),ae.create(n,s)}}})]}});Q.create({name:"selection",addOptions(){return{className:"selection"}},addProseMirrorPlugins(){const{editor:n,options:e}=this;return[new le({key:new Se("selection"),props:{decorations(t){return t.selection.empty||n.isFocused||!n.isEditable||Qp(t.selection)||n.view.dragging?null:ae.create(t.doc,[Pe.inline(t.selection.from,t.selection.to,{class:e.className})])}}})]}});function ph({types:n,node:e}){return e&&Array.isArray(n)&&n.includes(e.type)||e?.type===n}var ME=Q.create({name:"trailingNode",addOptions(){return{node:void 0,notAfter:[]}},addProseMirrorPlugins(){var n;const e=new Se(this.name),t=this.options.node||((n=this.editor.schema.topNodeType.contentMatch.defaultType)==null?void 0:n.name)||"paragraph",r=Object.entries(this.editor.schema.nodes).map(([,s])=>s).filter(s=>(this.options.notAfter||[]).concat(t).includes(s.name));return[new le({key:e,appendTransaction:(s,i,o)=>{const{doc:a,tr:l,schema:c}=o,d=e.getState(o),h=a.content.size,f=c.nodes[t];if(d)return l.insert(h,f.create())},state:{init:(s,i)=>{const o=i.tr.doc.lastChild;return!ph({node:o,types:r})},apply:(s,i)=>{if(!s.docChanged||s.getMeta("__uniqueIDTransaction"))return i;const o=s.doc.lastChild;return!ph({node:o,types:r})}}})]}}),IE=Q.create({name:"undoRedo",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:n,dispatch:e})=>jm(n,e),redo:()=>({state:n,dispatch:e})=>Bm(n,e)}},addProseMirrorPlugins(){return[EE(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-":()=>this.editor.commands.undo(),"Shift-Mod-":()=>this.editor.commands.redo()}}}),OE=Q.create({name:"starterKit",addExtensions(){var n,e,t,r;const s=[];return this.options.bold!==!1&&s.push(sT.configure(this.options.bold)),this.options.blockquote!==!1&&s.push(Zx.configure(this.options.blockquote)),this.options.bulletList!==!1&&s.push(Tm.configure(this.options.bulletList)),this.options.code!==!1&&s.push(aT.configure(this.options.code)),this.options.codeBlock!==!1&&s.push(dT.configure(this.options.codeBlock)),this.options.document!==!1&&s.push(uT.configure(this.options.document)),this.options.dropcursor!==!1&&s.push(CE.configure(this.options.dropcursor)),this.options.gapcursor!==!1&&s.push(AE.configure(this.options.gapcursor)),this.options.hardBreak!==!1&&s.push(hT.configure(this.options.hardBreak)),this.options.heading!==!1&&s.push(fT.configure(this.options.heading)),this.options.undoRedo!==!1&&s.push(IE.configure(this.options.undoRedo)),this.options.horizontalRule!==!1&&s.push(pT.configure(this.options.horizontalRule)),this.options.italic!==!1&&s.push(bT.configure(this.options.italic)),this.options.listItem!==!1&&s.push(Em.configure(this.options.listItem)),this.options.listKeymap!==!1&&s.push(Nm.configure((n=this.options)==null?void 0:n.listKeymap)),this.options.link!==!1&&s.push(VT.configure((e=this.options)==null?void 0:e.link)),this.options.orderedList!==!1&&s.push(Rm.configure(this.options.orderedList)),this.options.paragraph!==!1&&s.push(rE.configure(this.options.paragraph)),this.options.strike!==!1&&s.push(oE.configure(this.options.strike)),this.options.text!==!1&&s.push(aE.configure(this.options.text)),this.options.underline!==!1&&s.push(lE.configure((t=this.options)==null?void 0:t.underline)),this.options.trailingNode!==!1&&s.push(ME.configure((r=this.options)==null?void 0:r.trailingNode)),s}}),NE=OE,$E=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))$/,RE=/(?:^|\s)(==(?!\s+==)((?:[^=]+))==(?!\s+==))/g,PE=Wt.create({name:"highlight",addOptions(){return{multicolor:!1,HTMLAttributes:{}}},addAttributes(){return this.options.multicolor?{color:{default:null,parseHTML:n=>n.getAttribute("data-color")||n.style.backgroundColor,renderHTML:n=>n.color?{"data-color":n.color,style:`background-color: ${n.color}; color: inherit`}:{}}}:{}},parseHTML(){return[{tag:"mark"}]},renderHTML({HTMLAttributes:n}){return["mark",me(this.options.HTMLAttributes,n),0]},renderMarkdown:(n,e)=>`==${e.renderChildren(n)}==`,parseMarkdown:(n,e)=>e.applyMark("highlight",e.parseInline(n.tokens||[])),markdownTokenizer:{name:"highlight",level:"inline",start:n=>n.indexOf("=="),tokenize(n,e,t){const s=/^(==)([^=]+)(==)/.exec(n);if(s){const i=s[2].trim(),o=t.inlineTokens(i);return{type:"highlight",raw:s[0],text:i,tokens:o}}}},addCommands(){return{setHighlight:n=>({commands:e})=>e.setMark(this.name,n),toggleHighlight:n=>({commands:e})=>e.toggleMark(this.name,n),unsetHighlight:()=>({commands:n})=>n.unsetMark(this.name)}},addKeyboardShortcuts(){return{"Mod-Shift-h":()=>this.editor.commands.toggleHighlight()}},addInputRules(){return[Yn({find:$E,type:this.type})]},addPasteRules(){return[gn({find:RE,type:this.type})]}}),DE=Q.create({name:"textAlign",addOptions(){return{types:[],alignments:["left","center","right","justify"],defaultAlignment:null}},addGlobalAttributes(){return[{types:this.options.types,attributes:{textAlign:{default:this.options.defaultAlignment,parseHTML:n=>{const e=n.style.textAlign;return this.options.alignments.includes(e)?e:this.options.defaultAlignment},renderHTML:n=>n.textAlign?{style:`text-align: ${n.textAlign}`}:{}}}}]},addCommands(){return{setTextAlign:n=>({commands:e})=>this.options.alignments.includes(n)?this.options.types.map(t=>e.updateAttributes(t,{textAlign:n})).some(t=>t):!1,unsetTextAlign:()=>({commands:n})=>this.options.types.map(e=>n.resetAttributes(e,"textAlign")).some(e=>e),toggleTextAlign:n=>({editor:e,commands:t})=>this.options.alignments.includes(n)?e.isActive({textAlign:n})?t.unsetTextAlign():t.setTextAlign(n):!1}},addKeyboardShortcuts(){return{"Mod-Shift-l":()=>this.editor.commands.setTextAlign("left"),"Mod-Shift-e":()=>this.editor.commands.setTextAlign("center"),"Mod-Shift-r":()=>this.editor.commands.setTextAlign("right"),"Mod-Shift-j":()=>this.editor.commands.setTextAlign("justify")}}}),LE=20,Fm=(n,e=0)=>{const t=[];return!n.children.length||e>LE||Array.from(n.children).forEach(r=>{r.tagName==="SPAN"?t.push(r):r.children.length&&t.push(...Fm(r,e+1))}),t},jE=n=>{if(!n.children.length)return;const e=Fm(n);e&&e.forEach(t=>{var r,s;const i=t.getAttribute("style"),o=(s=(r=t.parentElement)==null?void 0:r.closest("span"))==null?void 0:s.getAttribute("style");t.setAttribute("style",`${o};${i}`)})},Um=Wt.create({name:"textStyle",priority:101,addOptions(){return{HTMLAttributes:{},mergeNestedSpanStyles:!0}},parseHTML(){return[{tag:"span",consuming:!1,getAttrs:n=>n.hasAttribute("style")?(this.options.mergeNestedSpanStyles&&jE(n),{}):!1}]},renderHTML({HTMLAttributes:n}){return["span",me(this.options.HTMLAttributes,n),0]},addCommands(){return{toggleTextStyle:n=>({commands:e})=>e.toggleMark(this.name,n),removeEmptyTextStyle:()=>({tr:n})=>{const{selection:e}=n;return n.doc.nodesBetween(e.from,e.to,(t,r)=>{if(t.isTextblock)return!0;t.marks.filter(s=>s.type===this.type).some(s=>Object.values(s.attrs).some(i=>!!i))||n.removeMark(r,r+t.nodeSize,this.type)}),!0}}}}),BE=Q.create({name:"backgroundColor",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{backgroundColor:{default:null,parseHTML:n=>{var e;const t=n.getAttribute("style");if(t){const r=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s=r.length-1;s>=0;s-=1){const i=r[s].split(":");if(i.length>=2){const o=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(o==="background-color")return a.replace(/['"]+/g,"")}}}return(e=n.style.backgroundColor)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:n=>n.backgroundColor?{style:`background-color: ${n.backgroundColor}`}:{}}}}]},addCommands(){return{setBackgroundColor:n=>({chain:e})=>e().setMark("textStyle",{backgroundColor:n}).run(),unsetBackgroundColor:()=>({chain:n})=>n().setMark("textStyle",{backgroundColor:null}).removeEmptyTextStyle().run()}}}),FE=Q.create({name:"color",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{color:{default:null,parseHTML:n=>{var e;const t=n.getAttribute("style");if(t){const r=t.split(";").map(s=>s.trim()).filter(Boolean);for(let s=r.length-1;s>=0;s-=1){const i=r[s].split(":");if(i.length>=2){const o=i[0].trim().toLowerCase(),a=i.slice(1).join(":").trim();if(o==="color")return a.replace(/['"]+/g,"")}}}return(e=n.style.color)==null?void 0:e.replace(/['"]+/g,"")},renderHTML:n=>n.color?{style:`color: ${n.color}`}:{}}}}]},addCommands(){return{setColor:n=>({chain:e})=>e().setMark("textStyle",{color:n}).run(),unsetColor:()=>({chain:n})=>n().setMark("textStyle",{color:null}).removeEmptyTextStyle().run()}}}),UE=Q.create({name:"fontFamily",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontFamily:{default:null,parseHTML:n=>n.style.fontFamily,renderHTML:n=>n.fontFamily?{style:`font-family: ${n.fontFamily}`}:{}}}}]},addCommands(){return{setFontFamily:n=>({chain:e})=>e().setMark("textStyle",{fontFamily:n}).run(),unsetFontFamily:()=>({chain:n})=>n().setMark("textStyle",{fontFamily:null}).removeEmptyTextStyle().run()}}}),zE=Q.create({name:"fontSize",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{fontSize:{default:null,parseHTML:n=>n.style.fontSize,renderHTML:n=>n.fontSize?{style:`font-size: ${n.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:n=>({chain:e})=>e().setMark("textStyle",{fontSize:n}).run(),unsetFontSize:()=>({chain:n})=>n().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),HE=Q.create({name:"lineHeight",addOptions(){return{types:["textStyle"]}},addGlobalAttributes(){return[{types:this.options.types,attributes:{lineHeight:{default:null,parseHTML:n=>n.style.lineHeight,renderHTML:n=>n.lineHeight?{style:`line-height: ${n.lineHeight}`}:{}}}}]},addCommands(){return{setLineHeight:n=>({chain:e})=>e().setMark("textStyle",{lineHeight:n}).run(),unsetLineHeight:()=>({chain:n})=>n().setMark("textStyle",{lineHeight:null}).removeEmptyTextStyle().run()}}});Q.create({name:"textStyleKit",addExtensions(){const n=[];return this.options.backgroundColor!==!1&&n.push(BE.configure(this.options.backgroundColor)),this.options.color!==!1&&n.push(FE.configure(this.options.color)),this.options.fontFamily!==!1&&n.push(UE.configure(this.options.fontFamily)),this.options.fontSize!==!1&&n.push(zE.configure(this.options.fontSize)),this.options.lineHeight!==!1&&n.push(HE.configure(this.options.lineHeight)),this.options.textStyle!==!1&&n.push(Um.configure(this.options.textStyle)),n}});let X=null,kt=null,fs=null,br=null,ps=null,_r=null;const VE=Q.create({name:"fontSize",addGlobalAttributes(){return[{types:["textStyle"],attributes:{fontSize:{default:null,parseHTML:n=>n.style.fontSize||null,renderHTML:n=>n.fontSize?{style:`font-size: ${n.fontSize}`}:{}}}}]},addCommands(){return{setFontSize:n=>({chain:e})=>e().setMark("textStyle",{fontSize:n}).run(),unsetFontSize:()=>({chain:n})=>n().setMark("textStyle",{fontSize:null}).removeEmptyTextStyle().run()}}}),qE=Q.create({name:"tabIndent",addKeyboardShortcuts(){return{Tab:()=>this.editor.isActive("listItem")?!1:this.editor.commands.insertContent("	"),"Shift-Tab":()=>{if(this.editor.isActive("listItem"))return!1;const{state:n}=this.editor,{from:e,empty:t}=n.selection;return!t||e<=1?this.editor.commands.command(()=>!0):n.doc.textBetween(e-1,e,"\0","\0")!=="	"?this.editor.commands.command(()=>!0):this.editor.commands.command(({tr:s})=>(s.delete(e-1,e),!0))}}}}),WE=Q.create({name:"dialogueDash",addGlobalAttributes(){return[{types:["paragraph"],attributes:{dialogueIndent:{default:!1,parseHTML:n=>n.getAttribute("data-dialogue-indent")==="true",renderHTML:n=>n.dialogueIndent?{"data-dialogue-indent":"true",class:"dialogue-indent"}:{}}}}]},addInputRules(){return[new Vs({find:/^(\s*)--$/,handler:({state:n,range:e,match:t})=>{const{$from:r}=n.selection;if(!r.parent||r.parent.type.name!=="paragraph")return null;for(let c=0;c<=r.depth;c+=1){const d=r.node(c).type.name;if(d==="heading"||d==="codeBlock"||d==="listItem")return null}const i=`${t[1]??""} `;let o=n.tr.insertText(i,e.from,e.to);const a=r.before();o=o.setNodeMarkup(a,void 0,{...r.parent.attrs,dialogueIndent:!0});const l=e.from+i.length;return o=o.setSelection(z.create(o.doc,l)),o}})]}});function mh(n){const e=[],t=/\[\[([^\]]+)\]\]/g;return n.descendants((r,s,i)=>{if(!r.isText||!r.text||i?.type?.name==="codeBlock"||r.marks?.some(a=>a.type.name==="code"))return;t.lastIndex=0;let o;for(;(o=t.exec(r.text))!==null;){const a=o[1]??"",l=a.indexOf("|"),d=(l===-1?a:a.slice(0,l)).trim();if(!d)continue;const h=s+o.index,f=h+o[0].length;e.push(Pe.inline(h,f,{class:"editor-wiki-link","data-wiki-title":encodeURIComponent(d)}))}}),e.length?ae.create(n,e):ae.empty}const KE=Q.create({name:"wikiLink",addOptions(){return{onOpen:null}},addProseMirrorPlugins(){const n=this.options.onOpen,e=new le({state:{init:(t,{doc:r})=>mh(r),apply:(t,r)=>t.docChanged?mh(t.doc):r},props:{decorations(t){return e.getState(t)},handleClick(t,r,s){if(s.button!==0)return!1;const o=(s.target instanceof HTMLElement?s.target:null)?.closest(".editor-wiki-link");if(!o)return!1;const a=o.dataset.wikiTitle||"",l=a?decodeURIComponent(a):"";return l?(typeof n=="function"&&n(l),s.preventDefault(),!0):!1}}});return[e]}});function zm(n){const e=n.trim();if(!e)return 0;const t=e.match(/\S+/g);return t?t.length:0}function gh(){if(!X)return;const n=document.querySelector("#editor-word-count");if(!n)return;const e=zm(X.state.doc.textContent??"");n.textContent=`${e} mot${e===1?"":"s"}`}function GE(){return X?zm(X.state.doc.textContent??""):null}function JE(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function YE(n){return n?n.split(`
`).map(e=>`<p>${JE(e)}</p>`).join(""):"<p></p>"}function XE(n){return/<\/?[a-z][\s\S]*>/i.test(n)}function QE(n){if(!n.includes('data-type="page"'))return n;const e=document.createElement("div");e.innerHTML=n;const t=Array.from(e.querySelectorAll('div[data-type="page"]'));for(const r of t){const s=r.parentNode;if(s){for(;r.firstChild;)s.insertBefore(r.firstChild,r);s.removeChild(r)}}return e.innerHTML}function ZE(n){if(!n)return"<p></p>";const e=XE(n)?n:YE(n);return QE(e)}function Ln(){if(!X||!kt)return;const n=kt.querySelectorAll("[data-command]"),e=kt.querySelector('[data-command="font-size"]');for(const t of n){const r=t.dataset.command;let s=!1;if(r==="bold")s=X.isActive("bold");else if(r==="italic")s=X.isActive("italic");else if(r==="heading-1")s=X.isActive("heading",{level:1});else if(r==="heading-2")s=X.isActive("heading",{level:2});else if(r==="align-left")s=X.isActive({textAlign:"left"});else if(r==="align-center")s=X.isActive({textAlign:"center"});else if(r==="align-right")s=X.isActive({textAlign:"right"});else if(r==="align-justify")s=X.isActive({textAlign:"justify"});else if(r==="bullet-list")s=X.isActive("bulletList");else if(r==="ordered-list")s=X.isActive("orderedList");else if(r==="highlight")s=X.isActive("highlight");else if(r&&r.startsWith("font-")){const i=`${r.replace("font-","")}px`;s=X.isActive("textStyle",{fontSize:i})}if(r==="align-left"&&!s){const i=X.getAttributes("paragraph").textAlign,o=X.getAttributes("heading").textAlign;!i&&!o&&(s=!0)}t.classList.toggle("is-active",s),r==="undo"&&(t.disabled=!X.can().undo()),r==="redo"&&(t.disabled=!X.can().redo())}if(e){if(document.activeElement===e)return;const t=X.getAttributes("textStyle").fontSize||"";e.value=t?t.replace("px",""):"16"}}function eC(n){if(n.target instanceof HTMLSelectElement||n.target instanceof HTMLOptionElement)return;const e=n.target.closest("[data-command]");if(!e||!X||e instanceof HTMLSelectElement)return;const t=e.dataset.command,r=X.chain().focus();if(t==="bold")r.toggleBold().run();else if(t==="italic")r.toggleItalic().run();else if(t==="heading-1")r.toggleHeading({level:1}).run();else if(t==="heading-2")r.toggleHeading({level:2}).run();else if(t==="align-left")r.setTextAlign("left").run();else if(t==="align-center")r.setTextAlign("center").run();else if(t==="align-right")r.setTextAlign("right").run();else if(t==="align-justify")r.setTextAlign("justify").run();else if(t==="bullet-list")r.toggleBulletList().run();else if(t==="ordered-list")r.toggleOrderedList().run();else if(t==="highlight")X.isActive("highlight")?r.unsetHighlight().run():r.toggleHighlight({color:"var(--token-highlight)"}).run();else if(t&&t.startsWith("font-")){const s=`${t.replace("font-","")}px`;r.setFontSize(s).run()}else t==="undo"?r.undo().run():t==="redo"&&r.redo().run();Ln()}function Hm(n){const e=n.target;if(!X||!(e instanceof HTMLSelectElement)||e.dataset.command!=="font-size")return;const t=e.value,r=X.chain().focus();if(!t){r.unsetFontSize().run(),Ln();return}const s=`${t}px`;r.setFontSize(s).run(),Ln()}function tC(){if(!br)return;const n=br.clientWidth;if(!n)return;const e=Math.min(980,Math.max(640,n)),t=Math.round(Math.min(56,Math.max(32,e*.06)));br.style.setProperty("--page-width",`${e}px`),br.style.setProperty("--page-padding",`${t}px`)}function yh(){_r||(_r=window.requestAnimationFrame(()=>{_r=null,tC()}))}function nC({content:n="",onUpdate:e,onWikiLinkClick:t}={}){const r=document.querySelector("#chapter-editor"),s=document.querySelector("#editor-toolbar"),i=document.querySelector(".paper-shell");if(!r||!s||!i){sd();return}X&&(X.destroy(),X=null),kt=s,fs=eC,kt.addEventListener("click",fs),kt.addEventListener("change",Hm),br=i,ps=yh,window.addEventListener("resize",ps),yh();const o=[NE.configure({gapcursor:!1}),DE.configure({types:["paragraph","heading"]}),PE,Um,VE,qE,WE];typeof t=="function"&&o.push(KE.configure({onOpen:t})),X=new zx({element:r,extensions:o,content:ZE(n),onUpdate({editor:a}){e&&e(a.getHTML()),Ln(),gh()},onSelectionUpdate:Ln,onTransaction:Ln}),Ln(),gh()}function sd(){kt&&fs&&(kt.removeEventListener("click",fs),kt.removeEventListener("change",Hm)),kt=null,fs=null,br=null,ps&&(window.removeEventListener("resize",ps),ps=null),_r&&(window.cancelAnimationFrame(_r),_r=null),X&&(X.destroy(),X=null)}const Vm="Bucketplumeo",rC="latest.json";function qm(n){return`${n}/${rC}`}async function Wm(){const n=await Et();if(!n.ok)return n;try{const e=await F("projects"),t=await F("chapters"),r=await F("characters"),s=await F("inspiration"),i=await F("ideas"),o=await F("mindmap_nodes"),a=await F("mindmap_edges"),l=await F("writing_sessions"),c=await F("knowledge_notes"),d=await F("knowledge_links"),h=await F("focus_sessions"),f={schema:1,saved_at:new Date().toISOString(),projects:e,chapters:t,characters:r,inspiration:s,ideas:i,mindmapNodes:o,mindmapEdges:a,writingSessions:l,knowledgeNotes:c,knowledgeLinks:d,focusSessions:h},p=new Blob([JSON.stringify(f)],{type:"application/json"}),m=qm(n.userId),{error:g}=await ye.storage.from(Vm).upload(m,p,{upsert:!0,contentType:"application/json"});return g?{ok:!1,errorMessage:g.message}:{ok:!0,savedAt:f.saved_at}}catch(e){return{ok:!1,errorMessage:e.message}}}async function Km({applyIfNewer:n=!1}={}){const e=await Et();if(!e.ok)return e;try{const t=qm(e.userId),{data:r,error:s}=await ye.storage.from(Vm).download(t);if(s)return{ok:!1,errorMessage:s.message};const i=await r.text(),o=JSON.parse(i),a=o?.saved_at,l=a?Date.parse(a):null,c=Ho();if(n&&l&&Number.isFinite(l)&&c&&Number.isFinite(c)&&l<=c)return{ok:!0,savedAt:l,skipped:!0};const d=Array.isArray(o?.projects)?o.projects:[],h=Array.isArray(o?.chapters)?o.chapters:[],f=Array.isArray(o?.characters)?o.characters:[],p=Array.isArray(o?.inspiration)?o.inspiration:[],m=Array.isArray(o?.ideas)?o.ideas:[],g=Array.isArray(o?.mindmapNodes)?o.mindmapNodes:[],y=Array.isArray(o?.mindmapEdges)?o.mindmapEdges:[],w=Array.isArray(o?.writingSessions)?o.writingSessions:Array.isArray(o?.writing_sessions)?o.writing_sessions:[],v=Array.isArray(o?.knowledgeNotes)?o.knowledgeNotes:[],b=Array.isArray(o?.knowledgeLinks)?o.knowledgeLinks:[],S=Array.isArray(o?.focusSessions)?o.focusSessions:[];return await Lr(d),await Fs(h,{force:!0}),await Promise.all([...f.map(k=>V("characters",k)),...p.map(k=>V("inspiration",k)),...m.map(k=>V("ideas",k)),...g.map(k=>V("mindmap_nodes",k)),...y.map(k=>V("mindmap_edges",k)),...w.map(k=>V("writing_sessions",k)),...v.map(k=>V("knowledge_notes",k)),...b.map(k=>V("knowledge_links",k)),...S.map(k=>V("focus_sessions",k))]),l&&Number.isFinite(l)&&wc(l),{ok:!0,savedAt:l}}catch(t){return{ok:!1,errorMessage:t.message}}}const ie=document.querySelector("#app"),id=.8,u={projects:[],projectsStats:{},projectsMenuOpenId:null,selectedProjectId:null,chapters:[],selectedChapterId:null,chapterDetail:null,versions:[],statusText:"",homeMessage:"",editingProjectId:null,lastChapterTitle:null,lastCloudSaveAt:null,cloudStatus:"",cloudBusy:!1,backupStatus:"",homeStats:null,editorTab:"session",ideas:[],ideasQuery:"",ideasTagFilter:"",ideasStatusFilter:"all",ideasSort:"desc",ideasFiltersOpen:!1,ideasProjectId:null,ideasNoteExpanded:!1,selectedIdeaId:null,knowledgeNotes:[],knowledgeLinks:[],knowledgeSearch:"",knowledgeSort:"recent",knowledgeActiveId:null,knowledgeProjectId:null,knowledgeTab:"notes",knowledgePreviewOpen:!1,knowledgeRenameBusy:!1,knowledgeTitleDrafts:{},knowledgeTitleOriginals:{},knowledgeTitleError:"",knowledgeDuplicates:[],wikiGraphNodes:[],wikiGraphEdges:[],wikiGraphSelectedNodeId:null,wikiGraphSearch:"",wikiGraphMinDegree:0,wikiGraphShowOrphans:!1,wikiGraphPanelCollapsed:!1,wikiGraphSettingsOpen:!1,wikiGraphNeedsBuild:!0,wikiGraphLayoutReady:!1,wikiGraphGuardMessage:"",wikiGraphView:{offsetX:0,offsetY:0,scale:id},focusSession:null,focusElapsedMs:0,knowledgeAutocomplete:{open:!1,query:"",matches:[],range:null,createTitle:""},writingNav:"chapter",characters:[],selectedCharacterId:null,characterFilter:"",inspirationItems:[],inspirationSearch:"",inspirationTag:"",inspirationModal:{open:!1,step:"type",type:null,draft:null},inspirationDetailId:null,mindmapNodes:[],mindmapEdges:[],mindmapSelectedNodeId:null,mindmapMode:"select",mindmapLinkSourceId:null,mindmapSearch:"",mindmapCreateType:"note",mindmapLinkTypeMenu:null,mindmapFlashNodeId:null,mindmapDeleteConfirmId:null,mindmapContextMenu:null,mindmapNeedsCenter:!0,projectStatsCache:{},projectStatsView:null,mindmapView:{offsetX:0,offsetY:0,scale:1},characterSections:{civil:!0,physique:!1,caractere:!1,profil:!1,storyRole:!1,evolution:!1,inventaire:!1,possession:!1,autres:!1},accountMenuOpen:!1,backupMenuOpen:!1},sC=300*1e3,iC=300*1e3,oC=120*1e3,aC=400;let Oi=null,_i=null,xr=null,rn=null,wh=!1,tt="",nc=!1,Br=!1,St=null,jn=null;const il=new Map,Tr=new Map,Io=new Map,Bt=new Map,Ps=new Map,xi=new Map,ol=new Set,Xn=180,Qn=64,lC=600,cC=400;let Fe=null,vt=null,al=null,Er=null,ll=null,cl=null,ln=null,ms=null,bh=!1;const Oo=new Map;function od(){Oi&&(clearTimeout(Oi),Oi=null)}function Ti(n){_i&&(clearInterval(_i),_i=null),n&&(_i=window.setInterval(async()=>{if(u.cloudBusy||!tt)return;const e=await Wm();if(e.ok){const t=Date.now();wc(t),u.lastCloudSaveAt=t}else console.error("cloud autosave error",e.errorMessage)},iC))}async function dl(){if(nc||!tt)return;nc=!0;const n=window.location.hostname,e=n&&n!=="localhost"&&n!=="127.0.0.1";e&&(u.cloudStatus="Chargement cloud...");const t=await Km({applyIfNewer:!e});if(!t.ok){u.cloudStatus=`Erreur cloud: ${t.errorMessage}`,console.error("cloud bootstrap error",t.errorMessage);return}t.skipped||(Br=!0),t.savedAt&&Number.isFinite(t.savedAt)&&(u.lastCloudSaveAt=t.savedAt),e&&(u.cloudStatus=t.skipped?"Cloud deja a jour.":"Cloud charge.")}function ul(n){const e=document.querySelector("#message");e&&(e.textContent=n)}function te(n){u.statusText=n;const e=document.querySelector("#status-text");e&&(e.textContent=n)}function Rr(n){u.homeMessage=n;const e=document.querySelector("#home-message");e&&(e.textContent=n)}function M(){sd(),new Set(["chapter","characters","ideas","inspiration","mindmap","stats","knowledge"]).has(u.writingNav)||(u.writingNav="chapter"),["notes","graph"].includes(u.knowledgeTab)||(u.knowledgeTab="notes"),u.writingNav!=="inspiration"&&(u.inspirationDetailId=null,u.inspirationModal={open:!1,step:"type",type:null,mode:"create",draft:null}),u.writingNav!=="mindmap"&&(u.mindmapMode="select",u.mindmapLinkSourceId=null,u.mindmapLinkTypeMenu=null,u.mindmapDeleteConfirmId=null,u.mindmapContextMenu=null),u.writingNav!=="knowledge"&&(u.knowledgePreviewOpen=!1,u.knowledgeAutocomplete={open:!1,query:"",matches:[],range:null,createTitle:""}),u.writingNav==="characters"&&!u.selectedCharacterId&&u.characters.length&&(u.selectedCharacterId=u.characters[0].id),Ni()&&ag();const e=Ni()?YC():{nodes:[],edges:[],blockedMessage:"",selectedNodeId:null,view:u.wikiGraphView,search:u.wikiGraphSearch,minDegree:u.wikiGraphMinDegree,showOrphans:u.wikiGraphShowOrphans},t=Ni()?JC():{outgoing:[],backlinks:[]},r=!!u.focusSession,s=r?" Quitter le focus":" Dmarrer le focus",i=r?` Focus en cours  ${Xm(Date.now()-u.focusSession.start_at)}`:"";if(ie.innerHTML=iv({userEmail:tt,projects:u.projects,selectedProjectId:u.selectedProjectId,editingProjectId:u.editingProjectId,chapters:u.chapters,selectedChapterId:u.selectedChapterId,chapterDetail:u.chapterDetail,versions:u.versions,statusText:u.statusText,editorTab:u.editorTab,writingNav:u.writingNav,characters:u.characters,selectedCharacterId:u.selectedCharacterId,characterFilter:u.characterFilter,inspirationItems:u.inspirationItems,inspirationSearch:u.inspirationSearch,inspirationTag:u.inspirationTag,inspirationModal:u.inspirationModal,inspirationDetailId:u.inspirationDetailId,ideas:FC(),selectedIdeaId:u.selectedIdeaId,ideasQuery:u.ideasQuery,ideasTagFilter:u.ideasTagFilter,ideasStatusFilter:u.ideasStatusFilter,ideasSort:u.ideasSort,ideasFiltersOpen:u.ideasFiltersOpen,ideasNoteExpanded:u.ideasNoteExpanded,knowledgeNotes:UC(),knowledgeActiveNote:ca(),knowledgeBacklinks:zC(),knowledgeHasNotes:u.knowledgeNotes.length>0,knowledgeSearch:u.knowledgeSearch,knowledgeSort:u.knowledgeSort,knowledgeTab:u.knowledgeTab,knowledgePreviewOpen:u.knowledgePreviewOpen,knowledgeAutocomplete:u.knowledgeAutocomplete,knowledgeTitleDrafts:u.knowledgeTitleDrafts,knowledgeTitleError:u.knowledgeTitleError,knowledgeDuplicates:u.knowledgeDuplicates,knowledgeRenameBusy:u.knowledgeRenameBusy,wikiGraph:e,wikiGraphDetails:t,mindmapNodes:u.mindmapNodes,mindmapEdges:u.mindmapEdges,mindmapSelectedNodeId:u.mindmapSelectedNodeId,mindmapMode:u.mindmapMode,mindmapLinkSourceId:u.mindmapLinkSourceId,mindmapSearch:u.mindmapSearch,mindmapCreateType:u.mindmapCreateType,mindmapLinkTypeMenu:u.mindmapLinkTypeMenu,mindmapFlashNodeId:u.mindmapFlashNodeId,mindmapDeleteConfirmId:u.mindmapDeleteConfirmId,mindmapContextMenu:u.mindmapContextMenu,mindmapView:u.mindmapView,projectStatsView:u.projectStatsView,characterSections:u.characterSections,lastCloudSaveAt:u.lastCloudSaveAt,cloudStatus:u.cloudStatus,cloudBusy:u.cloudBusy,accountMenuOpen:u.accountMenuOpen,backupStatus:u.backupStatus,backupMenuOpen:u.backupMenuOpen,focusActive:r,focusButtonLabel:s,focusIndicatorLabel:i}),hC(),u.writingNav==="knowledge"&&u.knowledgeTab==="notes"&&ud(),u.writingNav==="mindmap"&&u.mindmapNeedsCenter){u.mindmapNeedsCenter=!1,mg();return}u.chapterDetail&&(nC({content:u.chapterDetail.content_md??"",onUpdate:_g}),aa())}function dC(){ie.innerHTML=Xb({userEmail:tt,projects:u.projects,lastProjectId:Vt(),lastChapterTitle:u.lastChapterTitle,lastCloudSaveAt:u.lastCloudSaveAt,cloudStatus:u.cloudStatus,cloudBusy:u.cloudBusy,homeStats:u.homeStats,homeMessage:u.homeMessage,accountMenuOpen:u.accountMenuOpen,backupStatus:u.backupStatus,backupMenuOpen:u.backupMenuOpen})}function uC(){ie.innerHTML=Zb({userEmail:tt,projects:u.projects,projectStats:u.projectsStats,projectsMenuOpenId:u.projectsMenuOpenId,editingProjectId:u.editingProjectId,lastProjectId:Vt(),lastCloudSaveAt:u.lastCloudSaveAt,cloudStatus:u.cloudStatus,cloudBusy:u.cloudBusy,accountMenuOpen:u.accountMenuOpen,backupStatus:u.backupStatus,backupMenuOpen:u.backupMenuOpen})}function U(){if(window.location.hash.startsWith("#/project/")||window.location.hash.startsWith("#/editor")){M();return}if(window.location.hash.startsWith("#/home")){dC();return}if(window.location.hash.startsWith("#/projects")){uC();return}}function hC(){const n=document.querySelector("#project-export");if(!n)return;const t=!!u.projects.find(r=>r.id===u.selectedProjectId);n.disabled=!t,n.setAttribute("aria-disabled",t?"false":"true")}function vh(){const n=document.querySelector("#email"),e=document.querySelector("#password");return{email:n?n.value.trim():"",password:e?e.value:""}}async function He({allowFallback:n=!0}={}){const e=await vv();if(u.projects=e,u.projects.length===0){u.selectedProjectId=null;return}!u.projects.some(r=>r.id===u.selectedProjectId)&&n&&(u.selectedProjectId=u.projects[0].id)}async function No(){const n={};for(const e of u.projects){const t=await Fo(e.id);let r=0;const s=e.created_at?new Date(e.created_at).getTime():null;let i=Number.isNaN(s)?null:s;for(const o of t){const a=la(o.content_md??"");r+=oa(a);const l=o.updated_local_at??o.updated_at??o.created_at??null;if(l){const c=new Date(l).getTime();Number.isNaN(c)||(i=i?Math.max(i,c):c)}}n[e.id]={chapterCount:t.length,wordCount:r,updatedAt:i}}u.projectsStats=n}async function Pr(){if(!u.selectedProjectId){u.chapters=[],u.selectedChapterId=null,u.chapterDetail=null,u.versions=[];return}const n=await Fo(u.selectedProjectId);if(u.chapters=n,u.chapters.length===0){u.selectedChapterId=null,u.chapterDetail=null,u.versions=[];return}u.chapters.some(t=>t.id===u.selectedChapterId)||(u.selectedChapterId=u.chapters[0].id)}async function yn(){if(!u.selectedProjectId){u.characters=[],u.selectedCharacterId=null;return}u.characters=await Cv(u.selectedProjectId),u.characters.some(e=>e.id===u.selectedCharacterId)||(u.selectedCharacterId=u.characters[0]?.id??null)}async function $o(){if(!u.selectedProjectId){u.inspirationItems=[];return}u.inspirationItems=await Iv(u.selectedProjectId)}async function kh(){if(!u.selectedProjectId){u.mindmapNodes=[],u.mindmapEdges=[],u.mindmapSelectedNodeId=null,u.mindmapDeleteConfirmId=null;return}const n=await Rv(u.selectedProjectId);u.mindmapNodes=n.nodes,u.mindmapEdges=n.edges,u.mindmapNodes.some(t=>t.id===u.mindmapSelectedNodeId)||(u.mindmapSelectedNodeId=null)}async function Sh({projectId:n=null,render:e=!0}={}){if(!n){u.knowledgeNotes=[],u.knowledgeLinks=[],u.knowledgeActiveId=null,u.knowledgePreviewOpen=!1,u.wikiGraphNodes=[],u.wikiGraphEdges=[],u.wikiGraphSelectedNodeId=null,u.wikiGraphNeedsBuild=!0,u.wikiGraphLayoutReady=!1,u.knowledgeAutocomplete={open:!1,query:"",matches:[],range:null,createTitle:""};return}u.knowledgeProjectId=n,u.knowledgeNotes=await Cr(n),u.knowledgeLinks=await fn(n),Zn(),Dr(),u.knowledgeNotes.some(r=>r.id===u.knowledgeActiveId)||(u.knowledgeActiveId=u.knowledgeNotes[0]?.id??null),e&&M()}async function Ft(){if(!u.selectedChapterId){u.chapterDetail=null;return}u.chapterDetail=await Uo(u.selectedChapterId)}async function Ut(n){if(!n){u.versions=[];return}const e=await fv(n);if(!e.ok){u.versions=[];return}u.versions=e.data}async function ad(){const n=await ov();if(!n.ok){te(`Erreur: ${n.errorMessage}`);return}await Lr(n.data),await He()}async function fC(n){const e=await lv(n);if(!e.ok){te(`Erreur: ${e.errorMessage}`);return}await Fs(e.data),await Pr()}async function _h(){}async function Gm(){u.editingProjectId=null,u.lastCloudSaveAt=Ho(),await He(),await _h(),await wn(),await Do(),U(),Br||(await ad(),await He(),await _h(),await wn(),await Do(),U())}async function Jm(){u.lastCloudSaveAt=Ho(),await He({allowFallback:!1}),await No(),U(),Br||(await ad(),await He({allowFallback:!1}),await No(),U())}async function pC({projectId:n=null,render:e=!0}={}){u.lastCloudSaveAt=Ho(),u.ideasProjectId=n,u.ideas=await zo({projectId:n}),u.selectedIdeaId&&(u.ideas.some(r=>r.id===u.selectedIdeaId)||(u.selectedIdeaId=null)),e&&U()}async function Ym({projectId:n,force:e=!1}={}){if(!n){u.projectStatsView=null;return}if(!e&&u.projectStatsCache[n]){u.projectStatsView=u.projectStatsCache[n];return}const t=await Fo(n),r=t.map(b=>{const S=la(b.content_md??""),k=oa(S),_=bC(b);return{id:b.id,title:b.title||"Sans titre",order_index:b.order_index??0,words:k,timestamp:_}});let s=0;const i=new Set;let o=null;const a=new Map;for(const b of r)if(s+=b.words,b.timestamp){const S=xh(b.timestamp);if(S){i.add(S);const k=a.get(S)??0;a.set(S,k+b.words)}(!o||b.timestamp>o.timestamp)&&(o=b)}const l=i.size,c=l?Math.round(s/l):0,d=Array.from(a.entries()).sort((b,S)=>b[0]>S[0]?1:-1).map(([b,S])=>({date:b,words:S})),h=[...r].sort((b,S)=>(b.order_index??0)-(S.order_index??0)),p=(await sf(n)).filter(b=>b.end_at&&b.duration_ms),m=p.reduce((b,S)=>b+(S.duration_ms??0),0),g=new Set(p.map(b=>xh(b.start_at??b.end_at)).filter(Boolean)),y=m?Math.round(m/6e4):null,w=y&&g.size?Math.round(y/g.size):null,v={totalWords:s,totalChapters:t.length,daysActive:l,wordsPerDay:c,timeSpentMinutes:y,timePerDayMinutes:w,lastActivity:o,series:d,chapters:h};u.projectStatsCache[n]=v,u.projectStatsView=v}function oa(n){const e=n.trim();if(!e)return 0;const t=e.match(/\S+/g);return t?t.length:0}function Xm(n){const e=Math.max(0,Math.floor(n/1e3)),t=Math.floor(e/60),r=e%60;return`${String(t).padStart(2,"0")}:${String(r).padStart(2,"0")}`}function Qm(){const n=GE?.();if(Number.isFinite(n))return n;const e=la(u.chapterDetail?.content_md??"");return oa(e)}function aa(){const n=document.querySelector('[data-action="focus-toggle"]'),e=document.querySelector("#focus-indicator");if(document.body.classList.toggle("focus-mode",!!u.focusSession),!n)return;const t=n.querySelector(".focus-toggle-label")??n;if(!u.focusSession){t.textContent=" Dmarrer le focus",n.classList.remove("is-active"),n.setAttribute("aria-pressed","false"),e&&(e.textContent="",e.classList.remove("is-active"));return}const r=Date.now()-u.focusSession.start_at;t.textContent=" Quitter le focus",n.classList.add("is-active"),n.setAttribute("aria-pressed","true"),e&&(e.textContent=` Focus en cours  ${Xm(r)}`,e.classList.add("is-active"))}function mC(){ms||(ms=window.setInterval(()=>{u.focusSession&&aa()},1e3))}function gC(){ms&&(clearInterval(ms),ms=null)}async function yC(){if(u.writingNav!=="chapter"||!u.selectedProjectId||!u.selectedChapterId||u.focusSession)return;const n=Qm(),e=await Fv(u.selectedProjectId,u.selectedChapterId,{start_at:Date.now(),word_count_start:n});e&&(u.focusSession=e,u.focusElapsedMs=0,mC(),aa())}async function zt({reason:n}={}){if(!u.focusSession)return;const e=Date.now(),t=Qm(),r=Math.max(0,e-u.focusSession.start_at);await of(u.focusSession.id,{end_at:e,duration_ms:r,word_count_end:t});const s=u.focusSession.project_id;u.focusSession=null,u.focusElapsedMs=0,gC(),aa(),s&&(delete u.projectStatsCache[s],u.writingNav==="stats"&&await Ym({projectId:s,force:!0}))}async function wC(){const e=(await sf()).filter(t=>!t.end_at);for(const t of e)await of(t.id,{end_at:t.start_at,duration_ms:0,word_count_end:t.word_count_start??0})}function xh(n){const e=new Date(n);return Number.isNaN(e.getTime())?null:e.toISOString().slice(0,10)}function bC(n){return n.updated_local_at??n.updated_at??n.created_at??null}function la(n){if(!n)return"";if(!/<[a-z][\s\S]*>/i.test(n))return n;const e=document.createElement("div");return e.innerHTML=n,e.textContent??""}function Zm(n){const e=Number.isFinite(n?.started_at)?n.started_at:null;if(e===null)return null;const t=Number.isFinite(n?.ended_at)?n.ended_at:null,r=Number.isFinite(n?.duration_ms)?n.duration_ms:null,s=Number.isFinite(t)?t:Number.isFinite(r)?e+r:null;if(!Number.isFinite(s)||s<=e)return null;const i=Number.isFinite(r)&&r>0?r:s-e;return i<=0?null:{start:e,end:s,duration:i}}function vC(n,e){if(!Array.isArray(n))return{timeSpent:null,timePerDay:null};if(n.length===0)return{timeSpent:0,timePerDay:0};let t=0,r=null;for(const o of n){const a=Zm(o);a&&(t+=a.duration,r=r===null?a.start:Math.min(r,a.start))}if(t<=0||r===null)return{timeSpent:0,timePerDay:0};const s=t/6e4,i=Math.max(1,Math.ceil((e-r)/864e5));return{timeSpent:s,timePerDay:s/i}}const Bn=[{id:"night",label:"Nuit (0h-6h)",startHour:0,endHour:6},{id:"morning",label:"Matin (6h-12h)",startHour:6,endHour:12},{id:"afternoon",label:"Apres-midi (12h-18h)",startHour:12,endHour:18},{id:"evening",label:"Soir (18h-24h)",startHour:18,endHour:24}],kC=30,SC=6e4;function _C(n){return n<6?Bn[0]:n<12?Bn[1]:n<18?Bn[2]:Bn[3]}function xC(n){if(!Array.isArray(n)||n.length===0)return{status:"unavailable",label:null};const e=Bn.reduce((i,o)=>(i[o.id]=0,i),{});let t=0;for(const i of n){const o=Zm(i);if(!o)continue;let a=o.start;for(;a<o.end;){const l=new Date(a),c=_C(l.getHours()),d=new Date(l);d.setMinutes(0,0,0),d.setHours(c.endHour,0,0,0);const h=Math.min(o.end,d.getTime()),f=h-a;f>0&&(e[c.id]+=f,t+=f),a=h}}if(t<=0)return{status:"unavailable",label:null};if(t<kC*6e4)return{status:"insufficient",label:null};const r=Math.max(...Bn.map(i=>e[i.id]));if(r<=0)return{status:"unavailable",label:null};const s=Bn.filter(i=>Math.abs(e[i.id]-r)<=SC);return s.length!==1?{status:"insufficient",label:null}:{status:"ok",label:s[0].label}}async function wn(){const[n,e]=await Promise.all([F("chapters"),Ev().catch(()=>null)]),t=Date.now();let r=0,s=null,i=n.length>0;const o=vC(e,t),a=xC(e);for(const f of n){const p=la(f.content_md??"");r+=oa(p);const m=f.created_at??f.updated_at??f.updated_local_at??null;if(m){const g=new Date(m).getTime();Number.isNaN(g)||(s=s===null?g:Math.min(s,g))}}if(!i){u.homeStats={totalWords:null,wordsPerDay:null,pagesTotal:null,pagesPerDay:null,timeSpent:o.timeSpent,timePerDay:o.timePerDay,favoriteTime:a.label,favoriteTimeStatus:a.status};return}const l=s===null?1:Math.max(1,Math.ceil((t-s)/864e5)),c=r?Math.round(r/l):0,d=r?Math.ceil(r/250):0,h=d?d/l:0;u.homeStats={totalWords:r,wordsPerDay:c,pagesTotal:d,pagesPerDay:h,timeSpent:o.timeSpent,timePerDay:o.timePerDay,favoriteTime:a.label,favoriteTimeStatus:a.status}}function TC(){return!!(u.selectedChapterId&&u.writingNav==="chapter")}function EC(){xr&&clearTimeout(xr),xr=window.setTimeout(()=>{Ws("idle")},oC)}function CC(){if(!TC())return;const n=Date.now();rn?rn.chapterId!==u.selectedChapterId?(Ws("chapter-switch"),rn={projectId:u.selectedProjectId??null,chapterId:u.selectedChapterId??null,startedAt:n,lastActivityAt:n}):rn.lastActivityAt=n:rn={projectId:u.selectedProjectId??null,chapterId:u.selectedChapterId??null,startedAt:n,lastActivityAt:n},EC()}async function Ws(n){if(!rn)return;const e=rn;rn=null,xr&&(clearTimeout(xr),xr=null);const t=e.lastActivityAt??Date.now();if(!Number.isFinite(e.startedAt)||t<=e.startedAt)return;const r=t-e.startedAt;try{await Tv({project_id:e.projectId,chapter_id:e.chapterId,started_at:e.startedAt,ended_at:t,duration_ms:r}),await wn()}catch(s){console.error("writing session save error",n,s)}}function AC(){return u.chapters.map((e,t)=>({chapter:e,index:t})).sort((e,t)=>{const r=(e.chapter.order_index??0)-(t.chapter.order_index??0);return r!==0?r:e.index-t.index}).map(e=>e.chapter)}async function MC(n){const e=[];if(n.forEach((t,r)=>{const s=(r+1)*10;(t.order_index??0)!==s&&e.push({chapter:t,order_index:s})}),!!e.length){for(const t of e){const r={...t.chapter,order_index:t.order_index};await V("chapters",r)}u.chapters=n.map(t=>{const r=e.find(s=>s.chapter.id===t.id);return r?{...t,order_index:r.order_index}:t}),navigator.onLine&&await Promise.all(e.map(t=>uv(t.chapter.id,{order_index:t.order_index})))}}async function IC(n,e){if(!n||!e||n===e)return;const t=AC(),r=t.findIndex(a=>a.id===n),s=t.findIndex(a=>a.id===e);if(r===-1||s===-1)return;const i=[...t],[o]=i.splice(r,1);i.splice(s,0,o),await MC(i),M()}function Ro(){return u.characters.find(n=>n.id===u.selectedCharacterId)}async function OC(){if(!u.selectedProjectId){te("Cree un projet avant d'ajouter un personnage.");return}const n=await Av(u.selectedProjectId);await yn(),u.selectedCharacterId=n?.id??u.selectedCharacterId,M()}async function NC(n){!n||n===u.selectedCharacterId||(u.selectedCharacterId=n,M())}async function $C(n){if(!n)return;const e=u.characters.find(s=>s.id===n),t=e?.first_name||e?.last_name?`${e?.first_name??""} ${e?.last_name??""}`.trim():"ce personnage";window.confirm(`Supprimer ${t} ?`)&&(await Mv(n),await yn(),M())}function RC(n){u.characterFilter=n,M()}function PC(n){!n||!(n in u.characterSections)||(u.characterSections={...u.characterSections,[n]:!u.characterSections[n]},M())}async function DC(n){const e=Ro();if(!e)return;const t=Math.max(0,Math.min(5,n));await Bi(e.id,{role_rating:t}),await yn(),M()}function LC(n,e){const t=n;il.has(t)&&clearTimeout(il.get(t));const r=window.setTimeout(async()=>{await Bi(n,e),await yn(),M()},400);il.set(t,r)}function eg(n,e,t=null){const r=Ro();if(!r)return;const s=t?{meta:{[t]:{...r.meta?.[t]??{},[n]:e}}}:{[n]:e};LC(r.id,s)}function jC(){te("Bientot disponible.")}function Ge(n){return String(n||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function Ds(n){return String(n||"").split(",").map(e=>e.trim()).filter(Boolean)}function ge(n){return Ge(String(n||"").trim()).replace(/\s+/g," ")}function Ni(){return u.writingNav==="knowledge"&&u.knowledgeTab==="graph"}function Tt(){return u.writingNav==="mindmap"?"mindmap":Ni()?"wikiGraph":null}function tg(n=Tt()){return n==="mindmap"?u.mindmapNodes:n==="wikiGraph"?u.wikiGraphNodes:[]}function BC(n,e=Tt()){if(e==="mindmap"){u.mindmapNodes=n;return}e==="wikiGraph"&&(u.wikiGraphNodes=n)}function Ls(n=Tt()){return n==="mindmap"?u.mindmapView:n==="wikiGraph"?u.wikiGraphView:{offsetX:0,offsetY:0,scale:1}}function ng(n,e=Tt()){if(e==="mindmap"){u.mindmapView=n;return}e==="wikiGraph"&&(u.wikiGraphView=n)}function gs(n){u.knowledgeTitleError=n||"";const e=document.querySelector("#knowledge-title-error");e&&(e.textContent=u.knowledgeTitleError,e.classList.toggle("is-visible",!!u.knowledgeTitleError));const t=document.querySelector("#knowledge-title");t instanceof HTMLInputElement&&(u.knowledgeTitleError?t.setAttribute("aria-invalid","true"):t.removeAttribute("aria-invalid"))}function rg(n,e){n&&(u.knowledgeTitleDrafts={...u.knowledgeTitleDrafts,[n]:e})}function rc(n){if(!n)return;const{[n]:e,...t}=u.knowledgeTitleDrafts,{[n]:r,...s}=u.knowledgeTitleOriginals;u.knowledgeTitleDrafts=t,u.knowledgeTitleOriginals=s}function ld(n){return u.knowledgeNotes.find(t=>t.id===n)?.title??""}function FC(){let n=[...u.ideas];const e=u.ideasQuery.trim();if(e){const r=Ge(e);n=n.filter(s=>{const i=[s.content,s.note,...s.tags??[]].filter(Boolean).join(" ");return Ge(i).includes(r)})}if(u.ideasTagFilter.trim()){const r=Ge(u.ideasTagFilter.trim());n=n.filter(s=>(s.tags??[]).some(i=>Ge(i).includes(r)))}u.ideasStatusFilter!=="all"&&(n=n.filter(r=>r.status===u.ideasStatusFilter));const t=u.ideasSort==="asc"?1:-1;return n.sort((r,s)=>{const i=r.created_at??0,o=s.created_at??0;return t*(i-o)}),n}function ca(){return u.knowledgeActiveId?u.knowledgeNotes.find(n=>n.id===u.knowledgeActiveId)??null:null}function UC(){let n=[...u.knowledgeNotes];const e=u.knowledgeSearch.trim();if(e){const t=Ge(e);n=n.filter(r=>Ge(r.title??"").includes(t))}return u.knowledgeSort==="alpha"?(n.sort((t,r)=>Ge(t.title??"").localeCompare(Ge(r.title??""))),n):(n.sort((t,r)=>(r.updated_at??0)-(t.updated_at??0)),n)}function sg(n){if(!n)return[];const e=ge(n.title);if(!e)return[];const t=new Set(u.knowledgeLinks.filter(s=>s.to_title===e).map(s=>s.from_note_id)),r=[];for(const s of u.knowledgeNotes){if(!t.has(s.id)||s.id===n.id)continue;const i=qC(s.content??"",e);i.length&&r.push({id:s.id,title:s.title??"",updated_at:s.updated_at??0,contexts:i})}return r.sort((s,i)=>(i.updated_at??0)-(s.updated_at??0))}function zC(){return sg(ca())}function ig(n){const e=new Set;if(!n)return[];const t=/\[\[([^\]\|]+)(?:\|[^\]]+)?\]\]/g;let r;for(;(r=t.exec(n))!==null;){const i=(r[1]??"").trim(),o=ge(i);o&&e.add(o)}return Array.from(e)}function og(n){const e=new Map;if(!n)return e;const t=/\[\[([^\]\|]+)(?:\|[^\]]+)?\]\]/g;let r;for(;(r=t.exec(n))!==null;){const i=(r[1]??"").trim(),o=ge(i);o&&e.set(o,(e.get(o)??0)+1)}return e}function HC(n,e,t){if(!n)return n;const r=ge(e),s=t.trim();if(!r||!s)return n;const i=/\[\[([^\]\|]+)(\|[^\]]+)?\]\]/g;return n.replace(i,(o,a,l)=>ge(a)!==r?o:`[[${s}${l??""}]]`)}function VC(n,e,t,r=60){const s=Math.max(0,e-r),i=Math.min(n.length,t+r);let o=n.slice(s,i);return o=o.replace(/\s+/g," ").trim(),s>0&&(o=`...${o}`),i<n.length&&(o=`${o}...`),o}function qC(n,e){if(!n||!e)return[];const t=[],r=/\[\[([^\]\|]+)(?:\|[^\]]+)?\]\]/g;let s;for(;(s=r.exec(n))!==null;){const i=(s[1]??"").trim();if(ge(i)!==e)continue;const o=VC(n,s.index,s.index+s[0].length);if(o&&t.push(o),t.length>=2)break}return t}function Zn(){u.wikiGraphNeedsBuild=!0,u.wikiGraphLayoutReady=!1}function WC(){const n=u.knowledgeNotes,e=new Map;for(const o of n){const a=ge(o.title);a&&e.set(a,o)}const t=n.map(o=>({id:o.id,title:o.title||"Sans titre",degree:0,x:0,y:0})),r=new Map(t.map(o=>[o.id,o])),s=new Map;for(const o of n){const a=og(o.content??"");for(const[l,c]of a.entries()){const d=e.get(l);if(!d||d.id===o.id)continue;const h=`${o.id}::${d.id}`,f=s.get(h)??{id:h,fromId:o.id,toId:d.id,count:0};f.count+=c,s.set(h,f)}}const i=Array.from(s.values());for(const o of i){const a=r.get(o.fromId),l=r.get(o.toId);a&&(a.degree+=1),l&&(l.degree+=1)}u.wikiGraphNodes=t,u.wikiGraphEdges=i,u.wikiGraphNeedsBuild=!1,u.wikiGraphGuardMessage="",u.wikiGraphView={offsetX:0,offsetY:0,scale:id},KC(t,i),u.wikiGraphLayoutReady=!0,u.wikiGraphSelectedNodeId&&!r.has(u.wikiGraphSelectedNodeId)&&(u.wikiGraphSelectedNodeId=null)}function KC(n,e){const t=n.length;if(!t)return;const r=1400,s=900,i=r/2,o=s/2;if(t>cC){const w=Math.ceil(Math.sqrt(t)),v=260;n.forEach((b,S)=>{const k=S%w,_=Math.floor(S/w);b.x=k*v+40,b.y=_*v+40});return}const a=Math.min(r,s)*.42;n.forEach((w,v)=>{const b=v/t*Math.PI*2;w.x=i+Math.cos(b)*a+(Math.random()-.5)*40,w.y=o+Math.sin(b)*a+(Math.random()-.5)*40});const l=new Map(n.map((w,v)=>[w.id,v])),c=e.map(w=>({from:l.get(w.fromId),to:l.get(w.toId)})).filter(w=>Number.isFinite(w.from)&&Number.isFinite(w.to)),d=t<=120?320:t<=220?240:180,h=12e3,f=.035,p=.85,m=240,g=new Array(t).fill(0),y=new Array(t).fill(0);for(let w=0;w<d;w+=1){const v=new Array(t).fill(0),b=new Array(t).fill(0);for(let k=0;k<t;k+=1)for(let _=k+1;_<t;_+=1){const x=n[_].x-n[k].x,E=n[_].y-n[k].y,N=Math.hypot(x,E)||1;if(N>560)continue;const H=h/(N*N),A=H*x/N,J=H*E/N;v[k]-=A,b[k]-=J,v[_]+=A,b[_]+=J}for(const k of c){const _=k.from,x=k.to,E=n[x].x-n[_].x,N=n[x].y-n[_].y,H=Math.hypot(E,N)||1,A=(H-m)*f,J=A*E/H,ee=A*N/H;v[_]+=J,b[_]+=ee,v[x]-=J,b[x]-=ee}let S=0;for(let k=0;k<t;k+=1)g[k]=(g[k]+v[k])*p,y[k]=(y[k]+b[k])*p,n[k].x+=g[k],n[k].y+=y[k],S+=Math.hypot(g[k],y[k]);if(S/t<.2)break}}function ag(){!u.wikiGraphNeedsBuild&&u.wikiGraphLayoutReady||WC()}function GC(){const n=u.wikiGraphNodes,e=u.wikiGraphSearch.trim(),t=Number(u.wikiGraphMinDegree)||0,r=u.wikiGraphShowOrphans;let s=n;if(e){const a=Ge(e);s=s.filter(l=>Ge(l.title).includes(a))}if(r||(s=s.filter(a=>a.degree>0)),t>0&&(s=s.filter(a=>a.degree>=t)),s.length>lC)return u.wikiGraphSelectedNodeId=null,{nodes:[],edges:[],visibleIds:new Set,blockedMessage:"Le graphe est volumineux. Ajoute un filtre (recherche ou min connexions) pour l'afficher."};const i=new Set(s.map(a=>a.id)),o=u.wikiGraphEdges.filter(a=>i.has(a.fromId)&&i.has(a.toId));return u.wikiGraphSelectedNodeId&&!i.has(u.wikiGraphSelectedNodeId)&&(u.wikiGraphSelectedNodeId=null),{nodes:s,edges:o,visibleIds:i,blockedMessage:""}}function JC(){const n=u.wikiGraphSelectedNodeId;if(!n)return{note:null,outgoing:[],backlinks:[]};const e=u.knowledgeNotes.find(o=>o.id===n);if(!e)return{note:null,outgoing:[],backlinks:[]};const t=new Map;for(const o of u.knowledgeNotes){const a=ge(o.title);a&&t.set(a,o)}const r=[],s=og(e.content??"");for(const[o,a]of s.entries()){const l=t.get(o);!l||l.id===e.id||r.push({id:l.id,title:l.title||"Sans titre",count:a})}r.sort((o,a)=>(o.title||"").localeCompare(a.title||""));const i=sg(e);return{note:e,outgoing:r,backlinks:i}}function YC(){const{nodes:n,edges:e,blockedMessage:t}=GC();return{nodes:n,edges:e,blockedMessage:t,selectedNodeId:u.wikiGraphSelectedNodeId,view:u.wikiGraphView,search:u.wikiGraphSearch,minDegree:u.wikiGraphMinDegree,showOrphans:u.wikiGraphShowOrphans,panelCollapsed:u.wikiGraphPanelCollapsed,settingsOpen:u.wikiGraphSettingsOpen}}function cd(n,e){n&&(u.knowledgeNotes=u.knowledgeNotes.map(t=>t.id===n?{...t,...e}:t))}function sc(n,e){const t=document.querySelector(`.knowledge-note-item[data-id="${n}"] .knowledge-note-title`);t&&(t.textContent=e?.trim()||"Sans titre")}function Dr(){const n=new Map;for(const t of u.knowledgeNotes){const r=ge(t.title);r&&(n.has(r)||n.set(r,[]),n.get(r).push(t))}const e=[];for(const[t,r]of n.entries())r.length>1&&e.push({key:t,title:r[0]?.title??"",notes:r});u.knowledgeDuplicates=e}function Th(n,e,t=700){if(!n)return;const r=Io.get(n)??{};Io.set(n,{...r,...e}),Tr.has(n)&&clearTimeout(Tr.get(n));const s=window.setTimeout(()=>{lg(n)},t);Tr.set(n,s)}async function ic(n,e,{render:t=!1}={}){if(!n)return;const r=await Hv(n,e);r?u.ideas=u.ideas.map(s=>s.id===n?r:s):u.ideas=await zo({projectId:u.ideasProjectId}),t&&U()}async function lg(n,{render:e=!1}={}){const t=Io.get(n);t&&(Io.delete(n),Tr.has(n)&&(clearTimeout(Tr.get(n)),Tr.delete(n)),await ic(n,t,{render:e}))}function cg(n,e,t=600){if(!n)return;const r=Ps.get(n)??{};Ps.set(n,{...r,...e}),Bt.has(n)&&clearTimeout(Bt.get(n));const s=window.setTimeout(()=>{Ks(n)},t);Bt.set(n,s)}function XC(n,e){const t=ge(e);return t?u.knowledgeNotes.some(r=>r.id!==n&&ge(r.title)===t):!1}async function QC(n,e,{render:t=!1}={}){if(!n)return;const r={...e},s=await yc(n,r);if(s){if(u.knowledgeNotes=u.knowledgeNotes.map(i=>i.id===n?s:i),Object.prototype.hasOwnProperty.call(r,"content")){const i=ig(s.content??"");await lf(n,s.project_id,i),u.knowledgeLinks=await fn(s.project_id),Zn()}}else u.knowledgeProjectId&&(u.knowledgeNotes=await Cr(u.knowledgeProjectId),u.knowledgeLinks=await fn(u.knowledgeProjectId));t&&M()}async function Ks(n,{render:e=!1}={}){const t=Ps.get(n);t&&(Ps.delete(n),Bt.has(n)&&(clearTimeout(Bt.get(n)),Bt.delete(n)),await QC(n,t,{render:e}))}async function ZC(n,{select:e=!1}={}){const t=n.trim();if(!t)return;const r=await zv({content:t,status:"raw",tags:[],note:"",project_id:u.ideasProjectId});u.ideas=await zo({projectId:u.ideasProjectId}),e&&r?.id&&(u.selectedIdeaId=r.id,u.ideasNoteExpanded=!1),U()}async function eA(n){!n||!window.confirm("Supprimer cette idee ?")||(await Vv(n),u.ideas=await zo({projectId:u.ideasProjectId}),u.selectedIdeaId===n&&(u.selectedIdeaId=u.ideas[0]?.id??null,u.ideasNoteExpanded=!1),U())}function tA(n){const e=n.trim()||"Note",r=(e.match(/^(.*?)(?:\s*\((\d+)\))?$/)?.[1]??e).trim()||e,s=new Set(u.knowledgeNotes.map(a=>ge(a.title)));let i=2,o=`${r} (${i})`;for(;s.has(ge(o));)i+=1,o=`${r} (${i})`;return o}function dd(n){const e=ge(n);return e?u.knowledgeNotes.find(t=>ge(t.title)===e):null}function da(){const n=ca();if(!n)return;const e=document.querySelector("#knowledge-title"),t=document.querySelector("#knowledge-content"),r={};e instanceof HTMLInputElement&&rg(n.id,e.value),t instanceof HTMLTextAreaElement&&(r.content=t.value),Object.keys(r).length&&cd(n.id,r)}function it(){u.knowledgeAutocomplete.open&&(u.knowledgeAutocomplete={open:!1,query:"",matches:[],range:null,createTitle:""},ud())}function nA(n,e){if(!Number.isFinite(e))return null;const t=n.slice(0,e),r=t.lastIndexOf("[[");if(r===-1||t.lastIndexOf("]]")>r)return null;const i=t.slice(r+2);return i.includes(`
`)?null:{query:i,start:r+2,end:e}}function rA(n){if(!(n instanceof HTMLTextAreaElement))return;if(u.writingNav!=="knowledge"||u.knowledgePreviewOpen){it();return}const e=nA(n.value,n.selectionStart);if(!e){it();return}const t=e.query,r=t.trim();let s=u.knowledgeNotes.map(a=>a.title).filter(Boolean);if(r){const a=ge(r);s=s.filter(l=>ge(l).includes(a))}s=s.slice(0,6);const i=r?s.some(a=>ge(a)===ge(r)):!1,o=r&&!i?r:"";if(!s.length&&!o){it();return}u.knowledgeAutocomplete={open:!0,query:t,matches:s,range:e,createTitle:o},ud()}function ud(){const n=document.querySelector("#knowledge-autocomplete");if(!n)return;if(n.replaceChildren(),!u.knowledgeAutocomplete.open){n.classList.remove("is-open");return}n.classList.add("is-open");const{matches:e,createTitle:t}=u.knowledgeAutocomplete,r=document.createDocumentFragment();for(const s of e){const i=document.createElement("button");i.type="button",i.className="knowledge-autocomplete-item",i.dataset.action="knowledge-autocomplete-select",i.dataset.title=encodeURIComponent(s),i.textContent=s,r.appendChild(i)}if(t){const s=document.createElement("button");s.type="button",s.className="knowledge-autocomplete-item is-create",s.dataset.action="knowledge-autocomplete-select",s.dataset.title=encodeURIComponent(t),s.dataset.create="true",s.textContent=`Creer : ${t}`,r.appendChild(s)}n.appendChild(r)}async function dg(n=""){if(!u.knowledgeProjectId)return;u.knowledgeActiveId&&(da(),await Gs(u.knowledgeActiveId,{reason:"blur"}),await Ks(u.knowledgeActiveId,{render:!1}));const e=String(n||"Nouvelle note").trim()||"Nouvelle note",t=dd(e);if(t){await ua(t.id);return}const r=await af(u.knowledgeProjectId,e);u.knowledgeNotes=await Cr(u.knowledgeProjectId),u.knowledgeLinks=await fn(u.knowledgeProjectId),Zn(),Dr(),r?.id&&(u.knowledgeActiveId=r.id,u.wikiGraphSelectedNodeId=r.id),u.knowledgePreviewOpen=!1,it(),M()}async function ua(n){if(!n||n===u.knowledgeActiveId)return;const e=u.knowledgeActiveId;e&&(da(),await Gs(e,{reason:"blur"}),await Ks(e,{render:!1})),u.knowledgeActiveId=n,u.wikiGraphSelectedNodeId=n,u.knowledgePreviewOpen=!1,it(),M()}async function sA(n){!n||!window.confirm("Supprimer cette note ?")||(Ps.delete(n),Bt.has(n)&&(clearTimeout(Bt.get(n)),Bt.delete(n)),await Uv(n),u.knowledgeProjectId?(u.knowledgeNotes=await Cr(u.knowledgeProjectId),u.knowledgeLinks=await fn(u.knowledgeProjectId)):(u.knowledgeNotes=[],u.knowledgeLinks=[]),Zn(),Dr(),u.knowledgeActiveId===n&&(u.knowledgeActiveId=u.knowledgeNotes[0]?.id??null,u.wikiGraphSelectedNodeId=u.knowledgeActiveId),u.knowledgePreviewOpen=!1,it(),M())}async function iA(n){const e=String(n??"").trim();if(!e)return;const t=dd(e);if(t){await ua(t.id);return}await dg(e)}async function oA(n){const e=u.selectedProjectId;if(!e)return;const t=String(n??"").trim();if(!t||!ge(t))return;u.knowledgeProjectId=e,u.knowledgeNotes=await Cr(e),u.knowledgeLinks=await fn(e),Zn(),Dr();let s=dd(t);if(!s){const i=await af(e,t);i&&(u.knowledgeNotes=await Cr(e),u.knowledgeLinks=await fn(e),Zn(),Dr(),s=i)}if(s){if(u.knowledgeActiveId=s.id,u.wikiGraphSelectedNodeId=s.id,u.knowledgeTab="notes",u.knowledgePreviewOpen=!1,it(),u.writingNav!=="knowledge"){window.location.hash=`#/project/${e}/knowledge`;return}M()}}function aA(n,e){if(typeof n!="string"||!Number.isFinite(e)||!n.includes("[["))return null;const t=/\[\[([^\]]+)\]\]/g;let r;for(;(r=t.exec(n))!==null;){const s=r.index,i=s+r[0].length;if(e<s||e>i)continue;const o=r[1]??"";if(o.includes(`
`))continue;const a=o.indexOf("|"),l=(a===-1?o:o.slice(0,a)).trim();return l?{title:l,start:s,end:i}:null}return null}function lA(n){if(n instanceof HTMLTextAreaElement)return!0;if(n instanceof HTMLInputElement){const e=(n.type||"text").toLowerCase();return e==="text"||e==="search"}return!1}function cA(n){return n.closest(".knowledge-editor")?n.id!=="knowledge-title":!!(n.closest(".character-detail-panel")||n.id==="ideas-create-input"||n.classList.contains("ideas-detail-input")||n.classList.contains("ideas-note-input"))}async function Eh(n){const e=String(n??"").trim();if(!e)return;const t=ge(e);if(!t)return;if(xi.has(t))return xi.get(t);const r=(async()=>{if(u.writingNav==="knowledge"){await iA(e);return}await oA(e)})().finally(()=>{xi.delete(t)});return xi.set(t,r),r}function ha(){return document.querySelector("#graph-tooltip")}function dA(){const n=document.querySelector(".knowledge-graph-canvas")||document.querySelector(".wiki-graph-canvas");return n?n.getBoundingClientRect():{left:0,top:0,right:window.innerWidth,bottom:window.innerHeight}}function uA(n){let e=n.parentElement;for(;e&&e!==document.body;){const t=window.getComputedStyle(e);if(t.transform!=="none"||t.perspective!=="none"||t.filter!=="none"){const r=e.getBoundingClientRect();return{left:r.left,top:r.top}}e=e.parentElement}return{left:0,top:0}}function ug(n,e){const t=e.getBoundingClientRect(),r=dA(),s=uA(n),i=8,o=6,a=n.offsetWidth||0,l=n.offsetHeight||0,c=r.left-s.left,d=r.top-s.top,h=r.right-s.left,f=r.bottom-s.top;let p=t.right-s.left+i,m=t.top-s.top+(t.height-l)/2;p+a+o>h&&(p=t.left-s.left-a-i),p<c+o&&(p=c+o),m<d+o&&(m=d+o),m+l+o>f&&(m=f-l-o),n.style.left=`${p}px`,n.style.top=`${m}px`}function hA(n,e){const t=ha();if(!t)return;const r=n.dataset.title||"",s=r?decodeURIComponent(r):n.getAttribute("aria-label")||"";s&&(t.textContent=s,t.setAttribute("aria-hidden","false"),t.classList.add("is-visible"),ug(t,n))}function fA(){const n=ha();n&&(n.classList.remove("is-visible"),n.setAttribute("aria-hidden","true"))}function pA(){u.knowledgeSort=u.knowledgeSort==="alpha"?"recent":"alpha",M()}async function mA(n){!n||n===u.knowledgeTab||(u.knowledgeTab==="notes"&&u.knowledgeActiveId&&(da(),await Gs(u.knowledgeActiveId,{reason:"blur"}),await Ks(u.knowledgeActiveId,{render:!1})),u.knowledgeTab=n,n==="graph"&&(it(),u.knowledgePreviewOpen=!1,ag(),!u.wikiGraphSelectedNodeId&&u.knowledgeActiveId&&(u.wikiGraphSelectedNodeId=u.knowledgeActiveId)),M())}function gA(){da(),u.knowledgePreviewOpen=!u.knowledgePreviewOpen,it(),M()}function yA(n){const e=ca();if(!e)return;const t=document.querySelector("#knowledge-content");if(!(t instanceof HTMLTextAreaElement))return;const r=u.knowledgeAutocomplete.range;if(!r)return;const s=String(n??"").trim();if(!s)return;const i=t.value.slice(0,r.start),o=t.value.slice(r.end),l=o.startsWith("]]")?"":"]]",c=`${i}${s}${l}${o}`;t.value=c;const d=i.length+s.length+l.length;t.setSelectionRange(d,d),cd(e.id,{content:c}),cg(e.id,{content:c}),it(),t.focus()}function hg(n){n&&(u.wikiGraphSelectedNodeId=n,M())}function wA(){u.wikiGraphView={offsetX:0,offsetY:0,scale:id},M()}async function oc(n){n&&(u.knowledgeTab="notes",await ua(n))}function bA(n,e){const t=document.querySelector("#knowledge-title");t instanceof HTMLInputElement&&t.dataset.id===n&&(t.value=e),sc(n,e),rc(n),gs("")}async function vA({projectId:n,oldTitle:e,newTitle:t}){const r=[...u.knowledgeNotes];for(const s of r){const i=s.content??"",o=HC(i,e,t);if(o===i)continue;const a=await yc(s.id,{content:o});if(a){u.knowledgeNotes=u.knowledgeNotes.map(c=>c.id===s.id?a:c);const l=ig(a.content??"");await lf(s.id,n,l)}}u.knowledgeLinks=await fn(n)}async function fg({id:n,oldTitle:e,newTitle:t}){const r=u.knowledgeNotes.find(a=>a.id===n);if(!r)return;const s=r.project_id;u.knowledgeNotes.length>200&&(u.knowledgeRenameBusy=!0,M());const o=await yc(n,{title:t});o&&(u.knowledgeNotes=u.knowledgeNotes.map(a=>a.id===n?o:a)),e.trim()!==t.trim()&&await vA({projectId:s,oldTitle:e,newTitle:t}),u.knowledgeRenameBusy=!1,Zn(),Dr()}async function Gs(n,{reason:e="blur"}={}){if(!n)return;const t=u.knowledgeTitleDrafts[n];if(t===void 0)return;const r=u.knowledgeTitleOriginals[n]??ld(n),s=String(t??"").trim();if(!s){gs("Le titre ne peut pas etre vide.");return}if(XC(n,s)){gs("Ce titre existe deja dans ce projet.");return}if(gs(""),s===r.trim()){rc(n),sc(n,s);return}await fg({id:n,oldTitle:r,newTitle:s}),rc(n),sc(n,s),M()}async function kA(n){if(!n)return;const e=u.knowledgeNotes.find(s=>s.id===n);if(!e)return;const t=e.title?.trim()||"Note",r=tA(t);await fg({id:n,oldTitle:t,newTitle:r}),M()}function hd(n="type",e=null,t=null,r="create"){u.inspirationModal={open:!0,step:n,type:e,mode:r,draft:t},M()}function pg(){u.inspirationModal={open:!1,step:"type",type:null,mode:"create",draft:null},M()}function SA(n){u.inspirationDetailId=n,M()}function _A(){u.inspirationDetailId=null,M()}async function xA(){if(!u.selectedProjectId){te("Cree un projet avant d'ajouter une inspiration.");return}u.inspirationDetailId=null,hd("type",null,{tags:[]},"create")}function TA(n){if(!n)return;const e=u.inspirationModal?.draft??{tags:[]};hd("form",n,{...e,type:n},u.inspirationModal?.mode??"create")}async function EA(){const n=u.inspirationModal;if(!n?.open||n.step!=="form")return;const e=n.type,t=document.querySelector("#inspiration-title")?.value??"",r=document.querySelector("#inspiration-note")?.value??"",s=document.querySelector("#inspiration-tags")?.value??"",i=document.querySelector("#inspiration-url")?.value??"",o=document.querySelector("#inspiration-link-chapter")?.value??"",a=document.querySelector("#inspiration-link-character")?.value??"",l=Ds(s),c=n.draft?.image_data??"";if(e==="image"&&!c){window.alert("Ajoute une image avant d'enregistrer.");return}if((e==="link"||e==="video")&&!i.trim()){window.alert("Ajoute une URL avant d'enregistrer.");return}n.mode==="edit"&&n.draft?.id?await Nv(n.draft.id,{title:t,note:r,tags:l,url:i,image_data:c,linkedChapterId:o,linkedCharacterId:a}):await Ov(u.selectedProjectId,{type:e,title:t,note:r,tags:l,url:i,image_data:c,linkedChapterId:o,linkedCharacterId:a}),await $o(),pg()}function CA(n){u.inspirationSearch=n,M()}function AA(n){u.inspirationTag=n,M()}async function MA(n){const e=u.inspirationItems.find(s=>s.id===n);if(!e)return;const t=e.title||e.url||"cet element";window.confirm(`Supprimer ${t} ?`)&&(await $v(n),await $o(),u.inspirationDetailId=null,M())}function IA(n){const e=u.inspirationItems.find(r=>r.id===n);if(!e)return;u.inspirationDetailId=null;const t={...e,tags:e.tags??[]};hd("form",e.type,t,"edit")}function Po(n){return u.mindmapNodes.find(e=>e.id===n)}async function ac(n=null){if(!u.selectedProjectId){te("Cree un projet avant d'ajouter une carte mentale.");return}const t=document.querySelector(".mindmap-canvas")?.getBoundingClientRect(),r=t?.width??800,s=t?.height??500,i=n?.x??(r/2-u.mindmapView.offsetX)/u.mindmapView.scale-Xn/2,o=n?.y??(s/2-u.mindmapView.offsetY)/u.mindmapView.scale-Qn/2,a=await Pv(u.selectedProjectId,{x:i,y:o,type:u.mindmapCreateType});u.mindmapNodes=[...u.mindmapNodes,a],u.mindmapSelectedNodeId=a.id,M()}async function OA(n){n&&(await Dv(n),u.mindmapNodes=u.mindmapNodes.filter(e=>e.id!==n),u.mindmapEdges=u.mindmapEdges.filter(e=>e.fromNodeId!==n&&e.toNodeId!==n),u.mindmapSelectedNodeId===n&&(u.mindmapSelectedNodeId=null),M())}async function NA(n,e,{render:t=!0}={}){const r=await rf(n,e);r&&(u.mindmapNodes=u.mindmapNodes.map(s=>s.id===n?r:s),t&&M())}async function hl(n,e,t="linked"){if(!n||!e||n===e)return;const r=await Lv(u.selectedProjectId,{fromNodeId:n,toNodeId:e,type:t});u.mindmapEdges=[...u.mindmapEdges,r]}function $A(n){u.mindmapSelectedNodeId=n,u.mindmapDeleteConfirmId=null,M()}function mg(){u.mindmapView={offsetX:0,offsetY:0,scale:1},M()}function Ch(n,e,t){const r=n.x+n.width/2,s=n.y+n.height/2,i=t.x-e.x,o=t.y-e.y;if(i===0&&o===0)return{x:r,y:s};const a=n.width/2,l=n.height/2,c=Math.min(a/Math.max(Math.abs(i),1e-6),l/Math.max(Math.abs(o),1e-6));return{x:r+i*c,y:s+o*c}}function RA(){const n=document.querySelector(".wiki-graph-viewport");if(!n)return;const e=u.wikiGraphView;n.style.transform=`translate(${e.offsetX}px, ${e.offsetY}px) scale(${e.scale})`}function gg(){cl||(cl=window.requestAnimationFrame(()=>{cl=null,RA()}))}function PA(n){const e=u.wikiGraphNodes.find(r=>r.id===n);if(!e)return;const t=document.querySelector(`.graph-node[data-id="${n}"]`);t&&(t.style.transform=`translate(${e.x}px, ${e.y}px)`)}function DA(n){const e=u.wikiGraphEdges.filter(t=>t.fromId===n||t.toId===n);for(const t of e){const r=u.wikiGraphNodes.find(v=>v.id===t.fromId),s=u.wikiGraphNodes.find(v=>v.id===t.toId);if(!r||!s)continue;const i=document.querySelector(`.graph-node[data-id="${t.fromId}"]`),o=document.querySelector(`.graph-node[data-id="${t.toId}"]`),a=i?.offsetWidth||0,l=i?.offsetHeight||0,c=o?.offsetWidth||0,d=o?.offsetHeight||0,h={x:r.x,y:r.y,width:a||Xn,height:l||Qn},f={x:s.x,y:s.y,width:c||Xn,height:d||Qn},p={x:h.x+h.width/2,y:h.y+h.height/2},m={x:f.x+f.width/2,y:f.y+f.height/2},g=Ch(h,p,m),y=Ch(f,m,p),w=document.querySelector(`.graph-edge[data-from="${t.fromId}"][data-to="${t.toId}"]`);w&&(w.setAttribute("x1",g.x),w.setAttribute("y1",g.y),w.setAttribute("x2",y.x),w.setAttribute("y2",y.y))}}function LA(n){ll||(ll=window.requestAnimationFrame(()=>{ll=null,PA(n),DA(n)}))}function yg(n,e){if(!n)return null;let t=null;return u.mindmapNodes=u.mindmapNodes.map(r=>r.id!==n?r:(t={...r,...e},t)),t}function wg(n,e){const r=document.querySelector(`.mindmap-node[data-id="${n}"]`)?.querySelector(".mindmap-node-title");r&&(r.textContent=e||"Sans titre")}async function bg(){Er&&(clearTimeout(Er),Er=null);const n=Array.from(Oo.entries());Oo.clear();for(const[e,t]of n)await NA(e,t,{render:!1})}function vg(n,e){if(!n)return;const t=Oo.get(n)??{};Oo.set(n,{...t,...e}),Er&&clearTimeout(Er),Er=setTimeout(()=>{bg()},aC)}function jA(n){return{x:(n.x-u.mindmapView.offsetX)/u.mindmapView.scale-Xn/2,y:(n.y-u.mindmapView.offsetY)/u.mindmapView.scale-Qn/2}}function BA(n){const e=document.querySelector(".mindmap-canvas");if(!e)return;const t=e.getBoundingClientRect(),r=u.mindmapView.scale,s=t.width/2-(n.x+Xn/2)*r,i=t.height/2-(n.y+Qn/2)*r;u.mindmapView={...u.mindmapView,offsetX:s,offsetY:i}}function FA(n){al&&clearTimeout(al),u.mindmapFlashNodeId=n,M(),al=window.setTimeout(()=>{u.mindmapFlashNodeId=null,M()},600)}async function UA(n){const e=Po(n);if(e){if(e.linkedChapterId){u.writingNav="chapter",await xg(e.linkedChapterId);return}e.linkedCharacterId&&(u.writingNav="characters",u.selectedCharacterId=e.linkedCharacterId,M())}}async function zA(){if(u.cloudBusy)return;u.cloudBusy=!0,u.cloudStatus="Sauvegarde...",U();const n=await Wm();if(n.ok){const e=Date.now();wc(e),u.lastCloudSaveAt=e,u.cloudStatus="Sauvegarde terminee."}else u.cloudStatus=`Erreur: ${n.errorMessage}`;u.cloudBusy=!1,U()}async function HA(){if(u.cloudBusy)return;u.cloudBusy=!0,u.cloudStatus="Chargement...",U();const n=await Km();if(n.ok){n.skipped||(Br=!0);const e=window.location.hash;if(e.startsWith("#/project/")||e.startsWith("#/editor")){const t=u.selectedProjectId??e.replace("#/project/","").split("/")[0];t?await kg(t):(await He({allowFallback:!1}),U())}else e.startsWith("#/projects")?await Jm():e.startsWith("#/home")?await Gm():(await He({allowFallback:!1}),await wn(),await Do(),U());u.cloudStatus="Chargement termine."}else u.cloudStatus=`Erreur: ${n.errorMessage}`;u.cloudBusy=!1,U()}async function VA(){const n=await F("projects"),e=await F("chapters"),t=await F("outbox"),r=await F("characters"),s=await F("inspiration"),i=await F("ideas"),o=await F("mindmap_nodes"),a=await F("mindmap_edges"),l=await F("writing_sessions"),c=await F("knowledge_notes"),d=await F("knowledge_links"),h=await F("focus_sessions"),f={version:1,exportedAt:new Date().toISOString(),data:{projects:n,chapters:e,outbox:t,characters:r,inspiration:s,ideas:i,mindmapNodes:o,mindmapEdges:a,writingSessions:l,knowledgeNotes:c,knowledgeLinks:d,focusSessions:h}},p=new Blob([JSON.stringify(f)],{type:"application/json"}),m=URL.createObjectURL(p),y=`plumeo-backup-${new Date().toISOString().slice(0,10)}.json`,w=document.createElement("a");w.href=m,w.download=y,document.body.appendChild(w),w.click(),w.remove(),URL.revokeObjectURL(m),u.backupStatus="Export termine.",U()}async function lt(n,e){const t=await F(n);for(const r of t)r&&r[e]!=null&&await pe(n,r[e])}async function qA(n){if(!n)return;let e;try{const w=await n.text();e=JSON.parse(w)}catch{u.backupStatus="Import echoue.",U();return}if(!e||e.version!==1||!e.data){u.backupStatus="Import refuse (format).",U();return}const t=e.data,r=Array.isArray(t.projects)?t.projects:null,s=Array.isArray(t.chapters)?t.chapters:null;Array.isArray(t.outbox)&&t.outbox;const i=Array.isArray(t.characters)?t.characters:[],o=Array.isArray(t.inspiration)?t.inspiration:[],a=Array.isArray(t.ideas)?t.ideas:[],l=Array.isArray(t.mindmapNodes)?t.mindmapNodes:[],c=Array.isArray(t.mindmapEdges)?t.mindmapEdges:[],d=Array.isArray(t.writingSessions)?t.writingSessions:[],h=Array.isArray(t.knowledgeNotes)?t.knowledgeNotes:[],f=Array.isArray(t.knowledgeLinks)?t.knowledgeLinks:[],p=Array.isArray(t.focusSessions)?t.focusSessions:[];if(!r||!s){u.backupStatus="Import refuse (donnees).",U();return}const m=await F("projects"),g=await F("chapters");if(!((m.length>0||g.length>0)&&!window.confirm("Importer ce backup va remplacer les donnees locales. Continuer ?"))){await lt("projects","id"),await lt("chapters","id"),await lt("outbox","opId"),await lt("ideas","id"),await lt("inspiration","id"),await lt("mindmap_nodes","id"),await lt("mindmap_edges","id"),await lt("writing_sessions","id"),await lt("knowledge_notes","id"),await lt("knowledge_links","id"),await lt("focus_sessions","id");for(const w of i)await V("characters",w);for(const w of o)await V("inspiration",w);for(const w of a)await V("ideas",w);for(const w of l)await V("mindmap_nodes",w);for(const w of c)await V("mindmap_edges",w);for(const w of d)await V("writing_sessions",w);for(const w of h)await V("knowledge_notes",w);for(const w of f)await V("knowledge_links",w);for(const w of p)await V("focus_sessions",w);u.backupStatus="Import termine.",await He({allowFallback:!1}),await wn(),await Do(),U()}}async function Do(){const n=Vt(),e=qv();if(!n||!e){u.lastChapterTitle=null;return}const t=await Uo(e);if(!t||t.project_id!==n){u.lastChapterTitle=null;return}u.lastChapterTitle=t.title||"Sans titre"}async function WA(n){return n?(u.selectedProjectId=n,await He({allowFallback:!1}),u.projects.some(t=>t.id===n)?!0:(await ad(),await He({allowFallback:!1}),u.projects.some(t=>t.id===n))):!1}async function kg(n){if(!await WA(n)){window.location.hash="#/projects";return}u.focusSession&&u.focusSession.project_id!==n&&await zt({reason:"project-change"}),gt(n),u.statusText="",u.editingProjectId=u.editingProjectId===n?n:null,await Pr(),await yn(),await $o(),await kh(),u.writingNav==="stats"&&await Ym({projectId:n,force:!0}),u.knowledgeProjectId=u.writingNav==="knowledge"?n:null,u.writingNav==="knowledge"&&await Sh({projectId:n,render:!1}),u.ideasProjectId=u.writingNav==="ideas"?n:null,u.writingNav==="ideas"&&await pC({projectId:n,render:!1}),await Ft(),u.selectedChapterId&&qn(u.selectedChapterId),await Ut(u.selectedChapterId),M(),Br||(await fC(n),await Ft(),await yn(),await $o(),await kh(),u.writingNav==="knowledge"&&await Sh({projectId:n,render:!1}),u.selectedChapterId&&qn(u.selectedChapterId),await Ut(u.selectedChapterId),M())}async function KA(){const n=await mc("Sans titre");if(!n.ok){te(`Erreur: ${n.errorMessage}`);return}await Lr([n.data]),gt(n.data.id),u.editingProjectId=n.data.id,window.location.hash=`#/project/${n.data.id}/write`}async function GA(){const n=await mc("Sans titre");if(!n.ok){te(`Erreur: ${n.errorMessage}`);return}await Lr([n.data]),gt(n.data.id),u.editingProjectId=n.data.id,window.location.hash=`#/project/${n.data.id}/write`}function JA(n){n&&window.requestAnimationFrame(()=>{const e=document.querySelector(`.project-edit-input[data-id="${n}"]`);e&&(e.focus(),e.select())})}function YA(n,e){if(!n)return;const t=document.querySelector(`.project-edit-input[data-id="${n}"]`);t&&(t.setAttribute("aria-invalid","true"),t.setAttribute("title",e),t.focus(),t.select()),te(e)}async function XA(n){if(!n)return;if(!u.projects.find(t=>t.id===n)){console.warn("project rename: project not found",n);return}u.editingProjectId=n,u.projectsMenuOpenId=null,U(),JA(n)}async function QA(n){if(!n)return;const e=document.querySelector(`.project-edit-input[data-id="${n}"]`),t=e?e.value:"";await Sg(n,t)}async function ZA(n,e){!n||!e||(await Xh(n,{status:e}),await He({allowFallback:!1}),await No(),await wn(),e==="archived"&&Vt()===n&&gt(null),u.projectsMenuOpenId=null,U())}async function e1(n){if(!n)return;const e=u.projects.find(i=>i.id===n),t=e?.title?`"${e.title}"`:"ce projet";if(!window.confirm(`Supprimer ${t} ? Cette action est definitive.`))return;const s=await Wh(n);if(!s.ok){te(`Erreur: ${s.errorMessage}`);return}await Yh(n),await Qh(n),await Zh(n),await ef(n),await tf(n),await nf(n),await He({allowFallback:!1}),await No(),await wn(),u.selectedProjectId===n&&(u.selectedProjectId=null,u.selectedChapterId=null,u.chapterDetail=null,u.chapters=[],u.versions=[]),u.editingProjectId===n&&(u.editingProjectId=null),Vt()===n&&gt(null),u.projectsMenuOpenId=null,U()}async function t1(n){n!==u.selectedProjectId&&(gt(n),u.editingProjectId=null,window.location.hash=`#/project/${n}/write`)}async function n1(n){n&&(gt(n),window.location.hash=`#/project/${n}/write`)}async function r1(){const n=Vt();n&&(window.location.hash=`#/project/${n}/write`)}async function s1(){const n=await mc("Sans titre");if(!n.ok){Rr(`Erreur: ${n.errorMessage}`);return}Rr(""),await Lr([n.data]),gt(n.data.id),u.editingProjectId=n.data.id,window.location.hash=`#/project/${n.data.id}/write`}async function i1(n){if(!n)return;const e=u.projects.find(i=>i.id===n),t=e?.title?`"${e.title}"`:"ce projet";if(!window.confirm(`Supprimer ${t} ? Cette action est definitive.`))return;const s=await Wh(n);if(!s.ok){Rr(`Erreur: ${s.errorMessage}`);return}await Yh(n),await Qh(n),await Zh(n),await ef(n),await tf(n),await nf(n),await He({allowFallback:!1}),u.selectedProjectId===n&&(u.selectedProjectId=null,u.selectedChapterId=null,u.chapterDetail=null,u.chapters=[],u.versions=[]),u.editingProjectId===n&&(u.editingProjectId=null),Vt()===n&&gt(null),Rr("Projet supprime."),U()}async function Sg(n,e){if(!n||ol.has(n))return;const t=u.projects.find(l=>l.id===n);if(!t){console.warn("project rename: project not found",n),u.editingProjectId=null,U();return}const s=(typeof e=="string"?e:"").trim();if(!s){YA(n,"Le titre ne peut pas etre vide.");return}const i=t.title??"Sans titre";if(s===i){u.editingProjectId=null,U();return}ol.add(n);let o=null,a=null;try{const l=new Date().toISOString();o=await Xh(n,{title:s,updated_at:l}),o&&(u.projects=u.projects.map(c=>c.id===n?o:c)),u.editingProjectId=null,U(),navigator.onLine&&(a=await av(n,s),a.ok?(await Lr([a.data]),await He({allowFallback:!1})):te(`Erreur: ${a.errorMessage}`))}finally{ol.delete(n),U()}}async function _g(n){if(!u.selectedChapterId)return;CC();const e=await gc(u.selectedChapterId,{content_md:n});u.chapterDetail=e;const t=navigator.onLine?"Synchronisation...":"En attente (offline)";te(t),od();const r=u.selectedChapterId;Oi=window.setTimeout(async()=>{if(await wn(),await Vo(r),navigator.onLine){const s=await qo();await fa(s)}},1200)}async function o1(){if(!u.selectedProjectId){te("Cree un projet avant d'ajouter un chapitre.");return}if(u.focusSession&&await zt({reason:"chapter-change"}),!u.projects.find(a=>a.id===u.selectedProjectId)){te("Projet introuvable. Recharge la liste des projets.");return}const e=window.prompt("Titre du chapitre");if(!e)return;const t=e.trim();if(!t){te("Le titre du chapitre ne peut pas etre vide.");return}const r=u.chapters.length,s=async a=>{const l=await _v(u.selectedProjectId,t,r);if(!l){te("Erreur: creation locale du chapitre impossible.");return}await Vo(l.id),u.selectedChapterId=l.id,qn(l.id),await Pr(),await Ft(),await Ut(u.selectedChapterId),te(a),M()};if(!navigator.onLine){await s("Chapitre enregistre localement. Synchronisation en attente.");return}const i=await qh(u.selectedProjectId);if(!i.ok||!i.exists){await s("Projet pas encore synchronise. Chapitre enregistre localement.");return}const o=await Kh(u.selectedProjectId,t,r);if(!o.ok){if(o.errorMessage?.includes("chapters_project_id_fkey")||o.errorMessage?.toLowerCase().includes("foreign key constraint")){await s("Projet non synchronise. Chapitre enregistre localement.");return}te(`Erreur: ${o.errorMessage}`);return}await Fs([o.data]),u.selectedChapterId=o.data.id,qn(o.data.id),await Pr(),await Ft(),await Ut(u.selectedChapterId),M()}async function xg(n){if(n!==u.selectedChapterId){if(await Ws("chapter-select"),u.focusSession&&await zt({reason:"chapter-change"}),od(),u.selectedChapterId=n,qn(n),u.statusText="",await Ft(),!u.chapterDetail){const e=await Gh(n);e.ok&&(await Fs([e.data]),await Ft())}await Ut(n),M()}}async function a1(n){if(!n||!u.selectedProjectId)return;if(u.focusSession&&u.selectedChapterId===n&&await zt({reason:"chapter-delete"}),u.cloudBusy){te("Synchronisation en cours...");return}const t=u.chapters.find(s=>s.id===n)?.title?.trim()||"Sans titre";window.confirm(`Supprimer le chapitre "${t}" ? Cette action est irreversible.`)&&(u.selectedChapterId===n&&await Ws("chapter-delete"),await kv(n),u.selectedChapterId===n&&(u.selectedChapterId=null,u.chapterDetail=null,u.versions=[]),await Pr(),u.selectedChapterId?(qn(u.selectedChapterId),await Ft(),await Ut(u.selectedChapterId)):qn(null),M())}async function l1(){if(!u.chapterDetail?.server_copy)return;const n=u.chapterDetail.server_copy,e={...u.chapterDetail,title:n.title??u.chapterDetail.title,content_md:n.content_md??"",remote_revision:n.revision??u.chapterDetail.remote_revision??0,conflict:!1,dirty:!1,server_copy:null};await V("chapters",e),u.chapterDetail=e,te("Charge depuis serveur"),M()}async function c1(){if(!u.selectedProjectId||!u.chapterDetail)return;const e=`${u.chapterDetail.title||"Chapitre"} (copie)`,t=u.chapters.length,r=await Kh(u.selectedProjectId,e,t);if(!r.ok){te(`Erreur: ${r.errorMessage}`);return}await Fs([r.data]);const s=await gc(r.data.id,{content_md:u.chapterDetail.content_md??""});u.selectedChapterId=r.data.id,u.chapterDetail=s;const i=navigator.onLine?"Synchronisation...":"En attente (offline)";if(te(i),await Vo(r.data.id),navigator.onLine){const o=await qo();await fa(o)}await Pr(),await Ut(u.selectedChapterId),M()}async function d1(){if(!u.selectedChapterId||!u.chapterDetail)return;const n=window.prompt("Label du snapshot (optionnel)"),e=await Jh(u.selectedChapterId,u.chapterDetail.content_md??"",n||null);if(!e.ok){te(`Erreur: ${e.errorMessage}`);return}await Ut(u.selectedChapterId),M()}async function u1(n){if(!u.selectedChapterId)return;const e=u.versions.find(s=>s.id===n);if(!e)return;const t=await gc(u.selectedChapterId,{content_md:e.content_md??""});u.chapterDetail=t;const r=navigator.onLine?"Synchronisation...":"En attente (offline)";if(te(r),await Vo(u.selectedChapterId),navigator.onLine){const s=await qo();await fa(s)}M()}async function h1(){if(!u.selectedProjectId)return;const n=await Fo(u.selectedProjectId),t=u.projects.find(c=>c.id===u.selectedProjectId)?.title??"Projet",r=[`# ${t}`,""],s=c=>{if(!c)return"";if(!/<[a-z][\s\S]*>/i.test(c))return c;const d=document.createElement("div");return d.innerHTML=c,d.textContent??""};for(const c of n)r.push(`## ${c.title??"Sans titre"}`),r.push(s(c.content_md??"")),r.push("");const i=new Blob([r.join(`
`)],{type:"text/markdown"}),o=URL.createObjectURL(i),a=`${t}`.replace(/[\\/:*?"<>|]/g,"-").trim()||"projet",l=document.createElement("a");l.href=o,l.download=`${a}.md`,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(o)}async function f1(n){const e=await Uo(n);if(!e)return;const t=e.last_snapshot_at??0;if(Date.now()-t<sC||!(await Jh(n,e.content_md??"","Auto")).ok)return;const s={...e,last_snapshot_at:Date.now()};await V("chapters",s),n===u.selectedChapterId&&await Ut(n)}const p1=()=>{if(!u.selectedChapterId||u.writingNav!=="chapter")return!1;const n=document.activeElement;return n?!!(n.closest&&n.closest(".ProseMirror")):!1};async function fa(n){if(!n||n.length===0)return;for(const t of n)t.status==="synced"&&await f1(t.chapterId);const e=n.find(t=>t.chapterId===u.selectedChapterId);if(e){if(e.status==="synced"){if(p1()){te("Enregistre");return}await Ft(),te("Enregistre"),M();return}e.status==="conflict"&&(await Ft(),te("Conflit detecte"),M())}}ie.addEventListener("click",async n=>{if(n.button===0){const r=n.target;if((r instanceof HTMLInputElement||r instanceof HTMLTextAreaElement)&&lA(r)&&cA(r)){const s=r.selectionStart;if(s!==null&&s===r.selectionEnd){const i=aA(r.value,s);if(i){n.preventDefault(),await Eh(i.title);return}}}}const e=n.target.closest("[data-action]");if(!e)return;const t=e.dataset.action;if(t==="sign-out"){(await Vd()).ok&&(window.location.hash="#login");return}if(t==="backup-toggle"){u.backupMenuOpen=!u.backupMenuOpen,u.accountMenuOpen=!1,U();return}if(t==="account-toggle"){u.accountMenuOpen=!u.accountMenuOpen,u.backupMenuOpen=!1,U();return}if(t==="nav-home"){u.accountMenuOpen=!1,u.backupMenuOpen=!1,window.location.hash="#/home";return}if(t==="nav-ideas"){u.accountMenuOpen=!1,u.backupMenuOpen=!1;const r=Vt();window.location.hash=r?`#/project/${r}/ideas`:"#/projects";return}if(t==="nav-projects"){u.accountMenuOpen=!1,u.backupMenuOpen=!1,window.location.hash="#/projects";return}if(t==="projects-open"){const r=e.dataset.id;if(!r||u.editingProjectId===r)return;u.editingProjectId=null,gt(r),u.projectsMenuOpenId=null,window.location.hash=`#/project/${r}/write`;return}if(t==="projects-create"){await GA();return}if(t==="projects-menu-toggle"){const r=e.dataset.id;u.projectsMenuOpenId=u.projectsMenuOpenId===r?null:r,U();return}if(t==="projects-rename"){await XA(e.dataset.id);return}if(t==="projects-rename-confirm"){await QA(e.dataset.id);return}if(t==="projects-rename-cancel"){u.editingProjectId=null,U();return}if(t!=="projects-rename-input"){if(t==="projects-status"){await ZA(e.dataset.id,e.dataset.status);return}if(t==="projects-delete"){await e1(e.dataset.id);return}if(t==="ideas-select"){const r=e.dataset.id;if(r){if(r===u.selectedIdeaId){u.selectedIdeaId=null,u.ideasNoteExpanded=!1,U();return}u.selectedIdeaId=r,u.ideasNoteExpanded=!1,U()}return}if(t==="ideas-delete"){await eA(e.dataset.id);return}if(t==="ideas-note-toggle"){u.ideasNoteExpanded=!u.ideasNoteExpanded,U();return}if(t==="ideas-filters-toggle"){u.ideasFiltersOpen=!u.ideasFiltersOpen,U();return}if(t==="knowledge-create"){await dg();return}if(t==="knowledge-tab"){await mA(e.dataset.tab);return}if(t==="knowledge-select"){await ua(e.dataset.id);return}if(t==="knowledge-delete"){await sA(e.dataset.id);return}if(t==="knowledge-open-link"){const r=e.dataset.title||"";await Eh(decodeURIComponent(r));return}if(t==="knowledge-preview-toggle"){gA();return}if(t==="knowledge-sort-toggle"){pA();return}if(t==="wiki-graph-reset"){wA();return}if(t==="wiki-graph-open-note"){await oc(e.dataset.id);return}if(t==="wiki-graph-settings-toggle"){u.wikiGraphSettingsOpen=!u.wikiGraphSettingsOpen,M();return}if(t==="wiki-graph-min"){const r=Number(e.dataset.value);u.wikiGraphMinDegree=Number.isFinite(r)?r:0,M();return}if(t==="wiki-graph-panel-toggle"){u.wikiGraphPanelCollapsed=!u.wikiGraphPanelCollapsed,M();return}if(t==="wiki-graph-select"){hg(e.dataset.id);return}if(t==="knowledge-autocomplete-select"){const r=e.dataset.title||"";yA(decodeURIComponent(r));return}if(t==="knowledge-duplicate-rename"){await kA(e.dataset.id);return}if(t==="project-create"){await KA();return}if(t==="home-project-create"){await s1();return}if(t==="home-project-open"){await n1(e.dataset.id);return}if(t==="home-backup-export"){u.backupMenuOpen=!1,await VA();return}if(t==="home-backup-import"){u.backupMenuOpen=!1;const r=document.querySelector("#home-backup-file");r&&(r.value="",r.click());return}if(t==="home-cloud-save"){u.accountMenuOpen=!1,await zA();return}if(t==="home-cloud-load"){u.accountMenuOpen=!1,await HA();return}if(t==="home-sign-out"){u.accountMenuOpen=!1;const r=await Vd();if(!r.ok){console.error(r.errorMessage),Rr(`Erreur: ${r.errorMessage}`);return}tt="",Rr(""),U();return}if(t==="home-project-delete"){await i1(e.dataset.id);return}if(t==="home-project-continue"){await r1();return}if(t==="home-scroll-next"){const r=document.querySelector("#home-next");r&&r.scrollIntoView({behavior:"smooth",block:"start"});return}if(t==="project-select"){await t1(e.dataset.id);return}if(t==="project-export-md"){await h1();return}if(t==="chapter-create"){await o1();return}if(t==="chapter-select"){await xg(e.dataset.id);return}if(t==="chapter-delete"){await a1(e.dataset.id);return}if(t==="conflict-reload-server"){await l1();return}if(t==="conflict-duplicate-local"){await c1();return}if(t==="version-create"){await d1();return}if(t==="version-restore"&&await u1(e.dataset.id),t==="editor-tab"){const r=e.dataset.tab;r&&r!==u.editorTab&&(u.editorTab=r,M());return}if(t==="focus-toggle"){u.focusSession?await zt({reason:"manual"}):await yC();return}if(t==="writing-nav"){const r=e.dataset.nav;if(r&&r!==u.writingNav){u.focusSession&&r!=="chapter"&&await zt({reason:"leave-editor"});const s=u.selectedProjectId;if(!s)return;const i={chapter:"write",characters:"characters",inspiration:"inspiration",ideas:"ideas",mindmap:"mindmap",stats:"stats",knowledge:"knowledge"};window.location.hash=`#/project/${s}/${i[r]??"write"}`}return}if(t==="inspiration-add"){await xA();return}if(t==="inspiration-choose-type"){TA(e.dataset.type);return}if(t==="inspiration-save"){await EA();return}if(t==="inspiration-cancel"){pg();return}if(t==="inspiration-open"){SA(e.dataset.id);return}if(t==="inspiration-close"){_A();return}if(t==="inspiration-edit"){IA(e.dataset.id);return}if(t==="inspiration-delete"){await MA(e.dataset.id);return}if(t==="mindmap-add-node"){await ac();return}if(t==="mindmap-link-mode"){u.mindmapMode=u.mindmapMode==="link"?"select":"link",u.mindmapLinkSourceId=null,u.mindmapContextMenu=null,M();return}if(t==="mindmap-reset"){mg();return}if(t==="mindmap-node"){const r=e.dataset.id;if(!r)return;if(Tt()==="wikiGraph"){await oc(r);return}if(u.mindmapContextMenu=null,u.mindmapMode==="link"){if(!u.mindmapLinkSourceId){u.mindmapLinkSourceId=r,M();return}const i=Po(u.mindmapLinkSourceId),o=Po(r);if(!i||!o){u.mindmapMode="select",u.mindmapLinkSourceId=null,M();return}const a=(i.x+o.x)/2+Xn/2-80,l=(i.y+o.y)/2+Qn/2-20;u.mindmapLinkTypeMenu={open:!0,fromId:i.id,toId:o.id,x:a,y:l},M();return}$A(r);return}if(t==="mindmap-canvas"){if(Tt()==="wikiGraph"){u.wikiGraphSelectedNodeId=null,M();return}if(u.mindmapContextMenu=null,u.mindmapLinkTypeMenu?.open){const s=u.mindmapLinkTypeMenu;s?.fromId&&s?.toId&&await hl(s.fromId,s.toId,"linked"),u.mindmapLinkTypeMenu=null,u.mindmapMode="select",u.mindmapLinkSourceId=null,M();return}u.mindmapSelectedNodeId=null,u.mindmapMode==="link"&&(u.mindmapLinkSourceId=null),M();return}if(t==="mindmap-delete-node"){u.mindmapDeleteConfirmId=e.dataset.id||null,M();return}if(t==="mindmap-context-add-node"){const r=u.mindmapContextMenu;if(u.mindmapContextMenu=null,!r)return;const s=jA({x:r.canvasX,y:r.canvasY});await ac(s);return}if(t==="mindmap-context-link"){const r=u.mindmapContextMenu;u.mindmapContextMenu=null,u.mindmapMode="link",u.mindmapLinkSourceId=r?.nodeId||null,M();return}if(t==="mindmap-delete-confirm"){u.mindmapDeleteConfirmId=null,await OA(e.dataset.id);return}if(t==="mindmap-delete-cancel"){u.mindmapDeleteConfirmId=null,M();return}if(t==="mindmap-open-source"){await UA(e.dataset.id);return}if(t==="mindmap-link-type"){const r=e.dataset.type||"linked",s=u.mindmapLinkTypeMenu;s?.fromId&&s?.toId&&await hl(s.fromId,s.toId,r),u.mindmapLinkTypeMenu=null,u.mindmapMode="select",u.mindmapLinkSourceId=null,M();return}if(t==="mindmap-link-cancel"){const r=u.mindmapLinkTypeMenu;r?.fromId&&r?.toId&&await hl(r.fromId,r.toId,"linked"),u.mindmapLinkTypeMenu=null,u.mindmapMode="select",u.mindmapLinkSourceId=null,M();return}if(t==="character-create"){await OC();return}if(t==="character-select"){await NC(e.dataset.id);return}if(t==="character-delete"){await $C(e.dataset.id);return}if(t==="character-toggle"){PC(e.dataset.section);return}if(t==="character-rate"){const r=Number(e.dataset.rating);Number.isFinite(r)&&await DC(r);return}if(t==="character-write"){jC();return}if(t==="character-avatar"){const r=document.querySelector("#character-avatar-input");r instanceof HTMLInputElement&&(r.value="",r.click());return}if(t==="character-physique"){const r=document.querySelector("#character-physique-input");r instanceof HTMLInputElement&&(r.value="",r.click());return}}});function lc(){document.querySelectorAll(".chapter-item.is-dragging, .chapter-item.is-drop-target").forEach(n=>n.classList.remove("is-dragging","is-drop-target"))}ie.addEventListener("dragstart",n=>{const e=n.target.closest(".chapter-item");!e||!(n.dataTransfer instanceof DataTransfer)||(St=e.dataset.id||null,St&&(e.classList.add("is-dragging"),n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",St)))});ie.addEventListener("dragover",n=>{const e=n.target.closest(".chapter-item");if(!e||!St)return;const t=e.dataset.id;if(!(!t||t===St)){if(n.preventDefault(),jn&&jn!==t){const r=document.querySelector(`.chapter-item[data-id="${jn}"]`);r&&r.classList.remove("is-drop-target")}jn=t,e.classList.add("is-drop-target"),n.dataTransfer&&(n.dataTransfer.dropEffect="move")}});ie.addEventListener("drop",async n=>{const e=n.target.closest(".chapter-item");if(!e||!St){lc(),St=null,jn=null;return}n.preventDefault();const t=e.dataset.id;lc();const r=St;St=null,jn=null,t&&await IC(r,t)});ie.addEventListener("dragend",()=>{lc(),St=null,jn=null});ie.addEventListener("pointerover",n=>{if(!ha())return;const t=n.target.closest(".graph-node");t&&(t.contains(n.relatedTarget)||(ln=t,hA(t)))});ie.addEventListener("pointermove",n=>{if(!ln)return;const e=ha();if(!e){ln=null;return}ln.contains(n.target)&&ug(e,ln)});ie.addEventListener("pointerout",n=>{if(!ln)return;const e=n.target.closest(".graph-node");!e||e!==ln||e.contains(n.relatedTarget)||(ln=null,fA())});ie.addEventListener("contextmenu",n=>{if(u.writingNav!=="mindmap")return;const e=n.target;if(!(e instanceof Element))return;const t=e.closest(".mindmap-canvas");if(!t)return;n.preventDefault();const r=t.getBoundingClientRect(),s=n.clientX-r.left,i=n.clientY-r.top,o=e.closest(".mindmap-node");u.mindmapContextMenu={open:!0,x:s,y:i,nodeId:o?.dataset.id||null,canvasX:s,canvasY:i},M()});ie.addEventListener("mousedown",n=>{const e=Tt();if(!e)return;const t=n.target;if(!(t instanceof Element))return;const r=t.closest(".mindmap-node");if(!t.closest(".mindmap-canvas"))return;if(r){const o=r.dataset.id,a=tg(e).find(l=>l.id===o);if(!a)return;Fe={id:a.id,startX:n.clientX,startY:n.clientY,originX:a.x,originY:a.y,dataset:e},n.preventDefault();return}const i=Ls(e);vt={startX:n.clientX,startY:n.clientY,originX:i.offsetX,originY:i.offsetY,dataset:e},n.preventDefault()});ie.addEventListener("dblclick",async n=>{const e=Tt();if(!e)return;const t=n.target;if(!(t instanceof Element))return;const r=t.closest(".mindmap-canvas");if(!r)return;const s=t.closest(".graph-node");if(e==="wikiGraph"&&s?.dataset.id){const c=s.dataset.id;hg(c),await oc(c);return}if(e!=="mindmap")return;const i=r.getBoundingClientRect(),o=Ls("mindmap"),a=(n.clientX-i.left-o.offsetX)/o.scale-Xn/2,l=(n.clientY-i.top-o.offsetY)/o.scale-Qn/2;await ac({x:a,y:l})});ie.addEventListener("mousemove",n=>{if(Fe){const e=Fe.dataset??"mindmap",t=Ls(e),r=(n.clientX-Fe.startX)/t.scale,s=(n.clientY-Fe.startY)/t.scale,i=Fe.originX+r,o=Fe.originY+s,a=tg(e).map(l=>l.id===Fe.id?{...l,x:i,y:o}:l);if(BC(a,e),e==="wikiGraph"){LA(Fe.id);return}M();return}if(vt){const e=vt.dataset??"mindmap",t=n.clientX-vt.startX,r=n.clientY-vt.startY,i={...Ls(e),offsetX:vt.originX+t,offsetY:vt.originY+r};if(ng(i,e),e==="wikiGraph"){gg();return}M()}});ie.addEventListener("mouseup",async()=>{const n=Fe?.dataset??vt?.dataset??Tt();if(!n){Fe=null,vt=null;return}if(n==="mindmap"&&Fe){const e=Po(Fe.id);e&&await rf(e.id,{x:e.x,y:e.y})}Fe=null,vt=null});ie.addEventListener("wheel",n=>{const e=Tt();if(!e)return;const t=n.target;if(!(t instanceof Element))return;const r=t.closest(".mindmap-canvas");if(!r)return;n.preventDefault();const s=r.getBoundingClientRect(),i=n.clientX-s.left,o=n.clientY-s.top,a=Ls(e),l=a.scale,c=Math.min(2,Math.max(.4,l+(n.deltaY>0?-.08:.08))),d=c/l,h=i-(i-a.offsetX)*d,f=o-(o-a.offsetY)*d;if(ng({offsetX:h,offsetY:f,scale:c},e),e==="wikiGraph"){gg();return}M()},{passive:!1});ie.addEventListener("input",async n=>{const e=n.target;if(e){if(e instanceof HTMLInputElement&&e.classList.contains("project-edit-input")){e.getAttribute("aria-invalid")==="true"&&(e.removeAttribute("aria-invalid"),e.removeAttribute("title"));return}if(e.id==="character-filter"){RC(e.value);return}if(e.id==="ideas-search"){u.ideasQuery=e.value,U();return}if(e.id==="ideas-tag-filter"){u.ideasTagFilter=e.value,U();return}if(e.id==="inspiration-search"){CA(e.value);return}if(e.id==="mindmap-search"){u.mindmapSearch=e.value;const t=e.value.trim();if(t){const r=Ge(t),s=u.mindmapNodes.find(i=>{const o=[i.title,i.summary,...i.tags??[]].filter(Boolean).join(" ");return Ge(o).includes(r)});s&&(u.mindmapSelectedNodeId=s.id,BA(s),FA(s.id))}M();return}if(e.id==="knowledge-search"){u.knowledgeSearch=e.value,U();return}if(e.id==="wiki-graph-search"){u.wikiGraphSearch=e.value,M();return}if(e.id==="wiki-graph-min"){u.wikiGraphMinDegree=Number(e.value)||0,M();return}if(e.id==="knowledge-title"){const t=e.dataset.id;t&&(u.knowledgeTitleOriginals[t]||(u.knowledgeTitleOriginals={...u.knowledgeTitleOriginals,[t]:ld(t)}),rg(t,e.value),gs(""));return}if(e.id==="knowledge-content"){const t=e.dataset.id;t&&(cd(t,{content:e.value}),cg(t,{content:e.value}),rA(e));return}if(e.dataset.mindmapField){const t=e.dataset.mindmapField,r=e.dataset.id;if(r){const s=e.value,i=t==="tags"?{tags:Ds(s)}:{[t]:s};yg(r,i),t==="title"&&wg(r,s),vg(r,i);return}}if(e.dataset.ideaField){const t=e.dataset.ideaField,r=e.dataset.id;if(r){if(t==="tags"){const s=Ds(e.value);Th(r,{tags:s});return}Th(r,{[t]:e.value});return}}if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement){const t=e.dataset.characterField,r=e.dataset.characterMeta||null;if(t){eg(t,e.value,r);return}}e.id==="chapter-content"&&await _g(e.value)}});ie.addEventListener("focusout",async n=>{const e=n.target;if(e instanceof Element){if(e.dataset.mindmapField){await bg();return}if(e.dataset.ideaField){const t=e.dataset.id;t&&await lg(t,{render:!1})}if(e.id==="knowledge-title"){const t=e.dataset.id;t&&await Gs(t,{reason:"blur"});return}if(e.id==="knowledge-content"){const t=e.dataset.id;t&&await Ks(t,{render:!1})}}});ie.addEventListener("change",async n=>{const e=n.target;if(!(e instanceof HTMLInputElement||e instanceof HTMLSelectElement))return;if(e.dataset.characterField){const r=e.dataset.characterField,s=e.dataset.characterMeta||null;eg(r,e.value,s);return}if(e.dataset.mindmapField){const r=e.dataset.mindmapField,s=e.dataset.id;if(s){const i=e.value,o=r==="tags"?{tags:Ds(i)}:{[r]:i};yg(s,o),r==="title"&&wg(s,i),vg(s,o)}return}if(e.dataset.ideaField){const r=e.dataset.ideaField,s=e.dataset.id;if(s){if(r==="tags"){const i=Ds(e.value);await ic(s,{tags:i},{render:!0});return}await ic(s,{[r]:e.value},{render:!0})}return}if(e.id==="inspiration-tag-filter"){AA(e.value);return}if(e.id==="ideas-status-filter"){u.ideasStatusFilter=e.value,U();return}if(e.id==="ideas-sort"){u.ideasSort=e.value,U();return}if(e.id==="wiki-graph-orphans"){u.wikiGraphShowOrphans=!!e.checked,M();return}if(e.id==="mindmap-create-type"){u.mindmapCreateType=e.value;return}if(e.id==="inspiration-image-input"){const r=e.files?.[0]??null;if(!r)return;const s=new FileReader;s.onload=()=>{const i=typeof s.result=="string"?s.result:"";if(!i)return;const o=u.inspirationModal?.draft??{};u.inspirationModal={...u.inspirationModal??{},open:!0,step:"form",type:"image",draft:{...o,image_data:i}},M()},s.readAsDataURL(r);return}if(e.id==="character-avatar-input"){const r=e.files?.[0]??null;if(!r)return;const s=new FileReader;s.onload=async()=>{const i=typeof s.result=="string"?s.result:"",o=Ro();o&&i&&(await Bi(o.id,{avatar_url:i}),await yn(),M())},s.readAsDataURL(r);return}if(e.id==="character-physique-input"){const r=e.files?.[0]??null;if(!r)return;const s=new FileReader;s.onload=async()=>{const i=typeof s.result=="string"?s.result:"",o=Ro();if(o&&i){const a={...o.meta??{},physique:{...o.meta?.physique??{},image_url:i}};await Bi(o.id,{meta:a}),await yn(),M()}},s.readAsDataURL(r);return}if(e.id!=="home-backup-file")return;const t=e.files?.[0]??null;await qA(t),e.value=""});document.addEventListener("click",n=>{if(!u.accountMenuOpen)return;const e=n.target;e instanceof Element&&(e.closest(".topbar-account")||e.closest(".topbar-backup"))||(u.accountMenuOpen=!1,u.backupMenuOpen=!1,U())});document.addEventListener("click",n=>{if(!u.projectsMenuOpenId)return;const e=n.target;e instanceof Element&&(e.closest(".project-menu")||e.closest(".project-menu-toggle")||(u.projectsMenuOpenId=null,U()))});document.addEventListener("click",n=>{if(!u.mindmapContextMenu?.open)return;const e=n.target;e instanceof Element&&(e.closest(".mindmap-context-menu")||(u.mindmapContextMenu=null,U()))});document.addEventListener("click",n=>{if(!u.knowledgeAutocomplete.open)return;const e=n.target;e instanceof Element&&(e.closest("#knowledge-autocomplete")||e.closest("#knowledge-content")||it())});document.addEventListener("click",n=>{if(!u.wikiGraphSettingsOpen)return;const e=n.target;e instanceof Element&&(e.closest(".graph-settings")||(u.wikiGraphSettingsOpen=!1,U()))});document.addEventListener("keydown",n=>{const e=n.target,t=e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLElement&&e.isContentEditable;if(n.key==="Escape"){if(u.wikiGraphSettingsOpen){u.wikiGraphSettingsOpen=!1,U();return}if(u.mindmapContextMenu?.open){u.mindmapContextMenu=null,U();return}if(!u.accountMenuOpen&&!u.backupMenuOpen)return;u.accountMenuOpen=!1,u.backupMenuOpen=!1,U();return}if(t)return;const r=n.key.toLowerCase(),s=(n.ctrlKey||n.metaKey)&&n.shiftKey&&r==="i",i=n.ctrlKey&&n.altKey&&r==="i";if(s||i){n.preventDefault(),u.accountMenuOpen=!1,u.backupMenuOpen=!1;const o=Vt();window.location.hash=o?`#/project/${o}/ideas`:"#/projects"}});ie.addEventListener("keydown",async n=>{const e=n.target;if(e instanceof HTMLInputElement&&e.classList.contains("project-edit-input")){if(n.key==="Enter"){n.preventDefault();const t=e.dataset.id;t&&await Sg(t,e.value);return}n.key==="Escape"&&(n.preventDefault(),u.editingProjectId=null,U())}});ie.addEventListener("keydown",async n=>{const e=n.target;if(!(e instanceof HTMLTextAreaElement)||e.id!=="ideas-create-input"||n.key!=="Enter"||n.shiftKey)return;n.preventDefault();const t=e.value;await ZC(t),e.value=""});ie.addEventListener("keydown",n=>{const e=n.target;if(e instanceof HTMLInputElement&&e.id==="knowledge-title"){if(n.key==="Enter"){n.preventDefault();const t=e.dataset.id;t&&Gs(t,{reason:"enter"}).then(()=>{u.knowledgeTitleError||e.blur()});return}if(n.key==="Escape"){n.preventDefault();const t=e.dataset.id;if(t){const r=u.knowledgeTitleOriginals[t]??ld(t);bA(t,r)}e.blur()}}});ie.addEventListener("keydown",n=>{const e=n.target;e instanceof HTMLTextAreaElement&&e.id==="knowledge-content"&&n.key==="Escape"&&u.knowledgeAutocomplete.open&&(n.preventDefault(),it())});ie.addEventListener("keydown",n=>{const e=n.target;if(e instanceof HTMLElement&&!(e.dataset.action!=="projects-open"||e.tagName==="BUTTON")&&(n.key==="Enter"||n.key===" ")){n.preventDefault();const t=e.dataset.id;if(!t||u.editingProjectId===t)return;gt(t),u.projectsMenuOpenId=null,window.location.hash=`#/project/${t}/write`}});async function Tg(){const{page:n,props:e}=await Gb(),t=n==="editor"?e.writingNav??"chapter":null,r=n==="editor"&&e.projectId&&u.selectedProjectId&&e.projectId!==u.selectedProjectId;if((n!=="editor"||t!=="chapter"||r)&&await Ws("route-change"),od(),bh||(bh=!0,await wC()),n!=="editor"&&u.focusSession&&await zt({reason:"leave-editor"}),n==="editor"){if(u.accountMenuOpen=!1,u.backupMenuOpen=!1,tt=e.userEmail,Ti(!!tt),await dl(),wh||(Kv(fa),wh=!0),e.writingNav){const a=e.writingNav;a!==u.writingNav&&(u.focusSession&&a!=="chapter"&&await zt({reason:"leave-editor"}),u.writingNav=a,a==="mindmap"&&(u.mindmapNeedsCenter=!0))}await kg(e.projectId);return}if(sd(),n==="home"){u.accountMenuOpen=!1,u.backupMenuOpen=!1,tt=e.userEmail,Ti(!!tt),await dl(),await Gm();return}if(n==="projects"){u.accountMenuOpen=!1,u.backupMenuOpen=!1,tt=e.userEmail,Ti(!!tt),await dl(),await Jm();return}ie.innerHTML=Yb({message:e.message}),Ti(!1),nc=!1,Br=!1;const i=document.querySelector("#sign-in"),o=document.querySelector("#sign-up");i&&i.addEventListener("click",async()=>{const{email:a,password:l}=vh(),c=await Wb(a,l);if(!c.ok){ul(c.errorMessage);return}window.location.hash="#/home"}),o&&o.addEventListener("click",async()=>{const{email:a,password:l}=vh(),c=await qb(a,l);if(!c.ok){ul(c.errorMessage);return}ul("Compte cree. Verifie tes emails si besoin.")})}window.addEventListener("hashchange",Tg);window.addEventListener("beforeunload",()=>{u.focusSession&&zt({reason:"unload"})});Tg();
